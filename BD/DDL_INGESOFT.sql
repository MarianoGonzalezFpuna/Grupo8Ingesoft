  CREATE TABLE "DET_ROL" 
   (	"PERMISO" VARCHAR2(30000) NOT NULL ENABLE, 
	"ROL_ID_ROL" NUMBER(10,0)
   ) ;

  CREATE TABLE "HIJO" 
   (	"ID_HIJO" NUMBER(8,0) NOT NULL ENABLE, 
	"CEDULA" VARCHAR2(11) NOT NULL ENABLE, 
	"NOMBRE" VARCHAR2(80) NOT NULL ENABLE, 
	"APELLIDO" VARCHAR2(80) NOT NULL ENABLE, 
	"FECHA_NAC" DATE NOT NULL ENABLE, 
	"CERT_NACIMIENTO" BLOB NOT NULL ENABLE, 
	"VIDA_RESIDENCIA" BLOB NOT NULL ENABLE, 
	"VR_VALIDO_HASTA" DATE NOT NULL ENABLE, 
	"EMP_ID_EMPLEADO" NUMBER(8,0) NOT NULL ENABLE, 
	"DISCAPACIDAD" VARCHAR2(1), 
	 CONSTRAINT "PK_HIJO" PRIMARY KEY ("ID_HIJO")
  USING INDEX  ENABLE, 
	 CONSTRAINT "CHK_HIJO_DISCAPACIDAD" CHECK (DISCAPACIDAD IN ('S','N')) ENABLE
   ) ;

  CREATE TABLE "JRXML_APEX2JRXML_TEMPLATES" 
   (	"JAT_ID" NUMBER NOT NULL ENABLE, 
	"JAT_NAME" VARCHAR2(255) NOT NULL ENABLE, 
	"JAT_TYPE" VARCHAR2(2) DEFAULT 'RE' NOT NULL ENABLE, 
	"JAT_TEMPLATE_START" CLOB, 
	"JAT_TEMPLATE_END" CLOB, 
	"JAT_HEIGHT_OFFSET" NUMBER, 
	"JAT_CONTENT_WIDTH" NUMBER, 
	"JAT_STANDARD" VARCHAR2(1) DEFAULT 'N' NOT NULL ENABLE, 
	 CONSTRAINT "JAT_PK" PRIMARY KEY ("JAT_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JAT_UK" UNIQUE ("JAT_TYPE", "JAT_NAME")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_FONTS" 
   (	"JRF_ID" NUMBER NOT NULL ENABLE, 
	"JRF_NAME" VARCHAR2(80) NOT NULL ENABLE, 
	"JRF_TYPE" VARCHAR2(3) NOT NULL ENABLE, 
	"JRF_FONT" BLOB, 
	"JRF_ENCODING" VARCHAR2(30), 
	"JRF_COMPRESS" VARCHAR2(1) DEFAULT 'Y' NOT NULL ENABLE, 
	 CONSTRAINT "JRF_TYPE_CK" CHECK (
    JRF_TYPE IN ('TTF', 'TTC')
  ) ENABLE, 
	 CONSTRAINT "JRF_PK" PRIMARY KEY ("JRF_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRF_UK" UNIQUE ("JRF_NAME")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_REPORT_DEFINITIONS" 
   (	"JRD_ID" NUMBER NOT NULL ENABLE, 
	"JRD_NAME" VARCHAR2(255) NOT NULL ENABLE, 
	"JRD_DESCRIPTION" VARCHAR2(4000), 
	"JRD_XML" CLOB, 
	 CONSTRAINT "JRD_PK" PRIMARY KEY ("JRD_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRD_UK" UNIQUE ("JRD_NAME")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_REPORT_IMAGES" 
   (	"JRI_ID" NUMBER NOT NULL ENABLE, 
	"JRI_JRD_ID" NUMBER, 
	"JRI_NAME" VARCHAR2(255) NOT NULL ENABLE, 
	"JRI_DESCRIPTION" VARCHAR2(4000), 
	"JRI_IMAGE" BLOB, 
	"JRI_ADLER32" VARCHAR2(30), 
	"JRI_ADLER32_VALID" VARCHAR2(1) DEFAULT 'N' NOT NULL ENABLE, 
	 CONSTRAINT "JRI_ALER32_CK" CHECK (
    JRI_ADLER32_VALID IN ('Y', 'N')
  ) ENABLE, 
	 CONSTRAINT "JRI_PK" PRIMARY KEY ("JRI_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRI_UK" UNIQUE ("JRI_JRD_ID", "JRI_NAME")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_RESOURCE_FILES" 
   (	"JRR_ID" NUMBER NOT NULL ENABLE, 
	"JRR_NAME" VARCHAR2(80) NOT NULL ENABLE, 
	"JRR_LOCALE" VARCHAR2(10), 
	"JRR_VALID" VARCHAR2(1) NOT NULL ENABLE, 
	"JRR_CONTENT" CLOB NOT NULL ENABLE, 
	 CONSTRAINT "JRR_VALID_CK" CHECK (
    JRR_VALID IN ('Y', 'N')
  ) ENABLE, 
	 CONSTRAINT "JRR_PK" PRIMARY KEY ("JRR_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRR_UK" UNIQUE ("JRR_NAME", "JRR_LOCALE")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "ROL" 
   (	"ID_ROL" NUMBER(8,0) NOT NULL ENABLE, 
	"NOMBRE" VARCHAR2(15) NOT NULL ENABLE, 
	"PERMISOS" VARCHAR2(30000), 
	"ESTADO" VARCHAR2(100), 
	 CONSTRAINT "PK_ROL" PRIMARY KEY ("ID_ROL")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "AUX_EMP_AUSENCIAS" 
   (	"EMP_ID_EMPLEADO" NUMBER(20,0), 
	"CANTIDAD_AUS" NUMBER(20,0), 
	"MES" NUMBER(20,0), 
	"ANHO" NUMBER(20,0)
   ) ;

  CREATE TABLE "CARGO" 
   (	"ID_CARGO" NUMBER(8,0) NOT NULL ENABLE, 
	"DESCRIPCION" VARCHAR2(100) NOT NULL ENABLE, 
	"SALARIO" NUMBER NOT NULL ENABLE, 
	"ES_VIGENTE" VARCHAR2(1) NOT NULL ENABLE, 
	 CONSTRAINT "CK_CARGO_ES_VIGENTE" CHECK (ES_VIGENTE IN ('S','N')) ENABLE, 
	 CONSTRAINT "PK_CARGO" PRIMARY KEY ("ID_CARGO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "CONCEPTO_SALARIAL" 
   (	"ID_CONCEPTO" NUMBER(8,0) NOT NULL ENABLE, 
	"NOMBRE" VARCHAR2(50) NOT NULL ENABLE, 
	"TIPO" VARCHAR2(14) NOT NULL ENABLE, 
	"AFECTA_IPS" VARCHAR2(1), 
	"AFECTA_SALARIO" VARCHAR2(1), 
	"ES_RECURRENTE" VARCHAR2(1), 
	"MONTO" NUMBER(20,0), 
	 CHECK (AFECTA_IPS IN ('S','N')) ENABLE, 
	 CHECK (AFECTA_SALARIO IN ('S','N')) ENABLE, 
	 CHECK (ES_RECURRENTE IN ('S','N')) ENABLE, 
	 CONSTRAINT "PK_CONCEPTO_SALARIAL" PRIMARY KEY ("ID_CONCEPTO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "DET_LIQUIDACION" 
   (	"ID_DET_LIQUIDACION" NUMBER(8,0) NOT NULL ENABLE, 
	"CANTIDAD" NUMBER(10,0) NOT NULL ENABLE, 
	"MONTO" NUMBER(22,2) NOT NULL ENABLE, 
	"OBSERVACION" VARCHAR2(100), 
	"LIQ_ID_LIQUIDACION" NUMBER(8,0) NOT NULL ENABLE, 
	"CON_ID_CONCEPTO" NUMBER(8,0) NOT NULL ENABLE, 
	"SAL_ID_SALARIO_MINIMO" NUMBER(8,0), 
	 CONSTRAINT "PK_DETALLE_LIQUIDACION" PRIMARY KEY ("ID_DET_LIQUIDACION")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "EMPLEADO" 
   (	"ID_EMPLEADO" NUMBER(8,0) NOT NULL ENABLE, 
	"CEDULA" VARCHAR2(11) NOT NULL ENABLE, 
	"NOMBRE" VARCHAR2(80) NOT NULL ENABLE, 
	"APELLIDO" VARCHAR2(80) NOT NULL ENABLE, 
	"FECHA_NAC" DATE NOT NULL ENABLE, 
	"RUC" VARCHAR2(15), 
	"DIRECCION" VARCHAR2(80) NOT NULL ENABLE, 
	"CELULAR" VARCHAR2(15) NOT NULL ENABLE, 
	"CORREO" VARCHAR2(50) NOT NULL ENABLE, 
	"ESTADO_CIVIL" VARCHAR2(10), 
	"ID_CARGO" NUMBER(8,0) NOT NULL ENABLE, 
	"FECHA_INGRESO" DATE NOT NULL ENABLE, 
	"FECHA_SALIDA" DATE, 
	"IPS" VARCHAR2(100), 
	"USUARIO" VARCHAR2(30), 
	 CONSTRAINT "PK_EMPLEADO" PRIMARY KEY ("ID_EMPLEADO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "EMPLEADO_CONCEPTO" 
   (	"EMP_ID_EMPLEADO" NUMBER(10,0), 
	"CON_ID_CONCEPTO" NUMBER(10,0), 
	"ID_EMP_CON" NUMBER(10,0) NOT NULL ENABLE, 
	 CONSTRAINT "EMP_CON_PK" PRIMARY KEY ("ID_EMP_CON")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "HISTORIAL_CARGO" 
   (	"ID_HIST_CARGO" NUMBER(8,0) NOT NULL ENABLE, 
	"SALARIO_BASE" NUMBER NOT NULL ENABLE, 
	"ES_VIGENTE" VARCHAR2(1) NOT NULL ENABLE, 
	"FECHA_INICIO" DATE NOT NULL ENABLE, 
	"FECHA_FIN" DATE, 
	"EMP_ID_EMPLEADO" NUMBER(8,0) NOT NULL ENABLE, 
	"CAR_ID_CARGO" NUMBER(8,0) NOT NULL ENABLE, 
	 CONSTRAINT "CK_HISTCARGO_VIGENTE" CHECK (ES_VIGENTE IN ('SI','NO')) ENABLE, 
	 CONSTRAINT "PK_HISTORIAL_CARGO" PRIMARY KEY ("ID_HIST_CARGO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "HISTORICO_CARGO" 
   (	"ID_HISTORICO_CARGO" NUMBER(20,0), 
	"EMP_ID_EMPLEADO" NUMBER(20,0), 
	"CAR_ID_CARGO" NUMBER(20,0), 
	"FECHA_INICIO" DATE, 
	"FECHA_FIN" DATE, 
	 CONSTRAINT "HISTORICO_CARGO_PK" PRIMARY KEY ("ID_HISTORICO_CARGO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "HTMLDB_PLAN_TABLE" 
   (	"STATEMENT_ID" VARCHAR2(30), 
	"PLAN_ID" NUMBER, 
	"TIMESTAMP" DATE, 
	"REMARKS" VARCHAR2(4000), 
	"OPERATION" VARCHAR2(30), 
	"OPTIONS" VARCHAR2(255), 
	"OBJECT_NODE" VARCHAR2(128), 
	"OBJECT_OWNER" VARCHAR2(128), 
	"OBJECT_NAME" VARCHAR2(128), 
	"OBJECT_ALIAS" VARCHAR2(261), 
	"OBJECT_INSTANCE" NUMBER(*,0), 
	"OBJECT_TYPE" VARCHAR2(128), 
	"OPTIMIZER" VARCHAR2(255), 
	"SEARCH_COLUMNS" NUMBER, 
	"ID" NUMBER(*,0), 
	"PARENT_ID" NUMBER(*,0), 
	"DEPTH" NUMBER(*,0), 
	"POSITION" NUMBER(*,0), 
	"COST" NUMBER(*,0), 
	"CARDINALITY" NUMBER(*,0), 
	"BYTES" NUMBER(*,0), 
	"OTHER_TAG" VARCHAR2(255), 
	"PARTITION_START" VARCHAR2(255), 
	"PARTITION_STOP" VARCHAR2(255), 
	"PARTITION_ID" NUMBER(*,0), 
	"OTHER" LONG, 
	"DISTRIBUTION" VARCHAR2(30), 
	"CPU_COST" NUMBER(*,0), 
	"IO_COST" NUMBER(*,0), 
	"TEMP_SPACE" NUMBER(*,0), 
	"ACCESS_PREDICATES" VARCHAR2(4000), 
	"FILTER_PREDICATES" VARCHAR2(4000), 
	"PROJECTION" VARCHAR2(4000), 
	"TIME" NUMBER(*,0), 
	"QBLOCK_NAME" VARCHAR2(128)
   ) ;

  CREATE TABLE "JRXML_LOGGING" 
   (	"JRL_ID" NUMBER NOT NULL ENABLE, 
	"JRL_RUN_ID" NUMBER NOT NULL ENABLE, 
	"JRL_TIME" TIMESTAMP (6) NOT NULL ENABLE, 
	"JRL_TIME_SINCE_LAST_LOG" NUMBER NOT NULL ENABLE, 
	"JRL_TEXT" VARCHAR2(4000), 
	 CONSTRAINT "JRL_PK" PRIMARY KEY ("JRL_ID")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_NLS_PARAMETERS" 
   (	"JRN_ID" NUMBER(38,0) NOT NULL ENABLE, 
	"JRN_LOCALE_LANGUAGE" VARCHAR2(10) NOT NULL ENABLE, 
	"JRN_LOCALE_COUNTRY" VARCHAR2(10), 
	"JRN_NLS_LANGUAGE" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_NLS_TERRITORY" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_NUMERIC_CHARACTERS" VARCHAR2(2) NOT NULL ENABLE, 
	"JRN_DEFAULT_DATE_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_SHORT_DATE_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_MEDIUM_DATE_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_LONG_DATE_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_DEFAULT_TIME_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_SHORT_TIME_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_MEDIUM_TIME_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_LONG_TIME_FORMAT" VARCHAR2(80) NOT NULL ENABLE, 
	"JRN_DATE_TIME_STRING" VARCHAR2(10) NOT NULL ENABLE, 
	"JRN_CURRENCY" VARCHAR2(10) NOT NULL ENABLE, 
	 CONSTRAINT "JRN_PK" PRIMARY KEY ("JRN_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRN_UK" UNIQUE ("JRN_LOCALE_LANGUAGE", "JRN_LOCALE_COUNTRY")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "JRXML_RESOURCE_ENTRIES" 
   (	"JRS_ID" NUMBER NOT NULL ENABLE, 
	"JRS_JRR_ID" NUMBER NOT NULL ENABLE, 
	"JRS_KEY" VARCHAR2(2000) NOT NULL ENABLE, 
	"JRS_VALUE" VARCHAR2(4000), 
	 CONSTRAINT "JRS_PK" PRIMARY KEY ("JRS_ID")
  USING INDEX  ENABLE, 
	 CONSTRAINT "JRS_UK" UNIQUE ("JRS_JRR_ID", "JRS_KEY")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "LIQUIDACION" 
   (	"ID_LIQUIDACION" NUMBER(8,0) NOT NULL ENABLE, 
	"TOTAL_INGRESOS" NUMBER(22,2) NOT NULL ENABLE, 
	"TOTAL_DESCUENTOS" NUMBER(22,2) NOT NULL ENABLE, 
	"NETO_A_COBRAR_NUM" NUMBER(22,2) NOT NULL ENABLE, 
	"NETO_A_COBRAR_LET" VARCHAR2(2000) NOT NULL ENABLE, 
	"FECHA_GENERACION" DATE NOT NULL ENABLE, 
	"FECHA_CONFIRMACION" DATE NOT NULL ENABLE, 
	"PER_ID_PERIODO" NUMBER(8,0) NOT NULL ENABLE, 
	"EMP_ID_EMPLEADO" NUMBER(8,0) NOT NULL ENABLE, 
	 CONSTRAINT "PK_LIQUIDACION" PRIMARY KEY ("ID_LIQUIDACION")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "PERIODO_NOMINA" 
   (	"ID_PERIODO" NUMBER(8,0) NOT NULL ENABLE, 
	"ANHO" NUMBER(4,0) NOT NULL ENABLE, 
	"MES" NUMBER(2,0) NOT NULL ENABLE, 
	"FECHA_APERTURA" DATE NOT NULL ENABLE, 
	"FECHA_CIERRE" DATE, 
	"ESTADO" VARCHAR2(10) NOT NULL ENABLE, 
	 CONSTRAINT "PK_PERIODO_NOMINA" PRIMARY KEY ("ID_PERIODO")
  USING INDEX  ENABLE, 
	 CONSTRAINT "MES_ANHO_UK" UNIQUE ("ANHO", "MES")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "PERMISOS" 
   (	"ID_PERMISOS" NUMBER(8,0) NOT NULL ENABLE, 
	"RECURSO" VARCHAR2(50) NOT NULL ENABLE, 
	"ACCION" VARCHAR2(50) NOT NULL ENABLE, 
	"AMBITO" VARCHAR2(20) NOT NULL ENABLE, 
	 CONSTRAINT "PK_PERMISOS" PRIMARY KEY ("ID_PERMISOS")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "ROL_PERMISOS" 
   (	"ID_PERMISOS" NUMBER(8,0) NOT NULL ENABLE, 
	"ID_ROL" NUMBER(8,0) NOT NULL ENABLE, 
	 CONSTRAINT "PK_ROL_PERMISOS" PRIMARY KEY ("ID_PERMISOS", "ID_ROL")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "ROL_PERSONA" 
   (	"ROL_ID_ROL" NUMBER(10,0) NOT NULL ENABLE, 
	"PER_ID_PERSONA" NUMBER(10,0) NOT NULL ENABLE
   ) ;

  CREATE TABLE "SALARIO_MINIMO" 
   (	"ID_SALARIO_MINIMO" NUMBER(8,0) NOT NULL ENABLE, 
	"MONTO" NUMBER(20,2), 
	"FECHA_DESDE" DATE, 
	"FECHA_HASTA" DATE, 
	"ES_VIGENTE" VARCHAR2(1 CHAR) DEFAULT 'S' NOT NULL ENABLE, 
	 CONSTRAINT "PK_SALARIO_MINIMO" PRIMARY KEY ("ID_SALARIO_MINIMO")
  USING INDEX  ENABLE
   ) ;

  CREATE TABLE "SECUENCIA" 
   (	"SEC_NOMBRE" VARCHAR2(30) NOT NULL ENABLE, 
	"SEC_COMENTS" VARCHAR2(100), 
	"SEC_SIG_VALOR" NUMBER(20,0) NOT NULL ENABLE, 
	"SEC_INCREMENTO" NUMBER(5,0) NOT NULL ENABLE
   ) ;

  CREATE TABLE "USUARIO" 
   (	"ID_USUARIO" NUMBER(8,0) NOT NULL ENABLE, 
	"USERNAME" VARCHAR2(15) NOT NULL ENABLE, 
	"CONTRASENA" VARCHAR2(15) NOT NULL ENABLE, 
	"CORREO" VARCHAR2(50) NOT NULL ENABLE, 
	"ES_ACTIVO" CHAR(1) NOT NULL ENABLE, 
	"ROL_ID_ROL" NUMBER(8,0) NOT NULL ENABLE, 
	 CONSTRAINT "CK_USUARIO_ACTIVO" CHECK (ES_ACTIVO IN ('SI','NO')) ENABLE, 
	 CONSTRAINT "PK_USUARIO" PRIMARY KEY ("ID_USUARIO")
  USING INDEX  ENABLE, 
	 CONSTRAINT "UQ_USUARIO_USERNAME" UNIQUE ("USERNAME")
  USING INDEX  ENABLE, 
	 CONSTRAINT "UQ_USUARIO_CORREO" UNIQUE ("CORREO")
  USING INDEX  ENABLE
   ) ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CARGO" 
before insert on CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_cargo is null then 
            cgui$cg_code_controls('SEQ_CARGO', V_NEXT_VAL);

            :NEW.ID_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CARGO" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CONCEPTO_SALARIAL" 
before insert on CONCEPTO_SALARIAL 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_concepto is null then 
            cgui$cg_code_controls('SEQ_CONCEPTO_SALARIO', V_NEXT_VAL);

            :NEW.ID_concepto := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CONCEPTO_SALARIAL" ENABLE;

  ALTER TABLE "DET_LIQUIDACION" ADD CONSTRAINT "FK_DET_LIQ_LIQ" FOREIGN KEY ("LIQ_ID_LIQUIDACION")
	  REFERENCES "LIQUIDACION" ("ID_LIQUIDACION") ENABLE;
  ALTER TABLE "DET_LIQUIDACION" ADD CONSTRAINT "FK_DET_LIQ_CONC" FOREIGN KEY ("CON_ID_CONCEPTO")
	  REFERENCES "CONCEPTO_SALARIAL" ("ID_CONCEPTO") ENABLE;
  ALTER TABLE "DET_LIQUIDACION" ADD CONSTRAINT "FK_DET_LIQ_SAL" FOREIGN KEY ("SAL_ID_SALARIO_MINIMO")
	  REFERENCES "SALARIO_MINIMO" ("ID_SALARIO_MINIMO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_DET_LIQUIDACION" 
before insert on det_LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_det_liquidacion is null then 
            cgui$cg_code_controls('SEQ_DET_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_det_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_DET_LIQUIDACION" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_DET_LIQUIDACION_AIUD" 
AFTER INSERT OR UPDATE OR DELETE ON DET_LIQUIDACION
DECLARE
BEGIN
    -- Recalcular totales de TODAS las liquidaciones afectadas
    FOR liq IN (
        SELECT DISTINCT LIQ_ID_LIQUIDACION AS ID_LIQUIDACION
        FROM DET_LIQUIDACION
    ) LOOP
        DECLARE
            v_total_ingresos   NUMBER := 0;
            v_total_descuentos NUMBER := 0;
            v_neto             NUMBER := 0;
        BEGIN
            -- Calcular ingresos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_ingresos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'CREDITO';

            -- Calcular descuentos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_descuentos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'DEBITO';

            -- Calcular neto
            v_neto := v_total_ingresos - v_total_descuentos;

            -- Actualizar cabecera
            UPDATE LIQUIDACION
            SET TOTAL_INGRESOS    = v_total_ingresos,
                TOTAL_DESCUENTOS  = v_total_descuentos,
                NETO_A_COBRAR_NUM = v_neto,
                NETO_A_COBRAR_LET = UPPER(pr_num_a_letras.DinTex(v_neto))
            WHERE ID_LIQUIDACION = liq.ID_LIQUIDACION;
        END;
    END LOOP;
END;
/
ALTER TRIGGER "TRG_DET_LIQUIDACION_AIUD" ENABLE;

  ALTER TABLE "EMPLEADO" ADD CONSTRAINT "FK_EMPLEADO_CARGO" FOREIGN KEY ("ID_CARGO")
	  REFERENCES "CARGO" ("ID_CARGO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMPLEADO" 
before insert on empleado 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_empleado is null then 
            cgui$cg_code_controls('SEQ_EMPLEADO', V_NEXT_VAL);

            :NEW.ID_EMPLEADO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMPLEADO" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_HISTORICO_CARGO" 
AFTER INSERT OR UPDATE OF id_cargo ON empleado
FOR EACH ROW
BEGIN
    -- Cuando se inserta un empleado nuevo
    IF INSERTING THEN
        INSERT INTO historico_cargo (
            emp_id_empleado,
            car_id_cargo,
            fecha_inicio,
            fecha_fin
        ) VALUES (
            :NEW.id_empleado,
            :NEW.id_cargo,
            current_date,
            NULL
        );

    -- Cuando se actualiza el empleado
    ELSIF UPDATING('ID_CARGO') THEN

        -- Sólo si realmente cambió el cargo
        IF :NEW.id_cargo <> :OLD.id_cargo THEN
            
            -- Cierro el registro anterior
            UPDATE historico_cargo
               SET fecha_fin = current_date
             WHERE emp_id_empleado = :OLD.id_empleado
               AND car_id_cargo   = :OLD.id_cargo
               AND fecha_fin IS NULL;

            -- Inserto el nuevo registro de histórico
            INSERT INTO historico_cargo (
                emp_id_empleado,
                car_id_cargo,
                fecha_inicio,
                fecha_fin
            ) VALUES (
                :NEW.id_empleado,
                :NEW.id_cargo,
                current_date,
                NULL
            );
        END IF;
    END IF;
END trg_historico_cargo;
/
ALTER TRIGGER "TRG_HISTORICO_CARGO" ENABLE;

  ALTER TABLE "EMPLEADO_CONCEPTO" ADD CONSTRAINT "CON_EMP_EMP_FK" FOREIGN KEY ("EMP_ID_EMPLEADO")
	  REFERENCES "EMPLEADO" ("ID_EMPLEADO") ENABLE;
  ALTER TABLE "EMPLEADO_CONCEPTO" ADD CONSTRAINT "CON_EMP_CON_FK" FOREIGN KEY ("CON_ID_CONCEPTO")
	  REFERENCES "CONCEPTO_SALARIAL" ("ID_CONCEPTO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMP_CON" 
before insert on empleado_concepto
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_emp_con is null then 
            cgui$cg_code_controls('SEQ_EMP_CON', V_NEXT_VAL);

            :NEW.id_emp_con := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMP_CON" ENABLE;

  ALTER TABLE "HIJO" ADD CONSTRAINT "FK_HIJO_EMPLEADO" FOREIGN KEY ("EMP_ID_EMPLEADO")
	  REFERENCES "EMPLEADO" ("ID_EMPLEADO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HIJO" 
before insert on HIJO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_hijo is null then 
            cgui$cg_code_controls('SEQ_HIJO', V_NEXT_VAL);

            :NEW.ID_HIJO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HIJO" ENABLE;

  ALTER TABLE "HISTORIAL_CARGO" ADD CONSTRAINT "FK_HISTCARGO_EMPLEADO" FOREIGN KEY ("EMP_ID_EMPLEADO")
	  REFERENCES "EMPLEADO" ("ID_EMPLEADO") ENABLE;
  ALTER TABLE "HISTORIAL_CARGO" ADD CONSTRAINT "FK_HISTCARGO_CARGO" FOREIGN KEY ("CAR_ID_CARGO")
	  REFERENCES "CARGO" ("ID_CARGO") ENABLE;

  ALTER TABLE "HISTORICO_CARGO" ADD CONSTRAINT "HIST_CAR_EMP_FK" FOREIGN KEY ("EMP_ID_EMPLEADO")
	  REFERENCES "EMPLEADO" ("ID_EMPLEADO") ENABLE;
  ALTER TABLE "HISTORICO_CARGO" ADD CONSTRAINT "HIST_CAR_CARGO_FK" FOREIGN KEY ("CAR_ID_CARGO")
	  REFERENCES "CARGO" ("ID_CARGO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HISTORICO_CARGO" 
before insert on HISTORICO_CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.ID_HISTORICO_CARGO is null then 
            cgui$cg_code_controls('SEQ_HISTORIAL_CARGO', V_NEXT_VAL);

            :NEW.ID_HISTORICO_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HISTORICO_CARGO" ENABLE;

  ALTER TABLE "JRXML_REPORT_IMAGES" ADD CONSTRAINT "JRI_JRD_FK" FOREIGN KEY ("JRI_JRD_ID")
	  REFERENCES "JRXML_REPORT_DEFINITIONS" ("JRD_ID") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRI_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_report_images
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRI_ADLER32_VALID:='N';
  ELSE
    IF     :OLD.JRI_ADLER32_VALID='Y'
       AND :NEW.JRI_ADLER32_VALID='Y' THEN
      :NEW.JRI_ADLER32_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRI_RUI" ENABLE;

  ALTER TABLE "JRXML_RESOURCE_ENTRIES" ADD CONSTRAINT "JRS_JRR_FK" FOREIGN KEY ("JRS_JRR_ID")
	  REFERENCES "JRXML_RESOURCE_FILES" ("JRR_ID") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRR_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_resource_files
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRR_VALID:='N';
  ELSE
    IF     :OLD.JRR_VALID='Y'
       AND :NEW.JRR_VALID='Y' THEN
      :NEW.JRR_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRR_RUI" ENABLE;

  ALTER TABLE "LIQUIDACION" ADD CONSTRAINT "FK_LIQUIDACION_PERIODO" FOREIGN KEY ("PER_ID_PERIODO")
	  REFERENCES "PERIODO_NOMINA" ("ID_PERIODO") ENABLE;
  ALTER TABLE "LIQUIDACION" ADD CONSTRAINT "FK_LIQUIDACION_EMPLEADO" FOREIGN KEY ("EMP_ID_EMPLEADO")
	  REFERENCES "EMPLEADO" ("ID_EMPLEADO") ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_LIQUIDACION" 
before insert on LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_liquidacion is null then 
            cgui$cg_code_controls('SEQ_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_LIQUIDACION" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_PERIODO_NOMINA" 
before insert on PERIODO_NOMINA 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_periodo is null then 
            cgui$cg_code_controls('SEQ_PERIODO', V_NEXT_VAL);

            :NEW.id_periodo := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_PERIODO_NOMINA" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_ROL" 
before insert on rol 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_rol is null then 
            cgui$cg_code_controls('SEQ_ROL', V_NEXT_VAL);

            :NEW.ID_ROL := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_ROL" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "ATIU_ROL" 
AFTER INSERT OR UPDATE ON rol
FOR EACH ROW
BEGIN
  IF if_update(:OLD.permisos, :NEW.permisos) THEN
    pr_det_rol(
      p_id_rol    => :NEW.id_rol,
      p_permisos  => :NEW.permisos
    );
  END IF;
END;
/
ALTER TRIGGER "ATIU_ROL" ENABLE;

  ALTER TABLE "ROL_PERMISOS" ADD CONSTRAINT "FK_ROL_PERMISOS_PERM" FOREIGN KEY ("ID_PERMISOS")
	  REFERENCES "PERMISOS" ("ID_PERMISOS") ENABLE;
  ALTER TABLE "ROL_PERMISOS" ADD CONSTRAINT "FK_ROL_PERMISOS_ROL" FOREIGN KEY ("ID_ROL")
	  REFERENCES "ROL" ("ID_ROL") ENABLE;

  ALTER TABLE "USUARIO" ADD CONSTRAINT "FK_USUARIO_ROL" FOREIGN KEY ("ROL_ID_ROL")
	  REFERENCES "ROL" ("ID_ROL") ENABLE;
create or replace function devuelve_id_usuario(p_username IN VARCHAR2 default f_user)
RETURN number IS
    v_id_usuario number;
BEGIN
    begin
      select ID_EMPLEADO
      into v_id_usuario
        from empleado
        where usuario = p_username;
    EXCEPTION
        when no_data_found then
            v_id_usuario := null;
    end;
    return v_id_usuario;
end;
/
create or replace FUNCTION FN_GET_NEXT_VAL(p_sec_name IN VARCHAR2)
RETURN NUMBER
IS
  v_current_val  NUMBER;
  v_incremento   NUMBER;
BEGIN
  -- Bloqueo la fila para concurrencia segura
  SELECT sec_sig_valor, sec_incremento
    INTO v_current_val, v_incremento
    FROM secuencia
   WHERE sec_nombre = p_sec_name;

  -- Avanzo el siguiente
  UPDATE secuencia
     SET sec_sig_valor = v_current_val + v_incremento
   WHERE sec_nombre = p_sec_name;

  -- No hagas COMMIT aquí; que lo haga el caller
  RETURN v_current_val;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN -1; -- o lanza una excepción si preferís
END;
/
create or replace FUNCTION fn_rol_persona (
    p_id_persona IN NUMBER,
    p_permiso    IN VARCHAR2
) RETURN BOOLEAN IS
    v_id_rol rol.id_rol%TYPE;
    dummy    CHAR(1);
BEGIN
    SELECT
        rol_id_rol
    INTO v_id_rol
    FROM
        rol_persona
    WHERE
        per_id_persona = p_id_persona;

    SELECT
        NULL
    INTO dummy
    FROM
        det_rol
    WHERE
            rol_id_rol = v_id_rol
        AND permiso = p_permiso;

    RETURN true;
EXCEPTION
    WHEN no_data_found THEN
        RETURN false;
END;
/
create or replace function f_user
RETURN VARCHAR2 IS
begin 
    return nvl(v('app_user'),replace(USER,'C##',''));
end;
/
create or replace FUNCTION if_update (
    p_new IN VARCHAR2,
    p_old IN VARCHAR2
) RETURN BOOLEAN IS
BEGIN
  IF p_new IS NULL AND p_old IS NULL THEN
    RETURN FALSE;
  ELSIF p_new = p_old THEN
    RETURN FALSE;
  ELSE
    RETURN TRUE;
  END IF;
END;
/
































































































  CREATE UNIQUE INDEX "EMP_CON_PK" ON "EMPLEADO_CONCEPTO" ("ID_EMP_CON") 
  ;

  CREATE UNIQUE INDEX "HISTORICO_CARGO_PK" ON "HISTORICO_CARGO" ("ID_HISTORICO_CARGO") 
  ;

  CREATE UNIQUE INDEX "JAT_PK" ON "JRXML_APEX2JRXML_TEMPLATES" ("JAT_ID") 
  ;

  CREATE UNIQUE INDEX "JAT_UK" ON "JRXML_APEX2JRXML_TEMPLATES" ("JAT_TYPE", "JAT_NAME") 
  ;

  CREATE UNIQUE INDEX "JRD_PK" ON "JRXML_REPORT_DEFINITIONS" ("JRD_ID") 
  ;

  CREATE UNIQUE INDEX "JRD_UK" ON "JRXML_REPORT_DEFINITIONS" ("JRD_NAME") 
  ;

  CREATE UNIQUE INDEX "JRF_PK" ON "JRXML_FONTS" ("JRF_ID") 
  ;

  CREATE UNIQUE INDEX "JRF_UK" ON "JRXML_FONTS" ("JRF_NAME") 
  ;

  CREATE UNIQUE INDEX "JRI_PK" ON "JRXML_REPORT_IMAGES" ("JRI_ID") 
  ;

  CREATE UNIQUE INDEX "JRI_UK" ON "JRXML_REPORT_IMAGES" ("JRI_JRD_ID", "JRI_NAME") 
  ;

  CREATE UNIQUE INDEX "JRL_PK" ON "JRXML_LOGGING" ("JRL_ID") 
  ;

  CREATE UNIQUE INDEX "JRN_PK" ON "JRXML_NLS_PARAMETERS" ("JRN_ID") 
  ;

  CREATE UNIQUE INDEX "JRN_UK" ON "JRXML_NLS_PARAMETERS" ("JRN_LOCALE_LANGUAGE", "JRN_LOCALE_COUNTRY") 
  ;

  CREATE UNIQUE INDEX "JRR_PK" ON "JRXML_RESOURCE_FILES" ("JRR_ID") 
  ;

  CREATE UNIQUE INDEX "JRR_UK" ON "JRXML_RESOURCE_FILES" ("JRR_NAME", "JRR_LOCALE") 
  ;

  CREATE UNIQUE INDEX "JRS_PK" ON "JRXML_RESOURCE_ENTRIES" ("JRS_ID") 
  ;

  CREATE UNIQUE INDEX "JRS_UK" ON "JRXML_RESOURCE_ENTRIES" ("JRS_JRR_ID", "JRS_KEY") 
  ;

  CREATE UNIQUE INDEX "MES_ANHO_UK" ON "PERIODO_NOMINA" ("ANHO", "MES") 
  ;

  CREATE UNIQUE INDEX "PK_CARGO" ON "CARGO" ("ID_CARGO") 
  ;

  CREATE UNIQUE INDEX "PK_CONCEPTO_SALARIAL" ON "CONCEPTO_SALARIAL" ("ID_CONCEPTO") 
  ;

  CREATE UNIQUE INDEX "PK_DETALLE_LIQUIDACION" ON "DET_LIQUIDACION" ("ID_DET_LIQUIDACION") 
  ;

  CREATE UNIQUE INDEX "PK_EMPLEADO" ON "EMPLEADO" ("ID_EMPLEADO") 
  ;

  CREATE UNIQUE INDEX "PK_HIJO" ON "HIJO" ("ID_HIJO") 
  ;

  CREATE UNIQUE INDEX "PK_HISTORIAL_CARGO" ON "HISTORIAL_CARGO" ("ID_HIST_CARGO") 
  ;

  CREATE UNIQUE INDEX "PK_LIQUIDACION" ON "LIQUIDACION" ("ID_LIQUIDACION") 
  ;

  CREATE UNIQUE INDEX "PK_PERIODO_NOMINA" ON "PERIODO_NOMINA" ("ID_PERIODO") 
  ;

  CREATE UNIQUE INDEX "PK_PERMISOS" ON "PERMISOS" ("ID_PERMISOS") 
  ;

  CREATE UNIQUE INDEX "PK_ROL" ON "ROL" ("ID_ROL") 
  ;

  CREATE UNIQUE INDEX "PK_ROL_PERMISOS" ON "ROL_PERMISOS" ("ID_PERMISOS", "ID_ROL") 
  ;

  CREATE UNIQUE INDEX "PK_SALARIO_MINIMO" ON "SALARIO_MINIMO" ("ID_SALARIO_MINIMO") 
  ;

  CREATE UNIQUE INDEX "PK_USUARIO" ON "USUARIO" ("ID_USUARIO") 
  ;

  CREATE UNIQUE INDEX "UQ_USUARIO_CORREO" ON "USUARIO" ("CORREO") 
  ;

  CREATE UNIQUE INDEX "UQ_USUARIO_USERNAME" ON "USUARIO" ("USERNAME") 
  ;






































create or replace package as_pdf3_mod
is
/**********************************************
**
** Additional comment by Andreas Weiden:
**AS_PDF3_MOD
** The following methods were added by me for additinal functionality needed for PK_JRXML_REPGEN
**
** -   PR_GOTO_PAGE
** -   PR_GOTO_CURRENT_PAGE;
** -   PR_LINE
** -   PR_POLYGON
** -   PR_PATH
**
** Changed in parameter p_txt for procedure raw2page  from blob to raw
** Added global collection g_settings_per_tab to store different pageformat for each page.
** changed add_page to write a MediaBox-entry with the g_settings_per_tab-content for each page
**
** Change in subset_font:Checking for raw-length reduced from 32778 to 32000 because of raw-length-error
** in specific cases
**
** Various changes for font-usage: The access to g_fonts(g_current_font) is very slow, replaced it with a specific font-record
** which is filled when g_current_font changes
**
** Changes in adler32: The num-value of a hex-byte is no longer calculated by a to_number, but taken from an associative array
** done for preformance
**
** Changes in put_image_methods: the adler32-value can be provided from outside
***/
/**********************************************
**
** Author: Anton Scheffer
** Date: 11-04-2012
** Website: http://technology.amis.nl
** See also: http://technology.amis.nl/?p=17718
**
** Changelog:
**   Date: 16-04-2012
**     changed code for parse_png
**   Date: 15-04-2012
**     only dbms_lob.freetemporary for temporary blobs
**   Date: 11-04-2012
**     Initial release of as_pdf3
**
******************************************************************************
******************************************************************************
Copyright (C) 2012 by Anton Scheffer
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
******************************************************************************
******************************************** */
--
  c_get_page_width    constant pls_integer := 0;
  c_get_page_height   constant pls_integer := 1;
  c_get_margin_top    constant pls_integer := 2;
  c_get_margin_right  constant pls_integer := 3;
  c_get_margin_bottom constant pls_integer := 4;
  c_get_margin_left   constant pls_integer := 5;
  c_get_x             constant pls_integer := 6;
  c_get_y             constant pls_integer := 7;
  c_get_fontsize      constant pls_integer := 8;
  c_get_current_font  constant pls_integer := 9;
  type tVertices is table of number index by pls_integer;
  PATH_MOVE_TO    CONSTANT NUMBER:=1;
  PATH_LINE_TO    CONSTANT NUMBER:=2;
  PATH_CURVE_TO   CONSTANT NUMBER:=3;
  PATH_CLOSE      CONSTANT NUMBER:=4;
  type tPathElement IS RECORD (
    nType NUMBER,
    nVal1 NUMBER,
    nVal2 NUMBER,
    nVal3 NUMBER,
    nVal4 NUMBER,
    nVal5 NUMBER,
    nVal6 NUMBER
  );
  TYPE tPath IS TABLE OF tPathElement INDEX BY BINARY_INTEGER;
--
  function file2blob( p_dir varchar2, p_file_name varchar2 )
  return blob;
--
  function conv2uu( p_value number, p_unit varchar2 )
  return number;
--
  procedure set_page_size
    ( p_width number
    , p_height number
    , p_unit varchar2 := 'cm'
    );
--
  procedure set_page_format( p_format varchar2 := 'A4' );
--
  procedure set_page_orientation( p_orientation varchar2 := 'PORTRAIT' );
--
  procedure set_margins
    ( p_top number := null
    , p_left number := null
    , p_bottom number := null
    , p_right number := null
    , p_unit varchar2 := 'cm'
    );
--
  procedure set_info
    ( p_title varchar2 := null
    , p_author varchar2 := null
    , p_subject varchar2 := null
    , p_keywords varchar2 := null
    );
--
  procedure init;
--
  function get_pdf
  return blob;
--
  procedure save_pdf
    ( p_dir varchar2 := 'MY_DIR'
    , p_filename varchar2 := 'my.pdf'
    , p_freeblob boolean := true
    );
--
  procedure txt2page( p_txt varchar2 );
--
  procedure put_txt( p_x number, p_y number, p_txt varchar2, p_degrees_rotation number := null );
--
  function str_len( p_txt varchar2 )
  return number;
--
  procedure write
    ( p_txt in varchar2
    , p_x in number := null
    , p_y in number := null
    , p_line_height in number := null
    , p_start in number := null -- left side of the available text box
    , p_width in number := null -- width of the available text box
    , p_alignment in varchar2 := null
    );
--
  procedure set_font
    ( p_index pls_integer
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    );
--
  function set_font
    ( p_fontname varchar2
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    )
  return pls_integer;
--
  procedure set_font
    ( p_fontname varchar2
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    );
--
  function set_font
    ( p_family varchar2
    , p_style varchar2 := 'N'
    , p_fontsize_pt number := null
    , p_output_to_doc boolean := true
    )
  return pls_integer;
--
  procedure set_font
    ( p_family varchar2
    , p_style varchar2 := 'N'
    , p_fontsize_pt number := null
    , p_output_to_doc boolean := true
    );
--
  procedure new_page;
--
  function load_ttf_font
    ( p_font blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    , p_offset number := 1
    )
  return pls_integer;
--
  procedure load_ttf_font
    ( p_font blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    , p_offset number := 1
    );
--
  function load_ttf_font
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'BAUHS93.TTF'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    )
  return pls_integer;
--
  procedure load_ttf_font
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'BAUHS93.TTF'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    );
--
  procedure load_ttc_fonts
    ( p_ttc blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    );
--
  procedure load_ttc_fonts
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'CAMBRIA.TTC'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    );
--
  procedure set_color( p_rgb varchar2 := '000000' );
--
  procedure set_color
    ( p_red number := 0
    , p_green number := 0
    , p_blue number := 0
    );
--
  procedure set_bk_color( p_rgb varchar2 := 'ffffff' );
--
  procedure set_bk_color
    ( p_red number := 0
    , p_green number := 0
    , p_blue number := 0
    );
--
  procedure horizontal_line
    ( p_x in number
    , p_y in number
    , p_width in number
    , p_line_width in number := 0.5
    , p_line_color in varchar2 := '000000'
    );
--
  procedure vertical_line
    ( p_x in number
    , p_y in number
    , p_height in number
    , p_line_width in number := 0.5
    , p_line_color in varchar2 := '000000'
    );
--
  procedure rect
    ( p_x in number
    , p_y in number
    , p_width in number
    , p_height in number
    , p_line_color in varchar2 := null
    , p_fill_color in varchar2 := null
    , p_line_width in number := 0.5
    );
--
  function get( p_what in pls_integer )
  return number;
--
  procedure put_image
    ( p_img blob
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
    );
--
  procedure put_image
    ( p_dir varchar2
    , p_file_name varchar2
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
    );
--
  procedure put_image
    ( p_url varchar2
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
    );
--
  procedure set_page_proc( p_src clob );
--
  type tp_col_widths is table of number;
  type tp_headers is table of varchar2(32767);
--
  procedure query2table
    ( p_query varchar2
    , p_widths tp_col_widths := null
    , p_headers tp_headers := null
    );
--
  PROCEDURE PR_GOTO_PAGE(i_nPage IN NUMBER);
  PROCEDURE PR_GOTO_CURRENT_PAGE;
  PROCEDURE PR_LINE(i_nX1         IN NUMBER,
                    i_nY1         IN NUMBER,
                    i_nX2         IN NUMBER,
                    i_nY2         IN NUMBER,
                    i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                    i_nLineWidth  IN NUMBER DEFAULT 0.5,
                    i_vcStroke    IN VARCHAR2 DEFAULT NULL
                   );
  PROCEDURE PR_POLYGON(i_lXs         IN tVertices,
                       i_lYs         IN tVertices,
                       i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                       i_vcFillColor IN VARCHAR2 DEFAULT NULL,
                       i_nLineWidth  IN NUMBER DEFAULT 0.5
                      );
  PROCEDURE PR_PATH(i_lPath       IN tPath,
                    i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                    i_vcFillColor IN VARCHAR2 DEFAULT NULL,
                    i_nLineWidth  IN NUMBER DEFAULT 0.5
                   );
  function adler32( p_src in blob )
  return varchar2;
$IF not DBMS_DB_VERSION.VER_LE_10 $THEN
  procedure refcursor2table
    ( p_rc sys_refcursor
    , p_widths tp_col_widths := null
    , p_headers tp_headers := null
    );
--
$END
end;
/
create or replace PACKAGE pkg_utils IS
  FUNCTION app_error_handling (
      p_error IN apex_error.t_error
  ) RETURN apex_error.t_error_result;
END pkg_utils;
/
create or replace PACKAGE pk_jrxml2pdf_apex2jrxml IS
/* *****************************************************************************
Copyright (C) 2012-2013 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_APEX2JRXML
  $created 01.04.2013
  $author  Andreas Weiden
  $desc    package for the creation of JRXML-report-definitions out of the definition
           of a given APEX-pages
  $version 0.5.0.0 01.04.2013 Weiden
           initial draft-version
*/
/**
  $name    PR_INIT_COLLECTION
  $created 01.04.2013
  $author  Andreas Weiden
  $desc    initializes the APEX-collection JRXML with the data from
           the regions of the given APEX-page
  $param   i_nApplicationId APEX-application-id
  $param   i_nPageId APEX-page-id
  $version 1.0.0.0 01.04.2013 Weiden
           initial draft-version
*/
  PROCEDURE PR_INIT_COLLECTION(i_nApplicationId IN NUMBER,
                               i_nPageid        IN NUMBER);
/**
  $name    PR_GENERATE_JRXML
  $created 01.04.2013
  $author  Andreas Weiden
  $desc    takes the given data along with the defintions in the APEX-collection
           JRXML and generates a JRXML-rport-definition out of it.
           The result is stored JRXML_REPORt_DEFINITIONS
  $param   i_nApplicationId        APEX-application-id
  $param   i_nPageId               APEX-page-id
  $param   i_vcReportName          The name used to store the resulting JRXML

  $param   i_nReportTemplateId     The overall template

  $param   i_nBackgroundTemplateId additional template for the background-band

  $param   i_nTitelTemplateId      additional template for the title-band

  $param   i_nSummaryTemplateId    additional template for the summary-band

  $param   i_nPageheaderTemplateId additional template for the pageheader-band

  $param   i_nPagefooterTemplateId additional template for the pagefooter-band
  $version 1.0.0.0 01.04.2013 Weiden
           initial draft-version
*/
  PROCEDURE PR_GENERATE_JRXML(i_nApplicationId        IN NUMBER,
                              i_nPageId               IN NUMBER,
                              i_vcReportName          IN VARCHAR2,
                              i_nReportTemplateId     IN NUMBER,
                              i_nBackgroundTemplateId IN NUMBER,
                              i_nTitelTemplateId      IN NUMBER,
                              i_nSummaryTemplateId    IN NUMBER,
                              i_nPageheaderTemplateId IN NUMBER,
                              i_nPagefooterTemplateId IN NUMBER);
END;
/
create or replace PACKAGE pk_jrxml2pdf_charts AUTHID CURRENT_USER IS
/* *****************************************************************************
Copyright (C) 2012-2014 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
  /** ******************************************************************************
      The algorithms in the function FK_CALC_PIESLICE where adopted from
      the java-class EllipticalArc witten by Luc Maisonobe.
      Here the original copyright-text from that class:
      // Copyright (c) 2003-2004, Luc Maisonobe
      // All rights reserved.
      //
      // Redistribution and use in source and binary forms, with
      // or without modification, are permitted provided that
      // the following conditions are met:
      //
      //    Redistributions of source code must retain the
      //    above copyright notice, this list of conditions and
      //    the following disclaimer.
      //    Redistributions in binary form must reproduce the
      //    above copyright notice, this list of conditions and
      //    the following disclaimer in the documentation
      //    and/or other materials provided with the
      //    distribution.
      //    Neither the names of spaceroots.org, spaceroots.com
      //    nor the names of their contributors may be used to
      //    endorse or promote products derived from this
      //    software without specific prior written permission.
      //
      // THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
      // CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
      // WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
      // WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
      // PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
      // THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY
      // DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
      // CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
      // PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
      // USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
      // HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER
      // IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
      // NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
      // USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
      // POSSIBILITY OF SUCH DAMAGE.
  ******************************************************************************/
/**
  $name    PK_JRXML2PDF_CHARTS
  $created 30.10.2012
  $author  Andreas Weiden
  $desc    package for the creation of chart-diagrams into a PDF-document
           created by AS_PDF3_MOD.
           It can be used standalone with AS_PDF3_MOD for "handmade" PDF's,
           but its also part of the PK_JRXML2PDF-engine to render charts into
           PDF's generated with PK_JRXML2PDF_REPGEN
  $version 0.1.0.0 30.10.2012 Weiden
           initial draft-version
  $version 0.1.1.0 25.11.2012 Weiden
           initial version
  $version 1.0.0.0 28.12.2012 Weiden
           First release-version
  $version 1.1.0.0 28.12.2012 Weiden
           Added stacked areachart
*/
  SUBTYPE tTitle          IS VARCHAR2(2000);
  SUBTYPE tName           IS VARCHAR2(2000);
  SUBTYPE tTitlePosition  IS PK_JRXML2PDF_TYPES.tPosition;
  SUBTYPE tAxisType       IS NUMBER;
  SUBTYPE tValueType      IS NUMBER;
  SUBTYPE tOrientation    IS NUMBER;
  SUBTYPE tLegendPosition IS PK_JRXML2PDF_TYPES.tPosition;
  SUBTYPE tValuePosition  IS NUMBER;
  TYPE tPaddings IS RECORD (
    nLeft   NUMBER,
    nTop    NUMBER,
    nRight  NUMBER,
    nBottom NUMBER
  );
  TYPE tDataEntry IS RECORD (
    nValue  NUMBER,
    vcValue PK_JRXML2PDF_TYPES.tMaxVarchar2,
    dtValue DATE
  );
  TYPE tDataEntryList IS TABLE OF tdataEntry INDEX BY BINARY_INTEGER;
  TYPE tTickEntry IS RECORD (
    rDataEntry   tDataEntry,
    vcPattern    PK_JRXML2PDF_TYPES.tPattern,
    vcUnit       VARCHAR2(20)
  );
  TYPE tTickEntryList IS TABLE OF tTickEntry INDEX BY PK_JRXML2PDF_TYPES.tMaxVarchar2;
  TYPE tAxis IS RECORD (
    nAxisType            tAxisType,
    nValueType           tValueType,
    nOrientation         tOrientation,
    nPosition            NUMBER,
    nMinValueType        NUMBER,
    nMaxValueType        NUMBER,
    nAdditionalPercent   NUMBER,
    nHeightType          NUMBER,
    nWidthType           NUMBER,
    vcInclude0Value      PK_JRXML2PDF_TYPES.tYesNo,
    vcDatatype           PK_JRXML2PDF_TYPES.tDatatype,
    nMinMaxDiff          NUMBER,
    nPixelPerUnit        NUMBER,
    rMinValueDataEntry   tDataEntry,
    rMaxValueDataEntry   tDataEntry,
    nHeight              NUMBER,
    nWidth               NUMBER,
    nX                   NUMBER,
    nY                   NUMBER,
    vcDotLineColor       PK_JRXML2PDF_TYPES.tColor,
    bAutoTick            BOOLEAN,
    nTickSpace           NUMBER,
    nTickOffset          NUMBER,
    lTickEntries         tTickEntryList,
    vcTickLabelPattern   PK_JRXML2PDF_TYPES.tPattern,
    vcShowTickLabels     PK_JRXML2PDF_TYPES.tYesNo,
    vcShowTickMarks      PK_JRXML2PDF_TYPES.tYesNo,
    vcShowDotlines       PK_JRXML2PDF_TYPES.tYesNo,
    vcLabelText          PK_JRXML2PDF_TYPES.tExpression,
    vcLabelColor         PK_JRXML2PDF_TYPES.tColor,
    vcLabelFont          PK_JRXML2PDF_TYPES.tFont,
    vcLabelFontStyle     PK_JRXML2PDF_TYPES.tFontStyle,
    nLabelFontSize       NUMBER,
    vcTickLabelColor     PK_JRXML2PDF_TYPES.tColor,
    vcTickLabelFont      PK_JRXML2PDF_TYPES.tFont,
    vcTickLabelFontStyle PK_JRXML2PDF_TYPES.tFontStyle,
    nTickLabelFontSize   NUMBER,
    nTicklabelRotation   NUMBER,
    vcLineColor          PK_JRXML2PDF_TYPES.tColor,
    nAxisLineWidth       NUMBER,
    nStartOffset         NUMBER,
    nEndOffset           NUMBER,
    nDataOffset          NUMBER,
    nTickLabelOffset     NUMBER
  );
  TYPE tAxisList IS TABLE OF tAxis INDEX BY BINARY_INTEGER;
  TYPE tDataset IS RECORD (
    vcValueType        PK_JRXML2PDF_TYPES.tDatatype,
    vcRangeType        PK_JRXML2PDF_TYPES.tDatatype,
    nGroup            NUMBER,
    nSeries           NUMBER,
    nValueAxis        NUMBER,
    nRangeAxis        NUMBER,
    lValueDataEntries tDataEntryList,
    lRangeDataEntries tDataEntryList
  );
  TYPE tDatasetList IS TABLE OF tDataset INDEX BY BINARY_INTEGER;
  TYPE tSeries IS RECORD (
    vcColor       PK_JRXML2PDF_TYPES.tColor,
    vcBorderColor PK_JRXML2PDF_TYPES.tColor,
    vcName        tName,
    lShapePath    AS_PDF3_MOD.tPath
  );
  TYPE tSeriesList IS TABLE OF tSeries INDEX BY BINARY_INTEGER;
  TYPE tPlot IS RECORD (
    nType            NUMBER,
    lDataSets        tDatasetList,
    nLabelPosition   tValuePosition,
    vcLabelColor     PK_JRXML2PDF_TYPES.tColor,
    vcLabelFont      PK_JRXML2PDF_TYPES.tFont,
    vcLabelFontStyle PK_JRXML2PDF_TYPES.tFontStyle,
    vcLabelPattern   PK_JRXML2PDF_TYPES.tPattern,
    nLabelFontSize   NUMBER,
    nCategorySpace   NUMBER,
    nSeriesSpace     NUMBER,
    vcIsDonut        PK_JRXML2PDF_TYPES.tYesNo,
    vcLabelFormat    PK_JRXML2PDF_TYPES.tMaxVarchar2,
    vcKeyFormat      PK_JRXML2PDF_TYPES.tMaxVarchar2,
    vcShowLines      PK_JRXML2PDF_TYPES.tYesNo,
    vcShowShapes     PK_JRXML2PDF_TYPES.tYesNo
  );
  TYPE tPlotList IS TABLE OF tPlot INDEX BY BINARY_INTEGER;
  TYPE tLegend IS RECORD (
    nX                      NUMBER,
    nY                      NUMBER,
    nWidth                  NUMBER,
    nHeight                 NUMBER,
    rPlot                   tPlot,
    vcPosition              tLegendPosition,
    vcFont                  PK_JRXML2PDF_TYPES.tFont,
    vcFontStyle             PK_JRXML2PDF_TYPES.tFontStyle,
    nFontSize               NUMBER,
    vcFontColor             PK_JRXML2PDF_TYPES.tColor,
    vcBgColor               PK_JRXML2PDF_TYPES.tColor,
    vcBorderColor           PK_JRXML2PDF_TYPES.tColor,
    rOuterPaddings          tPaddings,
    rInnerPaddings          tPaddings,
    nEntryXSpacing          NUMBER,
    nEntryYSpacing          NUMBER,
    nScaleToWidthPercentage NUMBER
  );
  TYPE tChart IS RECORD (
    lPlots              tPlotList,
    lSeries             tSeriesList,
    lValueAxis          tAxisList,
    lRangeAxis          tAxisList,
    rLegend             tLegend,
    nWidth              NUMBER,
    nHeight             NUMBER,
    vcBgColor           PK_JRXML2PDF_TYPES.tColor,
    vcBorderColor       PK_JRXML2PDF_TYPES.tColor,
    nBorderWidth        NUMBER,
    vcTitle             tTitle,
    vcTitleFont         PK_JRXML2PDF_TYPES.tFont,
    vcTitleFontStyle    PK_JRXML2PDF_TYPES.tFontStyle,
    nTitleFontSize      NUMBER,
    vcTitleColor        PK_JRXML2PDF_TYPES.tColor,
    vcSubTitle          tTitle,
    vcSubTitleFont      PK_JRXML2PDF_TYPES.tFont,
    vcSubTitleFontStyle PK_JRXML2PDF_TYPES.tFontStyle,
    nSubTitleFontSize   NUMBER,
    vcSubTitleColor     PK_JRXML2PDF_TYPES.tColor,
    vcTitlePosition     PK_JRXML2PDF_TYPES.tPosition,
    vcIs3D              PK_JRXML2PDF_TYPES.tYesNo,
    rInnerPaddings      tPaddings,
    rLocaleData         PK_JRXML2PDF_TYPES.tLocaleData
  );
  PLOT_CATEGORY_BARCHART    CONSTANT NUMBER:=1;
  PLOT_XY_LINECHART         CONSTANT NUMBER:=2;
  PLOT_PIECHART             CONSTANT NUMBER:=3;
  PLOT_CATEGORY_LINECHART   CONSTANT NUMBER:=4;
  PLOT_TIMESERIES_LINECHART CONSTANT NUMBER:=5;
  PLOT_METER_CHART          CONSTANT NUMBER:=6;
  PLOT_STACKED_BARCHART     CONSTANT NUMBER:=7;
  PLOT_STACKED_AREACHART    CONSTANT NUMBER:=8;

  VALUE_AUTOMATIC           CONSTANT NUMBER:=1;
  VALUE_FIXED               CONSTANT NUMBER:=2;
  POSITION_TOP_OR_LEFT      CONSTANT NUMBER:=1;
  POSITION_BOTTOM_OR_RIGHT  CONSTANT NUMBER:=2;
  POSITION_HIDDEN           CONSTANT NUMBER:=3;
  POSITION_NONE             CONSTANT PK_JRXML2PDF_TYPES.tPosition:='None';
  POSITION_TOP              CONSTANT PK_JRXML2PDF_TYPES.tPosition:='Top';
  POSITION_BOTTOM           CONSTANT PK_JRXML2PDF_TYPES.tPosition:='Bottom';
  POSITION_LEFT             CONSTANT PK_JRXML2PDF_TYPES.tPosition:='Left';
  POSITION_RIGHT            CONSTANT PK_JRXML2PDF_TYPES.tPosition:='Right';
  VALUE_POSITION_NONE       CONSTANT NUMBER:=1;
  VALUE_POSITION_OUTSIDE    CONSTANT NUMBER:=2;
  VALUE_POSITION_INSIDE     CONSTANT NUMBER:=3;
  AXIS_TYPE_VALUE           CONSTANT NUMBER:=1;
  AXIS_TYPE_RANGE           CONSTANT NUMBER:=2;
  AXIS_VALUE                CONSTANT NUMBER:=1;
  AXIS_CATEGORY             CONSTANT NUMBER:=2;
  ORIENTATION_HORIZONTAL    CONSTANT NUMBER:=1;
  ORIENTATION_VERTICAL      CONSTANT NUMBER:=2;
  rCustomizableChart        tChart;
/**
  $name    FK_RADIANS
  $created 31.12.2012
  $author  Andreas Weiden
  $desc    convert a angkle in degrees to radians
  $param   i_nDegree angle in degree
  $return  angle in radians
  $version 1.0.0.0 31.12.2012 Weiden
           initial version
*/
  FUNCTION FK_RADIANS(i_nDegree IN NUMBER)
  RETURN NUMBER DETERMINISTIC;
/**
  $name    FK_CREATE_CATEGORY_BAR_CHART
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    create a new chart-object for a category-barchart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_CATEGORY_BAR_CHART(i_nWidth  IN NUMBER,
                                        i_nHeight IN NUMBER
                                       )
  RETURN tChart;
/**
  $name    FK_CREATE_CATEGORY_BAR_CHART
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    create a new chart-object for a category-linechart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_CATEGORY_LINE_CHART(i_nWidth  IN NUMBER,
                                         i_nHeight IN NUMBER
                                        )
  RETURN tChart;
/**
  $name    FK_CREATE_XY_LINE_CHART
  $created 18.12.2012
  $author  Andreas Weiden
  $desc    create a new chart-object for a XY-linechart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 18.12.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_XY_LINE_CHART(i_nWidth  IN NUMBER,
                                   i_nHeight IN NUMBER
                                  )
  RETURN tChart;
/**
  $name    FK_CREATE_TIME_LINE_CHART
  $created 24.12.2012
  $author  Andreas Weiden
  $desc    create a new chart-object for a timeseries-linechart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 24.12.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_TIME_LINE_CHART(i_nWidth  IN NUMBER,
                                     i_nHeight IN NUMBER
                                    )
  RETURN tChart;
/**
  $name    FK_CREATE_PIE_CHART
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    create a new chart-object for a piechart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_PIE_CHART(i_nWidth  IN NUMBER,
                               i_nHeight IN NUMBER
                              )
  RETURN tChart;
/**
  $name    FK_CREATE_STACKED_BAR_CHART
  $created 04.01.2013
  $author  Andreas Weiden
  $desc    create a new chart-object for a stacked barchart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 0.1.0.0 04.01.2013 Weiden
           initial version
*/
  FUNCTION FK_CREATE_STACKED_BAR_CHART(i_nWidth  IN NUMBER,
                                       i_nHeight IN NUMBER
                                      )
  RETURN tChart;
/**
  $name    FK_CREATE_STACKED_AREA_CHART
  $created 23.06.2014
  $author  Andreas Weiden
  $desc    create a new chart-object for a stacked areachart
  $param   i_nWidth  Width of the chart
  $param   i_nHeight Height of the chart
  $return  chart-object
  $version 1.0.0.0 23.06.2014 Weiden
           initial version
*/
  FUNCTION FK_CREATE_STACKED_AREA_CHART(i_nWidth  IN NUMBER,
                                        i_nHeight IN NUMBER
                                       )
  RETURN tChart;
/**
  $name    FK_CREATE_SERIES
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    create a new series-object with the given name.
           The series can be added to a chart-object
  $param   i_vcName Name of the series
  $return  series-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_SERIES(i_vcName IN VARCHAR2)
  RETURN tSeries;
/**
  $name    PR_ADD_SERIES
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    adds the given series to the given chart
  $param   io_rChart Chart-object to add the series to
  $param   i_rSeries Series to add
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  PROCEDURE PR_ADD_SERIES(io_rChart IN OUT NOCOPY tChart,
                          i_rSeries IN tSeries);
/**
  $name    FK_CREATE_XY_DATASET
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    returns a dataset-object for xy-data
  $return  dataset-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_XY_DATASET
  RETURN tDataset;
/**
  $name    FK_CREATE_CATEGORY_DATASET
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    returns a dataset-object for category-data
  $return  dataset-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_CATEGORY_DATASET
  RETURN tDataset;
/**
  $name    FK_CREATE_TIMESERIES_DATASET
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    returns a dataset-object for timeseries-data
  $return  dataset-object
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  FUNCTION FK_CREATE_TIMESERIES_DATASET
  RETURN tDataset;
/**
  $name    PR_ADD_DATASET
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    adds the given dataset to the chart-object
           the plotindex defines the plot the dataset belongs to.
           the seriesname defines the series the dataset belongs to.
  $param   io_rChart Chart-object
  $param   i_nPlotIndex Index of the plot the dataset belongs to
  $param   i_rDataset Dataset to add
  $param   i_vcSeries name of the series
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  PROCEDURE PR_ADD_DATASET(io_rChart    IN OUT NOCOPY tChart,
                           i_nPlotIndex IN NUMBER,
                           i_rDataSet   IN tDataset,
                           i_vcSeries   IN VARCHAR2 DEFAULT NULL);
/**
  $name    PR_ADD_DATASET
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    adds the given dataset to the chart-object
           the plotindex defines the plot the dataset belongs to.
           the seriesindexe defines the series the dataset belongs to.
  $param   io_rChart Chart-object
  $param   i_nPlotIndex Index of the plot the dataset belongs to
  $param   i_rDataset Dataset to add
  $param   i_nSeries Index of the series
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  PROCEDURE PR_ADD_DATASET(io_rChart    IN OUT NOCOPY tChart,
                           i_nPlotIndex IN NUMBER,
                           i_rDataSet   IN tDataset,
                           i_nSeries    IN NUMBER);
/**
  $name    PR_CHART_TO_PDF
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    renders the chart-object into the currently processed pdf via
           AS_PDF3_MOD.
           The podf has to initialized before
  $param   i_rChart Chart-object to render
  $param   i_nX      X-position
  $param   i_nY      Y-position
  $version 0.1.0.0 25.11.2012 Weiden
           initial version
*/
  PROCEDURE PR_CHART_TO_PDF(i_rChart  IN tChart,
                            i_nX      IN NUMBER,
                            i_nY      IN NUMBER);
END;
/
create or replace PACKAGE pk_jrxml2pdf_loader AUTHID CURRENT_USER IS
/* *****************************************************************************
Copyright (C) 2012-2014 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_LOADER
  $created 16.10.2012
  $author  Andreas Weiden
  $desc    Package with procedures aand functions to load a report-definition from
           the table JRXML_REPORT_DEFINITIONS into the in-momory-structure of PL-jrxml2pdf
           for further processing
  $version 1.0.0.0 16.10.2012 Weiden
           Out-sourced from PK_JRXML2PDF_REPGEN
  $version 1.1.0.0 31.10.2012 Weiden
           Added support for barcharts and piecharts
  $version 1.1.0.1 10.12.2012 Weiden
           Added support for category-linecharts
  $version 1.1.1.1 23.12.2012 Weiden
           Enhancements and bugfixes for tables:
           - groups in subdatasets are now loaded
           - groups in tables are not loaded
           - corrected handling of columngGroups without columns
           - corrected handling for footer objects
  $version 1.1.1.1 04.01.2013 Weiden
           Added support for stacked barcharts (2D and 3D)
  $version 1.1.1.2 05.02.2013 Weiden
           Bugfixes for ReportLocale in Table-subreports
  $version 1.1.1.3 15.02.2013 Weiden
           Bugfix: Set opaque to No for rects when Mode=Transparent
  $version 1.1.2.3 11.03.2013 Weiden
           Enhance: Add loading of HeaderCell for crosstabs

  $version 1.1.2.4 14.04.2014 Weiden
           Bug-Fix: Enable Queries > 32K
                    Load datasets before groups (enables tables in group-headers)
  $version 1.3.0.0 20.06.2014 Weiden
           Feature: Support for variables
           Enhance: Support for stacked area charts
  $version 1.3.1.0 22.08.2014 Weiden
           Enhance: Change the way to read different tags due to changed
                    XMLTABLE-behaviour in 11.2.0.4
*/
/**
  $name    FK_LOAD_REPORT
  $created 16.10.2012
  $author  Andreas Weiden
  $desc    Loads the report with the given name into memory and returns the result as record
  $param   i_vcReportName Name of the report to be loaded, must match a record in JRXML_REPORT_DEFINITIONS
  $param   i_lParamList   List of parameters and values to pass to the report
  $return  record with report-definition
  $version 1.0.0.0 16.10.2012 Weiden
           initial version
*/
  FUNCTION FK_LOAD_REPORT (i_vcReportName IN VARCHAR2,
                           i_lParamList   IN PK_JRXML2PDF_TYPES.tParamList)
  RETURN PK_JRXML2PDF_TYPES.tReport;
/**
  $name    PR_CLEAR_CACHE
  $created 16.10.2012
  $author  Andreas Weiden
  $desc    Clears the internal report-cache
  $version 1.0.0.0 16.10.2012 Weiden
           initial version
*/
  PROCEDURE PR_CLEAR_CACHE;
/**
  $name    PR_EXECUTE_QUERY
  $created 16.10.2012
  $author  Andreas Weiden
  $desc    Parses and executes the query of the given report
  $param   io_rReport     report-record with the report-definition
  $param   i_lParams      List of parameters and values to pass to the report
  $version 1.0.0.0 16.10.2012 Weiden
           initial version
*/
  PROCEDURE PR_EXECUTE_QUERY(io_rReport IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                             i_lParams  IN PK_JRXML2PDF_TYPES.tParamList);
END;
/
create or replace PACKAGE pk_jrxml2pdf_log IS
/* *****************************************************************************
Copyright (C) 2012 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_LOG

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Helper-Package to generate logging-data.
           This packaged is used by PK_JRXML2PDF_REPGEN to log the process
           of generating a pdf. Depending on the given LEVEL more or less logging-
           information is generated.

           The delivered version uses simple DBMS_OUTPUT for logging. The package may be modified
           to hook in existing logging-frameworks.

           Start logging by calling PR_SET_LEVEL with the appropiate level of detail before running
           a report using PK_JRXML2PDF_REPGEN-methods

  $version 0.5.0.0 22.05.2012 Weiden
           initial version
  $version 0.6.0.0 31.05.2012 Weiden
           Added possibility to log to table JRXML_LOGGING
  $version 0.6.1.0 13.07.2012 Weiden
           Make PR_LOG an autonomous transaction

*/
  -- Constants for the possible logging-levels
  LEVEL_NONE     CONSTANT NUMBER:=0;
  LEVEL_OVERVIEW CONSTANT NUMBER:=1;
  LEVEL_PROCESS  CONSTANT NUMBER:=2;
  LEVEL_DETAIL   CONSTANT NUMBER:=3;
  LEVEL_FINE     CONSTANT NUMBER:=4;
  LEVEL_INTERNAL CONSTANT NUMBER:=5;
  -- constants for the possuble Log-modes
  LOGMODE_DBMS_OUTPUT CONSTANT NUMBER:=0;
  LOGMODE_TABLE       CONSTANT NUMBER:=1;
/**
  $name    PR_SET_LEVEL

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Set the logging-level to the requested level. The higher the level, the more
           details will apear in the logs. LEVEL_NONE stops the generation of loggings

           If i_nLogMode is set to LOGMODE_TABLE, all logings will be written to the table
           JRXML_LOGGING. When calling PR_SET_LEVEL, a unique JRL_RUN_ID is created and applied
           to all following Logs until the next call to PR_SET_LEVEL.

  $param   i_nLevel  level of detail, see constants in the package-spec
  $param   i_nLogMode method of logging, defines if logs are done by DBMS_OUTPUT or into the table JRXML_LOGGING,
                      see constants in the package-spec

  $version 1.0.0.0 22.05.2012 Weiden
           initial version
  $version 1.1.0.0 31.05.2012 Weiden
           Added parameter to set the log-method

*/
  PROCEDURE PR_SET_LEVEL(i_nLevel   IN NUMBER,
                         i_nLogMode IN NUMBER DEFAULT LOGMODE_DBMS_OUTPUT);

/**
  $name    FK_IS_OVERVIEW

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Check if logs with level OVERVIEW will be logged

  $return  TRUE when log-level is LEVEL_OVERVIEW

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  FUNCTION FK_IS_OVERVIEW
  RETURN BOOLEAN;
/**
  $name    FK_IS_PROCESS

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Check if logs with level PROCESS will be logged

  $return  TRUE when log-level is LEVEL_OVERVIEW, LEVEL_PROCESS

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  FUNCTION FK_IS_PROCESS
  RETURN BOOLEAN;
/**
  $name    FK_IS_DETAIL

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Check if logs with level DETAIL will be logged

  $return  TRUE when log-level is LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  FUNCTION FK_IS_DETAIL
  RETURN BOOLEAN;
/**
  $name    FK_IS_FINE

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Check if logs with level FINE will be logged

  $return  TRUE when log-level is LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL, LEVEL_FINE

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  FUNCTION FK_IS_FINE
  RETURN BOOLEAN;
/**
  $name    FK_IS_INTERNAL

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Check if logs with level INTERNAL will be logged

  $return  TRUE when log-level is LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL, LEVEL_FINE, LEVEL_INTERNAL

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  FUNCTION FK_IS_INTERNAL
  RETURN BOOLEAN;
/**
  $name    PR_LOG_OVERVIEW

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Logs the given text when log-level is one of
           LEVEL_OVERVIEW

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  PROCEDURE PR_LOG_OVERVIEW(i_vcText IN VARCHAR2);
/**
  $name    PR_LOG_PROCESS

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Logs the given text when log-level is one of
           LEVEL_OVERVIEW, LEVEL_PROCESS

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  PROCEDURE PR_LOG_PROCESS(i_vcText IN VARCHAR2);
/**
  $name    PR_LOG_DETAIL

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Logs the given text when log-level is one of
           LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  PROCEDURE PR_LOG_DETAIL(i_vcText IN VARCHAR2);
/**
  $name    PR_LOG_FINE

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Logs the given text when log-level is one of
           LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL, LEVEL_FINE

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  PROCEDURE PR_LOG_FINE(i_vcText IN VARCHAR2);
/**
  $name    PR_LOG_INTERNAL

  $created 22.05.2012

  $author  Andreas Weiden

  $desc    Logs the given text when log-level is one of
           LEVEL_OVERVIEW, LEVEL_PROCESS, LEVEL_DETAIL, LEVEL_FINE, LEVEL_INTERNAL

  $version 1.0.0.0 22.05.2012 Weiden
           initial version

*/
  PROCEDURE PR_LOG_INTERNAL(i_vcText IN VARCHAR2);
END;
/
create or replace PACKAGE pk_jrxml2pdf_repgen AUTHID CURRENT_USER IS
/* *****************************************************************************
Copyright (C) 2012-2014 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_REPGEN
  $created 22.05.2012
  $author  Andreas Weiden
  $desc    Package to generate PDF-files from a JRXML-report-definition
           see documentation for further details
  $version 0.5.0.0 22.05.2012 Weiden
           initial beta-version
  $version 0.5.0.1 29.05.2012 Weiden
           Bug-Fix: Init of PDF before loading needed for page-headers with fields
                    Read values of last record in End of page-rendering
  $version 0.5.1.1 30.05.2012 Weiden
           Enhance: Add Parameter i_vcContentDisposition to PR_SHOW_REPORT
  $version 0.6.0.0 31.05.2012 Weiden
           Added support for custom fonts
  $version 0.6.0.1 08.06.2012 Weiden
           Bug-Fixes: Error in Evaluation with more than one field
                      Do not try to load font if fontname is empty
  $version 0.6.1.1 08.06.2012 Weiden
           Enhance: Added Support fur Line-Spacing
                    Rewrite of procedures to calculate Box-Height and write boxed text
                    in preparation for page-overflowing fields
  $version 0.6.3.1 13.07.2012 Weiden
           Enhance/Bugfix: Rewrite of all XMLTABLE-usages because
                           of strange behaviour in 11G 11.2.0.3.0
  $version 0.7.0.0 02.08.2012 Weiden
           Features: - support for jr:table-component with
                       + tableHeader, columnHeader, detailCell, columnFooter and tableFooter-cells
                       + nested columngroups
                       + conditional rendering of columns (only top-level, not inside columngroups)
                       + border around table-component
           Bugfixes: - "Stretch with overflow" in combination with paddings caused
                       missing textparts in multiline text
                     - Styles with names longer than 20 chars where cut off and not applied
                     - Parameter expressions ($P{}) where not parsed
                     - when a frame's content was extended in height, the fill-area for the frame
                       was not adjusted
                     - Special handling of parameter SUBREPORT_DIR
                     - empty expressions lead to endless loop
                     - bandheight could be smaller than minimum bandwidth when using subreports
                       (Thanks to Tom Petrus for providing a solution)
                     - fine-tuning of borders, especially when forming boxes
                     - Style-correction: Bold/Italic from style not used
                     - Style-correction: Boxline-colors and widths from style not used
           Enhance : - The property "mode" is now supported, so that objects without a color and
                       mode not set to "Opaque" are transparent and therefore have the color
                       of the underlying object
                     - the property verticalAlignment is now supported for Static text and textfields
                     - Added expression-support for
                       ! as NOT
                       .startsWith(EXPRESSION) as LIKE ('%' || EXPRESSION || '%')
                     - support for properties pen/@lineWidth and pen/@lineColor in various objects
  $version 0.8.0.0 08.09.2012 Weiden
           Features: - Support for crosstabs
                       + multiple column-groups, row-groups and measures
                       + measure-functions COUNT, AVG, SUM, HIGHEST, LOWEST, FIRST, NOTHING
                       + summaries at start or end
                       + positioning of row- and column-headers
                       + access to summary-variables at detail-level
                       + crosstabs-splitting on page-end or column-end
                     - Locale/NLS-support
                       + Usage of resource-files (including unincode-chars)
                       + Usage of $R{} syntax in expressions
                       + Usage of msg()-function
                       + auto-detection of date-, time-, and number-formats depedning on locale and or nls
                       + support for date-formats short, medium, long and default
           Bugfixes: - NULL-Pagesetup lead to endless loop in calculation of Overflow-fields in Sections other than detail
                     - Objects with negative y-Offset did not render
           Enhance : - Support for group-property isReprintHeaderOnEachPage
                     - Support for group-property minHeightToStartNewPage
                     - Linetuning for linespacings "Single", "1_1_2" and "Double"
                     - Allow to add filename to PR_SHOW_REPORT
                     - support for textfield-property patternExpression
  $version 0.9.0.0 04.10.2012 Weiden
           Features: - support for textfields with markup html both in standard way and enhanced
                       (different implementation than Jasper)
                     - Map-component to show google-maps
           Enhance : - support for property positionType for various objects
                     - support for more thane one subreport in the same detail-section (side-by-side)
                     - support for property Stretch-type in bands, enabling fields to span on different pages
                     - conditional constants for DBMS_SQL-types, so that the package compiles in 10G
           Bugfixes: - Bug introduced in 0.8.0.0 with group-headers starting on new page fixed
                     - VARCHAR2-results larger than 4000 (coming from clob) now works up to 32K
                     - Offset above crosstabs was too large
                     - height of grouped column-headers in tables was caclulated wrong under certain conditions
  $version 1.0.0.0.beta 11.11.2012 Weiden
           Features: - Text-rotation for "standard text" (not for html-markup)
                     - new report-properties for Title on new page and Summary on new page
                     - beta-support for barchart, 3D-barchart and piechart
           Enhance : - code restructured and divided into smaller packages
                     - Performance-Enhancement via DBMS_PROFILER
           Bugfixes: - empty line before first line of HTML-text removed
  $version 1.0.0.1.beta 05.12.2012 Weiden
           Bugfixes: - Corrected wrong framesize for a text with a pagebreak and paddings
  $version 1.0.0.2.beta 06.12.2012 Weiden
           Bugfixes: - Corrected wrong index in FK_GET_QUERY_RESULT if there occurs a pagebreak in
                     - the first record and a field of the record is used in the footer
  $version 1.0.1.3.beta 10.12.2012 Weiden
           Enhance:  - support for category-linechart
           Bugfixes: - Corrected bug in Rendering of HTML with setting "Stretch with overflow"
  $version 1.0.2.3.beta 14.12.2012 Weiden
           Enhance:  - support for property text-align in html-markup
  $version 1.0.2.4.beta 17.12.2012 Weiden
           Bugfix:  - Corrected wrong framesize for a text with a pagebreak and paddings
  $version 1.0.3.4.beta 17.12.2012 Weiden
           Adjusted usage of subdatasets according to new type-structure
  $version 1.0.3.4 28.12.2012 Weiden
           release version
  $version 1.1.0.0 05.01.2013 Weiden
           Features: - run multiple reports into one pdf
                       + possibility of different page-formats
                       + page numbering either continous or starting with 1
                         for each report
           Enhance : - support for stacked barcharts (2D and 3D)
                     - Title, Author, subject and Keywords which are accessible in the
                       properties of the generated pdf, can be set when calling the report by passing
                       parameters $$TITLE$$, $$AUTHOR$$, $$SUBJECT$$, $$KEYWORDS$$
           Bugfixes: - corrected NLS-settings for numbers and dates in charts
  $version 1.2.0.1 05.02.2013 Weiden
           General:  - Fixed version-number-mismatch
           Bugfixes: - Subreports where not allowed in Pageheaders
                     - Locale-settings where not transfered to Table-Subreport
                     - Changes in AS_PDF3_MOD fixing error "invalid RAW-length"
  $version 1.2.0.2 15.02.2013 Weiden
           Bugfixes: - Frames around table-cells did not stretch
                     - Mode "Transparent" for rectangles did not work properly
  $version 1.2.1.2 26.02.2013 Weiden
           Enhance:  - Detection and usage of currency symbol in number-formats
  $version 1.2.1.3 09.03.2013 Weiden
           Bugfix:  - Parameter resolving for cross-tabs was missing
  $version 1.2.2.3 11.03.2013 Weiden
           Enhance: Added support for HeaderCells for crosstabs
  $version 1.2.3.3 06.04.2013 Weiden
           Enhance: - Various performance-changes in AS_PDF3_MOD
                    - Handling of Adler32-checksum for static images
                    - new system parameters
                      + $$EXTERNAL_FONT_ARIAL$$
                      + $$EXTERNAL_FONT_TIMES$$
                      + $$EXTERNAL_FONT_COURIER$$
                      to allow the usage of custom fonts for standard font-names.
  $version 1.2.4.4 07.09.2013 Weiden
           Enhance: - Last line in block-adjusted html is now layoutet left-aligned
                    - Bug-Fix in PK_JRXML2PDF_APEX2JRXML causing endless loop
  $version 1.2.4.5 24.10.2013 Weiden
           Bugfix: When having roups with "Start on new page" set to Yes, the group-footer on
                   the last page of a group shows wrong data (data of next group)
  $version 1.2.4.6 17.01.2014 Weiden
           Bugfixes: Queries longer than 32K caused an error
                     Load datasets before groups (enables tables in group-headers)
                     Enable NULL as valid group-expression
                     Added evaluation of parameters passed to chart-datasets
  $version 1.3.0.0 20.06.2014 Weiden
           Feature: Support for variables
           Enhance: new charttype stacked-area-chart
  $version 1.3.1.1 03.07.2014 Weiden
           Bugfixes: a pagebreak is now rendered if its the only item in a band
                     the page-number with "Reset at group" is now rendered correctly
                     the running sum is now calculated correctly when a group spreads over more than page
*/
  TYPE tParameter IS RECORD (
    vcName  VARCHAR2(255),
    vcValue VARCHAR2(32767)
  );
  TYPE tParamList IS TABLE OF tParameter INDEX BY BINARY_INTEGER;
/**
  $name    FK_RUN
  $created 22.05.2012
  $author  Andreas Weiden
  $desc    Function to create a pdf from the report-definition with the given
           name. A report-definition with that name has to exist in JRXML_REPORT_DEFINITIONS
  $param   i_vcName    Name of the report, must match a record in JRXML_REPORT_DEFINITIONS
  $param   i_lParams   List of parameters and values to pass to the report
  $return  a blob containing the pdf-result
  $version 1.0.0.0 22.05.2012 Weiden
           initial version
*/
  FUNCTION FK_RUN(i_vcName  IN VARCHAR2,
                  i_lParams IN tParamList)
  RETURN BLOB;
/**
  $name    FK_RUN
  $created 22.05.2012
  $author  Andreas Weiden
  $desc    Function to create a pdf from the report-definition with the given
           name. A report-definition with that name has to exist in JRXML_REPORT_DEFINITIONS
  $param   i_vcName    Name of the report, must match a record in JRXML_REPORT_DEFINITIONS
  $return  a blob containing the pdf-result
  $version 1.0.0.0 22.05.2012 Weiden
           initial version
*/
  FUNCTION FK_RUN(i_vcName  IN VARCHAR2)
  RETURN BLOB;
/**
  $name    FK_RUN
  $created 05.01.2013
  $author  Andreas Weiden
  $desc    Function to create one pdf from all the report-definitions given in i_lReports
           name. A report-definition with that name has to exist in JRXML_REPORT_DEFINITIONS for each entry in
           i_lReports.
           The reports can have different page-formats
  $param   i_lReports         Names of the report, each must match a record in JRXML_REPORT_DEFINITIONS
  $param   i_lParams          List of parameters and values to pass to the report
  $param   i_bResetPageNumber Flag, if the page-numbers should start with 1 for each report
  $return  a blob containing the pdf-result
  $version 1.0.0.0 05.01.2013 Weiden
           initial version
*/
  FUNCTION FK_RUN(i_lReports         IN PK_JRXML2PDF_TYPES.tReportNameList,
                  i_lParams          IN tParamList,
                  i_bResetPageNumber IN BOOLEAN)
  RETURN BLOB;
/**
  $name    PR_RUN_TO_FILE
  $created 22.05.2012
  $author  Andreas Weiden
  $desc    Function to create a pdf from the report-definition with the given
           name. A report-definition with that name has to exist in JRXML_REPORT_DEFINITIONS
  $param   i_vcName     Name of the report, must match a record in JRXML_REPORT_DEFINITIONS
  $param   i_lParams    List of parameters and values to pass to the report
  $return  i_vcDir      name of the database-directory to write the record to
                        must be created using CREATE DIRECTORY
  $return  i_vcFilename name of the result-file containing the pdf-result
  $version 1.0.0.0 22.05.2012 Weiden
           initial version
*/
  PROCEDURE PR_RUN_TO_FILE(i_vcName     IN VARCHAR2,
                           i_lParams    IN tParamList,
                           i_vcDir      IN VARCHAR2,
                           i_vcFilename IN VARCHAR2);
/**
  $name    PR_RUN_TO_FILE
  $created 05.01.2013
  $author  Andreas Weiden
  $desc    Function to create a pdf from all the report-definitions given in i_lReports.
           A report-definition with that name has to exist in JRXML_REPORT_DEFINITIONS for each
  $param   i_lReports         Names of the report, each must match a record in JRXML_REPORT_DEFINITIONS
  $param   i_lParams          List of parameters and values to pass to the report
  $return  i_vcDir            name of the database-directory to write the record to
                              must be created using CREATE DIRECTORY
  $return  i_vcFilename       name of the result-file containing the pdf-result
  $param   i_bResetPageNumber Flag, if the page-numbers should start with 1 for each report
  $version 1.0.0.0 05.01.2013 Weiden
           initial version
*/
  PROCEDURE PR_RUN_TO_FILE(i_lReports         IN PK_JRXML2PDF_TYPES.tReportNameList,
                           i_lParams          IN tParamList,
                           i_vcDir            IN VARCHAR2,
                           i_vcFilename       IN VARCHAR2,
                           i_bResetPageNumber IN BOOLEAN);
/**
  $name    PR_SHOW_REPORT
  $created 22.05.2012
  $author  Andreas Weiden
  $desc    Helper-function to output the file in APEX using OWA-methods
  $param   io_blReport BLOB to output
  $param   i_vcContentDisposition content-disposition, may be "inline" or "attachment"
  $param   i_vcFilename filename to be used to save the result locally
  $version 1.0.0.0 22.05.2012 Weiden
           initial version
  $version 1.0.1.0 30.05.2012 Weiden
           Enhance: Add Parameter i_vcContentDisposition
  $version 1.0.2.0 03.09.2012 Weiden
           Enhance: Add Parameter i_vcFilename
*/
  PROCEDURE PR_SHOW_REPORT(io_blReport            IN OUT BLOB,
                           i_vcContentDisposition IN VARCHAR2 DEFAULT 'inline',
                           i_vcFilename           IN VARCHAR2 DEFAULT 'reportresult.pdf');
END;
/
create or replace PACKAGE pk_jrxml2pdf_types AUTHID CURRENT_USER IS
/* *****************************************************************************
Copyright (C) 2012-2014 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_TYPES
  $created 16.10.2012
  $author  Andreas Weiden
  $desc    Package with types and constants used by PL-jrxml2pdf
  $version 1.0.0.0 16.10.2012 Weiden
           Out-sourced from PK_JRXML2PDF_REPGEN
  $version 1.1.0.0 31.10.2012 Weiden
           New types for barchart
  $version 1.1.0.1 10.12.2012 Weiden
           New types for category-linechart
  $version 1.1.1.1 23.12.2012 Weiden
           adjusted type for subdatasets
  $version 1.1.2.1 24.12.2012 Weiden
           New types for timeseries-linechart
  $version 1.1.1.0 04.01.2013 Weiden
           adjusted type for barchart
  $version 1.1.2.0 11.03.2013 Weiden
           Enhance: Add rHeaderCell to crosstab-type
  $version 1.3.0.0 20.06.2014 Weiden
           Feature: types for variables
           Enhance: Types for stacked area chart
*/
  SUBTYPE tColor             IS VARCHAR2(60);
  SUBTYPE tYesNo             IS VARCHAR2(1);
  SUBTYPE tFont              IS VARCHAR2(255);
  SUBTYPE tAlignment         IS VARCHAR2(20);
  SUBTYPE tAttribute         IS VARCHAR2(80);
  SUBTYPE tExpression        IS VARCHAR2(4000);
  SUBTYPE tGroupname         IS VARCHAR2(255);
  SUBTYPE tStyleName         IS VARCHAR2(255);
  SUBTYPE tPattern           IS VARCHAR2(4000);
  SUBTYPE tName              IS VARCHAR2(255);
  SUBTYPE tCalculation       IS VARCHAR2(255);
  SUBTYPE tPosition          IS VARCHAR2(20);
  SUBTYPE tHeaderPosition    IS VARCHAR2(20);
  SUBTYPE tCrosstabCellName  IS VARCHAR2(512);
  SUBTYPE tDatatype          IS VARCHAR2(1);
  SUBTYPE tPositionType      IS VARCHAR2(20);
  SUBTYPE tSplitType         IS VARCHAR2(20);
  SUBTYPE tFontStyle         IS VARCHAR2(2);
  SUBTYPE tMaxVarchar2       IS VARCHAR2(32767);
  SUBTYPE tIndex             IS VARCHAR2(255);
  SUBTYPE tDatePattern       IS VARCHAR2(255);
  SUBTYPE tChar              IS VARCHAR2(1);
  SUBTYPE tNumAsVarchar2     IS VARCHAR2(255);
  SUBTYPE tSmallVarchar2     IS VARCHAR2(10);
  SUBTYPE tIncrementType     IS VARCHAR2(255);

  $IF DBMS_DB_VERSION.VER_LE_10 $THEN
    -- DBMS-SQL-constants for 10G
    DBMS_SQL_VARCHAR2_TYPE         CONSTANT NUMBER := 1;
    DBMS_SQL_CHAR_TYPE             CONSTANT NUMBER := 96;
    DBMS_SQL_CLOB_TYPE             CONSTANT NUMBER := 112;
    DBMS_SQL_NUMBER_TYPE           CONSTANT NUMBER := 2;
    DBMS_SQL_BINARY_FLOAT_TYPE     CONSTANT NUMBER := 100;
    DBMS_SQL_BINARY_BOUBLE_TYPE    CONSTANT NUMBER := 101;
    DBMS_SQL_DATE_TYPE             CONSTANT NUMBER := 12;
    DBMS_SQL_TIMESTAMP_TYPE        CONSTANT NUMBER := 180;
    DBMS_SQL_TSTMP_WITH_TZ_TYPE    CONSTANT NUMBER := 181;
    DBMS_SQL_IV_YEAR_TO_MONTH_TYPE CONSTANT NUMBER := 182;
    DBMS_SQL_IV_DAY_TO_SECOND_TYPE CONSTANT NUMBER := 183;
    DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE  CONSTANT NUMBER := 231;
    DBMS_SQL_BLOB_TYPE             CONSTANT NUMBER := 113;
  $ELSE
    DBMS_SQL_VARCHAR2_TYPE         CONSTANT NUMBER :=DBMS_SQL.VARCHAR2_TYPE;
    DBMS_SQL_CHAR_TYPE             CONSTANT NUMBER :=DBMS_SQL.CHAR_TYPE;
    DBMS_SQL_CLOB_TYPE             CONSTANT NUMBER :=DBMS_SQL.CLOB_TYPE;
    DBMS_SQL_NUMBER_TYPE           CONSTANT NUMBER :=DBMS_SQL.NUMBER_TYPE;
    DBMS_SQL_BINARY_FLOAT_TYPE     CONSTANT NUMBER :=DBMS_SQL.BINARY_FLOAT_TYPE;
    DBMS_SQL_BINARY_BOUBLE_TYPE    CONSTANT NUMBER :=DBMS_SQL.BINARY_BOUBLE_TYPE;
    DBMS_SQL_DATE_TYPE             CONSTANT NUMBER :=DBMS_SQL.DATE_TYPE;
    DBMS_SQL_TIMESTAMP_TYPE        CONSTANT NUMBER :=DBMS_SQL.TIMESTAMP_TYPE;
    DBMS_SQL_TSTMP_WITH_TZ_TYPE    CONSTANT NUMBER :=DBMS_SQL.TIMESTAMP_WITH_TZ_TYPE;
    DBMS_SQL_IV_YEAR_TO_MONTH_TYPE CONSTANT NUMBER :=DBMS_SQL.INTERVAL_YEAR_TO_MONTH_TYPE;
    DBMS_SQL_IV_DAY_TO_SECOND_TYPE CONSTANT NUMBER :=DBMS_SQL.INTERVAL_DAY_TO_SECOND_TYPE;
    DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE  CONSTANT NUMBER :=DBMS_SQL.TIMESTAMP_WITH_LOCAL_TZ_TYPE;
    DBMS_SQL_BLOB_TYPE             CONSTANT NUMBER :=DBMS_SQL.BLOB_TYPE;
  $END
  MAP_URL               CONSTANT tMaxVarchar2:='http://maps.google.com/maps/api/staticmap?center=#LATITUDE#,#LONGITUDE#&zoom=#ZOOM#&size=#WIDTH#x#HEIGHT#&maptype=roadmap&sensor=false';
  NIL                   CONSTANT VARCHAR2(10):='$#�#$';
  NIL2                  CONSTANT VARCHAR2(10):='^#$#^';
  DEFAULT_INT_FORMAT    CONSTANT tAttribute:='FM9999999999999999999999999999999999990';
  DEFAULT_FLOAT_FORMAT  CONSTANT tAttribute:='FM9999999999999999999999999999999999990D09999999999999999';
  REGION            CONSTANT NUMBER:=0;
  BAND              CONSTANT NUMBER:=1;
  SUBFRAME          CONSTANT NUMBER:=2;
  LINE              CONSTANT NUMBER:=3;
  RECTANGLE         CONSTANT NUMBER:=4;
  IMAGE             CONSTANT NUMBER:=5;
  TEXT              CONSTANT NUMBER:=6;
  FIELD             CONSTANT NUMBER:=7;
  SUBREPORT         CONSTANT NUMBER:=8;
  BREAK             CONSTANT NUMBER:=9;
  CROSSTAB          CONSTANT NUMBER:=10;
  MAP               CONSTANT NUMBER:=11;
  BARCHART          CONSTANT NUMBER:=12;
  PIECHART          CONSTANT NUMBER:=13;
  CATEGORYLINECHART CONSTANT NUMBER:=14;
  XYLINECHART       CONSTANT NUMBER:=15;
  TIMELINECHART     CONSTANT NUMBER:=16;
  STACKEDAREACHART  CONSTANT NUMBER:=17;

  NO_RECORD         CONSTANT NUMBER:=-1;
  BLACK             CONSTANT tColor:='000000';
  WHITE             CONSTANT tColor:='FFFFFF';
  THIS_IS_A_BLOB    CONSTANT VARCHAR2(10):='$$BLOB$$';
  THIN              CONSTANT NUMBER:=0.25;
  NONE_ALIGN      CONSTANT tAttribute:='none';
  LEFT_ALIGN      CONSTANT tAttribute:='left';
  CENTER_ALIGN    CONSTANT tAttribute:='center';
  RIGHT_ALIGN     CONSTANT tAttribute:='right';
  END_ALIGN       CONSTANT tAttribute:='end';
  TOP_ALIGN       CONSTANT tAttribute:='top';
  MIDDLE_ALIGN    CONSTANT tAttribute:='middle';
  BOTTOM_ALIGN    CONSTANT tAttribute:='bottom';
  STRETCH_ALIGN   CONSTANT tAttribute:='stretch';
  STRETCH_Y_ALIGN CONSTANT tAttribute:='stretchY';
  HTML_H1         CONSTANT tSmallVarchar2:='h1';
  HTML_H2         CONSTANT tSmallVarchar2:='h2';
  HTML_H3         CONSTANT tSmallVarchar2:='h3';
  HTML_H4         CONSTANT tSmallVarchar2:='h4';
  HTML_P          CONSTANT tSmallVarchar2:='p';
  HTML_B          CONSTANT tSmallVarchar2:='b';
  HTML_BR         CONSTANT tSmallVarchar2:='br';
  HTML_LI         CONSTANT tSmallVarchar2:='li';
  HTML_UL         CONSTANT tSmallVarchar2:='ul';
  HTML_OL         CONSTANT tSmallVarchar2:='ol';
  HTML_LT         CONSTANT tSmallVarchar2:='<';
  HTML_GT         CONSTANT tSmallVarchar2:='>';
  HTML_PRE        CONSTANT tSmallVarchar2:='pre';
  HTML_STRONG     CONSTANT tSmallVarchar2:='strong';
  HTML_TEXT       CONSTANT tSmallVarchar2:='text';
  HTML_CODE       CONSTANT tSmallVarchar2:='code';
  HTML_SPAN       CONSTANT tSmallVarchar2:='span';
  HTML_P_START    CONSTANT tSmallVarchar2:='<p>';
  HTML_P_END      CONSTANT tSmallVarchar2:='</p>';
  MIN_LINE_SPACING  CONSTANT NUMBER:=1.17;
  EVALUATION_NOW    CONSTANT tAttribute:='Now';
  EVALUATION_PAGE   CONSTANT tAttribute:='Page';
  EVALUATION_GROUP  CONSTANT tAttribute:='Group';
  EVALUATION_REPORT CONSTANT tAttribute:='Report';
  RENDER_FRAME_NONE   CONSTANT NUMBER:=1;
  RENDER_FRAME_BEFORE CONSTANT NUMBER:=2;
  RENDER_FRAME_AFTER  CONSTANT NUMBER:=3;
  BOOL_NO             CONSTANT tYesNo:='N';
  BOOL_YES            CONSTANT tYesNo:='Y';
  REPORT_LOCALE       CONSTANT tAttribute:='REPORT_LOCALE';
  REPORT_TYP_REPORT CONSTANT NUMBER:=1;
  REPORT_TYP_TABLE  CONSTANT NUMBER:=2;
  NUM_FORMAT_MASK   CONSTANT tAttribute:='FM999999999999990D099999';
  DATE_FORMAT_MASK  CONSTANT tAttribute:='DD.MM.YYYY HH24:MI:SS';
  OFFSET_NONE       CONSTANT NUMBER:=0;
  OFFSET_PREVIOUS   CONSTANT NUMBER:=1;
  OFFSET_NEXT       CONSTANT NUMBER:=2;
  HELVETICA         CONSTANT tFont:='helvetica';
  ARIAL             CONSTANT tFont:='Arial';
  WINGDINGS         CONSTANT tFont:='WingDings';
  COURIER_NEW       CONSTANT tFont:='Courier New';
  FONT_NORMAL       CONSTANT tFontStyle:='N';
  FONT_BOLD         CONSTANT tFontStyle:='B';
  FONT_ITALIC       CONSTANT tFontStyle:='I';
  FONT_BOLD_ITALIC  CONSTANT tFontStyle:='BI';
  YES               CONSTANT tYesNo:='Y';
  NO                CONSTANT tYesNo:='N';
  DATATYPE_VARCHAR  CONSTANT tDatatype:='V';
  DATATYPE_NUMBER   CONSTANT tDatatype:='N';
  DATATYPE_DATE     CONSTANT tDatatype:='D';
  DATATYPE_BLOB     CONSTANT tDatatype:='B';
  CALCULATION_HIGHEST CONSTANT tAttribute:='Highest';
  CALCULATION_LOWEST  CONSTANT tAttribute:='Lowest';
  CALCULATION_COUNT   CONSTANT tAttribute:='Count';
  CALCULATION_SUM     CONSTANT tAttribute:='Sum';
  CALCULATION_AVERAGE CONSTANT tAttribute:='Average';
  CALCULATION_FIRST   CONSTANT tAttribute:='First';
  CALCULATION_NOTHING CONSTANT tAttribute:='Nothing';
  CALCULATION_SYSTEM  CONSTANT tAttribute:='System';
  ORDERBY_ASCENDING   CONSTANT tAttribute:='Ascending';
  ORDERBY_DESCENDING  CONSTANT tAttribute:='Descending';
  RELATIVE_TO_TOP     CONSTANT tAttribute:='FixRelativeToTop';
  RELATIVE_TO_BOTTOM  CONSTANT tAttribute:='FixRelativeToBottom';
  IMMEDIATE           CONSTANT tAttribute:='Immediate';
  STRETCH             CONSTANT tAttribute:='Stretch';
  PREVENT             CONSTANT tAttribute:='Prevent';
  PIXEL               CONSTANT tSmallVarchar2:='px';
  VARTYPE_REPORT      CONSTANT tName:='Report';
  VARTYPE_GROUP       CONSTANT tName:='Group';
  VARTYPE_PAGE        CONSTANT tName:='Page';
  VARTYPE_NONE        CONSTANT tName:='None';
  TYPE tNumList        IS TABLE OF NUMBER            INDEX BY BINARY_INTEGER;
  TYPE tMaxVarcharList IS TABLE OF tMaxVarchar2      INDEX BY BINARY_INTEGER;
  TYPE tIndexList      IS TABLE OF tIndex            INDEX BY BINARY_INTEGER;
  TYPE tColorList      IS TABLE OF tColor            INDEX BY BINARY_INTEGER;
  TYPE tReportNameList IS TABLE OF tName             INDEX BY BINARY_INTEGER;
  TYPE tPatternList    IS TABLE OF tDatePattern      INDEX BY tIndex;
  TYPE tAttributeList  IS TABLE OF tAttribute        INDEX BY tAttribute;
  TYPE tArea IS RECORD (
    nX      NUMBER,
    nY      NUMBER,
    nPage   NUMBER
  );
  TYPE tAreaList IS TABLE OF tArea INDEX BY BINARY_INTEGER;
  TYPE tToken IS RECORD (
    vcStartTag tAttribute,
    vcEndTag   tAttribute
  );
  TYPE tTokenList IS TABLE OF tToken INDEX BY BINARY_INTEGER;
  TYPE tTokenValue IS RECORD (
    vcFoundTag tAttribute,
    vcEndTag   tAttribute
  );
  TYPE tTokenValueList IS TABLE OF tTokenValue INDEX BY BINARY_INTEGER;
  TYPE tSimpleStyle IS RECORD (
    vcWhenExpression tExpression,
    vcFGColor        tColor,
    vcBGColor        tColor,
    vcFont           tFont,
    vcFontStyle      tFontStyle,
    vcAlignment      tAlignment,
    vcVerticalAlign  tAlignment,
    nFontSize        NUMBER,
    nLineWidth       NUMBER,
    nBoxTop          NUMBER,
    nBoxLeft         NUMBER,
    nBoxBottom       NUMBER,
    nBoxRight        NUMBER,
    nTopPadding      NUMBER,
    nLeftPadding     NUMBER,
    nBottomPadding   NUMBER,
    nRightPadding    NUMBER,
    vcBoxTopColor    tColor,
    vcBoxLeftColor   tColor,
    vcBoxBottomColor tColor,
    vcBoxRightColor  tColor,
    nLineSpacing     NUMBER,
    vcOpaque        tYesNo
  );
  TYPE tSimpleStyleList IS TABLE OF tSimpleStyle INDEX BY tStyleName;
  TYPE tStyle IS RECORD (
    rStyle             tSimpleStyle,
    lConditionalStyles tSimpleStyleList
  );
  TYPE tStyleList IS TABLE OF tStyle INDEX BY tStyleName;
  TYPE tPageFrameMarker IS RECORD (
    nBorderTop   NUMBER,
    nBorderWidth NUMBER,
    rStyle       tSimpleStyle
  );
  TYPE tPageFrameMarkerList IS TABLE OF tPageFrameMarker INDEX BY BINARY_INTEGER;
  TYPE tLine IS RECORD (
    nX                NUMBER,
    nY                NUMBER,
    nWidth            NUMBER,
    nHeight           NUMBER,
    vcLineColor       tColor,
    nLineWidth        NUMBER,
    vcStretch         tYesNo,
    vcStyle           tStyleName,
    vcWhenExpression  tExpression,
    vcPositionType    tPositionType
  );
  TYPE tLineList IS TABLE OF tLine INDEX BY BINARY_INTEGER;
  TYPE tRectangle IS RECORD (
    nX               NUMBER,
    nY               NUMBER,
    nWidth           NUMBER,
    nHeight          NUMBER,
    vcLineColor      tColor,
    vcFillColor      tColor,
    nLineWidth       NUMBER,
    vcStretch        tYesNo,
    vcStyle          tStyleName,
    vcWhenExpression tExpression,
    vcOpaque         tYesNo,
    vcPositionType   tPositionType
);
  TYPE tRectangleList IS TABLE OF tRectangle INDEX BY BINARY_INTEGER;
  TYPE tImage IS RECORD (
    vcImageName      tName,
    nX               NUMBER,
    nY               NUMBER,
    nWidth           NUMBER,
    nHeight          NUMBER,
    vcLineColor      tColor,
    vcFillColor      tColor,
    vcStyle          tStylename,
    nBoxTop          NUMBER,
    nBoxLeft         NUMBER,
    nBoxBottom       NUMBER,
    nBoxRight        NUMBER,
    vcBoxTopColor    tColor,
    vcBoxLeftColor   tColor,
    vcBoxBottomColor tColor,
    vcBoxRightColor  tColor,
    vcWhenExpression tExpression,
    vcPositionType   tPositionType
  );
  TYPE tImageList IS TABLE OF tImage INDEX BY BINARY_INTEGER;
  TYPE tText IS RECORD (
    vcText           tMaxVarchar2,
    nX               NUMBER,
    nY               NUMBER,
    nWidth           NUMBER,
    nHeight          NUMBER,
    vcBGColor        tColor,
    vcFGColor        tColor,
    vcStyle          tStylename,
    vcFont           tFont,
    vcFontStyle      tFontStyle,
    vcAlignment      tAlignment,
    vcVerticalAlign  tAlignment,
    nFontSize        NUMBER,
    nBoxTop          NUMBER,
    nBoxLeft         NUMBER,
    nBoxBottom       NUMBER,
    nBoxRight        NUMBER,
    nTopPadding      NUMBER,
    nLeftPadding     NUMBER,
    nBottomPadding   NUMBER,
    nRightPadding    NUMBER,
    vcBoxTopColor    tColor,
    vcBoxLeftColor   tColor,
    vcBoxBottomColor tColor,
    vcBoxRightColor  tColor,
    vcStretch        tYesNo,
    vcWhenExpression tExpression,
    vcOpaque         tYesNo,
    vcPositionType   tPositionType,
    vcRotation       tAttribute
  );
  TYPE tTextList IS TABLE OF tText INDEX BY BINARY_INTEGER;
  TYPE tField IS RECORD (
    vcExpression        tExpression,
    vcPattern           tPattern,
    vcPatternExpression tExpression,
    vcPrintRepeated     tYesNo,
    nX                  NUMBER,
    nY                  NUMBER,
    nWidth              NUMBER,
    nHeight             NUMBER,
    vcBGColor           tColor,
    vcFGColor           tColor,
    vcStyle             tStyleName,
    vcFont              tFont,
    vcFontStyle         tFontStyle,
    vcAlignment         tAlignment,
    vcVerticalAlign     tAlignment,
    nFontSize           NUMBER,
    nBoxTop             NUMBER,
    nBoxLeft            NUMBER,
    nBoxBottom          NUMBER,
    nBoxRight           NUMBER,
    nTopPadding         NUMBER,
    nLeftPadding        NUMBER,
    nBottomPadding      NUMBER,
    nRightPadding       NUMBER,
    vcBoxTopColor       tColor,
    vcBoxLeftColor      tColor,
    vcBoxBottomColor    tColor,
    vcBoxRightColor     tColor,
    vcStretch           tYesNo,
    vcStretchOverflow   tYesNo,
    vcEvaluationTime    tAttribute,
    vcEvaluationGroup   tGroupname,
    vcWhenExpression    tExpression,
    nLineSpacing        NUMBER,
    vcOpaque            tYesNo,
    vcPositionType      tPositionType,
    vcMarkup            tAttribute,
    vcKey               tAttribute,
    vcRotation          tAttribute
  );
  TYPE tFieldList IS TABLE OF tField INDEX BY BINARY_INTEGER;
  TYPE tParameter IS RECORD (
    vcName  VARCHAR2(255),
    vcValue VARCHAR2(32767)
  );
  TYPE tParamList IS TABLE OF tParameter INDEX BY BINARY_INTEGER;
  TYPE tVariable IS RECORD (
    vcName           tName,
    vcDatatype       tName,
    vcIncrementType  tIncrementType,
    vcIncrementGroup tName,
    vcCalculation    tCalculation,
    vcInitialValue   tExpression,
    vcValue          tExpression,
    vcResetType      tIncrementType,
    vcResetGroup     tName
  );
  TYPE tVariableList IS TABLE OF tVariable INDEX BY BINARY_INTEGER;
  TYPE tDataEntry IS RECORD (
    vcDataType tDatatype,
    bIsInitial BOOLEAN,
    vcData     tMaxVarchar2,
    dtData     DATE,
    nData      NUMBER,
    iCount     PLS_INTEGER,
    nSum       NUMBER,
    blData     BLOB
  );
  TYPE tDataEntries IS TABLE OF tDataEntry INDEX BY tIndex;
  TYPE tSubreportReturnvalue IS RECORD (
    vcToVariable        tName,
    vcSubreportVariable tName,
    vcCalculation       tCalculation,
    rData               tDataEntry
  );

  TYPE tSubreportReturnvalueList IS TABLE OF tSubreportReturnvalue  INDEX BY BINARY_INTEGER;
  TYPE tSubreport IS RECORD (
    vcReportName     tName,
    nX               NUMBER,
    nY               NUMBER,
    nWidth           NUMBER,
    nHeight          NUMBER,
    vcStyle          tStylename,
    lParamList       tParamList,
    lReturnvalues    tSubreportReturnvalueList
  );
  TYPE tSubreportList IS TABLE OF tSubreport INDEX BY BINARY_INTEGER;
  TYPE tBreak IS RECORD (
    nX                NUMBER,
    nY                NUMBER,
    nWidth            NUMBER,
    nHeight           NUMBER,
    vcType            tAttribute,
    vcWhenExpression  tExpression
  );
  TYPE tBreakList IS TABLE OF tBreak INDEX BY BINARY_INTEGER;
  TYPE tQueryResult IS TABLE OF tDataEntries INDEX BY BINARY_INTEGER;
  TYPE tObject IS RECORD (
    nType     NUMBER,
    nPosition NUMBER
  );
  TYPE tObjectList IS TABLE OF tObject INDEX BY BINARY_INTEGER;
  TYPE tRegion IS RECORD (
    vcBaseNode tAttribute,
    lObjects   tObjectList
  );
  TYPE tRegionList IS TABLE OF tRegion INDEX BY BINARY_INTEGER;
  TYPE tBand IS RECORD (
    nX               NUMBER,
    nY               NUMBER,
    nWidth           NUMBER,
    nHeight          NUMBER,
    vcBGColor        tColor,
    vcFGColor        tColor,
    vcStyle          tStyleName,
    nBoxTop          NUMBER,
    nBoxLeft         NUMBER,
    nBoxBottom       NUMBER,
    nBoxRight        NUMBER,
    vcBoxTopColor    tColor,
    vcBoxLeftColor   tColor,
    vcBoxBottomColor tColor,
    vcBoxRightColor  tColor,
    vcStretch        tYesNo,
    vcOpaque         tYesNo,
    vcTyp            tAttribute,
    bHasBreaks       BOOLEAN,
    lObjects         tObjectList,
    vcWhenExpression tExpression,
    vcPositionType   tPositionType,
    bHasTopPos       BOOLEAN,
    bHasBottomPos    BOOLEAN,
    nMaxPosTop       NUMBER,
    nMinPosBottom    NUMBER,
    vcSplitType      tSplitType
  );
  TYPE tBandList IS TABLE OF tBand INDEX BY BINARY_INTEGER;
  TYPE tCrosstabRow IS RECORD (
    vcName             tName,
    nWidth             NUMBER,
    nHeight            NUMBER,
    vcBucketExpression tExpression,
    vcTotalPosition    tPosition,
    vcOrderBy          tAttribute,
    vcDatatype         tDatatype,
    nHeaderPos         NUMBER,
    nTotalHeaderPos    NUMBER,
    vcHeaderPosition   tHeaderPosition
  );
  TYPE tCrosstabRowList IS TABLE OF tCrosstabRow INDEX BY BINARY_INTEGER;
  TYPE tCrosstabMeasure IS RECORD (
    vcName             tName,
    vcCalculation      tCalculation,
    vcExpression       tExpression,
    vcDatatype         tDatatype
  );
  TYPE tCrosstabMeasureList IS TABLE OF tCrosstabMeasure INDEX BY BINARY_INTEGER;
  TYPE tCrosstabCell IS RECORD (
    vcName             tCrosstabCellname,
    vcRowGroup         tName,
    vcColgroup         tName,
    nWidth             NUMBER,
    nHeight            NUMBER,
    nCellPos           NUMBER
  );
  TYPE tCrosstabCellList IS TABLE OF tCrosstabCell INDEX BY tCrosstabCellName;
  TYPE tCrosstab IS RECORD (
    nX                 NUMBER,
    nY                 NUMBER,
    nWidth             NUMBER,
    nHeight            NUMBER,
    vcRepeatColHeaders tYesNo,
    vcRepeatRowHeaders tYesNo,
    nColBreakOffset    NUMBER,
    vcStyle            tStylename,
    vcQuery            tMaxVarchar2,
    vcWhenExpression   tExpression,
    lParams            tParamList,
    lRows              tCrossTabRowList,
    lColumns           tCrossTabRowList,
    lMeasures          tCrosstabMeasureList,
    lCells             tCrosstabCellList,
    rHeaderCell        tCrosstabCell
  );
  TYPE tCrosstabList IS TABLE OF tCrosstab INDEX BY BINARY_INTEGER;
  TYPE tGroup IS RECORD (
    vcName            tGroupname,
    vcExpression      tExpression,
    vcStartOnNewPage  tYesNo,
    vcResetPageNumber tYesNo,
    vcReprintHeader   tYesNo,
    nMinHeightForPage NUMBER,
    rGroupHeader      tRegion,
    rGroupFooter      tRegion
  );
  TYPE tGroupList IS TABLE OF tGroup INDEX BY BINARY_INTEGER;
  TYPE tDataset IS RECORD (
    vcQuery    tMaxVarchar2,
    lGroups    tGroupList,
    lVariables tVariableList
  );
  TYPE tDatasetList    IS TABLE OF tDataset INDEX BY tIndex;
  TYPE tMap IS RECORD (
    nX                    NUMBER,
    nY                    NUMBER,
    nWidth                NUMBER,
    nHeight               NUMBER,
    vcLineColor           tColor,
    vcFillColor           tColor,
    vcStyle               tStylename,
    nBoxTop               NUMBER,
    nBoxLeft              NUMBER,
    nBoxBottom            NUMBER,
    nBoxRight             NUMBER,
    vcBoxTopColor         tColor,
    vcBoxLeftColor        tColor,
    vcBoxBottomColor      tColor,
    vcBoxRightColor       tColor,
    vcWhenExpression      tExpression,
    vcPositionType        tPositionType,
    vcLongitudeExpression tExpression,
    vcLatitudeExpression  tExpression,
    vcZoomExpression      tExpression
  );
  TYPE tMapList IS TABLE OF tMap INDEX BY BINARY_INTEGER;
  TYPE tQuery IS RECORD (
    iCursor             PLS_INTEGER,
    lDescTab            DBMS_SQL.DESC_TAB,
    lQueryResult        tQueryResult,
    bEOF                BOOLEAN,
    nRecordPosition     NUMBER,
    nRecordRead         NUMBER,
    nPreviousRecord     PLS_INTEGER,
    nCurrentRecord      PLS_INTEGER,
    nNextRecord         PLS_INTEGER,
    bTreatLastAsCurrent BOOLEAN
  );
  TYPE tLocaledata IS RECORD (
    vcLocale         tAttribute,
    vcDateDefault    tAttribute,
    vcDateShort      tAttribute,
    vcDateMedium     tAttribute,
    vcDateLong       tAttribute,
    vcTimeDefault    tAttribute,
    vcTimeShort      tAttribute,
    vcTimeMedium     tAttribute,
    vcTimeLong       tAttribute,
    vcDateTimeString tAttribute,
    vcCurrency       tAttribute,
    vcNumericChars   tAttribute,
    vcDateLanguage   tAttribute
  );
  TYPE tResourceList IS TABLE OF tMaxVarchar2 INDEX BY tMaxVarchar2;
  TYPE tCategorySeries IS RECORD (
    vcSeriesExpression   tExpression,
    vcValueExpression    tExpression,
    vcCategoryExpression tExpression
  );
  TYPE tCategorySeriesList IS TABLE OF tCategorySeries INDEX BY BINARY_INTEGER;
  TYPE tBarChart IS RECORD (
    nX                            NUMBER,
    nY                            NUMBER,
    nWidth                        NUMBER,
    nHeight                       NUMBER,
    vcLineColor                   tColor,
    vcFillColor                   tColor,
    vcStyle                       tStylename,
    nBoxTop                       NUMBER,
    nBoxLeft                      NUMBER,
    nBoxBottom                    NUMBER,
    nBoxRight                     NUMBER,
    vcBoxTopColor                 tColor,
    vcBoxLeftColor                tColor,
    vcBoxBottomColor              tColor,
    vcBoxRightColor               tColor,
    nTopPadding                   NUMBER,
    nLeftPadding                  NUMBER,
    nBottomPadding                NUMBER,
    nRightPadding                 NUMBER,
    vcOpaque                      tYesNo,
    vcWhenExpression              tExpression,
    vcPositionType                tPositionType,
    vcQuery                       tMaxVarchar2,
    lParams                       tParamList,
    vcIs3D                        tYesNo,
    vcIsStacked                   tYesNo,
    vcTitleExpression             tExpression,
    vcTitleColor                  tColor,
    vcTitlePosition               tPosition,
    vcTitleFont                   tFont,
    vcTitleFontStyle              tFontStyle,
    nTitleFontSize                NUMBER,
    vcSubTitleExpression          tExpression,
    vcSubTitleColor               tColor,
    vcSubTitleFont                tFont,
    vcSubTitleFontStyle           tFontStyle,
    nSubTitleFontSize             NUMBER,
    vcShowLegend                  tYesNo,
    vcLegendTextColor             tColor,
    vcLegendBgColor               tColor,
    vcLegendFont                  tFont,
    vcLegendFontStyle             tFontStyle,
    nLegendFontSize               NUMBER,
    vcLegendPosition              tPosition,
    lSeries                       tCategorySeriesList,
    lSeriesColors                 tColorList,
    vcShowLabels                  tYesNo,
    vcLabelFont                   tFont,
    vclabelFontStyle              tFontStyle,
    vcLabelColor                  tColor,
    nLabelFontSize                NUMBER,
    vcShowTickLabels              tYesNo,
    vcShowTickMarks               tYesNo,
    vcCatAxisLabelExpression      tExpression,
    vcCatAxisLabelColor           tColor,
    vcCatAxisLabelFont            tFont,
    vcCatAxisLabelFontStyle       tFontStyle,
    nCatAxisLabelFontSize         NUMBER,
    vcCatAxisTickLabelColor       tColor,
    vcCatAxisTickLabelFont        tFont,
    vcCatAxisTickLabelFontStyle   tFontStyle,
    nCatAxisTickLabelFontSize     NUMBER,
    vcCatAxisTickLabelPattern     tPattern,
    vcCatAxisLineColor            tColor,
    vcValueAxisLabelExpression    tExpression,
    vcValueAxisLabelColor         tColor,
    vcValueAxisLabelFont          tFont,
    vcValueAxisLabelFontStyle     tFontStyle,
    nValueAxisLabelFontSize       NUMBER,
    vcValueAxisTickLabelColor     tColor,
    vcValueAxisTickLabelFont      tFont,
    vcValueAxisTickLabelFontStyle tFontStyle,
    nAxisTickLabelFontSize        NUMBER,
    vcValueAxisTickLabelPattern   tPattern,
    vcValueAxisLineColor          tColor,
    vcValueAxisMinValExpression   tExpression,
    vcValueAxisMaxValExpression   tExpression,
    vcCatAxisMinValExpression     tExpression,
    vcCatAxisMaxValExpression     tExpression,
    vcCustomizerClass             tMaxVarchar2,
    nLabelRotation                NUMBER
  );
  TYPE tBarChartList IS TABLE OF tBarChart INDEX BY BINARY_INTEGER;
  TYPE tStackedAreaChart IS RECORD (
    nX                            NUMBER,
    nY                            NUMBER,
    nWidth                        NUMBER,
    nHeight                       NUMBER,
    vcLineColor                   tColor,
    vcFillColor                   tColor,
    vcStyle                       tStylename,
    nBoxTop                       NUMBER,
    nBoxLeft                      NUMBER,
    nBoxBottom                    NUMBER,
    nBoxRight                     NUMBER,
    vcBoxTopColor                 tColor,
    vcBoxLeftColor                tColor,
    vcBoxBottomColor              tColor,
    vcBoxRightColor               tColor,
    nTopPadding                   NUMBER,
    nLeftPadding                  NUMBER,
    nBottomPadding                NUMBER,
    nRightPadding                 NUMBER,
    vcOpaque                      tYesNo,
    vcWhenExpression              tExpression,
    vcPositionType                tPositionType,
    vcQuery                       tMaxVarchar2,
    lParams                       tParamList,
    vcTitleExpression             tExpression,
    vcTitleColor                  tColor,
    vcTitlePosition               tPosition,
    vcTitleFont                   tFont,
    vcTitleFontStyle              tFontStyle,
    nTitleFontSize                NUMBER,
    vcSubTitleExpression          tExpression,
    vcSubTitleColor               tColor,
    vcSubTitleFont                tFont,
    vcSubTitleFontStyle           tFontStyle,
    nSubTitleFontSize             NUMBER,
    vcShowLegend                  tYesNo,
    vcLegendTextColor             tColor,
    vcLegendBgColor               tColor,
    vcLegendFont                  tFont,
    vcLegendFontStyle             tFontStyle,
    nLegendFontSize               NUMBER,
    vcLegendPosition              tPosition,
    lSeries                       tCategorySeriesList,
    lSeriesColors                 tColorList,
    vcShowLabels                  tYesNo,
    vcLabelFont                   tFont,
    vclabelFontStyle              tFontStyle,
    vcLabelColor                  tColor,
    nLabelFontSize                NUMBER,
    vcShowTickLabels              tYesNo,
    vcShowTickMarks               tYesNo,
    vcCatAxisLabelExpression      tExpression,
    vcCatAxisLabelColor           tColor,
    vcCatAxisLabelFont            tFont,
    vcCatAxisLabelFontStyle       tFontStyle,
    nCatAxisLabelFontSize         NUMBER,
    vcCatAxisTickLabelColor       tColor,
    vcCatAxisTickLabelFont        tFont,
    vcCatAxisTickLabelFontStyle   tFontStyle,
    nCatAxisTickLabelFontSize     NUMBER,
    vcCatAxisTickLabelPattern     tPattern,
    vcCatAxisLineColor            tColor,
    vcValueAxisLabelExpression    tExpression,
    vcValueAxisLabelColor         tColor,
    vcValueAxisLabelFont          tFont,
    vcValueAxisLabelFontStyle     tFontStyle,
    nValueAxisLabelFontSize       NUMBER,
    vcValueAxisTickLabelColor     tColor,
    vcValueAxisTickLabelFont      tFont,
    vcValueAxisTickLabelFontStyle tFontStyle,
    nAxisTickLabelFontSize        NUMBER,
    vcValueAxisTickLabelPattern   tPattern,
    vcValueAxisLineColor          tColor,
    vcValueAxisMinValExpression   tExpression,
    vcValueAxisMaxValExpression   tExpression,
    vcCatAxisMinValExpression     tExpression,
    vcCatAxisMaxValExpression     tExpression,
    vcCustomizerClass             tMaxVarchar2,
    nLabelRotation                NUMBER
  );
  TYPE tStackedAreaChartList IS TABLE OF tStackedAreaChart INDEX BY BINARY_INTEGER;
  TYPE tLineChart IS RECORD (
    nX                            NUMBER,
    nY                            NUMBER,
    nWidth                        NUMBER,
    nHeight                       NUMBER,
    vcLineColor                   tColor,
    vcFillColor                   tColor,
    vcStyle                       tStylename,
    nBoxTop                       NUMBER,
    nBoxLeft                      NUMBER,
    nBoxBottom                    NUMBER,
    nBoxRight                     NUMBER,
    vcBoxTopColor                 tColor,
    vcBoxLeftColor                tColor,
    vcBoxBottomColor              tColor,
    vcBoxRightColor               tColor,
    nTopPadding                   NUMBER,
    nLeftPadding                  NUMBER,
    nBottomPadding                NUMBER,
    nRightPadding                 NUMBER,
    vcOpaque                      tYesNo,
    vcWhenExpression              tExpression,
    vcPositionType                tPositionType,
    vcQuery                       tMaxVarchar2,
    lParams                       tParamList,
    vcIs3D                        tYesNo,
    vcTitleExpression             tExpression,
    vcTitleColor                  tColor,
    vcTitlePosition               tPosition,
    vcTitleFont                   tFont,
    vcTitleFontStyle              tFontStyle,
    nTitleFontSize                NUMBER,
    vcSubTitleExpression          tExpression,
    vcSubTitleColor               tColor,
    vcSubTitleFont                tFont,
    vcSubTitleFontStyle           tFontStyle,
    nSubTitleFontSize             NUMBER,
    vcShowLegend                  tYesNo,
    vcLegendTextColor             tColor,
    vcLegendBgColor               tColor,
    vcLegendFont                  tFont,
    vcLegendFontStyle             tFontStyle,
    nLegendFontSize               NUMBER,
    vcLegendPosition              tPosition,
    lSeries                       tCategorySeriesList,
    lSeriesColors                 tColorList,
    vcShowLabels                  tYesNo,
    vcLabelFont                   tFont,
    vclabelFontStyle              tFontStyle,
    vcLabelColor                  tColor,
    nLabelFontSize                NUMBER,
    vcShowTickLabels              tYesNo,
    vcShowTickMarks               tYesNo,
    vcCatAxisLabelExpression      tExpression,
    vcCatAxisLabelColor           tColor,
    vcCatAxisLabelFont            tFont,
    vcCatAxisLabelFontStyle       tFontStyle,
    nCatAxisLabelFontSize         NUMBER,
    vcCatAxisTickLabelColor       tColor,
    vcCatAxisTickLabelFont        tFont,
    vcCatAxisTickLabelFontStyle   tFontStyle,
    nCatAxisTickLabelFontSize     NUMBER,
    vcCatAxisTickLabelPattern     tPattern,
    vcCatAxisLineColor            tColor,
    vcValueAxisLabelExpression    tExpression,
    vcValueAxisLabelColor         tColor,
    vcValueAxisLabelFont          tFont,
    vcValueAxisLabelFontStyle     tFontStyle,
    nValueAxisLabelFontSize       NUMBER,
    vcValueAxisTickLabelColor     tColor,
    vcValueAxisTickLabelFont      tFont,
    vcValueAxisTickLabelFontStyle tFontStyle,
    nAxisTickLabelFontSize        NUMBER,
    vcValueAxisTickLabelPattern   tPattern,
    vcValueAxisLineColor          tColor,
    vcValueAxisMinValExpression   tExpression,
    vcValueAxisMaxValExpression   tExpression,
    vcCatAxisMinValExpression     tExpression,
    vcCatAxisMaxValExpression     tExpression,
    vcCustomizerClass             tMaxVarchar2,
    nLabelRotation                NUMBER,
    vcShowLines                   tYesNo,
    vcShowShapes                  tYesNo
  );
  TYPE tLineChartList IS TABLE OF tLineChart INDEX BY BINARY_INTEGER;
  TYPE tPieChart IS RECORD (
    nX                    NUMBER,
    nY                    NUMBER,
    nWidth                NUMBER,
    nHeight               NUMBER,
    vcLineColor           tColor,
    vcFillColor           tColor,
    vcStyle               tStylename,
    nBoxTop               NUMBER,
    nBoxLeft              NUMBER,
    nBoxBottom            NUMBER,
    nBoxRight             NUMBER,
    vcBoxTopColor         tColor,
    vcBoxLeftColor        tColor,
    vcBoxBottomColor      tColor,
    vcBoxRightColor       tColor,
    nTopPadding           NUMBER,
    nLeftPadding          NUMBER,
    nBottomPadding        NUMBER,
    nRightPadding         NUMBER,
    vcOpaque              tYesNo,
    vcWhenExpression      tExpression,
    vcPositionType        tPositionType,
    vcQuery               tMaxVarchar2,
    lParams               tParamList,
    vcIs3D                tYesNo,
    vcTitleExpression     tExpression,
    vcTitleColor          tColor,
    vcTitlePosition       tPosition,
    vcTitleFont           tFont,
    vcTitleFontStyle      tFontStyle,
    nTitleFontSize        NUMBER,
    vcSubTitleExpression  tExpression,
    vcSubTitleColor       tColor,
    vcSubTitleFont        tFont,
    vcSubTitleFontStyle   tFontStyle,
    nSubTitleFontSize     NUMBER,
    vcShowLegend          tYesNo,
    vcLegendTextColor     tColor,
    vcLegendBgColor       tColor,
    vcLegendFont          tFont,
    vcLegendFontStyle     tFontStyle,
    nLegendFontSize       NUMBER,
    vcLegendPosition      tPosition,
    vcKeyExpression       tExpression,
    vcValueExpression     tExpression,
    lSeriesColors         tColorList,
    vcShowLabels          tYesNo,
    vcLabelFont           tFont,
    vclabelFontStyle      tFontStyle,
    vcLabelColor          tColor,
    nLabelFontSize        NUMBER,
    vcLabelFormat         tExpression,
    vcLegendLabelFormat   tExpression,
    vcCustomizerClass     tMaxVarchar2
  );
  TYPE tPieChartList IS TABLE OF tPieChart INDEX BY BINARY_INTEGER;
  TYPE tReport IS RECORD (
     nId                     NUMBER,
     nTyp                    NUMBER,
     nPageWidth              NUMBER,
     nPageHeight             NUMBER,
     nLeftMargin             NUMBER,
     nRightMargin            NUMBER,
     nTopMargin              NUMBER,
     nBottomMargin           NUMBER,
     vcFloatColumnFooter     tYesNo,
     vcTitleOnNewPage        tYesNo,
     vcSummaryOnNewPage      tYesNo,
     vcSummaryWithHdrFtr     tYesNo,
     vcResourceBundle        tName,
     nPageHdrHeight          NUMBER,
     nColumnHdrheight        NUMBER,
     nColumnFtrheight        NUMBER,
     nPageFtrHeight          NUMBER,
     nSummaryHeight          NUMBER,
     vcQuery                 tMaxVarchar2,
     lParams                 tParamList,
     lStyles                 tStyleList,
     rQuery                  tQuery,
     rLocaleData             tLocaleData,
     nXPositionHdr           NUMBER,
     rTitleRegion            tRegion,
     rPageHeaderRegion       tRegion,
     rColumnHeaderRegion     tRegion,
     rDetailRegion           tRegion,
     rColumnFooterRegion     tRegion,
     rPageFooterRegion       tRegion,
     rSummaryRegion          tRegion,
     rBackgroundRegion       tRegion,
     lObjects                tObjectList,
     lRegions                tRegionList,
     lBands                  tBandList,
     lLines                  tLineList,
     lRectangles             tRectangleList,
     lImages                 tImageList,
     lTexts                  tTextList,
     lFields                 tFieldList,
     lSubreports             tSubreportList,
     lBreaks                 tBreakList,
     lEvalLaterFields        tFieldList,
     lEvalLaterPageNo        tNumList,
     lGroups                 tGroupList,
     lGroupExpressions       tMaxVarcharList,
     lDatasets               tDatasetList,
     lCrosstabs              tCrosstabList,
     lMaps                   tMapList,
     lBarCharts              tBarchartList,
     lPieCharts              tPieChartList,
     lCategoryLineCharts     tLineChartList,
     lXYLineCharts           tLineChartList,
     lTimeLineCharts         tLineChartList,
     lStackedAreaCharts      tStackedAreaChartList,
     lVariableCache          tDataEntries,
     lResources              tResourceList,
     lPageNumbers            tNumList,
     lLogicalPageNumbers     tNumList,
     lStartOfPageDone        tNumList,
     lEndOfPageDone          tNumList,
     nCurrentPagePointer     NUMBER,
     lStoredPositions        tAreaList,
     lPageFrameMarkers       tPageFrameMarkerList,
     lVariables              tVariableList
  );
  TYPE tReportCache IS TABLE OF tReport INDEX BY tIndex;
  TYPE tFontNames IS TABLE OF tFont INDEX BY tFont;
  TYPE tXmlRegion IS RECORD (
    xml     XMLTYPE,
    nHeight NUMBER
  );
  TYPE tXmlRegionList IS TABLE OF tXmlRegion INDEX BY BINARY_INTEGER;
  TYPE tPageSetup IS RECORD (
    nPageWidth    NUMBER,
    nPageHeight   NUMBER,
    nLeftMargin   NUMBER,
    nRightMargin  NUMBER,
    nTopMargin    NUMBER,
    nBottomMargin NUMBER
  );
  TYPE tReportList IS TABLE OF tReport INDEX BY BINARY_INTEGER;
  TYPE tTextPiece IS RECORD (
    nX      NUMBER,
    nHeight NUMBER,
    nGroup  NUMBER,
    nLength NUMBER,
    vcText  tMaxVarchar2
  );
  TYPE tTextPieceList IS TABLE OF tTextPiece INDEX BY BINARY_INTEGER;
  TYPE tHtmlSettings IS RECORD (
    vcFont            tFont,
    nFontSize         NUMBER,
    nH1FontSize       NUMBER,
    nH2FontSize       NUMBER,
    nH3FontSize       NUMBER,
    nH4FontSize       NUMBER,
    nXXlargeFontSize  NUMBER,
    nXlargeFontSize   NUMBER,
    nLargeFontSize    NUMBER,
    nMediumFontSize   NUMBER,
    nSmallFontSize    NUMBER,
    nXsmallFontSize   NUMBER,
    nXXsmallFontSize  NUMBER,
    nLargerFontSize   NUMBER,
    nSmallerFontSize  NUMBER,
    nListIndent       NUMBER,
    vcUlChar          tChar,
    nH1LineSpacing    NUMBER,
    nH2LineSpacing    NUMBER,
    nH3LineSpacing    NUMBER,
    nH4LineSpacing    NUMBER,
    nLiLineSpacing    NUMBER,
    nBrLineSpacing    NUMBER,
    nLineSpacing      NUMBER
  );
  TYPE tHtmlToken IS RECORD (
    vcTag       tAttribute,
    bHasEndTag  BOOLEAN,
    bHasAttribs BOOLEAN
  );
  TYPE tHtmlPiece IS RECORD (
    vcTag       tAttribute,
    lAttribs    tAttributeList,
    vcText      tMaxVarchar2,
    lTextPieces tTextPieceList,
    vcFont      tFont,
    nGroup      NUMBER,
    nFontSize   NUMBER,
    vcFontStyle tFontStyle,
    vcColor     tColor,
    bIsPRE      BOOLEAN,
    bInList     BOOLEAN,
    nListIndex  NUMBER,
    nX          NUMBER,
    nHeight     NUMBER,
    lSubPieces  tNumList,
    bBreak      BOOLEAN
  );
  TYPE tHtmlPieceList IS TABLE OF tHtmlPiece INDEX BY BINARY_INTEGER;
  TYPE tHtmlTree IS RECORD (
    lPieces    tHtmlPieceList
  );
  TYPE tHtmlTokenList IS TABLE OF tHtmlToken INDEX BY BINARY_INTEGER;
  TYPE tHtmlReplacementList IS TABLE OF VARCHAR2(10) INDEX BY VARCHAR2(20);
  TYPE tTextCacheEntry IS RECORD (
    lText          tTextPieceList,
    nCurrentHeight NUMBER,
    nX             NUMBER,
    nGroup         NUMBER
  );
  TYPE tTextCacheList IS TABLE OF tTextCacheEntry INDEX BY tMaxVarchar2;
END;
/
create or replace PACKAGE pk_jrxml2pdf_util IS
/* *****************************************************************************
Copyright (C) 2012-2013 by Andreas Weiden
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
****************************************************************************** */
/**
  $name    PK_JRXML2PDF_UTIL
  $created 01.09.2012
  $author  Andreas Weiden
  $desc    Helper-Package for PL-jrxml2pdf with various functions around
           -NLS/locale
           -helpers
  $version 1.0.0.0 01.09.2012 Weiden
           initial version
  $version 1.0.0.1 29.09.2012 Weiden
           added FK_SPLIT
  $version 1.0.0.2 16.10.2012 Weiden
           moved types to PK_JRXML2PDF_TYPES
  $version 1.0.0.2 25.11.2012 Weiden
           included several procedures from PK_JRXML2PDF_REPGEN
  $version 1.0.0.3 08.12.2012 Weiden
           Bug-FIx in PR_SPLIT_TEXT_TO_BOX
  $version 1.0.0.4 13.12.2012 Weiden
           Bug-Fix in PR_SET_FONT: Read ebcoding from JRXML_FONTS,
           needed for unicode fonts (CID)
  $version 1.0.0.5 17.12.2012 Weiden
           Bug-Fix in PR_SPLIT_TEXT_TO_BOX
  $version 1.0.1.5 24.12.2012 Weiden
           Enhancement in PR_SET_FONT: Read flag for compression from JRXML_FONTS,
           needed for performance issues with large unicode fonts
  $version 1.0.2.0 31.03.2013 Weiden
           Added FK_JAVA_DATE_PATTERN
  $version 1.0.2.0 05.04.2013 Weiden
           Added FK_UPDATE_ADLER32_FOR_IMAGE
*/
/**
  $name    FK_GET_LOCALE_DATA
  $created 01.09.2012
  $author  Andreas Weiden
  $desc    checks the given locale and reads the associated NLS-data from JRXML_NLS_PARAMETERS
  $param   i_vcLocale Locale in java-notation (like en_US)
                      If no value is given, the current sessions NLS-settings are taken from NLS_SESSION_PARAMETERS
  $return  Record with locale-data
  $version 1.0.0.0 01.09.2012 Weiden
           initial version
*/
  FUNCTION FK_GET_LOCALE_DATA(i_vcLocale IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tLocaleData;
/**
  $name    FK_GET_RESOURCE
  $created 01.09.2012
  $author  Andreas Weiden
  $desc    reads all resource-entries for the givane name and locale
           If no matching resource is found, a record matching only the language is searched
           If still no matching recource is found, a record matching only the name is searched
  $param   i_vcRecourcename Name of the Resource-file
  $param   i_vcLocale Locale in java-notation (like en_US)
  $return  Array with ressource-entries, index by Key
  $version 1.0.0.0 01.09.2012 Weiden
           initial version
*/
  FUNCTION FK_GET_RESOURCE(i_vcResourceName IN VARCHAR2,
                           i_vcLocale       IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tResourceList;
/**
  $name    FK_ORA_DATE_PATTERN
  $created 01.09.2012
  $author  Andreas Weiden
  $desc    transforms the given Java-date-pattern into an Oracle-date-pattern
           currently no support for Timezone
  $param   i_vcPattern pattern in java-notation
  $return  Pattern in oracle-notation
  $version 1.0.0.0 01.09.2012 Weiden
           initial version
*/
  FUNCTION FK_ORA_DATE_PATTERN(i_vcPattern IN VARCHAR2)
  RETURN VARCHAR2;
/**
  $name    FK_TEXT_MESSAGE
  $created 01.09.2012
  $author  Andreas Weiden
  $desc    builds a textmessage- If the given text contains {0} {1} {2}, these placeholders
           are replaced by the given placeholder-values
  $param   i_vcText         Text containing placeholders
  $param   i_vcPlaceholder1 Text to put in placeholder {0}
  $param   i_vcPlaceholder2 Text to put in placeholder {1}
  $param   i_vcPlaceholder3 Text to put in placeholder {2}
  $return  Text for placeholder-substitutions
  $version 1.0.0.0 01.09.2012 Weiden
           initial version
  $version 1.0.0.1 28.10.2012 Weiden
           Changed so that you can pass {2} without {1}
*/
  FUNCTION FK_TEXT_MESSAGE(i_vcText         IN VARCHAR2,
                           i_vcPlaceholder1 IN VARCHAR2 DEFAULT NULL,
                           i_vcPlaceholder2 IN VARCHAR2 DEFAULT NULL,
                           i_vcPlaceholder3 IN VARCHAR2 DEFAULT NULL)
  RETURN VARCHAR2;
/**
  $name    FK_SPLIT
  $created 29.09.2012
  $author  Andreas Weiden
  $desc    cuts a piece of text out of the given text at the position of the given delimiter
           The original text is shortened by the cutoff text
  $param   io_vcText        Original text, returned cut off after the delimiter-position
  $param   i_vcDelimiter    Delimiter, defining the position to split
  $return  text before the delimiter-position
  $version 1.0.0.0 29.09.2012 Weiden
           initial version
*/
  FUNCTION FK_SPLIT(io_vcText     IN OUT NOCOPY VARCHAR2,
                    i_vcDelimiter IN     VARCHAR2 DEFAULT '|')
  RETURN VARCHAR2;
/**
  $name    PR_SET_FONT
  $created 08.11.2012
  $author  Andreas Weiden
  $desc    sets the given font, style and size as current font in AS_PDF3_MOD
           If the font is not present in the standard-fonts, the procedure
           tries to load the font from the custom-font-table and include it in the
           PDF.
  $param   i_vcFont         Name of the font to set
  $param   i_vcStyle        Fontstyle
  $param   i_nSize          Fontsize
  $version 1.0.0.0 08.11.2012 Weiden
           extracted from PK_JRXML2PDF_REPGEN
*/
  PROCEDURE PR_SET_FONT(i_vcFont  IN VARCHAR2,
                        i_vcStyle IN PK_JRXML2PDF_TYPES.tStyleName,
                        i_nSize   IN NUMBER);
/**
  $name    PR_INIT_FONTS
  $created 08.11.2012
  $author  Andreas Weiden
  $desc    Initializes the font-list and clears the custom font-list.
  $param   i_lParams List of parameter to check, if one of the standard-fonts should
                     not be mapped ($$EXTERNAL_FONT_ARIAL$$, $$EXTERNAL_FONT_TIMES$$, $$EXTERNAL_FONT_COURIER$$)
  $version 1.0.0.0 08.11.2012 Weiden
           extracted from PK_JRXML2PDF_REPGEN

  $version 1.0.0.1 06.04.2013
           added parameter lParams to filter if specific fonts should be treated
           as externa�
*/
  PROCEDURE PR_INIT_FONTS(i_lParams in PK_JRXML2PDF_TYPES.tParamList);
/**
  $name    PR_CLEAR_TEXT_CACHE
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    Clears the cache for text-fragments
  $version 1.0.0.0 25.11.2012 Weiden
           extracted from PK_JRXML2PDF_REPGEN
*/
  PROCEDURE PR_CLEAR_TEXT_CACHE;
/**
  $name    PR_GET_TEXT_PIECES
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    Splits a text into pieces depending on max-width and max height
  $param   io_lText          resulting array of text-pieces
  $param   io_nCurrentHeight starting height as input, resulting height as output
  $param   io_nX             Starting x on new lines, resulting x as output
  $param   i_vcText          text to split
  $param   i_nMaxHeight      maximum allowed height for the text, internal processing stops at that height
  $param   io_nGroup         Textgroup in case of HTML
  $param   i_nLineSpacing    inter-linespacing
  $param   i_nXStart         starting x in first row
  $param   i_nMaxWidth       maximum allowed text-width, used as split-border
  $param   i_bSplitByWord    Flag that for each a new textpiece should be created
  $version 1.0.0.0 25.11.2012 Weiden
           extracted from PK_JRXML2PDF_REPGEN
  $version 1.0.0.1 14.12.2012 Weiden
           added parameter i_bSplitByWord
  $version 1.0.0.2 17.12.2012 Weiden
           bugfix for SplitByWord: Added length of space to each piece
*/
  PROCEDURE PR_GET_TEXT_PIECES(io_lText          IN OUT NOCOPY PK_JRXML2PDF_TYPES.tTextPieceList,
                               io_nCurrentHeight IN OUT NOCOPY NUMBER,
                               io_nX             IN OUT NOCOPY NUMBER,
                               i_vcText          IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                               i_nMaxHeight      IN NUMBER,
                               io_nGroup         IN OUT NUMBER,
                               i_nLineSpacing    IN NUMBER,
                               i_nXStart         IN NUMBER,
                               i_nMaxWidth       IN NUMBER,
                               i_bSplitByWord    IN BOOLEAN DEFAULT FALSE
                              );
/**
  $name    PR_GET_TEXT_PIECES
  $created 25.11.2012
  $author  Andreas Weiden
  $desc    calculates the height of the given text based on max-width and max height
  $param   i_vcText          text to split
  $param   i_nX              starting x
  $param   i_nMaxHeight      maximum allowed height for the text, internal processing stops at that height
  $param   i_nLineSpacing    inter-linespacing
  $param   i_nXStart         starting x in first row
  $param   i_nMaxWidth       maximum allowed text-width, used as split-border
  $return  resulting Testheight
  $version 1.0.0.0 25.11.2012 Weiden
           extracted from PK_JRXML2PDF_REPGEN
*/
  FUNCTION FK_CALC_BOX_HEIGHT(i_vcText          IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                              i_nX              IN NUMBER,
                              i_nMaxHeight      IN NUMBER,
                              i_nLineSpacing    IN NUMBER,
                              i_nXStart         IN NUMBER,
                              i_nMaxWidth       IN NUMBER
                             )
  RETURN NUMBER;
/**
  $name    FK_JAVA_DATE_PATTERN
  $created 31.03.2013
  $author  Andreas Weiden
  $desc    transforms the given oracle-date-pattern into a java-date-pattern
           currently no support for Timezone
  $param   i_vcPattern pattern in oracle-notation
  $return  Pattern in java-notation
  $version 1.0.0.0 31.03.2013 Weiden
           initial version
*/
  FUNCTION FK_JAVA_DATE_PATTERN(i_vcPattern IN VARCHAR2)
  RETURN VARCHAR2;
/**
  $name    FK_UPDATE_ADLER32_FOR_IMAGE
  $created 06.04.2013
  $author  Andreas Weiden
  $desc    Calculates the adler32 for the given image and update the JRXML_REPORT_IMAGES-table
           accordingly
  $param   i_nId Id of the image in JRXML_REPORT_IMAGES
  $param   i_blImage Blob with image-data
  $return  adler32-value for the image
  $version 1.0.0.0 06.04.2013 Weiden
           initial version
*/
  FUNCTION FK_UPDATE_ADLER32_FOR_IMAGE(i_nId     IN NUMBER,
                                       i_blImage IN BLOB)
  RETURN VARCHAR2;

END;
/
create or replace PACKAGE pr_num_a_letras IS
--
-- Retrofitted
FUNCTION DinTex( x IN number )RETURN varchar2;
--
-- Retrofitted
FUNCTION NumTex( x IN number )
RETURN varchar2;
PRAGMA RESTRICT_REFERENCES (dintex, WNDS, WNPS);
PRAGMA RESTRICT_REFERENCES (numtex, WNDS, WNPS);
END PR_NUM_A_LETRAS;
/




































































































create or replace PROCEDURE calcular_nomina(p_anho IN NUMBER, p_mes IN NUMBER) AS
    v_id_periodo          NUMBER;
    v_id_empleado         NUMBER;
    v_total_ingresos      NUMBER := 0;
    v_total_descuentos    NUMBER := 0;
    v_neto_a_cobrar       NUMBER := 0;
    v_id_liquidacion      NUMBER;
    v_sueldo_base         NUMBER;
    v_bonificacion_hijos  NUMBER := 0;
    v_ips_descuento       NUMBER := 0;
    v_salario_minimo      NUMBER;
    v_numero_hijos        NUMBER := 0;
    v_cant_ausencias      NUMBER := 0;
    v_descuento_ausencia  NUMBER := 0;
    v_jornal              NUMBER := 0;
BEGIN
    ---------------------------------------------------------------------
    -- Crear el período de nómina (si no existe)
    ---------------------------------------------------------------------
    INSERT INTO PERIODO_NOMINA(ANHO, MES, FECHA_APERTURA, FECHA_CIERRE, ESTADO)
    VALUES (p_anho, p_mes, SYSDATE, NULL, 'ABIERTO');
    COMMIT;

    ---------------------------------------------------------------------
    -- 1. Obtener ID del período
    ---------------------------------------------------------------------
    SELECT ID_PERIODO
    INTO v_id_periodo
    FROM PERIODO_NOMINA
    WHERE ANHO = p_anho 
      AND MES = p_mes 
      AND ESTADO = 'ABIERTO';

    ---------------------------------------------------------------------
    -- 2. Obtener salario mínimo vigente
    ---------------------------------------------------------------------
    SELECT MONTO
    INTO v_salario_minimo
    FROM SALARIO_MINIMO
    WHERE ES_VIGENTE = 'S'
      AND FECHA_DESDE <= TRUNC(SYSDATE);

    ---------------------------------------------------------------------
    -- 3. Iterar sobre empleados activos (excepto cargo 3)
    ---------------------------------------------------------------------
    FOR empleado IN (
        SELECT ID_EMPLEADO
        FROM EMPLEADO
        WHERE ID_CARGO != 3
          AND (FECHA_SALIDA IS NULL OR FECHA_SALIDA > SYSDATE)
    ) LOOP
        v_id_empleado := empleado.ID_EMPLEADO;

        -- Inicializar variables
        v_total_ingresos := 0;
        v_total_descuentos := 0;
        v_bonificacion_hijos := 0;
        v_numero_hijos := 0;
        v_cant_ausencias := 0;
        v_descuento_ausencia := 0;

        -----------------------------------------------------------------
        -- 4. Calcular ingresos (CREDITO)
        -----------------------------------------------------------------
        FOR concepto IN (
            SELECT c.ID_CONCEPTO,
                   NVL(c.MONTO, 100000) AS MONTO_CONCEPTO,
                   c.ES_RECURRENTE
            FROM CONCEPTO_SALARIAL c
            JOIN EMPLEADO_CONCEPTO ec ON ec.CON_ID_CONCEPTO = c.ID_CONCEPTO
            WHERE ec.EMP_ID_EMPLEADO = v_id_empleado
              AND c.TIPO = 'CREDITO'
              AND c.ID_CONCEPTO NOT IN (1, 2)
        ) LOOP
            IF concepto.ES_RECURRENTE = 'S' THEN
                v_total_ingresos := v_total_ingresos + concepto.MONTO_CONCEPTO;
            END IF;
        END LOOP;

        -- Sueldo Base (ID_CONCEPTO = 1)
        SELECT SALARIO
        INTO v_sueldo_base
        FROM CARGO
        WHERE ID_CARGO = (SELECT ID_CARGO FROM EMPLEADO WHERE ID_EMPLEADO = v_id_empleado);
        v_total_ingresos := v_total_ingresos + v_sueldo_base;

        -----------------------------------------------------------------
        -- 5. Bonificación Familiar por Hijos (ID_CONCEPTO = 2)
        -- Solo si el sueldo base <= 3 salarios mínimos
        -----------------------------------------------------------------
        IF v_sueldo_base <= (v_salario_minimo * 3) THEN
            FOR hijo IN (
                SELECT *
                FROM HIJO
                WHERE EMP_ID_EMPLEADO = v_id_empleado
                  AND FECHA_NAC >= ADD_MONTHS(SYSDATE, -12*18)
                  AND VR_VALIDO_HASTA >= SYSDATE
            ) LOOP
                v_numero_hijos := v_numero_hijos + 1;
                IF v_numero_hijos <= 4 THEN
                    v_bonificacion_hijos := v_bonificacion_hijos + (v_salario_minimo * 0.05);
                END IF;
            END LOOP;

            v_total_ingresos := v_total_ingresos + v_bonificacion_hijos;
        END IF;

        -----------------------------------------------------------------
        -- 6. Calcular descuentos (IPS y otros)
        -----------------------------------------------------------------
        v_ips_descuento := v_sueldo_base * 0.09;
        v_total_descuentos := v_ips_descuento;

        -- Débitos adicionales (excepto IPS y ausencia)
        FOR concepto IN (
            SELECT c.ID_CONCEPTO,
                   NVL(c.MONTO, 100000) AS MONTO_CONCEPTO
            FROM CONCEPTO_SALARIAL c
            JOIN EMPLEADO_CONCEPTO ec ON ec.CON_ID_CONCEPTO = c.ID_CONCEPTO
            WHERE ec.EMP_ID_EMPLEADO = v_id_empleado
              AND c.TIPO = 'DEBITO'
              AND c.ID_CONCEPTO NOT IN (10, 11)
        ) LOOP
            v_total_descuentos := v_total_descuentos + concepto.MONTO_CONCEPTO;
        END LOOP;

        -----------------------------------------------------------------
        -- 7. Descuento por Ausencias (ID_CONCEPTO = 11)
        -- Se usa AUX_EMP_AUSENCIAS para el mismo año y mes
        -----------------------------------------------------------------
        BEGIN
            SELECT NVL(CANTIDAD_AUS, 0)
            INTO v_cant_ausencias
            FROM AUX_EMP_AUSENCIAS
            WHERE EMP_ID_EMPLEADO = v_id_empleado
              AND ANHO = p_anho
              AND MES = p_mes;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                v_cant_ausencias := 0;
        END;

        IF v_cant_ausencias > 0 THEN
            v_jornal := v_salario_minimo / 30;
            v_descuento_ausencia := v_cant_ausencias * v_jornal;
            v_total_descuentos := v_total_descuentos + v_descuento_ausencia;

            -- Eliminar registro de AUX_EMP_AUSENCIAS luego de procesarlo
            DELETE FROM AUX_EMP_AUSENCIAS
            WHERE EMP_ID_EMPLEADO = v_id_empleado
              AND ANHO = p_anho
              AND MES = p_mes;
        END IF;

        -----------------------------------------------------------------
        -- 8. Calcular neto a cobrar
        -----------------------------------------------------------------
        v_neto_a_cobrar := v_total_ingresos - v_total_descuentos;

        -----------------------------------------------------------------
        -- 9. Registrar LIQUIDACIÓN
        -----------------------------------------------------------------
        INSERT INTO LIQUIDACION (
            EMP_ID_EMPLEADO, PER_ID_PERIODO, TOTAL_INGRESOS,
            TOTAL_DESCUENTOS, NETO_A_COBRAR_NUM, NETO_A_COBRAR_LET,
            FECHA_GENERACION, FECHA_CONFIRMACION
        )
        VALUES (
            v_id_empleado, v_id_periodo, v_total_ingresos, v_total_descuentos,
            v_neto_a_cobrar, UPPER(pr_num_a_letras.DinTex(v_neto_a_cobrar)),
            SYSDATE, SYSDATE
        )
        RETURNING ID_LIQUIDACION INTO v_id_liquidacion;

        -----------------------------------------------------------------
        -- 10. Registrar DETALLE DE LIQUIDACIÓN
        -----------------------------------------------------------------

        -- Sueldo Base
        INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
        VALUES (v_id_liquidacion, 1, 1, v_sueldo_base);

        -- Otros créditos
        FOR concepto IN (
            SELECT c.ID_CONCEPTO, NVL(c.MONTO, 100000) AS MONTO_CONCEPTO
            FROM CONCEPTO_SALARIAL c
            JOIN EMPLEADO_CONCEPTO ec ON ec.CON_ID_CONCEPTO = c.ID_CONCEPTO
            WHERE ec.EMP_ID_EMPLEADO = v_id_empleado
              AND c.TIPO='CREDITO'
              AND c.ID_CONCEPTO NOT IN (1, 2)
        ) LOOP
            INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
            VALUES (v_id_liquidacion, concepto.ID_CONCEPTO, 1, concepto.MONTO_CONCEPTO);
        END LOOP;

        -- Bonificación Familiar
        IF v_bonificacion_hijos > 0 THEN
            INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
            VALUES (v_id_liquidacion, 2, v_numero_hijos, v_bonificacion_hijos);
        END IF;

        -- Débitos (excluye IPS y ausencia)
        FOR concepto IN (
            SELECT c.ID_CONCEPTO, NVL(c.MONTO, 100000) AS MONTO_CONCEPTO
            FROM CONCEPTO_SALARIAL c
            JOIN EMPLEADO_CONCEPTO ec ON ec.CON_ID_CONCEPTO = c.ID_CONCEPTO
            WHERE ec.EMP_ID_EMPLEADO = v_id_empleado
              AND c.TIPO='DEBITO'
              AND c.ID_CONCEPTO NOT IN (10, 11)
        ) LOOP
            INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
            VALUES (v_id_liquidacion, concepto.ID_CONCEPTO, 1, concepto.MONTO_CONCEPTO);
        END LOOP;

        -- Descuento por Ausencias (ID_CONCEPTO = 11)
        IF v_descuento_ausencia > 0 THEN
            INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
            VALUES (v_id_liquidacion, 11, v_cant_ausencias, v_descuento_ausencia);
        END IF;

        -- Descuento IPS (ID_CONCEPTO = 10)
        INSERT INTO DET_LIQUIDACION (LIQ_ID_LIQUIDACION, CON_ID_CONCEPTO, CANTIDAD, MONTO)
        VALUES (v_id_liquidacion, 10, 1, v_ips_descuento);

    END LOOP;

    COMMIT;
END calcular_nomina;
/
create or replace PROCEDURE cerrar_nomina(p_id_periodo IN NUMBER) AS
BEGIN
    ---------------------------------------------------------------------
    -- 1️⃣ Validar que el período exista y esté abierto
    ---------------------------------------------------------------------
    DECLARE
        v_estado VARCHAR2(20);
    BEGIN
        SELECT ESTADO
        INTO v_estado
        FROM PERIODO_NOMINA
        WHERE ID_PERIODO = p_id_periodo;

        IF v_estado <> 'ABIERTO' THEN
            RAISE_APPLICATION_ERROR(-20001, 'El período ya está cerrado o no está disponible.');
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20002, 'El período de nómina no existe.');
    END;

    ---------------------------------------------------------------------
    -- 2️⃣ Actualizar las liquidaciones del período
    ---------------------------------------------------------------------
    UPDATE LIQUIDACION
    SET FECHA_CONFIRMACION = SYSDATE
    WHERE PER_ID_PERIODO = p_id_periodo;

    ---------------------------------------------------------------------
    -- 3️⃣ Cerrar el período de nómina
    ---------------------------------------------------------------------
    UPDATE PERIODO_NOMINA
    SET FECHA_CIERRE = SYSDATE,
        ESTADO = 'CERRADO'
    WHERE ID_PERIODO = p_id_periodo;

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('✅ Nómina ' || p_id_periodo || ' cerrada correctamente.');
END cerrar_nomina;
/
create or replace PROCEDURE cgui$cg_code_controls (
    p_cc_domain IN     VARCHAR2,  -- dominio que identifica la fila de control
    p_cc_target IN OUT NUMBER     -- aquí se devuelve el nuevo ID
) IS
    v_rowid        ROWID;
    v_next_value   NUMBER;
    v_increment    NUMBER;
BEGIN
    -- 1) Leer y bloquear la fila del dominio
    SELECT sec_sig_valor, sec_incremento, ROWID
      INTO v_next_value, v_increment, v_rowid
      FROM secuencia
     WHERE sec_nombre = p_cc_domain
     FOR UPDATE OF sec_sig_valor, sec_incremento;

    -- 2) Normalizar incremento (por si estuviera NULL)
    IF v_increment IS NULL THEN
        v_increment := 1;
    END IF;

    -- 3) Entregar el valor actual como nuevo ID
    p_cc_target := v_next_value;

    -- 4) Avanzar el contador en la tabla
    UPDATE secuencia
       SET sec_sig_valor = v_next_value + v_increment
     WHERE ROWID = v_rowid;

    -- Nota: COMMIT lo hace el caller (buenas prácticas en PL/SQL)

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- Dominio inexistente
        RAISE_APPLICATION_ERROR(
            -20000,
            'CG_CODE_CONTROLS: dominio no encontrado: ' || p_cc_domain
        );
    WHEN OTHERS THEN
        -- Repropagar con contexto
        RAISE_APPLICATION_ERROR(
            -20001,
            'CG_CODE_CONTROLS: error en dominio ' || p_cc_domain || ' -> ' || SQLERRM
        );
END;
/
create or replace PROCEDURE eliminar_periodo(p_id_periodo IN NUMBER) AS
    v_estado VARCHAR2(20);
BEGIN
    ---------------------------------------------------------------------
    -- 1️⃣ Validar que el período exista
    ---------------------------------------------------------------------
    BEGIN
        SELECT ESTADO
        INTO v_estado
        FROM PERIODO_NOMINA
        WHERE ID_PERIODO = p_id_periodo;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20001, ' El período indicado no existe.');
    END;

    ---------------------------------------------------------------------
    -- 2️⃣ Validar que el período no esté cerrado
    ---------------------------------------------------------------------
    IF v_estado = 'CERRADO' THEN
        RAISE_APPLICATION_ERROR(-20002, ' No se puede eliminar un período de nómina cerrado.');
    END IF;

    ---------------------------------------------------------------------
    -- 3️⃣ Eliminar detalles de liquidación asociados a las liquidaciones del período
    ---------------------------------------------------------------------
    DELETE FROM DET_LIQUIDACION
    WHERE LIQ_ID_LIQUIDACION IN (
        SELECT ID_LIQUIDACION
        FROM LIQUIDACION
        WHERE PER_ID_PERIODO = p_id_periodo
    );

    ---------------------------------------------------------------------
    -- 4️⃣ Eliminar liquidaciones del período
    ---------------------------------------------------------------------
    DELETE FROM LIQUIDACION
    WHERE PER_ID_PERIODO = p_id_periodo;

    ---------------------------------------------------------------------
    -- 5️⃣ Eliminar el período de nómina
    ---------------------------------------------------------------------
    DELETE FROM PERIODO_NOMINA
    WHERE ID_PERIODO = p_id_periodo;

EXCEPTION
    WHEN OTHERS THEN
       
        RAISE_APPLICATION_ERROR(-20003, 'Error al eliminar el período: ' || SQLERRM);
END eliminar_periodo;
/
create or replace PROCEDURE print_error (p_mensaje VARCHAR2,
                                                p_item VARCHAR2 DEFAULT NULL)
IS
    ERROR EXCEPTION;
BEGIN
    /*IF p_item IS NULL THEN
        APEX_ERROR.ADD_ERROR (
                                  p_message          => InitCap(p_mensaje),
                                  p_display_location => apex_error.c_inline_in_notification );
    ELSE
        APEX_ERROR.ADD_ERROR (
                                  p_message          => InitCap(p_mensaje),
                                  p_display_location => apex_error.c_inline_in_notification,
                                  p_page_item_name => Upper(p_item) );
    END IF;
    RAISE error;*/
  apex_application.show_error_message (p_mensaje);
END;
/
create or replace PROCEDURE pr_det_rol (
    p_id_rol    IN NUMBER,
    p_permisos  IN VARCHAR2
) IS
BEGIN
  -- Borro todos los permisos anteriores
  DELETE FROM det_rol
  WHERE rol_id_rol = p_id_rol;

  -- Inserto los nuevos permisos
  INSERT INTO det_rol (permiso, rol_id_rol)
    SELECT DISTINCT
           TRIM(regexp_substr(p_permisos, '[^:]+', 1, LEVEL)) AS permiso,
           p_id_rol
    FROM dual
    CONNECT BY regexp_substr(p_permisos, '[^:]+', 1, LEVEL) IS NOT NULL;

END;
/
create or replace PROCEDURE pr_enviar_mail_liquidacion (
    p_id_liquidacion IN liquidacion.id_liquidacion%TYPE
) IS
    -- Datos de la liquidación / empleado / período
    v_nombre          empleado.nombre%TYPE;
    v_apellido        empleado.apellido%TYPE;
    v_correo          empleado.correo%TYPE;
    v_anho            periodo_nomina.anho%TYPE;
    v_mes             periodo_nomina.mes%TYPE;
    v_fecha_gen       liquidacion.fecha_generacion%TYPE;
    v_neto_cobrar     liquidacion.neto_a_cobrar_num%TYPE;

    -- Texto del mail
    v_asunto          VARCHAR2(200);
    v_body_text       CLOB;
    v_body_html       CLOB;

    -- Remitente (FROM)
    v_from            VARCHAR2(100) := 'rrhh@miempresa.com';

    v_mail_id         NUMBER;
BEGIN
    /* Traemos todos los datos necesarios de una sola vez */
    SELECT e.nombre,
           e.apellido,
           e.correo,
           p.anho,
           p.mes,
           l.fecha_generacion,
           l.neto_a_cobrar_num
      INTO v_nombre,
           v_apellido,
           v_correo,
           v_anho,
           v_mes,
           v_fecha_gen,
           v_neto_cobrar
      FROM liquidacion      l
      JOIN empleado         e ON e.id_empleado = l.emp_id_empleado
      JOIN periodo_nomina   p ON p.id_periodo = l.per_id_periodo
     WHERE l.id_liquidacion = p_id_liquidacion;

    -- Armamos asunto
    v_asunto := 'Liquidación de haberes - Periodo '||
                LPAD(v_mes,2,'0')||'/'||v_anho;

    -- Cuerpo en texto plano
    v_body_text :=
          'Estimado/a '||v_nombre||' '||v_apellido||','||CHR(10)||CHR(10)
       || 'Se generó la liquidación correspondiente al periodo '
       || LPAD(v_mes,2,'0')||'/'||v_anho||'.'||CHR(10)
       || 'Fecha de generación: '||TO_CHAR(v_fecha_gen, 'DD/MM/YYYY')||CHR(10)
       || 'Neto a cobrar: '||TO_CHAR(v_neto_cobrar, 'FM999G999G999D00')||CHR(10)||CHR(10)
       || 'Por favor revise su liquidación en el sistema para más detalles.'||CHR(10)||CHR(10)
       || 'Saludos cordiales,'||CHR(10)
       || 'Departamento de RRHH';

    -- Cuerpo en HTML
    v_body_html :=
          '<p>Estimado/a <strong>'||v_nombre||' '||v_apellido||'</strong>,</p>'
       || '<p>Se generó la liquidación correspondiente al periodo <strong>'
       || LPAD(v_mes,2,'0')||'/'||v_anho||'</strong>.</p>'
       || '<ul>'
       ||   '<li><strong>Fecha de generación:</strong> '
       ||        TO_CHAR(v_fecha_gen, 'DD/MM/YYYY')||'</li>'
       ||   '<li><strong>Neto a cobrar:</strong> '
       ||        TO_CHAR(v_neto_cobrar, 'FM999G999G999D00')||'</li>'
       || '</ul>'
       || '<p>Por favor revise su liquidación en el sistema para más detalles.</p>'
       || '<p>Saludos cordiales,<br/>Departamento de RRHH</p>';

    -- Enviamos el mail
    v_mail_id := APEX_MAIL.SEND(
        p_to        => v_correo,          -- correo del empleado
        p_from      => v_from,            -- remitente (FROM)
        p_subj      => v_asunto,
        p_body      => v_body_text,
        p_body_html => v_body_html
    );

    -- Empujar la cola (si no tenés un job que lo haga)
    APEX_MAIL.PUSH_QUEUE;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- No existe la liquidación o no matchea empleado/período
        RAISE_APPLICATION_ERROR(-20001,
          'No se encontraron datos para la liquidación '||p_id_liquidacion);
    WHEN OTHERS THEN
        RAISE;
END pr_enviar_mail_liquidacion;
/
create or replace PROCEDURE PR_GET_NEXT_VAL(
  p_sec_name IN  VARCHAR2,
  p_next_val OUT NUMBER
) IS
  v_curr NUMBER;
  v_inc  NUMBER;
BEGIN
  SELECT sec_sig_valor, sec_incremento
    INTO v_curr, v_inc
    FROM secuencia
   WHERE sec_nombre = p_sec_name
   FOR UPDATE;

  UPDATE secuencia
     SET sec_sig_valor = v_curr + v_inc
   WHERE sec_nombre = p_sec_name;

  -- no hagas COMMIT aquí; que comitee quien llama
  p_next_val := v_curr;
END;
/













































   CREATE SEQUENCE  "JRXML_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 21 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;






















































































create or replace TRIGGER atiu_rol
AFTER INSERT OR UPDATE ON rol
FOR EACH ROW
BEGIN
  IF if_update(:OLD.permisos, :NEW.permisos) THEN
    pr_det_rol(
      p_id_rol    => :NEW.id_rol,
      p_permisos  => :NEW.permisos
    );
  END IF;
END;
/
create or replace TRIGGER btrg_jri_rui
BEFORE INSERT OR UPDATE ON jrxml_report_images
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRI_ADLER32_VALID:='N';
  ELSE
    IF     :OLD.JRI_ADLER32_VALID='Y'
       AND :NEW.JRI_ADLER32_VALID='Y' THEN
      :NEW.JRI_ADLER32_VALID:='N';
    END IF;
  END IF;
END;
/
create or replace TRIGGER btrg_jrr_rui
BEFORE INSERT OR UPDATE ON jrxml_resource_files
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRR_VALID:='N';
  ELSE
    IF     :OLD.JRR_VALID='Y'
       AND :NEW.JRR_VALID='Y' THEN
      :NEW.JRR_VALID:='N';
    END IF;
  END IF;
END;
/
create or replace trigger TRG_BI_CARGO
before insert on CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_cargo is null then 
            cgui$cg_code_controls('SEQ_CARGO', V_NEXT_VAL);

            :NEW.ID_CARGO := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_concepto_salarial
before insert on CONCEPTO_SALARIAL 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_concepto is null then 
            cgui$cg_code_controls('SEQ_CONCEPTO_SALARIO', V_NEXT_VAL);

            :NEW.ID_concepto := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_det_LIQUIDACION
before insert on det_LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_det_liquidacion is null then 
            cgui$cg_code_controls('SEQ_DET_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_det_liquidacion := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_empleado
before insert on empleado 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_empleado is null then 
            cgui$cg_code_controls('SEQ_EMPLEADO', V_NEXT_VAL);

            :NEW.ID_EMPLEADO := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_emp_con
before insert on empleado_concepto
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_emp_con is null then 
            cgui$cg_code_controls('SEQ_EMP_CON', V_NEXT_VAL);

            :NEW.id_emp_con := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_HIJO
before insert on HIJO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_hijo is null then 
            cgui$cg_code_controls('SEQ_HIJO', V_NEXT_VAL);

            :NEW.ID_HIJO := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_HISTORICO_CARGO
before insert on HISTORICO_CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.ID_HISTORICO_CARGO is null then 
            cgui$cg_code_controls('SEQ_HISTORIAL_CARGO', V_NEXT_VAL);

            :NEW.ID_HISTORICO_CARGO := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_LIQUIDACION
before insert on LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_liquidacion is null then 
            cgui$cg_code_controls('SEQ_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_liquidacion := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_PERIODO_NOMINA
before insert on PERIODO_NOMINA 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_periodo is null then 
            cgui$cg_code_controls('SEQ_PERIODO', V_NEXT_VAL);

            :NEW.id_periodo := V_NEXT_VAL;
    end if;
end;
/
create or replace trigger TRG_BI_ROL
before insert on rol 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_rol is null then 
            cgui$cg_code_controls('SEQ_ROL', V_NEXT_VAL);

            :NEW.ID_ROL := V_NEXT_VAL;
    end if;
end;
/
create or replace TRIGGER TRG_DET_LIQUIDACION_AIUD
AFTER INSERT OR UPDATE OR DELETE ON DET_LIQUIDACION
DECLARE
BEGIN
    -- Recalcular totales de TODAS las liquidaciones afectadas
    FOR liq IN (
        SELECT DISTINCT LIQ_ID_LIQUIDACION AS ID_LIQUIDACION
        FROM DET_LIQUIDACION
    ) LOOP
        DECLARE
            v_total_ingresos   NUMBER := 0;
            v_total_descuentos NUMBER := 0;
            v_neto             NUMBER := 0;
        BEGIN
            -- Calcular ingresos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_ingresos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'CREDITO';

            -- Calcular descuentos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_descuentos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'DEBITO';

            -- Calcular neto
            v_neto := v_total_ingresos - v_total_descuentos;

            -- Actualizar cabecera
            UPDATE LIQUIDACION
            SET TOTAL_INGRESOS    = v_total_ingresos,
                TOTAL_DESCUENTOS  = v_total_descuentos,
                NETO_A_COBRAR_NUM = v_neto,
                NETO_A_COBRAR_LET = UPPER(pr_num_a_letras.DinTex(v_neto))
            WHERE ID_LIQUIDACION = liq.ID_LIQUIDACION;
        END;
    END LOOP;
END;
/
create or replace TRIGGER trg_historico_cargo
AFTER INSERT OR UPDATE OF id_cargo ON empleado
FOR EACH ROW
BEGIN
    -- Cuando se inserta un empleado nuevo
    IF INSERTING THEN
        INSERT INTO historico_cargo (
            emp_id_empleado,
            car_id_cargo,
            fecha_inicio,
            fecha_fin
        ) VALUES (
            :NEW.id_empleado,
            :NEW.id_cargo,
            current_date,
            NULL
        );

    -- Cuando se actualiza el empleado
    ELSIF UPDATING('ID_CARGO') THEN

        -- Sólo si realmente cambió el cargo
        IF :NEW.id_cargo <> :OLD.id_cargo THEN
            
            -- Cierro el registro anterior
            UPDATE historico_cargo
               SET fecha_fin = current_date
             WHERE emp_id_empleado = :OLD.id_empleado
               AND car_id_cargo   = :OLD.id_cargo
               AND fecha_fin IS NULL;

            -- Inserto el nuevo registro de histórico
            INSERT INTO historico_cargo (
                emp_id_empleado,
                car_id_cargo,
                fecha_inicio,
                fecha_fin
            ) VALUES (
                :NEW.id_empleado,
                :NEW.id_cargo,
                current_date,
                NULL
            );
        END IF;
    END IF;
END trg_historico_cargo;
/

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CARGO" 
before insert on CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_cargo is null then 
            cgui$cg_code_controls('SEQ_CARGO', V_NEXT_VAL);

            :NEW.ID_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CARGO" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CONCEPTO_SALARIAL" 
before insert on CONCEPTO_SALARIAL 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_concepto is null then 
            cgui$cg_code_controls('SEQ_CONCEPTO_SALARIO', V_NEXT_VAL);

            :NEW.ID_concepto := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CONCEPTO_SALARIAL" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_DET_LIQUIDACION" 
before insert on det_LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_det_liquidacion is null then 
            cgui$cg_code_controls('SEQ_DET_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_det_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_DET_LIQUIDACION" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_DET_LIQUIDACION_AIUD" 
AFTER INSERT OR UPDATE OR DELETE ON DET_LIQUIDACION
DECLARE
BEGIN
    -- Recalcular totales de TODAS las liquidaciones afectadas
    FOR liq IN (
        SELECT DISTINCT LIQ_ID_LIQUIDACION AS ID_LIQUIDACION
        FROM DET_LIQUIDACION
    ) LOOP
        DECLARE
            v_total_ingresos   NUMBER := 0;
            v_total_descuentos NUMBER := 0;
            v_neto             NUMBER := 0;
        BEGIN
            -- Calcular ingresos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_ingresos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'CREDITO';

            -- Calcular descuentos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_descuentos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'DEBITO';

            -- Calcular neto
            v_neto := v_total_ingresos - v_total_descuentos;

            -- Actualizar cabecera
            UPDATE LIQUIDACION
            SET TOTAL_INGRESOS    = v_total_ingresos,
                TOTAL_DESCUENTOS  = v_total_descuentos,
                NETO_A_COBRAR_NUM = v_neto,
                NETO_A_COBRAR_LET = UPPER(pr_num_a_letras.DinTex(v_neto))
            WHERE ID_LIQUIDACION = liq.ID_LIQUIDACION;
        END;
    END LOOP;
END;
/
ALTER TRIGGER "TRG_DET_LIQUIDACION_AIUD" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMPLEADO" 
before insert on empleado 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_empleado is null then 
            cgui$cg_code_controls('SEQ_EMPLEADO', V_NEXT_VAL);

            :NEW.ID_EMPLEADO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMPLEADO" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_HISTORICO_CARGO" 
AFTER INSERT OR UPDATE OF id_cargo ON empleado
FOR EACH ROW
BEGIN
    -- Cuando se inserta un empleado nuevo
    IF INSERTING THEN
        INSERT INTO historico_cargo (
            emp_id_empleado,
            car_id_cargo,
            fecha_inicio,
            fecha_fin
        ) VALUES (
            :NEW.id_empleado,
            :NEW.id_cargo,
            current_date,
            NULL
        );

    -- Cuando se actualiza el empleado
    ELSIF UPDATING('ID_CARGO') THEN

        -- Sólo si realmente cambió el cargo
        IF :NEW.id_cargo <> :OLD.id_cargo THEN
            
            -- Cierro el registro anterior
            UPDATE historico_cargo
               SET fecha_fin = current_date
             WHERE emp_id_empleado = :OLD.id_empleado
               AND car_id_cargo   = :OLD.id_cargo
               AND fecha_fin IS NULL;

            -- Inserto el nuevo registro de histórico
            INSERT INTO historico_cargo (
                emp_id_empleado,
                car_id_cargo,
                fecha_inicio,
                fecha_fin
            ) VALUES (
                :NEW.id_empleado,
                :NEW.id_cargo,
                current_date,
                NULL
            );
        END IF;
    END IF;
END trg_historico_cargo;
/
ALTER TRIGGER "TRG_HISTORICO_CARGO" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMP_CON" 
before insert on empleado_concepto
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_emp_con is null then 
            cgui$cg_code_controls('SEQ_EMP_CON', V_NEXT_VAL);

            :NEW.id_emp_con := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMP_CON" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HIJO" 
before insert on HIJO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_hijo is null then 
            cgui$cg_code_controls('SEQ_HIJO', V_NEXT_VAL);

            :NEW.ID_HIJO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HIJO" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HISTORICO_CARGO" 
before insert on HISTORICO_CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.ID_HISTORICO_CARGO is null then 
            cgui$cg_code_controls('SEQ_HISTORIAL_CARGO', V_NEXT_VAL);

            :NEW.ID_HISTORICO_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HISTORICO_CARGO" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRI_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_report_images
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRI_ADLER32_VALID:='N';
  ELSE
    IF     :OLD.JRI_ADLER32_VALID='Y'
       AND :NEW.JRI_ADLER32_VALID='Y' THEN
      :NEW.JRI_ADLER32_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRI_RUI" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRR_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_resource_files
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRR_VALID:='N';
  ELSE
    IF     :OLD.JRR_VALID='Y'
       AND :NEW.JRR_VALID='Y' THEN
      :NEW.JRR_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRR_RUI" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_LIQUIDACION" 
before insert on LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_liquidacion is null then 
            cgui$cg_code_controls('SEQ_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_LIQUIDACION" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_PERIODO_NOMINA" 
before insert on PERIODO_NOMINA 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_periodo is null then 
            cgui$cg_code_controls('SEQ_PERIODO', V_NEXT_VAL);

            :NEW.id_periodo := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_PERIODO_NOMINA" ENABLE;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_ROL" 
before insert on rol 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_rol is null then 
            cgui$cg_code_controls('SEQ_ROL', V_NEXT_VAL);

            :NEW.ID_ROL := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_ROL" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "ATIU_ROL" 
AFTER INSERT OR UPDATE ON rol
FOR EACH ROW
BEGIN
  IF if_update(:OLD.permisos, :NEW.permisos) THEN
    pr_det_rol(
      p_id_rol    => :NEW.id_rol,
      p_permisos  => :NEW.permisos
    );
  END IF;
END;
/
ALTER TRIGGER "ATIU_ROL" ENABLE;






































































































  CREATE UNIQUE INDEX "PK_CARGO" ON "CARGO" ("ID_CARGO") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CARGO" 
before insert on CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_cargo is null then 
            cgui$cg_code_controls('SEQ_CARGO', V_NEXT_VAL);

            :NEW.ID_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CARGO" ENABLE;

  CREATE UNIQUE INDEX "PK_CONCEPTO_SALARIAL" ON "CONCEPTO_SALARIAL" ("ID_CONCEPTO") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_CONCEPTO_SALARIAL" 
before insert on CONCEPTO_SALARIAL 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_concepto is null then 
            cgui$cg_code_controls('SEQ_CONCEPTO_SALARIO', V_NEXT_VAL);

            :NEW.ID_concepto := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_CONCEPTO_SALARIAL" ENABLE;

  CREATE UNIQUE INDEX "PK_DETALLE_LIQUIDACION" ON "DET_LIQUIDACION" ("ID_DET_LIQUIDACION") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_DET_LIQUIDACION" 
before insert on det_LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_det_liquidacion is null then 
            cgui$cg_code_controls('SEQ_DET_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_det_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_DET_LIQUIDACION" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_DET_LIQUIDACION_AIUD" 
AFTER INSERT OR UPDATE OR DELETE ON DET_LIQUIDACION
DECLARE
BEGIN
    -- Recalcular totales de TODAS las liquidaciones afectadas
    FOR liq IN (
        SELECT DISTINCT LIQ_ID_LIQUIDACION AS ID_LIQUIDACION
        FROM DET_LIQUIDACION
    ) LOOP
        DECLARE
            v_total_ingresos   NUMBER := 0;
            v_total_descuentos NUMBER := 0;
            v_neto             NUMBER := 0;
        BEGIN
            -- Calcular ingresos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_ingresos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'CREDITO';

            -- Calcular descuentos
            SELECT NVL(SUM(dl.MONTO),0)
            INTO v_total_descuentos
            FROM DET_LIQUIDACION dl
            JOIN CONCEPTO_SALARIAL cs ON cs.ID_CONCEPTO = dl.CON_ID_CONCEPTO
            WHERE dl.LIQ_ID_LIQUIDACION = liq.ID_LIQUIDACION
              AND cs.TIPO = 'DEBITO';

            -- Calcular neto
            v_neto := v_total_ingresos - v_total_descuentos;

            -- Actualizar cabecera
            UPDATE LIQUIDACION
            SET TOTAL_INGRESOS    = v_total_ingresos,
                TOTAL_DESCUENTOS  = v_total_descuentos,
                NETO_A_COBRAR_NUM = v_neto,
                NETO_A_COBRAR_LET = UPPER(pr_num_a_letras.DinTex(v_neto))
            WHERE ID_LIQUIDACION = liq.ID_LIQUIDACION;
        END;
    END LOOP;
END;
/
ALTER TRIGGER "TRG_DET_LIQUIDACION_AIUD" ENABLE;

  CREATE UNIQUE INDEX "SYS_IL0000108584C00001$$" ON "DET_ROL" (
  ;

  CREATE UNIQUE INDEX "PK_EMPLEADO" ON "EMPLEADO" ("ID_EMPLEADO") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMPLEADO" 
before insert on empleado 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_empleado is null then 
            cgui$cg_code_controls('SEQ_EMPLEADO', V_NEXT_VAL);

            :NEW.ID_EMPLEADO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMPLEADO" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_HISTORICO_CARGO" 
AFTER INSERT OR UPDATE OF id_cargo ON empleado
FOR EACH ROW
BEGIN
    -- Cuando se inserta un empleado nuevo
    IF INSERTING THEN
        INSERT INTO historico_cargo (
            emp_id_empleado,
            car_id_cargo,
            fecha_inicio,
            fecha_fin
        ) VALUES (
            :NEW.id_empleado,
            :NEW.id_cargo,
            current_date,
            NULL
        );

    -- Cuando se actualiza el empleado
    ELSIF UPDATING('ID_CARGO') THEN

        -- Sólo si realmente cambió el cargo
        IF :NEW.id_cargo <> :OLD.id_cargo THEN
            
            -- Cierro el registro anterior
            UPDATE historico_cargo
               SET fecha_fin = current_date
             WHERE emp_id_empleado = :OLD.id_empleado
               AND car_id_cargo   = :OLD.id_cargo
               AND fecha_fin IS NULL;

            -- Inserto el nuevo registro de histórico
            INSERT INTO historico_cargo (
                emp_id_empleado,
                car_id_cargo,
                fecha_inicio,
                fecha_fin
            ) VALUES (
                :NEW.id_empleado,
                :NEW.id_cargo,
                current_date,
                NULL
            );
        END IF;
    END IF;
END trg_historico_cargo;
/
ALTER TRIGGER "TRG_HISTORICO_CARGO" ENABLE;

  CREATE UNIQUE INDEX "EMP_CON_PK" ON "EMPLEADO_CONCEPTO" ("ID_EMP_CON") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_EMP_CON" 
before insert on empleado_concepto
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_emp_con is null then 
            cgui$cg_code_controls('SEQ_EMP_CON', V_NEXT_VAL);

            :NEW.id_emp_con := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_EMP_CON" ENABLE;

  CREATE UNIQUE INDEX "PK_HIJO" ON "HIJO" ("ID_HIJO") 
  ;
  CREATE UNIQUE INDEX "SYS_IL0000106215C00007$$" ON "HIJO" (
  ;
  CREATE UNIQUE INDEX "SYS_IL0000106215C00006$$" ON "HIJO" (
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HIJO" 
before insert on HIJO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_hijo is null then 
            cgui$cg_code_controls('SEQ_HIJO', V_NEXT_VAL);

            :NEW.ID_HIJO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HIJO" ENABLE;

  CREATE UNIQUE INDEX "PK_HISTORIAL_CARGO" ON "HISTORIAL_CARGO" ("ID_HIST_CARGO") 
  ;

  CREATE UNIQUE INDEX "HISTORICO_CARGO_PK" ON "HISTORICO_CARGO" ("ID_HISTORICO_CARGO") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_HISTORICO_CARGO" 
before insert on HISTORICO_CARGO 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.ID_HISTORICO_CARGO is null then 
            cgui$cg_code_controls('SEQ_HISTORIAL_CARGO', V_NEXT_VAL);

            :NEW.ID_HISTORICO_CARGO := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_HISTORICO_CARGO" ENABLE;

  CREATE UNIQUE INDEX "SYS_IL0000112468C00005$$" ON "JRXML_APEX2JRXML_TEMPLATES" (
  ;
  CREATE UNIQUE INDEX "SYS_IL0000112468C00004$$" ON "JRXML_APEX2JRXML_TEMPLATES" (
  ;
  CREATE UNIQUE INDEX "JAT_PK" ON "JRXML_APEX2JRXML_TEMPLATES" ("JAT_ID") 
  ;
  CREATE UNIQUE INDEX "JAT_UK" ON "JRXML_APEX2JRXML_TEMPLATES" ("JAT_TYPE", "JAT_NAME") 
  ;

  CREATE UNIQUE INDEX "SYS_IL0000112478C00004$$" ON "JRXML_FONTS" (
  ;
  CREATE UNIQUE INDEX "JRF_PK" ON "JRXML_FONTS" ("JRF_ID") 
  ;
  CREATE UNIQUE INDEX "JRF_UK" ON "JRXML_FONTS" ("JRF_NAME") 
  ;

  CREATE UNIQUE INDEX "JRL_PK" ON "JRXML_LOGGING" ("JRL_ID") 
  ;

  CREATE UNIQUE INDEX "JRN_PK" ON "JRXML_NLS_PARAMETERS" ("JRN_ID") 
  ;
  CREATE UNIQUE INDEX "JRN_UK" ON "JRXML_NLS_PARAMETERS" ("JRN_LOCALE_LANGUAGE", "JRN_LOCALE_COUNTRY") 
  ;

  CREATE UNIQUE INDEX "SYS_IL0000112459C00004$$" ON "JRXML_REPORT_DEFINITIONS" (
  ;
  CREATE UNIQUE INDEX "JRD_PK" ON "JRXML_REPORT_DEFINITIONS" ("JRD_ID") 
  ;
  CREATE UNIQUE INDEX "JRD_UK" ON "JRXML_REPORT_DEFINITIONS" ("JRD_NAME") 
  ;

  CREATE UNIQUE INDEX "SYS_IL0000112454C00005$$" ON "JRXML_REPORT_IMAGES" (
  ;
  CREATE UNIQUE INDEX "JRI_PK" ON "JRXML_REPORT_IMAGES" ("JRI_ID") 
  ;
  CREATE UNIQUE INDEX "JRI_UK" ON "JRXML_REPORT_IMAGES" ("JRI_JRD_ID", "JRI_NAME") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRI_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_report_images
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRI_ADLER32_VALID:='N';
  ELSE
    IF     :OLD.JRI_ADLER32_VALID='Y'
       AND :NEW.JRI_ADLER32_VALID='Y' THEN
      :NEW.JRI_ADLER32_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRI_RUI" ENABLE;

  CREATE UNIQUE INDEX "JRS_PK" ON "JRXML_RESOURCE_ENTRIES" ("JRS_ID") 
  ;
  CREATE UNIQUE INDEX "JRS_UK" ON "JRXML_RESOURCE_ENTRIES" ("JRS_JRR_ID", "JRS_KEY") 
  ;

  CREATE UNIQUE INDEX "SYS_IL0000112448C00005$$" ON "JRXML_RESOURCE_FILES" (
  ;
  CREATE UNIQUE INDEX "JRR_PK" ON "JRXML_RESOURCE_FILES" ("JRR_ID") 
  ;
  CREATE UNIQUE INDEX "JRR_UK" ON "JRXML_RESOURCE_FILES" ("JRR_NAME", "JRR_LOCALE") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "BTRG_JRR_RUI" 
BEFORE INSERT OR UPDATE ON jrxml_resource_files
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    :NEW.JRR_VALID:='N';
  ELSE
    IF     :OLD.JRR_VALID='Y'
       AND :NEW.JRR_VALID='Y' THEN
      :NEW.JRR_VALID:='N';
    END IF;
  END IF;
END;
/
ALTER TRIGGER "BTRG_JRR_RUI" ENABLE;

  CREATE UNIQUE INDEX "PK_LIQUIDACION" ON "LIQUIDACION" ("ID_LIQUIDACION") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_LIQUIDACION" 
before insert on LIQUIDACION 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_liquidacion is null then 
            cgui$cg_code_controls('SEQ_LIQUIDACION', V_NEXT_VAL);

            :NEW.id_liquidacion := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_LIQUIDACION" ENABLE;

  CREATE UNIQUE INDEX "PK_PERIODO_NOMINA" ON "PERIODO_NOMINA" ("ID_PERIODO") 
  ;
  CREATE UNIQUE INDEX "MES_ANHO_UK" ON "PERIODO_NOMINA" ("ANHO", "MES") 
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_PERIODO_NOMINA" 
before insert on PERIODO_NOMINA 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_periodo is null then 
            cgui$cg_code_controls('SEQ_PERIODO', V_NEXT_VAL);

            :NEW.id_periodo := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_PERIODO_NOMINA" ENABLE;

  CREATE UNIQUE INDEX "PK_PERMISOS" ON "PERMISOS" ("ID_PERMISOS") 
  ;

  CREATE UNIQUE INDEX "PK_ROL" ON "ROL" ("ID_ROL") 
  ;
  CREATE UNIQUE INDEX "SYS_IL0000105098C00003$$" ON "ROL" (
  ;

  CREATE OR REPLACE EDITIONABLE TRIGGER "TRG_BI_ROL" 
before insert on rol 
for each row
declare
    V_NEXT_VAL number;
    V_RESULT number;
begin
    if :new.id_rol is null then 
            cgui$cg_code_controls('SEQ_ROL', V_NEXT_VAL);

            :NEW.ID_ROL := V_NEXT_VAL;
    end if;
end;
/
ALTER TRIGGER "TRG_BI_ROL" ENABLE;
  CREATE OR REPLACE EDITIONABLE TRIGGER "ATIU_ROL" 
AFTER INSERT OR UPDATE ON rol
FOR EACH ROW
BEGIN
  IF if_update(:OLD.permisos, :NEW.permisos) THEN
    pr_det_rol(
      p_id_rol    => :NEW.id_rol,
      p_permisos  => :NEW.permisos
    );
  END IF;
END;
/
ALTER TRIGGER "ATIU_ROL" ENABLE;

  CREATE UNIQUE INDEX "PK_ROL_PERMISOS" ON "ROL_PERMISOS" ("ID_PERMISOS", "ID_ROL") 
  ;

  CREATE UNIQUE INDEX "PK_SALARIO_MINIMO" ON "SALARIO_MINIMO" ("ID_SALARIO_MINIMO") 
  ;

  CREATE UNIQUE INDEX "PK_USUARIO" ON "USUARIO" ("ID_USUARIO") 
  ;
  CREATE UNIQUE INDEX "UQ_USUARIO_USERNAME" ON "USUARIO" ("USERNAME") 
  ;
  CREATE UNIQUE INDEX "UQ_USUARIO_CORREO" ON "USUARIO" ("CORREO") 
  ;






































create or replace package body as_pdf3_mod
is
--
  type tHex is table of pls_integer index by VARCHAR2(2);
  lHex tHex;
  type tp_pls_tab is table of pls_integer index by pls_integer;
  type tp_objects_tab is table of number(10) index by pls_integer;
  type tp_pages_tab is table of blob index by pls_integer;
  type tp_settings is record
    ( page_width number
    , page_height number
    , margin_left number
    , margin_right number
    , margin_top number
    , margin_bottom number
    );
  type tp_settings_tab is table of tp_settings index by pls_integer;
  type tp_font is record
    ( standard boolean
    , family varchar2(100)
    , style varchar2(2)  -- N Normal
                         -- I Italic
                         -- B Bold
                         -- BI Bold Italic
    , subtype varchar2(15)
    , name varchar2(100)
    , fontname varchar2(100)
    , char_width_tab tp_pls_tab
    , encoding varchar2(100)    , charset varchar2(1000)
    , compress_font boolean := true
    , fontsize number
    , unit_norm number
    , bb_xmin pls_integer
    , bb_ymin pls_integer
    , bb_xmax pls_integer
    , bb_ymax pls_integer
    , flags pls_integer
    , first_char pls_integer
    , last_char pls_integer
    , italic_angle number
    , ascent pls_integer
    , descent pls_integer
    , capheight pls_integer
    , stemv pls_integer
    , diff varchar2(32767)
    , cid boolean := false
    , fontfile2 blob
    , ttf_offset pls_integer
    , used_chars tp_pls_tab
    , numGlyphs pls_integer
    , indexToLocFormat pls_integer
    , loca tp_pls_tab
    , code2glyph tp_pls_tab
    , hmetrics tp_pls_tab
    );
  type tp_font_tab is table of tp_font index by pls_integer;
  type tp_img is record
    ( adler32 varchar2(8)
    , width pls_integer
    , height pls_integer
    , color_res pls_integer
    , color_tab raw(768)
    , greyscale boolean
    , pixels blob
    , type varchar2(5)
    , nr_colors pls_integer
    , transparancy_index pls_integer
    );
  type tp_img_tab is table of tp_img index by pls_integer;
  type tp_info is record
    ( title varchar2(1024)
    , author varchar2(1024)
    , subject varchar2(1024)
    , keywords varchar2(32767)
    );
  type tp_page_prcs is table of clob index by pls_integer;
--
-- globals
  g_pdf_doc blob; -- the PDF-document being constructed
  g_objects tp_objects_tab;
  g_pages tp_pages_tab;
  g_settings_per_page tp_settings_tab;
  g_settings tp_settings;
  g_fonts tp_font_tab;
  g_used_fonts tp_pls_tab;
  g_current_font pls_integer;
  g_current_font_record tp_font;
  g_images tp_img_tab;
  g_x number;  -- current x-location of the "cursor"
  g_y number;  -- current y-location of the "cursor"
  g_info tp_info;
  g_page_nr pls_integer;
  g_page_prcs tp_page_prcs;
--
-- constants
  c_nl constant varchar2(2) := chr(13) || chr(10);
--
  function num2raw( p_value number )
  return raw
  is
  begin
    return hextoraw( to_char( p_value, 'FM0XXXXXXX' ) );
  end;
--
  function raw2num( p_value raw )
  return number
  is
  begin
    return to_number( rawtohex( p_value ), 'XXXXXXXX' );
  end;
--
  function raw2num( p_value raw, p_pos pls_integer, p_len pls_integer )
  return pls_integer
  is
  begin
    return to_number( rawtohex( utl_raw.substr( p_value, p_pos, p_len ) ), 'XXXXXXXX' );
  end;
--
  function to_short( p_val raw, p_factor number := 1 )
  return number
  is
    t_rv number;
  begin
    t_rv := to_number( rawtohex( p_val ), 'XXXXXXXXXX' );
    if t_rv > 32767
    then
      t_rv := t_rv - 65536;
    end if;
    return t_rv * p_factor;
  end;
--
  function blob2num( p_blob blob, p_len integer, p_pos integer )
  return number
  is
  begin
    return to_number( rawtohex( dbms_lob.substr( p_blob, p_len, p_pos ) ), 'xxxxxxxx' );
  end;
--
  function file2blob( p_dir varchar2, p_file_name varchar2 )
  return blob
  is
    t_raw raw(32767);
    t_blob blob;
    fh utl_file.file_type;
  begin
    fh := utl_file.fopen( p_dir, p_file_name, 'rb' );
    dbms_lob.createtemporary( t_blob, true );
    loop
      begin
        utl_file.get_raw( fh, t_raw );
        dbms_lob.append( t_blob, t_raw );
      exception
        when no_data_found
        then
          exit;
      end;
    end loop;
    utl_file.fclose( fh );
    return t_blob;
  exception
    when others
    then
      if utl_file.is_open( fh )
      then
        utl_file.fclose( fh );
      end if;
      raise;
  end;
--
  procedure init_core_fonts
  is
    function uncompress_withs( p_compressed_tab varchar2 )
    return tp_pls_tab
    is
      t_rv tp_pls_tab;
      t_tmp raw(32767);
    begin
      if p_compressed_tab is not null
      then
        t_tmp := utl_compress.lz_uncompress
          ( utl_encode.base64_decode( utl_raw.cast_to_raw( p_compressed_tab ) ) );
        for i in 0 .. 255
        loop
          t_rv( i ) := to_number( utl_raw.substr( t_tmp, i * 4 + 1, 4 ), '0xxxxxxx' );
        end loop;
      end if;
      return t_rv;
    end;
--
    procedure init_core_font
      ( p_ind pls_integer
      , p_family varchar2
      , p_style varchar2
      , p_name varchar2
      , p_compressed_tab varchar2
      )
    is
    begin
      g_fonts( p_ind ).family := p_family;
      g_fonts( p_ind ).style := p_style;
      g_fonts( p_ind ).name := p_name;
      g_fonts( p_ind ).fontname := p_name;
      g_fonts( p_ind ).standard := true;
      g_fonts( p_ind ).encoding := 'WE8MSWIN1252';
      g_fonts( p_ind ).charset := sys_context( 'userenv', 'LANGUAGE' );
      g_fonts( p_ind ).charset := substr( g_fonts( p_ind ).charset
                                        , 1
                                        , instr( g_fonts( p_ind ).charset, '.' )
                                        ) || g_fonts( p_ind ).encoding;
      g_fonts( p_ind ).char_width_tab := uncompress_withs( p_compressed_tab );
    end;
  begin
    init_core_font( 1, 'helvetica', 'N', 'Helvetica'
      ,  'H4sIAAAAAAAAC81Tuw3CMBC94FQMgMQOLAGVGzNCGtc0dAxAT+8lsgE7RKJFomOA'
      || 'SLT4frHjBEFJ8XSX87372C8A1Qr+Ax5gsWGYU7QBAK4x7gTnGLOS6xJPOd8w5NsM'
      || '2OvFvQidAP04j1nyN3F7iSNny3E6DylPeeqbNqvti31vMpfLZuzH86oPdwaeo6X+'
      || '5X6Oz5VHtTqJKfYRNVu6y0ZyG66rdcxzXJe+Q/KJ59kql+bTt5K6lKucXvxWeHKf'
      || '+p6Tfersfh7RHuXMZjHsdUkxBeWtM60gDjLTLoHeKsyDdu6m8VK3qhnUQAmca9BG'
      || 'Dq3nP+sV/4FcD6WOf9K/ne+hdav+DTuNLeYABAAA' );
--
    init_core_font( 2, 'helvetica', 'I', 'Helvetica-Oblique'
      ,  'H4sIAAAAAAAAC81Tuw3CMBC94FQMgMQOLAGVGzNCGtc0dAxAT+8lsgE7RKJFomOA'
      || 'SLT4frHjBEFJ8XSX87372C8A1Qr+Ax5gsWGYU7QBAK4x7gTnGLOS6xJPOd8w5NsM'
      || '2OvFvQidAP04j1nyN3F7iSNny3E6DylPeeqbNqvti31vMpfLZuzH86oPdwaeo6X+'
      || '5X6Oz5VHtTqJKfYRNVu6y0ZyG66rdcxzXJe+Q/KJ59kql+bTt5K6lKucXvxWeHKf'
      || '+p6Tfersfh7RHuXMZjHsdUkxBeWtM60gDjLTLoHeKsyDdu6m8VK3qhnUQAmca9BG'
      || 'Dq3nP+sV/4FcD6WOf9K/ne+hdav+DTuNLeYABAAA' );
--
    init_core_font( 3, 'helvetica', 'B', 'Helvetica-Bold'
      ,  'H4sIAAAAAAAAC8VSsRHCMAx0SJcBcgyRJaBKkxXSqKahYwB6+iyRTbhLSUdHRZUB'
      || 'sOWXLF8SKCn+ZL/0kizZuaJ2/0fn8XBu10SUF28n59wbvoCr51oTD61ofkHyhBwK'
      || '8rXusVaGAb4q3rXOBP4Qz+wfUpzo5FyO4MBr39IH+uLclFvmCTrz1mB5PpSD52N1'
      || 'DfqS988xptibWfbw9Sa/jytf+dz4PqQz6wi63uxxBpCXY7uUj88jNDNy1mYGdl97'
      || '856nt2f4WsOFed4SpzumNCvlT+jpmKC7WgH3PJn9DaZfA42vlgh96d+wkHy0/V95'
      || 'xyv8oj59QbvBN2I/iAuqEAAEAAA=' );
--
    init_core_font( 4, 'helvetica', 'BI', 'Helvetica-BoldOblique'
      ,  'H4sIAAAAAAAAC8VSsRHCMAx0SJcBcgyRJaBKkxXSqKahYwB6+iyRTbhLSUdHRZUB'
      || 'sOWXLF8SKCn+ZL/0kizZuaJ2/0fn8XBu10SUF28n59wbvoCr51oTD61ofkHyhBwK'
      || '8rXusVaGAb4q3rXOBP4Qz+wfUpzo5FyO4MBr39IH+uLclFvmCTrz1mB5PpSD52N1'
      || 'DfqS988xptibWfbw9Sa/jytf+dz4PqQz6wi63uxxBpCXY7uUj88jNDNy1mYGdl97'
      || '856nt2f4WsOFed4SpzumNCvlT+jpmKC7WgH3PJn9DaZfA42vlgh96d+wkHy0/V95'
      || 'xyv8oj59QbvBN2I/iAuqEAAEAAA=' );
--
    init_core_font( 5, 'times', 'N', 'Times-Roman'
      ,  'H4sIAAAAAAAAC8WSKxLCQAyG+3Bopo4bVHbwHGCvUNNT9AB4JEwvgUBimUF3wCNR'
      || 'qAoGRZL9twlQikR8kzTvZBtF0SP6O7Ej1kTnSRfEhHw7+Jy3J4XGi8w05yeZh2sE'
      || '4j312ZDeEg1gvSJy6C36L9WX1urr4xrolfrSrYmrUCeDPGMu5+cQ3Ur3OXvQ+TYf'
      || '+2FGexOZvTM1L3S3o5fJjGQJX2n68U2ur3X5m3cTvfbxsk9pcsMee60rdTjnhNkc'
      || 'Zip9HOv9+7/tI3Oif3InOdV/oLdx3gq2HIRaB1Ob7XPk35QwwxDyxg3e09Dv6nSf'
      || 'rxQjvty8ywDce9CXvdF9R+4y4o+7J1P/I9sABAAA' );
--
    init_core_font( 6, 'times', 'I', 'Times-Italic'
      ,  'H4sIAAAAAAAAC8WSPQ6CQBCFF+i01NB5g63tPcBegYZTeAB6SxNLjLUH4BTEeAYr'
      || 'Kwpj5ezsW2YgoKXFl2Hnb9+wY4x5m7+TOOJMdIFsRywodkfMBX9aSz7bXGp+gj6+'
      || 'R4TvOtJ3CU5Eq85tgGsbxG3QN8iFZY1WzpxXwkckFTR7e1G6osZGWT1bDuBnTeP5'
      || 'KtW/E71c0yB2IFbBphuyBXIL9Y/9fPvhf8se6vsa8nmeQtU6NSf6ch9fc8P9DpqK'
      || 'cPa5/I7VxDwruTN9kV3LDvQ+h1m8z4I4x9LIbnn/Fv6nwOdyGq+d33jk7/cxztyq'
      || 'XRhTz/it7Mscg7fT5CO+9ahnYk20Hww5IrwABAAA' );
--
    init_core_font( 7, 'times', 'B', 'Times-Bold'
      , 'H4sIAAAAAAAAC8VSuw3CQAy9XBqUAVKxAZkgHQUNEiukySxpqOjTMQEDZIrUDICE'
      || 'RHUVVfy9c0IQJcWTfbafv+ece7u/Izs553cgAyN/APagl+wjgN3XKZ5kmTg/IXkw'
      || 'h4JqXUEfAb1I1VvwFYysk9iCffmN4+gtccSr5nlwDpuTepCZ/MH0FZibDUnO7MoR'
      || 'HXdDuvgjpzNxgevG+dF/hr3dWfoNyEZ8Taqn+7d7ozmqpGM8zdMYruFrXopVjvY2'
      || 'in9gXe+5vBf1KfX9E6TOVBsb8i5iqwQyv9+a3Gg/Cv+VoDtaQ7xdPwfNYRDji09g'
      || 'X/FvLNGmO62B9jSsoFwgfM+jf1z/SPwrkTMBOkCTBQAEAAA=' );
--
    init_core_font( 8, 'times', 'BI', 'Times-BoldItalic'
      ,  'H4sIAAAAAAAAC8WSuw2DMBCGHegYwEuECajIAGwQ0TBFBnCfPktkAKagzgCRIqWi'
      || 'oso9fr+Qo5RB+nT2ve+wMWYzf+fgjKmOJFelPhENnS0xANJXHfwHSBtjfoI8nMMj'
      || 'tXo63xKW/Cx9ONRn3US6C/wWvYeYNr+LH2IY6cHGPkJfvsc5kX7mFjF+Vqs9iT6d'
      || 'zwEL26y1Qz62nWlvD5VSf4R9zPuon/ne+C45+XxXf5lnTGLTOZCXPx8v9Qfdjdid'
      || '5vD/f/+/pE/Ur14kG+xjTHRc84pZWsC2Hjk2+Hgbx78j4Z8W4DlL+rBnEN5Bie6L'
      || 'fsL+1u/InuYCdsdaeAs+RxftKfGdfQDlDF/kAAQAAA==' );
--
    init_core_font( 9, 'courier', 'N', 'Courier', null );
    for i in 0 .. 255
    loop
      g_fonts( 9 ).char_width_tab( i ) := 600;
    end loop;
--
    init_core_font( 10, 'courier', 'I', 'Courier-Oblique', null );
    g_fonts( 10 ).char_width_tab := g_fonts( 9 ).char_width_tab;
--
    init_core_font( 11, 'courier', 'B', 'Courier-Bold', null );
    g_fonts( 11 ).char_width_tab := g_fonts( 9 ).char_width_tab;
--
    init_core_font( 12, 'courier', 'BI', 'Courier-BoldOblique', null );
    g_fonts( 12 ).char_width_tab := g_fonts( 9 ).char_width_tab;
--
    init_core_font( 13, 'symbol', 'N', 'Symbol'
      ,  'H4sIAAAAAAAAC82SIU8DQRCFZ28xIE+cqcbha4tENKk/gQCJJ6AweIK9H1CHqKnp'
      || 'D2gTFBaDIcFwCQkJSTG83fem7SU0qYNLvry5nZ25t7NnZkv7c8LQrFhAP6GHZvEY'
      || 'HOB9ylxGubTfNVRc34mKpFonzBQ/gUZ6Ds7AN6i5lv1dKv8Ab1eKQYSV4hUcgZFq'
      || 'J/Sec7fQHtdTn3iqfvdrb7m3e2pZW+xDG3oIJ/Li3gfMr949rlU74DyT1/AuTX1f'
      || 'YGhOzTP8B0/RggsEX/I03vgXPrrslZjfM8/pGu40t2ZjHgud97F7337mXP/GO4h9'
      || '3WmPPaOJ/jrOs9yC52MlrtUzfWupfTX51X/L+13Vl/J/s4W2S3pSfSh5DmeXerMf'
      || '+LXhWQAEAAA=' );
--
    init_core_font( 14, 'zapfdingbats', 'N', 'ZapfDingbats'
      ,  'H4sIAAAAAAAAC83ROy9EQRjG8TkzjdJl163SSHR0EpdsVkSi2UahFhUljUKUIgoq'
      || 'CrvJCtFQyG6EbSSERGxhC0ofQAQFxbIi8T/7PoUPIOEkvzxzzsycdy7O/fUTtToX'
      || 'bnCuvHPOV8gk4r423ovkGQ5od5OTWMeesmBz/RuZIWv4wCAY4z/xjipeqflC9qAD'
      || 'aRwxrxkJievSFzrRh36tZ1zttL6nkGX+A27xrLnttE/IBji9x7UvcIl9nPJ9AL36'
      || 'd1L9hyihoDW10L62cwhNyhntryZVExYl3kMj+zym+CrJv6M8VozPmfr5L8uwJORL'
      || 'tox7NFHG/Obj79FlwhqZ1X292xn6CbAXP/fjjv6rJYyBtUdl1vxEO6fcRB7bMmJ3'
      || 'GYZsTN0GdrDL/Ao5j1GZNr5kwqydX5z1syoiYEq5gCtlSrXi+mVbi3PfVAuhoQAE'
      || 'AAA=' );
--
  end;
--
  function to_char_round
    ( p_value number
    , p_precision pls_integer := 2
    )
  return varchar2
  is
  begin
    return to_char( round( p_value, p_precision ), 'TM9', 'NLS_NUMERIC_CHARACTERS=.,' );
  end;
--
  procedure raw2pdfdoc( p_raw blob )
  is
  begin
    dbms_lob.append( g_pdf_doc, p_raw );
  end;
--
  procedure txt2pdfdoc( p_txt varchar2 )
  is
  begin
    raw2pdfdoc( utl_raw.cast_to_raw( p_txt || c_nl ) );
  end;
--
  function add_object( p_txt varchar2 := null )
  return number
  is
    t_self number(10);
  begin
    t_self := g_objects.count( );
    g_objects( t_self ) := dbms_lob.getlength( g_pdf_doc );
--
    if p_txt is null
    then
      txt2pdfdoc( t_self || ' 0 obj' );
    else
      txt2pdfdoc( t_self || ' 0 obj' || c_nl || '<<' || p_txt || '>>' || c_nl || 'endobj' );
    end if;
--
    return t_self;
  end;
--
  procedure add_object( p_txt varchar2 := null )
  is
    t_dummy number(10) := add_object( p_txt );
  begin
    null;
  end;
--
  function adler32( p_src in blob )
  return varchar2
  is
    s1 pls_integer := 1;
    s2 pls_integer := 0;
    n  pls_integer;
    step_size number;
    tmp varchar2(32766);
    c65521 constant pls_integer := 65521;
  begin
    step_size := trunc( 16383 / dbms_lob.getchunksize( p_src ) ) * dbms_lob.getchunksize( p_src );

    if step_size = 0 THEN
      step_size := 1;
    end if;


    for j in 0 .. trunc( ( dbms_lob.getlength( p_src ) - 1 ) / step_size )
    loop
      tmp := rawtohex( dbms_lob.substr( p_src, step_size, j * step_size + 1 ) );
      for i in 1 .. length( tmp ) / 2
      loop
        n:=lHex(substr( tmp, i * 2 - 1, 2 ));--n := to_number( substr( tmp, i * 2 - 1, 2 ), 'xx' );
        s1 := s1 + n;
        if s1 >= c65521
        then
          s1 := s1 - c65521;
        end if;
        s2 := s2 + s1;
        if s2 >= c65521
        then
          s2 := s2 - c65521;
        end if;
      end loop;
    end loop;
    return to_char( s2, 'fm0XXX' ) || to_char( s1, 'fm0XXX' );
  end;
--
  function flate_encode( p_val blob )
  return blob
  is
    t_blob blob;
  begin
    t_blob := hextoraw( '789C' );
    dbms_lob.copy( t_blob
                 , utl_compress.lz_compress( p_val )
                 , dbms_lob.lobmaxsize
                 , 3
                 , 11
                 );
    dbms_lob.trim( t_blob, dbms_lob.getlength( t_blob ) - 8 );
    dbms_lob.append( t_blob, hextoraw( adler32( p_val ) ) );
    return t_blob;
  end;
--
  procedure put_stream
    ( p_stream blob
    , p_compress boolean := true
    , p_extra varchar2 := ''
    , p_tag boolean := true
    )
  is
    t_blob blob;
    t_compress boolean := false;
  begin
    if p_compress and nvl( dbms_lob.getlength( p_stream ), 0 ) > 0
    then
      t_compress := true;
      t_blob := flate_encode( p_stream );
    else
      t_blob := p_stream;
    end if;
    txt2pdfdoc( case when p_tag then '<<' end
                || case when t_compress then '/Filter /FlateDecode ' end
                || '/Length ' || nvl( length( t_blob ), 0 )
                || p_extra
                || '>>' );
    txt2pdfdoc( 'stream' );
    raw2pdfdoc( t_blob );
    txt2pdfdoc( 'endstream' );
    if dbms_lob.istemporary( t_blob ) = 1
    then
      dbms_lob.freetemporary( t_blob );
    end if;
  end;
--
  function add_stream
    ( p_stream blob
    , p_extra varchar2 := ''
    , p_compress boolean := true
    )
  return number
  is
    t_self number(10);
  begin
    t_self := add_object;
    put_stream( p_stream
              , p_compress
              , p_extra
              );
    txt2pdfdoc( 'endobj' );
    return t_self;
  end;
--
  function subset_font( p_index pls_integer )
  return blob
  is
    t_tmp blob;
    t_header blob;
    t_tables blob;
    t_len pls_integer;
    t_code pls_integer;
    t_glyph pls_integer;
    t_offset pls_integer;
    t_factor pls_integer;
    t_unicode pls_integer;
    t_used_glyphs tp_pls_tab;
    t_fmt varchar2(10);
    t_utf16_charset varchar2(1000);
    t_raw raw(32767);
    t_v varchar2(32767);
    t_table_records raw(32767);
  begin
    if g_fonts( p_index ).cid
    then
      t_used_glyphs := g_fonts( p_index ).used_chars;
      t_used_glyphs( 0 ) := 0;
    else
      t_utf16_charset := substr( g_fonts( p_index ).charset, 1, instr( g_fonts( p_index ).charset, '.' ) ) || 'AL16UTF16';
      t_used_glyphs( 0 ) := 0;
      t_code := g_fonts( p_index ).used_chars.first;
      while t_code is not null
      loop
        t_unicode := to_number( rawtohex( utl_raw.convert( hextoraw( to_char( t_code, 'fm0x' ) )
                                                                    , t_utf16_charset
                                                                    , g_fonts( p_index ).charset  -- ???? database characterset ?????
                                                                    )
                                        ), 'XXXXXXXX' );
        if g_fonts( p_index ).flags = 4 -- a symbolic font
        then
-- assume code 32, space maps to the first code from the font
          t_used_glyphs( g_fonts( p_index ).code2glyph( g_fonts( p_index ).code2glyph.first + t_unicode - 32 ) ) := 0;
        else
          t_used_glyphs( g_fonts( p_index ).code2glyph( t_unicode ) ) := 0;
        end if;
        t_code := g_fonts( p_index ).used_chars.next( t_code );
      end loop;
    end if;
--
    dbms_lob.createtemporary( t_tables, true );
    t_header := utl_raw.concat( hextoraw( '00010000' )
                              , dbms_lob.substr( g_fonts( p_index ).fontfile2, 8, g_fonts( p_index ).ttf_offset + 4 )
                              );
    t_offset := 12 + blob2num( g_fonts( p_index ).fontfile2, 2, g_fonts( p_index ).ttf_offset + 4 ) * 16;
    t_table_records := dbms_lob.substr( g_fonts( p_index ).fontfile2
                                      , blob2num( g_fonts( p_index ).fontfile2, 2, g_fonts( p_index ).ttf_offset + 4 ) * 16
                                      , g_fonts( p_index ).ttf_offset + 12
                                      );
    for i in 1 .. blob2num( g_fonts( p_index ).fontfile2, 2, g_fonts( p_index ).ttf_offset + 4 )
    loop
      case utl_raw.cast_to_varchar2( utl_raw.substr( t_table_records, i * 16 - 15, 4 ) )
        when 'post'
        then
          dbms_lob.append( t_header
                         , utl_raw.concat( utl_raw.substr( t_table_records, i * 16 - 15, 4 ) -- tag
                                         , hextoraw( '00000000' ) -- checksum
                                         , num2raw( t_offset + dbms_lob.getlength( t_tables ) ) -- offset
                                         , num2raw( 32 ) -- length
                                         )
                         );
          dbms_lob.append( t_tables
                         , utl_raw.concat( hextoraw( '00030000' )
                                         , dbms_lob.substr( g_fonts( p_index ).fontfile2
                                                          , 28
                                                          , raw2num( t_table_records, i * 16 - 7, 4 ) + 5
                                                          )
                                         )
                         );
        when 'loca'
        then
          if g_fonts( p_index ).indexToLocFormat = 0
          then
            t_fmt := 'fm0XXX';
          else
            t_fmt := 'fm0XXXXXXX';
          end if;
          t_raw := null;
          dbms_lob.createtemporary( t_tmp, true );
          t_len := 0;
          for g in 0 .. g_fonts( p_index ).numGlyphs - 1
          loop
            t_raw := utl_raw.concat( t_raw, hextoraw( to_char( t_len, t_fmt ) ) );
            if utl_raw.length( t_raw ) > 32770
            then
              dbms_lob.append( t_tmp, t_raw );
              t_raw := null;
            end if;
            if t_used_glyphs.exists( g )
            then
              t_len := t_len + g_fonts( p_index ).loca( g + 1 ) - g_fonts( p_index ).loca( g );
            end if;
          end loop;
          t_raw := utl_raw.concat( t_raw, hextoraw( to_char( t_len, t_fmt ) ) );
          dbms_lob.append( t_tmp, t_raw );
          dbms_lob.append( t_header
                         , utl_raw.concat( utl_raw.substr( t_table_records, i * 16 - 15, 4 ) -- tag
                                         , hextoraw( '00000000' ) -- checksum
                                         , num2raw( t_offset + dbms_lob.getlength( t_tables ) ) -- offset
                                         , num2raw( dbms_lob.getlength( t_tmp ) ) -- length
                                         )
                         );
          dbms_lob.append( t_tables, t_tmp );
          dbms_lob.freetemporary( t_tmp );
        when 'glyf'
        then
          if g_fonts( p_index ).indexToLocFormat = 0
          then
            t_factor := 2;
          else
            t_factor := 1;
          end if;
          t_raw := null;
          dbms_lob.createtemporary( t_tmp, true );
          for g in 0 .. g_fonts( p_index ).numGlyphs - 1
          loop
            if (   t_used_glyphs.exists( g )
               and g_fonts( p_index ).loca( g + 1 ) > g_fonts( p_index ).loca( g )
               )
            then
              t_raw := utl_raw.concat( t_raw
                                     , dbms_lob.substr( g_fonts( p_index ).fontfile2
                                                      , ( g_fonts( p_index ).loca( g + 1 ) - g_fonts( p_index ).loca( g ) ) * t_factor
                                                      , g_fonts( p_index ).loca( g ) * t_factor + raw2num( t_table_records, i * 16 - 7, 4 ) + 1
                                                      )
                                     );
              if utl_raw.length( t_raw ) > 32000
              then
                dbms_lob.append( t_tmp, t_raw );
                t_raw := null;
              end if;
            end if;
          end loop;
          if utl_raw.length( t_raw ) > 0
          then
            dbms_lob.append( t_tmp, t_raw );
          end if;
          dbms_lob.append( t_header
                         , utl_raw.concat( utl_raw.substr( t_table_records, i * 16 - 15, 4 ) -- tag
                                         , hextoraw( '00000000' ) -- checksum
                                         , num2raw( t_offset + dbms_lob.getlength( t_tables ) ) -- offset
                                         , num2raw( dbms_lob.getlength( t_tmp ) ) -- length
                                         )
                         );
          dbms_lob.append( t_tables, t_tmp );
          dbms_lob.freetemporary( t_tmp );
        else
          dbms_lob.append( t_header
                         , utl_raw.concat( utl_raw.substr( t_table_records, i * 16 - 15, 4 )    -- tag
                                         , utl_raw.substr( t_table_records, i * 16 - 11, 4 )    -- checksum
                                         , num2raw( t_offset + dbms_lob.getlength( t_tables ) ) -- offset
                                         , utl_raw.substr( t_table_records, i * 16 - 3, 4 )     -- length
                                         )
                         );
          dbms_lob.copy( t_tables
                       , g_fonts( p_index ).fontfile2
                       , raw2num( t_table_records, i * 16 - 3, 4 )
                       , dbms_lob.getlength( t_tables ) + 1
                       , raw2num( t_table_records, i * 16 - 7, 4 ) + 1
                       );
      end case;
    end loop;
    dbms_lob.append( t_header, t_tables );
    dbms_lob.freetemporary( t_tables );
    return t_header;
  end;
--
  function add_font( p_index pls_integer )
  return number
  is
    t_self number(10);
    t_fontfile number(10);
    t_font_subset blob;
    t_used pls_integer;
    t_used_glyphs tp_pls_tab;
    t_w varchar2(32767);
    t_unicode pls_integer;
    t_utf16_charset varchar2(1000);
    t_width number;
  begin
    if g_fonts( p_index ).standard
    then
      return add_object( '/Type/Font'
                       || '/Subtype/Type1'
                       || '/BaseFont/' || g_fonts( p_index ).name
                       || '/Encoding/WinAnsiEncoding' -- code page 1252
                       );
    end if;
--
    if g_fonts( p_index ).cid
    then
      t_self := add_object;
      txt2pdfdoc( '<</Type/Font/Subtype/Type0/Encoding/Identity-H'
                || '/BaseFont/' || g_fonts( p_index ).name
                || '/DescendantFonts ' || to_char( t_self + 1 ) || ' 0 R'
                || '/ToUnicode ' || to_char( t_self + 8 ) || ' 0 R'
                || '>>' );
      txt2pdfdoc( 'endobj' );
      add_object;
      txt2pdfdoc( '[' || to_char( t_self + 2 ) || ' 0 R]' );
      txt2pdfdoc( 'endobj' );
      add_object( '/Type/Font/Subtype/CIDFontType2/CIDToGIDMap/Identity/DW 1000'
                || '/BaseFont/' || g_fonts( p_index ).name
                || '/CIDSystemInfo ' || to_char( t_self + 3 ) || ' 0 R'
                || '/W ' || to_char( t_self + 4 ) || ' 0 R'
                || '/FontDescriptor ' || to_char( t_self + 5 ) || ' 0 R' );
      add_object( '/Ordering(Identity) /Registry(Adobe) /Supplement 0' );
--
      t_utf16_charset := substr( g_fonts( p_index ).charset, 1, instr( g_fonts( p_index ).charset, '.' ) ) || 'AL16UTF16';
      t_used_glyphs := g_fonts( p_index ).used_chars;
      t_used_glyphs( 0 ) := 0;
      t_used := t_used_glyphs.first();
      while t_used is not null
      loop
        if g_fonts( p_index ).hmetrics.exists( t_used )
        then
          t_width := g_fonts( p_index ).hmetrics( t_used );
        else
          t_width := g_fonts( p_index ).hmetrics( g_fonts( p_index ).hmetrics.last() );
        end if;
        t_width := trunc( t_width * g_fonts( p_index ).unit_norm );
        if t_used_glyphs.prior( t_used ) = t_used - 1
        then
          t_w := t_w || ' ' || t_width;
        else
          t_w := t_w || '] ' || t_used || ' [' || t_width;
        end if;
        t_used := t_used_glyphs.next( t_used );
      end loop;
      t_w := '[' || ltrim( t_w, '] ' ) || ']]';
      add_object;
      txt2pdfdoc( t_w );
      txt2pdfdoc( 'endobj' );
      add_object
        (    '/Type/FontDescriptor'
          || '/FontName/' || g_fonts( p_index ).name
          || '/Flags ' || g_fonts( p_index ).flags
          || '/FontBBox [' || g_fonts( p_index ).bb_xmin
          || ' ' || g_fonts( p_index ).bb_ymin
          || ' ' || g_fonts( p_index ).bb_xmax
          || ' ' || g_fonts( p_index ).bb_ymax
          || ']'
          || '/ItalicAngle ' || to_char_round( g_fonts( p_index ).italic_angle )
          || '/Ascent ' || g_fonts( p_index ).ascent
          || '/Descent ' || g_fonts( p_index ).descent
          || '/CapHeight ' || g_fonts( p_index ).capheight
          || '/StemV ' || g_fonts( p_index ).stemv
          || '/FontFile2 ' || to_char( t_self + 6 ) || ' 0 R' );
      t_fontfile := add_stream( g_fonts( p_index ).fontfile2
                              , '/Length1 ' || dbms_lob.getlength( g_fonts( p_index ).fontfile2 )
                              , g_fonts( p_index ).compress_font
                              );
      t_font_subset := subset_font( p_index );
      t_fontfile := add_stream( t_font_subset
                              , '/Length1 ' || dbms_lob.getlength( t_font_subset )
                              , g_fonts( p_index ).compress_font
                              );
      declare
        t_g2c tp_pls_tab;
        t_code     pls_integer;
        t_c_start  pls_integer;
        t_map varchar2(32767);
        t_cmap varchar2(32767);
        t_cor pls_integer;
        t_cnt pls_integer;
      begin
        t_code := g_fonts( p_index ).code2glyph.first;
        if g_fonts( p_index ).flags = 4 -- a symbolic font
        then
-- assume code 32, space maps to the first code from the font
          t_cor := t_code - 32;
        else
          t_cor := 0;
        end if;
        while t_code is not null
        loop
          t_g2c( g_fonts( p_index ).code2glyph( t_code ) ) := t_code - t_cor;
          t_code := g_fonts( p_index ).code2glyph.next( t_code );
        end loop;
        t_cnt := 0;
        t_used_glyphs := g_fonts( p_index ).used_chars;
        t_used := t_used_glyphs.first();
        while t_used is not null
        loop
          t_map := t_map || '<' || to_char( t_used, 'FM0XXX' )
                 || '> <' || to_char( t_g2c( t_used ), 'FM0XXX' )
                 || '>' || chr( 10 );
          if t_cnt = 99
          then
            t_cnt := 0;
            t_cmap := t_cmap || chr( 10 ) || '100 beginbfchar' || chr( 10 ) || t_map || 'endbfchar';
            t_map := '';
          else
            t_cnt := t_cnt + 1;
          end if;
          t_used := t_used_glyphs.next( t_used );
        end loop;
        if t_cnt > 0
        then
          t_cmap := t_cnt || ' beginbfchar' || chr( 10 ) || t_map || 'endbfchar';
        end if;
        t_fontfile := add_stream( utl_raw.cast_to_raw(
'/CIDInit /ProcSet findresource begin 12 dict begin
begincmap
/CIDSystemInfo
<< /Registry (Adobe) /Ordering (UCS) /Supplement 0 >> def
/CMapName /Adobe-Identity-UCS def /CMapType 2 def
1 begincodespacerange
<0000> <FFFF>
endcodespacerange
' || t_cmap || '
endcmap
CMapName currentdict /CMap defineresource pop
end
end' ) );
      end;
      return t_self;
    end if;
--
    g_fonts( p_index ).first_char := g_fonts( p_index ).used_chars.first();
    g_fonts( p_index ).last_char := g_fonts( p_index ).used_chars.last();
    t_self := add_object;
    txt2pdfdoc( '<</Type /Font '
              || '/Subtype /' || g_fonts( p_index ).subtype
              || ' /BaseFont /' || g_fonts( p_index ).name
              || ' /FirstChar ' || g_fonts( p_index ).first_char
              || ' /LastChar ' || g_fonts( p_index ).last_char
              || ' /Widths ' || to_char( t_self + 1 ) || ' 0 R'
              || ' /FontDescriptor ' || to_char( t_self + 2 ) || ' 0 R'
              || ' /Encoding ' || to_char( t_self + 3 ) || ' 0 R'
              || ' >>' );
    txt2pdfdoc( 'endobj' );
    add_object;
    txt2pdfdoc( '[' );
      begin
        for i in g_fonts( p_index ).first_char .. g_fonts( p_index ).last_char
        loop
          txt2pdfdoc( g_fonts( p_index ).char_width_tab( i ) );
        end loop;
      exception
        when others
        then
          dbms_output.put_line( '**** ' || g_fonts( p_index ).name );
      end;
      txt2pdfdoc( ']' );
      txt2pdfdoc( 'endobj' );
      add_object
        (    '/Type /FontDescriptor'
          || ' /FontName /' || g_fonts( p_index ).name
          || ' /Flags ' || g_fonts( p_index ).flags
          || ' /FontBBox [' || g_fonts( p_index ).bb_xmin
          || ' ' || g_fonts( p_index ).bb_ymin
          || ' ' || g_fonts( p_index ).bb_xmax
          || ' ' || g_fonts( p_index ).bb_ymax
          || ']'
          || ' /ItalicAngle ' || to_char_round( g_fonts( p_index ).italic_angle )
          || ' /Ascent ' || g_fonts( p_index ).ascent
          || ' /Descent ' || g_fonts( p_index ).descent
          || ' /CapHeight ' || g_fonts( p_index ).capheight
          || ' /StemV ' || g_fonts( p_index ).stemv
          || case
               when g_fonts( p_index ).fontfile2 is not null
                 then ' /FontFile2 ' || to_char( t_self + 4 ) || ' 0 R'
             end );
      add_object(    '/Type /Encoding /BaseEncoding /WinAnsiEncoding '
                         || g_fonts( p_index ).diff
                         || ' ' );
      if g_fonts( p_index ).fontfile2 is not null
      then
        t_font_subset := subset_font( p_index );
        t_fontfile :=
          add_stream( t_font_subset
                    , '/Length1 ' || dbms_lob.getlength( t_font_subset )
                    , g_fonts( p_index ).compress_font
                    );
    end if;
    return t_self;
  end;
--
  procedure add_image( p_img tp_img )
  is
    t_pallet number(10);
  begin
    if p_img.color_tab is not null
    then
      t_pallet := add_stream( p_img.color_tab );
    else
      t_pallet := add_object;  -- add an empty object
      txt2pdfdoc( 'endobj' );
    end if;
    add_object;
    txt2pdfdoc( '<</Type /XObject /Subtype /Image'
              ||  ' /Width ' || to_char( p_img.width )
              || ' /Height ' || to_char( p_img.height )
              || ' /BitsPerComponent ' || to_char( p_img.color_res )
              );
--
    if p_img.transparancy_index is not null
    then
      txt2pdfdoc( '/Mask [' || p_img.transparancy_index || ' ' || p_img.transparancy_index || ']' );
    end if;
    if p_img.color_tab is null
    then
      if p_img.greyscale
      then
        txt2pdfdoc( '/ColorSpace /DeviceGray' );
      else
        txt2pdfdoc( '/ColorSpace /DeviceRGB' );
      end if;
    else
      txt2pdfdoc(    '/ColorSpace [/Indexed /DeviceRGB '
                || to_char( utl_raw.length( p_img.color_tab ) / 3 - 1 )
                || ' ' || to_char( t_pallet ) || ' 0 R]'
                );
    end if;
--
    if p_img.type = 'jpg'
    then
      put_stream( p_img.pixels, false, '/Filter /DCTDecode', false );
    elsif p_img.type = 'png'
    then
      put_stream( p_img.pixels, false
                ,  ' /Filter /FlateDecode /DecodeParms <</Predictor 15 '
                || '/Colors ' || p_img.nr_colors
                || '/BitsPerComponent ' || p_img.color_res
                || ' /Columns ' || p_img.width
                || ' >> '
                , false );
    else
      put_stream( p_img.pixels, p_tag => false );
    end if;
    txt2pdfdoc( 'endobj' );
  end;
--
  function add_resources
  return number
  is
    t_ind pls_integer;
    t_self number(10);
    t_fonts tp_objects_tab;
  begin
--
    t_ind := g_used_fonts.first;
    while t_ind is not null
    loop
      t_fonts( t_ind ) := add_font( t_ind );
      t_ind := g_used_fonts.next( t_ind );
    end loop;
--
    t_self := add_object;
    txt2pdfdoc( '<</ProcSet [/PDF /Text]' );
--
    if g_used_fonts.count() > 0
    then
      txt2pdfdoc( '/Font <<' );
      t_ind := g_used_fonts.first;
      while t_ind is not null
      loop
        txt2pdfdoc( '/F'|| to_char( t_ind ) || ' '
                  || to_char( t_fonts( t_ind ) ) || ' 0 R'
                  );
        t_ind := g_used_fonts.next( t_ind );
      end loop;
      txt2pdfdoc( '>>' );
    end if;
--
    if g_images.count( ) > 0
    then
      txt2pdfdoc( '/XObject <<' );
      for i in g_images.first .. g_images.last
      loop
        txt2pdfdoc( '/I' || to_char( i ) || ' ' || to_char( t_self + 2 * i ) || ' 0 R' );
      end loop;
      txt2pdfdoc( '>>' );
    end if;
--
    txt2pdfdoc( '>>' );
    txt2pdfdoc( 'endobj' );
--
    if g_images.count( ) > 0
    then
      for i in g_images.first .. g_images.last
      loop
        add_image( g_images( i ) );
      end loop;
    end if;
    return t_self;
  end;
--
  procedure add_page
    ( p_page_ind pls_integer
    , p_parent number
    , p_resources number
    )
  is
    t_content number(10);
  begin
    t_content := add_stream( g_pages( p_page_ind ) );
    add_object;
    txt2pdfdoc( '<< /Type /Page' );
    txt2pdfdoc( '/Parent ' || to_char( p_parent ) || ' 0 R' );
    -- AW: Add a mediabox to each page
    txt2pdfdoc(    '/MediaBox [0 0 '
                || to_char_round( g_settings_per_page( p_page_ind ).page_width
                                , 0
                                )
                || ' '
                || to_char_round( g_settings_per_page( p_page_ind ).page_height
                                , 0
                                )
                || ']' );
    txt2pdfdoc( '/Contents ' || to_char( t_content ) || ' 0 R' );
    txt2pdfdoc( '/Resources ' || to_char( p_resources ) || ' 0 R' );
    txt2pdfdoc( '>>' );
    txt2pdfdoc( 'endobj' );
  end;
--
  function add_pages
  return number
  is
    t_self number(10);
    t_resources number(10);
  begin
    t_resources := add_resources;
    t_self := add_object;
    txt2pdfdoc( '<</Type/Pages/Kids [' );
--
    for i in g_pages.first .. g_pages.last
    loop
      txt2pdfdoc( to_char( t_self + i * 2 + 2 ) || ' 0 R' );
    end loop;
--
    -- AW: take the settings from page 1 as global settings
    if g_settings_per_page.EXISTS(0) THEN
      g_settings:=g_settings_per_page(0);
    end if;
    txt2pdfdoc( ']' );
    txt2pdfdoc( '/Count ' || g_pages.count() );
    txt2pdfdoc(    '/MediaBox [0 0 '
                || to_char_round( g_settings.page_width
                                , 0
                                )
                || ' '
                || to_char_round( g_settings.page_height
                                , 0
                                )
                || ']' );
    txt2pdfdoc( '>>' );
    txt2pdfdoc( 'endobj' );
--
    if g_pages.count() > 0
    then
      for i in g_pages.first .. g_pages.last
      loop
        add_page( i, t_self, t_resources );
      end loop;
    end if;
--
    return t_self;
  end;
--
  function add_catalogue
  return number
  is
  begin
    return add_object( '/Type/Catalog'
                     || '/Pages ' || to_char( add_pages ) || ' 0 R'
                     || '/OpenAction [0 /XYZ null null 0.77]'
                     );
  end;
--
  function add_info
  return number
  is
    t_banner varchar2( 1000 );
  begin
    begin
      select    'running on '
             || replace( replace( replace( substr( banner
                                                 , 1
                                                 , 950
                                                 )
                                         , '\'
                                         , '\\'
                                         )
                                , '('
                                , '\('
                                )
                       , ')'
                       , '\)'
                       )
      into t_banner
      from v$version
      where instr( upper( banner )
                 , 'DATABASE'
                 ) > 0;
      t_banner := '/Producer (' || t_banner || ')';
    exception
      when others
      then
        null;
    end;
--
    return add_object( to_char( current_date, '"/CreationDate (D:"YYYYMMDDhh24miss")"' )
                     || '/Creator (AS-PDF 0.3.0 by Anton Scheffer)'
                     || t_banner
                     || '/Title <FEFF' || utl_i18n.string_to_raw( g_info.title, 'AL16UTF16' ) || '>'
                     || '/Author <FEFF' || utl_i18n.string_to_raw( g_info.author, 'AL16UTF16' ) || '>'
                     || '/Subject <FEFF' || utl_i18n.string_to_raw( g_info.subject, 'AL16UTF16' ) || '>'
                     || '/Keywords <FEFF' || utl_i18n.string_to_raw( g_info.keywords, 'AL16UTF16' ) || '>'
                     );
  end;
--
  procedure finish_pdf
  is
    t_xref number;
    t_info number(10);
    t_catalogue number(10);
  begin
    if g_pages.count = 0
    then
      new_page;
    end if;
    if g_page_prcs.count > 0
    then
      for i in g_pages.first .. g_pages.last
      loop
        g_page_nr := i;
        for p in g_page_prcs.first .. g_page_prcs.last
        loop
          begin
            execute immediate replace( replace( g_page_prcs( p ), '#PAGE_NR#', i + 1 ), '"PAGE_COUNT#', g_pages.count );
          exception
            when others then null;
          end;
        end loop;
      end loop;
    end if;
    dbms_lob.createtemporary( g_pdf_doc, true );
    txt2pdfdoc( '%PDF-1.3' );
    raw2pdfdoc( hextoraw( '25E2E3CFD30D0A' ) );          -- add a hex comment
    t_info := add_info;
    t_catalogue := add_catalogue;
    t_xref := dbms_lob.getlength( g_pdf_doc );
    txt2pdfdoc( 'xref' );
    txt2pdfdoc( '0 ' || to_char( g_objects.count() ) );
    txt2pdfdoc( '0000000000 65535 f ' );
    for i in 1 .. g_objects.count( ) - 1
    loop
      txt2pdfdoc( to_char( g_objects( i ), 'fm0000000000' ) || ' 00000 n' );
                        -- this line should be exactly 20 bytes, including EOL
    end loop;
    txt2pdfdoc( 'trailer' );
    txt2pdfdoc( '<< /Root ' || to_char( t_catalogue ) || ' 0 R' );
    txt2pdfdoc( '/Info ' || to_char( t_info ) || ' 0 R' );
    txt2pdfdoc( '/Size ' || to_char( g_objects.count() ) );
    txt2pdfdoc( '>>' );
    txt2pdfdoc( 'startxref' );
    txt2pdfdoc( to_char( t_xref ) );
    txt2pdfdoc( '%%EOF' );
--
    g_objects.delete;
    for i in g_pages.first .. g_pages.last
    loop
      dbms_lob.freetemporary( g_pages( i ) );
    end loop;
    g_objects.delete;
    g_pages.delete;
    -- AW: Page-settings
    g_settings_per_page.delete;
    g_fonts.delete;
    g_used_fonts.delete;
    g_page_prcs.delete;
    if g_images.count() > 0
    then
      for i in g_images.first .. g_images.last
      loop
        if dbms_lob.istemporary( g_images( i ).pixels ) = 1
        then
          dbms_lob.freetemporary( g_images( i ).pixels );
        end if;
      end loop;
      g_images.delete;
    end if;
  end;
--
  function conv2uu( p_value number, p_unit varchar2 )
  return number
  is
   c_inch constant number := 25.40025;
  begin
    return round( case lower( p_unit )
                    when 'mm' then p_value * 72 / c_inch
                    when 'cm' then p_value * 720 / c_inch
                    when 'pt' then p_value          -- also point
                    when 'point' then p_value
                    when 'inch'  then p_value * 72
                    when 'in'    then p_value * 72  -- also inch
                    when 'pica'  then p_value * 12
                    when 'p'     then p_value * 12  -- also pica
                    when 'pc'    then p_value * 12  -- also pica
                    when 'em'    then p_value * 12  -- also pica
                    when 'px'    then p_value       -- pixel voorlopig op point zetten
                    when 'px'    then p_value * 0.8 -- pixel
                    else null
                  end
                , 3
                );
  end;
--
  procedure set_page_size
    ( p_width number
    , p_height number
    , p_unit varchar2 := 'cm'
    )
  is
  begin
    g_settings.page_width := conv2uu( p_width, p_unit );
    g_settings.page_height := conv2uu( p_height, p_unit );
  end;
--
  procedure set_page_format( p_format varchar2 := 'A4' )
  is
  begin
    case upper( p_format )
      when 'A3'
      then
        set_page_size( 420, 297, 'mm' );
      when 'A4'
      then
        set_page_size( 297, 210, 'mm' );
      when 'A5'
      then
        set_page_size( 210, 148, 'mm' );
      when 'A6'
      then
        set_page_size( 148, 105, 'mm' );
      when 'LEGAL'
      then
        set_page_size( 14, 8.5, 'in' );
      when 'LETTER'
      then
        set_page_size( 11, 8.5, 'in' );
      when 'QUARTO'
      then
        set_page_size( 11, 9, 'in' );
      when 'EXECUTIVE'
      then
        set_page_size( 10.5, 7.25, 'in' );
      else
        null;
    end case;
  end;
--
  procedure set_page_orientation( p_orientation varchar2 := 'PORTRAIT' )
  is
    t_tmp number;
  begin
    if (  (   upper( p_orientation ) in ( 'L', 'LANDSCAPE' )
          and g_settings.page_height > g_settings.page_width
          )
       or ( upper( p_orientation ) in( 'P', 'PORTRAIT' )
          and g_settings.page_height < g_settings.page_width
          )
       )
    then
      t_tmp := g_settings.page_width;
      g_settings.page_width := g_settings.page_height;
      g_settings.page_height := t_tmp;
    end if;
  end;
--
  procedure set_margins
    ( p_top number := null
    , p_left number := null
    , p_bottom number := null
    , p_right number := null
    , p_unit varchar2 := 'cm'
    )
  is
    t_tmp number;
  begin
    t_tmp := nvl( conv2uu( p_top, p_unit ), -1 );
    if t_tmp < 0 or t_tmp > g_settings.page_height
    then
      t_tmp := conv2uu( 3, 'cm' );
    end if;
    g_settings.margin_top := t_tmp;
    t_tmp := nvl( conv2uu( p_bottom, p_unit ), -1 );
    if t_tmp < 0 or t_tmp > g_settings.page_height
    then
      t_tmp := conv2uu( 4, 'cm' );
    end if;
    g_settings.margin_bottom := t_tmp;
    t_tmp := nvl( conv2uu( p_left, p_unit ), -1 );
    if t_tmp < 0 or t_tmp > g_settings.page_width
    then
      t_tmp := conv2uu( 1, 'cm' );
    end if;
    g_settings.margin_left := t_tmp;
    t_tmp := nvl( conv2uu( p_right, p_unit ), -1 );
    if t_tmp < 0 or t_tmp > g_settings.page_width
    then
      t_tmp := conv2uu( 1, 'cm' );
    end if;
    g_settings.margin_right := t_tmp;
--
    if g_settings.margin_top + g_settings.margin_bottom + conv2uu( 1, 'cm' )> g_settings.page_height
    then
      g_settings.margin_top := 0;
      g_settings.margin_bottom := 0;
    end if;
    if g_settings.margin_left + g_settings.margin_right + conv2uu( 1, 'cm' )> g_settings.page_width
    then
      g_settings.margin_left := 0;
      g_settings.margin_right := 0;
    end if;
  end;
--
  procedure set_info
    ( p_title varchar2 := null
    , p_author varchar2 := null
    , p_subject varchar2 := null
    , p_keywords varchar2 := null
    )
  is
  begin
    g_info.title := substr( p_title, 1, 1024 );
    g_info.author := substr( p_author, 1, 1024 );
    g_info.subject := substr( p_subject, 1, 1024 );
    g_info.keywords := substr( p_keywords, 1, 16383 );
  end;
--
  procedure init
  is
  begin
    g_objects.delete;
    g_pages.delete;
    -- AW: Page-settings
    g_settings_per_page.delete;
    g_fonts.delete;
    g_used_fonts.delete;
    g_page_prcs.delete;
    g_images.delete;
    g_settings := null;
    g_current_font := null;
    g_x := null;
    g_y := null;
    g_info := null;
    g_page_nr := null;
    g_objects( 0 ) := 0;
    init_core_fonts;
    set_page_format;
    set_page_orientation;
    set_margins;
  end;
--
  function get_pdf
  return blob
  is
  begin
    finish_pdf;
    return g_pdf_doc;
  end;
--
  procedure save_pdf
    ( p_dir varchar2 := 'MY_DIR'
    , p_filename varchar2 := 'my.pdf'
    , p_freeblob boolean := true
    )
  is
    t_fh utl_file.file_type;
    t_len pls_integer := 32767;
  begin
    finish_pdf;
    t_fh := utl_file.fopen( p_dir, p_filename, 'wb' );
    for i in 0 .. trunc( ( dbms_lob.getlength( g_pdf_doc ) - 1 ) / t_len )
    loop
      utl_file.put_raw( t_fh
                      , dbms_lob.substr( g_pdf_doc
                                       , t_len
                                       , i * t_len + 1
                                       )
                      );
    end loop;
    utl_file.fclose( t_fh );
    if p_freeblob
    then
      dbms_lob.freetemporary( g_pdf_doc );
    end if;
  end;
--
  procedure raw2page( p_txt raw )
  is
  begin
    if g_pages.count() = 0
    then
      new_page;
    end if;
    dbms_lob.append( g_pages( coalesce( g_page_nr, g_pages.count( ) - 1 ) )
                   , utl_raw.concat( p_txt, hextoraw( '0D0A' ) )
                   );
  end;
--
  procedure txt2page( p_txt varchar2 )
  is
  begin
    raw2page( utl_raw.cast_to_raw( p_txt ) );
  end;
--
  procedure output_font_to_doc( p_output_to_doc boolean )
  is
  begin
    if p_output_to_doc
    then
      txt2page( 'BT /F' || g_current_font || ' '
              || to_char_round( g_fonts( g_current_font ).fontsize ) || ' Tf ET'
              );
    end if;
  end;
--
  procedure set_font
    ( p_index pls_integer
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    )
  is
  begin
    if p_index is not null
    then
      g_used_fonts( p_index ) := 0;
      g_fonts( p_index ).fontsize := p_fontsize_pt;
      g_current_font_record.fontsize := p_fontsize_pt;
      if NVL(g_current_font,-1) != p_index then -- aw set only if different
        g_current_font := p_index;
        g_current_font_record:=g_fonts( p_index );
      end if;
      output_font_to_doc( p_output_to_doc );
    end if;
  end;
--
  function set_font
    ( p_fontname varchar2
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    )
  return pls_integer
  is
    t_fontname varchar2(100);
  begin
    if p_fontname is null
    then
      if (  g_current_font is not null
         and p_fontsize_pt != g_fonts( g_current_font ).fontsize
         )
      then
        g_fonts( g_current_font ).fontsize := p_fontsize_pt;
        g_current_font_record:=g_fonts( g_current_font );
        output_font_to_doc( p_output_to_doc );
      end if;
      return g_current_font;
    end if;
--
    t_fontname := lower( p_fontname );
    for i in g_fonts.first .. g_fonts.last
    loop
      if lower( g_fonts( i ).fontname ) = t_fontname
      then
        exit when g_current_font = i and g_fonts( i ).fontsize = p_fontsize_pt and g_page_nr is null;
        g_fonts( i ).fontsize := coalesce( p_fontsize_pt
                                         , g_fonts( nvl( g_current_font, i ) ).fontsize
                                         , 12
                                         );
        g_current_font := i;
        g_current_font_record:=g_fonts(i);
        g_used_fonts( i ) := 0;
        output_font_to_doc( p_output_to_doc );
        return g_current_font;
      end if;
    end loop;
    return null;
  end;
--
  procedure set_font
    ( p_fontname varchar2
    , p_fontsize_pt number
    , p_output_to_doc boolean := true
    )
  is
    t_dummy pls_integer;
  begin
    t_dummy := set_font( p_fontname, p_fontsize_pt, p_output_to_doc );
  end;
--
  function set_font
    ( p_family varchar2
    , p_style varchar2 := 'N'
    , p_fontsize_pt number := null
    , p_output_to_doc boolean := true
    )
  return pls_integer
  is
    t_family varchar2(100);
    t_style varchar2(100);
  begin
    if p_family is null and g_current_font is null
    then
      return null;
    end if;
    if p_family is null and  p_style is null and p_fontsize_pt is null
    then
      return null;
    end if;
    t_family := coalesce( lower( p_family )
                        , g_fonts( g_current_font ).family
                        );
    t_style := upper( p_style );
    t_style := case t_style
                 when 'NORMAL' then 'N'
                 when 'REGULAR' then 'N'
                 when 'BOLD' then 'B'
                 when 'ITALIC' then 'I'
                 when 'OBLIQUE' then 'I'
                 else t_style
               end;
    t_style := coalesce( t_style
                       , case when g_current_font is null then 'N' else g_fonts( g_current_font ).style end
                       );
--
    for i in g_fonts.first .. g_fonts.last
    loop
      if (   g_fonts( i ).family = t_family
         and g_fonts( i ).style = t_style
         )
      then
        return set_font( g_fonts( i ).fontname, p_fontsize_pt, p_output_to_doc );
      end if;
    end loop;
    return null;
  end;
--
  procedure set_font
    ( p_family varchar2
    , p_style varchar2 := 'N'
    , p_fontsize_pt number := null
    , p_output_to_doc boolean := true
    )
  is
    t_dummy pls_integer;
  begin
    t_dummy := set_font( p_family, p_style, p_fontsize_pt, p_output_to_doc );
  end;
--
  procedure new_page
  is
  begin
    g_pages( g_pages.count() ) := null;
    g_settings_per_page(g_settings_per_page.count()):=g_settings;
    dbms_lob.createtemporary( g_pages( g_pages.count() - 1 ), true );
    if g_current_font is not null and g_pages.count() > 0
    then
      txt2page( 'BT /F' || g_current_font || ' '
              || to_char_round( g_fonts( g_current_font ).fontsize )
              || ' Tf ET'
              );
    end if;
    g_x := null;
    g_y := null;
  end;
--
  function pdf_string( p_txt in blob )
  return blob
  is
    t_rv blob;
    t_ind integer;
    type tp_tab_raw is table of raw(1);
    tab_raw tp_tab_raw
      := tp_tab_raw( utl_raw.cast_to_raw( '\' )
                   , utl_raw.cast_to_raw( '(' )
                   , utl_raw.cast_to_raw( ')' )
                   );
    lob_max NUMBER;
  begin
    t_rv := p_txt;
    for i in tab_raw.first .. tab_raw.last
    loop
      t_ind := -1;
      loop
        t_ind := dbms_lob.instr( t_rv
                               , tab_raw( i )
                               , t_ind + 2
                               );
        exit when t_ind <= 0;
        lob_max := dbms_lob.getlength(t_rv) - t_ind + 1 ;
        dbms_lob.copy( t_rv
                     , t_rv
                     , lob_max
                     , t_ind + 1
                     , t_ind
                     );
        dbms_lob.copy( t_rv
                     , utl_raw.cast_to_raw( '\' )
                     , 1
                     , t_ind
                     , 1
                     );
      end loop;
    end loop;
    return t_rv;
  end;
--
  function txt2raw( p_txt varchar2 )
  return raw
  is
    t_rv raw(32767);
    t_unicode pls_integer;
  begin
    if g_current_font is null
    then
      set_font( 'helvetica' );
    end if;
    if g_fonts( g_current_font ).cid
    then
      for i in 1 .. length( p_txt )
      loop
        t_unicode := utl_raw.cast_to_binary_integer( utl_raw.convert( utl_raw.cast_to_raw( substr( p_txt, i, 1 ) )
                                                                    , 'AMERICAN_AMERICA.AL16UTF16'
                                                                    , sys_context( 'userenv', 'LANGUAGE' )  -- ???? font characterset ?????
                                                                    )
                                                 );
        if g_fonts( g_current_font ).flags = 4 -- a symbolic font
        then
-- assume code 32, space maps to the first code from the font
          t_unicode := g_fonts( g_current_font ).code2glyph.first + t_unicode - 32;
        end if;
        if g_current_font_record.code2glyph.exists( t_unicode )
        then
          g_fonts( g_current_font ).used_chars( g_current_font_record.code2glyph( t_unicode ) ) := 0;
          t_rv := utl_raw.concat( t_rv
                                , utl_raw.cast_to_raw( to_char( g_current_font_record.code2glyph( t_unicode ), 'FM0XXX' ) )
                                );
        else
          t_rv := utl_raw.concat( t_rv, utl_raw.cast_to_raw( '0000' ) );
        end if;
      end loop;
      t_rv := utl_raw.concat( utl_raw.cast_to_raw( '<' )
                            , t_rv
                            , utl_raw.cast_to_raw( '>' )
                            );
    else
      t_rv := utl_raw.convert( utl_raw.cast_to_raw( p_txt )
                             , g_fonts( g_current_font ).charset
                             , sys_context( 'userenv', 'LANGUAGE' )
                             );
      for i in 1 .. utl_raw.length( t_rv )
      loop
        g_fonts( g_current_font ).used_chars( raw2num( t_rv, i, 1 ) ) := 0;
      end loop;
      t_rv := utl_raw.concat( utl_raw.cast_to_raw( '(' )
                            , pdf_string( t_rv )
                            , utl_raw.cast_to_raw( ')' )
                            );
    end if;
    return t_rv;
  end;
--
  procedure put_raw( p_x number, p_y number, p_txt raw, p_degrees_rotation number := null )
  is
    c_pi constant number := 3.14159265358979323846264338327950288419716939937510;
    t_tmp varchar2(32767);
    t_sin number;
    t_cos number;
  begin
    t_tmp := to_char_round( p_x ) || ' ' || to_char_round( p_y );
    if p_degrees_rotation is null
    then
      t_tmp := t_tmp || ' Td ';
    else
      t_sin := sin( p_degrees_rotation / 180 * c_pi );
      t_cos := cos( p_degrees_rotation / 180 * c_pi );
      t_tmp := to_char_round( t_cos, 5 ) || ' ' || t_tmp;
      t_tmp := to_char_round( - t_sin, 5 ) || ' ' || t_tmp;
      t_tmp := to_char_round( t_sin, 5 ) || ' ' || t_tmp;
      t_tmp := to_char_round( t_cos, 5 ) || ' ' || t_tmp;
      t_tmp := t_tmp || ' Tm ';
    end if;
    raw2page( utl_raw.concat( utl_raw.cast_to_raw( 'BT ' || t_tmp )
                            , p_txt
                            , utl_raw.cast_to_raw( ' Tj ET' )
                            )
              );
  end;
--
  procedure put_txt( p_x number, p_y number, p_txt varchar2, p_degrees_rotation number := null )
  is
  begin
    if p_txt is not null
    then
      put_raw( p_x, p_y, txt2raw( p_txt ), p_degrees_rotation );
    end if;
  end;
--
  function str_len( p_txt in varchar2 )
  return number
  is
    t_width number;
    t_char pls_integer;
    t_rtxt raw(32767);
    t_tmp number;
    --t_font tp_font;
  begin
    if p_txt is null
    then
      return 0;
    end if;
--
    t_width := 0;
    if g_current_font_record.cid
    then
      t_rtxt := utl_raw.convert( utl_raw.cast_to_raw( p_txt )
                               , 'AMERICAN_AMERICA.AL16UTF16' -- 16 bit font => 2 bytes per char
                               , sys_context( 'userenv', 'LANGUAGE' )  -- ???? font characterset ?????
                               );
      for i in 1 .. utl_raw.length( t_rtxt ) / 2
      loop
        t_char := to_number( utl_raw.substr( t_rtxt, i * 2 - 1, 2 ), 'xxxx' );
        if g_current_font_record.flags = 4
        then
-- assume code 32, space maps to the first code from the font
          t_char := g_current_font_record.code2glyph.first + t_char - 32;
        end if;
        if (   g_current_font_record.code2glyph.exists( t_char )
           and g_current_font_record.hmetrics.exists( g_current_font_record.code2glyph( t_char ) )
           )
        then
          t_tmp := g_current_font_record.hmetrics( g_current_font_record.code2glyph( t_char ) );
        else
          t_tmp := g_current_font_record.hmetrics( g_current_font_record.hmetrics.last() );
        end if;
        t_width := t_width + t_tmp;
      end loop;
      t_width := t_width * g_current_font_record.unit_norm;
      t_width := t_width * g_current_font_record.fontsize / 1000;
    else
      t_rtxt := utl_raw.convert( utl_raw.cast_to_raw( p_txt )
                               , g_current_font_record.charset  -- should be an 8 bit font
                               , sys_context( 'userenv', 'LANGUAGE' )
                               );
      for i in 1 .. utl_raw.length( t_rtxt )
      loop
        t_char := to_number( utl_raw.substr( t_rtxt, i, 1 ), 'xx' );
        t_width := t_width + g_current_font_record.char_width_tab( t_char );
      end loop;
      t_width := t_width * g_current_font_record.fontsize / 1000;
    end if;
    return t_width;
  end;
--
  procedure write
    ( p_txt in varchar2
    , p_x in number := null
    , p_y in number := null
    , p_line_height in number := null
    , p_start in number := null  -- left side of the available text box
    , p_width in number := null  -- width of the available text box
    , p_alignment in varchar2 := null
    )
  is
    t_line_height number;
    t_x number;
    t_y number;
    t_start number;
    t_width number;
    t_len number;
    t_cnt pls_integer;
    t_ind pls_integer;
    t_alignment varchar2(100);
  begin
    if p_txt is null
    then
      return;
    end if;
--
    if g_current_font is null
    then
      set_font( 'helvetica' );
    end if;
--
    t_line_height := nvl( p_line_height, g_fonts( g_current_font ).fontsize );
    if (  t_line_height < g_fonts( g_current_font ).fontsize
       or t_line_height > ( g_settings.page_height - g_settings.margin_top - t_line_height ) / 4
       )
    then
      t_line_height := g_fonts( g_current_font ).fontsize;
    end if;
    t_start := nvl( p_start, g_settings.margin_left );
    if (  t_start < g_settings.margin_left
       or t_start > g_settings.page_width - g_settings.margin_right - g_settings.margin_left
       )
    then
      t_start := g_settings.margin_left;
    end if;
    t_width := nvl( p_width
                  , g_settings.page_width - g_settings.margin_right - g_settings.margin_left
                  );
    if (  t_width < str_len( '   ' )
       or t_width > g_settings.page_width - g_settings.margin_right - g_settings.margin_left
       )
    then
      t_width := g_settings.page_width - g_settings.margin_right - g_settings.margin_left;
    end if;
    t_x := coalesce( p_x, g_x, g_settings.margin_left );
    t_y := coalesce( p_y
                   , g_y
                   , g_settings.page_height - g_settings.margin_top - t_line_height
                   );
    if t_y < 0
    then
      t_y := coalesce( g_y
                     , g_settings.page_height - g_settings.margin_top - t_line_height
                     ) - t_line_height;
    end if;
    if t_x > t_start + t_width
    then
      t_x := t_start;
      t_y := t_y - t_line_height;
    elsif t_x < t_start
    then
      t_x := t_start;
    end if;
    if t_y < g_settings.margin_bottom
    then
      new_page;
      t_x := t_start;
      t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
    end if;
--
    t_ind := instr( p_txt, chr(10) );
    if t_ind > 0
    then
      g_x := t_x;
      g_y := t_y;
      write( rtrim( substr( p_txt, 1, t_ind - 1 ), chr(13) ), t_x, t_y, t_line_height, t_start, t_width, p_alignment );
      t_y := g_y - t_line_height;
      if t_y < g_settings.margin_bottom
      then
        new_page;
        t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
      end if;
      g_x := t_start;
      g_y := t_y;
      write( substr( p_txt, t_ind + 1 ), t_start, t_y, t_line_height, t_start, t_width, p_alignment );
      return;
    end if;
--
    t_len := str_len( p_txt );
    if t_len <= t_width - t_x + t_start
    then
      t_alignment := lower( substr( p_alignment, 1, 100 ) );
      if instr( t_alignment, 'right' ) > 0 or instr( t_alignment, 'end' ) > 0
      then
        t_x := t_start + t_width - t_len;
      elsif instr( t_alignment, 'center' ) > 0
      then
        t_x := ( t_width + t_x + t_start - t_len ) / 2;
      end if;
      put_txt( t_x, t_y, p_txt );
      g_x := t_x + t_len + str_len( ' ' );
      g_y := t_y;
      return;
    end if;
--
    t_cnt := 0;
    while (   instr( p_txt, ' ', 1, t_cnt + 1 ) > 0
          and str_len( substr( p_txt, 1, instr( p_txt, ' ', 1, t_cnt + 1 ) - 1 ) ) <= t_width - t_x + t_start
          )
    loop
      t_cnt := t_cnt + 1;
    end loop;
    if t_cnt > 0
    then
      t_ind := instr( p_txt, ' ', 1, t_cnt );
      write( substr( p_txt, 1, t_ind - 1 ), t_x, t_y, t_line_height, t_start, t_width, p_alignment );
      t_y := t_y - t_line_height;
      if t_y < g_settings.margin_bottom
      then
        new_page;
        t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
      end if;
      write( substr( p_txt, t_ind + 1 ), t_start, t_y, t_line_height, t_start, t_width, p_alignment );
      return;
    end if;
--
    if t_x > t_start and t_len < t_width
    then
      t_y := t_y - t_line_height;
      if t_y < g_settings.margin_bottom
      then
        new_page;
        t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
      end if;
      write( p_txt, t_start, t_y, t_line_height, t_start, t_width, p_alignment );
    else
      if length( p_txt ) = 1
      then
        if t_x > t_start
        then
          t_y := t_y - t_line_height;
          if t_y < g_settings.margin_bottom
          then
            new_page;
            t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
          end if;
        end if;
        write( p_txt, t_x, t_y, t_line_height, t_start, t_len );
      else
        t_ind := 2; -- start with 2 to make sure we get amaller string!
        while str_len( substr( p_txt, 1, t_ind ) ) <= t_width - t_x + t_start
        loop
          t_ind := t_ind + 1;
        end loop;
        write( substr( p_txt, 1, t_ind - 1 ), t_x, t_y, t_line_height, t_start, t_width, p_alignment );
        t_y := t_y - t_line_height;
        if t_y < g_settings.margin_bottom
        then
          new_page;
          t_y := g_settings.page_height - g_settings.margin_top - t_line_height;
        end if;
        write( substr( p_txt, t_ind ), t_start, t_y, t_line_height, t_start, t_width, p_alignment );
      end if;
    end if;
  end;
--
  function load_ttf_font
    ( p_font blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    , p_offset number := 1
    )
  return pls_integer
  is
    this_font tp_font;
    type tp_font_table is record
      ( offset pls_integer
      , length pls_integer
      );
    type tp_tables is table of tp_font_table index by varchar2(4);
    t_tables tp_tables;
    t_tag varchar2(4);
    t_blob blob;
    t_offset pls_integer;
    nr_hmetrics pls_integer;
    subtype tp_glyphname is varchar2(250);
    type tp_glyphnames is table of tp_glyphname index by pls_integer;
    t_glyphnames tp_glyphnames;
    t_glyph2name tp_pls_tab;
    t_font_ind pls_integer;
  begin
    if dbms_lob.substr( p_font, 4, p_offset ) != hextoraw( '00010000' ) --  OpenType Font
    then
      return null;
    end if;
    for i in 1 .. blob2num( p_font, 2, p_offset + 4 )
    loop
      t_tag :=
        utl_raw.cast_to_varchar2( dbms_lob.substr( p_font, 4, p_offset - 4 + i * 16 ) );
      t_tables( t_tag ).offset := blob2num( p_font, 4, p_offset + 4 + i * 16 ) + 1;
      t_tables( t_tag ).length := blob2num( p_font, 4, p_offset + 8 + i * 16 );
    end loop;
--
    if (  not t_tables.exists( 'cmap' )
       or not t_tables.exists( 'glyf' )
       or not t_tables.exists( 'head' )
       or not t_tables.exists( 'hhea' )
       or not t_tables.exists( 'hmtx' )
       or not t_tables.exists( 'loca' )
       or not t_tables.exists( 'maxp' )
       or not t_tables.exists( 'name' )
       or not t_tables.exists( 'post' )
       )
    then
      return null;
    end if;
--
    dbms_lob.createtemporary( t_blob, true );
    dbms_lob.copy( t_blob, p_font, t_tables( 'maxp' ).length, 1, t_tables( 'maxp' ).offset );
    this_font.numGlyphs := blob2num( t_blob, 2, 5 );
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'cmap' ).length, 1, t_tables( 'cmap' ).offset );
    for i in 0 .. blob2num( t_blob, 2, 3 ) - 1
    loop
      if (   dbms_lob.substr( t_blob, 2, 5 + i * 8 ) = hextoraw( '0003' ) -- Windows
         and dbms_lob.substr( t_blob, 2, 5 + i * 8 + 2 )
               in ( hextoraw( '0000' ) -- Symbol
                  , hextoraw( '0001' ) -- Unicode BMP (UCS-2)
                  )
         )
      then
        if dbms_lob.substr( t_blob, 2, 5 + i * 8 + 2 ) = hextoraw( '0000' ) -- Symbol
        then
          this_font.flags := 4; -- symbolic
        else
          this_font.flags := 32; -- non-symbolic
        end if;
        t_offset := blob2num( t_blob, 4, 5 + i * 8 + 4 ) + 1;
        if dbms_lob.substr( t_blob, 2, t_offset ) != hextoraw( '0004' )
        then
          return null;
        end if;
        declare
          t_seg_cnt pls_integer;
          t_end_offs pls_integer;
          t_start_offs pls_integer;
          t_idDelta_offs pls_integer;
          t_idRangeOffset_offs pls_integer;
          t_tmp pls_integer;
          t_start pls_integer;
        begin
          t_seg_cnt := blob2num( t_blob, 2, t_offset + 6 ) / 2;
          t_end_offs := t_offset + 14;
          t_start_offs := t_end_offs + t_seg_cnt * 2 + 2;
          t_idDelta_offs := t_start_offs + t_seg_cnt * 2;
          t_idRangeOffset_offs := t_idDelta_offs + t_seg_cnt * 2;
          for seg in 0 .. t_seg_cnt - 1
          loop
            t_tmp := blob2num( t_blob, 2, t_idRangeOffset_offs + seg * 2 );
            if t_tmp = 0
            then
              t_tmp := blob2num( t_blob, 2, t_idDelta_offs + seg * 2 );
              for c in blob2num( t_blob, 2, t_start_offs + seg * 2 )
                    .. blob2num( t_blob, 2, t_end_offs + seg * 2 )
              loop
                this_font.code2glyph( c ) := mod( c + t_tmp, 65536 );
              end loop;
            else
              t_start := blob2num( t_blob, 2, t_start_offs + seg * 2 );
              for c in t_start .. blob2num( t_blob, 2, t_end_offs + seg * 2 )
              loop
                this_font.code2glyph( c ) := blob2num( t_blob, 2, t_idRangeOffset_offs + t_tmp + ( seg + c - t_start ) * 2 );
              end loop;
            end if;
          end loop;
        end;
        exit;
      end if;
    end loop;
--
    t_glyphnames( 0 ) := '.notdef';
    t_glyphnames( 1 ) := '.null';
    t_glyphnames( 2 ) := 'nonmarkingreturn';
    t_glyphnames( 3 ) := 'space';
    t_glyphnames( 4 ) := 'exclam';
    t_glyphnames( 5 ) := 'quotedbl';
    t_glyphnames( 6 ) := 'numbersign';
    t_glyphnames( 7 ) := 'dollar';
    t_glyphnames( 8 ) := 'percent';
    t_glyphnames( 9 ) := 'ampersand';
    t_glyphnames( 10 ) := 'quotesingle';
    t_glyphnames( 11 ) := 'parenleft';
    t_glyphnames( 12 ) := 'parenright';
    t_glyphnames( 13 ) := 'asterisk';
    t_glyphnames( 14 ) := 'plus';
    t_glyphnames( 15 ) := 'comma';
    t_glyphnames( 16 ) := 'hyphen';
    t_glyphnames( 17 ) := 'period';
    t_glyphnames( 18 ) := 'slash';
    t_glyphnames( 19 ) := 'zero';
    t_glyphnames( 20 ) := 'one';
    t_glyphnames( 21 ) := 'two';
    t_glyphnames( 22 ) := 'three';
    t_glyphnames( 23 ) := 'four';
    t_glyphnames( 24 ) := 'five';
    t_glyphnames( 25 ) := 'six';
    t_glyphnames( 26 ) := 'seven';
    t_glyphnames( 27 ) := 'eight';
    t_glyphnames( 28 ) := 'nine';
    t_glyphnames( 29 ) := 'colon';
    t_glyphnames( 30 ) := 'semicolon';
    t_glyphnames( 31 ) := 'less';
    t_glyphnames( 32 ) := 'equal';
    t_glyphnames( 33 ) := 'greater';
    t_glyphnames( 34 ) := 'question';
    t_glyphnames( 35 ) := 'at';
    t_glyphnames( 36 ) := 'A';
    t_glyphnames( 37 ) := 'B';
    t_glyphnames( 38 ) := 'C';
    t_glyphnames( 39 ) := 'D';
    t_glyphnames( 40 ) := 'E';
    t_glyphnames( 41 ) := 'F';
    t_glyphnames( 42 ) := 'G';
    t_glyphnames( 43 ) := 'H';
    t_glyphnames( 44 ) := 'I';
    t_glyphnames( 45 ) := 'J';
    t_glyphnames( 46 ) := 'K';
    t_glyphnames( 47 ) := 'L';
    t_glyphnames( 48 ) := 'M';
    t_glyphnames( 49 ) := 'N';
    t_glyphnames( 50 ) := 'O';
    t_glyphnames( 51 ) := 'P';
    t_glyphnames( 52 ) := 'Q';
    t_glyphnames( 53 ) := 'R';
    t_glyphnames( 54 ) := 'S';
    t_glyphnames( 55 ) := 'T';
    t_glyphnames( 56 ) := 'U';
    t_glyphnames( 57 ) := 'V';
    t_glyphnames( 58 ) := 'W';
    t_glyphnames( 59 ) := 'X';
    t_glyphnames( 60 ) := 'Y';
    t_glyphnames( 61 ) := 'Z';
    t_glyphnames( 62 ) := 'bracketleft';
    t_glyphnames( 63 ) := 'backslash';
    t_glyphnames( 64 ) := 'bracketright';
    t_glyphnames( 65 ) := 'asciicircum';
    t_glyphnames( 66 ) := 'underscore';
    t_glyphnames( 67 ) := 'grave';
    t_glyphnames( 68 ) := 'a';
    t_glyphnames( 69 ) := 'b';
    t_glyphnames( 70 ) := 'c';
    t_glyphnames( 71 ) := 'd';
    t_glyphnames( 72 ) := 'e';
    t_glyphnames( 73 ) := 'f';
    t_glyphnames( 74 ) := 'g';
    t_glyphnames( 75 ) := 'h';
    t_glyphnames( 76 ) := 'i';
    t_glyphnames( 77 ) := 'j';
    t_glyphnames( 78 ) := 'k';
    t_glyphnames( 79 ) := 'l';
    t_glyphnames( 80 ) := 'm';
    t_glyphnames( 81 ) := 'n';
    t_glyphnames( 82 ) := 'o';
    t_glyphnames( 83 ) := 'p';
    t_glyphnames( 84 ) := 'q';
    t_glyphnames( 85 ) := 'r';
    t_glyphnames( 86 ) := 's';
    t_glyphnames( 87 ) := 't';
    t_glyphnames( 88 ) := 'u';
    t_glyphnames( 89 ) := 'v';
    t_glyphnames( 90 ) := 'w';
    t_glyphnames( 91 ) := 'x';
    t_glyphnames( 92 ) := 'y';
    t_glyphnames( 93 ) := 'z';
    t_glyphnames( 94 ) := 'braceleft';
    t_glyphnames( 95 ) := 'bar';
    t_glyphnames( 96 ) := 'braceright';
    t_glyphnames( 97 ) := 'asciitilde';
    t_glyphnames( 98 ) := 'Adieresis';
    t_glyphnames( 99 ) := 'Aring';
    t_glyphnames( 100 ) := 'Ccedilla';
    t_glyphnames( 101 ) := 'Eacute';
    t_glyphnames( 102 ) := 'Ntilde';
    t_glyphnames( 103 ) := 'Odieresis';
    t_glyphnames( 104 ) := 'Udieresis';
    t_glyphnames( 105 ) := 'aacute';
    t_glyphnames( 106 ) := 'agrave';
    t_glyphnames( 107 ) := 'acircumflex';
    t_glyphnames( 108 ) := 'adieresis';
    t_glyphnames( 109 ) := 'atilde';
    t_glyphnames( 110 ) := 'aring';
    t_glyphnames( 111 ) := 'ccedilla';
    t_glyphnames( 112 ) := 'eacute';
    t_glyphnames( 113 ) := 'egrave';
    t_glyphnames( 114 ) := 'ecircumflex';
    t_glyphnames( 115 ) := 'edieresis';
    t_glyphnames( 116 ) := 'iacute';
    t_glyphnames( 117 ) := 'igrave';
    t_glyphnames( 118 ) := 'icircumflex';
    t_glyphnames( 119 ) := 'idieresis';
    t_glyphnames( 120 ) := 'ntilde';
    t_glyphnames( 121 ) := 'oacute';
    t_glyphnames( 122 ) := 'ograve';
    t_glyphnames( 123 ) := 'ocircumflex';
    t_glyphnames( 124 ) := 'odieresis';
    t_glyphnames( 125 ) := 'otilde';
    t_glyphnames( 126 ) := 'uacute';
    t_glyphnames( 127 ) := 'ugrave';
    t_glyphnames( 128 ) := 'ucircumflex';
    t_glyphnames( 129 ) := 'udieresis';
    t_glyphnames( 130 ) := 'dagger';
    t_glyphnames( 131 ) := 'degree';
    t_glyphnames( 132 ) := 'cent';
    t_glyphnames( 133 ) := 'sterling';
    t_glyphnames( 134 ) := 'section';
    t_glyphnames( 135 ) := 'bullet';
    t_glyphnames( 136 ) := 'paragraph';
    t_glyphnames( 137 ) := 'germandbls';
    t_glyphnames( 138 ) := 'registered';
    t_glyphnames( 139 ) := 'copyright';
    t_glyphnames( 140 ) := 'trademark';
    t_glyphnames( 141 ) := 'acute';
    t_glyphnames( 142 ) := 'dieresis';
    t_glyphnames( 143 ) := 'notequal';
    t_glyphnames( 144 ) := 'AE';
    t_glyphnames( 145 ) := 'Oslash';
    t_glyphnames( 146 ) := 'infinity';
    t_glyphnames( 147 ) := 'plusminus';
    t_glyphnames( 148 ) := 'lessequal';
    t_glyphnames( 149 ) := 'greaterequal';
    t_glyphnames( 150 ) := 'yen';
    t_glyphnames( 151 ) := 'mu';
    t_glyphnames( 152 ) := 'partialdiff';
    t_glyphnames( 153 ) := 'summation';
    t_glyphnames( 154 ) := 'product';
    t_glyphnames( 155 ) := 'pi';
    t_glyphnames( 156 ) := 'integral';
    t_glyphnames( 157 ) := 'ordfeminine';
    t_glyphnames( 158 ) := 'ordmasculine';
    t_glyphnames( 159 ) := 'Omega';
    t_glyphnames( 160 ) := 'ae';
    t_glyphnames( 161 ) := 'oslash';
    t_glyphnames( 162 ) := 'questiondown';
    t_glyphnames( 163 ) := 'exclamdown';
    t_glyphnames( 164 ) := 'logicalnot';
    t_glyphnames( 165 ) := 'radical';
    t_glyphnames( 166 ) := 'florin';
    t_glyphnames( 167 ) := 'approxequal';
    t_glyphnames( 168 ) := 'Delta';
    t_glyphnames( 169 ) := 'guillemotleft';
    t_glyphnames( 170 ) := 'guillemotright';
    t_glyphnames( 171 ) := 'ellipsis';
    t_glyphnames( 172 ) := 'nonbreakingspace';
    t_glyphnames( 173 ) := 'Agrave';
    t_glyphnames( 174 ) := 'Atilde';
    t_glyphnames( 175 ) := 'Otilde';
    t_glyphnames( 176 ) := 'OE';
    t_glyphnames( 177 ) := 'oe';
    t_glyphnames( 178 ) := 'endash';
    t_glyphnames( 179 ) := 'emdash';
    t_glyphnames( 180 ) := 'quotedblleft';
    t_glyphnames( 181 ) := 'quotedblright';
    t_glyphnames( 182 ) := 'quoteleft';
    t_glyphnames( 183 ) := 'quoteright';
    t_glyphnames( 184 ) := 'divide';
    t_glyphnames( 185 ) := 'lozenge';
    t_glyphnames( 186 ) := 'ydieresis';
    t_glyphnames( 187 ) := 'Ydieresis';
    t_glyphnames( 188 ) := 'fraction';
    t_glyphnames( 189 ) := 'currency';
    t_glyphnames( 190 ) := 'guilsinglleft';
    t_glyphnames( 191 ) := 'guilsinglright';
    t_glyphnames( 192 ) := 'fi';
    t_glyphnames( 193 ) := 'fl';
    t_glyphnames( 194 ) := 'daggerdbl';
    t_glyphnames( 195 ) := 'periodcentered';
    t_glyphnames( 196 ) := 'quotesinglbase';
    t_glyphnames( 197 ) := 'quotedblbase';
    t_glyphnames( 198 ) := 'perthousand';
    t_glyphnames( 199 ) := 'Acircumflex';
    t_glyphnames( 200 ) := 'Ecircumflex';
    t_glyphnames( 201 ) := 'Aacute';
    t_glyphnames( 202 ) := 'Edieresis';
    t_glyphnames( 203 ) := 'Egrave';
    t_glyphnames( 204 ) := 'Iacute';
    t_glyphnames( 205 ) := 'Icircumflex';
    t_glyphnames( 206 ) := 'Idieresis';
    t_glyphnames( 207 ) := 'Igrave';
    t_glyphnames( 208 ) := 'Oacute';
    t_glyphnames( 209 ) := 'Ocircumflex';
    t_glyphnames( 210 ) := 'apple';
    t_glyphnames( 211 ) := 'Ograve';
    t_glyphnames( 212 ) := 'Uacute';
    t_glyphnames( 213 ) := 'Ucircumflex';
    t_glyphnames( 214 ) := 'Ugrave';
    t_glyphnames( 215 ) := 'dotlessi';
    t_glyphnames( 216 ) := 'circumflex';
    t_glyphnames( 217 ) := 'tilde';
    t_glyphnames( 218 ) := 'macron';
    t_glyphnames( 219 ) := 'breve';
    t_glyphnames( 220 ) := 'dotaccent';
    t_glyphnames( 221 ) := 'ring';
    t_glyphnames( 222 ) := 'cedilla';
    t_glyphnames( 223 ) := 'hungarumlaut';
    t_glyphnames( 224 ) := 'ogonek';
    t_glyphnames( 225 ) := 'caron';
    t_glyphnames( 226 ) := 'Lslash';
    t_glyphnames( 227 ) := 'lslash';
    t_glyphnames( 228 ) := 'Scaron';
    t_glyphnames( 229 ) := 'scaron';
    t_glyphnames( 230 ) := 'Zcaron';
    t_glyphnames( 231 ) := 'zcaron';
    t_glyphnames( 232 ) := 'brokenbar';
    t_glyphnames( 233 ) := 'Eth';
    t_glyphnames( 234 ) := 'eth';
    t_glyphnames( 235 ) := 'Yacute';
    t_glyphnames( 236 ) := 'yacute';
    t_glyphnames( 237 ) := 'Thorn';
    t_glyphnames( 238 ) := 'thorn';
    t_glyphnames( 239 ) := 'minus';
    t_glyphnames( 240 ) := 'multiply';
    t_glyphnames( 241 ) := 'onesuperior';
    t_glyphnames( 242 ) := 'twosuperior';
    t_glyphnames( 243 ) := 'threesuperior';
    t_glyphnames( 244 ) := 'onehalf';
    t_glyphnames( 245 ) := 'onequarter';
    t_glyphnames( 246 ) := 'threequarters';
    t_glyphnames( 247 ) := 'franc';
    t_glyphnames( 248 ) := 'Gbreve';
    t_glyphnames( 249 ) := 'gbreve';
    t_glyphnames( 250 ) := 'Idotaccent';
    t_glyphnames( 251 ) := 'Scedilla';
    t_glyphnames( 252 ) := 'scedilla';
    t_glyphnames( 253 ) := 'Cacute';
    t_glyphnames( 254 ) := 'cacute';
    t_glyphnames( 255 ) := 'Ccaron';
    t_glyphnames( 256 ) := 'ccaron';
    t_glyphnames( 257 ) := 'dcroat';
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'post' ).length, 1, t_tables( 'post' ).offset );
    this_font.italic_angle := to_short( dbms_lob.substr( t_blob, 2, 5 ) )
                            + to_short( dbms_lob.substr( t_blob, 2, 7 ) ) / 65536;
    case rawtohex( dbms_lob.substr( t_blob, 4, 1 ) )
      when '00010000'
      then
        for g in 0 .. 257
        loop
          t_glyph2name( g ) := g;
        end loop;
      when '00020000'
      then
        t_offset := blob2num( t_blob, 2, 33 ) * 2 + 35;
        while nvl( blob2num( t_blob, 1, t_offset ), 0 ) > 0
        loop
          t_glyphnames( t_glyphnames.count ) := utl_raw.cast_to_varchar2( dbms_lob.substr( t_blob, blob2num( t_blob, 1, t_offset ), t_offset + 1 ) );
          t_offset := t_offset + blob2num( t_blob, 1, t_offset ) + 1;
        end loop;
        for g in 0 .. blob2num( t_blob, 2, 33 ) - 1
        loop
          t_glyph2name( g ) := blob2num( t_blob, 2, 35 + 2 * g );
        end loop;
      when '00025000'
      then
        for g in 0 .. blob2num( t_blob, 2, 33 ) - 1
        loop
          t_offset := blob2num( t_blob, 1, 35 + g );
          if t_offset > 127
          then
            t_glyph2name( g ) := g - t_offset;
          else
            t_glyph2name( g ) := g + t_offset;
          end if;
        end loop;
      when '00030000'
      then
        t_glyphnames.delete;
      else
        dbms_output.put_line( 'no post ' || dbms_lob.substr( t_blob, 4, 1 ) );
    end case;
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'head' ).length, 1, t_tables( 'head' ).offset );
    if dbms_lob.substr( t_blob, 4, 13 ) = hextoraw( '5F0F3CF5' )  -- magic
    then
      declare
        t_tmp pls_integer := blob2num( t_blob, 2, 45 );
      begin
        if bitand( t_tmp, 1 ) = 1
        then
          this_font.style := 'B';
        end if;
        if bitand( t_tmp, 2 ) = 2
        then
          this_font.style := this_font.style || 'I';
          this_font.flags := this_font.flags + 64;
        end if;
        this_font.style := nvl( this_font.style, 'N' );
        this_font.unit_norm := 1000 / blob2num( t_blob, 2, 19 );
        this_font.bb_xmin := to_short( dbms_lob.substr( t_blob, 2, 37 ), this_font.unit_norm );
        this_font.bb_ymin := to_short( dbms_lob.substr( t_blob, 2, 39 ), this_font.unit_norm );
        this_font.bb_xmax := to_short( dbms_lob.substr( t_blob, 2, 41 ), this_font.unit_norm );
        this_font.bb_ymax := to_short( dbms_lob.substr( t_blob, 2, 43 ), this_font.unit_norm );
        this_font.indexToLocFormat := blob2num( t_blob, 2, 51 ); -- 0 for short offsets, 1 for long
      end;
    end if;
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'hhea' ).length, 1, t_tables( 'hhea' ).offset );
    if dbms_lob.substr( t_blob, 4, 1 ) = hextoraw( '00010000' ) -- version 1.0
    then
      this_font.ascent := to_short( dbms_lob.substr( t_blob, 2, 5 ), this_font.unit_norm );
      this_font.descent := to_short( dbms_lob.substr( t_blob, 2, 7 ), this_font.unit_norm );
      this_font.capheight := this_font.ascent;
      nr_hmetrics := blob2num( t_blob, 2, 35 );
    end if;
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'hmtx' ).length, 1, t_tables( 'hmtx' ).offset );
    for j in 0 .. nr_hmetrics - 1
    loop
      this_font.hmetrics( j ) := blob2num( t_blob, 2, 1 + 4 * j );
    end loop;
--
    dbms_lob.copy( t_blob, p_font, t_tables( 'name' ).length, 1, t_tables( 'name' ).offset );
    if dbms_lob.substr( t_blob, 2, 1 ) = hextoraw( '0000' ) -- format 0
    then
      t_offset := blob2num( t_blob, 2, 5 ) + 1;
      for j in 0 .. blob2num( t_blob, 2, 3 ) - 1
      loop
        if (   dbms_lob.substr( t_blob, 2, 7  + j * 12 ) = hextoraw( '0003' ) -- Windows
           and dbms_lob.substr( t_blob, 2, 11 + j * 12 ) = hextoraw( '0409' ) -- English United States
           )
        then
          case rawtohex( dbms_lob.substr( t_blob, 2, 13 + j * 12 ) )
            when '0001'
            then
              this_font.family := utl_i18n.raw_to_char( dbms_lob.substr( t_blob, blob2num( t_blob, 2, 15 + j * 12 ), t_offset + blob2num( t_blob, 2, 17 + j * 12 ) ), 'AL16UTF16' );
            when '0006'
            then
              this_font.name := utl_i18n.raw_to_char( dbms_lob.substr( t_blob, blob2num( t_blob, 2, 15 + j * 12 ), t_offset + blob2num( t_blob, 2, 17 + j * 12 ) ), 'AL16UTF16' );
            else
              null;
          end case;
        end if;
      end loop;
    end if;
--
    if this_font.italic_angle != 0
    then
      this_font.flags := this_font.flags + 64;
    end if;
    this_font.subtype := 'TrueType';
    this_font.stemv := 50;
    this_font.family := lower( this_font.family );
    this_font.encoding := utl_i18n.map_charset( p_encoding
                                              , utl_i18n.generic_context
                                              , utl_i18n.iana_to_oracle
                                              );
    this_font.encoding := nvl( this_font.encoding, upper( p_encoding ) );
    this_font.charset := sys_context( 'userenv', 'LANGUAGE' );
    this_font.charset := substr( this_font.charset
                               , 1
                               , instr( this_font.charset, '.' )
                               ) || this_font.encoding;
    this_font.cid := upper( p_encoding ) in ( 'CID', 'AL16UTF16', 'UTF', 'UNICODE' );
    this_font.fontname := this_font.name;
    this_font.compress_font := p_compress;
--
    if ( p_embed or this_font.cid ) and t_tables.exists( 'OS/2' )
    then
      dbms_lob.copy( t_blob, p_font, t_tables( 'OS/2' ).length, 1, t_tables( 'OS/2' ).offset );
      if blob2num( t_blob, 2, 9 ) != 2
      then
        this_font.fontfile2 := p_font;
        this_font.ttf_offset := p_offset;
        this_font.name := dbms_random.string( 'u', 6 ) || '+' || this_font.name;
--
        t_blob := dbms_lob.substr( p_font, t_tables( 'loca' ).length, t_tables( 'loca' ).offset );
        declare
          t_size pls_integer := 2 + this_font.indexToLocFormat * 2; -- 0 for short offsets, 1 for long
        begin
          for i in 0 .. this_font.numGlyphs
          loop
            this_font.loca( i ) := blob2num( t_blob, t_size, 1 + i * t_size );
          end loop;
        end;
      end if;
    end if;
--
    if not this_font.cid
    then
      if this_font.flags = 4 -- a symbolic font
      then
        declare
          t_real pls_integer;
        begin
          for t_code in 32 .. 255
          loop
            t_real := this_font.code2glyph.first + t_code - 32; -- assume code 32, space maps to the first code from the font
            if this_font.code2glyph.exists( t_real )
            then
              this_font.first_char := least( nvl( this_font.first_char, 255 ), t_code );
              this_font.last_char := t_code;
              if this_font.hmetrics.exists( this_font.code2glyph( t_real ) )
              then
                this_font.char_width_tab( t_code ) := trunc( this_font.hmetrics( this_font.code2glyph( t_real ) ) * this_font.unit_norm );
              else
                this_font.char_width_tab( t_code ) := trunc( this_font.hmetrics( this_font.hmetrics.last() ) * this_font.unit_norm );
              end if;
            else
              this_font.char_width_tab( t_code ) := trunc( this_font.hmetrics( 0 ) * this_font.unit_norm );
            end if;
          end loop;
        end;
      else
        declare
          t_unicode pls_integer;
          t_prv_diff pls_integer;
          t_utf16_charset varchar2(1000);
          t_winansi_charset varchar2(1000);
          t_glyphname tp_glyphname;
        begin
          t_prv_diff := -1;
          t_utf16_charset := substr( this_font.charset, 1, instr( this_font.charset, '.' ) ) || 'AL16UTF16';
          t_winansi_charset := substr( this_font.charset, 1, instr( this_font.charset, '.' ) ) || 'WE8MSWIN1252';
          for t_code in 32 .. 255
          loop
            t_unicode := utl_raw.cast_to_binary_integer( utl_raw.convert( hextoraw( to_char( t_code, 'fm0x' ) )
                                                                        , t_utf16_charset
                                                                        , this_font.charset
                                                                        )
                                                       );
            t_glyphname := '';
            this_font.char_width_tab( t_code ) := trunc( this_font.hmetrics( this_font.hmetrics.last() ) * this_font.unit_norm );
            if this_font.code2glyph.exists( t_unicode )
            then
              this_font.first_char := least( nvl( this_font.first_char, 255 ), t_code );
              this_font.last_char := t_code;
              if this_font.hmetrics.exists( this_font.code2glyph( t_unicode ) )
              then
                this_font.char_width_tab( t_code ) := trunc( this_font.hmetrics( this_font.code2glyph( t_unicode ) ) * this_font.unit_norm );
              end if;
              if t_glyph2name.exists( this_font.code2glyph( t_unicode ) )
              then
                if t_glyphnames.exists( t_glyph2name( this_font.code2glyph( t_unicode ) ) )
                then
                  t_glyphname := t_glyphnames( t_glyph2name( this_font.code2glyph( t_unicode ) ) );
                end if;
              end if;
            end if;
--
            if (   t_glyphname is not null
               and t_unicode != utl_raw.cast_to_binary_integer( utl_raw.convert( hextoraw( to_char( t_code, 'fm0x' ) )
                                                                               , t_winansi_charset
                                                                               , this_font.charset
                                                                               )
                                                              )
               )
            then
              this_font.diff := this_font.diff || case when t_prv_diff != t_code - 1 then ' ' || t_code end || ' /' || t_glyphname;
              t_prv_diff := t_code;
            end if;
          end loop;
        end;
        if this_font.diff is not null
        then
          this_font.diff := '/Differences [' || this_font.diff || ']';
        end if;
      end if;
    end if;
--
    t_font_ind := g_fonts.count( ) + 1;
    g_fonts( t_font_ind ) := this_font;
/*
--
dbms_output.put_line( this_font.fontname || ' ' || this_font.family || ' ' || this_font.style
|| ' ' || this_font.flags
|| ' ' || this_font.code2glyph.first
|| ' ' || this_font.code2glyph.prior( this_font.code2glyph.last )
|| ' ' || this_font.code2glyph.last
|| ' nr glyphs: ' || this_font.numGlyphs
 ); */
--
    return t_font_ind;
  end;
--
  procedure load_ttf_font
    ( p_font blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    , p_offset number := 1
    )
  is
    t_tmp pls_integer;
  begin
    t_tmp := load_ttf_font( p_font, p_encoding, p_embed, p_compress );
  end;
--
  function load_ttf_font
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'BAUHS93.TTF'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    )
  return pls_integer
  is
  begin
    return load_ttf_font( file2blob( p_dir, p_filename ), p_encoding, p_embed, p_compress );
  end;
--
  procedure load_ttf_font
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'BAUHS93.TTF'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    )
  is
  begin
    load_ttf_font( file2blob( p_dir, p_filename ), p_encoding, p_embed, p_compress );
  end;
--
  procedure load_ttc_fonts
    ( p_ttc blob
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    )
  is
    type tp_font_table is record
      ( offset pls_integer
      , length pls_integer
      );
    type tp_tables is table of tp_font_table index by varchar2(4);
    t_tables tp_tables;
    t_tag varchar2(4);
    t_blob blob;
    t_offset pls_integer;
    t_font_ind pls_integer;
  begin
    if utl_raw.cast_to_varchar2( dbms_lob.substr( p_ttc, 4, 1 ) ) != 'ttcf'
    then
      return;
    end if;
    for f in 0 .. blob2num( p_ttc, 4, 9 ) - 1
    loop
      t_font_ind := load_ttf_font( p_ttc, p_encoding, p_embed, p_compress, blob2num( p_ttc, 4, 13 + f * 4 ) + 1 );
    end loop;
  end;
--
  procedure load_ttc_fonts
    ( p_dir varchar2 := 'MY_FONTS'
    , p_filename varchar2 := 'CAMBRIA.TTC'
    , p_encoding varchar2 := 'WINDOWS-1252'
    , p_embed boolean := false
    , p_compress boolean := true
    )
  is
  begin
    load_ttc_fonts( file2blob( p_dir, p_filename ), p_encoding, p_embed, p_compress );
  end;
--
  function rgb( p_hex_rgb varchar2 )
  return varchar2
  is
  begin
    return to_char_round( nvl( to_number( substr( ltrim( p_hex_rgb, '#' )
                                                , 1, 2 )
                                        , 'xx' ) / 255
                              , 0 )
                         , 5 ) || ' '
        || to_char_round( nvl(   to_number( substr( ltrim( p_hex_rgb, '#' )
                                                , 3, 2 )
                                        , 'xx' ) / 255
                              , 0 )
                         , 5 ) || ' '
        || to_char_round( nvl(   to_number( substr( ltrim( p_hex_rgb, '#' )
                                                , 5, 2 )
                                        , 'xx' ) / 255
                              , 0 )
                         , 5 ) || ' ';
  end;
--
  procedure set_color( p_rgb varchar2 := '000000', p_backgr boolean )
  is
  begin
    txt2page( rgb( p_rgb ) || case when p_backgr then 'RG' else 'rg' end );
  end;
--
  procedure set_color( p_rgb varchar2 := '000000' )
  is
  begin
    set_color( p_rgb, false );
  end;
--
  procedure set_color
    ( p_red number := 0
    , p_green number := 0
    , p_blue number := 0
    )
  is
  begin
    if (     p_red between 0 and 255
       and p_blue  between 0 and 255
       and p_green between 0 and 255
       )
    then
      set_color(  to_char( p_red, 'fm0x' )
               || to_char( p_green, 'fm0x' )
               || to_char( p_blue, 'fm0x' )
               , false
               );
    end if;
  end;
--
  procedure set_bk_color( p_rgb varchar2 := 'ffffff' )
  is
  begin
    set_color( p_rgb, true );
  end;
--
  procedure set_bk_color
    ( p_red number := 0
    , p_green number := 0
    , p_blue number := 0
    )
  is
  begin
    if (     p_red between 0 and 255
       and p_blue  between 0 and 255
       and p_green between 0 and 255
       )
    then
      set_color(  to_char( p_red, 'fm0x' )
               || to_char( p_green, 'fm0x' )
               || to_char( p_blue, 'fm0x' )
               , true
               );
    end if;
  end;
--
  procedure horizontal_line
    ( p_x number
    , p_y number
    , p_width number
    , p_line_width number := 0.5
    , p_line_color varchar2 := '000000'
    )
  is
    t_use_color boolean;
  begin
    txt2page( 'q ' || to_char_round( p_line_width, 5 ) || ' w' );
    t_use_color := substr( p_line_color
                         , -6
                         ) != '000000';
    if t_use_color
    then
      set_color( p_line_color );
      set_bk_color( p_line_color );
    else
      txt2page( '0 g' );
    end if;
    txt2page(  to_char_round( p_x, 5 ) || ' '
            || to_char_round( p_y, 5 ) || ' m '
            || to_char_round( p_x + p_width, 5 ) || ' '
            || to_char_round( p_y, 5 ) || ' l b'
            );
    txt2page( 'Q' );
  end;
--
  procedure vertical_line
    ( p_x number
    , p_y number
    , p_height number
    , p_line_width number := 0.5
    , p_line_color varchar2 := '000000'
    )
  is
    t_use_color boolean;
  begin
    txt2page( 'q ' || to_char_round( p_line_width, 5 ) || ' w' );
    t_use_color := substr( p_line_color
                         , -6
                         ) != '000000';
    if t_use_color
    then
      set_color( p_line_color );
      set_bk_color( p_line_color );
    else
      txt2page( '0 g' );
    end if;
    txt2page(  to_char_round( p_x, 5 ) || ' '
            || to_char_round( p_y, 5 ) || ' m '
            || to_char_round( p_x, 5 ) || ' '
            || to_char_round( p_y + p_height, 5 ) || ' l b'
            );
    txt2page( 'Q' );
  end;
--
  procedure rect
    ( p_x number
    , p_y number
    , p_width number
    , p_height number
    , p_line_color varchar2 := null
    , p_fill_color varchar2 := null
    , p_line_width number := 0.5
    )
  is
  begin
    txt2page( 'q' );
    if substr( p_line_color, -6 ) != substr( p_fill_color, -6 )
    then
      txt2page( to_char_round( p_line_width, 5 ) || ' w' );
    end if;
    if substr( p_line_color, -6 ) != '000000'
    then
      set_bk_color( p_line_color );
    else
      txt2page( '0 g' );
    end if;
    if p_fill_color is not null
    then
      set_color( p_fill_color );
    end if;
    txt2page(  to_char_round( p_x, 5 ) || ' ' || to_char_round( p_y, 5 ) || ' '
            || to_char_round( p_width, 5 ) || ' ' || to_char_round( p_height, 5 ) || ' re '
            || case
                 when p_fill_color is null
                 then 'S'
                 else case when p_line_color is null then 'f' else 'b' end
               end
            );
    txt2page( 'Q' );
  end;
--
  function get( p_what pls_integer )
  return number
  is
  begin
    return case p_what
             when c_get_page_width    then g_settings.page_width
             when c_get_page_height   then g_settings.page_height
             when c_get_margin_top    then g_settings.margin_top
             when c_get_margin_right  then g_settings.margin_right
             when c_get_margin_bottom then g_settings.margin_bottom
             when c_get_margin_left   then g_settings.margin_left
             when c_get_x             then g_x
             when c_get_y             then g_y
             when c_get_fontsize      then g_fonts( g_current_font ).fontsize
             when c_get_current_font  then g_current_font
           end;
  end;
--
  function parse_jpg( p_img_blob blob )
  return tp_img
  is
    buf raw(4);
    t_img tp_img;
    t_ind integer;
  begin
    if (  dbms_lob.substr( p_img_blob, 2, 1 ) != hextoraw( 'FFD8' )                                      -- SOI Start of Image
       or dbms_lob.substr( p_img_blob, 2, dbms_lob.getlength( p_img_blob ) - 1 ) != hextoraw( 'FFD9' )   -- EOI End of Image
       )
    then  -- this is not a jpg I can handle
      return null;
    end if;
--
    t_img.pixels := p_img_blob;
    t_img.type := 'jpg';
    if dbms_lob.substr( t_img.pixels, 2, 3 ) in ( hextoraw( 'FFE0' )  -- a APP0 jpg
                                                , hextoraw( 'FFE1' )  -- a APP1 jpg
                                                )
    then
      t_img.color_res := 8;
      t_img.height := 1;
      t_img.width := 1;
--
      t_ind := 3;
      t_ind := t_ind + 2 + blob2num( t_img.pixels, 2, t_ind + 2 );
      loop
        buf := dbms_lob.substr( t_img.pixels, 2, t_ind );
        exit when buf = hextoraw( 'FFDA' );  -- SOS Start of Scan
        exit when buf = hextoraw( 'FFD9' );  -- EOI End Of Image
        exit when substr( rawtohex( buf ), 1, 2 ) != 'FF';
        if rawtohex( buf ) in ( 'FFD0'                                                          -- RSTn
                              , 'FFD1', 'FFD2', 'FFD3', 'FFD4', 'FFD5', 'FFD6', 'FFD7', 'FF01'  -- TEM
                              )
        then
          t_ind := t_ind + 2;
        else
          if buf = hextoraw( 'FFC0' )       -- SOF0 (Start Of Frame 0) marker
          then
            t_img.color_res := blob2num( t_img.pixels, 1, t_ind + 4 );
            t_img.height    := blob2num( t_img.pixels, 2, t_ind + 5 );
            t_img.width     := blob2num( t_img.pixels, 2, t_ind + 7 );
          end if;
          t_ind := t_ind + 2 + blob2num( t_img.pixels, 2, t_ind + 2 );
        end if;
      end loop;
    end if;
--
    return t_img;
  end;
--
  function parse_png( p_img_blob blob )
  return tp_img
  is
    t_img tp_img;
    buf raw(32767);
    len integer;
    ind integer;
    color_type pls_integer;
  begin
    if rawtohex( dbms_lob.substr( p_img_blob, 8, 1 ) ) != '89504E470D0A1A0A'  -- not the right signature
    then
      return null;
    end if;
    dbms_lob.createtemporary( t_img.pixels, true );
    ind := 9;
    loop
      len := blob2num( p_img_blob, 4, ind );  -- length
      exit when len is null or ind > dbms_lob.getlength( p_img_blob );
      case utl_raw.cast_to_varchar2( dbms_lob.substr( p_img_blob, 4, ind + 4 ) )  -- Chunk type
        when 'IHDR'
        then
          t_img.width     := blob2num( p_img_blob, 4, ind + 8 );
          t_img.height    := blob2num( p_img_blob, 4, ind + 12 );
          t_img.color_res := blob2num( p_img_blob, 1, ind + 16 );
          color_type      := blob2num( p_img_blob, 1, ind + 17 );
          t_img.greyscale := color_type in ( 0, 4 );
        when 'PLTE'
        then
          t_img.color_tab := dbms_lob.substr( p_img_blob, len, ind + 8 );
        when 'IDAT'
        then
          dbms_lob.copy( t_img.pixels, p_img_blob, len, dbms_lob.getlength( t_img.pixels ) + 1, ind + 8 );
        when 'IEND'
        then
          exit;
        else
          null;
      end case;
      ind := ind + 4 + 4 + len + 4;  -- Length + Chunk type + Chunk data + CRC
    end loop;
--
    t_img.type := 'png';
    t_img.nr_colors := case color_type
                         when 0 then 1
                         when 2 then 3
                         when 3 then 1
                         when 4 then 2
                         else 4
                       end;
--
    return t_img;
  end;
--
  function lzw_decompress
    ( p_blob blob
    , p_bits pls_integer
    )
  return blob
  is
    powers tp_pls_tab;
--
    g_lzw_ind pls_integer;
    g_lzw_bits pls_integer;
    g_lzw_buffer pls_integer;
    g_lzw_bits_used pls_integer;
--
    type tp_lzw_dict is table of raw(1000) index by pls_integer;
    t_lzw_dict tp_lzw_dict;
    t_clr_code pls_integer;
    t_nxt_code pls_integer;
    t_new_code pls_integer;
    t_old_code pls_integer;
    t_blob blob;
--
    function get_lzw_code
    return pls_integer
    is
      t_rv pls_integer;
    begin
      while g_lzw_bits_used < g_lzw_bits
      loop
        g_lzw_ind := g_lzw_ind + 1;
        g_lzw_buffer := blob2num( p_blob, 1, g_lzw_ind ) * powers( g_lzw_bits_used ) + g_lzw_buffer;
        g_lzw_bits_used := g_lzw_bits_used + 8;
      end loop;
      t_rv := bitand( g_lzw_buffer, powers( g_lzw_bits ) - 1 );
      g_lzw_bits_used := g_lzw_bits_used - g_lzw_bits;
      g_lzw_buffer := trunc( g_lzw_buffer / powers( g_lzw_bits ) );
      return t_rv;
    end;
--
  begin
    for i in 0 .. 30
    loop
      powers( i ) := power( 2, i );
    end loop;
--
    t_clr_code := powers( p_bits - 1 );
    t_nxt_code := t_clr_code + 2;
    for i in 0 .. least( t_clr_code - 1, 255 )
    loop
      t_lzw_dict( i ) := hextoraw( to_char( i, 'fm0X' ) );
    end loop;
    dbms_lob.createtemporary( t_blob, true );
    g_lzw_ind := 0;
    g_lzw_bits := p_bits;
    g_lzw_buffer := 0;
    g_lzw_bits_used := 0;
--
    t_old_code := null;
    t_new_code := get_lzw_code( );
    loop
      case nvl( t_new_code, t_clr_code + 1 )
        when t_clr_code + 1
        then
          exit;
        when t_clr_code
        then
          t_new_code := null;
          g_lzw_bits := p_bits;
          t_nxt_code := t_clr_code + 2;
        else
          if t_new_code = t_nxt_code
          then
            t_lzw_dict( t_nxt_code ) :=
              utl_raw.concat( t_lzw_dict( t_old_code )
                            , utl_raw.substr( t_lzw_dict( t_old_code ), 1, 1 )
                            );
            dbms_lob.append( t_blob, t_lzw_dict( t_nxt_code ) );
            t_nxt_code := t_nxt_code + 1;
          elsif t_new_code > t_nxt_code
          then
            exit;
          else
            dbms_lob.append( t_blob, t_lzw_dict( t_new_code ) );
            if t_old_code is not null
            then
              t_lzw_dict( t_nxt_code ) := utl_raw.concat( t_lzw_dict( t_old_code )
                                                        , utl_raw.substr( t_lzw_dict( t_new_code ), 1, 1 )
                                                        );
              t_nxt_code := t_nxt_code + 1;
            end if;
          end if;
          if     bitand( t_nxt_code, powers( g_lzw_bits ) - 1 ) = 0
             and g_lzw_bits < 12
          then
            g_lzw_bits := g_lzw_bits + 1;
          end if;
      end case;
      t_old_code := t_new_code;
      t_new_code := get_lzw_code( );
    end loop;
    t_lzw_dict.delete;
--
    return t_blob;
  end;
--
  function parse_gif( p_img_blob blob )
  return tp_img
  is
    img tp_img;
    buf raw(4000);
    ind integer;
    t_len pls_integer;
  begin
    if dbms_lob.substr( p_img_blob, 3, 1 ) != utl_raw.cast_to_raw( 'GIF' )
    then
      return null;
    end if;
    ind := 7;
    buf := dbms_lob.substr( p_img_blob, 7, 7 );  --  Logical Screen Descriptor
    ind := ind + 7;
    img.color_res := raw2num( utl_raw.bit_and( utl_raw.substr( buf, 5, 1 ), hextoraw( '70' ) ) ) / 16 + 1;
    img.color_res := 8;
    if raw2num( buf, 5, 1 ) > 127
    then
      t_len := 3 * power( 2, raw2num( utl_raw.bit_and( utl_raw.substr( buf, 5, 1 ), hextoraw( '07' ) ) ) + 1 );
      img.color_tab := dbms_lob.substr( p_img_blob, t_len, ind  ); -- Global Color Table
      ind := ind + t_len;
    end if;
--
    loop
      case dbms_lob.substr( p_img_blob, 1, ind )
        when hextoraw( '3B' ) -- trailer
        then
          exit;
        when hextoraw( '21' ) -- extension
        then
          if dbms_lob.substr( p_img_blob, 1, ind + 1 ) = hextoraw( 'F9' )
          then -- Graphic Control Extension
            if utl_raw.bit_and( dbms_lob.substr( p_img_blob, 1, ind + 3 ), hextoraw( '01' ) ) = hextoraw( '01' )
            then -- Transparent Color Flag set
              img.transparancy_index := blob2num( p_img_blob, 1, ind + 6 );
            end if;
          end if;
          ind := ind + 2; -- skip sentinel + label
          loop
            t_len := blob2num( p_img_blob, 1, ind ); -- Block Size
            exit when t_len = 0;
            ind := ind + 1 + t_len; -- skip Block Size + Data Sub-block
          end loop;
          ind := ind + 1;           -- skip last Block Size
        when hextoraw( '2C' )       -- image
        then
          declare
            img_blob blob;
            min_code_size pls_integer;
            code_size pls_integer;
            flags raw(1);
          begin
            img.width := utl_raw.cast_to_binary_integer( dbms_lob.substr( p_img_blob, 2, ind + 5 )
                                                       , utl_raw.little_endian
                                                       );
            img.height := utl_raw.cast_to_binary_integer( dbms_lob.substr( p_img_blob, 2, ind + 7 )
                                                        , utl_raw.little_endian
                                                        );
            img.greyscale := false;
            ind := ind + 1 + 8;                   -- skip sentinel + img sizes
            flags := dbms_lob.substr( p_img_blob, 1, ind );
            if utl_raw.bit_and( flags, hextoraw( '80' ) ) = hextoraw( '80' )
            then
              t_len := 3 * power( 2, raw2num( utl_raw.bit_and( flags, hextoraw( '07' ) ) ) + 1 );
              img.color_tab := dbms_lob.substr( p_img_blob, t_len, ind + 1 );          -- Local Color Table
            end if;
            ind := ind + 1;                                -- skip image Flags
            min_code_size := blob2num( p_img_blob, 1, ind );
            ind := ind + 1;                      -- skip LZW Minimum Code Size
            dbms_lob.createtemporary( img_blob, true );
            loop
              t_len := blob2num( p_img_blob, 1, ind ); -- Block Size
              exit when t_len = 0;
              dbms_lob.append( img_blob, dbms_lob.substr( p_img_blob, t_len, ind + 1 ) ); -- Data Sub-block
              ind := ind + 1 + t_len;      -- skip Block Size + Data Sub-block
            end loop;
            ind := ind + 1;                            -- skip last Block Size
            img.pixels := lzw_decompress( img_blob, min_code_size + 1 );
--
            if utl_raw.bit_and( flags, hextoraw( '40' ) ) = hextoraw( '40' )
            then                                        --  interlaced
              declare
                pass pls_integer;
                pass_ind tp_pls_tab;
              begin
                dbms_lob.createtemporary( img_blob, true );
                pass_ind( 1 ) := 1;
                pass_ind( 2 ) := trunc( ( img.height - 1 ) / 8 ) + 1;
                pass_ind( 3 ) := pass_ind( 2 ) + trunc( ( img.height + 3 ) / 8 );
                pass_ind( 4 ) := pass_ind( 3 ) + trunc( ( img.height + 1 ) / 4 );
                pass_ind( 2 ) := pass_ind( 2 ) * img.width + 1;
                pass_ind( 3 ) := pass_ind( 3 ) * img.width + 1;
                pass_ind( 4 ) := pass_ind( 4 ) * img.width + 1;
                for i in 0 .. img.height - 1
                loop
                  pass := case mod( i, 8 )
                            when 0 then 1
                            when 4 then 2
                            when 2 then 3
                            when 6 then 3
                            else 4
                          end;
                  dbms_lob.append( img_blob, dbms_lob.substr( img.pixels, img.width, pass_ind( pass ) ) );
                  pass_ind( pass ) := pass_ind( pass ) + img.width;
                end loop;
                img.pixels := img_blob;
              end;
            end if;
--
            dbms_lob.freetemporary( img_blob );
          end;
        else
          exit;
      end case;
    end loop;
--
    img.type := 'gif';
    return img;
  end;
--
  function parse_img
    ( p_blob in blob
    , p_adler32 in varchar2 := null
    , p_type in varchar2 := null
    )
  return tp_img
  is
    t_img tp_img;
  begin
    t_img.type := p_type;
    if t_img.type is null
    then
      if rawtohex( dbms_lob.substr( p_blob, 8, 1 ) ) = '89504E470D0A1A0A'
      then
        t_img.type := 'png';
      elsif dbms_lob.substr( p_blob , 3, 1 ) = utl_raw.cast_to_raw( 'GIF' )
      then
        t_img.type := 'gif';
      else
        t_img.type := 'jpg';
      end if;
    end if;
--
    t_img := case lower( t_img.type )
               when 'gif' then parse_gif( p_blob )
               when 'png' then parse_png( p_blob )
               when 'jpg' then parse_jpg( p_blob )
               else null
             end;
--
    if t_img.type is not null
    then
      t_img.adler32 := coalesce( p_adler32, adler32( p_blob ) );
    end if;
    return t_img;
  end;
--
  procedure put_image
    ( p_img blob
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
  )
  is
    t_x number;
    t_y number;
    t_img tp_img;
    t_ind pls_integer;
    t_adler32 varchar2(8):=p_adler32;
  begin
    if p_img is null
    then
      return;
    end if;
    if t_adler32 is null then
      t_adler32 := adler32( p_img );
    end if;
    t_ind := g_images.first;
    while t_ind is not null
    loop
      exit when g_images( t_ind ).adler32 = t_adler32;
      t_ind := g_images.next( t_ind );
    end loop;
--
    if t_ind is null
    then
      t_img := parse_img( p_img, t_adler32 );
      if t_img.adler32 is null
      then
        return;
      end if;
      t_ind := g_images.count( ) + 1;
      g_images( t_ind ) := t_img;
    end if;
--
    t_x := case substr( upper( p_align ), 1, 1 )
             when 'L' then p_x -- left
             when 'S' then p_x -- start
             when 'R' then p_x + nvl( p_width, 0 ) - g_images( t_ind ).width -- right
             when 'E' then p_x + nvl( p_width, 0 ) - g_images( t_ind ).width -- end
             else ( p_x + nvl( p_width, 0 ) - g_images( t_ind ).width ) / 2       -- center
           end;
    t_y := case substr( upper( p_valign ), 1, 1 )
             when 'C' then ( p_y - nvl( p_height, 0 ) + g_images( t_ind ).height ) / 2  -- center
             when 'B' then p_y - nvl( p_height, 0 ) + g_images( t_ind ).height -- bottom
             else p_y                                          -- top
           end;
--
    txt2page( 'q ' || to_char_round( least( nvl( p_width, g_images( t_ind ).width ), g_images( t_ind ).width ) )
            || ' 0 0 ' || to_char_round( least( nvl( p_height, g_images( t_ind ).height ), g_images( t_ind ).height ) )
            || ' ' || to_char_round( t_x ) || ' ' || to_char_round( t_y )
            || ' cm /I' || to_char( t_ind ) || ' Do Q'
            );
  end;
--
  procedure put_image
    ( p_dir varchar2
    , p_file_name varchar2
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
  )
  is
    t_blob blob;
  begin
    t_blob := file2blob( p_dir
                       , p_file_name
                       );
    put_image( t_blob
             , p_x
             , p_y
             , p_width
             , p_height
             , p_align
             , p_valign
             , p_adler32
             );
    dbms_lob.freetemporary( t_blob );
  end;
--
  procedure put_image
    ( p_url varchar2
    , p_x number
    , p_y number
    , p_width number := null
    , p_height number := null
    , p_align varchar2 := 'center'
    , p_valign varchar2 := 'top'
    , p_adler32 varchar2 := null
    )
  is
    t_blob blob;
  begin
    t_blob := httpuritype( p_url ).getblob( );
    put_image( t_blob
             , p_x
             , p_y
             , p_width
             , p_height
             , p_align
             , p_valign
             , p_adler32
             );
    dbms_lob.freetemporary( t_blob );
  end;
--
  procedure set_page_proc( p_src clob )
  is
  begin
    g_page_prcs( g_page_prcs.count ) := p_src;
  end;
--
  procedure cursor2table
    ( p_c integer
    , p_widths tp_col_widths := null
    , p_headers tp_headers := null
    )
  is
    t_col_cnt integer;
$IF DBMS_DB_VERSION.VER_LE_10 $THEN
    t_desc_tab dbms_sql.desc_tab2;
$ELSE
    t_desc_tab dbms_sql.desc_tab3;
$END
    d_tab dbms_sql.date_table;
    n_tab dbms_sql.number_table;
    v_tab dbms_sql.varchar2_table;
    t_bulk_size pls_integer := 200;
    t_r integer;
    t_cur_row pls_integer;
    type tp_integer_tab is table of integer;
    t_chars tp_integer_tab := tp_integer_tab( 1, 8, 9, 96, 112 );
    t_dates tp_integer_tab := tp_integer_tab( 12, 178, 179, 180, 181 , 231 );
    t_numerics tp_integer_tab := tp_integer_tab( 2, 100, 101 );
    t_widths tp_col_widths;
    t_tmp number;
    t_x number;
    t_y number;
    t_start_x number;
    t_lineheight number;
    t_padding number := 2;
    t_num_format varchar2(100) := 'tm9';
    t_date_format varchar2(100) := 'dd.mm.yyyy';
    t_txt varchar2(32767);
    c_rf number := 0.2; -- raise factor of text above cell bottom
--
    procedure show_header
    is
    begin
      if p_headers is not null and p_headers.count > 0
      then
        t_x := t_start_x;
        for c in 1 .. t_col_cnt
        loop
          rect( t_x, t_y, t_widths( c ), t_lineheight );
          if c <= p_headers.count
          then
            put_txt( t_x + t_padding, t_y + c_rf * t_lineheight, p_headers( c ) );
          end if;
          t_x := t_x + t_widths( c );
        end loop;
        t_y := t_y - t_lineheight;
      end if;
    end;
--
  begin
$IF DBMS_DB_VERSION.VER_LE_10 $THEN
    dbms_sql.describe_columns2( p_c, t_col_cnt, t_desc_tab );
$ELSE
    dbms_sql.describe_columns3( p_c, t_col_cnt, t_desc_tab );
$END
    if p_widths is null or p_widths.count < t_col_cnt
    then
      t_tmp := get( c_get_page_width ) - get( c_get_margin_left ) - get( c_get_margin_right );
      t_widths := tp_col_widths();
      t_widths.extend( t_col_cnt );
      for c in 1 .. t_col_cnt
      loop
        t_widths( c ) := round( t_tmp / t_col_cnt, 1 );
      end loop;
    else
      t_widths := p_widths;
    end if;
--
    if get( c_get_current_font ) is null
    then
      set_font( 'helvetica', 12 );
    end if;
--
    for c in 1 .. t_col_cnt
    loop
      case
        when t_desc_tab( c ).col_type member of t_numerics
        then
          dbms_sql.define_array( p_c, c, n_tab, t_bulk_size, 1 );
        when t_desc_tab( c ).col_type member of t_dates
        then
          dbms_sql.define_array( p_c, c, d_tab, t_bulk_size, 1 );
        when t_desc_tab( c ).col_type member of t_chars
        then
          dbms_sql.define_array( p_c, c, v_tab, t_bulk_size, 1 );
        else
          null;
      end case;
    end loop;
--
    t_start_x := get( c_get_margin_left );
    t_lineheight := get( c_get_fontsize ) * 1.2;
    t_y := coalesce( get( c_get_y ) - t_lineheight, get( c_get_page_height ) - get( c_get_margin_top ) ) - t_lineheight;
--
    show_header;
--
    loop
      t_r := dbms_sql.fetch_rows( p_c );
      for i in 0 .. t_r - 1
      loop
        if t_y < get( c_get_margin_bottom )
        then
          new_page;
          t_y := get( c_get_page_height ) - get( c_get_margin_top ) - t_lineheight;
          show_header;
        end if;
        t_x := t_start_x;
        for c in 1 .. t_col_cnt
        loop
          case
            when t_desc_tab( c ).col_type member of t_numerics
            then
              n_tab.delete;
              dbms_sql.column_value( p_c, c, n_tab );
              rect( t_x, t_y, t_widths( c ), t_lineheight );
              t_txt := to_char( n_tab( i + n_tab.first() ), t_num_format );
              if t_txt is not null
              then
                put_txt( t_x + t_widths( c ) - t_padding - str_len( t_txt ), t_y + c_rf * t_lineheight, t_txt );
              end if;
              t_x := t_x + t_widths( c );
            when t_desc_tab( c ).col_type member of t_dates
            then
              d_tab.delete;
              dbms_sql.column_value( p_c, c, d_tab );
              rect( t_x, t_y, t_widths( c ), t_lineheight );
              t_txt := to_char( d_tab( i + d_tab.first() ), t_date_format );
              if t_txt is not null
              then
                put_txt( t_x + t_padding, t_y + c_rf * t_lineheight, t_txt );
              end if;
              t_x := t_x + t_widths( c );
            when t_desc_tab( c ).col_type member of t_chars
            then
              v_tab.delete;
              dbms_sql.column_value( p_c, c, v_tab );
              rect( t_x, t_y, t_widths( c ), t_lineheight );
              t_txt := v_tab( i + v_tab.first() );
              if t_txt is not null
              then
                put_txt( t_x + t_padding, t_y + c_rf * t_lineheight, t_txt );
              end if;
              t_x := t_x + t_widths( c );
            else
              null;
          end case;
        end loop;
        t_y := t_y - t_lineheight;
      end loop;
      exit when t_r != t_bulk_size;
    end loop;
    g_y := t_y;
  end;
--
  procedure query2table
    ( p_query varchar2
    , p_widths tp_col_widths := null
    , p_headers tp_headers := null
    )
  is
    t_cx integer;
    t_dummy integer;
  begin
    t_cx := dbms_sql.open_cursor;
    dbms_sql.parse( t_cx, p_query, dbms_sql.native );
    t_dummy := dbms_sql.execute( t_cx );
    cursor2table( t_cx, p_widths, p_headers );
    dbms_sql.close_cursor( t_cx );
  end;
  PROCEDURE PR_GOTO_PAGE(i_nPage IN NUMBER) IS
  BEGIN
    IF i_nPage<=g_pages.count THEN
      g_page_nr:=i_nPage-1;
    END IF;
  END;
  PROCEDURE PR_GOTO_CURRENT_PAGE IS
  BEGIN
    g_page_nr:=NULL;
  END;
  FUNCTION FK_GET_PAGE
  RETURN NUMBER IS
  BEGIN
    RETURN g_page_nr;
  END;
  PROCEDURE PR_LINE(i_nX1         IN NUMBER,
                    i_nY1         IN NUMBER,
                    i_nX2         IN NUMBER,
                    i_nY2         IN NUMBER,
                    i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                    i_nLineWidth  IN NUMBER DEFAULT 0.5,
                    i_vcStroke    IN VARCHAR2 DEFAULT NULL
                   ) IS
  BEGIN
    txt2page('q ' );
    txt2page(to_char_round(i_nLineWidth, 5 ) || ' w' );
    IF SUBSTR(i_vcLineColor, -6 ) != '000000' THEN
      set_bk_color(i_vcLineColor);
    ELSE
      txt2page( '0 g' );
    END IF;
    txt2page('n ');
    IF i_vcStroke IS NOT NULL THEN
      txt2page(i_vcStroke || ' d ');
    END IF;
    txt2page(to_char_round(i_nX1, 5) || ' ' || to_char_round(i_nY1, 5) || ' m ');
    txt2page(to_char_round(i_nX2, 5) || ' ' || to_char_round(i_nY2, 5) || ' l S Q');
  END;
  PROCEDURE PR_POLYGON(i_lXs         IN tVertices,
                       i_lYs         IN tVertices,
                       i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                       i_vcFillColor IN VARCHAR2 DEFAULT NULL,
                       i_nLineWidth  IN NUMBER DEFAULT 0.5
                      ) IS
    vcBuffer VARCHAR2(32767);
  BEGIN
    IF i_lXs.COUNT>0 AND i_lXs.COUNT=i_lYs.COUNT THEN
      txt2page('q ' );
      IF SUBSTR(i_vcLineColor, -6 ) != SUBSTR(i_vcFillColor, -6 ) THEN
        txt2page( to_char_round(i_nLineWidth, 5 ) || ' w' );
      END IF;
      IF SUBSTR(i_vcLineColor, -6 ) != '000000' THEN
        set_bk_color(i_vcLineColor);
      ELSE
        txt2page( '0 g' );
      END IF;
      IF i_vcFillColor IS NOT NULL THEN
        set_color(i_vcFillColor);
      END IF;
      txt2page(' 2.00000 M ');
      txt2page('n ');
      vcBuffer:=to_char_round(i_lXs(1), 5) || ' ' || to_char_round(i_lYs(1), 5) || ' m ';
      FOR i IN 2..i_lXs.COUNT LOOP
        vcBuffer:=vcBuffer || to_char_round(i_lXs(i), 5) || ' ' || to_char_round(i_lYs(i), 5) || ' l ';
      END LOOP;
      vcBuffer:=vcBuffer || to_char_round(i_lXs(1), 5) || ' ' || to_char_round(i_lYs(1), 5) || ' l ';
      vcBuffer:=vcBuffer || CASE WHEN i_vcFillColor IS NULL THEN
                               'S'
                            ELSE CASE WHEN i_vcLineColor IS NULL THEN
                                   'f'
                                 ELSE
                                   'b'
                                 END
                            END;
      txt2page( vcBuffer || ' Q' );
    END IF;
  END;
  PROCEDURE PR_PATH(i_lPath       IN tPath,
                    i_vcLineColor IN VARCHAR2 DEFAULT NULL,
                    i_vcFillColor IN VARCHAR2 DEFAULT NULL,
                    i_nLineWidth  IN NUMBER DEFAULT 0.5
                   ) IS
    vcBuffer VARCHAR2(32767);
  BEGIN
    txt2page('q ' );
    IF SUBSTR(i_vcLineColor, -6) != SUBSTR(i_vcFillColor, -6) THEN
      txt2page(to_char_round(i_nLineWidth, 5) || ' w' );
    END IF;
    IF SUBSTR(i_vcLineColor, -6) != '000000' THEN
      set_bk_color(i_vcLineColor);
    ELSE
      txt2page('0 g');
    END IF;
    IF i_vcFillColor IS NOT NULL THEN
      set_color(i_vcFillColor);
    END IF;
    txt2page('n ');
    FOR i IN 1..i_lPath.COUNT LOOP
      IF i_lPath(i).nType=PATH_MOVE_TO THEN
        vcBuffer:=vcBuffer|| to_char_round( i_lPath(i).nVal1, 5 ) || ' ' ||
                             to_char_round( i_lPath(i).nVal2, 5 ) || ' m ';
      ELSIF i_lPath(i).nType=PATH_LINE_TO THEN
        vcBuffer:=vcBuffer || to_char_round( i_lPath(i).nVal1, 5 ) || ' ' ||
                              to_char_round( i_lPath(i).nVal2, 5 ) || ' l ';
      ELSIF i_lPath(i).nType=PATH_CURVE_TO THEN
        vcBuffer:=vcBuffer || to_char_round( i_lPath(i).nVal1,5)  || ' ' ||
                              to_char_round( i_lPath(i).nVal2,5)  || ' ' ||
                              to_char_round( i_lPath(i).nVal3,5)  || ' ' ||
                              to_char_round( i_lPath(i).nVal4,5)  || ' ' ||
                              to_char_round( i_lPath(i).nVal5,5)  || ' ' ||
                              to_char_round( i_lPath(i).nVal6,5)  || ' c ';
      ELSIF i_lPath(i).nType=PATH_CLOSE THEN
        vcBuffer:=vcBuffer || CASE WHEN i_vcFillColor IS NULL THEN
                                'S'
                               ELSE CASE WHEN i_vcLineColor IS NULL THEN
                                      'f'
                                    ELSE
                                      'b'
                                    END
                               END;
      END IF;
    END LOOP;
    txt2page( vcBuffer || ' Q' );
  END;
$IF not DBMS_DB_VERSION.VER_LE_10 $THEN
--
  procedure refcursor2table
    ( p_rc sys_refcursor
    , p_widths tp_col_widths := null
    , p_headers tp_headers := null
    )
  is
    t_cx integer;
    t_rc sys_refcursor;
  begin
    t_rc := p_rc;
    t_cx := dbms_sql.to_cursor_number( t_rc );
    cursor2table( t_cx, p_widths, p_headers );
    dbms_sql.close_cursor( t_cx );
  end;
$END
begin
  for i IN 0..255 LOOP
    lHex(TO_CHAR(i, 'FM0X')):=i;
  end loop;
end;
/
create or replace PACKAGE BODY pkg_utils IS
  FUNCTION app_error_handling (
    p_error IN apex_error.t_error
  ) RETURN apex_error.t_error_result IS
    l_result apex_error.t_error_result;
    l_msg    VARCHAR2(4000);
  BEGIN
    -- Inicializar el resultado est�ndar
    l_result := apex_error.init_error_result(p_error);

    --------------------------------------------------------------------
    -- 1. Errores personalizados (RAISE_APPLICATION_ERROR)
    --------------------------------------------------------------------
    IF NVL(p_error.ora_sqlcode, 0) BETWEEN -20999 AND -20000 THEN
      l_msg := p_error.ora_sqlerrm;
      l_msg := REGEXP_REPLACE(l_msg, '^ORA-\d{5}:\s*', ''); -- limpiar ORA-20001:
      l_result.message := l_msg;
      l_result.display_location := apex_error.c_inline_in_notification;
      RETURN l_result;
    END IF;

    --------------------------------------------------------------------
    -- 2. Errores t�picos de Oracle (constraints, nulls, etc.)
    --------------------------------------------------------------------
    CASE p_error.ora_sqlcode
      WHEN -1 THEN -- ORA-00001 Unique/PK
        l_result.message := 'Ya existe un registro con este valor (duplicado no permitido).';
        l_result.display_location := apex_error.c_inline_in_notification;
        RETURN l_result;

      WHEN -1400 THEN -- ORA-01400 Not null
        l_result.message := 'El campo obligatorio no puede quedar vac�o.';
        l_result.display_location := apex_error.c_inline_in_notification;
        RETURN l_result;

      WHEN -2291 THEN -- ORA-02291 Parent key not found
        l_result.message := 'No se puede insertar/modificar: el valor no existe en la tabla relacionada.';
        l_result.display_location := apex_error.c_inline_in_notification;
        RETURN l_result;

      WHEN -2292 THEN -- ORA-02292 Child record found
        l_result.message := 'No se puede eliminar: existen registros relacionados en otra tabla.';
        l_result.display_location := apex_error.c_inline_in_notification;
        RETURN l_result;

      ELSE
        NULL; -- otros errores quedan como est�n
    END CASE;

    RETURN l_result;
  END app_error_handling;
END pkg_utils;
/
create or replace PACKAGE BODY pk_jrxml2pdf_apex2jrxml IS
  TYPE tRegionData IS RECORD (
    nRegionId         NUMBER,
    vcDisplayPosition PK_JRXML2PDF_TYPES.tMaxVarchar2,
    nColumn           NUMBER,
    nRegionTemplateId NUMBER,
    nColumnTemplateId NUMBER,
    nLabelTemplateId  NUMBER,
    nItemTemplateId   NUMBER,
    nImageTemplateId  NUMBER
  );
  TYPE tRegionDataList IS TABLE OF tRegionData INDEX BY BINARY_INTEGER;
  TYPE tColumn IS RECORD (
    nWidth NUMBER
  );

  TYPE tColumnList IS TABLE OF tColumn INDEX BY PK_JRXML2PDF_TYPES.tIndex;
  TYPE tColumnListList IS TABLE OF tColumnList INDEX BY PK_JRXML2PDF_TYPES.tIndex;

  TYPE tTemplate IS RECORD (
    clTemplate    CLOB
  );
  TYPE tParamList IS TABLE OF PK_JRXML2PDF_TYPES.tIndex INDEX BY PK_JRXML2PDF_TYPES.tIndex;
  DELIMITERS   CONSTANT VARCHAR2(20):='),;|&+-*&(!=<> ' || CHR(9) || CHR(10) || CHR(13);
  TABLEHEADER1TEMPLATE CONSTANT VARCHAR2(32000):=
  '                 <datasetRun subDataset="#REGIONID#">' || CHR(10);

  TABLEPARAMTEMPLATE CONSTANT VARCHAR2(32000):=
  '                        <datasetParameter name="#PARAMETER#">' || CHR(10) ||
  '                            <datasetParameterExpression><![CDATA[$P{#PARAMETER#}]]></datasetParameterExpression>' || CHR(10) ||
  '                        </datasetParameter>' || CHR(10);

  TABLEHEADER2TEMPLATE CONSTANT VARCHAR2(32000):=
  '                     <connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>' || CHR(10) ||
  '                 </datasetRun>' || CHR(10);
  PROCEDURE PR_INIT_COLLECTION(i_nApplicationId IN NUMBER,
                               i_nPageid        IN NUMBER) IS

    CURSOR crRegions IS
      SELECT REGION_ID        C001,
             REGION_NAME      C002,
             SOURCE_TYPE      C003,
             'Y'              C004,
             DISPLAY_POSITION_CODE C005,
             DISPLAY_COLUMN   C006,
             DISPLAY_SEQUENCE N001
        FROM APEX_APPLICATION_PAGE_REGIONS
       WHERE APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageid
         AND SOURCE_TYPE IN ('Report', 'Tabular Form', 'HTML/Text', 'Interactive Report')
       ORDER BY DISPLAY_SEQUENCE;

    vcQuery PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nTemplateTabRegion  NUMBER;
    nTemplateTabColumn  NUMBER;
    nTemplateTabItem    NUMBER;
    nTemplateTabLabel   NUMBER;
    nTemplateTabImage   NUMBER;
    nTemplateFormRegion NUMBER;
    nTemplateFormItem   NUMBER;
    nTemplateFormLabel  NUMBER;
    nTemplateFormImage  NUMBER;

    FUNCTION FK_GET_TEMPLATE_ID(i_vcType IN VARCHAR2)
    RETURN NUMBER IS
      CURSOR crTemplate IS
        SELECT JAT_ID
          FROM JRXML_APEX2JRXML_TEMPLATES
         WHERE JAT_TYPE=i_vcType
           AND JAT_STANDARD='Y';
      nResult NUMBER;
    BEGIN
      OPEN crTemplate;
      FETCh crTemplate INTO nResult;
      CLOSE crTemplate;
      RETURN nResult;
    END;
  BEGIN
    -- Create new Collection
    APEX_COLLECTION.CREATE_OR_TRUNCATE_COLLECTION('JRXML');
    -- initialize default-templates
    nTemplateTabRegion :=FK_GET_TEMPLATE_ID('TR');
    nTemplateTabColumn :=FK_GET_TEMPLATE_ID('TC');
    nTemplateTabItem   :=FK_GET_TEMPLATE_ID('TI');
    nTemplateTabLabel  :=FK_GET_TEMPLATE_ID('TH');
    nTemplateTabImage  :=FK_GET_TEMPLATE_ID('IT');
    nTemplateFormRegion:=FK_GET_TEMPLATE_ID('FR');
    nTemplateFormItem  :=FK_GET_TEMPLATE_ID('FI');
    nTemplateFormLabel :=FK_GET_TEMPLATE_ID('FL');
    nTemplateFormImage :=FK_GET_TEMPLATE_ID('IF');

    FOR rec IN crRegions LOOP
      IF rec.C003='HTML/Text' THEN
        APEX_COLLECTION.ADD_MEMBER (p_collection_name =>'JRXML',
                                    p_c001            =>rec.C001,
                                    p_c002            =>rec.C002,
                                    p_c003            =>rec.C003,
                                    p_c004            =>rec.C004,
                                    p_c005            =>rec.C005,
                                    p_c006            =>rec.C006,
                                    p_c011            =>nTemplateFormRegion,
                                    p_c012            =>NULL,
                                    p_c013            =>nTemplateFormLabel,
                                    p_c014            =>nTemplateFormItem,
                                    p_c015            =>nTemplateFormImage,
                                    p_n001            =>rec.N001);
      ELSE
        APEX_COLLECTION.ADD_MEMBER (p_collection_name =>'JRXML',
                                    p_c001            =>rec.C001,
                                    p_c002            =>rec.C002,
                                    p_c003            =>rec.C003,
                                    p_c004            =>rec.C004,
                                    p_c005            =>rec.C005,
                                    p_c006            =>rec.C006,
                                    p_c011            =>nTemplateTabRegion,
                                    p_c012            =>nTemplateTabColumn,
                                    p_c013            =>nTemplateTabLabel,
                                    p_c014            =>nTemplateTabItem,
                                    p_c015            =>nTemplateTabImage,
                                    p_n001            =>rec.N001);
      END IF;
    END LOOP;

  END;

  FUNCTION FK_GET_TEMPLATE(i_nId IN NUMBER)
  RETURN CLOB IS
    CURSOR crTemplate IS
      SELECT JAT_TEMPLATE_START
        FROM JRXML_APEX2JRXML_TEMPLATES
       WHERE JAT_ID=i_nId;
    clTemplate CLOB;
  BEGIN
    OPEN crTemplate;
    FETCh crTemplate INTO clTemplate;
    CLOSE crTemplate;
    RETURN clTemplate;
  END;
  FUNCTION FK_REVERSE_PATTERN(i_vcPattern IN VARCHAR2)
  RETURN VARCHAR2 IS
    CURRENCYPATTERN     CONSTANT VARCHAR2(4) :=UNISTR('\00A4');
    ISOCURRENCYPATTERN  CONSTANT VARCHAR2(8) :=UNISTR('\00A4\00A4');
    vcResult PK_JRXML2PDF_TYPES.tPattern;
  BEGIN
    IF    INSTR(i_vcPattern, '9')>0
       OR INSTR(i_vcPattern, '0')>0 THEN
      -- Num-Pattern
      vcResult:=TRANSLATE(i_vcPattern, '#0.,', '90DG');
      vcResult:=REPLACE(vcResult, 'C', ISOCURRENCYPATTERN);
      vcResult:=REPLACE(vcResult, 'L', CURRENCYPATTERN);
      vcResult:=REPLACE(vcResult, 'FM', '');
    ELSIF i_vcPattern IS NOT NULL THEN
      -- date-pattern
      vcResult:=PK_JRXML2PDF_UTIL.FK_JAVA_DATE_PATTERN(i_vcPattern);
    END IF;
    RETURN vcResult;
  END;
  PROCEDURE PR_GET_TEMPLATES(i_nId            IN  NUMBER,
                             o_clStart        OUT CLOB,
                             o_clEnd          OUT CLOB,
                             o_nContentWidth  OUT NUMBER,
                             o_nHeightOffset  OUT NUMBER)
  IS
    CURSOR crTemplate IS
      SELECT JAT_TEMPLATE_START,
             JAT_TEMPLATE_END,
             JAT_CONTENT_WIDTH,
             JAT_HEIGHT_OFFSET
        FROM JRXML_APEX2JRXML_TEMPLATES
       WHERE JAT_ID=i_nId;
  BEGIN
    OPEN crTemplate;
    FETCh crTemplate INTO o_clStart,
                          o_clEnd,
                          o_nContentWidth,
                          o_nHeightOffset;
    CLOSE crTemplate;
  END;
  FUNCTION FK_REPLACE_IN_CLOB(i_clData IN CLOB, i_vcReplace IN VARCHAR2, i_vcReplaceWith IN CLOB)
  RETURN CLOB IS
    clTemp   CLOB;
    clTemp2  CLOB;
    iPos     PLS_INTEGER;
    clResult CLOB;
  BEGIN
    DBMS_LOB.CREATETEMPORARY(clTemp, TRUE, DBMS_LOB.SESSION);
    DBMS_LOB.APPEND(clTemp, i_clData);
    LOOP
      iPos:=DBMS_LOB.INSTR(clTemp, i_vcReplace);
      IF iPos>0 THEN
        DBMS_LOB.CREATETEMPORARY(clTemp2, TRUE, DBMS_LOB.SESSION);
        DBMS_LOB.COPY(clTemp2,
                      clTemp,
                      iPos-1,
                      1,
                      1);
        DBMS_LOB.APPEND(clTemp2, i_vcReplaceWith);
        DBMS_LOB.COPY(clTemp2,
                      clTemp,
                      DBMS_LOB.GETLENGTH(clTemp)-iPos-LENGTH(i_vcReplace)+1,
                      DBMS_LOB.GETLENGTH(clTemp2)+1,
                      iPos+LENGTH(i_vcReplace));
        DBMS_LOB.FREETEMPORARY(clTemp);
        DBMS_LOB.CREATETEMPORARY(clTemp, TRUE, DBMS_LOB.SESSION);
        DBMS_LOB.APPEND(clTemp, clTemp2);
        DBMS_LOB.FREETEMPORARY(clTemp2);
      ELSE
        EXIT;
      END IF;
    END LOOP;
    clResult:=clTemp;
    DBMS_LOB.FREETEMPORARY(clTemp);
    RETURN clResult;
  END;

  -- ---------------------------------------------------------------------------

  PROCEDURE PR_REPLACE(io_clData IN OUT NOCOPY CLOB,
                       i_vcToken IN VARCHAR2,
                       i_vcValue IN VARCHAR2) IS
    iPos PLS_INTEGER;
    clTemp CLOB;
  BEGIN
    IF DBMS_LOB.INSTR (io_clData, i_vcToken)>0 THEN
      clTemp:=FK_REPLACE_IN_CLOB(io_clData, i_vcToken, i_vcValue);
      io_clData:=clTemp;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_COLUMNS_FROM_LOOKUP_QUERY(i_vcLovQuery IN VARCHAR2,
                                         o_vcDisplay  OUT VARCHAR2,
                                         o_vcValue    OUT VARCHAR2
                                        ) IS
    rec          DBMS_SQL.DESC_REC;
    iColCount    PLS_INTEGER:=0;
    rQuery       PK_JRXML2PDF_TYPES.tQuery;
  BEGIN
    -- parse teh resulting query
    rQuery.iCursor:=DBMS_SQL.OPEN_CURSOR;
    rQuery.bEOF:=FALSE;
    rQuery.nRecordPosition:=0;
    rQuery.nRecordRead:=0;
    rQuery.bTreatLastAsCurrent:=FALSE;
    DBMS_SQL.PARSE(rQuery.iCursor, i_vcLovQuery, DBMS_SQL.NATIVE);
    DBMS_SQL.DESCRIBE_COLUMNS (rQuery.iCursor, iColCount, rQuery.lDescTab);
    IF rQuery.lDescTab.COUNT>=2 THEN
      o_vcDisplay:=rQuery.lDescTab(1).col_name;
      o_vcValue:=rQuery.lDescTab(2).col_name;
    END IF;
  END;
  -- ---------------------------------------------------------------------------

  FUNCTION FK_BUILD_LOV(i_nApplicationId IN NUMBER,
                        i_vcName         IN VARCHAR2,
                        i_vcInlineQuery  IN VARCHAR2,
                        i_vcColname      IN VARCHAR2)
  RETURN VARCHAR2 IS
    CURSOR crLov IS
      SELECT LOV_ID,
             LOV_TYPE,
             LIST_OF_VALUES_QUERY
        FROM APEX_APPLICATION_LOVS
       WHERE APPLICATION_ID=i_nApplicationId
         AND LIST_OF_VALUES_NAME=i_vcName;
    recLov       crLov%ROWTYPE;
    CURSOR crLovCols (i_nLovId IN NUMBER) IS
      SELECT DISPLAY_VALUE, RETURN_VALUE
        FROM APEX_APPLICATION_LOV_ENTRIES
       WHERE APPLICATION_ID=i_nApplicationId
         AND LOV_ID=i_nLovId;

    vcLookupCode    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcDecodeOptions PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcDecodePiece   PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcDisplayValue  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcReturnValue   PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcDisplay       PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcValue         PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF i_vcName IS NOT NULL THEN
      OPEN crLov;
      FETCH crLov INTO recLov;
      CLOSE crLov;
      IF recLov.LOV_TYPE='Static' THEN
        -- Read all values
        vcLookupCode:='DECODE(' || i_vcColName || ',' || CHR(10);
        FOR recLovCols IN crLovCols(recLov.LOV_ID) LOOP
          vcLookupCode:=vcLookupCode || '       '''|| recLovCols.RETURN_VALUE || ''', ''' || recLovCols.DISPLAY_VALUE || ''',' || CHR(10);
        END LOOP;
        vcLookupCode:=vcLookupCode || '       '|| i_vcColName || ') ';
      ELSE
        PR_COLUMNS_FROM_LOOKUP_QUERY(i_vcLovQuery=>recLov.LIST_OF_VALUES_QUERY,
                                     o_vcDisplay =>vcDisplay,
                                     o_vcValue   =>vcValue
                                    );
        -- wrap up query
        vcLookupCode:='(SELECT ' || vcDisplay || CHR(10) ||
                      '   FROM (' || CHR(10) ||
                      recLov.LIST_OF_VALUES_QUERY ||
                      '        ) INNER' || CHR(10) ||
                      '  WHERE INNER.' || vcValue || '=' || i_vcColname || CHR(10) ||
                      ')';
      END IF;
    ELSE
      -- inline query
      IF UPPER(i_vcInlineQuery) LIKE 'STATIC%' THEN
        -- build up decode from options
        -- Read all values
        vcLookupCode:='DECODE(' || i_vcColName || ',' || CHR(10);
        vcDecodeOptions:=i_vcInlineQuery;
        vcDecodePiece:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDecodeOptions, ':');
        vcDecodePiece:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDecodeOptions, ',');
        WHILE vcDecodePiece IS NOT NULL LOOP
          vcDisplayValue:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDecodePiece, ';');
          vcReturnValue:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDecodePiece, ';');
          vcLookupCode:=vcLookupCode || '       '''|| vcReturnValue || ''', ''' || vcDisplayValue || ''',' || CHR(10);
        END LOOP;
        vcLookupCode:=vcLookupCode || '       '|| i_vcColName || ') ';
      ELSE
        PR_COLUMNS_FROM_LOOKUP_QUERY(i_vcLovQuery=>i_vcInlineQuery,
                                     o_vcDisplay =>vcDisplay,
                                     o_vcValue   =>vcValue
                                    );
        -- wrap up query
        vcLookupCode:='(SELECT ' || vcDisplay || CHR(10) ||
                      '   FROM (' || CHR(10) ||
                      i_vcInlineQuery ||
                      '        ) INNER' || CHR(10) ||
                      '  WHERE INNER.' || vcValue || '=' || i_vcColname || CHR(10) ||
                      ')';
      END IF;
    END IF;
    RETURN vcLookupCode;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_HANDLE_QUERY(i_nApplicationId IN  NUMBER,
                            i_nPageId        IN  NUMBER,
                            i_vcSource       IN  VARCHAR2,
                            o_clQuery        OUT CLOB,
                            o_clFields       OUT CLOB,
                            o_lVars          OUT tParamList,
                            o_lColumns       OUT tColumnList) IS
    vcVar        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    iColCount    PLS_INTEGER;
    rec          DBMS_SQL.DESC_REC;
    iRecord      PLS_INTEGER:=0;
    nRows        NUMBER;
    lQueryResult PK_JRXML2PDF_TYPES.tQueryresult;
    rEntry       PK_JRXML2PDF_TYPES.tDataEntry;
    rQuery       PK_JRXML2PDF_TYPES.tQuery;
    iQuotePos    PLS_INTEGER;
    iColonPos    PLS_INTEGER;
    iColonEndPos PLS_INTEGER;
    iPos         PLS_INTEGER:=1;
    clQuery      CLOB;

    CURSOR crOwner IS
      SELECT OWNER
        FROM APEX_APPLICATIONS
      WHERE APPLICATION_ID=i_nApplicationId;
    CURSOR crCols IS
      SELECT ITEM_SOURCE
        FROM APEX_APPLICATION_PAGE_ITEMS
       WHERE APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageId
         AND ITEM_SOURCE_TYPE='Database Column'
         ORDER BY DISPLAY_SEQUENCE;
    CURSOR crLookupColumns IS
      SELECT ITEM_SOURCE,
             LOV_NAMED_LOV LOV_NAME,
             LOV_DEFINITION LOV_TEXT
        FROM APEX_APPLICATION_PAGE_ITEMS
       WHERE DISPLAY_AS_CODE IN ('NATIVE_SELECT_LIST',
                                 'NATIVE_POPUP_LOV',
                                 'NATIVE_RADIOGROUP'
                                )
         AND APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageId;
    TYPE tLookupColumns IS TABLE OF crLookupColumns%ROWTYPE;

    lLookupCols  tLookupColumns;

    TYPE tCols IS TABLE OF crCols%ROWTYPE;
    lCols        tCols;
    bIsLookup    BOOLEAN;
    vcDatasource PK_JRXML2PDF_TYPES.tMaxVarchar2:=i_vcSource;
    vcDummy      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcOwner      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcTable      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem1      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColumn1    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem2      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColumn2    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem3      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColumn3    PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    -- Extract values from datasource
    IF INSTR(vcDatasource, '|')>0 THEN
      vcDummy  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, '|');
    END IF;
    vcOwner  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcTable  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcItem1  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcColumn1:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcItem2  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcColumn2:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcItem3  :=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    vcColumn3:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcDatasource, ':');
    IF vcOwner='#OWNER#' THEN
      OPEN crOwner;
      FETCH crOwner INTO vcOwner;
      CLOSE crOwner;
    END IF;
    --get database columns from regions
    OPEN crCols;
    FETCh crCols
    BULK COLLECT INTO lCols;
    CLOSE crCols;
    DBMS_LOB.CREATETEMPORARY(clQuery, TRUE, DBMS_LOB.SESSION);
    -- build query
    IF lCols.COUNT>0 THEN
      DBMS_LOB.APPEND(clQuery, 'SELECT ');
      FOR i IN 1..lCOls.COUNT LOOP
        DBMS_LOB.APPEND(clQuery, lCols(i).ITEM_SOURCE);
        IF i<lCols.COUNT THEN
          DBMS_LOB.APPEND(clQuery, ',');
        END IF;
        DBMS_LOB.APPEND(clQuery, CHR(10));
      END LOOP;
      DBMS_LOB.APPEND(clQuery, '  FROM ' || vcOwner || '.' || vcTable || CHR(10));
      -- WHERE-condition
      IF vcItem1 IS NOT NULL THEN
        DBMS_LOB.APPEND(clQuery, ' WHERE ' || vcColumn1 || '=:' || vcItem1 || CHR(10));
        o_lVars(vcItem1):=vcItem1;
      END IF;
      IF vcItem2 IS NOT NULL THEN
        DBMS_LOB.APPEND(clQuery, '   AND ' || vcColumn2 || '=:' || vcItem2 || CHR(10));
        o_lVars(vcItem2):=vcItem2;
      END IF;
      IF vcItem3 IS NOT NULL THEN
        DBMS_LOB.APPEND(clQuery, '   AND ' || vcColumn3 || '=:' || vcItem3 || CHR(10));
        o_lVars(vcItem3):=vcItem3;
      END IF;
    ELSE
      clQuery:='SELECT 1 X FROM DUAL';
    END IF;
    -- parse teh resulting query
    rQuery.iCursor:=DBMS_SQL.OPEN_CURSOR;
    rQuery.bEOF:=FALSE;
    rQuery.nRecordPosition:=0;
    rQuery.nRecordRead:=0;
    rQuery.bTreatLastAsCurrent:=FALSE;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Parse query' || SUBSTR(clQuery,1,4000));
    END IF;
    DBMS_SQL.PARSE(rQuery.iCursor, clQuery , DBMS_SQL.NATIVE);
    DBMS_SQL.DESCRIBE_COLUMNS (rQuery.iCursor, iColCount, rQuery.lDescTab);
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Column is (' || rQuery.lDescTab(i).col_type || '):' || rQuery.lDescTab(i).col_name);
      END IF;
      IF rQuery.lDescTab(i).col_type IN     (PK_JRXML2PDF_TYPES.DBMS_SQL_VARCHAR2_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_CHAR_TYPE
                                            ) THEN
        o_clFields:=o_clFields|| '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_max_len;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Varchar:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type =      PK_JRXML2PDF_TYPES.DBMS_SQL_CLOB_TYPE THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Clob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_NUMBER_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_FLOAT_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_BOUBLE_TYPE
                                            ) THEN
        IF rQuery.lDescTab(i).col_precision>0 THEN
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_precision;
        ELSE
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        END IF;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Number:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.math.BigDecimal"/>' || CHR(10);
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_DATE_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TIMESTAMP_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TSTMP_WITH_TZ_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_YEAR_TO_MONTH_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_DAY_TO_SECOND_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.sql.Timestamp"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=10;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Date:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_BLOB_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="oracle.sql.BLOB"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Blob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSE
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=0;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Whatever(' || rQuery.lDescTab(i).col_type || '):' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      END IF;
      IF NVL(o_lColumns(rQuery.lDescTab(i).col_name).nWidth,1)>1 THEN
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=o_lColumns(rQuery.lDescTab(i).col_name).nWidth*LOG(o_lColumns(rQuery.lDescTab(i).col_name).nWidth, 10);
      END IF;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Start building result-query');
    END IF;
    DBMS_LOB.CREATETEMPORARY(o_clQuery, TRUE, DBMS_LOB.SESSION);
    -- Build up SELECT-List from column-descriptions
    -- Lookup-Columns
    OPEN crLookupColumns;
    FETCH crLookupColumns
    BULK COLLECT INTO lLookupCols;
    CLOSE crLookupColumns;
    DBMS_LOB.APPEND(o_clQuery, 'SELECT ');
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      bIsLookup:=FALSE;
      FOR j IN 1..lLookupCols.COUNT LOOP
        IF lLookupCols(j).ITEM_SOURCE=rQuery.lDescTab(i).col_name THEN
          bIsLookup:=TRUE;
          DBMS_LOB.APPEND(o_clQuery, FK_BUILD_LOV(i_nApplicationId,
                                                  lLookupCols(j).LOV_NAME,
                                                  lLookupCols(j).LOV_TEXT,
                                                  rQuery.lDescTab(i).col_name) || ' ' || rQuery.lDescTab(i).col_name);
        END IF;
      END LOOP;
      IF NOT bIsLookup THEN
        DBMS_LOB.APPEND(o_clQuery, '       ' || rQuery.lDescTab(i).col_name);
      END IF;
      IF i<rQuery.lDescTab.COUNT THEN
        DBMS_LOB.APPEND(o_clQuery, ',');
      END IF;
      DBMS_LOB.APPEND(o_clQuery, CHR(10));
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('building inner query');
    END IF;

    DBMS_LOB.APPEND(o_clQuery, '  FROM ( ');
    DBMS_LOB.APPEND(o_clQuery, clQuery);
    LOOP
      iQuotePos:=DBMS_LOB.INSTR(o_clQuery, '''', iPos);
      iColonPos:=DBMS_LOB.INSTR(o_clQuery, ':', iPos);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('replacing quotes' || iQuotePos || '-' || iColonPos);
      END IF;
      IF iQuotePos>0 AND iQuotePos<iColonPos THEN
        iQuotePos:=DBMS_LOB.INSTR(o_clQuery, '''', iQuotePos+1);
        iPos:=iQuotePos+1;
      ELSIF iColonPos>iQuotePos THEN
        -- found match, find end
        iColonEndPos:=DBMS_LOB.GETLENGTH(o_clQuery);
        FOR i IN 1..LENGTH(DELIMITERS) LOOP
          iPos:=INSTR(o_clQuery, SUBSTR(DELIMITERS, i, 1), iColonPos+1);
          IF iPos>0 THEN
            iColonEndPos:=LEAST(iColonEndPos, iPos);
          END IF;
        END LOOP;
        -- replace
        vcVar:=DBMS_LOB.SUBSTR(o_clQuery, iColonEndPos-iColonPos-1, iColonPos+1);
        o_lVars(vcVar):=vcVar;
        o_clQuery:=FK_REPLACE_IN_CLOB(o_clQuery, ':' || vcVar, '$P{' || vcVar || '}');
        iPos:=iColonPos+1;
      END IF;
      EXIT WHEN iColonPos=0;
    END LOOP;
    DBMS_LOB.APPEND(o_clQuery, '       )');
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('finish query');
    END IF;
    o_clQuery:='<queryString>' || CHR(10) || '      <![CDATA[' || o_clQuery || ']]>' || CHR(10) || '    </queryString>' || CHR(10);
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_HANDLE_REPORT_QUERY(i_nApplicationId IN NUMBER,
                                   i_nRegionId IN NUMBER,
                                   i_clQuery   IN CLOB,
                                   o_clQuery   OUT CLOB,
                                   o_clFields  OUT CLOB,
                                   o_lVars     OUT tParamList,
                                   o_lColumns  OUT tColumnList) IS
    CURSOR crSortCols IS
      SELECT COLUMN_ALIAS || ' ' || NVL(DEFAULT_SORT_DIRECTION, 'ASC') SORTCOL
        FROM APEX_APPLICATION_PAGE_RPT_COLS
       WHERE REGION_ID=i_nRegionId
         AND DEFAULT_SORT_SEQUENCE>0
    ORDER BY DEFAULT_SORT_SEQUENCE;

    CURSOR crLookupColumns IS
      SELECT COLUMN_ALIAS,
             NAMED_LIST_OF_VALUES LOV_NAME,
             INLINE_LIST_OF_VALUES LOV_TEXT
        FROM APEX_APPLICATION_PAGE_RPT_COLS
       WHERE DISPLAY_AS_CODE IN ('TEXT_FROM_LOV',
                                 'SELECT_LIST',
                                 'SELECT_LIST_FROM_LOV',
                                 'SELECT_LIST_FROM_QUERY',
                                 'RADIOGROUP',
                                 'RADIOGROUP_FROM_LOV',
                                 'RADIOGROUP_FROM_QUERY',
                                 'POPUP',
                                 'POPUP_FROM_LOV',
                                 'POPUP_FROM_QUERY',
                                 'POPUPKEY_FROM_LOV',
                                 'POPUPKEY_FROM_QUERY'
                                )
         AND REGION_ID=i_nRegionId;

    TYPE tLookupColumns IS TABLE OF crLookupColumns%ROWTYPE;

    lLookupCols  tLookupColumns;
    vcVar        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    iColCount    PLS_INTEGER;
    rec          DBMS_SQL.DESC_REC;
    iRecord      PLS_INTEGER:=0;
    nRows        NUMBER;
    lQueryResult PK_JRXML2PDF_TYPES.tQueryresult;
    rEntry       PK_JRXML2PDF_TYPES.tDataEntry;
    rQuery       PK_JRXML2PDF_TYPES.tQuery;
    iQuotePos    PLS_INTEGER;
    iColonPos    PLS_INTEGER;
    iColonEndPos PLS_INTEGER;
    iPos         PLS_INTEGER:=1;
    clQuery      CLOB;
    bIsLookup    BOOLEAN;
    vcSort       PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    rQuery.iCursor:=DBMS_SQL.OPEN_CURSOR;
    rQuery.bEOF:=FALSE;
    rQuery.nRecordPosition:=0;
    rQuery.nRecordRead:=0;
    rQuery.bTreatLastAsCurrent:=FALSE;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Parse query ' || i_clQuery);
    END IF;
    DBMS_SQL.PARSE(rQuery.iCursor, i_clQuery , DBMS_SQL.NATIVE);
    DBMS_SQL.DESCRIBE_COLUMNS (rQuery.iCursor, iColCount, rQuery.lDescTab);
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Column ' || rQuery.lDescTab(i).col_name);
      END IF;
      IF rQuery.lDescTab(i).col_type IN     (PK_JRXML2PDF_TYPES.DBMS_SQL_VARCHAR2_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_CHAR_TYPE
                                            ) THEN
        o_clFields:=o_clFields|| '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_max_len;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Varchar:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type =      PK_JRXML2PDF_TYPES.DBMS_SQL_CLOB_TYPE THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Clob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_NUMBER_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_FLOAT_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_BOUBLE_TYPE
                                            ) THEN
        IF rQuery.lDescTab(i).col_precision>0 THEN
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_precision;
        ELSE
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=15;
        END IF;
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.math.BigDecimal"/>' || CHR(10);
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Number:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_DATE_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TIMESTAMP_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TSTMP_WITH_TZ_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_YEAR_TO_MONTH_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_DAY_TO_SECOND_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.sql.Timestamp"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=10;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Date:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_BLOB_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="oracle.sql.BLOB"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Blob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSE
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        -- default to small width
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=5;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Whatever(' || rQuery.lDescTab(i).col_type || '):' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      END IF;
      IF NVL(o_lColumns(rQuery.lDescTab(i).col_name).nWidth,1)>1 THEN
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=o_lColumns(rQuery.lDescTab(i).col_name).nWidth*LOG(o_lColumns(rQuery.lDescTab(i).col_name).nWidth, 10);
      END IF;
    END LOOP;
    -- replace bind-variables by $P{}-JRXML-style fields
    DBMS_LOB.CREATETEMPORARY(clQuery, TRUE, DBMS_LOB.SESSION);
    -- Build up SELECT-List from column-descriptions
    -- Lookup-Columns
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Build up outer query');
    END IF;
    OPEN crLookupColumns;
    FETCH crLookupColumns
    BULK COLLECT INTO lLookupCols;
    CLOSE crLookupColumns;
    DBMS_LOB.APPEND(clQuery, 'SELECT ');
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      bIsLookup:=FALSE;
      FOR j IN 1..lLookupCols.COUNT LOOP
        IF lLookupCols(j).COLUMN_ALIAS=rQuery.lDescTab(i).col_name THEN
          bIsLookup:=TRUE;
          DBMS_LOB.APPEND(clQuery, FK_BUILD_LOV(i_nApplicationId,
                                                lLookupCols(j).LOV_NAME,
                                                lLookupCols(j).LOV_TEXT,
                                                rQuery.lDescTab(i).col_name) || ' ' || rQuery.lDescTab(i).col_name);
        END IF;
      END LOOP;
      IF NOT bIsLookup THEN
        DBMS_LOB.APPEND(clQuery, '       ' || rQuery.lDescTab(i).col_name);
      END IF;
      IF i<rQuery.lDescTab.COUNT THEN
        DBMS_LOB.APPEND(clQuery, ',');
      END IF;
      DBMS_LOB.APPEND(clQuery, CHR(10));
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Build up inner query');
    END IF;

    DBMS_LOB.APPEND(clQuery, '  FROM ( ');
    DBMS_LOB.APPEND(clQuery, i_clQuery);
    DBMS_LOB.APPEND(clQuery, ' ');
    LOOP
      iQuotePos:=DBMS_LOB.INSTR(clQuery, '''', iPos);
      iColonPos:=DBMS_LOB.INSTR(clQuery, ':', iPos);
      IF iQuotePos>0 AND iQuotePos<iColonPos THEN
        iQuotePos:=DBMS_LOB.INSTR(clQuery, '''', iQuotePos+1);
        iPos:=iQuotePos+1;
      ELSIF iColonPos>iQuotePos THEN
        -- found match, find end
        iColonEndPos:=DBMS_LOB.GETLENGTH(clQuery);
        FOR i IN 1..LENGTH(DELIMITERS) LOOP
          iPos:=INSTR(clQuery, SUBSTR(DELIMITERS, i, 1), iColonPos+1);
          IF iPos>0 THEN
            iColonEndPos:=LEAST(iColonEndPos, iPos);
          END IF;
        END LOOP;
        -- replace
        vcVar:=DBMS_LOB.SUBSTR(clQuery, iColonEndPos-iColonPos-1, iColonPos+1);
        o_lVars(vcVar):=vcVar;
        clQuery:=FK_REPLACE_IN_CLOB(clQuery, ':' || vcVar, '$P{' || vcVar || '}');
        iPos:=iColonPos+1;
      END IF;
      EXIT WHEN iColonPos=0;
    END LOOP;
    DBMS_LOB.APPEND(clQuery, '       )');
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('build order by');
    END IF;
    FOR rec IN crSortCols LOOP
      vcSort:=vcSort || rec.SORTCOL || ',';
    END LOOP;
    IF vcSort IS NOT NULL THEN
      DBMS_LOB.APPEND(clQuery, CHR(10) || ' ORDER BY ' || SUBSTR(vcSort, 1, LENGTH(vcSort)-1));
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('query done');
    END IF;
    o_clQuery:='<queryString>' || CHR(10) || '      <![CDATA[' || clQuery || ']]>' || CHR(10) || '    </queryString>' || CHR(10);
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL(o_clQuery);
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_HANDLE_IR_QUERY(i_nApplicationId IN NUMBER,
                               i_nRegionId IN NUMBER,
                               i_clQuery   IN CLOB,
                               o_clQuery   OUT CLOB,
                               o_clFields  OUT CLOB,
                               o_lVars     OUT tParamList,
                               o_lColumns  OUT tColumnList) IS
    CURSOR crSortCol IS
      SELECT CASE WHEN SORT_COLUMN_1 IS NOT NULL THEN
               'ORDER BY ' || SORT_COLUMN_1 || ' ' || NVL(SORT_DIRECTION_1, 'ASC')
             END ||
             CASE WHEN NVL(SORT_COLUMN_2,'0')!='0' THEN
               ',' || SORT_COLUMN_2 || ' ' || NVL(SORT_DIRECTION_2, 'ASC')
             END ||
             CASE WHEN NVL(SORT_COLUMN_3,'0')!='0' THEN
               ',' || SORT_COLUMN_3 || ' ' || NVL(SORT_DIRECTION_3, 'ASC')
             END ||
             CASE WHEN NVL(SORT_COLUMN_4,'0')!='0' THEN
               ',' || SORT_COLUMN_4 || ' ' || NVL(SORT_DIRECTION_4, 'ASC')
             END ||
             CASE WHEN NVL(SORT_COLUMN_5,'0')!='0' THEN
               ',' || SORT_COLUMN_5 || ' ' || NVL(SORT_DIRECTION_5, 'ASC')
             END ||
             CASE WHEN NVL(SORT_COLUMN_6,'0')!='0' THEN
               ',' || SORT_COLUMN_6 || ' ' || NVL(SORT_DIRECTION_6, 'ASC')
             END SORTCOL
        FROM APEX_APPLICATION_PAGE_IR A,
             APEX_APPLICATION_PAGE_IR_RPT B
       WHERE A.REGION_ID=i_nRegionId
         AND A.INTERACTIVE_REPORT_ID=B.INTERACTIVE_REPORT_ID
         AND B.REPORT_TYPE='PRIMARY_DEFAULT';
    CURSOR crLookupColumns IS
      SELECT COLUMN_ALIAS,
             NAMED_LOV LOV_NAME,
             NULL LOV_TEXT
        FROM APEX_APPLICATION_PAGE_IR_COL
       WHERE DISPLAY_TEXT_AS IN ('LOV_ESCAPE_SC'
                                )
         AND REGION_ID=i_nRegionId;

    TYPE tLookupColumns IS TABLE OF crLookupColumns%ROWTYPE;

    CURSOR crConditions IS
      SELECT B.CONDITION_SQL,
             B.CONDITION_EXPRESSION,
             B.CONDITION_EXPRESSION2
        FROM APEX_APPLICATION_PAGE_IR A,
             APEX_APPLICATION_PAGE_IR_COND B,
             APEX_APPLICATION_PAGE_IR_RPT C
       WHERE A.REGION_ID=i_nRegionId
         AND A.INTERACTIVE_REPORT_ID=B.INTERACTIVE_REPORT_ID
         AND B.INTERACTIVE_REPORT_ID=C.INTERACTIVE_REPORT_ID
         AND B.REPORT_ID=C.REPORT_ID
         AND B.CONDITION_TYPE='Filter'
         AND C.REPORT_TYPE='PRIMARY_DEFAULT'
;

    lLookupCols  tLookupColumns;
    vcVar        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    iColCount    PLS_INTEGER;
    rec          DBMS_SQL.DESC_REC;
    iRecord      PLS_INTEGER:=0;
    nRows        NUMBER;
    lQueryResult PK_JRXML2PDF_TYPES.tQueryresult;
    rEntry       PK_JRXML2PDF_TYPES.tDataEntry;
    rQuery       PK_JRXML2PDF_TYPES.tQuery;
    iQuotePos    PLS_INTEGER;
    iColonPos    PLS_INTEGER;
    iColonEndPos PLS_INTEGER;
    iPos         PLS_INTEGER:=1;
    clQuery      CLOB;
    bIsLookup    BOOLEAN;
    vcSort       PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcToAdd      PK_JRXML2PDF_TYPES.tMaxVarchar2;

    FUNCTION FK_BUILD_CONDITION(i_vcConditionSql IN VARCHAR2,
                                i_vcExpression1  IN VARCHAR2,
                                i_vcExpression2  IN VARCHAR2)
    RETURN VARCHAR2 IS
      vcResult        PK_JRXML2PDF_TYPES.tMaxVarchar2:=i_vcConditionSql;
      iPos            PLS_INTEGER:=1;
      vcExpressions PK_JRXML2PDF_TYPES.tMaxVarchar2:=i_vcExpression1;
      vcOneValue    PK_JRXML2PDF_TYPES.tMaxVarchar2;

      FUNCTION FK_VALUE(i_vcValue IN VARCHAR2)
      RETURN VARCHAR2 IS
      BEGIN
        RETURN '''' || REPLACE(i_vcValue, '''', '''''') || '''';
      END;
    BEGIN
      IF INSTR(i_vcConditionSql, '#APXWS_EXPR#')>0 THEN
        -- complete expression
        vcResult:=REPLACE(vcResult, '#APXWS_EXPR#', FK_VALUE(i_vcExpression1));
        vcResult:=REPLACE(vcResult, '#APXWS_EXPR2#', FK_VALUE(i_vcExpression2));
      ELSE
        WHILE INSTR(i_vcConditionSql, '#APXWS_EXPR_VAL' || TO_CHAR(iPos) || '#')>0 LOOP
          vcOneValue:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcExpressions, ',');
          vcResult:=REPLACE(vcResult, '#APXWS_EXPR_VAL' || TO_CHAR(iPos) || '#', FK_VALUE(vcOneValue));
          iPos:=iPos+1;
        END LOOP;
      END IF;
      RETURN vcResult;
    END;
  BEGIN
    rQuery.iCursor:=DBMS_SQL.OPEN_CURSOR;
    rQuery.bEOF:=FALSE;
    rQuery.nRecordPosition:=0;
    rQuery.nRecordRead:=0;
    rQuery.bTreatLastAsCurrent:=FALSE;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Parse query ' || i_clQuery);
    END IF;
    DBMS_SQL.PARSE(rQuery.iCursor, i_clQuery , DBMS_SQL.NATIVE);
    DBMS_SQL.DESCRIBE_COLUMNS (rQuery.iCursor, iColCount, rQuery.lDescTab);
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Column ' || rQuery.lDescTab(i).col_name);
      END IF;
      IF rQuery.lDescTab(i).col_type IN     (PK_JRXML2PDF_TYPES.DBMS_SQL_VARCHAR2_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_CHAR_TYPE
                                            ) THEN
        o_clFields:=o_clFields|| '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_max_len;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Varchar:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type =      PK_JRXML2PDF_TYPES.DBMS_SQL_CLOB_TYPE THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Clob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_NUMBER_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_FLOAT_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_BOUBLE_TYPE
                                            ) THEN
        IF rQuery.lDescTab(i).col_precision>0 THEN
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=rQuery.lDescTab(i).col_precision;
        ELSE
          o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=15;
        END IF;
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.math.BigDecimal"/>' || CHR(10);
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Number:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_DATE_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TIMESTAMP_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TSTMP_WITH_TZ_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_YEAR_TO_MONTH_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_DAY_TO_SECOND_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.sql.Timestamp"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=10;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Date:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_BLOB_TYPE
                                            ) THEN
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="oracle.sql.BLOB"/>' || CHR(10);
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=30;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Blob:' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      ELSE
        o_clFields:=o_clFields || '    <field name="' || rQuery.lDescTab(i).col_name || '" class="java.lang.String"/>' || CHR(10);
        -- default to small width
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=5;
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Whatever(' || rQuery.lDescTab(i).col_type || '):' || o_lColumns(rQuery.lDescTab(i).col_name).nWidth);
        END IF;
      END IF;
      IF NVL(o_lColumns(rQuery.lDescTab(i).col_name).nWidth,1)>1 THEN
        o_lColumns(rQuery.lDescTab(i).col_name).nWidth:=o_lColumns(rQuery.lDescTab(i).col_name).nWidth*LOG(o_lColumns(rQuery.lDescTab(i).col_name).nWidth, 10);
      END IF;
    END LOOP;
    -- replace bind-variables by $P{}-JRXML-style fields
    DBMS_LOB.CREATETEMPORARY(clQuery, TRUE, DBMS_LOB.SESSION);
    -- Build up SELECT-List from column-descriptions
    -- Lookup-Columns
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Build up outer query');
    END IF;
    OPEN crLookupColumns;
    FETCH crLookupColumns
    BULK COLLECT INTO lLookupCols;
    CLOSE crLookupColumns;
    DBMS_LOB.APPEND(clQuery, 'SELECT ');
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      bIsLookup:=FALSE;
      FOR j IN 1..lLookupCols.COUNT LOOP
        IF lLookupCols(j).COLUMN_ALIAS=rQuery.lDescTab(i).col_name THEN
          bIsLookup:=TRUE;
          DBMS_LOB.APPEND(clQuery, FK_BUILD_LOV(i_nApplicationId,
                                                lLookupCols(j).LOV_NAME,
                                                lLookupCols(j).LOV_TEXT,
                                                rQuery.lDescTab(i).col_name) || ' ' || rQuery.lDescTab(i).col_name);
        END IF;
      END LOOP;
      IF NOT bIsLookup THEN
        DBMS_LOB.APPEND(clQuery, '       ' || rQuery.lDescTab(i).col_name);
      END IF;
      IF i<rQuery.lDescTab.COUNT THEN
        DBMS_LOB.APPEND(clQuery, ',');
      END IF;
      DBMS_LOB.APPEND(clQuery, CHR(10));
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Build up inner query');
    END IF;

    DBMS_LOB.APPEND(clQuery, '  FROM ( ');
    DBMS_LOB.APPEND(clQuery, i_clQuery);
    LOOP
      iQuotePos:=DBMS_LOB.INSTR(clQuery, '''', iPos);
      iColonPos:=DBMS_LOB.INSTR(clQuery, ':', iPos);
      IF iQuotePos>0 AND iQuotePos<iColonPos THEN
        iQuotePos:=DBMS_LOB.INSTR(clQuery, '''', iQuotePos+1);
        iPos:=iQuotePos+1;
      ELSIF iColonPos>iQuotePos THEN
        -- found match, find end
        iColonEndPos:=DBMS_LOB.GETLENGTH(clQuery);
        FOR i IN 1..LENGTH(DELIMITERS) LOOP
          iPos:=INSTR(clQuery, SUBSTR(DELIMITERS, i, 1), iColonPos+1);
          IF iPos>0 THEN
            iColonEndPos:=LEAST(iColonEndPos, iPos);
          END IF;
        END LOOP;
        -- replace
        vcVar:=DBMS_LOB.SUBSTR(clQuery, iColonEndPos-iColonPos-1, iColonPos+1);
        o_lVars(vcVar):=vcVar;
        clQuery:=FK_REPLACE_IN_CLOB(clQuery, ':' || vcVar, '$P{' || vcVar || '}');
        iPos:=iColonPos+1;
      END IF;
      EXIT WHEN iColonPos=0;
    END LOOP;
    DBMS_LOB.APPEND(clQuery, '       )');
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('apply IR-conditions');
    END IF;
    vcToAdd:=' WHERE ';
    FOR recConditions IN crConditions LOOP
      DBMS_LOB.APPEND(clQuery, vcToAdd || FK_BUILD_CONDITION(recConditions.CONDITION_SQL,
                                                             recConditions.CONDITION_EXPRESSION,
                                                             recConditions.CONDITION_EXPRESSION2) || CHR(10));
      vcToAdd:='   AND ';
    END LOOP;

    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('build order by ');
    END IF;
    OPEN crSortCol;
    FETCH crSortCol INTO vcSort;
    CLOSE crSortCol;
    IF vcSort IS NOT NULL THEN
      DBMS_LOB.APPEND(clQuery, CHR(10) || vcSort);
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('query done');
    END IF;
    o_clQuery:='<queryString>' || CHR(10) || '      <![CDATA[' || clQuery || ']]>' || CHR(10) || '    </queryString>' || CHR(10);
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL(o_clQuery);
    END IF;
  END;
  -- ----------------------------------------------------------------------------
  PROCEDURE PR_CREATE_REPORT_TABLE(i_nRegionId    IN NUMBER,
                                   i_vcRegionName IN VARCHAR2,
                                   i_rRegion      IN tRegionData,
                                   i_lVars        IN tParamList,
                                   i_lColumns     IN tColumnList,
                                   i_nXOffset     IN NUMBER,
                                   o_clData       OUT CLOB,
                                   o_nHeight      OUT NUMBER,
                                   o_nWidth       OUT NUMBER) IS
    CURSOR crCols IS
      SELECT COLUMN_ALIAS,
             DISPLAY_AS_CODE,
             DISPLAY_SEQUENCE,
             HEADING,
             DECODE(COLUMN_ALIGNMENT, 'LEFT', 'Left',
                                      'RIGHT', 'Right',
                                      'CENTER', 'Center',
                                      'Left') COLUMN_ALIGNMENT,
             DECODE(HEADING_ALIGNMENT, 'LEFT', 'Left',
                                       'RIGHT', 'Right',
                                       'CENTER', 'Center',
                                       'Left') HEADING_ALIGNMENT,
             DEFAULT_SORT_SEQUENCE,
             DEFAULT_SORT_DIRECTION,
             FORMAT_MASK,
             REPORT_COLUMN_WIDTH,
             REFERENCE_TABLE_NAME,
             REFERENCE_COLUMN_NAME
        FROM APEX_APPLICATION_PAGE_RPT_COLS
       WHERE REGION_ID=i_nRegionId
       ORDER BY DISPLAY_SEQUENCE;
    TYPE tCols IS TABLE OF crCols%ROWTYPE;

    lCols tCols;

    clTable       CLOB;
    clTabStart    CLOB;
    clTabEnd      CLOB;
    clColStart    CLOB;
    clColEnd      CLOB;
    clHeader      CLOB;
    clItem        CLOB;
    clDummy       CLOB;
    vcColStart    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItemHeader  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColEnd      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nWidth        NUMBER;
    nXPos         NUMBER:=0;
    vcVar         PK_JRXML2PDF_TYPES.tIndex;
    nMaxWidth     NUMBER;
    nDummy        NUMBER;
    nTotalWidth   NUMBER;
    nUnitPerWidth NUMBER;
    nRowHeight    NUMBER;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Load templates');
    END IF;

    -- load templates
    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nRegionTemplateId,
                     o_clStart        =>clTabStart,
                     o_clEnd          =>clTabEnd,
                     o_nContentWidth  =>nMaxWidth,
                     o_nHeightOffset  =>o_nHeight);
    -- load templates
    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nColumnTemplateId,
                     o_clStart        =>clColStart,
                     o_clEnd          =>clColEnd,
                     o_nContentWidth  =>nDummy,
                     o_nHeightOffset  =>nDummy);

    clHeader:=FK_GET_TEMPLATE(i_nId=>i_rRegion.nLabelTemplateId);

    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nItemTemplateId,
                     o_clStart        =>clItem,
                     o_clEnd          =>clDummy,
                     o_nContentWidth  =>nDummy,
                     o_nHeightOffset  =>nRowHeight);
    DBMS_LOB.CREATETEMPORARY(clTable, TRUE, DBMS_LOB.SESSION);
    DBMS_LOB.APPEND(clTable, clTabStart);
    DBMS_LOB.APPEND(clTable, TABLEHEADER1TEMPLATE);
    -- Parametermappings
    vcVar:=i_lVars.FIRST;
    LOOP
      EXIT WHEN vcVar IS NULL;
      DBMS_LOB.APPEND(clTable, REPLACE(TABLEPARAMTEMPLATE, '#PARAMETER#', vcVar));
      vcVar:=i_lVars.NEXT(vcVar);
    END LOOP;
    DBMS_LOB.APPEND(clTable, TABLEHEADER2TEMPLATE);
    PR_REPLACE(clTable, '#XPOSITION#', i_nXOffset);
    PR_REPLACE(clTable, '#YPOSITION#', '0');
    PR_REPLACE(clTable, '#WIDTH#', nMaxWidth);
    PR_REPLACE(clTable, '#HEIGHT#', '10');
    PR_REPLACE(clTable, '#REGIONID#', i_nRegionId);
    OPEN crCols;
    FETCH crCols
    BULK COLLECT INTO lCols;
    CLOSE crCols;
    nTotalWidth:=0;
    FOR i IN 1..lCols.COUNT LOOP
      IF NVL(lCols(i).REPORT_COLUMN_WIDTH,0)>0 THEN
        nTotalWidth:=nTotalWidth+lCols(i).REPORT_COLUMN_WIDTH;
      ELSIF i_lColumns.EXISTS(lCols(i).COLUMN_ALIAS) THEN
        nTotalWidth:=nTotalWidth+i_lColumns(lCols(i).COLUMN_ALIAS).nWidth;
      ELSE
        nTotalWidth:=nTotalWidth+5;
      END IF;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Total width for report' || nTotalWidth);
    END IF;
    -- Units per with
    nUnitPerWidth:=nMaxWidth/nTotalWidth;
    FOR i IN 1..lCols.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('Column ' || i);
      END IF;
      IF NVL(lCols(i).REPORT_COLUMN_WIDTH,0)>0 THEN
        nWidth:=TRUNC(lCols(i).REPORT_COLUMN_WIDTH*nUnitPerWidth);
      ELSIF i_lColumns.EXISTS(lCols(i).COLUMN_ALIAS) THEN
        nWidth:=TRUNC(i_lColumns(lCols(i).COLUMN_ALIAS).nWidth*nUnitPerWidth);
      ELSE
        nWidth:=TRUNC(5*nUnitPerWidth);
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('- Width is ' || nWidth);
      END IF;

      vcColStart:=clColStart;
      vcColStart:=REPLACE(vcColStart, '#COLUMNWIDTH#', nWidth);

      vcItemHeader:=clHeader;
      vcItemHeader:=REPLACE(vcItemHeader, '#XPOSITION#', nXPos);
      vcItemHeader:=REPLACE(vcItemHeader, '#COLUMNWIDTH#', nWidth);
      vcItemHeader:=REPLACE(vcItemHeader, '#HEADERTEXT#', lCols(i).HEADING);
      vcItemHeader:=REPLACE(vcItemHeader, '#ALIGNMENT#', lCols(i).HEADING_ALIGNMENT);
      vcItem:=clItem;
      vcItem:=REPLACE(vcItem, '#XPOSITION#', nXPos);
      vcItem:=REPLACE(vcItem, '#COLUMNWIDTH#', nWidth);
      vcItem:=REPLACE(vcItem, '#FIELD#', lCols(i).COLUMN_ALIAS);
      vcItem:=REPLACE(vcItem, '#ALIGNMENT#', lCols(i).COLUMN_ALIGNMENT);
      vcItem:=REPLACE(vcItem, '#PATTERN#', FK_REVERSE_PATTERN(lCols(i).FORMAT_MASK));
      vcColEnd:=clColEnd;
      clTable:=clTable || vcColStart || vcItemHeader || vcItem || vcColEnd;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('- Go to next column');
      END IF;

      nXPos:=nXPos+nWidth;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Report is done');
    END IF;
    DBMS_LOB.APPEND(clTable, clTabEnd);
    -- replace region-name
    IF i_vcRegionName IS NOT NULL THEN
      PR_REPLACE(clTable, '#REGION_TITLE#', i_vcRegionName);
    ELSE
      PR_REPLACE(clTable, '#REGION_TITLE#', ' ');
    END IF;
    -- set output data
    o_nWidth:=nMaxWidth;
    o_cldata:=clTable;
  END;
  -- ----------------------------------------------------------------------------
  PROCEDURE PR_CREATE_IR_TABLE(i_nRegionId    IN NUMBER,
                               i_vcRegionName IN VARCHAR2,
                               i_rRegion      IN tRegionData,
                               i_lVars        IN tParamList,
                               i_lColumns     IN tColumnList,
                               i_nXOffset     IN NUMBER,
                               o_clData       OUT CLOB,
                               o_nHeight      OUT NUMBER,
                               o_nWidth       OUT NUMBER) IS
    CURSOR crColList IS
      SELECT REPORT_COLUMNS
        FROM APEX_APPLICATION_PAGE_IR A,
             APEX_APPLICATION_PAGE_IR_RPT B
       WHERE A.REGION_ID=i_nRegionId
         AND A.INTERACTIVE_REPORT_ID=B.INTERACTIVE_REPORT_ID
         AND B.REPORT_TYPE='PRIMARY_DEFAULT';

    CURSOR crOneColumn(i_vcColumn IN VARCHAR2) IS
      SELECT COLUMN_ALIAS,
             REPORT_LABEL,
             DECODE(COLUMN_ALIGNMENT, 'LEFT', 'Left',
                                      'RIGHT', 'Right',
                                      'CENTER', 'Center',
                                      'Left') COLUMN_ALIGNMENT,
             DECODE(HEADING_ALIGNMENT, 'LEFT', 'Left',
                                       'RIGHT', 'Right',
                                       'CENTER', 'Center',
                                       'Left') HEADING_ALIGNMENT,
             FORMAT_MASK
        FROM APEX_APPLICATION_PAGE_IR_COL
       WHERE REGION_ID=i_nRegionId
         AND COLUMN_ALIAS=i_vcColumn;

    TYPE tOneColumn IS TABLE OF crOneColumn%ROWTYPE INDEX BY BINARY_INTEGER;

    lCols           tOneColumn;

    clTable         CLOB;
    clTabStart      CLOB;
    clTabEnd        CLOB;
    clColStart      CLOB;
    clColEnd        CLOB;
    clHeader        CLOB;
    clItem          CLOB;

    vcColStart      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItemHeader    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem          PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColEnd        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nWidth          NUMBER;
    nXPos           NUMBER:=0;
    vcVar           PK_JRXML2PDF_TYPES.tIndex;
    nMaxWidth       NUMBER;
    nDummy          NUMBER;
    nTotalWidth     NUMBER;
    nUnitPerWidth   NUMBER;
    vcReportColumns PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcColumn        PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Load templates');
    END IF;

    -- load templates
    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nRegionTemplateId,
                     o_clStart        =>clTabStart,
                     o_clEnd          =>clTabEnd,
                     o_nContentWidth  =>nMaxWidth,
                     o_nHeightOffset  =>o_nHeight);
    -- load templates
    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nColumnTemplateId,
                     o_clStart        =>clColStart,
                     o_clEnd          =>clColEnd,
                     o_nContentWidth  =>nDummy,
                     o_nHeightOffset  =>nDummy);

    clHeader:=FK_GET_TEMPLATE(i_nId=>i_rRegion.nLabelTemplateId);
    clItem  :=FK_GET_TEMPLATE(i_nId=>i_rRegion.nItemTemplateId);
    DBMS_LOB.CREATETEMPORARY(clTable, TRUE, DBMS_LOB.SESSION);
    DBMS_LOB.APPEND(clTable, clTabStart);
    DBMS_LOB.APPEND(clTable, TABLEHEADER1TEMPLATE);
    -- Parametermappings
    vcVar:=i_lVars.FIRST;
    LOOP
      EXIT WHEN vcVar IS NULL;
      DBMS_LOB.APPEND(clTable, REPLACE(TABLEPARAMTEMPLATE, '#PARAMETER#', vcVar));
      vcVar:=i_lVars.NEXT(vcVar);
    END LOOP;
    DBMS_LOB.APPEND(clTable, TABLEHEADER2TEMPLATE);
    PR_REPLACE(clTable, '#XPOSITION#', i_nXOffset);
    PR_REPLACE(clTable, '#YPOSITION#', '0');
    PR_REPLACE(clTable, '#WIDTH#', nMaxWidth);
    PR_REPLACE(clTable, '#HEIGHT#', '10');
    PR_REPLACE(clTable, '#REGIONID#', i_nRegionId);

    -- Get Columns for report
    OPEN crColList;
    FETCH crColList INTO vcReportColumns;
    CLOSE crColList;

    vcColumn:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcReportColumns, ':');
    WHILE vcColumn IS NOT NULL LOOP
      lCols(lCols.COUNT+1).COLUMN_ALIAS:=vcColumn;
      OPEN crOneColumn(vcColumn);
      FETCH crOneColumn INTO lCols(lCols.COUNT);
      CLOSE crOneColumn;
      vcColumn:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcReportColumns, ':');
    END LOOP;
    nTotalWidth:=0;
    FOR i IN 1..lCols.COUNT LOOP
      IF i_lColumns.EXISTS(lCols(i).COLUMN_ALIAS) THEN
        nTotalWidth:=nTotalWidth+i_lColumns(lCols(i).COLUMN_ALIAS).nWidth;
      ELSE
        nTotalWidth:=nTotalWidth+5;
      END IF;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Total width for report' || nTotalWidth);
    END IF;
    -- Units per with
    nUnitPerWidth:=nMaxWidth/nTotalWidth;
    FOR i IN 1..lCols.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('Column ' || i);
      END IF;
      IF i_lColumns.EXISTS(lCols(i).COLUMN_ALIAS) THEN
        nWidth:=TRUNC(i_lColumns(lCols(i).COLUMN_ALIAS).nWidth*nUnitPerWidth);
      ELSE
        nWidth:=TRUNC(5*nUnitPerWidth);
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('- Width is ' || nWidth);
      END IF;

      vcColStart:=clColStart;
      vcColStart:=REPLACE(vcColStart, '#COLUMNWIDTH#', nWidth);

      vcItemHeader:=clHeader;
      vcItemHeader:=REPLACE(vcItemHeader, '#XPOSITION#', nXPos);
      vcItemHeader:=REPLACE(vcItemHeader, '#COLUMNWIDTH#', nWidth);
      vcItemHeader:=REPLACE(vcItemHeader, '#HEADERTEXT#', lCols(i).REPORT_LABEL);
      vcItemHeader:=REPLACE(vcItemHeader, '#ALIGNMENT#', lCols(i).HEADING_ALIGNMENT);
      vcItem:=clItem;
      vcItem:=REPLACE(vcItem, '#XPOSITION#', nXPos);
      vcItem:=REPLACE(vcItem, '#COLUMNWIDTH#', nWidth);
      vcItem:=REPLACE(vcItem, '#FIELD#', lCols(i).COLUMN_ALIAS);
      vcItem:=REPLACE(vcItem, '#ALIGNMENT#', lCols(i).COLUMN_ALIGNMENT);
      vcItem:=REPLACE(vcItem, '#PATTERN#', FK_REVERSE_PATTERN(lCols(i).FORMAT_MASK));
      vcColEnd:=clColEnd;
      clTable:=clTable || vcColStart || vcItemHeader || vcItem || vcColEnd;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('- Go to next column');
      END IF;

      nXPos:=nXPos+nWidth;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Report is done');
    END IF;
    DBMS_LOB.APPEND(clTable, clTabEnd);
    -- replace region-name
    IF i_vcRegionName IS NOT NULL THEN
      PR_REPLACE(clTable, '#REGION_TITLE#', i_vcRegionName);
    ELSE
      PR_REPLACE(clTable, '#REGION_TITLE#', ' ');
    END IF;
    -- set output data
    o_nWidth:=nMaxWidth;
    o_clData:=clTable;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CREATE_FORM_REGION(i_nRegionId   IN NUMBER,
                                 i_vcRegionName IN VARCHAR2,
                                 i_rRegion      IN tRegionData,
                                 i_nXOffset     IN NUMBER,
                                 o_clData       OUT CLOB,
                                 o_nHeight      OUT NUMBER,
                                 o_nWidth       OUT NUMBER) IS
    CURSOR crItems IS
      SELECT ITEM_NAME,
           ITEM_SOURCE_TYPE,
           ITEM_SOURCE,
           LABEL,
           FORMAT_MASK,
           REGION_ID,
           DISPLAY_AS_CODE,
           LOV_NAMED_LOV,
           LOV_DEFINITION,
           ITEM_ELEMENT_WIDTH,
           ITEM_ELEMENT_HEIGHT,
           BEGINS_ON_NEW_ROW,
           LABEL_ALIGNMENT,
           ITEM_ALIGNMENT,
           0 REGION_ROW,
           0 REGION_COL,
           0 LABEL_WIDTH,
           0 ITEM_WIDTH
      FROM APEX_APPLICATION_PAGE_ITEMS
     WHERE REGION_ID=i_nRegionId
       AND DISPLAY_AS_CODE!='NATIVE_HIDDEN'
       ORDER BY DISPLAY_SEQUENCE;

    TYPE tItems IS TABLE OF crItems%ROWTYPE;

    lItems      tItems;

    clForm        CLOB;
    clFormStart   CLOB;
    clFormEnd     CLOB;
    clLabel       CLOB;
    clItem        CLOB;
    clImage       CLOB;
    clDummy       CLOB;
    nMaxWidth     NUMBER;
    nRow          NUMBER;
    nCol          NUMBER;
    nWidth        NUMBER;
    nHeight       NUMBER;
    nHeightOffset NUMBER;
    nItemHeight   NUMBER;
    nDummy        NUMBER;
    vcItemLabel   PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcItem        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nXPos         NUMBER;
    lLabelWidth   PK_JRXML2PDF_TYPES.tNumList;
    lItemWidth    PK_JRXML2PDF_TYPES.tNumList;
    nUnitPerWidth NUMBER;
    nTotalWidth   NUMBER;
    nImageWidth   NUMBER;
    nImageHeight  NUMBER;
    nRowHeight    NUMBER;
  BEGIN
    -- load templates
    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nRegionTemplateId,
                     o_clStart        =>clFormStart,
                     o_clEnd          =>clFormEnd,
                     o_nContentWidth  =>nMaxWidth,
                     o_nHeightOffset  =>nHeightOffset);
    clLabel:=FK_GET_TEMPLATE(i_nId=>i_rRegion.nLabelTemplateId);

    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nItemTemplateId,
                     o_clStart        =>clItem,
                     o_clEnd          =>clDummy,
                     o_nContentWidth  =>nDummy,
                     o_nHeightOffset  =>nItemHeight);

    PR_GET_TEMPLATES(i_nId            =>i_rRegion.nImageTemplateId,
                     o_clStart        =>clImage,
                     o_clEnd          =>clDummy,
                     o_nContentWidth  =>nImageWidth,
                     o_nHeightOffset  =>nImageHeight);
    DBMS_LOB.CREATETEMPORARY(clForm, TRUE, DBMS_LOB.SESSION);
    DBMS_LOB.APPEND(clForm, clFormStart);
    PR_REPLACE(clForm, '#XPOSITION#', i_nXOffset);
    PR_REPLACE(clForm, '#YPOSITION#', '0');
    PR_REPLACE(clForm, '#WIDTH#', nMaxWidth);
    PR_REPLACE(clForm, '#REGIONID#', i_nRegionId);
    OPEN crItems;
    FETCH crItems
    BULK COLLECT INTO lItems;
    CLOSE crItems;
    -- Sort items into grid
    -- Units per with
    nRow:=0;
    nCol:=1;
    FOR i IN 1..lItems.COUNT LOOP
      IF lItems(i).BEGINS_ON_NEW_ROW='Yes' THEN
        nRow:=nRow+1;
        nCol:=1;
      END IF;
      lItems(i).REGION_ROW:=nRow;
      lItems(i).REGION_COL:=nCol;
      nCol:=nCol+1;
    END LOOP;
    -- max with per column

    FOR i IN 1..lItems.COUNT LOOP
      IF lLabelWidth.EXISTS(lItems(i).REGION_COL) THEN
        lLabelWidth(lItems(i).REGION_COL):=GREATEST(lLabelWidth(lItems(i).REGION_COL), NVL(LENGTH(lItems(i).LABEL),1)*5);
      ELSE
        lLabelWidth(lItems(i).REGION_COL):=NVL(LENGTH(lItems(i).LABEL),1)*5;
      END IF;
      IF lItems(i).DISPLAY_AS_CODE='NATIVE_DISPLAY_IMAGE' THEN
        nWidth:=nImageWidth;
      ELSE
        nWidth:=NVL(lItems(i).ITEM_ELEMENT_WIDTH,1)*5;
      END IF;

      IF lItemWidth.EXISTS(lItems(i).REGION_COL) THEN
        lItemWidth(lItems(i).REGION_COL):=GREATEST(lItemWidth(lItems(i).REGION_COL), nWidth);
      ELSE
        lItemWidth(lItems(i).REGION_COL):=nWidth;
      END IF;
    END LOOP;
    FOR i IN 1..lItems.COUNT LOOP
      lItems(i).LABEL_WIDTH:=lLabelWidth(lItems(i).REGION_COL);
      lItems(i).ITEM_ELEMENT_WIDTH:=lItemWidth(lItems(i).REGION_COL);
    END LOOP;
    nTotalWidth:=0;
    FOR i IN 1..lLabelWidth.COUNT LOOP
      nTotalWidth:=nTotalWidth+lLabelWidth(i)+lItemWidth(i);
    END LOOP;
    IF nTotalWidth>nMaxWidth THEN
      -- Units per with
      nUnitPerWidth:=nMaxWidth/nTotalWidth;
    ELSE
      nUnitPerWidth:=1;
    END IF;
    nHeight:=0;
    nXPos:=0;
    nRowHeight:=0;
    FOR i IN 1..lItems.COUNT LOOP
      IF lItems(i).BEGINS_ON_NEW_ROW='Yes' THEN
        IF i>1 THEN
          nHeight:=nHeight+nRowHeight;
          nRowHeight:=0;
        END IF;
        nXPos:=0;
      END IF;
      nRowHeight:=GREATEST(nRowHeight, CASE WHEN lItems(i).DISPLAY_AS_CODE='NATIVE_DISPLAY_IMAGE' THEN
                                         nImageHeight
                                       ELSE
                                         nItemHeight
                                       END
                          );
      vcItemLabel:=clLabel;
      vcItemLabel:=REPLACE(vcItemLabel, '#XPOSITION#', TRUNC(nXPos*nUnitPerWidth));
      vcItemLabel:=REPLACE(vcItemLabel, '#YPOSITION#', nHeight);
      vcItemLabel:=REPLACE(vcItemLabel, '#WIDTH#', TRUNC(lItems(i).LABEL_WIDTH*nUnitPerWidth));
      vcItemLabel:=REPLACE(vcItemLabel, '#HEIGHT#', nItemHeight);
      vcItemLabel:=REPLACE(vcItemLabel, '#LABEL#', lItems(i).LABEL);
      vcItemLabel:=REPLACE(vcItemLabel, '#ALIGNMENT#', lItems(i).LABEL_ALIGNMENT);

      IF lItems(i).DISPLAY_AS_CODE='NATIVE_DISPLAY_IMAGE' THEN
        vcItem:=clImage;
        vcItem:=REPLACE(vcItem, '#XPOSITION#', TRUNC((nXPos+lItems(i).LABEL_WIDTH)*nUnitPerWidth));
        vcItem:=REPLACE(vcItem, '#YPOSITION#', nHeight);
        IF lItems(i).ITEM_SOURCE_TYPE='Database Column' THEN
          vcItem:=REPLACE(vcItem, '#FIELD#', '$F{' || lItems(i).ITEM_SOURCE || '}');
        ELSE
          vcItem:=REPLACE(vcItem, '#FIELD#', '');
        END IF;
      ELSE
        vcItem:=clItem;
        vcItem:=REPLACE(vcItem, '#XPOSITION#', TRUNC((nXPos+lItems(i).LABEL_WIDTH)*nUnitPerWidth));
        vcItem:=REPLACE(vcItem, '#YPOSITION#', nHeight);
        vcItem:=REPLACE(vcItem, '#WIDTH#', TRUNC(lItems(i).ITEM_ELEMENT_WIDTH*nUnitPerWidth));
        vcItem:=REPLACE(vcItem, '#HEIGHT#', nItemHeight);
        IF lItems(i).ITEM_SOURCE_TYPE='Database Column' THEN
          vcItem:=REPLACE(vcItem, '#FIELD#', '$F{' || lItems(i).ITEM_SOURCE || '}');
        ELSE
          vcItem:=REPLACE(vcItem, '#FIELD#', '');
        END IF;
        vcItem:=REPLACE(vcItem, '#ALIGNMENT#', lItems(i).ITEM_ALIGNMENT);

        vcItem:=REPLACE(vcItem, '#PATTERN#', FK_REVERSE_PATTERN(lItems(i).FORMAT_MASK));
      END IF;
      clForm:=clForm || vcItemLabel || vcItem;
      nXPos:=nXPos+lItems(i).LABEL_WIDTH+lItems(i).ITEM_ELEMENT_WIDTH;
    END LOOP;
    nHeight:=nHeight+nRowHeight;

    PR_REPLACE(clForm, '#INNERHEIGHT#', nHeight);
    DBMS_LOB.APPEND(clForm, clFormEnd);
        -- replace region-name
    IF i_vcRegionName IS NOT NULL THEN
      PR_REPLACE(clForm, '#REGION_TITLE#', i_vcRegionName);
    ELSE
      PR_REPLACE(clForm, '#REGION_TITLE#', ' ');
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Region height (inner/offset) ' || nHeight || '/' || nHeightOffset);
    END IF;
    o_nHeight:=nHeight+nHeightOffset;
    o_nWidth:=nMaxWidth;
    o_clData:=clForm;
  END;

  -- --------------------------------------------------------------------------

  PROCEDURE PR_GENERATE_JRXML(i_nApplicationId        IN NUMBER,
                              i_nPageId               IN NUMBER,
                              i_vcReportName          IN VARCHAR2,
                              i_nReportTemplateId     IN NUMBER,
                              i_nBackgroundTemplateId IN NUMBER,
                              i_nTitelTemplateId      IN NUMBER,
                              i_nSummaryTemplateId    IN NUMBER,
                              i_nPageheaderTemplateId IN NUMBER,
                              i_nPagefooterTemplateId IN NUMBER,
                              i_lRegions              IN tRegionDataList) IS

    TYPE tClobList IS TABLE OF CLOB INDEX BY BINARY_INTEGER;
    TYPE tVarList  IS TABLE OF tParamList INDEX BY PK_JRXML2PDF_TYPES.tIndex;
    CURSOR crOwner IS
      SELECT OWNER
        FROM APEX_APPLICATIONS
      WHERE APPLICATION_ID=i_nApplicationId;

    CURSOR crPage IS
      SELECT PAGE_TITLE
        FROM APEX_APPLICATION_PAGES
       WHERE APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageId;
    recPage crPage%ROWTYPE;
    CURSOR crRegion(i_nRegionId IN NUMBER) IS
      SELECT REGION_ID,
             REGION_NAME,
             REGION_SOURCE,
             DECODE(SOURCE_TYPE_CODE, 'SQL_QUERY', 'REPORT',
                                      'UPDATABLE_SQL_QUERY', 'REPORT',
                                      'DYNAMIC_QUERY', 'IR',
                                 SOURCE_TYPE
                   ) SOURCE_TYPE
        FROM APEX_APPLICATION_PAGE_REGIONS
       WHERE APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageId
         AND REGION_ID=i_nRegionId;
    recRegion crRegion%ROWTYPE;

    CURSOR crProcess IS
      SELECT PROCESS_SOURCE
        FROM APEX_APPLICATION_PAGE_PROC
       WHERE APPLICATION_ID=i_nApplicationId
         AND PAGE_ID=i_nPageId
         AND PROCESS_TYPE_CODE='DML_FETCH_ROW';

    recProcess       crProcess%ROWTYPE;
    clBackgroundTemplate CLOB;
    clTitleTemplate      CLOB;
    clSummaryTemplate    CLOB;
    clPageHeaderTemplate CLOB;
    clPageFooterTemplate CLOB;
    clReportTemplate     CLOB;

    clReport     CLOB;
    rTemplate tTemplate;
    clQuery          CLOB;
    clFields         CLOB;
    clSubdatasets    CLOB;
    clDetailSections CLOB;
    lTempVars        tParamList;
    lVars            tParamList;
    lVarsByRegion    tVarList;
    vcVar            PK_JRXML2PDF_TYPES.tIndex;
    clParams         CLOB;
    iIdx             PLS_INTEGER:=0;
    lColumns         tColumnList;
    lColsByRegion    tColumnListList;
    vcOwner          PK_JRXML2PDF_TYPES.tMaxVarchar2;
    PROCEDURE PR_LOAD_TEMPLATES IS
    BEGIN
      clReportTemplate:=FK_GET_TEMPLATE(i_nReportTemplateId);
      clBackgroundTemplate:=FK_GET_TEMPLATE(i_nBackgroundTemplateId);
      clTitleTemplate:=FK_GET_TEMPLATE(i_nTitelTemplateId);
      clSummaryTemplate:=FK_GET_TEMPLATE(i_nSummaryTemplateId);
      clPageHeaderTemplate:=FK_GET_TEMPLATE(i_nPageheaderTemplateId);
      clPageFooterTemplate:=FK_GET_TEMPLATE(i_nPagefooterTemplateId);
    END;

    PROCEDURE PR_HANDLE_QUERIES IS
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('handle main query');
      END IF;

      OPEN crOwner;
      FETCH crOwner INTO vcOwner;
      CLOSE crOwner;

      OPEN crProcess;
      FETCH crProcess INTO recProcess;
      CLOSE crProcess;
      -- dummy-query for later Regions
      PR_HANDLE_QUERY(i_nApplicationId =>i_nApplicationId,
                      i_nPageId        =>i_nPageId,
                      i_vcSource       =>recProcess.PROCESS_SOURCE,
                      o_clQuery        =>clQuery,
                      o_clFields       =>clFields,
                      o_lVars          =>lTempVars,
                      o_lColumns       =>lColumns);

      vcVar:=lTempVars.FIRST;
      LOOP
        EXIT WHEN vcVar IS NULL;
        lVars(vcVar):=vcVar;
        vcVar:=lTempVars.NEXT(vcVar);
      END LOOP;
      PR_REPLACE(clReport, '#MAINQUERY#', clQuery || clFields);
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
       PK_JRXML2PDF_LOG.PR_LOG_FINE('handle region queries');
      END IF;

      -- Queries for reports as subdatasets
      FOR i IN 1..i_lRegions.COUNT LOOP
        OPEN crRegion(i_lRegions(i).nRegionId);
        FETCh crRegion INTO recRegion;
        CLOSE crRegion;
        IF recRegion.SOURCE_TYPE IN ('REPORT', 'IR') THEN
          PR_REPLACE(recRegion.REGION_SOURCE, '#OWNER#', vcOwner);
          IF recRegion.SOURCE_TYPE ='REPORT' THEN
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
             PK_JRXML2PDF_LOG.PR_LOG_FINE('tab region/query' || recRegion.REGION_ID || ':' || recRegion.REGION_SOURCE);
            END IF;
            PR_HANDLE_REPORT_QUERY(i_nApplicationId,
                                   recRegion.REGION_ID,
                                   recRegion.REGION_SOURCE,
                                   clQuery,
                                   clFields,
                                   lTempVars,
                                   lColumns);
          ELSE
            PR_HANDLE_IR_QUERY(i_nApplicationId,
                               recRegion.REGION_ID,
                               recRegion.REGION_SOURCE,
                               clQuery,
                               clFields,
                               lTempVars,
                               lColumns);
          END IF;
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('process vars');
          END IF;
          vcVar:=lTempVars.FIRST;
          LOOP
            EXIT WHEN vcVar IS NULL;
            lVars(vcVar):=vcVar;
            vcVar:=lTempVars.NEXT(vcVar);
          END LOOP;
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('build subdataset');
          END IF;
          lVarsByRegion(TO_CHAR(recRegion.REGION_ID)):=lTempVars;
          lColsByRegion(TO_CHAR(recRegion.REGION_ID)):=lColumns;
          clSubDataSets:=clSubDataSets || '    <subDataset name="' || recRegion.REGION_ID || '">' || CHR(10);
          -- parameters
          vcVar:=lTempVars.FIRST;
          LOOP
            EXIT WHEN vcVar IS NULL;
            clSubDataSets:=clSubDataSets  || '    <parameter name="' || vcVar || '" class="java.lang.String"/>' || CHR(10);
            vcVar:=lTempVars.NEXT(vcVar);
          END LOOP;
          -- Query and fields
          clSubDataSets:=clSubDataSets || clQuery || clFields;
          clSubDataSets:=clSubDataSets || '    </subDataset>' || CHR(10);
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('done with subdataset');
          END IF;
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('put subdatasets into report');
      END IF;
      IF clSubDataSets IS NULL THEN
        PR_REPLACE(clReport, '#SUBDATASETS#', ' ');
      ELSE
        PR_REPLACE(clReport, '#SUBDATASETS#', clSubDataSets);
      END IF;

      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('generate main parameters');
      END IF;

      vcVar:=lVars.FIRST;
      LOOP
        EXIT WHEN vcVar IS NULL;
        clParams:=clParams || '    <parameter name="' || vcVar || '" class="java.lang.String"/>' || CHR(10);
        vcVar:=lVars.NEXT(vcVar);
      END LOOP;

      IF clParams IS NOT NULL THEN
        PR_REPLACE(clReport, '#PARAMETERS#', clParams);
      ELSE
        PR_REPLACE(clReport, '#PARAMETERS#', ' ');
      END IF;
    END;

    PROCEDURE PR_CREATE_DETAIL_LAYOUT IS
      clLocalData  CLOB;
      nLocalHeight NUMBER;
      nHeight      NUMBER;
      nXOffset     NUMBER;
      nLocalX      NUMBER;
      PROCEDURE PR_START_BAND IS
      BEGIN
        nHeight:=0;
        nXOffset:=0;
        -- put band start into clob
        clDetailSections:=clDetailSections || '  <band height="#HEIGHT#">';
      END;

      PROCEDURE PR_END_BAND IS
      BEGIN
        clDetailSections:=clDetailSections || '  </band>';
        PR_REPLACE(clDetailSections,'#HEIGHT#', nHeight);
      END;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('process detail-sections');
      END IF;

      -- for each report, create a detail-section
      clDetailSections:=clDetailSections || '    <detail>' || CHR(10);

      FOR i IN 1..i_lRegions.COUNT LOOP
        -- check for band change
        IF i=1 THEN
          PR_START_BAND;
        ELSIF     i>1
              AND (   i_lRegions(i).vcDisplayPosition!=i_lRegions(i-1).vcDisplayPosition
                   OR i_lRegions(i).nColumn=1
                  ) THEN
          PR_START_BAND;
        END IF;
        OPEN crRegion(i_lRegions(i).nRegionId);
        FETCh crRegion INTO recRegion;
        CLOSE crRegion;
        IF recRegion.SOURCE_TYPE='REPORT' THEN
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
           PK_JRXML2PDF_LOG.PR_LOG_FINE('Create report for region ' || i_lRegions(i).nRegionId);
          END IF;
          PR_CREATE_REPORT_TABLE(recRegion.REGION_ID,
                                 recRegion.REGION_NAME,
                                 i_lRegions(i),
                                 lVarsByRegion(recRegion.REGION_ID),
                                 lColsByRegion(recRegion.REGION_ID),
                                 nXOffset,
                                 clLocalData,
                                 nLocalHeight,
                                 nLocalX);
        ELSIF recRegion.SOURCE_TYPE='IR' THEN
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
           PK_JRXML2PDF_LOG.PR_LOG_FINE('Create Interactive-Report for region ' || i_lRegions(i).nRegionId);
          END IF;
          PR_CREATE_IR_TABLE(recRegion.REGION_ID,
                             recRegion.REGION_NAME,
                             i_lRegions(i),
                             lVarsByRegion(recRegion.REGION_ID),
                             lColsByRegion(recRegion.REGION_ID),
                             nXOffset,
                             clLocalData,
                             nLocalHeight,
                             nLocalX);
        ELSE
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
           PK_JRXML2PDF_LOG.PR_LOG_FINE('Create formular layout for region ' || i_lRegions(i).nRegionId);
          END IF;
          PR_CREATE_FORM_REGION(recRegion.REGION_ID,
                                recRegion.REGION_NAME,
                                i_lRegions(i),
                                nXOffset,
                                clLocalData,
                                nLocalHeight,
                                nLocalX);
        END IF;
        clDetailSections:=clDetailSections || clLocalData;
        nHeight:=GREATEST(nHeight, nLocalHeight);
        nXOffset:=nXOffset+nLocalX;
        IF i=i_lRegions.COUNT THEN
          PR_END_BAND;
        ELSIF     i<i_lRegions.COUNT
              AND (   i_lRegions(i).vcDisplayPosition!=i_lRegions(i+1).vcDisplayPosition
                   OR i_lRegions(i+1).nColumn=1
                  ) THEN
          PR_END_BAND;
        END IF;
      END LOOP;
      clDetailSections:=clDetailSections || '    </detail>' || CHR(10);



      PR_REPLACE(clReport, '#DETAIL#', clDetailSections);
    END;

    PROCEDURE PR_CREATE_OTHER_LAYOUT IS
    BEGIN
      IF clBackgroundTemplate IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Background set');
        END IF;
        PR_REPLACE(clReport, '#BACKGROUNDREGION#', clBackgroundTemplate);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('no Background');
        END IF;
        PR_REPLACE(clReport, '#BACKGROUNDREGION#', ' ');
      END IF;

      IF clTitleTemplate IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('title set');
        END IF;
        PR_REPLACE(clReport, '#TITLEREGION#', clTitleTemplate);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('no title');
        END IF;
        PR_REPLACE(clReport, '#TITLEREGION#', ' ');
      END IF;

      clPageFooterTemplate:=FK_GET_TEMPLATE(i_nPagefooterTemplateId);

      IF clPageHeaderTemplate IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Pageheader set');
        END IF;
        PR_REPLACE(clReport, '#PAGEHEADERREGION#', clPageHeaderTemplate);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('no pageheader');
        END IF;
        PR_REPLACE(clReport, '#PAGEHEADERREGION#', ' ');
      END IF;

      IF clPageFooterTemplate IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Pagefooter set');
        END IF;
        PR_REPLACE(clReport, '#PAGEFOOTERREGION#', clPageFooterTemplate );
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('no pagefooter');
        END IF;
        PR_REPLACE(clReport, '#PAGEFOOTERREGION#', ' ');
      END IF;

      IF clSummaryTemplate IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('summary set');
        END IF;
        PR_REPLACE(clReport, '#SUMMARYREGION#', clSummaryTemplate );
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('no summary');
        END IF;
        PR_REPLACE(clReport, '#SUMMARYREGION#', ' ');
      END IF;
      -- replace Page-name
      IF recPage.PAGE_TITLE IS NOT NULL THEN
        PR_REPLACE(clReport, '#REPORT_TITLE#', recPage.PAGE_TITLE);
      ELSE
        PR_REPLACE(clReport, '#REPORT_TITLE#', ' ');
      END IF;
    END;
  BEGIN
    PK_JRXML2PDF_LOG.PR_SET_LEVEL(i_nLevel  =>PK_JRXML2PDF_LOG.LEVEL_FINE,
                                  i_nLogMode=>PK_JRXML2PDF_LOG.LOGMODE_TABLE);
    OPEN crPage;
    FETCH crPage INTO recPage;
    CLOSE crPage;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
     PK_JRXML2PDF_LOG.PR_LOG_FINE('Load templates');
    END IF;
    DBMS_LOB.CREATETEMPORARY(clReport, TRUE, DBMS_LOB.SESSION);

    -- load all templates
    PR_LOAD_TEMPLATES;
    DBMS_LOB.APPEND(clReport, clReportTemplate);
    PR_HANDLE_QUERIES;
    PR_CREATE_DETAIL_LAYOUT;
    PR_CREATE_OTHER_LAYOUT;
    MERGE INTO JRXML_REPORT_DEFINITIONS I
    USING (SELECT i_vcReportName JRD_NAME
             FROM DUAL
          ) O
    ON (I.JRD_NAME=O.JRD_NAME)
    WHEN MATCHED THEN
      UPDATE SET JRD_XML=clReport
    WHEN NOT MATCHED THEN
      INSERT (
        JRD_ID,
        JRD_NAME,
        JRD_XML
      ) VALUES (
        JRXML_SEQ.NEXTVAL,
        i_vcReportName,
        clReport
      );
    COMMIT;
    DBMS_LOB.FREETEMPORARY(clReport);
  END;
  PROCEDURE PR_GENERATE_JRXML(i_nApplicationId        IN NUMBER,
                              i_nPageId               IN NUMBER,
                              i_vcReportName          IN VARCHAR2,
                              i_nReportTemplateId     IN NUMBER,
                              i_nBackgroundTemplateId IN NUMBER,
                              i_nTitelTemplateId      IN NUMBER,
                              i_nSummaryTemplateId    IN NUMBER,
                              i_nPageheaderTemplateId IN NUMBER,
                              i_nPagefooterTemplateId IN NUMBER) IS
    lRegions PK_JRXML2PDF_APEX2JRXML.tRegionDataList;
    CURSOR crRegions IS
      SELECT C001,
             C005,
             C006,
             C011,
             C012,
             C013,
             C014,
             C015
        FROM APEX_COLLECTIONS
       WHERE COLLECTION_NAME='JRXML'
         AND C004='Y';

  BEGIN
    -- Transfer collection-Data INTO Region-array
    OPEN crRegions;
    FETCH crRegions
    BULK COLLECT INTO lRegions;
    CLOSE crRegions;

    -- call generator
    PR_GENERATE_JRXML(i_nApplicationId        =>i_nApplicationId,
                      i_nPageId               =>i_nPageId,
                      i_vcReportName          =>i_vcReportName,
                      i_nReportTemplateId     =>i_nReportTemplateId,
                      i_nBackgroundTemplateId =>i_nBackgroundTemplateId,
                      i_nTitelTemplateId      =>i_nTitelTemplateId,
                      i_nSummaryTemplateId    =>i_nSummaryTemplateId,
                      i_nPageheaderTemplateId =>i_nPageheaderTemplateId,
                      i_nPagefooterTemplateId =>i_nPagefooterTemplateId,
                      i_lRegions              =>lRegions);
  END;
END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_charts IS
  LIGHT_GRAY CONSTANT PK_JRXML2PDF_TYPES.tColor:='EEEEEE';
  MID_GRAY   CONSTANT PK_JRXML2PDF_TYPES.tColor:='C0C0C0';
  MAX_NUMBER CONSTANT NUMBER:=99999999999999999999999999999;
  MIN_NUMBER CONSTANT NUMBER:=-99999999999999999999999999999;
  MAX_DATE   CONSTANT DATE:=TO_DATE('01.01.4000','DD.MM.YYYY');
  MIN_DATE   CONSTANT DATE:=TO_DATE('01.01.1000','DD.MM.YYYY');
  PIXEL_PER_TICK NUMBER:=20;
  PI     CONSTANT NUMBER:=3.141592653589793;
  TWO_PI CONSTANT NUMBER:=3.141592653589793*2;
  TYPE tRect IS RECORD (
     nX      NUMBER,
     nY      NUMBER,
     nWidth  NUMBER,
     nHeight NUMBER
  );
  TYPE tPathList IS TABLE OF AS_PDF3_MOD.tPath INDEX BY BINARY_INTEGER;
  TYPE tMinMaxList IS TABLE OF NUMBER INDEX BY PK_JRXML2PDF_TYPES.tMaxVarchar2;
  lDefaultNumberTicks tTickEntryList;
  lDefaultDateTicks   tTickEntryList;
  lDefaultColors      PK_JRXML2PDF_TYPES.tColorList;
  lDefaultShapes      tPathList;
  FUNCTION FK_TRANSFORM_PATH(i_nX    IN NUMBER,
                             i_nY    IN NUMBER,
                             i_lPath IN AS_PDF3_MOD.tPath)
  RETURN AS_PDF3_MOD.tPath IS
    lPath AS_PDF3_MOD.tPath;
  BEGIN
    FOR i IN 1..i_lPath.COUNT LOOP
      lPath(i):=i_lPath(i);
      lPath(i).nVal1:=lPath(i).nVal1+i_nX;
      lPath(i).nVal2:=lPath(i).nVal2+i_nY;
      lPath(i).nVal3:=lPath(i).nVal3+i_nX;
      lPath(i).nVal4:=lPath(i).nVal4+i_nY;
      lPath(i).nVal5:=lPath(i).nVal5+i_nX;
      lPath(i).nVal6:=lPath(i).nVal6+i_nY;
    END LOOP;
    RETURN lPath;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RADIANS(i_nDegree IN NUMBER)
  RETURN NUMBER DETERMINISTIC IS
  BEGIN
    RETURN i_nDegree / 57.2957795;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_PIESLICE(i_nCX          IN NUMBER,
                             i_nCY         IN NUMBER,
                             i_nA          IN NUMBER,
                             i_nB          IN NUMBER,
                             i_nLambda1    IN NUMBER,
                             i_nLambda2    IN NUMBER,
                             i_bIsPieSlice IN BOOLEAN)
  RETURN AS_PDF3_MOD.tPath IS
    nCX NUMBER;
    nCY NUMBER;
    nA NUMBER;
    nB NUMBER;
    nTheta NUMBER;
    nCosTheta NUMBER;
    nSinTheta NUMBER;
    nEta1     NUMBER;
    nEta2     NUMBER;
    nX1 NUMBER;
    nX2 NUMBER;
    nY1 NUMBER;
    nY2 NUMBER;
    nXF1 NUMBER;
    nXF2 NUMBER;
    nYF1 NUMBER;
    nYF2 NUMBER;
    nXLeft NUMBER;
    nYUp NUMBER;
    nWidth NUMBER;
    nHeight NUMBER;
    bIsPieSlice BOOLEAN;
    nMaxDegree  NUMBER;
    nDefaultFlatness NUMBER;
    nF NUMBER;
    nE2 NUMBER;
    nG NUMBER;
    nG2 NUMBER;
    nd NUMBER;
    ndx NUMBER;
    ndy NUMBER;
    naCosEta1 NUMBER;
    nbSinEta1 NUMBER;
    naCosEta2 NUMBER;
    nbSinEta2 NUMBER;
    lPath     AS_PDF3_MOD.tPath;
    iPos      PLS_INTEGER;
    PROCEDURE PR_BUILD_PATH IS
      bFound BOOLEAN;
      n      PLS_INTEGER;
      ndEta  NUMBER;
      netaB  NUMBER;
      ncosEtaB  NUMBER;
      nsinEtaB  NUMBER;
      naCosEtaB NUMBER;
      nbSinEtaB NUMBER;
      naSinEtaB NUMBER;
      nbCosEtaB NUMBER;
      nxB       NUMBER;
      nyB       NUMBER;
      nxBDot    NUMBER;
      nyBDot    NUMBER;
      nt        NUMBER;
      nAlpha    NUMBER;
      netaA     NUMBER;
      nxA       NUMBER;
      nyA       NUMBER;
      nxADot    NUMBER;
      nyADot    NUMBER;
    BEGIN
      -- build path
      -- find the number of B�zier curves needed
      bfound := false;
      n := 1;
      while ((NOT bfound) AND (n < 1024)) LOOP
        ndEta := (neta2 - neta1) / n;
        if (ndEta <= 0.5 * PI) THEN
          netaB := neta1;
          bfound := true;
          FOR I IN 0..n-1 LOOP
            netaA := netaB;
            netaB :=nEtaB+ ndEta;
          END LOOP;
        END IF;
        n := n*2;
      END LOOP;
      ndEta := (neta2 - neta1) / n;
      netaB := neta1;
      ncosEtaB  := cos(netaB);
      nsinEtaB  := sin(netaB);
      naCosEtaB := na * ncosEtaB;
      nbSinEtaB := nb * nsinEtaB;
      naSinEtaB := na * nsinEtaB;
      nbCosEtaB := nb * ncosEtaB;
      nxB       := ncx + naCosEtaB * ncosTheta - nbSinEtaB * nsinTheta;
      nyB       := ncy + naCosEtaB * nsinTheta + nbSinEtaB * ncosTheta;
      nxBDot    := -naSinEtaB * ncosTheta - nbCosEtaB * nsinTheta;
      nyBDot    := -naSinEtaB * nsinTheta + nbCosEtaB * ncosTheta;
      if (bisPieSlice) THEN
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
        lPath(iPos).nVal1:=ncx;
        lPath(iPos).nVal2:=ncy;
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_LINE_TO;
        lPath(iPos).nVal1:=nXb;
        lPath(iPos).nVal2:=nYb;
      ELSE
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
        lPath(iPos).nVal1:=nXb;
        lPath(iPos).nVal2:=nYb;
      END IF;
      nt     := tan(0.5 * ndEta);
      nalpha := sin(ndEta) * (sqrt(4 + 3 * nt * nt) - 1) / 3;
      FOR i IN 0..n-1 LOOP
        netaA  := netaB;
        nxA    := nxB;
        nyA    := nyB;
        nxADot := nxBDot;
        nyADot := nyBDot;
        netaB    :=netaB+ ndEta;
        ncosEtaB  := cos(netaB);
        nsinEtaB  := sin(netaB);
        naCosEtaB := na * ncosEtaB;
        nbSinEtaB := nb * nsinEtaB;
        naSinEtaB := na * nsinEtaB;
        nbCosEtaB := nb * ncosEtaB;
        nxB       := ncx + naCosEtaB * ncosTheta - nbSinEtaB * nsinTheta;
        nyB       := ncy + naCosEtaB * nsinTheta + nbSinEtaB * ncosTheta;
        nxBDot    := -naSinEtaB * ncosTheta - nbCosEtaB * nsinTheta;
        nyBDot    := -naSinEtaB * nsinTheta + nbCosEtaB * ncosTheta;
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_CURVE_TO;
        lPath(iPos).nVal1:=nxA + nalpha * nxADot;
        lPath(iPos).nVal2:=nyA + nalpha * nyADot;
        lPath(iPos).nVal3:=nxB - nalpha * nxBDot;
        lPath(iPos).nVal4:=nyB - nalpha * nyBDot;
        lPath(iPos).nVal5:=nxB;
        lPath(iPos).nVal6:=nyB;
      END LOOP;
      if (bisPieSlice) THEN
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_LINE_TO;
        lPath(iPos).nVal1:=ncx;
        lPath(iPos).nVal2:=ncy;
      ELSE
        iPos:=lPath.COUNT+1;
        lPath(iPos).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
        lPath(iPos).nVal1:=ncx;
        lPath(iPos).nVal2:=ncy;
      END IF;
      iPos:=lPath.COUNT+1;
      lPath(iPos).nType:=AS_PDF3_MOD.PATH_CLOSE;
    END;
  BEGIN
    ncx         := i_ncx;
    ncy         := i_ncy;
    na          := i_na;
    nb          := i_nb;
    ntheta      := 0;--i_ntheta;
    bisPieSlice := i_bisPieSlice;
    neta1       := ATAN2(sin(i_nlambda1) / nb,
                            cos(i_nlambda1) / na);
    neta2       := ATAN2(sin(i_nlambda2) / nb,
                            cos(i_nlambda2) / na);
    ncosTheta   := cos(ntheta);
    nsinTheta   := sin(ntheta);
    nmaxDegree  := 3;
    ndefaultFlatness := 0.5; -- half a pixel
    -- make sure we have eta1 <= eta2 <= eta1 + 2 PI
    neta2 :=nEta2-TWO_PI * floor((neta2 - neta1) / TWO_PI);
    -- the preceding correction fails if we have exactly et2 - eta1 = 2 PI
    -- it reduces the interval to zero length
    if ((i_nlambda2 - i_nlambda1 > PI) AND (neta2 - neta1 < PI)) THEN
      neta2 :=neta2+ 2 * PI;
    END IF;
    --computeFocii();
    nd  := sqrt(na * na - nb * nb);
    ndx := nd * ncosTheta;
    ndy := nd * nsinTheta;
    nxF1 := ncx - ndx;
    nyF1 := ncy - ndy;
    nxF2 := ncx + ndx;
    nyF2 := ncy + ndy;
    --computeEndPoints();
    -- start point
    naCosEta1 := na * cos(neta1);
    nbSinEta1 := nb * sin(neta1);
    nx1 := ncx + naCosEta1 * ncosTheta - nbSinEta1 * nsinTheta;
    ny1 := ncy + naCosEta1 * nsinTheta + nbSinEta1 * ncosTheta;
    -- end point
    naCosEta2 := na * cos(neta2);
    nbSinEta2 := nb * sin(neta2);
    nx2 := ncx + naCosEta2 * ncosTheta - nbSinEta2 * nsinTheta;
    ny2 := ncy + naCosEta2 * nsinTheta + nbSinEta2 * ncosTheta;
   -- computeDerivedFlatnessParameters();
    nf   := (na - nb) / na;
    ne2  := nf * (2.0 - nf);
    ng   := 1.0 - nf;
    ng2  := ng * ng;
    PR_BUILD_PATH;
    RETURN lPath;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_DEFAULT_SHAPES IS
  BEGIN
    -- Square
    lDefaultShapes(1)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(1)(1).nVal1:=-3;
    lDefaultShapes(1)(1).nVal2:=-3;
    lDefaultShapes(1)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(1)(2).nVal1:=-3;
    lDefaultShapes(1)(2).nVal2:=3;
    lDefaultShapes(1)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(1)(3).nVal1:=3;
    lDefaultShapes(1)(3).nVal2:=3;
    lDefaultShapes(1)(4).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(1)(4).nVal1:=3;
    lDefaultShapes(1)(4).nVal2:=-3;
    lDefaultShapes(1)(5).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- triangle down
    lDefaultShapes(2)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(2)(1).nVal1:=0;
    lDefaultShapes(2)(1).nVal2:=3;
    lDefaultShapes(2)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(2)(2).nVal1:=-3;
    lDefaultShapes(2)(2).nVal2:=-3;
    lDefaultShapes(2)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(2)(3).nVal1:=3;
    lDefaultShapes(2)(3).nVal2:=-3;
    lDefaultShapes(2)(4).nType:=AS_PDF3_MOD.PATH_CLOSE;
    lDefaultShapes(3):=FK_CALC_PIESLICE(i_nCX         =>0,
                                        i_nCY         =>0,
                                        i_nA          =>3.5,
                                        i_nB          =>3.5,
                                        i_nLambda1    =>0,
                                        i_nLambda2    =>360,
                                        i_bIsPieSlice =>FALSE);
    -- diamond
    lDefaultShapes(4)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(4)(1).nVal1:=-3;
    lDefaultShapes(4)(1).nVal2:=0;
    lDefaultShapes(4)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(4)(2).nVal1:=0;
    lDefaultShapes(4)(2).nVal2:=3;
    lDefaultShapes(4)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(4)(3).nVal1:=3;
    lDefaultShapes(4)(3).nVal2:=0;
    lDefaultShapes(4)(4).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(4)(4).nVal1:=0;
    lDefaultShapes(4)(4).nVal2:=-3;
    lDefaultShapes(4)(5).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- flat Square
    lDefaultShapes(5)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(5)(1).nVal1:=-3;
    lDefaultShapes(5)(1).nVal2:=-1.5;
    lDefaultShapes(5)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(5)(2).nVal1:=-3;
    lDefaultShapes(5)(2).nVal2:=1.5;
    lDefaultShapes(5)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(5)(3).nVal1:=3;
    lDefaultShapes(5)(3).nVal2:=1.5;
    lDefaultShapes(5)(4).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(5)(4).nVal1:=3;
    lDefaultShapes(5)(4).nVal2:=-1.5;
    lDefaultShapes(5)(5).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- triangle down
    lDefaultShapes(6)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(6)(1).nVal1:=0;
    lDefaultShapes(6)(1).nVal2:=-3;
    lDefaultShapes(6)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(6)(2).nVal1:=-3;
    lDefaultShapes(6)(2).nVal2:=3;
    lDefaultShapes(6)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(6)(3).nVal1:=3;
    lDefaultShapes(6)(3).nVal2:=3;
    lDefaultShapes(6)(4).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- flat ellipse
    lDefaultShapes(7):=FK_CALC_PIESLICE(i_nCX         =>0,
                                        i_nCY         =>0,
                                        i_nA          =>3.5,
                                        i_nB          =>1.5,
                                        i_nLambda1    =>0,
                                        i_nLambda2    =>360,
                                        i_bIsPieSlice =>FALSE);
    -- triangle right
    lDefaultShapes(8)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(8)(1).nVal1:=-3;
    lDefaultShapes(8)(1).nVal2:=-3;
    lDefaultShapes(8)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(8)(2).nVal1:=3;
    lDefaultShapes(8)(2).nVal2:=0;
    lDefaultShapes(8)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(8)(3).nVal1:=-3;
    lDefaultShapes(8)(3).nVal2:=3;
    lDefaultShapes(8)(4).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- flat Square
    lDefaultShapes(9)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(9)(1).nVal1:=-1.5;
    lDefaultShapes(9)(1).nVal2:=-3;
    lDefaultShapes(9)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(9)(2).nVal1:=-1.5;
    lDefaultShapes(9)(2).nVal2:=3;
    lDefaultShapes(9)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(9)(3).nVal1:=1.5;
    lDefaultShapes(9)(3).nVal2:=3;
    lDefaultShapes(9)(4).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(9)(4).nVal1:=1.5;
    lDefaultShapes(9)(4).nVal2:=-3;
    lDefaultShapes(9)(5).nType:=AS_PDF3_MOD.PATH_CLOSE;
    -- triangle left
    lDefaultShapes(10)(1).nType:=AS_PDF3_MOD.PATH_MOVE_TO;
    lDefaultShapes(10)(1).nVal1:=3;
    lDefaultShapes(10)(1).nVal2:=-3;
    lDefaultShapes(10)(2).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(10)(2).nVal1:=-3;
    lDefaultShapes(10)(2).nVal2:=0;
    lDefaultShapes(10)(3).nType:=AS_PDF3_MOD.PATH_LINE_TO;
    lDefaultShapes(10)(3).nVal1:=3;
    lDefaultShapes(10)(3).nVal2:=3;
    lDefaultShapes(10)(4).nType:=AS_PDF3_MOD.PATH_CLOSE;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_INIT_DEFAULT_NUM_TICKS IS
    nTick1 NUMBER:=0.000000000000001;
    nTick2 NUMBER:=0.000000000000002;
    nTick3 NUMBER:=0.0000000000000025;
    nTick4 NUMBER:=0.000000000000005;
    nTick5 NUMBER:=0.0000000000000075;
    vcPattern PK_JRXML2PDF_TYPES.tPattern:='0.0000000000000000';
    PROCEDURE PR_ADD_TICK(i_nValue    IN NUMBER,
                          i_vcPattern IN VARCHAR2) IS
      iPos PLS_INTEGER:=lDefaultNumberTicks.COUNT+1;
    BEGIN
      lDefaultNumberTicks(iPos).rDataEntry.nValue:=i_nValue;
      lDefaultNumberTicks(iPos).vcPattern:=i_vcPattern;
    END;
  BEGIN
    FOR i IN 1..30 LOOP
      PR_ADD_TICK(nTick1, 'FM' || vcPattern);
      PR_ADD_TICK(nTick2, 'FM' || vcPattern);
      PR_ADD_TICK(nTick3, 'FM' || vcPattern);
      PR_ADD_TICK(nTick4, 'FM' || vcPattern);
      PR_ADD_TICK(nTick5, 'FM' || vcPattern);
      nTick1:=nTick1*10;
      nTick2:=nTick2*10;
      nTick3:=nTick3*10;
      nTick4:=nTick4*10;
      nTick5:=nTick5*10;
      IF i<16 THEN
        vcPattern:=SUBSTR(vcPattern, 1, LENGTH(vcPattern)-1);
      ELSIF i=16 THEN
        vcPattern:='90';
      ELSE
        IF MOD(i,3)=0 THEN
          vcPattern:='G' || vcPattern;
        END IF;
        vcPattern:='9' || vcPattern;
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_INIT_DEFAULT_DATE_TICKS IS
    nTick1 NUMBER:=0.000000000000001;
    nTick2 NUMBER:=0.000000000000002;
    nTick3 NUMBER:=0.0000000000000025;
    nTick4 NUMBER:=0.000000000000005;
    nTick5 NUMBER:=0.0000000000000075;
    vcPattern PK_JRXML2PDF_TYPES.tPattern:='0.0000000000000000';
    PROCEDURE PR_ADD_TICK(i_nValue    IN NUMBER,
                          i_vcPattern IN VARCHAR2,
                          i_vcUnit    IN VARCHAR2) IS
      iPos PLS_INTEGER:=lDefaultDateTicks.COUNT+1;
    BEGIN
      lDefaultDateTicks(iPos).rDataEntry.nValue:=i_nValue;
      lDefaultDateTicks(iPos).vcPattern:=i_vcPattern;
      lDefaultDateTicks(iPos).vcUnit:=i_vcUnit;
    END;
  BEGIN
    -- second
    PR_ADD_TICK( 1, 'MI:SS', 'SS');
    -- 2 second
    PR_ADD_TICK( 2, 'MI:SS', 'SS');
    -- 5 second
    PR_ADD_TICK( 5, 'MI:SS', 'SS');
    -- 10 second
    PR_ADD_TICK(10, 'MI:SS', 'SS');
    -- 15 second
    PR_ADD_TICK(15, 'MI:SS', 'SS');
    -- 30 second
    PR_ADD_TICK(30, 'MI:SS', 'SS');
    -- 1 minute
    PR_ADD_TICK( 1, 'HH24:MI', 'MI');
    -- 2 minute
    PR_ADD_TICK( 2, 'HH24:MI', 'MI');
    -- 5 minute
    PR_ADD_TICK( 5, 'HH24:MI', 'MI');
    -- 10 minute
    PR_ADD_TICK(10, 'HH24:MI', 'MI');
    -- 15 minute
    PR_ADD_TICK(15, 'HH24:MI', 'MI');
    -- 30 minute
    PR_ADD_TICK(30, 'HH24:MI', 'MI');
    -- 1 hour
    PR_ADD_TICK( 1, 'HH24', 'HH');
    -- 2 hour
    PR_ADD_TICK( 2, 'HH24', 'HH');
    -- 4 hour
    PR_ADD_TICK( 4, 'HH24', 'HH');
    -- 6 hour
    PR_ADD_TICK( 6, 'HH24', 'HH');
    -- 8 hour
    PR_ADD_TICK( 8, 'HH24', 'HH');
    -- 12 hour
    PR_ADD_TICK(12, 'HH24', 'HH');
    -- 1 day
    PR_ADD_TICK( 1, 'DD.MM.', 'DD');
    -- 2 days
    PR_ADD_TICK( 2, 'DD.MM.', 'DD');
    -- 5 days
    PR_ADD_TICK( 5, 'DD.MM.', 'DD');
    -- 10 days
    PR_ADD_TICK(10, 'DD.MM.', 'DD');
    -- 15 days
    PR_ADD_TICK(15, 'DD.MM.', 'DD');
    -- 1 month
    PR_ADD_TICK( 1, 'MM.YYYY', 'MM');
    -- 2 months
    PR_ADD_TICK( 2, 'MM.YYYY', 'MM');
    -- 3 months
    PR_ADD_TICK( 3, 'MM.YYYY', 'MM');
    -- 6 months
    PR_ADD_TICK( 6, 'MM.YYYY', 'MM');
    -- 1 year
    PR_ADD_TICK( 1, 'YYYY', 'YYYY');
    -- 2 years
    PR_ADD_TICK( 2, 'YYYY', 'YYYY');
    -- 5 years
    PR_ADD_TICK( 5, 'YYYY', 'YYYY');
    -- 10 years
    PR_ADD_TICK(10, 'YYYY', 'YYYY');
    -- 20 years
    PR_ADD_TICK(20, 'YYYY', 'YYYY');
    -- 25 years
    PR_ADD_TICK(25, 'YYYY', 'YYYY');
    -- 50 years
    PR_ADD_TICK(50, 'YYYY', 'YYYY');
    -- 100 years
    PR_ADD_TICK(100, 'YYYY', 'YYYY');
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_NUM_PATTERN_FOR_VALUE(i_nValue IN NUMBER)
  RETURN PK_JRXML2PDF_TYPES.tPattern IS
    vcPattern PK_JRXML2PDF_TYPES.tPattern;
  BEGIN
    FOR i IN 1..lDefaultNumberTicks.COUNT LOOP
      IF lDefaultNumberTicks(i).rDataEntry.nValue>i_nValue THEN
        vcPattern:=lDefaultNumberTicks(i).vcPattern;
        EXIT;
      END IF;
    END LOOP;
    RETURN vcPattern;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_NUM_TICK_ENTRIES(i_nMinValue  IN NUMBER,
                                    i_nMaxValue  IN NUMBER,
                                    i_nSpace     IN NUMBER,
                                    i_nTickSpace IN NUMBER,
                                    i_vcPattern  IN PK_JRXML2PDF_TYPES.tPattern)
  RETURN tTickEntryList IS
    lTickEntries             tTickEntryList;
    nTicksToShow             NUMBER:=GREATEST(ROUND(i_nSpace/i_nTickSpace),1);
    nValueRange              NUMBER:=i_nMaxValue-i_nMinValue;
    nApproximateTickDistance NUMBER:=nValueRange/nTicksToShow;
    nValue                   NUMBER;
    iTickIndex               PLS_INTEGER;
    vcIndex                  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcPattern                PK_JRXML2PDF_TYPES.tPattern:=i_vcPattern;
  BEGIN
    IF vcPattern IS NULL THEN
      vcPattern:=FK_GET_NUM_PATTERN_FOR_VALUE(nValueRange);
    END IF;
    FOR i IN 1..lDefaultNumberTicks.COUNT LOOP
      IF lDefaultNumberTicks(i).rDataEntry.nValue>=nApproximateTickDistance THEN
        iTickIndex:=i;
        EXIT;
      END IF;
    END LOOP;
    IF iTickIndex>1 THEN
      iTickIndex:=iTickIndex-1;
    END IF;
    IF iTickIndex>0 THEN
      -- round first tick to match spacing
      IF i_nMinValue!=0 THEN
        nValue:=ROUND(i_nMinValue/lDefaultNumberTicks(iTickIndex).rDataEntry.nValue)*lDefaultNumberTicks(iTickIndex).rDataEntry.nValue;
      ELSE
        nValue:=0;
      END IF;
      -- create ticks
      WHILE nValue<i_nMaxValue LOOP
        vcIndex:=TO_CHAR(nValue, 'FM00000000000000000000D00000000000000000');
        lTickEntries(vcIndex).rDataEntry.nValue:=nValue;
        lTickEntries(vcIndex).vcPattern:=vcPattern;
        nValue:=nValue+lDefaultNumberTicks(iTickIndex).rDataEntry.nValue;
      END LOOP;
    END IF;
    RETURN lTickEntries;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_TICK_VALUE_FOR_ENTRY(i_iIdx IN PLS_INTEGER)
  RETURN NUMBER IS
  BEGIN
    IF lDefaultDateTicks(i_iIdx).vcUnit='SS' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue/(24*60*60);
    ELSIF lDefaultDateTicks(i_iIdx).vcUnit='MI' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue/(24*60);
    ELSIF lDefaultDateTicks(i_iIdx).vcUnit='HH' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue/24;
    ELSIF lDefaultDateTicks(i_iIdx).vcUnit='DD' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue;
    ELSIF lDefaultDateTicks(i_iIdx).vcUnit='MM' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue*30;
    ELSIF lDefaultDateTicks(i_iIdx).vcUnit='YYYY' THEN
      RETURN lDefaultDateTicks(i_iIdx).rDataEntry.nValue*365;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_DATE_PATTERN_FOR_VALUE(i_nValue IN NUMBER)
  RETURN PK_JRXML2PDF_TYPES.tPattern IS
    vcPattern PK_JRXML2PDF_TYPES.tPattern;
  BEGIN
    FOR i IN 1..lDefaultDateTicks.COUNT LOOP
      IF FK_TICK_VALUE_FOR_ENTRY(i)>i_nValue THEN
        vcPattern:=lDefaultDateTicks(i).vcPattern;
        EXIT;
      END IF;
    END LOOP;
    RETURN vcPattern;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_DATE_TICK_ENTRIES(i_dtMinValue IN DATE,
                                     i_dtMaxValue IN DATE,
                                     i_nSpace     IN NUMBER,
                                     i_nTickSpace IN NUMBER,
                                     i_vcPattern  IN PK_JRXML2PDF_TYPES.tPattern)
  RETURN tTickEntryList IS
    lTickEntries             tTickEntryList;
    nTicksToShow             NUMBER:=GREATEST(ROUND(i_nSpace/i_nTickSpace),1);
    nValueRange              NUMBER:=i_dtMaxValue-i_dtMinValue;
    nApproximateTickDistance NUMBER:=nValueRange/nTicksToShow;
    dtValue                  DATE;
    iTickIndex               PLS_INTEGER;
    vcIndex                  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcPattern                PK_JRXML2PDF_TYPES.tPattern:=i_vcPattern;
  BEGIN
    IF vcPattern IS NULL THEN
      vcPattern:=FK_GET_DATE_PATTERN_FOR_VALUE(nValueRange);
    END IF;
    FOR i IN 1..lDefaultDateTicks.COUNT LOOP
      IF FK_TICK_VALUE_FOR_ENTRY(i)>=nApproximateTickDistance THEN
        iTickIndex:=i;
        EXIT;
      END IF;
    END LOOP;
    IF iTickIndex>1 THEN
      iTickIndex:=iTickIndex-1;
    END IF;
    IF iTickIndex>0 THEN
      -- round first tick to match spacing
      --TODO round to unit dtValue:=ROUND(i_dtMinValue/lDefaultDateTicks(iTickIndex).rDataEntry.nValue)*lDefaultDateTicks(iTickIndex).rDataEntry.nValue;
      dtValue:=i_dtMinValue;
      -- create ticks
      WHILE dtValue<i_dtMaxValue LOOP
        vcIndex:=TO_CHAR(dtValue, 'YYYYMMDDHH24MISS');
        lTickEntries(vcIndex).rDataEntry.dtValue:=dtValue;
        lTickEntries(vcIndex).vcPattern:=vcPattern;
        dtValue:=dtValue+FK_TICK_VALUE_FOR_ENTRY(iTickIndex);
      END LOOP;
    END IF;
    RETURN lTickEntries;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_BASE_PLOT
  RETURN tPlot IS
    rPlot tPlot;
  BEGIN
    rPlot.nLabelPosition  :=VALUE_POSITION_NONE;
    rPlot.vcLabelColor    :=PK_JRXML2PDF_TYPES.BLACK;
    rPlot.vcLabelFont     :=PK_JRXML2PDF_TYPES.ARIAL;
    rPlot.vcLabelFontStyle:=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rPlot.nLabelFontSize  :=10;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_CATEGORY_BAR_PLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType         :=PLOT_CATEGORY_BARCHART;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_CATEGORY_LINE_PLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType         :=PLOT_CATEGORY_LINECHART;
    rPlot.vcShowShapes  :=PK_JRXML2PDF_TYPES.YES;
    rPlot.vcShowLines   :=PK_JRXML2PDF_TYPES.YES;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_XY_LINE_PLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType:=PLOT_XY_LINECHART;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_PIECHART_PLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType:=PLOT_PIECHART;
    rPlot.nLabelPosition:=VALUE_POSITION_OUTSIDE;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_TIMESERIES_LINE_PLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType:=PLOT_TIMESERIES_LINECHART;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_STACKED_BARPLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType:=PLOT_STACKED_BARCHART;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_STACKED_AREAPLOT
  RETURN tPlot IS
    rPlot tPlot:=FK_CREATE_BASE_PLOT;
  BEGIN
    rPlot.nType:=PLOT_STACKED_AREACHART;
    RETURN rPlot;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_LEGEND(i_rPlot IN tPlot)
  RETURN tLegend IS
    rLegend tLegend;
  BEGIN
    rLegend.rPlot        :=i_rPlot;
    rLegend.vcPosition    :=POSITION_BOTTOM;
    rLegend.vcFont       :=PK_JRXML2PDF_TYPES.ARIAL;
    rLegend.vcFontStyle  :=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rLegend.nFontSize   :=12;
    rLegend.vcFontColor  :=PK_JRXML2PDF_TYPES.BLACK;
    rLegend.vcBgColor    :=NULL;
    rLegend.vcBorderColor:=PK_JRXML2PDF_TYPES.BLACK;
    rLegend.rOuterPaddings.nLeft  :=5;
    rLegend.rOuterPaddings.nTop   :=5;
    rLegend.rOuterPaddings.nRight :=5;
    rLegend.rOuterPaddings.nBottom:=5;
    rLegend.rInnerPaddings.nLeft  :=5;
    rLegend.rInnerPaddings.nTop   :=5;
    rLegend.rInnerPaddings.nRight :=5;
    rLegend.rInnerPaddings.nBottom:=5;
    rLegend.nEntryXSpacing:=4;
    rLegend.nEntryYSpacing:=4;
    rLegend.nScaleToWidthPercentage:=0.8;
    RETURN rLegend;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_DARKER(i_vcColor IN PK_JRXML2PDF_TYPES.tColor)
  RETURN PK_JRXML2PDF_TYPES.tColor IS
    vcR PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 1, 2);
    vcG PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 3, 2);
    vcB PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 5, 2);
  BEGIN
    vcR:=TO_CHAR(GREATEST(TO_NUMBER(vcR, 'XX')-40, 0), 'FM0X');
    vcG:=TO_CHAR(GREATEST(TO_NUMBER(vcG, 'XX')-40, 0), 'FM0X');
    vcB:=TO_CHAR(GREATEST(TO_NUMBER(vcB, 'XX')-40, 0), 'FM0X');
    RETURN vcR || vcG || vcB;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LIGHTER(i_vcColor IN PK_JRXML2PDF_TYPES.tColor)
  RETURN PK_JRXML2PDF_TYPES.tColor IS
    vcR PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 1, 2);
    vcG PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 3, 2);
    vcB PK_JRXML2PDF_TYPES.tColor:=SUBSTR(REPLACE(i_vcColor, '#', ''), 5, 2);
  BEGIN
    vcR:=TO_CHAR(LEAST(TO_NUMBER(vcR, 'XX')+40, 255), 'FM0X');
    vcG:=TO_CHAR(LEAST(TO_NUMBER(vcG, 'XX')+40, 255), 'FM0X');
    vcB:=TO_CHAR(LEAST(TO_NUMBER(vcB, 'XX')+40, 255), 'FM0X');
    RETURN vcR || vcG || vcB;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_VALUE_AXIS
  RETURN tAxis IS
    rValueAxis tAxis;
  BEGIN
    rValueAxis.nAxisType:=AXIS_TYPE_VALUE;
    rValueAxis.nValueType:=AXIS_VALUE;
    rValueAxis.nPosition:=POSITION_TOP_OR_LEFT;
    rValueAxis.nOrientation:=ORIENTATION_VERTICAL;
    rValueAxis.nMinValueType:=VALUE_AUTOMATIC;
    rValueAxis.vcInclude0Value:=PK_JRXML2PDF_TYPES.YES;
    rValueAxis.nMaxValueType:=VALUE_AUTOMATIC;
    rValueAxis.nAdditionalPercent:=5;
    rValueAxis.nWidthType:=VALUE_AUTOMATIC;
    rValueAxis.vcDotLineColor:=MID_GRAY;
    rValueAxis.vcShowTickLabels    :=PK_JRXML2PDF_TYPES.YES;
    rValueAxis.vcShowTickMarks     :=PK_JRXML2PDF_TYPES.YES;
    rValueAxis.vcShowDotlines      :=PK_JRXML2PDF_TYPES.YES;
    rValueAxis.vcLabelColor        :=PK_JRXML2PDF_TYPES.BLACK;
    rValueAxis.vcLabelFont         :=PK_JRXML2PDF_TYPES.ARIAL;
    rValueAxis.vcLabelFontStyle    :=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rValueAxis.nLabelFontSize      :=10;
    rValueAxis.vcTickLabelColor    :=PK_JRXML2PDF_TYPES.BLACK;
    rValueAxis.vcTickLabelFont     :=PK_JRXML2PDF_TYPES.ARIAL;
    rValueAxis.vcTickLabelFontStyle:=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rValueAxis.nTickLabelFontSize  :=10;
    rValueAxis.vcLineColor         :=PK_JRXML2PDF_TYPES.BLACK;
    rValueAxis.nAxisLineWidth      :=1;
    rValueAxis.nStartOffset        :=0;
    rValueAxis.nEndOffset          :=10;
    rValueAxis.nDataOffset         :=0;
    rValueAxis.nTickLabelOffset    :=0;
    rValueAxis.nTickSpace          :=60;
    RETURN rValueAxis;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_RANGE_AXIS(i_nAxisType IN tAxisType)
  RETURN tAxis IS
    rRangeAxis tAxis;
  BEGIN
    rRangeAxis.nAxisType:=AXIS_TYPE_RANGE;
    rRangeAxis.nValueType:=i_nAxisType;
    rRangeAxis.nPosition:=POSITION_BOTTOM_OR_RIGHT;
    rRangeAxis.nOrientation:=ORIENTATION_HORIZONTAL;
    rRangeAxis.nMinValueType:=VALUE_AUTOMATIC;
    rRangeAxis.nMaxValueType:=VALUE_AUTOMATIC;
    rRangeAxis.nAdditionalPercent:=5;
    rRangeAxis.vcInclude0Value:=PK_JRXML2PDF_TYPES.YES;
    rRangeAxis.nHeightType:=VALUE_AUTOMATIC;
    rRangeAxis.vcShowTickLabels:=PK_JRXML2PDF_TYPES.YES;
    IF i_nAxisType!=AXIS_CATEGORY THEN
      rRangeAxis.vcDotLineColor:=MID_GRAY;
      rRangeAxis.vcShowTickMarks   :=PK_JRXML2PDF_TYPES.YES;
      rRangeAxis.nStartOffset      :=0;
    ELSE
      rRangeAxis.vcShowTickMarks   :=PK_JRXML2PDF_TYPES.NO;
      -- Starting offset
      rRangeAxis.nStartOffset      :=10;
    END IF;
    rRangeAxis.vcShowDotlines      :=PK_JRXML2PDF_TYPES.YES;
    rRangeAxis.vcLabelColor        :=PK_JRXML2PDF_TYPES.BLACK;
    rRangeAxis.vcLabelFont         :=PK_JRXML2PDF_TYPES.ARIAL;
    rRangeAxis.vcLabelFontStyle    :=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rRangeAxis.nLabelFontSize      :=10;
    rRangeAxis.vcTickLabelColor    :=PK_JRXML2PDF_TYPES.BLACK;
    rRangeAxis.vcTickLabelFont     :=PK_JRXML2PDF_TYPES.ARIAL;
    rRangeAxis.vcTickLabelFontStyle:=PK_JRXML2PDF_TYPES.FONT_NORMAL;
    rRangeAxis.nTickLabelFontSize  :=10;
    rRangeAxis.vcLineColor         :=PK_JRXML2PDF_TYPES.BLACK;
    rRangeAxis.nAxisLineWidth      :=1;
    rRangeAxis.nEndOffset          :=10;
    rRangeAxis.nDataOffset         :=0;
    rRangeAxis.nTickLabelOffset    :=0;
    rRangeAxis.nTickSpace          :=60;
    RETURN rRangeAxis;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_SERIES(i_vcName IN VARCHAR2)
  RETURN tSeries IS
    rSeries tSeries;
  BEGIN
    rSeries.vcName:=i_vcName;
    RETURn rSeries;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_XY_DATASET
  RETURN tDataset IS
    rDataset tDataset;
  BEGIN
    rDataset.vcValueType:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    rDataset.vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    rDataset.nGroup:=1;
    rDataset.nValueAxis:=1;
    rDataset.nRangeAxis:=1;
    RETURN rDataset;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_CATEGORY_DATASET
  RETURN tDataset IS
    rDataset tDataset;
  BEGIN
    rDataset.vcValueType:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    rDataset.vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
    rDataset.nGroup:=1;
    rDataset.nValueAxis:=1;
    rDataset.nRangeAxis:=1;
    RETURN rDataset;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_TIMESERIES_DATASET
  RETURN tDataset IS
    rDataset tDataset;
  BEGIN
    rDataset.vcValueType:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    rDataset.vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
    rDataset.nGroup:=1;
    rDataset.nValueAxis:=1;
    rDataset.nRangeAxis:=1;
    RETURN rDataset;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_SERIES(io_rChart IN OUT NOCOPY tChart, i_rSeries IN tSeries) IS
    iSeries PLS_INTEGER:=io_rChart.lSeries.COUNT+1;
  BEGIN
    io_rChart.lSeries(iSeries):=i_rSeries;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_DATASET(io_rChart IN OUT NOCOPY tChart, i_nPlotIndex IN NUMBER, i_rDataSet IN tDataset, i_vcSeries IN VARCHAR2 DEFAULT NULL) IS
    iPos PLS_INTEGER:=io_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT+1;
    iSeries PLS_INTEGER:=io_rChart.lSeries.COUNT+1;
  BEGIN
    IF i_vcSeries IS NULL THEN
      iSeries:=NULL;
    ELSE
      FOR i IN 1..io_rChart.lSeries.COUNT LOOP
        IF io_rChart.lSeries(i).vcName=i_vcSeries THEN
          iSeries:=i;
          EXIT;
        END IF;
      END LOOP;
      IF iSeries>io_rChart.lSeries.COUNT THEN
        io_rChart.lSeries(iSeries):=FK_CREATE_SERIES(i_vcSeries);
      END IF;
    END IF;
    io_rChart.lPlots(i_nPlotIndex).lDataSets(iPos):=i_rDataSet;
    io_rChart.lPlots(i_nPlotIndex).lDataSets(iPos).nSeries:=iSeries;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_DATASET(io_rChart IN OUT NOCOPY tChart, i_nPlotIndex IN NUMBER, i_rDataSet IN tDataset, i_nSeries IN NUMBER) IS
    iPos PLS_INTEGER:=io_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT+1;
  BEGIN
    IF io_rChart.lSeries.EXISTS(i_nSeries) THEN
      io_rChart.lPlots(i_nPlotIndex).lDataSets(iPos):=i_rDataSet;
      io_rChart.lPlots(i_nPlotIndex).lDataSets(iPos).nSeries:=i_nSeries;
    ELSE
      RAISE NO_DATA_FOUND;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_BASE_CHART
  RETURN tChart IS
    rChart tChart;
  BEGIN
    rChart.vcTitleFont        :=PK_JRXML2PDF_TYPES.ARIAL;
    rChart.vcTitleFontStyle   :=PK_JRXML2PDF_TYPES.FONT_BOLD;
    rChart.nTitleFontSize     :=16;
    rChart.vcTitleColor       :=PK_JRXML2PDF_TYPES.BLACK;
    rChart.vcSubTitleFont     :=PK_JRXML2PDF_TYPES.ARIAL;
    rChart.vcSubTitleFontStyle:=PK_JRXML2PDF_TYPES.FONT_BOLD;
    rChart.nSubTitleFontSize  :=14;
    rChart.vcSubTitleColor    :=PK_JRXML2PDF_TYPES.BLACK;
    rChart.vcTitlePosition    :=POSITION_TOP;
    rChart.rInnerPaddings.nLeft:=10;
    rChart.rInnerPaddings.nTop:=0;
    rChart.rInnerPaddings.nRight:=10;
    rChart.rInnerPaddings.nBottom:=0;
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_CATEGORY_BAR_CHART(i_nWidth  IN NUMBER,
                                        i_nHeight IN NUMBER
                                       )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_CATEGORY_BAR_PLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_CATEGORY);
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_CATEGORY_LINE_CHART(i_nWidth  IN NUMBER,
                                         i_nHeight IN NUMBER
                                        )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_CATEGORY_LINE_PLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_CATEGORY);
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_PIE_CHART(i_nWidth  IN NUMBER,
                               i_nHeight IN NUMBER
                              )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_PIECHART_PLOT;
    rChart.lPlots(1).vcKeyFormat:='{0}';
    rChart.lPlots(1).vcLabelFormat:='{0}';
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    -- By default, don�t show legend
    rChart.rLegend.vcPosition:=NULL;
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_XY_BAR_CHART(i_nWidth  IN NUMBER,
                                  i_nHeight IN NUMBER
                                 )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_CATEGORY_BAR_PLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_VALUE);
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_XY_LINE_CHART(i_nWidth  IN NUMBER,
                                   i_nHeight IN NUMBER
                                  )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_XY_LINE_PLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_VALUE);
    rChart.lRangeAxis(1).vcInclude0Value:=PK_JRXML2PDF_TYPES.NO;
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_TIME_LINE_CHART(i_nWidth  IN NUMBER,
                                     i_nHeight IN NUMBER
                                    )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_TIMESERIES_LINE_PLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).vcInclude0Value:=PK_JRXML2PDF_TYPES.NO;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_VALUE);
    rChart.lRangeAxis(1).vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_STACKED_BAR_CHART(i_nWidth  IN NUMBER,
                                       i_nHeight IN NUMBER
                                      )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_STACKED_BARPLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_CATEGORY);
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_STACKED_AREA_CHART(i_nWidth  IN NUMBER,
                                        i_nHeight IN NUMBER
                                       )
  RETURN tChart IS
    rChart tChart:=FK_CREATE_BASE_CHART;
  BEGIN
    rChart.nWidth:=i_nWidth;
    rChart.nHeight:=i_nHeight;
    rChart.lPlots(1):=FK_CREATE_STACKED_AREAPLOT;
    rChart.rLegend:=FK_CREATE_LEGEND(rChart.lPlots(1));
    rChart.lValueAxis(1):=FK_CREATE_VALUE_AXIS;
    rChart.lValueAxis(1).nTickSpace:=30;
    rChart.lRangeAxis(1):=FK_CREATE_RANGE_AXIS(AXIS_CATEGORY);
    RETURN rChart;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_RANGE_CATEGORY_KEY(i_rDataset In tDataset, i_iIdx IN PLS_INTEGER)
  RETURN PK_JRXML2PDF_TYPES.tMaxVarchar2 IS
    vcKey PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF i_rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
      vcKey:=TO_CHAR(i_rDataset.lRangeDataEntries(i_iIdx).nValue, 'FM00000000000000000000D00000000000000000');
    ELSIF i_rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
      vcKey:=TO_CHAR(i_rDataset.lRangeDataEntries(i_iIdx).dtValue, 'YYYYMMDDHH24MISS');
    ELSE
      vcKey:=i_rDataset.lRangeDataEntries(i_iIdx).vcValue;
    END IF;
    RETURN vcKey;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CALC_AXIS_MEASURES(i_rChart     IN tChart,
                                  io_rAxis IN OUT NOCOPY tAxis,
                                  i_nAxisIndex IN NUMBER) IS
    nMaxLen     NUMBER:=0;
    vcText      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rDataSet    tDataSet;
    vcDataType  PK_JRXML2PDF_TYPES.tDatatype;
    nMinValue   NUMBER:=MAX_NUMBER;
    nMaxValue   NUMBER:=MIN_NUMBER;
    dtMinValue  DATE:=MAX_DATE;
    dtMaxValue  DATE:=MIN_DATE;
    vcPattern   PK_JRXML2PDF_TYPES.tPattern;
    nXSpace     NUMBER;
    nYSpace     NUMBER;
    bStacked    BOOLEAN;
    lMinStacked tMinMaxList;
    lMaxStacked tMinMaxList;

    PROCEDURE PR_CALC_VALUE_MINMAX(i IN PLS_INTEGER, j IN PLS_INTEGER) IS
      vcKey PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      FOR t IN 1..i_rChart.lPlots(i).lDatasets(j).lValueDataEntries.COUNT LOOP
        -- Initialize min and max if stacked
        IF bStacked THEN
          nMinValue :=MAX_NUMBER;
          nMaxValue :=MIN_NUMBER;
          dtMinValue:=MAX_DATE;
          dtMaxValue:=MIN_DATE;
          vcKey:=FK_GET_RANGE_CATEGORY_KEY(i_rChart.lPlots(i).lDatasets(j), t);
        END IF;
        IF rDataset.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nMinValue:=LEAST(nMinValue, i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(t).nValue);
          nMaxValue:=GREATEST(nMaxValue, i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(t).nValue);
        ELSIF rDataset.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          dtMinValue:=LEAST(dtMinValue, i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(t).dtValue);
          dtMaxValue:=GREATEST(dtMaxValue, i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(t).dtValue);
        ELSE
          vcText:=i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(t).vcValue;
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
        -- store min and max back
        IF     bStacked
           AND vcKey IS NOT NULL THEN
          -- get value for accordin range-entry
          IF vcKey IS NOT NULL THEN
            IF lMinStacked.EXISTS(vcKey) THEN
              lMinStacked(vcKey):=lMinStacked(vcKey)+nMinValue;
            ELSE
              lMinStacked(vcKey):=nMinValue;
            END IF;
            IF lMaxStacked.EXISTS(vcKey) THEN
              lMaxStacked(vcKey):=lMaxStacked(vcKey)+nMaxValue;
            ELSE
              lMaxStacked(vcKey):=nMaxValue;
            END IF;
          END IF;
        END IF;
      END LOOP;
      -- for stacked charts, now get min and max bycategory
      IF bStacked THEN
        nMinValue :=MAX_NUMBER;
        nMaxValue :=MIN_NUMBER;
        vcKey:=lMinStacked.FIRST;
        WHILE vcKey IS NOT NULL LOOP
          nMinValue:=LEAST(nMinValue, lMinStacked(vcKey));
          nMaxValue:=GREATEST(nMaxValue, lMaxStacked(vcKey));
          vcKey:=lMinStacked.NEXT(vcKey);
        END LOOP;
      END IF;
      IF rDataset.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        IF nMaxValue!=nMinValue THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(nMaxValue-nMinValue));
        ELSIF nMaxValue!=0 THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(nMaxValue));
        ELSE
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(100));
        END IF;
        IF i_rChart.lPlots(i).lDatasets(j).lValueDataEntries.COUNT>0 THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(i_rChart.lPlots(i).lDatasets(j).lValueDataEntries.COUNT).nValue, vcPattern));
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
      ELSIF rDataset.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
        IF dtMinValue!=dtMaxValue THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_DATE_PATTERN_FOR_VALUE(dtMaxValue-dtMinValue));
        ELSE
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_DATE_PATTERN_FOR_VALUE(1));
        END IF;
        IF i_rChart.lPlots(i).lDatasets(j).lValueDataEntries.COUNT>0 THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lValueDataEntries(i_rChart.lPlots(i).lDatasets(j).lValueDataEntries.COUNT).dtValue,vcPattern));
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
      END IF;
    END;

    PROCEDURE PR_CALC_RANGE_MINMAX(i IN PLS_INTEGER, j IN PLS_INTEGER) IS
    BEGIN
      FOR t IN 1..i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT LOOP
        IF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).nValue, io_rAxis.vcTickLabelPattern));
          nMinValue:=LEAST(nMinValue, i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).nValue);
          nMaxValue:=GREATEST(nMaxValue, i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).nValue);
        ELSIF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).dtValue, io_rAxis.vcTickLabelPattern));
          dtMinValue:=LEAST(dtMinValue, i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).dtValue);
          dtMaxValue:=GREATEST(dtMaxValue, i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).dtValue);
        ELSE
          vcText:=i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).vcValue;
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
      END LOOP;
      IF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        IF nMaxValue!=nMinValue THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(nMaxValue-nMinValue));
        ELSIF nMaxValue!=0 THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(nMaxValue));
        ELSE
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_NUM_PATTERN_FOR_VALUE(100));
        END IF;
        IF i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT>0 THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT).nValue, vcPattern));
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
      ELSIF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
        IF dtMinValue!=dtMaxValue THEN
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_DATE_PATTERN_FOR_VALUE(dtMaxValue-dtMinValue));
        ELSE
          vcPattern:=NVL(io_rAxis.vcTickLabelPattern, FK_GET_DATE_PATTERN_FOR_VALUE(1));
        END IF;
        IF i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT>0 THEN
          vcText:=TRIM(TO_CHAR(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT).dtValue,vcPattern));
          nMaxLen:=GREATEST(nMaxLen, AS_PDF3_MOD.str_len(vcText));
        END IF;
      END IF;
    END;
  BEGIN
    -- change rotation
    IF NVL(io_rAxis.nTicklabelRotation,0)!=0 THEN
      io_rAxis.nTicklabelRotation:=360-io_rAxis.nTicklabelRotation;
    END IF;
    FOR i IN 1..i_rChart.lPlots.COUNT LOOP
      bStacked:=i_rChart.lPlots(i).nType IN(PLOT_STACKED_BARCHART, PLOT_STACKED_AREACHART);
      -- initialize aggregats
      nMaxLen   :=0;
      nMinValue :=MAX_NUMBER;
      nMaxValue :=MIN_NUMBER;
      dtMinValue:=MAX_DATE;
      dtMaxValue:=MIN_DATE;
      lMinStacked.DELETE;
      lMaxStacked.DELETE;
      FOR j IN 1..i_rChart.lPlots(i).lDatasets.COUNT LOOP
        IF    (    i_rChart.lPlots(i).lDatasets(j).nValueAxis=i_nAxisIndex
               AND io_rAxis.nAxisType=AXIS_TYPE_VALUE
              )
           OR (    i_rChart.lPlots(i).lDatasets(j).nRangeAxis=i_nAxisIndex
               AND io_rAxis.nAxisType=AXIS_TYPE_RANGE
              ) THEN
          rDataSet:=i_rChart.lPlots(i).lDatasets(j);
          IF vcDataType IS NULL THEN
            IF io_rAxis.nAxisType=AXIS_TYPE_VALUE THEN
              vcDatatype:=rDataset.vcValueType;
            ELSE
              vcDatatype:=rDataset.vcRangeType;
            END IF;
          END IF;
          IF io_rAxis.nAxisType=AXIS_TYPE_VALUE THEN
            PR_CALC_VALUE_MINMAX(i, j);
          ELSE
            PR_CALC_RANGE_MINMAX(i, j);
          END IF;
        END IF;
      END LOOP;
    END LOOP;
    IF io_rAxis.vcLabelText IS NOT NULL THEN
      -- set font for measuring
      PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcLabelFont,
                                    i_vcStyle    =>io_rAxis.vcLabelFontStyle,
                                    i_nSize      =>io_rAxis.nLabelFontSize
                                   );
    END IF;
    -- set measures
    -- set font for measuring
    PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcTickLabelFont,
                                  i_vcStyle    =>io_rAxis.vcTickLabelFontStyle,
                                  i_nSize      =>io_rAxis.nTickLabelFontSize
                                 );
    IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
      IF io_rAxis.nWidthType=VALUE_AUTOMATIC THEN
        IF NVL(io_rAxis.nTicklabelRotation,0) IN (90,270) THEN
          nXSpace:=AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
        ELSE
          nXSpace:=nMaxLen*cos(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0)));
        END IF;
        io_rAxis.nWidth:=GREATEST(ABS(nXSpace)+5, 5);
      END IF;
      -- Additional space if there is an axis-label
      IF io_rAxis.vcLabelText IS NOT NULL THEN
        io_rAxis.nWidth:=io_rAxis.nWidth+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
      END IF;
      -- Offsets for Data and Ticklabel
      io_rAxis.nWidth:=io_rAxis.nWidth+io_rAxis.nDataOffset+io_rAxis.nTickLabelOffset;
    ELSE
      IF io_rAxis.nHeightType=VALUE_AUTOMATIC THEN
        IF NVL(io_rAxis.nTicklabelRotation,0) IN (0,180) THEN
          nYSpace:=AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+2;
        ELSE
          nYSpace:=nMaxLen*sin(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0)));
        END IF;
        io_rAxis.nHeight:=GREATEST(ABS(nYSpace)+10, 10);
      END IF;
      -- Additional space if there is an axis-label
      IF io_rAxis.vcLabelText IS NOT NULL THEN
        io_rAxis.nHeight:=io_rAxis.nHeight+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
      END IF;
      -- Offsets for Data and Ticklabel
      io_rAxis.nHeight:=io_rAxis.nHeight+io_rAxis.nDataOffset+io_rAxis.nTickLabelOffset;
    END IF;
    -- set min and max-values
    IF vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
      io_rAxis.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
      IF io_rAxis.nMinValueType=VALUE_AUTOMATIC THEN
        IF nMinValue>0 AND io_rAxis.vcInclude0Value=PK_JRXML2PDF_TYPES.YES THEN
          nMinValue:=0;
        ELSE
          nMinValue:=nMinValue-ABS(nMinValue)*io_rAxis.nAdditionalPercent/100;
        END IF;
        io_rAxis.rMinValueDataEntry.nValue:=nMinValue;
      END IF;
      IF io_rAxis.nMaxValueType=VALUE_AUTOMATIC THEN
        nMaxValue:=nMaxValue+(nMaxValue-nMinValue)*io_rAxis.nAdditionalPercent/100;
        io_rAxis.rMaxValueDataEntry.nValue:=nMaxValue;
      ELSE
        io_rAxis.rMaxValueDataEntry.nValue:=io_rAxis.rMaxValueDataEntry.nValue+ABS(io_rAxis.rMaxValueDataEntry.nValue)*io_rAxis.nAdditionalPercent/100;
      END IF;
      io_rAxis.nMinMaxDiff:=io_rAxis.rMaxValueDataEntry.nValue-io_rAxis.rMinValueDataEntry.nValue;
    ELSIF vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
      io_rAxis.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
      IF io_rAxis.nMinValueType=VALUE_AUTOMATIC THEN
        io_rAxis.rMinValueDataEntry.dtValue:=dtMinValue;
      END IF;
      IF io_rAxis.nMinValueType=VALUE_AUTOMATIC THEN
        dtMaxValue:=dtMaxValue+(dtMaxValue-dtMinValue)*io_rAxis.nAdditionalPercent/100;
        io_rAxis.rMaxValueDataEntry.dtValue:=dtMaxValue;
      END IF;
      io_rAxis.nMinMaxDiff:=io_rAxis.rMaxValueDataEntry.dtValue-io_rAxis.rMinValueDataEntry.dtValue;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_VALUE_ON_AXIS(i_rAxis       IN tAxis,
                                i_bSnapToEdge IN BOOLEAN,
                                i_nValue      IN NUMBER)
  RETURN NUMBER IS
    nReturn NUMBER;
  BEGIN
    IF i_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
      IF i_nValue<i_rAxis.rMinValueDataEntry.nValue THEN
        IF i_bSnapToEdge THEN
          nReturn:=i_rAxis.rMinValueDataEntry.nValue;
        END IF;
      ELSIF i_nValue>i_rAxis.rMaxValueDataEntry.nValue THEN
        IF i_bSnapToEdge THEN
          nReturn:=i_rAxis.rMaxValueDataEntry.nValue;
        END IF;
      ELSE
        nReturn :=i_nValue;
      END IF;
      IF nReturn IS NOT NULL THEN
        nReturn:=i_rAxis.nStartOffset+(nReturn-i_rAxis.rMinValueDataEntry.nValue)*i_rAxis.nPixelPerUnit;
      END IF;
    END IF;
    RETURN nReturn;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_VALUE_ON_AXIS(i_rAxis       IN tAxis,
                                i_bSnapToEdge IN BOOLEAN,
                                i_dtValue     IN DATE)
  RETURN NUMBER IS
    dtValue DATE;
    nReturn NUMBER;
  BEGIN
    IF i_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
      IF i_dtValue<i_rAxis.rMinValueDataEntry.dtValue THEN
        IF i_bSnapToEdge THEN
          dtValue:=i_rAxis.rMinValueDataEntry.dtValue;
        END IF;
      ELSIF i_dtValue>i_rAxis.rMaxValueDataEntry.dtValue THEN
        IF i_bSnapToEdge THEN
          dtValue:=i_rAxis.rMaxValueDataEntry.dtValue;
        END IF;
      ELSE
        dtValue:=i_dtValue;
      END IF;
      IF dtValue IS NOT NULL THEN
        nReturn:=i_rAxis.nStartOffset+(dtValue-i_rAxis.rMinValueDataEntry.dtValue)*i_rAxis.nPixelPerUnit;
      END IF;
    END IF;
    RETURN nReturn;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_AXIS(i_rChart           IN tChart,
                           io_rAxis           IN OUT NOCOPY tAxis,
                           i_nAxisIndex       IN NUMBER,
                           i_rChartRect       IN tRect) IS
    nTicks         NUMBER;
    nTickOffset    NUMBER;
    vcText         PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nTickValueDiff NUMBER;
    nX             NUMBER;
    nY             NUMBER;
    nValue         NUMBER;
    dtValue        DATE;
    vcIndex        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    lX             AS_PDF3_MOD.tVertices;
    lY             AS_PDF3_MOD.tVertices;
    nXBaseLabel    NUMBER;
    nYBaseLabel    NUMBER;
    nXAngle        NUMBER;
    nYAngle        NUMBER;
    PROCEDURE PR_RENDER_VALUE_AXIS IS
      iPos PLS_INTEGER;
      PROCEDURE PR_CALC_TICKS IS
      BEGIN
        IF io_rAxis.lTickEntries.COUNT>0 THEN
          vcIndex:=io_rAxis.lTickEntries.FIRST;
          WHILE vcIndex IS NOT NULL LOOP
            IF io_rAxis.lTickEntries(vcIndex).vcPattern IS NULL THEN
              io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
            END IF;
            vcIndex:=io_rAxis.lTickEntries.NEXT(vcIndex);
          END LOOP;
        ELSIF io_rAxis.nTickOffset IS NOT NULL THEN
          IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            WHILE nValue<=io_rAxis.rMaxValueDataEntry.nValue LOOP
              vcIndex:=TO_CHAR(nValue, 'FM00000000000000000000D00000000000000000');
              io_rAxis.lTickEntries(vcIndex).rDataEntry.nValue:=nValue;
              io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
              nValue:=nValue+io_rAxis.nTickOffset;
            END LOOP;
          ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            WHILE dtValue<=io_rAxis.rMaxValueDataEntry.dtValue LOOP
              vcIndex:=TO_CHAR(dtValue, 'YYYYMMDDHH24MISS');
              io_rAxis.lTickEntries(vcIndex).rDataEntry.dtValue:=dtValue;
              io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
              dtValue:=dtValue+io_rAxis.nTickOffset;
            END LOOP;
          END IF;
        ELSE
          -- automatic ticks
          IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
              io_rAxis.lTickEntries:=FK_CALC_NUM_TICK_ENTRIES(i_nMinValue =>io_rAxis.rMinValueDataEntry.nValue,
                                                              i_nMaxValue =>io_rAxis.rMaxValueDataEntry.nValue,
                                                              i_nSpace    =>i_rChartRect.nHeight,
                                                              i_nTickSpace=>io_rAxis.nTickSpace,
                                                              i_vcPattern =>io_rAxis.vcTickLabelPattern
                                                             );
            ELSE
              io_rAxis.lTickEntries:=FK_CALC_NUM_TICK_ENTRIES(i_nMinValue =>io_rAxis.rMinValueDataEntry.nValue,
                                                              i_nMaxValue =>io_rAxis.rMaxValueDataEntry.nValue,
                                                              i_nSpace    =>i_rChartRect.nWidth,
                                                              i_nTickSpace=>io_rAxis.nTickSpace,
                                                              i_vcPattern =>io_rAxis.vcTickLabelPattern
                                                             );
            END IF;
          ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
              io_rAxis.lTickEntries:=FK_CALC_DATE_TICK_ENTRIES(i_dtMinValue =>io_rAxis.rMinValueDataEntry.dtValue,
                                                               i_dtMaxValue =>io_rAxis.rMaxValueDataEntry.dtValue,
                                                               i_nSpace     =>i_rChartRect.nHeight,
                                                               i_nTickSpace=>io_rAxis.nTickSpace,
                                                               i_vcPattern  =>io_rAxis.vcTickLabelPattern
                                                              );
            ELSE
              io_rAxis.lTickEntries:=FK_CALC_DATE_TICK_ENTRIES(i_dtMinValue =>io_rAxis.rMinValueDataEntry.dtValue,
                                                               i_dtMaxValue =>io_rAxis.rMaxValueDataEntry.dtValue,
                                                               i_nSpace     =>i_rChartRect.nWidth,
                                                               i_nTickSpace=>io_rAxis.nTickSpace,
                                                               i_vcPattern  =>io_rAxis.vcTickLabelPattern
                                                              );
            END IF;
          END IF;
        END IF;
      END;
      PROCEDURE PR_VERTICAL_TICKS IS
        nXSpace NUMBER;
        nYSpace NUMBER;
      BEGIN
        IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>io_rAxis,
                                                   i_bSnapToEdge =>FALSE,
                                                   i_nValue      =>io_rAxis.lTickEntries(vcIndex).rdataEntry.nValue);
        END IF;
        IF nY IS NOT NULL THEN
          IF io_rAxis.vcShowTickMarks=PK_JRXML2PDF_TYPES.YES THEN
            AS_PDF3_MOD.horizontal_line(p_x          =>CASE WHEN io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                                                         nTickOffset-io_rAxis.nDataOffset
                                                       ELSE
                                                         nTickOffset+io_rAxis.nDataOffset
                                                       END,
                                        p_y          =>nY,
                                        p_width      =>2,
                                        p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                                        p_line_color =>io_rAxis.vcLineColor
                                     );
          END IF;
          IF io_rAxis.vcShowDotlines=PK_JRXML2PDF_TYPES.YES THEN
            IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
              IF io_rAxis.vcDotlineColor IS NOT NULL THEN
                -- dotted lines
                AS_PDF3_MOD.pr_line      (i_nX1        =>i_rChartRect.nX,
                                          i_nY1        =>nY,
                                          i_nX2        =>i_rChartRect.nX+10.5,
                                          i_nY2        =>nY+10.5,
                                          i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                          i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                          i_vcStroke   =>'[3] 0'
                                         );
                -- dotted line
                AS_PDF3_MOD.pr_line      (i_nX1        =>i_rChartRect.nX+10.5,
                                          i_nY1        =>nY+10.5,
                                          i_nX2        =>i_rChartRect.nX+i_rChartRect.nWidth+10.5,
                                          i_nY2        =>nY+10.5,
                                          i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                          i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                          i_vcStroke   =>'[3] 0'
                                         );
              END IF;
            ELSE
              IF     io_rAxis.vcDotlineColor IS NOT NULL THEN
                -- dotted line
                AS_PDF3_MOD.pr_line      (i_nX1        =>i_rChartRect.nX,
                                          i_nY1        =>nY,
                                          i_nX2        =>i_rChartRect.nX+i_rChartRect.nWidth,
                                          i_nY2        =>nY,
                                          i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                          i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                          i_vcStroke   =>'[3] 0'
                                         );
              END IF;
            END IF;
          END IF;
          IF io_rAxis.vcShowTickLabels=PK_JRXML2PDF_TYPES.YES THEN
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcTickLabelFont,
                                          i_vcStyle    =>io_rAxis.vcTickLabelFontStyle,
                                          i_nSize      =>io_rAxis.nTickLabelFontSize
                                         );
            IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
              vcText:=TRIM(TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.nValue, io_rAxis.lTickEntries(vcIndex).vcPattern, i_rChart.rLocaleData.vcNumericChars));
            ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
              vcText:=TRIM(TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.dtValue, io_rAxis.lTickEntries(vcIndex).vcPattern, i_rChart.rLocaleData.vcDateLanguage));
            END IF;
            IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
              nx:=nTickOffset-AS_PDF3_MOD.str_len(vcText)-2;
            ELSE
              nx:=nTickOffset+3;
            END IF;
            AS_PDF3_MOD.set_color(io_rAxis.vcTickLabelColor);
            -- calculate end-point when rotation is set
            IF NVL(io_rAxis.nTicklabelRotation,0)=0 THEN
              nXBaseLabel:=nx;
              nYBaseLabel:=nY-(AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2);
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=180 THEN
              nXBaseLabel:=nx+AS_PDF3_MOD.str_len(vcText);
              nYBaseLabel:=nY+(AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2*0.8);
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=90 THEN
              IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                nXBaseLabel:=nTickOffset-2-io_rAxis.nTickLabelOffset;
              ELSE
                nXBaseLabel:=nTickOffset+3+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+io_rAxis.nTickLabelOffset;
              END IF;
              nYBaseLabel:=nY-AS_PDF3_MOD.str_len(vcText)/2;
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=270 THEN
              IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                nXBaseLabel:=nTickOffset-2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)-io_rAxis.nTickLabelOffset;
              ELSE
                nXBaseLabel:=nTickOffset+3+io_rAxis.nTickLabelOffset;
              END IF;
              nYBaseLabel:=nY+AS_PDF3_MOD.str_len(vcText)/2;
            ELSE
              -- calculate space of rotated text
              nXSpace:=GREATEST(AS_PDF3_MOD.str_len(vcText)*cos(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0))), AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize));
              nYSpace:=GREATEST(AS_PDF3_MOD.str_len(vcText)*sin(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0))), AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize));
              IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                nX:=nTickOffset-2-nXSpace-io_rAxis.nTickLabelOffset;
                nXBaseLabel:=nx;
                nYBaseLabel:=ny;
                IF    io_rAxis.nTicklabelRotation <90 THEN
                  nXBaseLabel:=nTickOffset-2;
                  nYBaseLabel:=nY;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 90 AND 180 THEN
                  nXBaseLabel:=nx;
                  nYBaseLabel:=nY+nYSpace;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 180 AND 270 THEN
                  nXBaseLabel:=nTickOffset-5;
                  nYBaseLabel:=nY+5;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 270 AND 360 THEN
                  nXBaseLabel:=nx;
                  nYBaseLabel:=nY+nYSpace;
                END IF;
              ELSE
                nX:=nTickOffset+nXSpace+io_rAxis.nTickLabelOffset;
                nXBaseLabel:=nx;
                nYBaseLabel:=ny;
                IF    io_rAxis.nTicklabelRotation <90 THEN
                  nXBaseLabel:=nX+4;
                  nYBaseLabel:=nY+nYSpace-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 90 AND 180 THEN
                  nXBaseLabel:=nx-nXSpace+4;
                  nYBaseLabel:=nY+4;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 180 AND 270 THEN
                  nXBaseLabel:=nX+4;
                  nYBaseLabel:=nY+nYSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                ELSIF io_rAxis.nTicklabelRotation BETWEEN 270 AND 360 THEN
                  nXBaseLabel:=nx-nXSpace;
                  nYBaseLabel:=nY;
                END IF;
              END IF;
              nXAngle:=nXBaseLabel+AS_PDF3_MOD.str_len(vcText)*cos(FK_RADIANS(io_rAxis.nTicklabelRotation));
              nYAngle:=nYBaseLabel+AS_PDF3_MOD.str_len(vcText)*sin(FK_RADIANS(io_rAxis.nTicklabelRotation));
              IF    io_rAxis.nTicklabelRotation <180 THEN
                nXBaseLabel:=nXBaseLabel-(nXAngle-nXBaseLabel);
                nYBaseLabel:=nYBaseLabel-(nYAngle-nYBaseLabel);
              END IF;
            END IF;
            AS_PDF3_MOD.put_txt(p_x               =>CASE WHEN io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                                                      nXBaseLabel-io_rAxis.nDataOffset-io_rAxis.nTickLabelOffset
                                                    ELSE
                                                      nXBaseLabel+io_rAxis.nDataOffset+io_rAxis.nTickLabelOffset
                                                    END,
                                p_y               =>nYBaseLabel,
                                p_txt             =>vcText,
                                p_degrees_rotation=>io_rAxis.nTicklabelRotation);
          END IF;
        END IF;
      END;
      PROCEDURE PR_HORIZONTAL_TICKS IS
        nXSpace NUMBER;
        nYSpace NUMBER;
      BEGIN
        IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nX:=i_rChartRect.nX+FK_GET_VALUE_ON_AXIS(i_rAxis       =>io_rAxis,
                                                   i_bSnapToEdge =>FALSE,
                                                   i_nValue      =>io_rAxis.lTickEntries(vcIndex).rdataEntry.nValue);
        ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nX:=i_rChartRect.nX+FK_GET_VALUE_ON_AXIS(i_rAxis       =>io_rAxis,
                                                   i_bSnapToEdge =>FALSE,
                                                   i_dtValue     =>io_rAxis.lTickEntries(vcIndex).rdataEntry.dtValue);
        END IF;
        IF io_rAxis.vcShowTickMarks=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.vertical_line(p_x          =>nX,
                                    p_y          =>nY,
                                    p_height     =>CASE WHEN io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
                                                     -2
                                                   ELSE
                                                     2
                                                   END,
                                    p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                                    p_line_color =>io_rAxis.vcLineColor
                                   );
        END IF;
        IF io_rAxis.vcShowDotlines=PK_JRXML2PDF_TYPES.YES THEN
          IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
            IF io_rAxis.vcDotlineColor IS NOT NULL THEN
              -- dotted lines
              AS_PDF3_MOD.pr_line      (i_nX1        =>nX,
                                        i_nY1        =>i_rChartRect.nY,
                                        i_nX2        =>nX+10.5,
                                        i_nY2        =>i_rChartRect.nY+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke   =>'[3] 0'
                                       );
              -- dotted line
              AS_PDF3_MOD.pr_line      (i_nX1        =>nX+10.5,
                                        i_nY1        =>i_rChartRect.nY+10.5,
                                        i_nX2        =>nX+10.5,
                                        i_nY2        =>i_rChartRect.nY+i_rChartRect.nHeight+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke   =>'[3] 0'
                                       );
            END IF;
          ELSE
            IF     io_rAxis.vcDotlineColor IS NOT NULL THEN
              -- dotted line
              AS_PDF3_MOD.pr_line      (i_nX1        =>nX,
                                        i_nY1        =>i_rChartRect.nY,
                                        i_nX2        =>nX,
                                        i_nY2        =>i_rChartRect.nY+i_rChartRect.nHeight,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor=>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke   =>'[3] 0'
                                       );
            END IF;
          END IF;
        END IF;
        IF io_rAxis.vcShowTickLabels=PK_JRXML2PDF_TYPES.YES THEN
          PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcTickLabelFont,
                                        i_vcStyle    =>io_rAxis.vcTickLabelFontStyle,
                                        i_nSize      =>io_rAxis.nTickLabelFontSize
                                       );
          IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            vcText:=TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.nValue, io_rAxis.lTickEntries(vcIndex).vcPattern, i_rChart.rLocaleData.vcNumericChars);
          ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            vcText:=TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.dtValue, io_rAxis.lTickEntries(vcIndex).vcPattern, i_rChart.rLocaleData.vcDateLanguage);
          END IF;
          IF NVL(io_rAxis.nTicklabelRotation,0)=0 THEN
            nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-(AS_PDF3_MOD.str_len(vcText)/2);
            IF io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
              nYBaseLabel:=nY-2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            ELSE
              nYBaseLabel:=nY-2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            END IF;
          ELSIF NVL(io_rAxis.nTicklabelRotation,0)=180 THEN
            nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+(AS_PDF3_MOD.str_len(vcText)/2);
            IF io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
              nYBaseLabel:=nY+2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            ELSE
              nYBaseLabel:=nY+2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            END IF;
          ELSIF NVL(io_rAxis.nTicklabelRotation,0)=90 THEN
            nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
            IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
              nYBaseLabel:=nY+3;
            ELSE
              nYBaseLabel:=nY-AS_PDF3_MOD.str_len(vcText)-3;
            END IF;
          ELSIF NVL(io_rAxis.nTicklabelRotation,0)=270 THEN
            nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/4;
            IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
              nYBaseLabel:=nY+AS_PDF3_MOD.str_len(vcText)+2;
            ELSE
              nYBaseLabel:=nY-3;
            END IF;
          ELSE
            -- calculate space of rotated text
            nXSpace:=GREATEST(AS_PDF3_MOD.str_len(vcText)*cos(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0))), AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize));
            nYSpace:=GREATEST(AS_PDF3_MOD.str_len(vcText)*sin(FK_RADIANS(NVL(io_rAxis.nTicklabelRotation,0))), AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize));
            IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
              IF    io_rAxis.nTicklabelRotation <90 THEN
                nXBaseLabel:=nx+nXSpace;
                nYBaseLabel:=nY+nYSpace+2;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 90 AND 180 THEN
                nXBaseLabel:=nx-nXSpace+2;
                nYBaseLabel:=nY+nYSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 180 AND 270 THEN
                nXBaseLabel:=nx+nXSpace;
                nYBaseLabel:=nY+nySpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+2;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 270 AND 360 THEN
                nXBaseLabel:=nx-nXSpace;
                nYBaseLabel:=nY+nySpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
              END IF;
            ELSE
              IF    io_rAxis.nTicklabelRotation <90 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                nYBaseLabel:=nY-8;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 90 AND 180 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2;
                nYBaseLabel:=nY-5;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 180 AND 270 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2;
                nYBaseLabel:=nY-5;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 270 AND 360 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                nYBaseLabel:=nY-8;
              END IF;
            END IF;
            nXAngle:=nXBaseLabel+AS_PDF3_MOD.str_len(vcText)*cos(FK_RADIANS(io_rAxis.nTicklabelRotation));
            nYAngle:=nYBaseLabel+AS_PDF3_MOD.str_len(vcText)*sin(FK_RADIANS(io_rAxis.nTicklabelRotation));
            IF    io_rAxis.nTicklabelRotation <180 THEN
              nXBaseLabel:=nXBaseLabel-(nXAngle-nXBaseLabel);
              nYBaseLabel:=nYBaseLabel-(nYAngle-nYBaseLabel);
            END IF;
          END IF;
          AS_PDF3_MOD.set_color(io_rAxis.vcTickLabelColor);
          AS_PDF3_MOD.put_txt(p_x               =>nXBaseLabel,
                              p_y               =>CASE WHEN io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
                                                    nYBaseLabel-io_rAxis.nTickLabelOffset
                                                  ELSE
                                                    nYBaseLabel+io_rAxis.nTickLabelOffset
                                                  END,
                              p_txt             =>vcText,
                              p_degrees_rotation=>io_rAxis.nTicklabelRotation);
        END IF;
      END;
    BEGIN
      PR_CALC_TICKS;
      vcIndex:=io_rAxis.lTickEntries.FIRST;
      iPos:=1;
      WHILE vcIndex IS NOT NULL LOOP
        IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
          PR_VERTICAL_TICKS;
        ELSE
          PR_HORIZONTAL_TICKS;
        END IF;
        vcIndex:=io_rAxis.lTickEntries.NEXT(vcIndex);
        iPos:=iPos+1;
      END LOOP;
    END;
    PROCEDURE PR_RENDER_CATEGORY_AXIS IS
      rDataSet tDataset;
      rEntry   tDataEntry;
      iPos     PLS_INTEGER;
    BEGIN
      -- Render one ticket for each value
      FOR i IN 1..i_rChart.lPlots.COUNT LOOP
        FOR j IN 1..i_rChart.lPlots(i).lDatasets.COUNT LOOP
          IF    (    i_rChart.lPlots(i).lDatasets(j).nValueAxis=i_nAxisIndex
                 AND io_rAxis.nAxisType=AXIS_TYPE_VALUE
                )
             OR (    i_rChart.lPlots(i).lDatasets(j).nRangeAxis=i_nAxisIndex
                 AND io_rAxis.nAxisType=AXIS_TYPE_RANGE
                ) THEN
            rDataSet:=i_rChart.lPlots(i).lDatasets(j);
            FOR t IN 1..i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries.COUNT LOOP
              rEntry:=i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t);
              IF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
                vcIndex:=TO_CHAR(rEntry.nValue, 'FM00000000000000000000D00000000000000000');
                io_rAxis.lTickEntries(vcIndex).rDataEntry.nValue:=rEntry.nValue;
                io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
              ELSIF rDataset.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
                vcIndex:=TO_CHAR(rEntry.dtValue, 'YYYYMMDDHH24MISS');
                io_rAxis.lTickEntries(vcIndex).rDataEntry.dtValue:=rEntry.dtValue;
                io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
              ELSE
                -- sort by appearence
                -- check for existance
                vcIndex:=io_rAxis.lTickEntries.FIRST;
                WHILE vcIndex IS NOT NULL LOOP
                  IF io_rAxis.lTickEntries(vcIndex).rDataEntry.vcValue=i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).vcValue THEN
                    EXIT;
                  END IF;
                  vcIndex:=io_rAxis.lTickEntries.NEXT(vcIndex);
                END LOOP;
                IF vcIndex IS NULL THEN
                  vcIndex:=TO_CHAR(io_rAxis.lTickEntries.COUNT+1, 'FM00000000000000000000');
                  io_rAxis.lTickEntries(vcIndex).rDataEntry.vcValue:=i_rChart.lPlots(i).lDatasets(j).lRangeDataEntries(t).vcValue;
                  io_rAxis.lTickEntries(vcIndex).vcPattern:=io_rAxis.vcTickLabelPattern;
                END IF;
              END IF;
            END LOOP;
          END IF;
        END LOOP;
      END LOOP;
      vcIndex:=io_rAxis.lTickEntries.FIRST;
      iPos:=1;
      WHILE vcIndex IS NOT NULL LOOP
        IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
          NULL;
        ELSE
          io_rAxis.nPixelPerUnit:=(i_rChartRect.nWidth-20)/io_rAxis.lTickEntries.COUNT;
          nX:=i_rChartRect.nX+10+iPos*io_rAxis.nPixelPerUnit;
          IF io_rAxis.vcShowTickMarks=PK_JRXML2PDF_TYPES.YES THEN
            AS_PDF3_MOD.vertical_line(p_x          =>nX,
                                      p_y          =>nY-io_rAxis.nTickLabelOffset,
                                      p_height     =>-2,
                                      p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                                      p_line_color =>io_rAxis.vcLineColor
                                     );
          END IF;
          IF io_rAxis.vcShowDotlines=PK_JRXML2PDF_TYPES.YES THEN
            IF     io_rAxis.vcDotlineColor IS NOT NULL THEN
              -- dotted line
              AS_PDF3_MOD.pr_line      (i_nX1         =>nX,
                                        i_nY1         =>i_rChartRect.nY,
                                        i_nX2         =>nX,
                                        i_nY2         =>i_rChartRect.nY+i_rChartRect.nHeight,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor =>REPLACE(io_rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke     =>'[3] 0'
                                       );
            END IF;
          END IF;
          IF io_rAxis.vcShowTickLabels=PK_JRXML2PDF_TYPES.YES THEN
            IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
              vcText:=TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.nValue, io_rAxis.lTickEntries(vcIndex).vcPattern);
            ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
              vcText:=TO_CHAR(io_rAxis.lTickEntries(vcIndex).rdataEntry.dtValue, io_rAxis.lTickEntries(vcIndex).vcPattern);
            ELSE
              vcText:=io_rAxis.lTickEntries(vcIndex).rdataEntry.vcValue;
            END IF;
            AS_PDF3_MOD.set_color(io_rAxis.vcTickLabelColor);
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcTickLabelFont,
                                          i_vcStyle    =>io_rAxis.vcTickLabelFontStyle,
                                          i_nSize      =>io_rAxis.nTickLabelFontSize
                                         );
            -- calculate end-point when rotation is set
            IF NVL(io_rAxis.nTicklabelRotation,0)=0 THEN
              nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-(AS_PDF3_MOD.str_len(vcText)/2);
              nYBaseLabel:=nY-2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=180 THEN
              nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+(AS_PDF3_MOD.str_len(vcText)/2);
              nYBaseLabel:=nY-(AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2*0.8);
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=90 THEN
              nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
              IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                nYBaseLabel:=nY+3;
              ELSE
                nYBaseLabel:=nY-AS_PDF3_MOD.str_len(vcText)-3;
              END IF;
            ELSIF NVL(io_rAxis.nTicklabelRotation,0)=270 THEN
              nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
              IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
                nYBaseLabel:=nY+AS_PDF3_MOD.str_len(vcText)+3;
              ELSE
                nYBaseLabel:=nY-3;
              END IF;
            ELSE
              IF    io_rAxis.nTicklabelRotation <90 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                nYBaseLabel:=nY-8;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 90 AND 180 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2;
                nYBaseLabel:=nY-5;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 180 AND 270 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2;
                nYBaseLabel:=nY-5;
              ELSIF io_rAxis.nTicklabelRotation BETWEEN 270 AND 360 THEN
                nXBaseLabel:=nx-io_rAxis.nPixelPerUnit/2-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2;
                nYBaseLabel:=nY-8;
              END IF;
              nXAngle:=nXBaseLabel+AS_PDF3_MOD.str_len(vcText)*cos(FK_RADIANS(io_rAxis.nTicklabelRotation));
              nYAngle:=nYBaseLabel+AS_PDF3_MOD.str_len(vcText)*sin(FK_RADIANS(io_rAxis.nTicklabelRotation));
              IF    io_rAxis.nTicklabelRotation <180 THEN
                nXBaseLabel:=nXBaseLabel-(nXAngle-nXBaseLabel);
                nYBaseLabel:=nYBaseLabel-(nYAngle-nYBaseLabel);
              END IF;
            END IF;
            AS_PDF3_MOD.put_txt(p_x               =>nXBaseLabel,
                                p_y               =>nYBaseLabel-io_rAxis.nDataOffset-io_rAxis.nTickLabelOffset,
                                p_txt             =>vcText,
                                p_degrees_rotation=>io_rAxis.nTicklabelRotation);
         END IF;
        END IF;
        vcIndex:=io_rAxis.lTickEntries.NEXT(vcIndex);
        iPos:=iPos+1;
      END LOOP;
    END;
    PROCEDURE PR_RENDER_VERTICAL IS
    BEGIN
      io_rAxis.nPixelPerUnit:=(i_rChartRect.nHeight-io_rAxis.nStartOffset-io_rAxis.nEndOffset)/io_rAxis.nMinMaxDiff;
      nY:=i_rChartRect.nY;
      -- Render axis-label, if set
      IF io_rAxis.vcLabelText IS NOT NULL THEN
        -- set font for measuring
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcLabelFont,
                                      i_vcStyle    =>io_rAxis.vcLabelFontStyle,
                                      i_nSize      =>io_rAxis.nLabelFontSize
                                     );
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          nX:=io_rAxis.nX+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
        ELSE
          nX:=io_rAxis.nX+io_rAxis.nWidth-5;
        END IF;
        AS_PDF3_MOD.set_color(io_rAxis.vcLabelColor);
        AS_PDF3_MOD.put_txt(p_x               =>nX,
                            p_y               =>nY+(i_rChartRect.nHeight-AS_PDF3_MOD.str_len(io_rAxis.vcLabelText))/2,
                            p_txt             =>io_rAxis.vcLabelText,
                            p_degrees_rotation=>90);
      END IF;
      IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
        nX:=io_rAxis.nX+io_rAxis.nWidth;
        nTickOffset:=io_rAxis.nX+io_rAxis.nWidth-2;
      ELSE
        nX:=io_rAxis.nX;
        nTickOffset:=io_rAxis.nX;
      END IF;
      IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
        -- buildd up polygon
        lX(1):=nX+.5;     lY(1):=nY+.5;
        lX(2):=nX+10.5;   lY(2):=nY+10.5;
        lX(3):=nX+10.5;   lY(3):=nY+10.5+i_rChartRect.nHeight;
        lX(4):=nX+.5;     lY(4):=nY+.5+i_rChartRect.nHeight;
        lX(5):=nX+.5;     lY(5):=nY+.5;
        AS_PDF3_MOD.pr_polygon( lX,
                                lY,
                                'EEEEEE',
                                'EEEEEE'
                              );
        AS_PDF3_MOD.vertical_line(p_x          =>nX+10.5,
                                  p_y          =>nY+10.5,
                                  p_height     =>i_rChartRect.nHeight,
                                  p_line_width =>1,
                                  p_line_color =>REPLACE('C0C0C0', '#', '')
                                 );
        AS_PDF3_MOD.pr_line(i_nX1        =>nX,
                            i_nY1        =>nY,
                            i_nX2        =>nX+10.5,
                            i_nY2        =>nY+10.5,
                            i_nLineWidth =>1,
                            i_vcLineColor=>REPLACE('C0C0C0', '#', '')
                           );
      ELSE
        -- Axis line only when not 3D
        AS_PDF3_MOD.vertical_line(p_x          =>nX,
                                  p_y          =>nY,
                                  p_height     =>i_rChartRect.nHeight,
                                  p_line_width =>io_rAxis.nAxisLineWidth,
                                  p_line_color =>CASE WHEN io_rAxis.nDataOffset>0 THEN
                                                   REPLACE('C0C0C0', '#', '')
                                                 ELSE
                                                   io_rAxis.vcLineColor
                                                 END
                                 );
      END IF;
      IF io_rAxis.nDataOffset>0 THEN
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          nX:=nX-io_rAxis.nDataOffset;
        ELSE
          nX:=nX+io_rAxis.nDataOffset;
        END IF;
        -- Axis line only when not 3D
        AS_PDF3_MOD.vertical_line(p_x          =>nX,
                                  p_y          =>nY,
                                  p_height     =>i_rChartRect.nHeight,
                                  p_line_width =>io_rAxis.nAxisLineWidth,
                                  p_line_color =>io_rAxis.vcLineColor
                                 );
      END IF;
      nTicks:=TRUNC(i_rChartRect.nHeight/PIXEL_PER_TICK);
    END;
    PROCEDURE PR_RENDER_HORIZONTAL IS
    BEGIN
      io_rAxis.nPixelPerUnit:=(i_rChartRect.nWidth-io_rAxis.nStartOffset-io_rAxis.nEndOffset)/io_rAxis.nMinMaxDiff;
      nX:=i_rChartRect.nX;
      -- Render axis-label, if set
      IF io_rAxis.vcLabelText IS NOT NULL THEN
        -- set font for measuring
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>io_rAxis.vcLabelFont,
                                      i_vcStyle    =>io_rAxis.vcLabelFontStyle,
                                      i_nSize      =>io_rAxis.nLabelFontSize
                                     );
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          ny:=io_rAxis.nY-5-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
        ELSE
          ny:=io_rAxis.nY-io_rAxis.nHeight+10;
        END IF;
        AS_PDF3_MOD.set_color(io_rAxis.vcLabelColor);
        AS_PDF3_MOD.put_txt(p_x               =>nX+(i_rChartRect.nWidth-AS_PDF3_MOD.str_len(io_rAxis.vcLabelText))/2,
                            p_y               =>nY,
                            p_txt             =>io_rAxis.vcLabelText);
      END IF;
      IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
        nY:=io_rAxis.nY-io_rAxis.nHeight;
      ELSE
        nY:=io_rAxis.nY;
      END IF;
      IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
        -- buildd up polygon
        lX(1):=nX+.5;                         lY(1):=nY+.5;
        lX(2):=nX+10.5;                       lY(2):=nY+10.5;
        lX(3):=nX+10.5+i_rChartRect.nWidth;   lY(3):=nY+10.5;
        lX(4):=nX+.5+i_rChartRect.nWidth;     lY(4):=nY+.5;
        lX(5):=nX+.5;                         lY(5):=nY+.5;
        AS_PDF3_MOD.pr_polygon( lX,
                                lY,
                                'EEEEEE',
                                'EEEEEE'
                              );
        AS_PDF3_MOD.horizontal_line(p_x          =>nX+10.5,
                                    p_y          =>nY+10.5,
                                    p_width      =>i_rChartRect.nWidth,
                                    p_line_width =>1,
                                    p_line_color =>REPLACE('C0C0C0', '#', '')
                                   );
        AS_PDF3_MOD.pr_line(i_nX1          =>nX,
                            i_nY1          =>nY,
                            i_nX2          =>nX+10.5,
                            i_nY2          =>nY+10.5,
                            i_nLineWidth =>1,
                            i_vcLineColor =>REPLACE('C0C0C0', '#', '')
                           );
      ELSE
        -- render axis-line only in 2D
        AS_PDF3_MOD.horizontal_line(p_x          =>nX,
                                    p_y          =>nY,
                                    p_width      =>i_rChartRect.nWidth,
                                    p_line_width =>io_rAxis.nAxisLineWidth,
                                    p_line_color =>CASE WHEN io_rAxis.nDataOffset>0 THEN
                                                     REPLACE('C0C0C0', '#', '')
                                                   ELSE
                                                     REPLACE(io_rAxis.vcLineColor, '#', '')
                                                   END
                                 );
      END IF;
      IF (io_rAxis.nDataOffset>0) THEN
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          nY:=nY+io_rAxis.nDataOffset;
        ELSE
          nY:=nY-io_rAxis.nDataOffset;
        END IF;
        -- render axis-line only in 2D
        AS_PDF3_MOD.horizontal_line(p_x          =>nX,
                                    p_y          =>nY,
                                    p_width      =>i_rChartRect.nWidth,
                                    p_line_width =>io_rAxis.nAxisLineWidth,
                                    p_line_color =>REPLACE(io_rAxis.vcLineColor, '#', '')
                                 );
      END IF;
      nTicks:=TRUNC(i_rChartRect.nWidth/PIXEL_PER_TICK);
    END;
  BEGIN
    IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
      PR_RENDER_VERTICAL;
    ELSE
      PR_RENDER_HORIZONTAL;
    END IF;
    IF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
      nTickValueDiff:=(io_rAxis.rMaxValueDataEntry.nValue-io_rAxis.rMinValueDataEntry.nValue)/nTicks;
      nValue:=io_rAxis.rMinValueDataEntry.nValue;
    ELSIF io_rAxis.vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
      nTickValueDiff:=(io_rAxis.rMaxValueDataEntry.dtValue-io_rAxis.rMinValueDataEntry.dtValue)/nTicks;
      dtValue:=io_rAxis.rMinValueDataEntry.dtValue;
    END IF;
    -- font for axis-values
    PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>PK_JRXML2PDF_TYPES.ARIAL,
                                  i_vcStyle    =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                  i_nSize      =>11
                                 );
    IF io_rAxis.nValueType=AXIS_VALUE THEN
      PR_RENDER_VALUE_AXIS;
    ELSE
      PR_RENDER_CATEGORY_AXIS;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_STACKED_AREA_PLOT(i_rChart IN tChart,
                                        i_nPlotIndex IN NUMBER,
                                        i_rChartRect IN tRect
                                       ) IS
    nXLast         NUMBER;
    nY1Last        NUMBER;
    nY2Last        NUMBER;
    lSeriesIndex   PK_JRXML2PDF_TYPES.tNumList;
    iSeries        PLS_INTEGER;
    nRangeAxis     NUMBER;
    vcIndex        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nSeriesNum     NUMBER;
    iRangeIndex    NUMBER;
    nY             NUMBER;
    rAxis          tAxis;
    lX             AS_PDF3_MOD.tVertices;
    lY             AS_PDF3_MOD.tVertices;
    nCategorySpace NUMBER;
    --nSeriesSpace   NUMBER;
    lLastValues    PK_JRXML2PDF_TYPES.tNumList;
    PROCEDURE PR_RENDER_AREA(i_rDataset        IN tDataset,
                             i_rRangeTickEntry IN tTickEntry,
                             i_nRangeIndex     IN NUMBER,
                             i_nSeriesNum      IN NUMBER,
                             i_nSeriesCount    IN NUMBER,
                             i_bLastDataEntry  IN BOOLEAN) IS
      nX       NUMBER;
      nXFactor NUMBER;
      nY1      NUMBER;
      nY2      NUMBER;
      nSwap    NUMBER;
      nYFactor NUMBER;
      vcLineColor        PK_JRXML2PDF_TYPES.tColor;
      vcLineColorDark    PK_JRXML2PDF_TYPES.tColor;
      vcLineColorLight   PK_JRXML2PDF_TYPES.tColor;
      vcColor            PK_JRXML2PDF_TYPES.tColor;
      vcIndex            PK_JRXML2PDF_TYPES.tMaxVarchar2;
      iPos               PLS_INTEGER;
      lX                 AS_PDF3_MOD.tVertices;
      lY                 AS_PDF3_MOD.tVertices;
      vcText             PK_JRXML2PDF_TYPES.tMaxVarchar2;
      nXText             NUMBER;
      nYText             NUMBER;
      iDatasetIndex      PLS_INTEGER;
      nValue             NUMBER;
      nMinValue          NUMBER;
    BEGIN
      nXFactor:=i_rChart.lValueAxis(i_rDataset.nValueAxis).nPixelPerUnit;
      nYFactor:=i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit;
      vcLineColor:=i_rChart.lSeries(i_rDataset.nSeries).vcColor;
      vcLineColorDark:=FK_DARKER(vcLineColor);
      vcLineColorLight:=FK_LIGHTER(vcLineColor);
      -- Find entry in Range
      -- calc y-value and check Index in TickEntries
      FOR i IN 1..i_rDataset.lRangeDataEntries.COUNT LOOP
        IF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF i_rRangeTickEntry.rDataEntry.nValue=i_rDataset.lRangeDataEntries(i).nValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSIF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          IF i_rRangeTickEntry.rDataEntry.dtValue=i_rDataset.lRangeDataEntries(i).dtValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSE
          IF i_rRangeTickEntry.rDataEntry.vcValue=i_rDataset.lRangeDataEntries(i).vcValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        END IF;
        EXIT WHEN iDatasetIndex >0;
      END LOOP;
      IF iDatasetIndex>0 THEN
        -- calc x-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF lLastValues.EXISTS(iDatasetIndex) THEN
            nValue:=lLastValues(iDatasetIndex)+i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
            nMinValue:=lLastValues(iDatasetIndex);
            lLastValues(iDatasetIndex):=lLastValues(iDatasetIndex)+i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
          ELSE
            nValue:=i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
            nMinValue:=0;
            lLastValues(iDatasetIndex):=i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
          END IF;
        END IF;
      ELSE
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nValue:=0;
          nMinValue:=0;
        END IF;
      END IF;
      nY1:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                i_bSnapToEdge =>TRUE,
                                                i_nValue      =>NVL(nValue, 0)
                                               );
      nY2:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                i_bSnapToEdge =>TRUE,
                                                i_nValue      =>NVL(nMinValue, 0)
                                               );
      IF i_nRangeIndex IS NOT NULL THEN
        nX:= i_rChartRect.nx
            +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset
            +(i_nRangeIndex-1)*i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
            +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit/2;
        IF nxLast IS NULL THEN
          nxLast:=nx-i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit/2;
          ny1Last:=ny1;
          ny2Last:=ny2;
        END IF;
        lX(1):=nxLast;    lY(1):=ny1Last;
        lX(2):=nX;        lY(2):=nY1;
        lX(3):=nX;        lY(3):=nY2;
        lX(4):=nXLast;    lY(4):=nY2Last;
        lX(5):=nxLast;    lY(5):=ny1Last;
        AS_PDF3_MOD.PR_POLYGON(i_lXs =>lX,
                               i_lYs =>lY,
                               i_vcLineColor=>vcLineColor,
                               i_vcFillColor=>vcLineColor,
                               i_nLineWidth=>PK_JRXML2PDF_TYPES.THIN
                              );
        nxLast:=nX;
        nY1Last:=ny1;
        nY2Last:=ny2;

        IF i_bLastDataEntry THEN
          lX(1):=nxLast;                                                             lY(1):=ny1Last;
          lX(2):=nxLast+i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit/2;  lY(2):=nY1Last;
          lX(3):=nxLast+i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit/2;  lY(3):=nY2Last;
          lX(4):=nXLast;                                                             lY(4):=nY2Last;
          lX(5):=nxLast;                                                             lY(5):=ny1Last;


          AS_PDF3_MOD.PR_POLYGON(i_lXs =>lX,
                                 i_lYs =>lY,
                                 i_vcLineColor=>vcLineColor,
                                 i_vcFillColor=>vcLineColor,
                                 i_nLineWidth=>PK_JRXML2PDF_TYPES.THIN
                                );
        END IF;
      END IF;
      IF nY1>nY2 THEN
        nSwap:=nY2;
        nY2:=nY1;
        nY1:=nSwap;
      END IF;
      IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition IN (VALUE_POSITION_INSIDE, VALUE_POSITION_OUTSIDE) THEN
        AS_PDF3_MOD.set_color(i_rChart.lPlots(i_nPlotIndex).vcLabelColor);
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>i_rChart.lPlots(i_nPlotIndex).vcLabelFont,
                                      i_vcStyle    =>i_rChart.lPlots(i_nPlotIndex).vcLabelFontStyle,
                                      i_nSize      =>i_rChart.lPlots(i_nPlotIndex).nLabelFontSize
                                     );
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).nValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern);
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).dtValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern);
        END IF;
        IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_INSIDE THEN
          nYText:=(nY2-nY1)/2;
        ELSE
          IF nSwap IS NULL THEN
            nYText:=nY1-3-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          ELSE
            -- swapped, then place text beneath bar
            nYText:=nY2+3;
          END IF;
        END IF;
        nxText:=nx+nCategorySpace/2-AS_PDF3_MOD.str_len(vcText)/2;
        IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES
           AND i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_OUTSIDE THEN
          nxText:=nxText+5;
        END IF;
        AS_PDF3_MOD.put_txt(p_x=>nXText,
                            p_y=>nYText,
                            p_txt=>vcText
                           );
      END IF;
    END;
  BEGIN
    FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
      IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries>0 THEN
        nRangeAxis:=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nrangeAxis;
        lSeriesIndex(i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries):=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries;
      END IF;
    END LOOP;
    IF lSeriesIndex.COUNT>0 THEN
      -- if spaces for category and series are not explicitly set, calculate percentage of space
      IF i_rChart.lPlots(i_nPlotIndex).nCategorySpace IS NULL THEN
        nCategorySpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit*0.20;
      ELSE
        nCategorySpace:=i_rChart.lPlots(i_nPlotIndex).nCategorySpace;
      END IF;
      FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
        nXLast:=NULL;
        nY1Last:=NULL;
        nY2Last:=NULL;
        iRangeIndex:=1;
        vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.FIRST;
        WHILE vcIndex IS NOT NULL LOOP
          nSeriesNum:=1;
          iSeries:=lSeriesIndex.FIRST;
          WHILE iSeries IS NOT NULL LOOP
            IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries=iSeries THEN
              PR_RENDER_AREA(i_rChart.lPlots(i_nPlotIndex).lDatasets(i),
                             i_rChart.lRangeAxis(nRangeAxis).lTickEntries(vcIndex),
                             iRangeIndex,
                             nSeriesNum,
                             lSeriesIndex.COUNT,
                             i_rChart.lRangeAxis(nRangeAxis).lTickEntries.NEXT(vcIndex) IS NULL
                            );
            END IF;
            nSeriesNum:=nSeriesNum+1;
            iSeries:=lSeriesIndex.NEXT(iSeries);
          END LOOP;
          iRangeIndex:=iRangeIndex+1;
          vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.NEXT(vcIndex);
        END LOOP;
      END LOOP;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_CATEGORY_LINE_PLOT(i_rChart IN tChart,
                                         i_nPlotIndex IN NUMBER,
                                         i_rChartRect IN tRect
                                        ) IS
    nXLast         NUMBER;
    nYLast         NUMBER;
    lSeriesIndex   PK_JRXML2PDF_TYPES.tNumList;
    iSeries        PLS_INTEGER;
    nRangeAxis     NUMBER;
    vcIndex        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nSeriesNum     NUMBER;
    iRangeIndex    NUMBER;
    nY             NUMBER;
    rAxis          tAxis;
    lX             AS_PDF3_MOD.tVertices;
    lY             AS_PDF3_MOD.tVertices;
    nCategorySpace NUMBER;
    nSeriesSpace   NUMBER;
    PROCEDURE PR_RENDER_LINE(i_rDataset        IN tDataset,
                             i_rRangeTickEntry IN tTickEntry,
                             i_nRangeIndex     IN NUMBER,
                             i_nSeriesNum      IN NUMBER,
                             i_nSeriesCount    IN NUMBER) IS
      nX       NUMBER;
      nXFactor NUMBER;
      nY1      NUMBER;
      nY2      NUMBER;
      nSwap    NUMBER;
      nYFactor NUMBER;
      vcLineColor        PK_JRXML2PDF_TYPES.tColor;
      vcLineColorDark    PK_JRXML2PDF_TYPES.tColor;
      vcLineColorLight   PK_JRXML2PDF_TYPES.tColor;
      vcColor            PK_JRXML2PDF_TYPES.tColor;
      vcIndex            PK_JRXML2PDF_TYPES.tMaxVarchar2;
      iPos               PLS_INTEGER;
      lX                 AS_PDF3_MOD.tVertices;
      lY                 AS_PDF3_MOD.tVertices;
      vcText             PK_JRXML2PDF_TYPES.tMaxVarchar2;
      nXText             NUMBER;
      nYText             NUMBER;
      iDatasetIndex      PLS_INTEGER;
    BEGIN
      nXFactor:=i_rChart.lValueAxis(i_rDataset.nValueAxis).nPixelPerUnit;
      nYFactor:=i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit;
      vcLineColor:=i_rChart.lSeries(i_rDataset.nSeries).vcColor;
      vcLineColorDark:=FK_DARKER(vcLineColor);
      vcLineColorLight:=FK_LIGHTER(vcLineColor);
      -- Find entry in Range
      -- calc y-value and check Index in TickEntries
      FOR i IN 1..i_rDataset.lRangeDataEntries.COUNT LOOP
        IF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF i_rRangeTickEntry.rDataEntry.nValue=i_rDataset.lRangeDataEntries(i).nValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSIF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          IF i_rRangeTickEntry.rDataEntry.dtValue=i_rDataset.lRangeDataEntries(i).dtValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSE
          IF i_rRangeTickEntry.rDataEntry.vcValue=i_rDataset.lRangeDataEntries(i).vcValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        END IF;
        EXIT WHEN iDatasetIndex >0;
      END LOOP;
      IF iDatasetIndex>0 THEN
        -- calc x-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY1:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>i_rDataset.lValueDataEntries(iDatasetIndex).nValue
                                                  );
          nY2:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>0
                                                  );
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nY1:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(iDatasetIndex).dtValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.dtValue)*nXFactor;
        END IF;
      ELSE
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY1:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>0
                                                  );
          nY2:=nY1;
        END IF;
      END IF;
      IF i_nRangeIndex IS NOT NULL THEN
        nX:= i_rChartRect.nx
            +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset
            +(i_nRangeIndex-1)*i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
            +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit/2;
        IF i_rChart.lPlots(i_nPlotIndex).vcShowShapes=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.pr_path(i_lPath     =>FK_TRANSFORM_PATH(i_nX   =>nX,
                                                              i_nY   =>nY1,
                                                              i_lPath=>i_rChart.lSeries(i_rDataset.nSeries).lShapePath),
                              i_vcLineColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_vcFillColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                             );
        END IF;
        IF     nxLast IS NOT NULL
           AND i_rChart.lPlots(i_nPlotIndex).vcShowLines=PK_JRXML2PDF_TYPES.YES THEN
          IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
            lX.DELETE;
            lY.DELETE;
            lX(1):=nXLast+.5;        lY(1):=nYLast+.5;
            lX(2):=nXLast+10.5;      lY(2):=nYLast+10.5;
            lX(3):=nX+10.5;          lY(3):=nY1+10.5;
            lX(4):=nX+.5;            lY(4):=nY1+.5;
            lX(5):=nXLast+.5;        lY(5):=nYLast+.5;
            IF nY1!=nYLast THEN
              IF (nx-nXLast)/(nY1-nYLast)>1 THEN
                vcColor:=vcLineColorLight;
              ELSIF (nx-nXLast)/(nY1-nYLast) BETWEEN 0 AND 1 THEN
                vcColor:=vcLineColorDark;
              ELSIF (nx-nXLast)/(nY1-nYLast) BETWEEN 0 AND -1 THEN
                vcColor:=vcLineColorDark;
              ELSE
                vcColor:=vcLineColorLight;
              END IF;
            ELSE
              vcColor:=vcLineColorLight;
            END IF;
            as_pdf3_mod.pr_polygon(lX,
                                   lY,
                                   vcColor,
                                   vcColor
                                  );
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nxLast+10.5,
                                nyLast+10.5,
                                i_vcLineColor=>vcLineColor);
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny1,
                                i_vcLineColor=>vcLineColor);
          ELSE
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny1,
                                i_vcLineColor=>vcLineColor);
          END IF;
        END IF;
        nxLast:=nX;
        nYLast:=ny1;
      END IF;
      IF nY1>nY2 THEN
        nSwap:=nY2;
        nY2:=nY1;
        nY1:=nSwap;
      END IF;
      IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition IN (VALUE_POSITION_INSIDE, VALUE_POSITION_OUTSIDE) THEN
        AS_PDF3_MOD.set_color(i_rChart.lPlots(i_nPlotIndex).vcLabelColor);
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>i_rChart.lPlots(i_nPlotIndex).vcLabelFont,
                                      i_vcStyle    =>i_rChart.lPlots(i_nPlotIndex).vcLabelFontStyle,
                                      i_nSize      =>i_rChart.lPlots(i_nPlotIndex).nLabelFontSize
                                     );
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).nValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern);
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).dtValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern);
        END IF;
        IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_INSIDE THEN
          nYText:=(nY2-nY1)/2;
        ELSE
          IF nSwap IS NULL THEN
            nYText:=nY1-3-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          ELSE
            -- swapped, then place text beneath bar
            nYText:=nY2+3;
          END IF;
        END IF;
        nxText:=nx+nCategorySpace/2-AS_PDF3_MOD.str_len(vcText)/2;
        IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES
           AND i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_OUTSIDE THEN
          nxText:=nxText+5;
        END IF;
        AS_PDF3_MOD.put_txt(p_x=>nXText,
                            p_y=>nYText,
                            p_txt=>vcText
                           );
      END IF;
    END;
  BEGIN
    FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
      IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries>0 THEN
        nRangeAxis:=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nrangeAxis;
        lSeriesIndex(i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries):=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries;
      END IF;
    END LOOP;
    IF lSeriesIndex.COUNT>0 THEN
      -- if the plot is 3D, render a bar-base at X-position 0
      IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
        -- find X-axis
        rAxis:=i_rChart.lValueaxis(i_rChart.lPlots(i_nPlotIndex).lDatasets(1).nValueAxis);
        nY:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>rAxis,
                                                 i_bSnapToEdge =>FALSE,
                                                 i_nValue      =>0
                                                );
        -- render bar-base
        IF rAxis.rMinValueDataEntry.nValue<0 AND rAxis.rMaxValueDataEntry.nValue>0 THEN
          lX(1):=i_rChartRect.nX+.5;                         lY(1):=nY+.5;
          lX(2):=i_rChartRect.nX+10.5;                       lY(2):=nY+10.5;
          lX(3):=i_rChartRect.nX+10.5+i_rChartRect.nWidth;   lY(3):=nY+10.5;
          lX(4):=i_rChartRect.nX+.5+i_rChartRect.nWidth;     lY(4):=nY+.5;
          lX(5):=i_rChartRect.nX+.5;                         lY(5):=nY+.5;
          AS_PDF3_MOD.pr_polygon( lX,
                                  lY,
                                  'EEEEEE',
                                  'EEEEEE'
                                );
          IF rAxis.vcShowDotlines=PK_JRXML2PDF_TYPES.YES THEN
            IF rAxis.vcDotlineColor IS NOT NULL THEN
              -- dotted lines
              AS_PDF3_MOD.pr_line      (i_nX1         =>i_rChartRect.nX,
                                        i_nY1         =>nY,
                                        i_nX2         =>i_rChartRect.nX+10.5,
                                        i_nY2         =>nY+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor =>REPLACE(rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke     =>'[3] 0'
                                       );
              -- dotted line
              AS_PDF3_MOD.pr_line      (i_nX1        =>i_rChartRect.nX+10.5,
                                        i_nY1        =>nY+10.5,
                                        i_nX2        =>i_rChartRect.nX+i_rChartRect.nWidth+10.5,
                                        i_nY2        =>nY+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor=>REPLACE(rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke   =>'[3] 0'
                                       );
            END IF;
          END IF;
        END IF;
      END IF;
      -- if spaces for category and series are not explicitly set, calculate percentage of space
      IF i_rChart.lPlots(i_nPlotIndex).nCategorySpace IS NULL THEN
        nCategorySpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit*0.20;
      ELSE
        nCategorySpace:=i_rChart.lPlots(i_nPlotIndex).nCategorySpace;
      END IF;
      IF i_rChart.lPlots(i_nPlotIndex).nSeriesSpace IS NULL THEN
        nSeriesSpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit*0.05;
      ELSE
        nSeriesSpace:=i_rChart.lPlots(i_nPlotIndex).nSeriesSpace;
      END IF;
      FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
        nXLast:=NULL;
        nYLast:=NULL;
        iRangeIndex:=1;
        vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.FIRST;
        WHILE vcIndex IS NOT NULL LOOP
          nSeriesNum:=1;
          iSeries:=lSeriesIndex.FIRST;
          WHILE iSeries IS NOT NULL LOOP
            IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries=iSeries THEN
              PR_RENDER_LINE(i_rChart.lPlots(i_nPlotIndex).lDatasets(i),
                             i_rChart.lRangeAxis(nRangeAxis).lTickEntries(vcIndex),
                             iRangeIndex,
                             nSeriesNum,
                             lSeriesIndex.COUNT
                            );
            END IF;
            nSeriesNum:=nSeriesNum+1;
            iSeries:=lSeriesIndex.NEXT(iSeries);
          END LOOP;
          iRangeIndex:=iRangeIndex+1;
          vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.NEXT(vcIndex);
        END LOOP;
      END LOOP;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_CATEGORY_BAR_PLOT(i_rChart IN tChart,
                                        i_nPlotIndex IN NUMBER,
                                        i_rChartRect IN tRect
                                       ) IS
    lSeriesIndex   PK_JRXML2PDF_TYPES.tNumList;
    iSeries        PLS_INTEGER;
    nRangeAxis     NUMBER;
    vcIndex        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nSeriesNum     NUMBER;
    iRangeIndex    NUMBER;
    nY             NUMBER;
    rAxis          tAxis;
    lX             AS_PDF3_MOD.tVertices;
    lY             AS_PDF3_MOD.tVertices;
    nCategorySpace NUMBER;
    nSeriesSpace   NUMBER;
    nSeriesCount   NUMBER;
    lLastValues    PK_JRXML2PDF_TYPES.tNumList;

    PROCEDURE PR_RENDER_BAR(i_rDataset        IN tDataset,
                            i_rRangeTickEntry IN tTickEntry,
                            i_nRangeIndex     IN NUMBER,
                            i_nSeriesNum      IN NUMBER,
                            i_nSeriesCount    IN NUMBER) IS
      nX                 NUMBER;
      nXFactor           NUMBER;
      nY1                NUMBER;
      nY2                NUMBER;
      nSwap              NUMBER;
      nYFactor           NUMBER;
      nxLast             NUMBER;
      nYLast             NUMBER;
      vcBarColor         PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcDarkerBarColor   PK_JRXML2PDF_TYPES.tColor;
      vcVeryDarkBarColor PK_JRXML2PDF_TYPES.tColor;
      vcIndex            PK_JRXML2PDF_TYPES.tMaxVarchar2;
      iPos               PLS_INTEGER;
      nBarWidth          NUMBER;
      lX                 AS_PDF3_MOD.tVertices;
      lY                 AS_PDF3_MOD.tVertices;
      vcText             PK_JRXML2PDF_TYPES.tMaxVarchar2;
      nXText             NUMBER;
      nYText             NUMBER;
      iDatasetIndex      PLS_INTEGER;
      nValue             NUMBER;
      nMinValue          NUMBER;
    BEGIN
      nXFactor:=i_rChart.lValueAxis(i_rDataset.nValueAxis).nPixelPerUnit;
      nYFactor:=i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit;
      vcBarColor:=i_rChart.lSeries(i_rDataset.nSeries).vcColor;
      vcDarkerBarColor:=FK_DARKER(vcBarColor);
      vcVeryDarkBarColor:=FK_DARKER(vcDarkerBarColor);
      -- Find entry in Range
      -- calc y-value and check Index in TickEntries
      FOR i IN 1..i_rDataset.lRangeDataEntries.COUNT LOOP
        IF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF i_rRangeTickEntry.rDataEntry.nValue=i_rDataset.lRangeDataEntries(i).nValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSIF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          IF i_rRangeTickEntry.rDataEntry.dtValue=i_rDataset.lRangeDataEntries(i).dtValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        ELSE
          IF i_rRangeTickEntry.rDataEntry.vcValue=i_rDataset.lRangeDataEntries(i).vcValue THEN
            iDatasetIndex:=i;
            EXIT;
          END IF;
        END IF;
        EXIT WHEN iDatasetIndex >0;
      END LOOP;
      IF iDatasetIndex>0 THEN
        -- calc x-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        -- for stacked bars, get the last value
          IF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_STACKED_BARCHART THEN
            IF lLastValues.EXISTS(iDatasetIndex) THEN
              nValue:=lLastValues(iDatasetIndex)+i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
              nMinValue:=lLastValues(iDatasetIndex);
              lLastValues(iDatasetIndex):=lLastValues(iDatasetIndex)+i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
            ELSE
              nValue:=i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
              nMinValue:=0;
              lLastValues(iDatasetIndex):=i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
            END IF;
          ELSE
            nValue:=i_rDataset.lValueDataEntries(iDatasetIndex).nValue;
            nMinValue:=0;
          END IF;
          nY1:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>nValue
                                                  );
          nY2:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>nMinValue
                                                  );
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nY1:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(iDatasetIndex).dtValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.dtValue)*nXFactor;
        END IF;
      ELSE
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY1:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>i_rChart.lValueAxis(i_rDataset.nValueAxis),
                                                    i_bSnapToEdge =>TRUE,
                                                    i_nValue      =>0
                                                  );
          nY2:=nY1;
        END IF;
      END IF;
      IF nY1>nY2 THEN
        nSwap:=nY2;
        nY2:=nY1;
        nY1:=nSwap;
      END IF;
      IF i_nRangeIndex IS NOT NULL THEN
        IF i_nSeriesCount> 1 THEN
          nBarWidth:=( i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
                      -nCategorySpace
                      -(i_nSeriesCount-1)*nSeriesSpace)/i_nSeriesCount;
          nX:= i_rChartRect.nx
              +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset
              +(i_nRangeIndex-1)*i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
              +nCategorySpace/2+(i_nSeriesNum-1)*(nSeriesSpace/2+nBarWidth);
        ELSE
          nBarWidth:= i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
                     -nCategorySpace;
          nX:= i_rChartRect.nx
              +i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset
              +(i_nRangeIndex-1)*i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit
              +nCategorySpace/2;
        END IF;
        IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.NO THEN
        AS_PDF3_MOD.rect(p_x         =>nX,
                         p_y         =>nY1,
                         p_width     =>nBarWidth,
                         p_height    =>nY2-nY1,
                         p_line_color=>i_rChart.lSeries(i_rDataset.nSeries).vcBorderColor,
                         p_fill_color=>vcBarColor,
                         p_line_width=>PK_JRXML2PDF_TYPES.THIN
                        );
        ELSE
          lX.DELETE;
          lY.DELETE;
          lX(1):=nx;              lY(1):=nY1;
          lX(2):=nx;              lY(2):=nY2;
          lX(3):=nx+nBarWidth;    lY(3):=nY2;
          lX(4):=nx+nBarWidth;    lY(4):=nY1;
          lX(5):=nx;              lY(5):=nY1;
          AS_PDF3_MOD.PR_POLYGON(i_lXs =>lX,
                                 i_lYs =>lY,
                                 i_vcLineColor=>NVL(i_rChart.lSeries(i_rDataset.nSeries).vcBorderColor, vcBarColor),
                                 i_vcFillColor=>vcBarColor,
                                 i_nLineWidth=>PK_JRXML2PDF_TYPES.THIN
                                );
          -- Apply 3d-effect
          -- build upper box
          lX.DELETE;
          lY.DELETE;
          lX(1):=nx-0.45;         lY(1):=nY2+0.45;
          lX(2):=nx+10;           lY(2):=nY2+10;
          lX(3):=nx+10+nBarWidth+0.45; lY(3):=nY2+10;
          lX(4):=nx+nBarWidth+0.45;    lY(4):=nY2+0.45;
          lX(5):=nx-0.45;         lY(5):=nY2+0.45;
          AS_PDF3_MOD.PR_POLYGON(i_lXs =>lX,
                                 i_lYs =>lY,
                                 i_vcLineColor=>i_rChart.lSeries(i_rDataset.nSeries).vcBorderColor,
                                 i_vcFillColor=>vcDarkerBarColor,
                                 i_nLineWidth=>PK_JRXML2PDF_TYPES.THIN
                                );
          -- build right box
          lX.DELETE;
          lY.DELETE;
          lX(1):=nx+nBarWidth+0.45;    lY(1):=nY2+0.45;
          lX(2):=nx+nBarWidth+10+0.45;      lY(2):=nY2+10;
          lX(3):=nx+nBarWidth+10+0.45;      lY(3):=nY1+10;
          lX(4):=nx+nBarWidth+0.45;    lY(4):=nY1-0.45;
          lX(5):=nx+nBarWidth+0.45;    lY(5):=nY2+0.45;
          AS_PDF3_MOD.PR_POLYGON(i_lXs        =>lX,
                                 i_lYs        =>lY,
                                 i_vcLineColor=>i_rChart.lSeries(i_rDataset.nSeries).vcBorderColor,
                                 i_vcFillColor=>vcVeryDarkBarColor,
                                 i_nLineWidth=>PK_JRXML2PDF_TYPES.THIN
                                );
        END IF;
      END IF;
      IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition IN (VALUE_POSITION_INSIDE, VALUE_POSITION_OUTSIDE) THEN
        AS_PDF3_MOD.set_color(i_rChart.lPlots(i_nPlotIndex).vcLabelColor);
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>i_rChart.lPlots(i_nPlotIndex).vcLabelFont,
                                      i_vcStyle    =>i_rChart.lPlots(i_nPlotIndex).vcLabelFontStyle,
                                      i_nSize      =>i_rChart.lPlots(i_nPlotIndex).nLabelFontSize
                                     );
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).nValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern, i_rChart.rLocaleData.vcNumericChars);
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          vcText:=TO_CHAR(i_rDataset.lValueDataEntries(iDatasetIndex).dtValue, i_rChart.lPlots(i_nPlotIndex).vcLabelPattern, i_rChart.rLocaleData.vcDateLanguage);
        END IF;
        IF i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_INSIDE THEN
          nYText:=(nY2-nY1)/2;
        ELSE
          IF nSwap IS NULL THEN
            nYText:=nY1-3-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          ELSE
            -- swapped, then place text beneath bar
            nYText:=nY2+3;
          END IF;
        END IF;
        nxText:=nx+nBarWidth/2-AS_PDF3_MOD.str_len(vcText)/2;
        IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES
           AND i_rChart.lPlots(i_nPlotIndex).nLabelPosition=VALUE_POSITION_OUTSIDE THEN
          nxText:=nxText+5;
        END IF;
        AS_PDF3_MOD.put_txt(p_x=>nXText,
                            p_y=>nYText,
                            p_txt=>vcText
                           );
      END IF;
    END;
  BEGIN
    FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
      IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries>0 THEN
        nRangeAxis:=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nrangeAxis;
        lSeriesIndex(i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries):=i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries;
      END IF;
    END LOOP;
    IF lSeriesIndex.COUNT>0 THEN
      IF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_STACKED_BARCHART THEN
        nSeriesCount:=1;
      ELSE
        nSeriesCount:=lSeriesIndex.COUNT;
      END IF;
      -- if the plot is 3D, render a bar-base at X-position 0
      IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
        -- find X-axis
        rAxis:=i_rChart.lValueaxis(i_rChart.lPlots(i_nPlotIndex).lDatasets(1).nValueAxis);
        nY:=i_rChartRect.nY+FK_GET_VALUE_ON_AXIS(i_rAxis       =>rAxis,
                                                 i_bSnapToEdge =>FALSE,
                                                 i_nValue      =>0
                                                );
        -- render bar-base
        IF rAxis.rMinValueDataEntry.nValue<0 AND rAxis.rMaxValueDataEntry.nValue>0 THEN
          lX(1):=i_rChartRect.nX+.5;                         lY(1):=nY+.5;
          lX(2):=i_rChartRect.nX+10.5;                       lY(2):=nY+10.5;
          lX(3):=i_rChartRect.nX+10.5+i_rChartRect.nWidth;   lY(3):=nY+10.5;
          lX(4):=i_rChartRect.nX+.5+i_rChartRect.nWidth;     lY(4):=nY+.5;
          lX(5):=i_rChartRect.nX+.5;                         lY(5):=nY+.5;
          AS_PDF3_MOD.pr_polygon( lX,
                                  lY,
                                  'EEEEEE',
                                  'EEEEEE'
                                );
          IF rAxis.vcShowDotlines=PK_JRXML2PDF_TYPES.YES THEN
            IF rAxis.vcDotlineColor IS NOT NULL THEN
              -- dotted lines
              AS_PDF3_MOD.pr_line      (i_nX1         =>i_rChartRect.nX,
                                        i_nY1         =>nY,
                                        i_nX2         =>i_rChartRect.nX+10.5,
                                        i_nY2         =>nY+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor =>REPLACE(rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke     =>'[3] 0'
                                       );
              -- dotted line
              AS_PDF3_MOD.pr_line      (i_nX1        =>i_rChartRect.nX+10.5,
                                        i_nY1        =>nY+10.5,
                                        i_nX2        =>i_rChartRect.nX+i_rChartRect.nWidth+10.5,
                                        i_nY2        =>nY+10.5,
                                        i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN,
                                        i_vcLineColor=>REPLACE(rAxis.vcDotlineColor, '#', ''),
                                        i_vcStroke   =>'[3] 0'
                                       );
            END IF;
          END IF;
        END IF;
      END IF;
      -- if spaces for category and series are not explicitly set, calculate percentage of space
      IF i_rChart.lPlots(i_nPlotIndex).nCategorySpace IS NULL THEN
        nCategorySpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit*0.20;
      ELSE
        nCategorySpace:=i_rChart.lPlots(i_nPlotIndex).nCategorySpace;
      END IF;
      IF i_rChart.lPlots(i_nPlotIndex).nSeriesSpace IS NULL THEN
        IF lSeriesIndex.COUNT>0 THEN
          nSeriesSpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit/nSeriesCount*0.4;
        ELSE
          nSeriesSpace:=i_rChart.lRangeAxis(nRangeAxis).nPixelPerUnit*0.1;
        END IF;
      ELSE
        nSeriesSpace:=i_rChart.lPlots(i_nPlotIndex).nSeriesSpace;
      END IF;
      iRangeIndex:=1;
      vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.FIRST;
      WHILE vcIndex IS NOT NULL LOOP
        nSeriesNum:=1;
        iSeries:=lSeriesIndex.FIRST;
        WHILE iSeries IS NOT NULL LOOP
          FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
            IF i_rChart.lPlots(i_nPlotIndex).lDatasets(i).nSeries=iSeries THEN
              PR_RENDER_BAR(i_rChart.lPlots(i_nPlotIndex).lDatasets(i),
                            i_rChart.lRangeAxis(nRangeAxis).lTickEntries(vcIndex),
                            iRangeIndex,
                            nSeriesNum,
                            nSeriesCount
                           );
            END IF;
          END LOOP;
          nSeriesNum:=nSeriesNum+1;
          iSeries:=lSeriesIndex.NEXT(iSeries);
        END LOOP;
        iRangeIndex:=iRangeIndex+1;
        vcIndex:=i_rChart.lRangeAxis(nRangeAxis).lTickEntries.NEXT(vcIndex);
      END LOOP;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_PLOT(i_rChart IN tChart,
                           i_nPlotIndex IN NUMBER,
                           i_rChartRect IN tRect
                          ) IS
    PROCEDURE PR_RENDER_XY_LINE_DATASET(i_rDataset IN tDataset) IS
      nX       NUMBER;
      nXFactor NUMBER;
      nY       NUMBER;
      nYFactor NUMBER;
      nxLast   NUMBER;
      nYLast   NUMBER;
      vcLineColor PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcLineColorDark PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcLineColorLight PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcColor          PK_JRXML2PDF_TYPES.tColor;
      lX       AS_PDF3_MOD.tVertices;
      lY       AS_PDF3_MOD.tVertices;
    BEGIN
      nXFactor:=i_rChart.lValueAxis(i_rDataset.nValueAxis).nPixelPerUnit;
      nYFactor:=i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit;
      IF i_rDataset.nSeries>0 THEN
        vcLineColor:=i_rChart.lSeries(i_rDataset.nSeries).vcColor;
        vcLineColorDark:=FK_DARKER(vcLineColor);
        vcLineColorLight:=FK_LIGHTER(vcLineColor);
      END IF;
      FOR i IN 1..i_rDataset.lValueDataEntries.COUNT LOOP
        -- calc x-value
        IF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nX:=i_rChartRect.nX+(i_rDataset.lRangeDataEntries(i).nValue-i_rChart.lRangeAxis(i_rDataset.nRangeAxis).rMinValueDataEntry.nValue)*nYFactor;
        ELSIF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nX:=i_rChartRect.nX+(i_rDataset.lRangeDataEntries(i).dtValue-i_rChart.lRangeAxis(i_rDataset.nRangeAxis).rMinValueDataEntry.dtValue)*nYFactor;
        END IF;
        -- starting offset
        nx:=nx+i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset;
        -- calc y-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(i).nValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.nValue)*nXFactor;
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nY:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(i).dtValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.dtValue)*nXFactor;
        END IF;
        -- starting offset
        ny:=ny+i_rChart.lValueAxis(i_rDataset.nValueAxis).nStartOffset;
        IF i_rChart.lPlots(i_nPlotIndex).vcShowShapes=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.pr_path(i_lPath     =>FK_TRANSFORM_PATH(i_nX   =>nX,
                                                              i_nY   =>nY,
                                                              i_lPath=>i_rChart.lSeries(i_rDataset.nSeries).lShapePath),
                              i_vcLineColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_vcFillColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                             );
        END IF;
        IF     nxLast IS NOT NULL
           AND i_rChart.lPlots(i_nPlotIndex).vcShowLines=PK_JRXML2PDF_TYPES.YES THEN
          IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
            lX.DELETE;
            lY.DELETE;
            lX(1):=nXLast+.5;        lY(1):=nYLast+.5;
            lX(2):=nXLast+10.5;     lY(2):=nYLast+10.5;
            lX(3):=nX+10.5;         lY(3):=nY+10.5;
            lX(4):=nX+.5;            lY(4):=nY+.5;
            lX(5):=nXLast+.5;        lY(5):=nYLast+.5;
            IF nY!=nYLast THEN
              IF (nx-nXLast)/(nY-nYLast)>1 THEN
                vcColor:=vcLineColorLight;
              ELSIF (nx-nXLast)/(nY-nYLast) BETWEEN 0 AND 1 THEN
                vcColor:=vcLineColorDark;
              ELSIF (nx-nXLast)/(nY-nYLast) BETWEEN 0 AND -1 THEN
                vcColor:=vcLineColorDark;
              ELSE
                vcColor:=vcLineColorLight;
              END IF;
            ELSE
              vcColor:=vcLineColorLight;
            END IF;
            as_pdf3_mod.pr_polygon(lX,
                                   lY,
                                   vcColor,
                                   vcColor
                                  );
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nxLast+10.5,
                                nyLast+10.5,
                                i_vcLineColor=>vcLineColor);
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny,
                                i_vcLineColor=>vcLineColor);
          ELSE
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny,
                                i_vcLineColor=>vcLineColor);
          END IF;
        END IF;
        nxLast:=nX;
        nYLast:=ny;
      END LOOP;
    END;
    PROCEDURE PR_RENDER_TIME_LINE_DATASET(i_rDataset IN tDataset) IS
      nX       NUMBER;
      nXFactor NUMBER;
      nY       NUMBER;
      nYFactor NUMBER;
      nxLast   NUMBER;
      nYLast   NUMBER;
      vcLineColor PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcLineColorDark PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcLineColorLight PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      vcColor          PK_JRXML2PDF_TYPES.tColor;
      lX       AS_PDF3_MOD.tVertices;
      lY       AS_PDF3_MOD.tVertices;
    BEGIN
      nXFactor:=i_rChart.lValueAxis(i_rDataset.nValueAxis).nPixelPerUnit;
      nYFactor:=i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nPixelPerUnit;
      IF i_rDataset.nSeries>0 THEN
        vcLineColor:=i_rChart.lSeries(i_rDataset.nSeries).vcColor;
        vcLineColorDark:=FK_DARKER(vcLineColor);
        vcLineColorLight:=FK_LIGHTER(vcLineColor);
      END IF;
      FOR i IN 1..i_rDataset.lValueDataEntries.COUNT LOOP
        -- calc x-value
        IF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nX:=i_rChartRect.nX+(i_rDataset.lRangeDataEntries(i).nValue-i_rChart.lRangeAxis(i_rDataset.nRangeAxis).rMinValueDataEntry.nValue)*nYFactor;
        ELSIF i_rDataSet.vcRangeType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nX:=i_rChartRect.nX+(i_rDataset.lRangeDataEntries(i).dtValue-i_rChart.lRangeAxis(i_rDataset.nRangeAxis).rMinValueDataEntry.dtValue)*nYFactor;
        END IF;
        -- starting offset
        nx:=nx+i_rChart.lRangeAxis(i_rDataset.nRangeAxis).nStartOffset;
        -- calc y-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nY:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(i).nValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.nValue)*nXFactor;
        ELSIF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          nY:=i_rChartRect.nY+(i_rDataset.lValueDataEntries(i).dtValue-i_rChart.lValueAxis(i_rDataset.nValueAxis).rMinValueDataEntry.dtValue)*nXFactor;
        END IF;
        -- starting offset
        ny:=ny+i_rChart.lValueAxis(i_rDataset.nValueAxis).nStartOffset;
        IF i_rChart.lPlots(i_nPlotIndex).vcShowShapes=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.pr_path(i_lPath     =>FK_TRANSFORM_PATH(i_nX   =>nX,
                                                              i_nY   =>nY,
                                                              i_lPath=>i_rChart.lSeries(i_rDataset.nSeries).lShapePath),
                              i_vcLineColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_vcFillColor=>REPLACE(i_rChart.lSeries(i_rDataset.nSeries).vcColor, '#', ''),
                              i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                             );
        END IF;
        IF     nxLast IS NOT NULL
           AND i_rChart.lPlots(i_nPlotIndex).vcShowLines=PK_JRXML2PDF_TYPES.YES THEN
          IF i_rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
            lX.DELETE;
            lY.DELETE;
            lX(1):=nXLast+.5;        lY(1):=nYLast+.5;
            lX(2):=nXLast+10.5;     lY(2):=nYLast+10.5;
            lX(3):=nX+10.5;         lY(3):=nY+10.5;
            lX(4):=nX+.5;            lY(4):=nY+.5;
            lX(5):=nXLast+.5;        lY(5):=nYLast+.5;
            IF nY!=nYLast THEN
              IF (nx-nXLast)/(nY-nYLast)>1 THEN
                vcColor:=vcLineColorLight;
              ELSIF (nx-nXLast)/(nY-nYLast) BETWEEN 0 AND 1 THEN
                vcColor:=vcLineColorDark;
              ELSIF (nx-nXLast)/(nY-nYLast) BETWEEN 0 AND -1 THEN
                vcColor:=vcLineColorDark;
              ELSE
                vcColor:=vcLineColorLight;
              END IF;
            ELSE
              vcColor:=vcLineColorLight;
            END IF;
            as_pdf3_mod.pr_polygon(lX,
                                   lY,
                                   vcColor,
                                   vcColor
                                  );
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nxLast+10.5,
                                nyLast+10.5,
                                i_vcLineColor=>vcLineColor);
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny,
                                i_vcLineColor=>vcLineColor);
          ELSE
            as_pdf3_mod.pr_line(nxLast,
                                nylast,
                                nx,
                                ny,
                                i_vcLineColor=>vcLineColor);
          END IF;
        END IF;
        nxLast:=nX;
        nYLast:=ny;
      END LOOP;
    END;
    PROCEDURE PR_RENDER_PIE_DATASET(i_rDataset IN tDataset) IS
      nX             NUMBER;
      nXFactor       NUMBER;
      nY             NUMBER;
      nYFactor       NUMBER;
      nxLast         NUMBER;
      nYLast         NUMBER;
      vcLineColor    PK_JRXML2PDF_TYPES.tColor:=PK_JRXML2PDF_TYPES.BLACK;
      nTotal         NUMBER:=0;
      nStartAngle    NUMBER:=0;
      nAngle         NUMBER;
      nCenterX       NUMBER;
      nCenterY       NUMBER;
      lPath          AS_PDF3_MOD.tPath;
      nRadius        NUMBER;
      bFirst         BOOLEAN:=TRUE;
      vcColor        PK_JRXML2PDF_TYPES.tColor;
      lAngle         PK_JRXML2PDF_TYPES.tNumList;
      bToLeft        BOOLEAN;
      nMaxLabelWidth NUMBER;
      PROCEDURE PR_PIE_LABEL(i_nValue     IN NUMBER,
                             i_vcCategory IN VARCHAR2,
                             i_nPercent   IN NUMBER,
                             i_nX         IN NUMBER,
                             i_nY         IN NUMBER,
                             i_bToLeft    IN BOOLEAN
                            ) IS
        vcText PK_JRXML2PDF_TYPES.tMaxVarchar2;
        nTextLength NUMBER;
        nTextHeight NUMBER:=0;
        nX          NUMBER;
        nY          NUMBER;
        lText       PK_JRXML2PDF_TYPES.tTextPieceList;
        nDummy      NUMBER:=0;
        nGroup      NUMBER:=0;
      BEGIN
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>PK_JRXML2PDF_TYPES.ARIAL,
                                      i_vcStyle    =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                      i_nSize      =>9
                                     );
        vcText:=PK_JRXML2PDF_UTIL.FK_TEXT_MESSAGE(i_rChart.lPlots(i_nPlotIndex).vcLabelFormat,
                                                  i_vcCategory,
                                                  TO_CHAR(ROUND(i_nValue, 1), 'FM99999999990D0', i_rChart.rLocaleData.vcNumericChars),
                                                  TO_CHAR(ROUND(i_nPercent*100,1), 'FM99999999990D0', i_rChart.rLocaleData.vcNumericChars) || '%' );
        -- calculate the textpieces
        PK_JRXML2PDF_UTIL.PR_GET_TEXT_PIECES(io_lText          =>lText,
                                             io_nCurrentHeight =>nTextheight,
                                             io_nX             =>nDummy,
                                             i_vcText          =>vcText,
                                             i_nMaxHeight      =>AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)*4,
                                             io_nGroup         =>nGroup,
                                             i_nLineSpacing    =>PK_JRXML2PDF_TYPES.MIN_LINE_SPACING,
                                             i_nXStart         =>0,
                                             i_nMaxWidth       =>nMaxLabelWidth
                                            );
        nTextLength:=0;
        FOR i IN 1..lText.COUNT LOOP
          nTextlength:=GREATEST(nTextLength,AS_PDF3_MOD.str_len(lText(i).vcText));
        END LOOP;
        IF i_bToLeft THEN
          nX:=i_nX-4-nTextLength;
        ELSE
          nx:=i_nx+2;
        END IF;
        -- Rectangle around label
        AS_PDF3_MOD.rect(nx,
                         i_nY+3+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize),
                         nTextLength+4,
                         -nTextHeight-4,
                         PK_JRXML2PDF_TYPES.BLACK,
                         PK_JRXML2PDF_TYPES.WHITE
                        );
        nY:=i_nY+2;
        FOR i IN 1..lText.COUNT LOOP
          AS_PDF3_MOD.put_txt(nX+2, nY, lText(i).vcText);
          nY:=nY-lText(i).nHeight;
        END LOOP;
      END;
    BEGIN
      -- calculate total sum of the dataset
      FOR i IN 1..i_rDataset.lValueDataEntries.COUNT LOOP
        -- calc x-value
        IF i_rDataSet.vcValueType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          nTotal:=nTotal+i_rDataset.lValueDataEntries(i).nValue;
        END IF;
      END LOOP;
      IF nTotal!=0 THEN
        nCenterX:=i_rChartRect.nX+i_rChartRect.nWidth/2;
        nCenterY:=i_rChartRect.nY+i_rChartRect.nHeight/2;
        -- Leave 50px room at a minimum left and right of pie
        nRadius:=LEAST(i_rChartRect.nWidth*0.8/2, i_rChartRect.nHeight*0.8/2);
        IF i_rChartRect.nWidth-2*nRadius<100 THEN
          nRadius:=(i_rChartRect.nWidth-100)/2;
        END IF;
        nMaxLabelWidth:=(i_rChartRect.nWidth-2*nRadius)/2-10;
        FOR i IN 1..i_rDataset.lValueDataEntries.COUNT LOOP
          nAngle:=i_rDataset.lValueDataEntries(i).nValue/nTotal*360;
          IF bFirst THEN
            nStartAngle:=90;
            bFirst:=FALSE;
          END IF;
          -- Draw Pie-piece
          lPath:=FK_CALC_PIESLICE(i_nCX=>nCenterX,
                                  i_nCY=>nCenterY,
                                  i_nA=>nRadius,
                                  i_nB=>nRadius,
                                  i_nLambda2=>FK_RADIANS(nStartAngle),
                                  i_nLambda1=>FK_RADIANS(nStartAngle-nAngle),
                                  i_bIsPieSlice=>TRUE
                                 );
          IF i_rChart.lSeries.EXISTS(i) THEN
            vcColor:=i_rChart.lSeries(i).vcColor;
          ELSE
            vcColor:='FF0000';
          END IF;
          AS_PDF3_MOD.PR_PATH(lPath,
                              PK_JRXML2PDF_TYPES.BLACK,
                              vcColor,
                              0.5
                             );
          lPath.DELETE;
          -- calculate the line and text
          lAngle(i):=MOD(nStartAngle-nAngle/2, 360);
          IF lAngle(i)<0 THEN
            lAngle(i):=360+lAngle(i);
          END IF;
          nStartAngle:=nStartAngle-nAngle;
        END LOOP;
        IF i_rChart.lPlots(i_nPlotIndex).vcIsDonut=PK_JRXML2PDF_TYPES.YES THEN
          -- Donut, cut-out inner circle
          lPath:=FK_CALC_PIESLICE(i_nCX=>nCenterX,
                                   i_nCY=>nCenterY,
                                   i_nA=>nRadius/4,
                                   i_nB=>nRadius/4,
                                   i_nLambda1=>FK_RADIANS(0),
                                   i_nLambda2=>FK_RADIANS(360),
                                   i_bIsPieSlice=>FALSE
                                  );
          AS_PDF3_MOD.PR_PATH(lPath,
                              PK_JRXML2PDF_TYPES.BLACK,
                              NVL(i_rChart.vcBgColor, PK_JRXML2PDF_TYPES.WHITE),
                              0.5
                             );
        END IF;
        FOR i IN 1..i_rDataset.lValueDataEntries.COUNT LOOP
          nXLast:= nCenterX + nRadius * 0.95 * cos(FK_RADIANS(lAngle(i)));
          nYLast:= nCentery + nRadius * 0.95 * sin(FK_RADIANS(lAngle(i)));
          nX:= nCenterX + nRadius * 1.05 * cos(FK_RADIANS(lAngle(i)));
          nY:= nCentery + nRadius * 1.05 * sin(FK_RADIANS(lAngle(i)));
          AS_PDF3_MOD.PR_LINE(nxLast,
                              nyLast,
                              nx,
                              ny,
                              PK_JRXML2PDF_TYPES.BLACK,
                              0.5
                             );
          IF    lAngle(i)<90
             OR lAngle(i)>270 THEN
            nXLast:=i_rChartRect.nx+i_rChartRect.nWidth/2+nRadius;
            bToLeft:=FALSE;
          ELSE
            nXLast:=i_rChartRect.nx+i_rChartRect.nWidth/2-nRadius;
            bToLeft:=TRUE;
          END IF;
          AS_PDF3_MOD.PR_LINE(nxLast,
                              ny,
                              nx,
                              ny,
                              PK_JRXML2PDF_TYPES.BLACK,
                              0.5
                             );
          PR_PIE_LABEL(i_rDataset.lValueDataEntries(i).nValue,
                       i_rDataset.lRangeDataEntries(i).vcValue,
                       i_rDataset.lValueDataEntries(i).nValue/nTotal,
                       nxLast,
                       ny,
                       bToLeft
                      );
        END LOOP;
      END IF;
    END;
  BEGIN
    IF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_XY_LINECHART THEN
      -- Render all datasets, measure by the corresponding axis
      FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
        PR_RENDER_XY_LINE_DATASET(i_rChart.lPlots(i_nPlotIndex).lDatasets(i));
      END LOOP;
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_TIMESERIES_LINECHART THEN
      -- Render all datasets, measure by the corresponding axis
      FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
        PR_RENDER_TIME_LINE_DATASET(i_rChart.lPlots(i_nPlotIndex).lDatasets(i));
      END LOOP;
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_CATEGORY_BARCHART THEN
      PR_RENDER_CATEGORY_BAR_PLOT(i_rChart, i_nPlotIndex, i_rChartRect);
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_STACKED_BARCHART THEN
      PR_RENDER_CATEGORY_BAR_PLOT(i_rChart, i_nPlotIndex, i_rChartRect);
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_CATEGORY_LINECHART THEN
      PR_RENDER_CATEGORY_LINE_PLOT(i_rChart, i_nPlotIndex, i_rChartRect);
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_STACKED_AREACHART THEN
      PR_RENDER_STACKED_AREA_PLOT(i_rChart, i_nPlotIndex, i_rChartRect);
    ELSIF i_rChart.lPlots(i_nPlotIndex).nType=PLOT_PIECHART THEN
      -- Render all datasets, measure by the corresponding axis
      FOR i IN 1..i_rChart.lPlots(i_nPlotIndex).lDatasets.COUNT LOOP
        PR_RENDER_PIE_DATASET(i_rChart.lPlots(i_nPlotIndex).lDatasets(i));
      END LOOP;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_LEGEND(i_rChart IN tChart) IS
    nX            NUMBER:=i_rChart.rLegend.nX+i_rChart.rLegend.rOuterPaddings.nLeft+i_rChart.rLegend.rInnerPaddings.nLeft;
    nY            NUMBER:=i_rChart.rLegend.nY-i_rChart.rLegend.rOuterPaddings.nTop-i_rChart.rLegend.rInnerPaddings.nTop;
    bFirst        BOOLEAN:=TRUE;
    nWidth        NUMBER;
    nLegendHeight NUMBER;
    PROCEDURE PR_RENDER_MARKER(i_nSeries IN NUMBER) IS
      lPath    AS_PDF3_MOD.tPath;
      nType    NUMBER;
      vcLines  PK_JRXML2PDF_TYPES.tYesNo;
      vcShapes PK_JRXML2PDF_TYPES.tYesNo;
      PROCEDURE PR_GET_SERIES_TYPE(i_nSeries IN NUMBER,
                                  o_nType    OUT NUMBER,
                                  o_vcLines  OUT PK_JRXML2PDF_TYPES.tYesNo,
                                  o_vcShapes OUT PK_JRXML2PDF_TYPES.tYesNo
                                  ) IS
      BEGIN
        IF i_rChart.lPlots(1).nType=PLOT_PIECHART THEN
          o_nType:=PLOT_PIECHART;
        ELSE
          FOR i IN 1..i_rChart.lPlots.COUNT LOOP
            FOR j IN 1..i_rChart.lPlots(i).lDatasets.COUNT LOOP
              IF i_rChart.lPlots(i).lDatasets(j).nSeries=i_nSeries THEN
                o_nType:=i_rChart.lPlots(i).nType;
                o_vcLines:=i_rChart.lPlots(i).vcShowLines;
                o_vcShapes:=i_rChart.lPlots(i).vcShowShapes;
                EXIT;
              END IF;
            END LOOP;
            EXIT WHEN nType IS NOT NULL;
          END LOOP;
        END IF;
      END;
    BEGIN
      PR_GET_SERIES_TYPE(i_nSeries, nType, vcLines, vcShapes);
      IF nType IN (PLOT_XY_LINECHART, PLOT_TIMESERIES_LINECHART) THEN
        -- Render piece of line if lines are shown
        IF vcLines=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.horizontal_line(p_x          =>nX+3,
                                      p_y          =>nY-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2-1,
                                      p_width      =>10,
                                      p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                                      p_line_color =>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', '')
                                     );
        END IF;
        IF vcShapes=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.pr_path(i_lPath     =>FK_TRANSFORM_PATH(i_nX   =>nX+8,
                                                              i_nY   =>nY-6,
                                                              i_lPath=>i_rChart.lSeries(i_nSeries).lShapePath),
                              i_vcLineColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                              i_vcFillColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                              i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                             );
        END IF;
      ELSIF nType=PLOT_CATEGORY_LINECHART THEN
        -- Render piece of line
        IF vcLines=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.horizontal_line(p_x          =>nX+3,
                                      p_y          =>nY-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)/2-1,
                                      p_width      =>10,
                                      p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                                      p_line_color =>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', '')
                                     );
        END IF;
        IF vcShapes=PK_JRXML2PDF_TYPES.YES THEN
          AS_PDF3_MOD.pr_path(i_lPath     =>FK_TRANSFORM_PATH(i_nX   =>nX+8,
                                                              i_nY   =>nY-6,
                                                              i_lPath=>i_rChart.lSeries(i_nSeries).lShapePath),
                              i_vcLineColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                              i_vcFillColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                              i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                             );
        END IF;
      ELSIF nType=PLOT_PIECHART THEN
        -- Render circle
        lPath:=FK_CALC_PIESLICE(i_nCX =>nX+7,
                                i_nCY =>nY-7,
                                i_nA  =>4,
                                i_nB =>4,
                                i_nLambda1=>0,
                                i_nLambda2=>360,
                                i_bIsPieSlice =>FALSE);
        AS_PDF3_MOD.pr_path(i_lPath     =>lPath,
                            i_vcLineColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                            i_vcFillColor=>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                            i_nLineWidth =>PK_JRXML2PDF_TYPES.THIN
                           );
      ELSIF nType IN (PLOT_CATEGORY_BARCHART, PLOT_STACKED_BARCHART, PLOT_STACKED_AREACHART) THEN
        -- Render square
        AS_PDF3_MOD.rect(p_x          =>nX+3,
                         p_y          =>nY-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize),
                         p_width      =>8,
                         p_height     =>8,
                         p_line_width =>PK_JRXML2PDF_TYPES.THIN,
                         p_line_color =>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', ''),
                         p_fill_color =>REPLACE(i_rChart.lSeries(i_nSeries).vcColor, '#', '')
                        );
      END IF;
    END;
  BEGIN
    IF i_rChart.rLegend.vcPosition!=POSITION_NONE THEN
      IF i_rChart.rLegend.vcBGColor IS NOT NULL THEN
        AS_PDF3_MOD.rect(p_x =>i_rChart.rLegend.nX+i_rChart.rLegend.rOuterPaddings.nLeft,
                         p_y =>i_rChart.rLegend.nY-i_rChart.rLegend.rOuterPaddings.nTop,
                         p_width=>i_rChart.rLegend.nWidth-i_rChart.rLegend.rOuterPaddings.nLeft-i_rChart.rLegend.rOuterPaddings.nRight,
                         p_height=>-(i_rChart.rLegend.nHeight-i_rChart.rLegend.rOuterPaddings.nTop-i_rChart.rLegend.rOuterPaddings.nBottom),
                         p_line_color =>i_rChart.rLegend.vcBGColor,
                         p_fill_color =>i_rChart.rLegend.vcBGColor,
                         p_line_width =>PK_JRXML2PDF_TYPES.THIN
                        );
      END IF;
      PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>i_rChart.rLegend.vcFont,
                                    i_vcStyle    =>i_rChart.rLegend.vcFontStyle,
                                    i_nSize      =>i_rChart.rLegend.nFontSize
                                   );
      AS_PDF3_MOD.set_color(i_rChart.rLegend.vcFontColor);
      FOR i IN 1..i_rChart.lSeries.COUNT LOOP
        IF i_rChart.rLegend.vcPosition IN (POSITION_TOP, POSITION_BOTTOM) THEN
          nWidth:=i_rChart.rLegend.nEntryXSpacing+10+2+AS_PDF3_MOD.str_len(i_rChart.lSeries(i).vcName);
          IF NOT bFirst THEN
            IF nx+nWidth> i_rChart.rLegend.nWidth
                         +i_rChart.rLegend.nX
                         -i_rChart.rLegend.rOuterPaddings.nRight
                         -i_rChart.rLegend.rInnerPaddings.nRight THEN
              -- skip to next line
              nX:=i_rChart.rLegend.nX+i_rChart.rLegend.rOuterPaddings.nLeft+i_rChart.rLegend.rInnerPaddings.nLeft;
              nY:=nY-i_rChart.rLegend.nEntryYSpacing-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            END IF;
          ELSE
            bFirst:=FALSE;
          END IF;
        ELSE
          -- skip to next line
          nX:=i_rChart.rLegend.nX+i_rChart.rLegend.rOuterPaddings.nLeft+i_rChart.rLegend.rInnerPaddings.nLeft;
          IF NOT bFirst THEN
            nY:=nY-i_rChart.rLegend.nEntryYSpacing-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          ELSE
            bFirst:=FALSE;
          END IF;
        END IF;
        PR_RENDER_MARKER(i);
        AS_PDF3_MOD.put_txt(p_x               =>nx+3+10+3,
                            p_y               =>nY-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize),
                            p_txt             =>i_rChart.lSeries(i).vcName);
        nx:=nX+nWidth;
      END LOOP;
      -- Render box
      IF i_rChart.rLegend.vcBorderColor IS NOT NULL THEN
        AS_PDF3_MOD.rect(p_x =>i_rChart.rLegend.nX+i_rChart.rLegend.rOuterPaddings.nLeft,
                         p_y =>i_rChart.rLegend.nY-i_rChart.rLegend.rOuterPaddings.nTop,
                         p_width=>i_rChart.rLegend.nWidth-i_rChart.rLegend.rOuterPaddings.nLeft-i_rChart.rLegend.rOuterPaddings.nRight,
                         p_height=>-(i_rChart.rLegend.nHeight-i_rChart.rLegend.rOuterPaddings.nTop-i_rChart.rLegend.rOuterPaddings.nBottom),
                         p_line_color=>i_rChart.rLegend.vcBorderColor,
                         p_line_width =>PK_JRXML2PDF_TYPES.THIN
                        );
      END IF;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CHART_TO_PDF(i_rChart  IN tChart,
                            i_nX      IN NUMBER,
                            i_nY      IN NUMBER) IS
    rChart        tChart:=i_rChart;
    nLeftSpace    NUMBER:=i_rChart.rInnerPaddings.nLeft;
    nRightSpace   NUMBER:=i_rChart.rInnerPaddings.nRight;
    nTopSpace     NUMBER:=i_rChart.rInnerPaddings.nTop;
    nBottomSpace  NUMBER:=i_rChart.rInnerPaddings.nBottom;
    rChartRect    tRect;
    iColor        PLS_INTEGER:=1;
    iShape        PLS_INTEGER:=1;
    PROCEDURE PR_CALC_AXIS_SPACE(io_rAxis IN OUT NOCOPY tAxis) IS
    BEGIN
      IF io_rAxis.nOrientation=ORIENTATION_VERTICAL THEN
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          io_rAxis.nX:=i_nX+nLeftSpace;
          nLeftSpace:=nLeftSpace+io_rAxis.nWidth;
        ELSIF io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
          nRightSpace:=nRightSpace+io_rAxis.nWidth;
          io_rAxis.nX:=i_nX+rChart.nWidth-nRightSpace;
        END IF;
      ELSE
        IF io_rAxis.nPosition=POSITION_TOP_OR_LEFT THEN
          io_rAxis.nY:=i_nY-nTopSpace;
          nTopSpace:=nTopSpace+io_rAxis.nHeight;
        ELSIF io_rAxis.nPosition=POSITION_BOTTOM_OR_RIGHT THEN
          nBottomSpace:=nBottomSpace+io_rAxis.nHeight;
          io_rAxis.nY:=i_nY-rChart.nHeight+nBottomSpace;
        END IF;
      END IF;
    END;
    PROCEDURE PR_CALC_LEGEND_MEASURE IS
      nResult   NUMBER:=0;
      nWidth    NUMBER;
      bFirst    BOOLEAN:=TRUE;
      nMaxWidth NUMBER:=0;
      nX        NUMBER:=0;
      nTotal    NUMBER:=0;
      vcText    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      IF rChart.rLegend.vcPosition!=POSITION_NONE THEN
        -- If the chart is a pie-chart, the series-entries are the different Keys from the dataset
        IF rChart.lPlots(1).nType=PLOT_PIECHART THEN
          -- calculate the total and percentages
          FOR i IN 1..rChart.lPlots(1).lDataSets(1).lValueDataEntries.COUNT LOOP
            nTotal:=nTotal+rChart.lPlots(1).lDataSets(1).lValueDataEntries(i).nValue;
          END LOOP;
          FOR i IN 1..rChart.lPlots(1).lDataSets(1).lRangeDataEntries.COUNT LOOP
            vcText:=PK_JRXML2PDF_UTIL.FK_TEXT_MESSAGE(i_rChart.lPlots(1).vcKeyFormat,
                                                      rChart.lPlots(1).lDataSets(1).lRangeDataEntries(i).vcValue,
                                                      TO_CHAR(ROUND(rChart.lPlots(1).lDataSets(1).lValueDataEntries(i).nValue, 1), 'FM99999999990D0', i_rChart.rLocaleData.vcNumericChars),
                                                      TO_CHAR(ROUND(rChart.lPlots(1).lDataSets(1).lValueDataEntries(i).nValue/nTotal*100,1), 'FM99999999990D0', i_rChart.rLocaleData.vcNumericChars) || '%' );
            IF rChart.lSeries.EXISTS(i) THEN
              rChart.lSeries(i).vcName:=vcText;
            ELSE
              rChart.lSeries(i):=FK_CREATE_SERIES(vcText);
              IF lDefaultColors.EXISTS(i) THEN
                rChart.lSeries(i).vcColor:=lDefaultColors(i);
                rChart.lSeries(i).vcBorderColor:=lDefaultColors(i);
              END IF;
            END IF;
          END LOOP;
        END IF;
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>rChart.rLegend.vcFont,
                                      i_vcStyle    =>rChart.rLegend.vcFontStyle,
                                      i_nSize      =>rChart.rLegend.nFontSize
                                     );
        IF rChart.rLegend.vcPosition IN (POSITION_TOP, POSITION_BOTTOM) THEN
          nResult:=2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          FOR i IN 1..rChart.lSeries.COUNT LOOP
            nWidth:=rChart.rLegend.nEntryXSpacing+10+2+AS_PDF3_MOD.str_len(rChart.lSeries(i).vcName);
            IF NOT bFirst THEN
              IF nX+nWidth>i_rChart.nWidth-rChart.rLegend.rOuterPaddings.nLeft
                                          -rChart.rLegend.rOuterPaddings.nRight
                                          -rChart.rLegend.rInnerPaddings.nLeft
                                          -rChart.rLegend.rInnerPaddings.nRight
                                          -nLeftSpace
                                          -nRightSpace THEN
                -- skip to next line
                nX:=0;
                nResult:=nResult+rChart.rLegend.nEntryYSpacing+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
              END IF;
            ELSE
              bFirst:=FALSE;
            END IF;
            nx:=nX+nWidth;
            nMaxWidth:=GREATEST(nMaxWidth, nX);
          END LOOP;
          nMaxWidth:=LEAST(nMaxWidth, i_rChart.nWidth);
          nResult:=nResult
                   +rChart.rLegend.rOuterPaddings.nTop
                   +rChart.rLegend.rOuterPaddings.nBottom
                   +rChart.rLegend.rInnerPaddings.nTop
                   +rChart.rLegend.rInnerPaddings.nBottom;
          IF rChart.rLegend.vcPosition=POSITION_TOP THEN
            rChart.rLegend.nY:=i_nY-nTopSpace;
            nTopSpace:=nTopSpace+nResult;
          ELSE
            rChart.rLegend.nY:=i_nY-rChart.nHeight+nBottomSpace+nResult;
            nBottomSpace:=nBottomSpace+nResult;
          END IF;
          rChart.rLegend.nHeight:=nResult;
          -- Check the width of the legend, if its more than the defined percentage of the whole
          -- area, put it to the maximum size
          nMaxWidth:= nMaxWidth
                     +rChart.rLegend.rInnerPaddings.nLeft
                     +rChart.rLegend.rInnerPaddings.nRight
                     +rChart.rLegend.rOuterPaddings.nLeft
                     +rChart.rLegend.rOuterPaddings.nRight;
          IF  nMaxWidth<(rChart.nWidth-nLeftSpace-nRightSpace)*rChart.rLegend.nScaleToWidthPercentage THEN
            rChart.rLegend.nWidth:=nMaxWidth;
            -- adjust x-position to center
            rChart.rLegend.nX:=i_nX+nLeftSpace+(rChart.nWidth-nLeftSpace-nRightSpace-nMaxWidth)/2;
          ELSE
            rChart.rLegend.nX:=i_nX+nLeftSpace;
            rChart.rLegend.nWidth:=rChart.nWidth-nLeftSpace-nRightSpace;
          END IF;
        ELSIF rChart.rLegend.vcPosition IN (POSITION_LEFT, POSITION_RIGHT) THEN
          nResult:=2+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
          FOR i IN 1..rChart.lSeries.COUNT LOOP
            nWidth:=rChart.rLegend.nEntryXSpacing+10+2+AS_PDF3_MOD.str_len(rChart.lSeries(i).vcName);
            IF NOT bFirst THEN
              nResult:=nResult+rChart.rLegend.nEntryYSpacing+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
            ELSE
              bFirst:=FALSE;
            END IF;
            nMaxWidth:=GREATEST(nMaxWidth, nWidth);
          END LOOP;
          nResult:=nResult
                   +rChart.rLegend.rOuterPaddings.nTop
                   +rChart.rLegend.rOuterPaddings.nBottom
                   +rChart.rLegend.rInnerPaddings.nTop
                   +rChart.rLegend.rInnerPaddings.nBottom;
          IF rChart.rLegend.vcPosition=POSITION_LEFT THEN
            rChart.rLegend.nX:=i_nX+nLeftSpace;
            nLeftSpace:=nLeftSpace+nMaxWidth;
          ELSE
            rChart.rLegend.nX:=i_nX+rChart.nWidth-nRightSpace-nMaxWidth;
            nRightSpace:=nRightSpace+nMaxWidth;
          END IF;
          rChart.rLegend.nY:=i_nY-(rChart.nHeight+nBottomSpace-nResult)/2;
          rChart.rLegend.nHeight:=nResult;
          rChart.rLegend.nWidth:= nMaxWidth
                                 +rChart.rLegend.rOuterPaddings.nLeft
                                 +rChart.rLegend.rOuterPaddings.nRight
                                 +rChart.rLegend.rInnerPaddings.nLeft
                                 +rChart.rLegend.rInnerPaddings.nRight;
        END IF;
      END IF;
    END;
    PROCEDURE PR_RENDER_TITLE IS
    BEGIN
      -- Render title
      IF rChart.vcTitle IS NOT NULL THEN
        AS_PDF3_MOD.set_color(rChart.vcTitleColor);
        -- title is centered
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>rChart.vcTitleFont,
                                      i_vcStyle    =>rChart.vcTitleFontStyle,
                                      i_nSize      =>rChart.nTitleFontSize
                                     );
        IF rChart.vcTitlePosition=POSITION_TOP THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+i_rChart.nWidth/2-AS_PDF3_MOD.str_len(rChart.vcTitle)/2,
                              p_y               =>i_nY-3-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize),
                              p_txt             =>rChart.vcTitle);
          nTopSpace:=nTopSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_BOTTOM THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+i_rChart.nWidth/2-AS_PDF3_MOD.str_len(rChart.vcTitle)/2,
                              p_y               =>i_nY+6-rChart.nHeight+nBottomSpace,
                              p_txt             =>rChart.vcTitle);
          nBottomSpace:=nBottomSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_LEFT THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+3+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize),
                              p_y               =>i_nY-(rChart.nHeight-nTopSpace-nBottomSpace)/2-AS_PDF3_MOD.str_len(rChart.vcTitle)/2,
                              p_txt             =>rChart.vcTitle,
                              p_degrees_rotation=>90
                             );
          nLeftSpace:=nLeftSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_RIGHT THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+rChart.nWidth-nRightSpace,
                              p_y               =>i_nY-(rChart.nHeight-nTopSpace-nBottomSpace)/2-AS_PDF3_MOD.str_len(rChart.vcTitle)/2,
                              p_txt             =>rChart.vcTitle,
                              p_degrees_rotation=>90
                             );
          nRightSpace:=nRightSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        END IF;
      END IF;
    END;
    PROCEDURE PR_RENDER_SUBTITLE IS
    BEGIN
      -- Render subtitle
      IF rChart.vcSubTitle IS NOT NULL THEN
        AS_PDF3_MOD.set_color(rChart.vcSubTitleColor);
        -- title is centered
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>rChart.vcSubTitleFont,
                                      i_vcStyle    =>rChart.vcSubTitleFontStyle,
                                      i_nSize      =>rChart.nSubTitleFontSize
                                     );
        IF rChart.vcTitlePosition=POSITION_TOP THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+i_rChart.nWidth/2-AS_PDF3_MOD.str_len(rChart.vcSubTitle)/2,
                              p_y               =>i_nY-3-AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)-nTopSpace,
                              p_txt             =>rChart.vcSubTitle);
          nTopSpace:=nTopSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_BOTTOM THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+i_rChart.nWidth/2-AS_PDF3_MOD.str_len(rChart.vcSubTitle)/2,
                              p_y               =>i_nY+6-rChart.nHeight+nBottomSpace,
                              p_txt             =>rChart.vcSubTitle);
          nBottomSpace:=nBottomSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_LEFT THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+3+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+nLeftSpace,
                              p_y               =>i_nY-(rChart.nHeight-nTopSpace-nBottomSpace)/2-AS_PDF3_MOD.str_len(rChart.vcSubTitle)/2,
                              p_txt             =>rChart.vcSubTitle,
                              p_degrees_rotation=>90
                             );
          nLeftSpace:=nLeftSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        ELSIF rChart.vcTitlePosition=POSITION_RIGHT THEN
          AS_PDF3_MOD.put_txt(p_x               =>i_nX+rChart.nWidth-nRightSpace,
                              p_y               =>i_nY-(rChart.nHeight-nTopSpace-nBottomSpace)/2-AS_PDF3_MOD.str_len(rChart.vcSubTitle)/2,
                              p_txt             =>rChart.vcSubTitle,
                              p_degrees_rotation=>90
                             );
          nRightSpace:=nRightSpace+AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)+10;
        END IF;
      END IF;
    END;
  BEGIN
    PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont     =>PK_JRXML2PDF_TYPES.ARIAL,
                                  i_vcStyle    =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                  i_nSize      =>10
                                 );
    -- calculate measures
    FOR i IN 1..rChart.lValueAxis.COUNT LOOP
      PR_CALC_AXIS_MEASURES(i_rChart     =>rChart,
                            io_rAxis     =>rChart.lValueAxis(i),
                            i_nAxisIndex =>i
                           );
    END LOOP;
    FOR i IN 1..rChart.lRangeAxis.COUNT LOOP
      PR_CALC_AXIS_MEASURES(i_rChart     =>rChart,
                            io_rAxis     =>rChart.lRangeAxis(i),
                            i_nAxisIndex =>i
                           );
    END LOOP;
    IF    rChart.vcBorderColor IS NOT NULL
       OR rChart.vcBgColor IS NOT NULL THEN
      -- render background
      AS_PDF3_MOD.rect(p_x          =>i_nX,
                       p_y          =>i_nY-rChart.nHeight,
                       p_width      =>rChart.nWidth,
                       p_height     =>rChart.nHeight,
                       p_line_color =>REPLACE(rChart.vcBorderColor, '#', ''),
                       p_fill_color =>REPLACE(rChart.vcBgColor, '#', ''),
                       p_line_width =>COALESCE(rChart.nBorderWidth, PK_JRXML2PDF_TYPES.THIN)
                      );
    END IF;
    PR_RENDER_TITLE;
    PR_CALC_LEGEND_MEASURE;
    PR_RENDER_SUBTITLE;
    FOR i IN 1..rChart.lValueAxis.COUNT LOOP
      PR_CALC_AXIS_SPACE(rChart.lValueAxis(i));
    END LOOP;
    FOR i IN 1..rChart.lRangeAxis.COUNT LOOP
      PR_CALC_AXIS_SPACE(rChart.lRangeAxis(i));
    END LOOP;
    rChartRect.nX:=i_nX+nLeftSpace;
    rChartRect.nY:=i_nY-rChart.nHeight+nBottomSpace;
    IF rChart.vcIs3D=PK_JRXML2PDF_TYPES.YES THEN
      rChartRect.nWidth:=rChart.nWidth-nLeftSpace-nRightSpace-10;
      rChartRect.nHeight:=rChart.nHeight-nTopSpace-nBottomSpace-10;
    ELSE
      rChartRect.nWidth:=rChart.nWidth-nLeftSpace-nRightSpace;
      rChartRect.nHeight:=rChart.nHeight-nTopSpace-nBottomSpace;
    END IF;
    -- set empty series-colour
    FOR i IN 1..rChart.lSeries.COUNT LOOP
      IF rChart.lSeries(i).vcColor IS NULL THEN
        rChart.lSeries(i).vcColor:=lDefaultColors(iColor);
        IF iColor<lDefaultColors.COUNT THEN
          iColor:=iColor+1;
        ELSE
          iColor:=1;
        END IF;
      END IF;
    END LOOP;
    --set empty series paths
    FOR i IN 1..rChart.lSeries.COUNT LOOP
      IF rChart.lSeries(i).lShapePath.COUNT=0 THEN
        rChart.lSeries(i).lShapePath:=lDefaultShapes(iShape);
        IF iShape<lDefaultShapes.COUNT THEN
          iShape:=iShape+1;
        ELSE
          iShape:=1;
        END IF;
      END IF;
    END LOOP;
    -- now render value-axis and range
    FOR i IN 1..rChart.lValueAxis.COUNT LOOP
      PR_RENDER_AXIS(rChart, rChart.lValueAxis(i), i, rChartRect);
    END LOOP;
    FOR i IN 1..rChart.lRangeAxis.COUNT LOOP
      PR_RENDER_AXIS(rChart, rChart.lRangeAxis(i), i, rChartRect);
    END LOOP;
    FOR i IN 1..rChart.lPlots.COUNT LOOP
      PR_RENDER_PLOT(rChart,
                     i,
                     rChartRect
                    );
    END LOOP;
    PR_RENDER_LEGEND(rChart);
  END;
BEGIN
  lDefaultColors(1):='FF5555';
  lDefaultColors(2):='5555FF';
  lDefaultColors(3):='55FF55';
  lDefaultColors(4):='FFFF55';
  lDefaultColors(5):='FF55FF';
  lDefaultColors(6):='55FFFF';
  lDefaultColors(7):='FFAFAF';
  lDefaultColors(8):='808080';
  lDefaultColors(9):='C00000';
  lDefaultColors(10):='0000C0';
  lDefaultColors(11):='00C000';
  lDefaultColors(12):='C0C000';
  lDefaultColors(13):='C000C0';
  lDefaultColors(14):='00C0C0';
  lDefaultColors(15):='404040';
  PR_DEFAULT_SHAPES;
  PR_INIT_DEFAULT_NUM_TICKS;
  PR_INIT_DEFAULT_DATE_TICKS;
END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_loader IS
  lReportCache         PK_JRXML2PDF_TYPES.tReportCache;
  FUNCTION FK_LOAD_BAND(io_rReport              IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                        i_oBand                 IN      XMLTYPE,
                        i_vcTyp                 IN      PK_JRXML2PDF_TYPES.tAttribute,
                        i_nHeight               IN      NUMBER,
                        i_vcPrintWhenExpression IN      PK_JRXML2PDF_TYPES.tExpression,
                        i_vcSplitType           IN      PK_JRXML2PDF_TYPES.tSplitType)
  RETURN PK_JRXML2PDF_TYPES.tBand;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_MAKE_NUM(i_vcValue IN VARCHAR2)
  RETURN NUMBER IS
  BEGIN
    RETURN TO_NUMBER(i_vcValue, 'FM9999999D99', 'NLS_NUMERIC_CHARACTERS=.,');
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_DATATYPE_FROM_CLASS(i_vcClass IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tDatatype IS
    vcResult PK_JRXML2PDF_TYPES.tDatatype;
  BEGIN
    IF i_vcClass IN ('java.lang.Integer',
                     'java.lang.Byte',
                     'java.lang.Double',
                     'java.lang.Float',
                     'java.lang.Long',
                     'java.lang.Short',
                     'java.lang.Number',
                     'java.math.BigDecimal') THEN
      vcResult:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    ELSIF i_vcClass IN ('java.sql.Timestamp',
                        'java.sql.Time',
                        'java.util.Date') THEN
      vcResult:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
    ELSE
      vcResult:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_PARAMLIST(i_xmlParams IN XMLTYPE)
  RETURN PK_JRXML2PDF_TYPES.tParamList IS
    CURSOR crParams IS
      SELECT PARAM_NAME,
             EXPRESSION
        FROM XMLTABLE('/subreport/subreportParameter' PASSING i_xmlParams
                                                      COLUMNS PARAM_NAME VARCHAR2(255) PATH './@name',
                                                              EXPRESSION VARCHAR2(255) PATH './subreportParameterExpression'
                     );
    lParams PK_JRXML2PDF_TYPES.tParamList;
    iPos    PLS_INTEGER:=0;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Create paramlist');
    END IF;
    FOR rec IN crParams LOOP
      iPos:=iPos+1;
      lParams(iPos).vcName:=rec.PARAM_NAME;
      lParams(iPos).vcValue:=rec.EXPRESSION;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Added Parameter ' || lParams(iPos).vcName ||':' || lParams(iPos).vcValue);
      END IF;
    END LOOP;
    RETURN lParams;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CREATE_TABLE_PARAMLIST(i_xmlParams IN XMLTYPE)
  RETURN PK_JRXML2PDF_TYPES.tParamList IS
    CURSOR crParams IS
      SELECT PARAM_NAME,
             EXPRESSION
        FROM XMLTABLE('/datasetRun/datasetParameter' PASSING i_xmlParams
                                                     COLUMNS PARAM_NAME VARCHAR2(255) PATH './@name',
                                                             EXPRESSION VARCHAR2(255) PATH './datasetParameterExpression'
                     );
    lParams PK_JRXML2PDF_TYPES.tParamList;
    iPos    PLS_INTEGER:=0;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Create paramlist for table');
    END IF;
    FOR rec IN crParams LOOP
      iPos:=iPos+1;
      lParams(iPos).vcName:=rec.PARAM_NAME;
      lParams(iPos).vcValue:=rec.EXPRESSION;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Added Parameter ' || lParams(iPos).vcName ||':' || lParams(iPos).vcValue);
      END IF;
    END LOOP;
    RETURN lParams;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_EXECUTE_QUERY(io_rReport IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                             i_lParams  IN PK_JRXML2PDF_TYPES.tParamList) IS
   iColCount      PLS_INTEGER;
   rec            DBMS_SQL.DESC_REC;
   iRecord        PLS_INTEGER:=0;
   nRows          NUMBER;
   lQueryResult   PK_JRXML2PDF_TYPES.tQueryresult;
   rEntry         PK_JRXML2PDF_TYPES.tDataEntry;
   vcQuery        PK_JRXML2PDF_TYPES.tMaxVarchar2:=io_rReport.vcQuery;
   nPos           PLS_INTEGER;
   nEndPos        PLS_INTEGER;
   vcLexicalParam PK_JRXML2PDF_TYPES.tMaxVarchar2;
   vcValue        PK_JRXML2PDF_TYPES.tMaxVarchar2;
   nNumberDummy   NUMBER;
   rQuery         PK_JRXML2PDF_TYPES.tQuery;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Search for lexical params');
    END IF;
    -- Replacing lexical parameters
    LOOP
      nPos:=NVL(INSTR(vcQuery, '$P!{'),0);
      vcValue:=NULL;
      EXIT WHEN nPos=0;
      nEndPos:=INSTR(vcQuery, '}', nPos+1);
      --Extract parametername
      vcLexicalParam:=SUBSTR(vcQuery,nPos+4,nEndPos- nPos-4);
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Found lexical param ' || vcLexicalParam);
      END IF;
      -- get value for parameter from report-params
      FOR i IN 1..i_lParams.COUNT LOOP
        IF i_lParams(i).vcName=vcLexicalParam THEN
          vcValue:=i_lParams(i).vcValue;
          EXIT;
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Replace by value ' || vcValue);
      END IF;
      vcQuery:=REPLACE(vcQuery, '$P!{' || vcLexicalParam || '}', vcValue);
    END LOOP;
    -- Replacing bind-parameters
    vcQuery:=REPLACE(REPLACE(vcQuery, '$P{', ':'), '}', '');
    rQuery.iCursor:=DBMS_SQL.OPEN_CURSOR;
    rQuery.bEOF:=FALSE;
    rQuery.nRecordPosition:=0;
    rQuery.nRecordRead:=0;
    rQuery.bTreatLastAsCurrent:=FALSE;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Parse query');
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Query:' || vcQuery);
    END IF;
    DBMS_SQL.PARSE(rQuery.iCursor, vcQuery, DBMS_SQL.NATIVE);
    -- Bind Variables from arameters
    FOR i IN 1..i_lParams.COUNT LOOP
      IF INSTR(vcQuery, ':' || i_lParams(i).vcName)>0 THEN
        DBMS_SQL.BIND_VARIABLE(rQuery.iCursor, i_lParams(i).vcName, i_lParams(i).vcValue);
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Bind variable / to ' || i_lParams(i).vcName  || ' / "' || i_lParams(i).vcValue || '"');
        END IF;
      END IF;
    END LOOP;
    DBMS_SQL.DESCRIBE_COLUMNS (rQuery.iCursor, iColCount, rQuery.lDescTab);
    FOR i IN 1..rQuery.lDescTab.COUNT LOOP
      IF rQuery.lDescTab(i).col_type IN     (PK_JRXML2PDF_TYPES.DBMS_SQL_VARCHAR2_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_CHAR_TYPE
                                            ) THEN
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, 'X', rQuery.lDescTab(i).COL_MAX_LEN);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is varchar: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type =      PK_JRXML2PDF_TYPES.DBMS_SQL_CLOB_TYPE THEN
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, EMPTY_CLOB);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is clob: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_NUMBER_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_FLOAT_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_BOUBLE_TYPE
                                            ) THEN
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, TO_NUMBER(NULL));
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is number: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_DATE_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TIMESTAMP_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TSTMP_WITH_TZ_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_YEAR_TO_MONTH_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_IV_DAY_TO_SECOND_TYPE,
                                             PK_JRXML2PDF_TYPES.DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE
                                            ) THEN
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, TO_DATE(NULL));
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is date: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      ELSIF rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_BLOB_TYPE
                                            ) THEN
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, EMPTY_BLOB);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is blob: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      ELSE
        DBMS_SQL.DEFINE_COLUMN(rQuery.iCursor, i, rQuery.lDescTab(i).COL_NAME, rQuery.lDescTab(i).COL_MAX_LEN);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Column is undefined: ' || rQuery.lDescTab(i).COL_NAME);
        END IF;
      END IF;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Execute query');
    END IF;
    nRows := DBMS_SQL.EXECUTE(rQuery.iCursor);
    io_rReport.rQuery:=rQuery;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LOAD_CROSSTAB(io_rReport           IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                            i_oCrosstab          IN XMLTYPE,
                            i_vcSubdataset       IN PK_JRXML2PDF_TYPES.tName,
                            i_vcRepeatRowHeaders IN PK_JRXML2PDF_TYPES.tYesNo,
                            i_vcRepeatColHeaders IN PK_JRXML2PDF_TYPES.tYesNo,
                            i_nColBreakOffset    IN NUMBER
                           )
  RETURN PK_JRXML2PDF_TYPES.tCrossTab IS
    CURSOR crDetails IS
      SELECT CASE WHEN TAG='rowGroup' THEN
               'ROWGROUP'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             WHEN TAG='measure' THEN
               'MEASURE'
             WHEN TAG='crosstabCell' THEN
               'CELL'
             WHEN TAG='crosstabHeaderCell' THEN
               'HEADERCELL'
             END ROWTYPE,
             ROWGROUP,
             COLGROUP,
             MEASURE,
             CELL,
             HEADERCELL
        FROM XMLTABLE('/crosstab/*' PASSING i_oCrosstab
                           COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                   ROWGROUP            XMLTYPE        PATH './../rowGroup',
                                   COLGROUP            XMLTYPE        PATH './../columnGroup',
                                   MEASURE             XMLTYPE        PATH './../measure',
                                   CELL                XMLTYPE        PATH './../crosstabCell',
                                   HEADERCELL          XMLTYPE        PATH './../crosstabHeaderCell'
                     );
    nColStart          NUMBER:=0;
    rCrosstab          PK_JRXML2PDF_TYPES.tCrosstab;
    iPos               PLS_INTEGER;
    iBandPos           PLS_INTEGER;
    vcStyle            PK_JRXML2PDF_TYPES.tStyleName;
    rCell              PK_JRXML2PDF_TYPES.tCrossTabCell;
    vcIndex            PK_JRXML2PDF_TYPES.tCrosstabCellName;
    FUNCTION FK_MAKE_BAND_FROM_CELL(i_oParts           IN XMLTYPE,
                                    i_nWidth           IN NUMBER,
                                    i_nHeight          IN NUMBER,
                                    i_vcBoxTop         IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                                    i_vcBoxBottom      IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                                    i_vcBoxLeft        IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                                    i_vcBoxRight       IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                                    i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                                    i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                                    i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                                    i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                                    i_vcBackColor      IN PK_JRXML2PDF_TYPES.tColor,
                                    i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo,
                                    i_vcStyle          IN PK_JRXML2PDF_TYPES.tStyleName
                                   )
    RETURN NUMBER IS
      iBandPos PLS_INTEGER;
      iPos     PLS_INTEGER;
      rObject  PK_JRXML2PDF_TYPES.tObject;
    BEGIN
      -- create new band-entry
      iBandPos:=io_rReport.lBands.COUNT+1;
      io_rReport.lBands(iBandPos).nX:=NULL;
      iPos:=io_rReport.lBands.COUNT+1;
      -- Mark record as used because of recursion
      io_rReport.lBands(iPos).nX:=NULL;
      -- load the band
      io_rReport.lBands(iPos):=FK_LOAD_BAND(io_rReport             =>io_rReport,
                                            i_oBand                =>i_oParts,
                                            i_vcTyp                =>'X-RowReg',
                                            i_nHeight              =>i_nHeight,
                                            i_vcPrintWhenExpression=>NULL,
                                            i_vcSplitType          =>PK_JRXML2PDF_TYPES.PREVENT
                                           );
      -- set band-properties
      io_rReport.lBands(iPos).nX               :=0;
      io_rReport.lBands(iPos).nY               :=0;
      io_rReport.lBands(iPos).nWidth           :=i_nWidth;
      io_rReport.lBands(iPos).nHeight          :=i_nHeight;
      io_rReport.lBands(iPos).nBoxTop          :=FK_MAKE_NUM(i_vcboxTop);
      io_rReport.lBands(iPos).nBoxLeft         :=FK_MAKE_NUM(i_vcBoxLeft);
      io_rReport.lBands(iPos).nBoxBottom       :=FK_MAKE_NUM(i_vcBoxBottom);
      io_rReport.lBands(iPos).nBoxRight        :=FK_MAKE_NUM(i_vcBoxRight);
      io_rReport.lBands(iPos).vcBoxTopColor    :=i_vcBoxTopColor;
      io_rReport.lBands(iPos).vcBoxLeftColor   :=i_vcBoxLeftColor;
      io_rReport.lBands(iPos).vcBoxBottomColor :=i_vcBoxBottomColor;
      io_rReport.lBands(iPos).vcBoxRightColor  :=i_vcBoxRightColor;
      io_rReport.lBands(iPos).vcStyle          :=i_vcStyle;
      io_rReport.lBands(iPos).vcBGColor        :=i_vcBackColor;
      io_rReport.lBands(iPos).vcOpaque         :=i_vcOpaque;
      io_rReport.lBands(iPos).vcWhenExpression :=NULL;
      rObject.nType:=PK_JRXML2PDF_TYPES.SUBFRAME;
      rObject.nPosition:=iPos;
      io_rReport.lBands(iBandPos).lObjects(io_rReport.lBands(iBandPos).lObjects.COUNT+1):=rObject;
      RETURN iPos;
    END;
    FUNCTION FK_LOAD_ROW(i_oXml IN XMLTYPE)
    RETURN PK_JRXML2PDF_TYPES.tCrosstabRow IS
      CURSOR crRow IS
        SELECT NAME,
               WIDTH,
               TOTAL_POSITION,
               HEADER_POSITION,
               EXPRESSION,
               ORDERBY,
               CLASS,
               XMLELEMENT("element", HEADER)    HEADER,
               NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
               NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
               NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
               NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
               NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
               NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
               NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
               NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
               BACKCOLOR,
               CASE WHEN MODUS='Opaque' THEN
                 'Y'
               END OPAQUE,
               STYLE,
               XMLELEMENT("element", T_HEADER)      T_HEADER,
               NVL(T_BOX_TOP_COLOR, T_BOX_COLOR)    T_BOX_TOP_COLOR,
               NVL(T_BOX_BOTTOM_COLOR, T_BOX_COLOR) T_BOX_BOTTOM_COLOR,
               NVL(T_BOX_LEFT_COLOR, T_BOX_COLOR)   T_BOX_LEFT_COLOR,
               NVL(T_BOX_RIGHT_COLOR, T_BOX_COLOR)  T_BOX_RIGHT_COLOR,
               NVL(T_BOX_TOP, T_BOX_LINEWIDTH)      T_BOX_TOP,
               NVL(T_BOX_BOTTOM, T_BOX_LINEWIDTH)   T_BOX_BOTTOM,
               NVL(T_BOX_LEFT, T_BOX_LINEWIDTH)     T_BOX_LEFT,
               NVL(T_BOX_RIGHT, T_BOX_LINEWIDTH)    T_BOX_RIGHT,
               T_BACKCOLOR,
               CASE WHEN T_MODUS='Opaque' THEN
                 'Y'
               END T_OPAQUE,
               T_STYLE
          FROM XMLTABLE('/rowGroup' PASSING i_oXml
                                    COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                            WIDTH              VARCHAR2(20)   PATH './@width',
                                            TOTAL_POSITION     VARCHAR2(20)   PATH './@totalPosition',
                                            HEADER_POSITION    VARCHAR2(20)   PATH './@headerPosition',
                                            EXPRESSION         VARCHAR2(4000) PATH './bucket/bucketExpression',
                                            ORDERBY            VARCHAR2(20)   PATH './bucket/@order',
                                            CLASS              VARCHAR2(20)   PATH './bucket/@class',
                                            HEADER             XMLTYPE        PATH './crosstabRowHeader/cellContents/*',
                                            BOX_TOP_COLOR      VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/topPen/@lineColor',
                                            BOX_BOTTOM_COLOR   VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/bottomPen/@lineColor',
                                            BOX_LEFT_COLOR     VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/leftPen/@lineColor',
                                            BOX_RIGHT_COLOR    VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/rightPen/@lineColor',
                                            BOX_TOP            VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/topPen/@lineWidth',
                                            BOX_BOTTOM         VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/bottomPen/@lineWidth',
                                            BOX_LEFT           VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/leftPen/@lineWidth',
                                            BOX_RIGHT          VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/rightPen/@lineWidth',
                                            BOX_LINEWIDTH      VARCHAR2(10)   PATH './crosstabRowHeader/cellContents/box/pen/@lineWidth',
                                            BOX_COLOR          VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/box/pen/@lineColor',
                                            BACKCOLOR          VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/@backcolor',
                                            MODUS              VARCHAR2(20)   PATH './crosstabRowHeader/cellContents/@mode',
                                            STYLE              VARCHAR2(255)  PATH './crosstabRowHeader/cellContents/@style',
                                            T_HEADER           XMLTYPE        PATH './crosstabTotalRowHeader/cellContents/*',
                                            T_BOX_TOP_COLOR    VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/topPen/@lineColor',
                                            T_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/bottomPen/@lineColor',
                                            T_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/leftPen/@lineColor',
                                            T_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/rightPen/@lineColor',
                                            T_BOX_TOP          VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/topPen/@lineWidth',
                                            T_BOX_BOTTOM       VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/bottomPen/@lineWidth',
                                            T_BOX_LEFT         VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/leftPen/@lineWidth',
                                            T_BOX_RIGHT        VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/rightPen/@lineWidth',
                                            T_BOX_LINEWIDTH    VARCHAR2(10)   PATH './crosstabTotalRowHeader/cellContents/box/pen/@lineWidth',
                                            T_BOX_COLOR        VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/box/pen/@lineColor',
                                            T_BACKCOLOR        VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/@backcolor',
                                            T_MODUS            VARCHAR2(20)   PATH './crosstabTotalRowHeader/cellContents/@mode',
                                            T_STYLE            VARCHAR2(255)  PATH './crosstabTotalRowHeader/cellContents/@style'
                       );
      rec  crRow%ROWTYPE;
      rRow PK_JRXML2PDF_TYPES.tCrosstabRow;
    BEGIN
      -- extract row-data
      OPEN crRow;
      FETCh crRow INTO rec;
      CLOSE crRow;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Load row ' || rec.NAME);
      END IF;
      -- set properties
      rRow.vcName            :=rec.NAME;
      rRow.nWidth            :=FK_MAKE_NUM(rec.WIDTH);
      rRow.vcBucketExpression:=rec.EXPRESSION;
      rRow.vcOrderBy         :=NVL(rec.ORDERBY, PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING);
      rRow.vcTotalPosition   :=rec.TOTAL_POSITION;
      rRow.vcDatatype        :=FK_DATATYPE_FROM_CLASS(rec.CLASS);
      rRow.vcHeaderPosition  :=LOWER(NVL(rec.HEADER_POSITION, PK_JRXML2PDF_TYPES.TOP_ALIGN));
      -- Special handling of Stretch
      IF rRow.vcHeaderPosition=PK_JRXML2PDF_TYPES.STRETCH_ALIGN THEN
        rRow.vcHeaderPosition:=PK_JRXML2PDF_TYPES.STRETCH_Y_ALIGN;
      END IF;
      IF rec.HEADER IS NOT NULL THEN
        -- load header-band
        rRow.nHeaderPos     :=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.HEADER,
                                                     i_nWidth           =>rec.WIDTH,
                                                     i_nHeight          =>20,
                                                     i_vcBoxTop         =>rec.BOX_TOP,
                                                     i_vcBoxBottom      =>rec.BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.BOX_LEFT,
                                                     i_vcBoxRight       =>rec.BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.BACKCOLOR,
                                                     i_vcOpaque         =>rec.OPAQUE,
                                                     i_vcStyle          =>rec.STYLE
                                                    );
      END IF;
      IF rec.T_HEADER IS NOT NULL THEN
        -- load total-band
        rRow.nTotalHeaderPos:=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.T_HEADER,
                                                     i_nWidth           =>rec.WIDTH,
                                                     i_nHeight          =>20,
                                                     i_vcBoxTop         =>rec.T_BOX_TOP,
                                                     i_vcBoxBottom      =>rec.T_BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.T_BOX_LEFT,
                                                     i_vcBoxRight       =>rec.T_BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.T_BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.T_BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.T_BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.T_BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.T_BACKCOLOR,
                                                     i_vcOpaque         =>rec.T_OPAQUE,
                                                     i_vcStyle          =>rec.T_STYLE
                                                    );
      END IF;
      RETURN rRow;
    END;
    FUNCTION FK_LOAD_COLUMN(i_oXml IN XMLTYPE)
    RETURN PK_JRXML2PDF_TYPES.tCrosstabRow IS
      CURSOR crColumn IS
        SELECT NAME,
               HEIGHT,
               EXPRESSION,
               ORDERBY,
               CLASS,
               TOTAL_POSITION,
               HEADER_POSITION,
               XMLELEMENT("element", HEADER)    HEADER,
               NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
               NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
               NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
               NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
               NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
               NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
               NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
               NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
               BACKCOLOR,
               CASE WHEN MODUS='Opaque' THEN
                 'Y'
               END OPAQUE,
               STYLE,
               XMLELEMENT("element", T_HEADER)      T_HEADER,
               NVL(T_BOX_TOP_COLOR, T_BOX_COLOR)    T_BOX_TOP_COLOR,
               NVL(T_BOX_BOTTOM_COLOR, T_BOX_COLOR) T_BOX_BOTTOM_COLOR,
               NVL(T_BOX_LEFT_COLOR, T_BOX_COLOR)   T_BOX_LEFT_COLOR,
               NVL(T_BOX_RIGHT_COLOR, T_BOX_COLOR)  T_BOX_RIGHT_COLOR,
               NVL(T_BOX_TOP, T_BOX_LINEWIDTH)      T_BOX_TOP,
               NVL(T_BOX_BOTTOM, T_BOX_LINEWIDTH)   T_BOX_BOTTOM,
               NVL(T_BOX_LEFT, T_BOX_LINEWIDTH)     T_BOX_LEFT,
               NVL(T_BOX_RIGHT, T_BOX_LINEWIDTH)    T_BOX_RIGHT,
               T_BACKCOLOR,
               CASE WHEN T_MODUS='Opaque' THEN
                 'Y'
               END T_OPAQUE,
               T_STYLE
          FROM XMLTABLE('/columnGroup'  PASSING i_oXml
                                        COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                HEIGHT             VARCHAR2(20)   PATH './@height',
                                                TOTAL_POSITION     VARCHAR2(20)   PATH './@totalPosition',
                                                HEADER_POSITION    VARCHAR2(20)   PATH './@headerPosition',
                                                EXPRESSION         VARCHAR2(4000) PATH './bucket/bucketExpression',
                                                CLASS              VARCHAR2(20)   PATH './bucket/@class',
                                                ORDERBY            VARCHAR2(20)   PATH './bucket/@order',
                                                HEADER             XMLTYPE        PATH './crosstabColumnHeader/cellContents/*',
                                                BOX_TOP_COLOR      VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/topPen/@lineColor',
                                                BOX_BOTTOM_COLOR   VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/bottomPen/@lineColor',
                                                BOX_LEFT_COLOR     VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/leftPen/@lineColor',
                                                BOX_RIGHT_COLOR    VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/rightPen/@lineColor',
                                                BOX_TOP            VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/topPen/@lineWidth',
                                                BOX_BOTTOM         VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/bottomPen/@lineWidth',
                                                BOX_LEFT           VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/leftPen/@lineWidth',
                                                BOX_RIGHT          VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/rightPen/@lineWidth',
                                                BOX_LINEWIDTH      VARCHAR2(10)   PATH './crosstabColumnHeader/cellContents/box/pen/@lineWidth',
                                                BOX_COLOR          VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/box/pen/@lineColor',
                                                BACKCOLOR          VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/@backcolor',
                                                MODUS              VARCHAR2(20)   PATH './crosstabColumnHeader/cellContents/@mode',
                                                STYLE              VARCHAR2(255)  PATH './crosstabColumnHeader/cellContents/@style',
                                                T_HEADER           XMLTYPE        PATH './crosstabTotalColumnHeader/cellContents/*',
                                                T_BOX_TOP_COLOR    VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/topPen/@lineColor',
                                                T_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/bottomPen/@lineColor',
                                                T_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/leftPen/@lineColor',
                                                T_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/rightPen/@lineColor',
                                                T_BOX_TOP          VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/topPen/@lineWidth',
                                                T_BOX_BOTTOM       VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/bottomPen/@lineWidth',
                                                T_BOX_LEFT         VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/leftPen/@lineWidth',
                                                T_BOX_RIGHT        VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/rightPen/@lineWidth',
                                                T_BOX_LINEWIDTH    VARCHAR2(10)   PATH './crosstabTotalColumnHeader/cellContents/box/pen/@lineWidth',
                                                T_BOX_COLOR        VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/box/pen/@lineColor',
                                                T_BACKCOLOR        VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/@backcolor',
                                                T_MODUS            VARCHAR2(20)   PATH './crosstabTotalColumnHeader/cellContents/@mode',
                                                T_STYLE            VARCHAR2(255)  PATH './crosstabTotalColumnHeader/cellContents/@style'
                       );
      rec  crColumn%ROWTYPE;
      rRow PK_JRXML2PDF_TYPES.tCrosstabRow;
    BEGIN
      -- extract column-data
      OPEN crColumn;
      FETCh crColumn INTO rec;
      CLOSE crColumn;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Load column ' || rec.NAME);
      END IF;
      -- set properties
      rRow.vcName            :=rec.NAME;
      rRow.nHeight           :=FK_MAKE_NUM(rec.HEIGHT);
      rRow.vcBucketExpression:=rec.EXPRESSION;
      rRow.vcOrderBy         :=NVL(rec.ORDERBY, PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING);
      rRow.vcTotalPosition   :=rec.TOTAL_POSITION;
      rRow.vcDatatype        :=FK_DATATYPE_FROM_CLASS(rec.CLASS);
      rRow.vcHeaderPosition  :=LOWER(NVL(rec.HEADER_POSITION, PK_JRXML2PDF_TYPES.CENTER_ALIGN));
      IF rec.HEADER IS NOT NULL THEN
        -- load header-band
        rRow.nHeaderPos     :=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.HEADER,
                                                     i_nWidth           =>20,
                                                     i_nHeight          =>rec.HEIGHT,
                                                     i_vcBoxTop         =>rec.BOX_TOP,
                                                     i_vcBoxBottom      =>rec.BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.BOX_LEFT,
                                                     i_vcBoxRight       =>rec.BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.BACKCOLOR,
                                                     i_vcOpaque         =>rec.OPAQUE,
                                                     i_vcStyle          =>rec.STYLE
                                                    );
      END IF;
      IF rec.T_HEADER IS NOT NULL THEN
        -- load total-band
        rRow.nTotalHeaderPos:=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.T_HEADER,
                                                     i_nWidth           =>20,
                                                     i_nHeight          =>rec.HEIGHT,
                                                     i_vcBoxTop         =>rec.T_BOX_TOP,
                                                     i_vcBoxBottom      =>rec.T_BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.T_BOX_LEFT,
                                                     i_vcBoxRight       =>rec.T_BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.T_BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.T_BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.T_BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.T_BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.T_BACKCOLOR,
                                                     i_vcOpaque         =>rec.T_OPAQUE,
                                                     i_vcStyle          =>rec.T_STYLE
                                                    );
      END IF;
      RETURN rRow;
    END;
    FUNCTION FK_LOAD_MEASURE(i_oXml IN XMLTYPE)
    RETURN PK_JRXML2PDF_TYPES.tCrossTabMeasure IS
      CURSOR crMeasure IS
        SELECT NAME,
               CALCULATION,
               MEASURE_EXPRESSION,
               CLASS
          FROM XMLTABLE('/measure' PASSING i_oXml
                                        COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                CALCULATION        VARCHAR2(20)   PATH './@calculation',
                                                MEASURE_EXPRESSION VARCHAR2(4000) PATH './measureExpression',
                                                CLASS              VARCHAR2(255)  PATH './@class'
                       );
      rec      crMeasure%ROWTYPE;
      rMeasure PK_JRXML2PDF_TYPES.tCrossTabMeasure;
    BEGIN
      -- extract measure-data
      OPEN crMeasure;
      FETCh crMeasure INTO rec;
      CLOSE crMeasure;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Load measure ' || rec.NAME);
      END IF;
      -- set properties
      rMeasure.vcName          :=rec.NAME;
      rMeasure.vcCalculation   :=NVL(rec.CALCULATION, PK_JRXML2PDF_TYPES.CALCULATION_NOTHING);
      rMeasure.vcExpression    :=rec.MEASURE_EXPRESSION;
      rMeasure.vcDatatype      :=FK_DATATYPE_FROM_CLASS(rec.CLASS);
      RETURN rMeasure;
    END;
    FUNCTION FK_LOAD_CELL(i_oXml IN XMLTYPE)
    RETURN PK_JRXML2PDF_TYPES.tCrossTabCell IS
      CURSOR crCell IS
        SELECT ROW_TOTAL_GROUP,
               COL_TOTAL_GROUP,
               WIDTH,
               HEIGHT,
               XMLELEMENT("element", CELL) CELL,
               NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
               NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
               NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
               NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
               NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
               NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
               NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
               NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
               BACKCOLOR,
               CASE WHEN MODUS='Opaque' THEN
                 'Y'
               END OPAQUE,
               STYLE
          FROM XMLTABLE('/crosstabCell' PASSING i_oXml
                                        COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                WIDTH              VARCHAR2(20)   PATH './@width',
                                                HEIGHT             VARCHAR2(20)   PATH './@height',
                                                CELL               XMLTYPE        PATH './cellContents/*',
                                                BOX_TOP_COLOR      VARCHAR2(20)   PATH './cellContents/box/topPen/@lineColor',
                                                BOX_BOTTOM_COLOR   VARCHAR2(20)   PATH './cellContents/box/bottomPen/@lineColor',
                                                BOX_LEFT_COLOR     VARCHAR2(20)   PATH './cellContents/box/leftPen/@lineColor',
                                                BOX_RIGHT_COLOR    VARCHAR2(20)   PATH './cellContents/box/rightPen/@lineColor',
                                                BOX_TOP            VARCHAR2(20)   PATH './cellContents/box/topPen/@lineWidth',
                                                BOX_BOTTOM         VARCHAR2(20)   PATH './cellContents/box/bottomPen/@lineWidth',
                                                BOX_LEFT           VARCHAR2(20)   PATH './cellContents/box/leftPen/@lineWidth',
                                                BOX_RIGHT          VARCHAR2(20)   PATH './cellContents/box/rightPen/@lineWidth',
                                                BOX_LINEWIDTH      VARCHAR2(10)   PATH './cellContents/box/pen/@lineWidth',
                                                BOX_COLOR          VARCHAR2(20)   PATH './cellContents/box/pen/@lineColor',
                                                BACKCOLOR          VARCHAR2(20)   PATH './cellContents/@backcolor',
                                                MODUS              VARCHAR2(20)   PATH './cellContents/@mode',
                                                STYLE              VARCHAR2(255)  PATH './cellContents/@style',
                                                ROW_TOTAL_GROUP    VARCHAR2(255)  PATH './@rowTotalGroup',
                                                COL_TOTAL_GROUP    VARCHAR2(255)  PATH './@columnTotalGroup'
                       );
      rec  crCell%ROWTYPE;
      rCell PK_JRXML2PDF_TYPES.tCrossTabCell;
    BEGIN
      -- extract cell-data
      OPEN crCell;
      FETCh crCell INTO rec;
      CLOSE crCell;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Load cell ' || rec.ROW_TOTAL_GROUP ||'_' || rec.COL_TOTAL_GROUP);
      END IF;
      -- set properties
      rCell.vcName            :=rec.ROW_TOTAL_GROUP ||'_' || rec.COL_TOTAL_GROUP;
      rCell.vcRowGroup        :=rec.ROW_TOTAL_GROUP;
      rCell.vcColgroup        :=rec.COL_TOTAL_GROUP;
      rCell.nWidth            :=FK_MAKE_NUM(rec.WIDTH);
      rCell.nHeight           :=FK_MAKE_NUM(rec.HEIGHT);
      IF rec.CELL IS NOT NULL THEN
        -- load cell-band
        rCell.nCellPos      :=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.CELL,
                                                     i_nWidth           =>rCell.nWidth,
                                                     i_nHeight          =>rCell.nHeight,
                                                     i_vcBoxTop         =>rec.BOX_TOP,
                                                     i_vcBoxBottom      =>rec.BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.BOX_LEFT,
                                                     i_vcBoxRight       =>rec.BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.BACKCOLOR,
                                                     i_vcOpaque         =>rec.OPAQUE,
                                                     i_vcStyle          =>rec.STYLE
                                                    );
      END IF;
      RETURN rCell;
    END;
    FUNCTION FK_LOAD_HEADERCELL(i_oXml IN XMLTYPE)
    RETURN PK_JRXML2PDF_TYPES.tCrossTabCell IS
      CURSOR crCell IS
        SELECT WIDTH,
               HEIGHT,
               XMLELEMENT("element", CELL) CELL,
               NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
               NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
               NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
               NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
               NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
               NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
               NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
               NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
               BACKCOLOR,
               CASE WHEN MODUS='Opaque' THEN
                 'Y'
               END OPAQUE,
               STYLE
          FROM XMLTABLE('/crosstabHeaderCell' PASSING i_oXml
                                        COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                WIDTH              VARCHAR2(20)   PATH './@width',
                                                HEIGHT             VARCHAR2(20)   PATH './@height',
                                                CELL               XMLTYPE        PATH './cellContents/*',
                                                BOX_TOP_COLOR      VARCHAR2(20)   PATH './cellContents/box/topPen/@lineColor',
                                                BOX_BOTTOM_COLOR   VARCHAR2(20)   PATH './cellContents/box/bottomPen/@lineColor',
                                                BOX_LEFT_COLOR     VARCHAR2(20)   PATH './cellContents/box/leftPen/@lineColor',
                                                BOX_RIGHT_COLOR    VARCHAR2(20)   PATH './cellContents/box/rightPen/@lineColor',
                                                BOX_TOP            VARCHAR2(20)   PATH './cellContents/box/topPen/@lineWidth',
                                                BOX_BOTTOM         VARCHAR2(20)   PATH './cellContents/box/bottomPen/@lineWidth',
                                                BOX_LEFT           VARCHAR2(20)   PATH './cellContents/box/leftPen/@lineWidth',
                                                BOX_RIGHT          VARCHAR2(20)   PATH './cellContents/box/rightPen/@lineWidth',
                                                BOX_LINEWIDTH      VARCHAR2(10)   PATH './cellContents/box/pen/@lineWidth',
                                                BOX_COLOR          VARCHAR2(20)   PATH './cellContents/box/pen/@lineColor',
                                                BACKCOLOR          VARCHAR2(20)   PATH './cellContents/@backcolor',
                                                MODUS              VARCHAR2(20)   PATH './cellContents/@mode',
                                                STYLE              VARCHAR2(255)  PATH './cellContents/@style'
                       );
      rec  crCell%ROWTYPE;
      rCell PK_JRXML2PDF_TYPES.tCrossTabCell;
    BEGIN
      -- extract cell-data
      OPEN crCell;
      FETCh crCell INTO rec;
      CLOSE crCell;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Load headercell ');
      END IF;
      -- set properties
      rCell.vcName            :='HEADER';
      rCell.nWidth            :=FK_MAKE_NUM(rec.WIDTH);
      rCell.nHeight           :=FK_MAKE_NUM(rec.HEIGHT);
      IF rec.CELL IS NOT NULL THEN
        -- load cell-band
        rCell.nCellPos      :=FK_MAKE_BAND_FROM_CELL(i_oParts           =>rec.CELL,
                                                     i_nWidth           =>rCell.nWidth,
                                                     i_nHeight          =>rCell.nHeight,
                                                     i_vcBoxTop         =>rec.BOX_TOP,
                                                     i_vcBoxBottom      =>rec.BOX_BOTTOM,
                                                     i_vcBoxLeft        =>rec.BOX_LEFT,
                                                     i_vcBoxRight       =>rec.BOX_RIGHT,
                                                     i_vcBoxTopColor    =>rec.BOX_TOP_COLOR,
                                                     i_vcBoxBottomColor =>rec.BOX_BOTTOM_COLOR,
                                                     i_vcBoxLeftColor   =>rec.BOX_LEFT_COLOR,
                                                     i_vcBoxRightColor  =>rec.BOX_RIGHT_COLOR,
                                                     i_vcBackColor      =>rec.BACKCOLOR,
                                                     i_vcOpaque         =>rec.OPAQUE,
                                                     i_vcStyle          =>rec.STYLE
                                                    );
      END IF;
      RETURN rCell;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Load crosstab');
    END IF;
    -- find subdataset
    IF io_rReport.lDatasets.EXISTS(i_vcSubdataset) THEN
      rCrossTab.vcQuery:=io_rReport.lDatasets(i_vcSubdataset).vcQuery;
    ELSE
      rCrossTab.vcQuery:=io_rReport.vcQuery;
    END IF;
    -- set attributes
    rCrossTab.vcRepeatRowHeaders:=i_vcRepeatRowHeaders;
    rCrossTab.vcRepeatColHeaders:=i_vcRepeatColHeaders;
    rCrossTab.nColBreakOffset:=i_nColBreakOffset;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Load crosstab-details');
    END IF;
    -- read all crosstab-detail-information
    FOR rec IN crDetails LOOP
      IF rec.ROWTYPE='ROWGROUP' THEN
        rCrossTab.lRows(rCrossTab.lRows.COUNT+1):=FK_LOAD_ROW(rec.ROWGROUP);
      ELSIF rec.ROWTYPE='COLGROUP' THEN
        rCrossTab.lColumns(rCrossTab.lColumns.COUNT+1):=FK_LOAD_COLUMN(rec.COLGROUP);
      ELSIF rec.ROWTYPE='MEASURE' THEN
        rCrossTab.lMeasures(rCrossTab.lMeasures.COUNT+1):=FK_LOAD_MEASURE(rec.MEASURE);
      ELSIF rec.ROWTYPE='CELL' THEN
        rCell:=FK_LOAD_CELL(rec.CELL);
        rCrossTab.lCells(rCell.vcName):=rCell;
      ELSIF rec.ROWTYPE='HEADERCELL' THEN
        rCrossTab.rHeaderCell:=FK_LOAD_HEADERCELL(rec.HEADERCELL);
      END IF;
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Calculating missing width and height for rows, columns and cells');
    END IF;
    -- Set the width for all cols froms the according cells
    FOR i IN 1..rCrossTab.lColumns.COUNT LOOP
      rCell:=rCrossTab.lCells('_');
      IF rCrossTab.lColumns(i).nWidth IS NULL THEN
        rCrossTab.lColumns(i).nWidth:=rCell.nWidth;
      END IF;
      IF rCrossTab.lColumns(i).nHeaderPos IS NOT NULL THEN
        rCell:=rCrossTab.lCells('_');
        io_rReport.lBands(rCrossTab.lColumns(i).nHeaderPos).nWidth:=NVL(rCrossTab.lColumns(i).nWidth, rCell.nWidth);
      END IF;
      IF rCrossTab.lColumns(i).nTotalHeaderPos IS NOT NULL THEN
        rCell:=rCrossTab.lCells('_' || rCrossTab.lColumns(i).vcName);
        IF rCell.nWidth IS NULL THEN
          rCell:=rCrossTab.lCells('_');
        END IF;
        io_rReport.lBands(rCrossTab.lColumns(i).nTotalHeaderPos).nWidth:=rCell.nWidth;
      END IF;
    END LOOP;
    -- set the width for all cols froms the according cells
    FOR i IN 1..rCrossTab.lRows.COUNT LOOP
      rCell:=rCrossTab.lCells('_');
      IF rCrossTab.lRows(i).nHeight IS NULL THEN
        rCrossTab.lRows(i).nHeight:=rCell.nHeight;
      END IF;
      IF rCrossTab.lRows(i).nHeaderPos IS NOT NULL THEN
        rCell:=rCrossTab.lCells('_');
        io_rReport.lBands(rCrossTab.lRows(i).nHeaderPos).nHeight:=NVL(rCrossTab.lRows(i).nHeight, rCell.nHeight);
      END IF;
      IF rCrossTab.lRows(i).nTotalHeaderPos IS NOT NULL THEN
        rCell:=rCrossTab.lCells(rCrossTab.lRows(i).vcName || '_');
        IF rCell.nHeight IS NULL THEN
          rCell:=rCrossTab.lCells('_');
        END IF;
        io_rReport.lBands(rCrossTab.lRows(i).nTotalHeaderPos).nHeight:=rCell.nHeight;
      END IF;
    END LOOP;
    -- Now set the width and height for all cells, if not already set
    rCell:=rCrossTab.lCells('_');
    vcIndex:=rCrosstab.lCells.FIRST;
    WHILE vcIndex IS NOT NULL LOOP
      IF rCrossTab.lCells(vcIndex).nWidth IS NULL THEN
        -- take width from according column
        FOR i IN 1..rCrossTab.lColumns.COUNT LOOP
          IF rCrossTab.lColumns(i).vcName=rCrossTab.lCells(vcIndex).vcColGroup THEN
            IF rCrossTab.lCells(vcIndex).nCellPos IS NOT NULL THEN
              rCrossTab.lCells(vcIndex).nWidth:=io_rReport.lBands(rCrossTab.lColumns(i).nTotalHeaderPos).nWidth;
              io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nWidth:=io_rReport.lBands(rCrossTab.lColumns(i).nTotalHeaderPos).nWidth;
              EXIT;
            END IF;
          END IF;
        END LOOP;
        IF io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nWidth IS NULL THEN
          rCrossTab.lCells(vcIndex).nWidth:=rCell.nWidth;
          IF rCrossTab.lCells(vcIndex).nCellPos IS NOT NULL THEN
            io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nWidth:=rCrossTab.lCells(vcIndex).nWidth;
          END IF;
        END IF;
      END IF;
      IF rCrossTab.lCells(vcIndex).nheight IS NULL THEN
        -- take height from according row
        FOR i IN 1..rCrossTab.lRows.COUNT LOOP
          IF rCrossTab.lRows(i).vcName=rCrossTab.lCells(vcIndex).vcRowGroup THEN
            IF rCrossTab.lCells(vcIndex).nCellPos IS NOT NULL THEN
              rCrossTab.lCells(vcIndex).nHeight:=io_rReport.lBands(rCrossTab.lRows(i).nTotalHeaderPos).nHeight;
              io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nHeight:=io_rReport.lBands(rCrossTab.lRows(i).nTotalHeaderPos).nHeight;
              EXIT;
            END IF;
          END IF;
        END LOOP;
        IF io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nHeight IS NULL THEN
          rCrossTab.lCells(vcIndex).nHeight:=rCell.nHeight;
          IF rCrossTab.lCells(vcIndex).nCellPos IS NOT NULL THEN
            io_rReport.lBands(rCrossTab.lCells(vcIndex).nCellPos).nHeight:=rCrossTab.lCells(vcIndex).nHeight;
          END IF;
        END IF;
      END IF;
      vcIndex:=rCrossTab.lCells.NEXT(vcIndex);
    END LOOP;
    RETURN rCrossTab;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_LOAD_TABLE_AS_SUBREPORT(i_rReport      IN PK_JRXML2PDF_TYPES.tReport,
                                       i_vcReportName IN VARCHAR2,
                                       i_oTable       IN XMLTYPE,
                                       i_vcSubdataset IN VARCHAR2) IS
    TYPE tColStartGroup IS TABLE OF NUMBER INDEX BY PK_JRXML2PDF_TYPES.tName;
    TYPE_TABLE_HEADER  CONSTANT NUMBER:=1;
    TYPE_COLUMN_HEADER CONSTANT NUMBER:=2;
    TYPE_DETAIL_CELL   CONSTANT NUMBER:=3;
    TYPE_TABLE_FOOTER  CONSTANT NUMBER:=4;
    TYPE_COLUMN_FOOTER CONSTANT NUMBER:=5;
    TYPE_GROUP_HEADER  CONSTANT NUMBER:=6;
    TYPE_GROUP_FOOTER  CONSTANT NUMBER:=7;
    CURSOR crColumnsTH IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             TH_HEIGHT,
             CH_HEIGHT,
             DC_HEIGHT,
             CF_HEIGHT,
             TF_HEIGHT,
             NVL(TH_BOX_TOP_COLOR, TH_BOX_COLOR)    TH_BOX_TOP_COLOR,
             NVL(TH_BOX_BOTTOM_COLOR, TH_BOX_COLOR) TH_BOX_BOTTOM_COLOR,
             NVL(TH_BOX_LEFT_COLOR, TH_BOX_COLOR)   TH_BOX_LEFT_COLOR,
             NVL(TH_BOX_RIGHT_COLOR, TH_BOX_COLOR)  TH_BOX_RIGHT_COLOR,
             NVL(TH_BOX_TOP, TH_BOX_LINEWIDTH)    TH_BOX_TOP,
             NVL(TH_BOX_BOTTOM, TH_BOX_LINEWIDTH) TH_BOX_BOTTOM,
             NVL(TH_BOX_LEFT, TH_BOX_LINEWIDTH)   TH_BOX_LEFT,
             NVL(TH_BOX_RIGHT, TH_BOX_LINEWIDTH)  TH_BOX_RIGHT,
             TH_STYLE,
             XMLELEMENT("element", TH_DETAILS) TH_DETAILS,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                TH_BOX_TOP_COLOR    VARCHAR2(20)   PATH './tableHeader/box/topPen/@lineColor',
                                                TH_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './tableHeader/box/bottomPen/@lineColor',
                                                TH_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './tableHeader/box/leftPen/@lineColor',
                                                TH_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './tableHeader/box/rightPen/@lineColor',
                                                TH_BOX_TOP          VARCHAR2(20)   PATH './tableHeader/box/topPen/@lineWidth',
                                                TH_BOX_BOTTOM       VARCHAR2(20)   PATH './tableHeader/box/bottomPen/@lineWidth',
                                                TH_BOX_LEFT         VARCHAR2(20)   PATH './tableHeader/box/leftPen/@lineWidth',
                                                TH_BOX_RIGHT        VARCHAR2(20)   PATH './tableHeader/box/rightPen/@lineWidth',
                                                TH_BOX_LINEWIDTH    VARCHAR2(10)   PATH './tableHeader/box/pen/@lineWidth',
                                                TH_BOX_COLOR        VARCHAR2(20)   PATH './tableHeader/box/pen/@lineColor',
                                                TH_STYLE            VARCHAR2(255)  PATH './tableHeader/@style',
                                                TH_DETAILS          XMLTYPE        PATH './tableHeader/*'
                     );
    CURSOR crColumnsCH IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             TH_HEIGHT,
             CH_HEIGHT,
             DC_HEIGHT,
             CF_HEIGHT,
             TF_HEIGHT,
             NVL(CH_BOX_TOP_COLOR, CH_BOX_COLOR)    CH_BOX_TOP_COLOR,
             NVL(CH_BOX_BOTTOM_COLOR, CH_BOX_COLOR) CH_BOX_BOTTOM_COLOR,
             NVL(CH_BOX_LEFT_COLOR, CH_BOX_COLOR)   CH_BOX_LEFT_COLOR,
             NVL(CH_BOX_RIGHT_COLOR, CH_BOX_COLOR)  CH_BOX_RIGHT_COLOR,
             NVL(CH_BOX_TOP, CH_BOX_LINEWIDTH)    CH_BOX_TOP,
             NVL(CH_BOX_BOTTOM, CH_BOX_LINEWIDTH) CH_BOX_BOTTOM,
             NVL(CH_BOX_LEFT, CH_BOX_LINEWIDTH)   CH_BOX_LEFT,
             NVL(CH_BOX_RIGHT, CH_BOX_LINEWIDTH)  CH_BOX_RIGHT,
             CH_STYLE,
             XMLELEMENT("element", CH_DETAILS) CH_DETAILS,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                CH_BOX_TOP_COLOR    VARCHAR2(20)   PATH './columnHeader/box/topPen/@lineColor',
                                                CH_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './columnHeader/box/bottomPen/@lineColor',
                                                CH_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './columnHeader/box/leftPen/@lineColor',
                                                CH_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './columnHeader/box/rightPen/@lineColor',
                                                CH_BOX_TOP          VARCHAR2(20)   PATH './columnHeader/box/topPen/@lineWidth',
                                                CH_BOX_BOTTOM       VARCHAR2(20)   PATH './columnHeader/box/bottomPen/@lineWidth',
                                                CH_BOX_LEFT         VARCHAR2(20)   PATH './columnHeader/box/leftPen/@lineWidth',
                                                CH_BOX_RIGHT        VARCHAR2(20)   PATH './columnHeader/box/rightPen/@lineWidth',
                                                CH_BOX_LINEWIDTH    VARCHAR2(10)   PATH './columnHeader/box/pen/@lineWidth',
                                                CH_BOX_COLOR        VARCHAR2(20)   PATH './columnHeader/box/pen/@lineColor',
                                                CH_STYLE            VARCHAR2(255)  PATH './columnHeader/@style',
                                                CH_DETAILS          XMLTYPE        PATH './columnHeader/*'
                     );
    CURSOR crColumnsDC IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             TH_HEIGHT,
             CH_HEIGHT,
             DC_HEIGHT,
             CF_HEIGHT,
             TF_HEIGHT,
             NVL(DC_BOX_TOP_COLOR, DC_BOX_COLOR)    DC_BOX_TOP_COLOR,
             NVL(DC_BOX_BOTTOM_COLOR, DC_BOX_COLOR) DC_BOX_BOTTOM_COLOR,
             NVL(DC_BOX_LEFT_COLOR, DC_BOX_COLOR)   DC_BOX_LEFT_COLOR,
             NVL(DC_BOX_RIGHT_COLOR, DC_BOX_COLOR)  DC_BOX_RIGHT_COLOR,
             NVL(DC_BOX_TOP, DC_BOX_LINEWIDTH)    DC_BOX_TOP,
             NVL(DC_BOX_BOTTOM, DC_BOX_LINEWIDTH) DC_BOX_BOTTOM,
             NVL(DC_BOX_LEFT, DC_BOX_LINEWIDTH)   DC_BOX_LEFT,
             NVL(DC_BOX_RIGHT, DC_BOX_LINEWIDTH)  DC_BOX_RIGHT,
             DC_STYLE,
             XMLELEMENT("element", DC_DETAILS) DC_DETAILS,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                DC_BOX_TOP_COLOR    VARCHAR2(20)   PATH './detailCell/box/topPen/@lineColor',
                                                DC_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './detailCell/box/bottomPen/@lineColor',
                                                DC_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './detailCell/box/leftPen/@lineColor',
                                                DC_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './detailCell/box/rightPen/@lineColor',
                                                DC_BOX_TOP          VARCHAR2(20)   PATH './detailCell/box/topPen/@lineWidth',
                                                DC_BOX_BOTTOM       VARCHAR2(20)   PATH './detailCell/box/bottomPen/@lineWidth',
                                                DC_BOX_LEFT         VARCHAR2(20)   PATH './detailCell/box/leftPen/@lineWidth',
                                                DC_BOX_RIGHT        VARCHAR2(20)   PATH './detailCell/box/rightPen/@lineWidth',
                                                DC_BOX_LINEWIDTH    VARCHAR2(10)   PATH './detailCell/box/pen/@lineWidth',
                                                DC_BOX_COLOR        VARCHAR2(20)   PATH './detailCell/box/pen/@lineColor',
                                                DC_STYLE            VARCHAR2(255)  PATH './detailCell/@style',
                                                DC_DETAILS          XMLTYPE        PATH './detailCell/*'
                     );
    CURSOR crColumnsCF IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             TH_HEIGHT,
             CH_HEIGHT,
             DC_HEIGHT,
             CF_HEIGHT,
             TF_HEIGHT,
             NVL(CF_BOX_TOP_COLOR, CF_BOX_COLOR)    CF_BOX_TOP_COLOR,
             NVL(CF_BOX_BOTTOM_COLOR, CF_BOX_COLOR) CF_BOX_BOTTOM_COLOR,
             NVL(CF_BOX_LEFT_COLOR, CF_BOX_COLOR)   CF_BOX_LEFT_COLOR,
             NVL(CF_BOX_RIGHT_COLOR, CF_BOX_COLOR)  CF_BOX_RIGHT_COLOR,
             NVL(CF_BOX_TOP, CF_BOX_LINEWIDTH)    CF_BOX_TOP,
             NVL(CF_BOX_BOTTOM, CF_BOX_LINEWIDTH) CF_BOX_BOTTOM,
             NVL(CF_BOX_LEFT, CF_BOX_LINEWIDTH)   CF_BOX_LEFT,
             NVL(CF_BOX_RIGHT, CF_BOX_LINEWIDTH)  CF_BOX_RIGHT,
             CF_STYLE,
             XMLELEMENT("element", CF_DETAILS) CF_DETAILS,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                CF_BOX_TOP_COLOR    VARCHAR2(20)   PATH './columnFooter/box/topPen/@lineColor',
                                                CF_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './columnFooter/box/bottomPen/@lineColor',
                                                CF_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './columnFooter/box/leftPen/@lineColor',
                                                CF_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './columnFooter/box/rightPen/@lineColor',
                                                CF_BOX_TOP          VARCHAR2(20)   PATH './columnFooter/box/topPen/@lineWidth',
                                                CF_BOX_BOTTOM       VARCHAR2(20)   PATH './columnFooter/box/bottomPen/@lineWidth',
                                                CF_BOX_LEFT         VARCHAR2(20)   PATH './columnFooter/box/leftPen/@lineWidth',
                                                CF_BOX_RIGHT        VARCHAR2(20)   PATH './columnFooter/box/rightPen/@lineWidth',
                                                CF_BOX_LINEWIDTH    VARCHAR2(10)   PATH './columnFooter/box/pen/@lineWidth',
                                                CF_BOX_COLOR        VARCHAR2(20)   PATH './columnFooter/box/pen/@lineColor',
                                                CF_STYLE            VARCHAR2(255)  PATH './columnFooter/@style',
                                                CF_DETAILS          XMLTYPE        PATH './columnFooter/*'
                     );
    CURSOR crColumnsTF IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             TH_HEIGHT,
             CH_HEIGHT,
             DC_HEIGHT,
             CF_HEIGHT,
             TF_HEIGHT,
             NVL(TF_BOX_TOP_COLOR, TF_BOX_COLOR)    TF_BOX_TOP_COLOR,
             NVL(TF_BOX_BOTTOM_COLOR, TF_BOX_COLOR) TF_BOX_BOTTOM_COLOR,
             NVL(TF_BOX_LEFT_COLOR, TF_BOX_COLOR)   TF_BOX_LEFT_COLOR,
             NVL(TF_BOX_RIGHT_COLOR, TF_BOX_COLOR)  TF_BOX_RIGHT_COLOR,
             NVL(TF_BOX_TOP, TF_BOX_LINEWIDTH)    TF_BOX_TOP,
             NVL(TF_BOX_BOTTOM, TF_BOX_LINEWIDTH) TF_BOX_BOTTOM,
             NVL(TF_BOX_LEFT, TF_BOX_LINEWIDTH)   TF_BOX_LEFT,
             NVL(TF_BOX_RIGHT, TF_BOX_LINEWIDTH)  TF_BOX_RIGHT,
             TF_STYLE,
             XMLELEMENT("element", TF_DETAILS) TF_DETAILS,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                TF_BOX_TOP_COLOR    VARCHAR2(20)   PATH './tableFooter/box/topPen/@lineColor',
                                                TF_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './tableFooter/box/bottomPen/@lineColor',
                                                TF_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './tableFooter/box/leftPen/@lineColor',
                                                TF_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './tableFooter/box/rightPen/@lineColor',
                                                TF_BOX_TOP          VARCHAR2(20)   PATH './tableFooter/box/topPen/@lineWidth',
                                                TF_BOX_BOTTOM       VARCHAR2(20)   PATH './tableFooter/box/bottomPen/@lineWidth',
                                                TF_BOX_LEFT         VARCHAR2(20)   PATH './tableFooter/box/leftPen/@lineWidth',
                                                TF_BOX_RIGHT        VARCHAR2(20)   PATH './tableFooter/box/rightPen/@lineWidth',
                                                TF_BOX_LINEWIDTH    VARCHAR2(10)   PATH './tableFooter/box/pen/@lineWidth',
                                                TF_BOX_COLOR        VARCHAR2(20)   PATH './tableFooter/box/pen/@lineColor',
                                                TF_STYLE            VARCHAR2(255)  PATH './tableFooter/@style',
                                                TF_DETAILS          XMLTYPE        PATH './tableFooter/*'
                     );
    CURSOR crColumnsGH IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE,
             XMLELEMENT("element", COL_GH) COL_GH,
             XMLELEMENT("element", COLGROUP_GH) COLGROUP_GH
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                COL_GH              XMLTYPE        PATH './../column/groupHeader',
                                                COLGROUP_GH         XMLTYPE        PATH './../columnGroup/groupHeader'
                     );
    CURSOR crColumnsGF IS
      SELECT WIDTH,
             WHEN_EXPRESSION,
             COL,
             COLGROUP,
             CASE WHEN TAG='column' THEN
               'COL'
             WHEN TAG='columnGroup' THEN
               'COLGROUP'
             END ROWTYPE,
             XMLELEMENT("element", COL_GF) COL_GF,
             XMLELEMENT("element", COLGROUP_GF) COLGROUP_GF
        FROM XMLTABLE('/table/*'        PASSING i_oTable
                                        COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                COL                 XMLTYPE        PATH './../column',
                                                COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                WIDTH               NUMBER         PATH './@width',
                                                WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                COL_GF              XMLTYPE        PATH './../column/groupFooter',
                                                COLGROUP_GF         XMLTYPE        PATH './../columnGroup/groupFooter'
                     );
    CURSOR crColumnsGroup(i_oXmlHeaders IN XMLTYPE) IS
      SELECT NAME,
             HEIGHT,
             NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
             NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
             NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
             NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
             STYLE,
             XMLELEMENT("element", DETAILS)   DETAILS
        FROM XMLTABLE('/element/*'  PASSING i_oXmlHeaders
                                        COLUMNS NAME             VARCHAR2(255)  PATH './@groupName',
                                                HEIGHT           NUMBER         PATH './cell/@height',
                                                BOX_TOP_COLOR    VARCHAR2(20)   PATH './cell/box/topPen/@lineColor',
                                                BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './cell/box/bottomPen/@lineColor',
                                                BOX_LEFT_COLOR   VARCHAR2(20)   PATH './cell/box/leftPen/@lineColor',
                                                BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './cell/box/rightPen/@lineColor',
                                                BOX_TOP          VARCHAR2(20)   PATH './cell/box/topPen/@lineWidth',
                                                BOX_BOTTOM       VARCHAR2(20)   PATH './cell/box/bottomPen/@lineWidth',
                                                BOX_LEFT         VARCHAR2(20)   PATH './cell/box/leftPen/@lineWidth',
                                                BOX_RIGHT        VARCHAR2(20)   PATH './cell/box/rightPen/@lineWidth',
                                                BOX_LINEWIDTH    VARCHAR2(10)   PATH './cell/box/pen/@lineWidth',
                                                BOX_COLOR        VARCHAR2(20)   PATH './cell/box/pen/@lineColor',
                                                STYLE            VARCHAR2(255)  PATH './cell/@style',
                                                DETAILS          XMLTYPE        PATH './cell/*'
                     );
    nColStart          NUMBER:=0;
    nColStartForGroup  tColStartGroup;
    nTempColStart      NUMBER;
    rReport            PK_JRXML2PDF_TYPES.tReport;
    iPos               PLS_INTEGER;
    iBandPos           PLS_INTEGER;
    vcStyle            PK_JRXML2PDF_TYPES.tStyleName;
    rGroup             PK_JRXML2PDF_TYPES.tGroup;
    iMatchGroup        PLS_INTEGER;
    PROCEDURE PR_PROCESS_PART(io_rRegion         IN OUT NOCOPY PK_JRXML2PDF_TYPES.tRegion,
                              i_vcWhenExpression IN PK_JRXML2PDF_TYPES.tExpression,
                              i_nColStart        IN NUMBER,
                              i_nColWidth        IN NUMBER,
                              i_nYOffset         IN NUMBER,
                              i_nHeight          IN NUMBER,
                              i_vcBoxTop         IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                              i_vcBoxBottom      IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                              i_vcBoxLeft        IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                              i_vcBoxRight       IN PK_JRXML2PDF_TYPES.tNumAsVarchar2,
                              i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                              i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                              i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                              i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                              i_vcStyle          IN PK_JRXML2PDF_TYPES.tStyleName,
                              i_oParts           IN XMLTYPE
                             ) IS
      rObject PK_JRXML2PDF_TYPES.tObject;
    BEGIN
      IF i_nHeight IS NOT NULL THEN
        -- Initialize band in region
        IF io_rRegion.lObjects.COUNT=0 THEN
          iBandPos:=rReport.lBands.COUNT+1;
          -- tick record to reserve array-index
          rReport.lBands(iBandPos).nX:=0;
          rReport.lBands(iBandPos).nHeight:=NVL(i_nHeight,0);
          rReport.lBands(iBandPos).bHasBreaks:=FALSE;
          rObject.nType:=PK_JRXML2PDF_TYPES.BAND;
          rObject.nPosition:=iBandPos;
          io_rRegion.lObjects(io_rRegion.lObjects.COUNT+1):=rObject;
        ELSE
          -- read band-position
          iBandPos:=io_rRegion.lObjects(1).nPosition;
          -- calculate new height for the band
          rReport.lBands(iBandPos).nHeight:=GREATEST(rReport.lBands(iBandPos).nHeight, i_nHeight+i_nYOffset);
        END IF;
        iPos:=rReport.lBands.COUNT+1;
        -- Mark record as used because of recursion
        rReport.lBands(iPos).nX:=NULL;
        rReport.lBands(iPos):=FK_LOAD_BAND(io_rReport             =>rReport,
                                           i_oBand                =>i_oParts,
                                           i_vcTyp                =>'colRegion',
                                           i_nHeight              =>i_nHeight,
                                           i_vcPrintWhenExpression=>NULL,
                                           i_vcSplitType          =>PK_JRXML2PDF_TYPES.PREVENT
                                          );
        rReport.lBands(iPos).nX               :=i_nColStart;
        rReport.lBands(iPos).nY               :=i_nYOffset;
        rReport.lBands(iPos).nWidth           :=i_nColWidth;
        rReport.lBands(iPos).nHeight          :=NVL(i_nHeight,0);
        rReport.lBands(iPos).nBoxTop          :=FK_MAKE_NUM(i_vcboxTop);
        rReport.lBands(iPos).nBoxLeft         :=FK_MAKE_NUM(i_vcBoxLeft);
        rReport.lBands(iPos).nBoxBottom       :=FK_MAKE_NUM(i_vcBoxBottom);
        rReport.lBands(iPos).nBoxRight        :=FK_MAKE_NUM(i_vcBoxRight);
        rReport.lBands(iPos).vcBoxTopColor    :=i_vcBoxTopColor;
        rReport.lBands(iPos).vcBoxLeftColor   :=i_vcBoxLeftColor;
        rReport.lBands(iPos).vcBoxBottomColor :=i_vcBoxBottomColor;
        rReport.lBands(iPos).vcBoxRightColor  :=i_vcBoxRightColor;
        rReport.lBands(iPos).vcStyle          :=i_vcStyle;
        rReport.lBands(iPos).vcWhenExpression :=i_vcWhenExpression;
        rReport.lBands(iPos).vcStretch        :=PK_JRXML2PDF_TYPES.YES;
        rObject.nType:=PK_JRXML2PDF_TYPES.SUBFRAME;
        rObject.nPosition:=iPos;
        rReport.lBands(iBandPos).lObjects(rReport.lBands(iBandPos).lObjects.COUNT+1):=rObject;
      END IF;
    END;
    FUNCTION FK_PROCESS_GROUP(i_oXml             IN XMLTYPE,
                              i_nProcessType     IN NUMBER,
                              i_vcWhenExpression IN PK_JRXML2PDF_TYPES.tExpression,
                              i_nHeight          IN NUMBER,
                              i_nLastLevelheight IN NUMBER,
                              i_vcGroupName      IN VARCHAR2 DEFAULT NULL
                             )
    RETURN NUMBER IS
      CURSOR crColumnsTH IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               TH_HEIGHT,
               NVL(TH_BOX_TOP_COLOR, TH_BOX_COLOR)    TH_BOX_TOP_COLOR,
               NVL(TH_BOX_BOTTOM_COLOR, TH_BOX_COLOR) TH_BOX_BOTTOM_COLOR,
               NVL(TH_BOX_LEFT_COLOR, TH_BOX_COLOR)   TH_BOX_LEFT_COLOR,
               NVL(TH_BOX_RIGHT_COLOR, TH_BOX_COLOR)  TH_BOX_RIGHT_COLOR,
               NVL(TH_BOX_TOP, TH_BOX_LINEWIDTH)    TH_BOX_TOP,
               NVL(TH_BOX_BOTTOM, TH_BOX_LINEWIDTH) TH_BOX_BOTTOM,
               NVL(TH_BOX_LEFT, TH_BOX_LINEWIDTH)   TH_BOX_LEFT,
               NVL(TH_BOX_RIGHT, TH_BOX_LINEWIDTH)  TH_BOX_RIGHT,
               TH_STYLE,
               XMLELEMENT("element", TH_DETAILS) TH_DETAILS,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXML
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                  TH_BOX_TOP_COLOR    VARCHAR2(20)   PATH './tableHeader/box/topPen/@lineColor',
                                                  TH_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './tableHeader/box/bottomPen/@lineColor',
                                                  TH_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './tableHeader/box/leftPen/@lineColor',
                                                  TH_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './tableHeader/box/rightPen/@lineColor',
                                                  TH_BOX_TOP          VARCHAR2(20)   PATH './tableHeader/box/topPen/@lineWidth',
                                                  TH_BOX_BOTTOM       VARCHAR2(20)   PATH './tableHeader/box/bottomPen/@lineWidth',
                                                  TH_BOX_LEFT         VARCHAR2(20)   PATH './tableHeader/box/leftPen/@lineWidth',
                                                  TH_BOX_RIGHT        VARCHAR2(20)   PATH './tableHeader/box/rightPen/@lineWidth',
                                                  TH_BOX_LINEWIDTH    VARCHAR2(10)   PATH './tableHeader/box/pen/@lineWidth',
                                                  TH_BOX_COLOR        VARCHAR2(20)   PATH './tableHeader/box/pen/@lineColor',
                                                  TH_STYLE            VARCHAR2(255)  PATH './tableHeader/@style',
                                                  TH_DETAILS          XMLTYPE        PATH './tableHeader/*'
                       );
      CURSOR crColumnsCH IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               CH_HEIGHT,
               NVL(CH_BOX_TOP_COLOR, CH_BOX_COLOR)    CH_BOX_TOP_COLOR,
               NVL(CH_BOX_BOTTOM_COLOR, CH_BOX_COLOR) CH_BOX_BOTTOM_COLOR,
               NVL(CH_BOX_LEFT_COLOR, CH_BOX_COLOR)   CH_BOX_LEFT_COLOR,
               NVL(CH_BOX_RIGHT_COLOR, CH_BOX_COLOR)  CH_BOX_RIGHT_COLOR,
               NVL(CH_BOX_TOP, CH_BOX_LINEWIDTH)    CH_BOX_TOP,
               NVL(CH_BOX_BOTTOM, CH_BOX_LINEWIDTH) CH_BOX_BOTTOM,
               NVL(CH_BOX_LEFT, CH_BOX_LINEWIDTH)   CH_BOX_LEFT,
               NVL(CH_BOX_RIGHT, CH_BOX_LINEWIDTH)  CH_BOX_RIGHT,
               CH_STYLE,
               XMLELEMENT("element", CH_DETAILS) CH_DETAILS,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXML
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  TH_DETAILS          XMLTYPE        PATH './tableHeader/*',
                                                  CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                  CH_BOX_TOP_COLOR    VARCHAR2(20)   PATH './columnHeader/box/topPen/@lineColor',
                                                  CH_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './columnHeader/box/bottomPen/@lineColor',
                                                  CH_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './columnHeader/box/leftPen/@lineColor',
                                                  CH_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './columnHeader/box/rightPen/@lineColor',
                                                  CH_BOX_TOP          VARCHAR2(20)   PATH './columnHeader/box/topPen/@lineWidth',
                                                  CH_BOX_BOTTOM       VARCHAR2(20)   PATH './columnHeader/box/bottomPen/@lineWidth',
                                                  CH_BOX_LEFT         VARCHAR2(20)   PATH './columnHeader/box/leftPen/@lineWidth',
                                                  CH_BOX_RIGHT        VARCHAR2(20)   PATH './columnHeader/box/rightPen/@lineWidth',
                                                  CH_BOX_LINEWIDTH    VARCHAR2(10)   PATH './columnHeader/box/pen/@lineWidth',
                                                  CH_BOX_COLOR        VARCHAR2(20)   PATH './columnHeader/box/pen/@lineColor',
                                                  CH_STYLE            VARCHAR2(255)  PATH './columnHeader/@style',
                                                  CH_DETAILS          XMLTYPE        PATH './columnHeader/*'
                       );
      CURSOR crColumnsDC IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               DC_HEIGHT,
               TH_HEIGHT,
               CH_HEIGHT,
               CF_HEIGHT,
               TF_HEIGHT,
               NVL(DC_BOX_TOP_COLOR, DC_BOX_COLOR)    DC_BOX_TOP_COLOR,
               NVL(DC_BOX_BOTTOM_COLOR, DC_BOX_COLOR) DC_BOX_BOTTOM_COLOR,
               NVL(DC_BOX_LEFT_COLOR, DC_BOX_COLOR)   DC_BOX_LEFT_COLOR,
               NVL(DC_BOX_RIGHT_COLOR, DC_BOX_COLOR)  DC_BOX_RIGHT_COLOR,
               NVL(DC_BOX_TOP, DC_BOX_LINEWIDTH)    DC_BOX_TOP,
               NVL(DC_BOX_BOTTOM, DC_BOX_LINEWIDTH) DC_BOX_BOTTOM,
               NVL(DC_BOX_LEFT, DC_BOX_LINEWIDTH)   DC_BOX_LEFT,
               NVL(DC_BOX_RIGHT, DC_BOX_LINEWIDTH)  DC_BOX_RIGHT,
               DC_STYLE,
               XMLELEMENT("element", DC_DETAILS) DC_DETAILS,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXML
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  DC_HEIGHT           NUMBER         PATH './detailCell/@height',
                                                  TH_HEIGHT           NUMBER         PATH './tableHeader/@height',
                                                  CH_HEIGHT           NUMBER         PATH './columnHeader/@height',
                                                  CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                  TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                  DC_BOX_TOP_COLOR    VARCHAR2(20)   PATH './detailCell/box/topPen/@lineColor',
                                                  DC_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './detailCell/box/bottomPen/@lineColor',
                                                  DC_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './detailCell/box/leftPen/@lineColor',
                                                  DC_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './detailCell/box/rightPen/@lineColor',
                                                  DC_BOX_TOP          VARCHAR2(20)   PATH './detailCell/box/topPen/@lineWidth',
                                                  DC_BOX_BOTTOM       VARCHAR2(20)   PATH './detailCell/box/bottomPen/@lineWidth',
                                                  DC_BOX_LEFT         VARCHAR2(20)   PATH './detailCell/box/leftPen/@lineWidth',
                                                  DC_BOX_RIGHT        VARCHAR2(20)   PATH './detailCell/box/rightPen/@lineWidth',
                                                  DC_BOX_LINEWIDTH    VARCHAR2(10)   PATH './detailCell/box/pen/@lineWidth',
                                                  DC_BOX_COLOR        VARCHAR2(20)   PATH './detailCell/box/pen/@lineColor',
                                                  DC_STYLE            VARCHAR2(255)  PATH './detailCell/@style',
                                                  DC_DETAILS          XMLTYPE        PATH './detailCell/*'
                       );
      CURSOR crColumnsCF IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               CF_HEIGHT,
               NVL(CF_BOX_TOP_COLOR, CF_BOX_COLOR)    CF_BOX_TOP_COLOR,
               NVL(CF_BOX_BOTTOM_COLOR, CF_BOX_COLOR) CF_BOX_BOTTOM_COLOR,
               NVL(CF_BOX_LEFT_COLOR, CF_BOX_COLOR)   CF_BOX_LEFT_COLOR,
               NVL(CF_BOX_RIGHT_COLOR, CF_BOX_COLOR)  CF_BOX_RIGHT_COLOR,
               NVL(CF_BOX_TOP, CF_BOX_LINEWIDTH)    CF_BOX_TOP,
               NVL(CF_BOX_BOTTOM, CF_BOX_LINEWIDTH) CF_BOX_BOTTOM,
               NVL(CF_BOX_LEFT, CF_BOX_LINEWIDTH)   CF_BOX_LEFT,
               NVL(CF_BOX_RIGHT, CF_BOX_LINEWIDTH)  CF_BOX_RIGHT,
               CF_STYLE,
               XMLELEMENT("element", CF_DETAILS) CF_DETAILS,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXML
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  CF_HEIGHT           NUMBER         PATH './columnFooter/@height',
                                                  CF_BOX_TOP_COLOR    VARCHAR2(20)   PATH './columnFooter/box/topPen/@lineColor',
                                                  CF_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './columnFooter/box/bottomPen/@lineColor',
                                                  CF_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './columnFooter/box/leftPen/@lineColor',
                                                  CF_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './columnFooter/box/rightPen/@lineColor',
                                                  CF_BOX_TOP          VARCHAR2(20)   PATH './columnFooter/box/topPen/@lineWidth',
                                                  CF_BOX_BOTTOM       VARCHAR2(20)   PATH './columnFooter/box/bottomPen/@lineWidth',
                                                  CF_BOX_LEFT         VARCHAR2(20)   PATH './columnFooter/box/leftPen/@lineWidth',
                                                  CF_BOX_RIGHT        VARCHAR2(20)   PATH './columnFooter/box/rightPen/@lineWidth',
                                                  CF_BOX_LINEWIDTH    VARCHAR2(10)   PATH './columnFooter/box/pen/@lineWidth',
                                                  CF_BOX_COLOR        VARCHAR2(20)   PATH './columnFooter/box/pen/@lineColor',
                                                  CF_STYLE            VARCHAR2(255)  PATH './columnFooter/@style',
                                                  CF_DETAILS          XMLTYPE        PATH './columnFooter/*'
                       );
      CURSOR crColumnsTF IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               TF_HEIGHT,
               NVL(TF_BOX_TOP_COLOR, TF_BOX_COLOR)    TF_BOX_TOP_COLOR,
               NVL(TF_BOX_BOTTOM_COLOR, TF_BOX_COLOR) TF_BOX_BOTTOM_COLOR,
               NVL(TF_BOX_LEFT_COLOR, TF_BOX_COLOR)   TF_BOX_LEFT_COLOR,
               NVL(TF_BOX_RIGHT_COLOR, TF_BOX_COLOR)  TF_BOX_RIGHT_COLOR,
               NVL(TF_BOX_TOP, TF_BOX_LINEWIDTH)    TF_BOX_TOP,
               NVL(TF_BOX_BOTTOM, TF_BOX_LINEWIDTH) TF_BOX_BOTTOM,
               NVL(TF_BOX_LEFT, TF_BOX_LINEWIDTH)   TF_BOX_LEFT,
               NVL(TF_BOX_RIGHT, TF_BOX_LINEWIDTH)  TF_BOX_RIGHT,
               TF_STYLE,
               XMLELEMENT("element", TF_DETAILS) TF_DETAILS,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXML
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  TF_HEIGHT           NUMBER         PATH './tableFooter/@height',
                                                  TF_BOX_TOP_COLOR    VARCHAR2(20)   PATH './tableFooter/box/topPen/@lineColor',
                                                  TF_BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './tableFooter/box/bottomPen/@lineColor',
                                                  TF_BOX_LEFT_COLOR   VARCHAR2(20)   PATH './tableFooter/box/leftPen/@lineColor',
                                                  TF_BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './tableFooter/box/rightPen/@lineColor',
                                                  TF_BOX_TOP          VARCHAR2(20)   PATH './tableFooter/box/topPen/@lineWidth',
                                                  TF_BOX_BOTTOM       VARCHAR2(20)   PATH './tableFooter/box/bottomPen/@lineWidth',
                                                  TF_BOX_LEFT         VARCHAR2(20)   PATH './tableFooter/box/leftPen/@lineWidth',
                                                  TF_BOX_RIGHT        VARCHAR2(20)   PATH './tableFooter/box/rightPen/@lineWidth',
                                                  TF_BOX_LINEWIDTH    VARCHAR2(10)   PATH './tableFooter/box/pen/@lineWidth',
                                                  TF_BOX_COLOR        VARCHAR2(20)   PATH './tableFooter/box/pen/@lineColor',
                                                  TF_STYLE            VARCHAR2(255)  PATH './tableFooter/@style',
                                                  TF_DETAILS          XMLTYPE        PATH './tableFooter/*'
                       );
      CURSOR crColumnsGH IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE,
               XMLELEMENT("element", COL_GH) COL_GH,
               XMLELEMENT("element", COLGROUP_GH) COLGROUP_GH
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXml
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  COL_GH              XMLTYPE        PATH './../column/groupHeader',
                                                  COLGROUP_GH         XMLTYPE        PATH './../columnGroup/groupHeader'
                       );
      CURSOR crColumnsGF IS
        SELECT WIDTH,
               WHEN_EXPRESSION,
               COL,
               COLGROUP,
               CASE WHEN TAG='column' THEN
                 'COL'
               WHEN TAG='columnGroup' THEN
                 'COLGROUP'
               END ROWTYPE,
               XMLELEMENT("element", COL_GF) COL_GF,
               XMLELEMENT("element", COLGROUP_GF) COLGROUP_GF
          FROM XMLTABLE('/columnGroup/*'  PASSING i_oXml
                                          COLUMNS TAG                 VARCHAR2(80)   PATH 'name()',
                                                  COL                 XMLTYPE        PATH './../column',
                                                  COLGROUP            XMLTYPE        PATH './../columnGroup',
                                                  WIDTH               NUMBER         PATH './@width',
                                                  WHEN_EXPRESSION     VARCHAR2(4000) PATH './printWhenExpression',
                                                  COL_GF              XMLTYPE        PATH './../column/groupFooter',
                                                  COLGROUP_GF         XMLTYPE        PATH './../columnGroup/groupFooter'
                       );
      CURSOR crColumnsGroup(i_oXmlHeaders IN XMLTYPE) IS
        SELECT NAME,
               HEIGHT,
               NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
               NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
               NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
               NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
               NVL(BOX_TOP, BOX_LINEWIDTH)      BOX_TOP,
               NVL(BOX_BOTTOM, BOX_LINEWIDTH)   BOX_BOTTOM,
               NVL(BOX_LEFT, BOX_LINEWIDTH)     BOX_LEFT,
               NVL(BOX_RIGHT, BOX_LINEWIDTH)    BOX_RIGHT,
               STYLE,
               XMLELEMENT("element", DETAILS)   DETAILS
          FROM XMLTABLE('/element/*'  PASSING i_oXmlHeaders
                                          COLUMNS NAME             VARCHAR2(255)  PATH './@groupName',
                                                  HEIGHT           NUMBER         PATH './cell/@height',
                                                  BOX_TOP_COLOR    VARCHAR2(20)   PATH './cell/box/topPen/@lineColor',
                                                  BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './cell/box/bottomPen/@lineColor',
                                                  BOX_LEFT_COLOR   VARCHAR2(20)   PATH './cell/box/leftPen/@lineColor',
                                                  BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './cell/box/rightPen/@lineColor',
                                                  BOX_TOP          VARCHAR2(20)   PATH './cell/box/topPen/@lineWidth',
                                                  BOX_BOTTOM       VARCHAR2(20)   PATH './cell/box/bottomPen/@lineWidth',
                                                  BOX_LEFT         VARCHAR2(20)   PATH './cell/box/leftPen/@lineWidth',
                                                  BOX_RIGHT        VARCHAR2(20)   PATH './cell/box/rightPen/@lineWidth',
                                                  BOX_LINEWIDTH    VARCHAR2(10)   PATH './cell/box/pen/@lineWidth',
                                                  BOX_COLOR        VARCHAR2(20)   PATH './cell/box/pen/@lineColor',
                                                  STYLE            VARCHAR2(255)  PATH './cell/@style',
                                                  DETAILS          XMLTYPE        PATH './cell/*'
                       );
      nLastColStart NUMBER:=nColStart;
      nInnerheight  NUMBER:=0;
      PROCEDURE PR_PROCESS_TABLE_HEADER IS
        nMasterColStart NUMBER;
      BEGIN
        FOR rec IN crColumnsTH LOOP
          IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
            -- table-header in column,
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Table-Header');
            END IF;
            PR_PROCESS_PART(rReport.rTitleRegion,
                            i_vcWhenExpression,
                            nColStart,
                            rec.Width,
                            i_nHeight,
                            rec.TH_HEIGHT,
                            rec.TH_BOX_TOP,
                            rec.TH_BOX_BOTTOM,
                            rec.TH_BOX_LEFT,
                            rec.TH_BOX_RIGHT,
                            rec.TH_BOX_TOP_COLOR,
                            rec.TH_BOX_BOTTOM_COLOR,
                            rec.TH_BOX_LEFT_COLOR,
                            rec.TH_BOX_RIGHT_COLOR,
                            rec.TH_STYLE,
                            rec.TH_DETAILS
                           );
          END IF;
          IF rec.ROWTYPE='COLGROUP' THEN
            -- recursively process columngroup
            nMasterColStart:=nColStart;
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           i_nProcessType,
                                           i_vcWhenExpression,
                                           i_nHeight+NVL(rec.TH_HEIGHT,0),
                                           NVL(rec.TH_HEIGHT,0)
                                          );
          END IF;
          IF rec.ROWTYPE='COL' THEN
            -- Startposition of next column
            nColStart:=nColStart+NVL(rec.WIDTH,0);
          ELSIF rec.ROWTYPE='COLGROUP' THEN
            -- Startposition of next column
            nColStart:=nMasterColStart+NVL(rec.WIDTH,0);
          END IF;
        END LOOP;
      END;
      PROCEDURE PR_PROCESS_COLUMN_HEADER IS
        nMasterColStart NUMBER;
      BEGIN
        FOR rec IN crColumnsCH LOOP
          IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
            -- column-Header in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Column-Header');
            END IF;
            PR_PROCESS_PART(rReport.rColumnHeaderRegion,
                            i_vcWhenExpression,
                            nColStart,
                            rec.Width,
                            i_nHeight,
                            rec.CH_HEIGHT,
                            rec.CH_BOX_TOP,
                            rec.CH_BOX_BOTTOM,
                            rec.CH_BOX_LEFT,
                            rec.CH_BOX_RIGHT,
                            rec.CH_BOX_TOP_COLOR,
                            rec.CH_BOX_BOTTOM_COLOR,
                            rec.CH_BOX_LEFT_COLOR,
                            rec.CH_BOX_RIGHT_COLOR,
                            rec.CH_STYLE,
                            rec.CH_DETAILS);
          END IF;
          IF rec.ROWTYPE='COLGROUP' THEN
            nMasterColStart:=nColStart;
            -- recursively process columngroup
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           i_nProcessType,
                                           i_vcWhenExpression,
                                           i_nHeight+NVL(rec.CH_HEIGHT,0),
                                           NVL(rec.CH_HEIGHT,0)
                                          );
          END IF;
          IF rec.ROWTYPE='COL' THEN
            -- Startposition of next column
            nColStart:=nColStart+NVL(rec.WIDTH,0);
          ELSIF rec.ROWTYPE='COLGROUP' THEN
            -- Startposition of next column
            nColStart:=nMasterColStart+NVL(rec.WIDTH,0);
          END IF;
        END LOOP;
      END;
      PROCEDURE PR_PROCESS_DETAIL_CELL IS
      BEGIN
        FOR rec IN crColumnsDC LOOP
          IF rec.ROWTYPE IN ('COL') THEN
            -- detail in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Detail-Cells');
            END IF;
            PR_PROCESS_PART(rReport.rDetailRegion,
                            i_vcWhenExpression,
                            nColStart,
                            rec.Width,
                            0,
                            rec.DC_HEIGHT,
                            rec.DC_BOX_TOP,
                            rec.DC_BOX_BOTTOM,
                            rec.DC_BOX_LEFT,
                            rec.DC_BOX_RIGHT,
                            rec.DC_BOX_TOP_COLOR,
                            rec.DC_BOX_BOTTOM_COLOR,
                            rec.DC_BOX_LEFT_COLOR,
                            rec.DC_BOX_RIGHT_COLOR,
                            rec.DC_STYLE,
                            rec.DC_DETAILS);
            -- Startposition of next column
            nColStart:=nColStart+NVL(rec.WIDTH, 0);
          ELSIF rec.ROWTYPE='COLGROUP' THEN
            -- recursively process columngroup
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           i_nProcessType,
                                           i_vcWhenExpression,
                                           i_nHeight+NVL(rec.DC_HEIGHT,0),
                                           NVL(rec.DC_HEIGHT,0)
                                          );
          END IF;
        END LOOP;
      END;
      PROCEDURE PR_PROCESS_COLUMN_FOOTER IS
        nMasterColStart NUMBER;
        nDetailColStart NUMBER;
        bFound          BOOLEAN:=FALSE;
      BEGIN
        FOR rec IN crColumnsCF LOOP
          IF rec.ROWTYPE='COLGROUP' THEN
            -- recursively process columngroup
            nMasterColStart:=nColStart;
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           i_nProcessType,
                                           i_vcWhenExpression,
                                           NVL(rec.CF_HEIGHT,0),
                                           NVL(rec.CF_HEIGHT,0)
                                          );
            nDetailColStart:=nColStart;
            nColStart:=nMasterColStart;
          ELSIF rec.ROWTYPE='COL' THEN
            nInnerheight:=i_nHeight-i_nLastLevelheight;
          END IF;
          IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
            IF rec.CF_HEIGHT IS NOT NULL THEN
              bFound:=TRUE;
            END IF;
            -- column-footer in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Column-Footer');
            END IF;
            PR_PROCESS_PART(rReport.rColumnFooterRegion,
                            i_vcWhenExpression,
                            nColStart,
                            rec.Width,
                            nInnerheight,
                            rec.CF_HEIGHT,
                            rec.CF_BOX_TOP,
                            rec.CF_BOX_BOTTOM,
                            rec.CF_BOX_LEFT,
                            rec.CF_BOX_RIGHT,
                            rec.CF_BOX_TOP_COLOR,
                            rec.CF_BOX_BOTTOM_COLOR,
                            rec.CF_BOX_LEFT_COLOR,
                            rec.CF_BOX_RIGHT_COLOR,
                            rec.CF_STYLE,
                            rec.CF_DETAILS);
          END IF;
          IF rec.ROWTYPE='COL' THEN
            -- Startposition of next column
            nColStart:=nColStart+NVL(rec.WIDTH,0);
          ELSIF rec.ROWTYPE IN ('COLGROUP') THEN
            nColStart:=nDetailColStart;
          END IF;
        END LOOP;
        IF bFound THEN
          nInnerHeight:=nInnerHeight+i_nHeight;
        END IF;
      END;
      PROCEDURE PR_PROCESS_TABLE_FOOTER IS
        nMasterColStart NUMBER;
        nDetailColStart NUMBER;
        bFound          BOOLEAN:=FALSE;
      BEGIN
        FOR rec IN crColumnsTF LOOP
          IF rec.ROWTYPE='COLGROUP' THEN
            nMasterColStart:=nColStart;
            -- recursively process columngroup
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           i_nProcessType,
                                           i_vcWhenExpression,
                                           NVL(rec.TF_HEIGHT,0),
                                           NVL(rec.TF_HEIGHT,0)
                                          );
            nDetailColStart:=nColStart;
            nColStart:=nMasterColStart;
          ELSIF rec.ROWTYPE='COL' THEN
            nInnerheight:=i_nHeight-i_nLastLevelheight;
          END IF;
          IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
            IF rec.TF_HEIGHT IS NOT NULL THEN
              bFound:=TRUE;
            END IF;
            -- table-footer in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Table-Footer');
            END IF;
            PR_PROCESS_PART(rReport.rSummaryRegion,
                            i_vcWhenExpression,
                            nColStart,
                            rec.Width,
                            nInnerheight,
                            rec.TF_HEIGHT,
                            rec.TF_BOX_TOP,
                            rec.TF_BOX_BOTTOM,
                            rec.TF_BOX_LEFT,
                            rec.TF_BOX_RIGHT,
                            rec.TF_BOX_TOP_COLOR,
                            rec.TF_BOX_BOTTOM_COLOR,
                            rec.TF_BOX_LEFT_COLOR,
                            rec.TF_BOX_RIGHT_COLOR,
                            rec.TF_STYLE,
                            rec.TF_DETAILS);
          END IF;
          IF rec.ROWTYPE='COL' THEN
            -- Startposition of next column
            nColStart:=nColStart+NVL(rec.WIDTH,0);
          END IF;
        END LOOP;
        IF bFound THEN
          nInnerHeight:=nInnerHeight+i_nHeight;
        END IF;
      END;
      PROCEDURE PR_PROCESS_GROUP_HEADER IS
        iMatchGroup PLS_INTEGER;
      BEGIN
        FOR rec IN crColumnsGH    LOOP
          IF rec.ROWTYPE IN ('COL') THEN
            FOR rec2 IN crColumnsGroup(rec.COL_GH) LOOP
              IF rec2.NAME=i_vcGroupName THEN
                IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
                  nColStartForGroup(rec2.NAME):=nTempColStart;
                END IF;
                -- detail in column
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-Headers for group ' || rec2.NAME);
                END IF;
                iMatchGroup:=NULL;
                FOR i IN 1..rReport.lGroups.COUNT LOOP
                  IF rReport.lGroups(i).vcName=rec2.NAME THEN
                    iMatchGroup:=i;
                    EXIT;
                  END IF;
                END LOOP;
                IF iMatchGroup IS NOT NULL THEN
                  -- find the matching region
                  PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupHeader,
                                  rec.WHEN_EXPRESSION,
                                  nColStartForGroup(rec2.NAME),
                                  rec.WIDTH,
                                  i_nHeight,
                                  rec2.HEIGHT,
                                  rec2.BOX_TOP,
                                  rec2.BOX_BOTTOM,
                                  rec2.BOX_LEFT,
                                  rec2.BOX_RIGHT,
                                  rec2.BOX_TOP_COLOR,
                                  rec2.BOX_BOTTOM_COLOR,
                                  rec2.BOX_LEFT_COLOR,
                                  rec2.BOX_RIGHT_COLOR,
                                  rec2.STYLE,
                                  rec2.DETAILS);
                END IF;
                nColStartForGroup(rec2.NAME):=nColStartForGroup(rec2.NAME)+rec.WIDTH;
              END IF;
            END LOOP;
         ELSIF rec.ROWTYPE='COLGROUP' THEN
            FOR rec2 IN crColumnsGroup(rec.COLGROUP_GH) LOOP
              IF rec2.NAME=i_vcGroupName THEN
                IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
                  nColStartForGroup(rec2.NAME):=nTempColStart;
                END IF;
                -- detail in column
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-Headers for group ' || rec2.NAME);
                END IF;
                iMatchGroup:=NULL;
                FOR i IN 1..rReport.lGroups.COUNT LOOP
                  IF rReport.lGroups(i).vcName=rec2.NAME THEN
                    iMatchGroup:=i;
                    EXIT;
                  END IF;
                END LOOP;
                IF iMatchGroup IS NOT NULL THEN
                  -- find the matching region
                  PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupHeader,
                                  rec.WHEN_EXPRESSION,
                                  nColStartForGroup(rec2.NAME),
                                  rec.WIDTH,
                                  i_nHeight,
                                  rec2.HEIGHT,
                                  rec2.BOX_TOP,
                                  rec2.BOX_BOTTOM,
                                  rec2.BOX_LEFT,
                                  rec2.BOX_RIGHT,
                                  rec2.BOX_TOP_COLOR,
                                  rec2.BOX_BOTTOM_COLOR,
                                  rec2.BOX_LEFT_COLOR,
                                  rec2.BOX_RIGHT_COLOR,
                                  rec2.STYLE,
                                  rec2.DETAILS);
                END IF;
                nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                               i_nProcessType,
                                               rec.WHEN_EXPRESSION,
                                               NVL(rec2.HEIGHT,0),
                                               NVL(rec2.HEIGHT,0),
                                               rec2.NAME
                                              );
              END IF;
            END LOOP;
          END IF;
        END LOOP;
      END;
      PROCEDURE PR_PROCESS_GROUP_FOOTER IS
        iMatchGroup     PLS_INTEGER;
        nMasterColStart NUMBER;
        nDetailColStart NUMBER;
        bFound          BOOLEAN:=FALSE;
      BEGIN
        FOR rec IN crColumnsGF    LOOP
          IF rec.ROWTYPE IN ('COL') THEN
            FOR rec2 IN crColumnsGroup(rec.COL_GF) LOOP
              IF rec2.NAME=i_vcGroupName THEN
                nInnerheight:=i_nHeight-i_nLastLevelheight;
                IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
                  nColStartForGroup(rec2.NAME):=nTempColStart;
                END IF;
                -- detail in column
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-footers for group ' || rec2.NAME);
                END IF;
                iMatchGroup:=NULL;
                FOR i IN 1..rReport.lGroups.COUNT LOOP
                  IF rReport.lGroups(i).vcName=rec2.NAME THEN
                    iMatchGroup:=i;
                    EXIT;
                  END IF;
                END LOOP;
                IF iMatchGroup IS NOT NULL THEN
                  IF rec2.HEIGHT IS NOT NULL THEN
                    bFound:=TRUE;
                  END IF;
                  -- find the matching region
                  PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupFooter,
                                  rec.WHEN_EXPRESSION,
                                  nColStartForGroup(rec2.NAME),
                                  rec.WIDTH,
                                  nInnerHeight,
                                  rec2.HEIGHT,
                                  rec2.BOX_TOP,
                                  rec2.BOX_BOTTOM,
                                  rec2.BOX_LEFT,
                                  rec2.BOX_RIGHT,
                                  rec2.BOX_TOP_COLOR,
                                  rec2.BOX_BOTTOM_COLOR,
                                  rec2.BOX_LEFT_COLOR,
                                  rec2.BOX_RIGHT_COLOR,
                                  rec2.STYLE,
                                  rec2.DETAILS);
                END IF;
                nColStartForGroup(rec2.NAME):=nColStartForGroup(rec2.NAME)+rec.WIDTH;
              END IF;
            END LOOP;
          ELSIF rec.ROWTYPE='COLGROUP' THEN
            FOR rec2 IN crColumnsGroup(rec.COLGROUP_GF) LOOP
              IF rec2.NAME=i_vcGroupName THEN
                IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
                  nColStartForGroup(rec2.NAME):=nTempColStart;
                END IF;
                nMasterColStart:=nColStartForGroup(rec2.NAME);
                nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                               i_nProcessType,
                                               rec.WHEN_EXPRESSION,
                                               NVL(rec2.HEIGHT,0),
                                               NVL(rec2.HEIGHT,0),
                                               rec2.NAME
                                              );
                nDetailColStart:=nColStartForGroup(rec2.NAME);
                nColStartForGroup(rec2.NAME):=nMasterColStart;
                -- detail in column
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-footers for group ' || rec2.NAME);
                END IF;
                iMatchGroup:=NULL;
                FOR i IN 1..rReport.lGroups.COUNT LOOP
                  IF rReport.lGroups(i).vcName=rec2.NAME THEN
                    iMatchGroup:=i;
                    EXIT;
                  END IF;
                END LOOP;
                IF iMatchGroup IS NOT NULL THEN
                  IF rec2.HEIGHT IS NOT NULL THEN
                    bFound:=TRUE;
                  END IF;
                  -- find the matching region
                  PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupFooter,
                                  rec.WHEN_EXPRESSION,
                                  nColStartForGroup(rec2.NAME),
                                  rec.WIDTH,
                                  nInnerheight,
                                  rec2.HEIGHT,
                                  rec2.BOX_TOP,
                                  rec2.BOX_BOTTOM,
                                  rec2.BOX_LEFT,
                                  rec2.BOX_RIGHT,
                                  rec2.BOX_TOP_COLOR,
                                  rec2.BOX_BOTTOM_COLOR,
                                  rec2.BOX_LEFT_COLOR,
                                  rec2.BOX_RIGHT_COLOR,
                                  rec2.STYLE,
                                  rec2.DETAILS);
                END IF;
                nColStartForGroup(rec2.NAME):=nDetailColStart;
              END IF;
            END LOOP;
          END IF;
        END LOOP;
        IF bFound THEN
          nInnerHeight:=nInnerHeight+i_nHeight;
        END IF;
      END;
    BEGIN
      IF i_nProcessType=TYPE_TABLE_HEADER THEN
        PR_PROCESS_TABLE_HEADER;
      ELSIF i_nProcessType=TYPE_COLUMN_HEADER THEN
        PR_PROCESS_COLUMN_HEADER;
      ELSIF i_nProcessType=TYPE_DETAIL_CELL THEN
        PR_PROCESS_DETAIL_CELL;
      ELSIF i_nProcessType=TYPE_COLUMN_FOOTER THEN
        PR_PROCESS_COLUMN_FOOTER;
      ELSIF i_nProcessType=TYPE_TABLE_FOOTER THEN
        PR_PROCESS_TABLE_FOOTER;
      ELSIF i_nProcessType=TYPE_GROUP_HEADER THEN
        PR_PROCESS_GROUP_HEADER;
      ELSIF i_nProcessType=TYPE_GROUP_FOOTER THEN
        PR_PROCESS_GROUP_FOOTER;
      END IF;
      RETURN nInnerHeight;
    END;
    PROCEDURE PR_INITIALIZE_REPORT IS
    BEGIN
      -- copy styles
      vcStyle:=i_rReport.lStyles.FIRST;
      LOOP
        EXIT WHEN vcStyle IS NULL;
        rReport.lStyles(vcStyle):=i_rReport.lStyles(vcStyle);
        vcStyle:=i_rReport.lStyles.NEXT(vcStyle);
      END LOOP;
      -- find subdataset
      IF i_rReport.lDatasets.EXISTS(i_vcSubdataset) THEN

        rReport.vcQuery:=i_rReport.lDatasets(i_vcSubdataset).vcQuery;
        -- take over the groups from the subdataset
        rReport.lGroups:=i_rReport.lDatasets(i_vcSubdataset).lGroups;
        FOR i IN 1..rReport.lGroups.COUNT LOOP
          -- set layouting options
          rReport.lGroups(i).vcStartOnNewPage:=PK_JRXML2PDF_TYPES.NO;
          rReport.lGroups(i).vcResetPageNumber:=PK_JRXML2PDF_TYPES.NO;
          rReport.lGroups(i).vcReprintHeader:=PK_JRXML2PDF_TYPES.NO;
          rReport.lGroups(i).nMinHeightForPage:=NULL;
          rReport.lGroupExpressions(i):=NULL;
        END LOOP;
        -- take over the variables
        rReport.lVariables:=i_rReport.lDatasets(i_vcSubdataset).lVariables;
      END IF;
      -- take over resources and locale-data
      rReport.rLocaleData:=i_rReport.rLocaleData;
      rReport.lResources:=i_rReport.lResources;
    END;
    PROCEDURE PR_PROCESS_TH_COLUMNS IS
      nInnerheight    NUMBER;
      nMasterColStart NUMBER;
    BEGIN
      nTempColStart:=nColStart;
      FOR rec IN crColumnsTH LOOP
        IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
          -- table-header in column,
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Table-Header');
          END IF;
          PR_PROCESS_PART(rReport.rTitleRegion,
                          rec.WHEN_EXPRESSION,
                          nColStart,
                          rec.Width,
                          0,
                          rec.TH_HEIGHT,
                          rec.TH_BOX_TOP,
                          rec.TH_BOX_BOTTOM,
                          rec.TH_BOX_LEFT,
                          rec.TH_BOX_RIGHT,
                          rec.TH_BOX_TOP_COLOR,
                          rec.TH_BOX_BOTTOM_COLOR,
                          rec.TH_BOX_LEFT_COLOR,
                          rec.TH_BOX_RIGHT_COLOR,
                          rec.TH_STYLE,
                          rec.TH_DETAILS
                         );
        END IF;
        -- groups
        IF rec.ROWTYPE='COLGROUP' THEN
          nMasterColStart:=nColStart;
          -- recursively process columngroup
          nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                         TYPE_TABLE_HEADER,
                                         rec.WHEN_EXPRESSION,
                                         NVL(rec.TH_HEIGHT,0),
                                         NVL(rec.TH_HEIGHT,0)
                                        );
        END IF;
        IF rec.ROWTYPE IN ('COL') THEN
          -- Startposition of next column
          nColStart:=nColStart+rec.WIDTH;
        ELSIF rec.ROWTYPE IN ('COLGROUP') THEN
          nColStart:=nMasterColStart+rec.WIDTH;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_CH_COLUMNS IS
      nInnerheight   NUMBER;
      nMasterColStart NUMBER;
    BEGIN
      nColStart:=nTempColStart;
      FOR rec IN crColumnsCH LOOP
        IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
          -- column-Header in column
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Column-Header');
          END IF;
          PR_PROCESS_PART(rReport.rColumnHeaderRegion,
                          rec.WHEN_EXPRESSION,
                          nColStart,
                          rec.Width,
                          0,
                          rec.CH_HEIGHT,
                          rec.CH_BOX_TOP,
                          rec.CH_BOX_BOTTOM,
                          rec.CH_BOX_LEFT,
                          rec.CH_BOX_RIGHT,
                          rec.CH_BOX_TOP_COLOR,
                          rec.CH_BOX_BOTTOM_COLOR,
                          rec.CH_BOX_LEFT_COLOR,
                          rec.CH_BOX_RIGHT_COLOR,
                          rec.CH_STYLE,
                          rec.CH_DETAILS);
        END IF;
        -- groups
        IF rec.ROWTYPE='COLGROUP' THEN
          nMasterColStart:=nColStart;
          nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                         TYPE_COLUMN_HEADER,
                                         rec.WHEN_EXPRESSION,
                                         NVL(rec.CH_HEIGHT,0),
                                         NVL(rec.CH_HEIGHT,0)
                                        );
        END IF;
        IF rec.ROWTYPE IN ('COL') THEN
          -- Startposition of next column
          nColStart:=nColStart+rec.WIDTH;
        ELSIF rec.ROWTYPE IN ('COLGROUP') THEN
          -- Startposition of next column
          nColStart:=nMasterColStart+rec.WIDTH;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_DC_COLUMNS IS
      nInnerheight NUMBER;
    BEGIN
      nColStart:=nTempColStart;
      FOR rec IN crColumnsDC LOOP
        IF rec.ROWTYPE IN ('COL') THEN
          -- detail in column
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Detail-Cells');
          END IF;
          PR_PROCESS_PART(rReport.rDetailRegion,
                          rec.WHEN_EXPRESSION,
                          nColStart,
                          rec.Width,
                          0,
                          rec.DC_HEIGHT,
                          rec.DC_BOX_TOP,
                          rec.DC_BOX_BOTTOM,
                          rec.DC_BOX_LEFT,
                          rec.DC_BOX_RIGHT,
                          rec.DC_BOX_TOP_COLOR,
                          rec.DC_BOX_BOTTOM_COLOR,
                          rec.DC_BOX_LEFT_COLOR,
                          rec.DC_BOX_RIGHT_COLOR,
                          rec.DC_STYLE,
                          rec.DC_DETAILS);
        ELSIF rec.ROWTYPE='COLGROUP' THEN
          nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                         TYPE_DETAIL_CELL,
                                         rec.WHEN_EXPRESSION,
                                         0,
                                         0
                                        );
        END IF;
        IF rec.ROWTYPE IN ('COL') THEN
          -- Startposition of next column
          nColStart:=nColStart+rec.WIDTH;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_CF_COLUMNS IS
      nMasterColStart NUMBER;
      nDetailColStart NUMBER;
      nInnerheight    NUMBER:=0;
    BEGIN
      nColStart:=nTempColStart;
      FOR rec IN crColumnsCF LOOP
        IF rec.ROWTYPE='COLGROUP' THEN
          nMasterColStart:=nColStart;
          nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                         TYPE_COLUMN_FOOTER,
                                         rec.WHEN_EXPRESSION,
                                         NVL(rec.CF_HEIGHT,0),
                                         NVL(rec.CF_HEIGHT,0)
                                        );
          nDetailColStart:=nColStart;
          nColStart:=nMasterColStart;
        ELSIF rec.ROWTYPE ='COL' THEN
          nInnerheight:=0;
        END IF;
        IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
          -- column-footer in column
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Column-Footer');
          END IF;
          PR_PROCESS_PART(rReport.rColumnFooterRegion,
                          rec.WHEN_EXPRESSION,
                          nColStart,
                          rec.Width,
                          nInnerheight,
                          rec.CF_HEIGHT,
                          rec.CF_BOX_TOP,
                          rec.CF_BOX_BOTTOM,
                          rec.CF_BOX_LEFT,
                          rec.CF_BOX_RIGHT,
                          rec.CF_BOX_TOP_COLOR,
                          rec.CF_BOX_BOTTOM_COLOR,
                          rec.CF_BOX_LEFT_COLOR,
                          rec.CF_BOX_RIGHT_COLOR,
                          rec.CF_STYLE,
                          rec.CF_DETAILS);
        END IF;
        IF rec.ROWTYPE IN ('COL') THEN
          -- Startposition of next column
          nColStart:=nColStart+rec.WIDTH;
        ELSIF rec.ROWTYPE IN ('COLGROUP') THEN
          nColStart:=nMasterColStart+rec.WIDTH;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_TF_COLUMNS IS
      nMasterColStart NUMBER;
      nDetailColStart NUMBER;
      nInnerheight    NUMBER:=0;
    BEGIN
      nColStart:=nTempColStart;
      FOR rec IN crColumnsTF LOOP
        IF rec.ROWTYPE='COLGROUP' THEN
          nMasterColStart:=nColStart;
          nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                         TYPE_TABLE_FOOTER,
                                         rec.WHEN_EXPRESSION,
                                         NVL(rec.TF_HEIGHT,0),
                                         NVL(rec.TF_HEIGHT,0)
                                        );
          nDetailColStart:=nColStart;
          nColStart:=nMasterColStart;
        ELSIF rec.ROWTYPE ='COL' THEN
          nInnerheight:=0;
        END IF;
        IF rec.ROWTYPE IN ('COL', 'COLGROUP') THEN
          -- table-footer in column
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Table-Footer');
          END IF;
          PR_PROCESS_PART(rReport.rSummaryRegion,
                          rec.WHEN_EXPRESSION,
                          nColStart,
                          rec.Width,
                          nInnerheight,
                          rec.TF_HEIGHT,
                          rec.TF_BOX_TOP,
                          rec.TF_BOX_BOTTOM,
                          rec.TF_BOX_LEFT,
                          rec.TF_BOX_RIGHT,
                          rec.TF_BOX_TOP_COLOR,
                          rec.TF_BOX_BOTTOM_COLOR,
                          rec.TF_BOX_LEFT_COLOR,
                          rec.TF_BOX_RIGHT_COLOR,
                          rec.TF_STYLE,
                          rec.TF_DETAILS);
        END IF;
        IF rec.ROWTYPE IN ('COL') THEN
          -- Startposition of next column
          nColStart:=nColStart+rec.WIDTH;
        ELSIF rec.ROWTYPE IN ('COLGROUP') THEN
          nColStart:=nMasterColStart+rec.WIDTH;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_GH_COLUMNS IS
      nInnerheight NUMBER;
    BEGIN
      FOR rec IN crColumnsGH LOOP
        IF rec.ROWTYPE IN ('COL') THEN
          FOR rec2 IN crColumnsGroup(rec.COL_GH) LOOP
            IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
              nColStartForGroup(rec2.NAME):=nTempColStart;
            END IF;
            -- detail in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-Headers for group ' || rec2.NAME);
            END IF;
            iMatchGroup:=NULL;
            FOR i IN 1..rReport.lGroups.COUNT LOOP
              IF rReport.lGroups(i).vcName=rec2.NAME THEN
                iMatchGroup:=i;
                EXIT;
              END IF;
            END LOOP;
            IF iMatchGroup IS NOT NULL THEN
              -- find the matching region
              PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupHeader,
                              rec.WHEN_EXPRESSION,
                              nColStartForGroup(rec2.NAME),
                              rec.WIDTH,
                              0,
                              rec2.HEIGHT,
                              rec2.BOX_TOP,
                              rec2.BOX_BOTTOM,
                              rec2.BOX_LEFT,
                              rec2.BOX_RIGHT,
                              rec2.BOX_TOP_COLOR,
                              rec2.BOX_BOTTOM_COLOR,
                              rec2.BOX_LEFT_COLOR,
                              rec2.BOX_RIGHT_COLOR,
                              rec2.STYLE,
                              rec2.DETAILS);
            END IF;
            nColStartForGroup(rec2.NAME):=nColStartForGroup(rec2.NAME)+rec.WIDTH;
          END LOOP;
        ELSIF rec.ROWTYPE='COLGROUP' THEN
          FOR rec2 IN crColumnsGroup(rec.COLGROUP_GH) LOOP
            IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
              nColStartForGroup(rec2.NAME):=nTempColStart;
            END IF;
            -- detail in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-Headers for group ' || rec2.NAME);
            END IF;
            iMatchGroup:=NULL;
            FOR i IN 1..rReport.lGroups.COUNT LOOP
              IF rReport.lGroups(i).vcName=rec2.NAME THEN
                iMatchGroup:=i;
                EXIT;
              END IF;
            END LOOP;
            IF iMatchGroup IS NOT NULL THEN
              -- find the matching region
              PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupHeader,
                              rec.WHEN_EXPRESSION,
                              nColStartForGroup(rec2.NAME),
                              rec.WIDTH,
                              0,
                              rec2.HEIGHT,
                              rec2.BOX_TOP,
                              rec2.BOX_BOTTOM,
                              rec2.BOX_LEFT,
                              rec2.BOX_RIGHT,
                              rec2.BOX_TOP_COLOR,
                              rec2.BOX_BOTTOM_COLOR,
                              rec2.BOX_LEFT_COLOR,
                              rec2.BOX_RIGHT_COLOR,
                              rec2.STYLE,
                              rec2.DETAILS);
            END IF;
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           TYPE_GROUP_HEADER,
                                           rec.WHEN_EXPRESSION,
                                           NVL(rec2.HEIGHT,0),
                                           NVL(rec2.HEIGHT,0),
                                           rec2.NAME
                                          );
          END LOOP;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_PROCESS_GF_COLUMNS IS
      nMasterColStart NUMBER;
      nDetailColStart NUMBER;
      nInnerheight    NUMBER:=0;
    BEGIN
      nColStartForGroup.DELETE;
      FOR rec IN crColumnsGF LOOP
        IF rec.ROWTYPE IN ('COL') THEN
          FOR rec2 IN crColumnsGroup(rec.COL_GF) LOOP
            nInnerheight:=0;
            IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
              nColStartForGroup(rec2.NAME):=nTempColStart;
            END IF;
            -- detail in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-footers for group ' || rec2.NAME);
            END IF;
            iMatchGroup:=NULL;
            FOR i IN 1..rReport.lGroups.COUNT LOOP
              IF rReport.lGroups(i).vcName=rec2.NAME THEN
                iMatchGroup:=i;
                EXIT;
              END IF;
            END LOOP;
            IF iMatchGroup IS NOT NULL THEN
              -- find the matching region
              PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupFooter,
                              rec.WHEN_EXPRESSION,
                              nColStartForGroup(rec2.NAME),
                              rec.WIDTH,
                              nInnerheight,
                              rec2.HEIGHT,
                              rec2.BOX_TOP,
                              rec2.BOX_BOTTOM,
                              rec2.BOX_LEFT,
                              rec2.BOX_RIGHT,
                              rec2.BOX_TOP_COLOR,
                              rec2.BOX_BOTTOM_COLOR,
                              rec2.BOX_LEFT_COLOR,
                              rec2.BOX_RIGHT_COLOR,
                              rec2.STYLE,
                              rec2.DETAILS);
            END IF;
            nColStartForGroup(rec2.NAME):=nColStartForGroup(rec2.NAME)+rec.WIDTH;
          END LOOP;
        ELSIF rec.ROWTYPE='COLGROUP' THEN
          FOR rec2 IN crColumnsGroup(rec.COLGROUP_GF) LOOP
            IF NOT nColStartForGroup.EXISTS(rec2.NAME) THEN
              nColStartForGroup(rec2.NAME):=nTempColStart;
            END IF;
            nMasterColStart:=nColStartForGroup(rec2.NAME);
            nInnerheight:=FK_PROCESS_GROUP(rec.COLGROUP,
                                           TYPE_GROUP_FOOTER,
                                           rec.WHEN_EXPRESSION,
                                           NVL(rec2.HEIGHT,0),
                                           NVL(rec2.HEIGHT,0),
                                           rec2.NAME
                                          );
            nDetailColStart:=nColStartForGroup(rec2.NAME);
            nColStartForGroup(rec2.NAME):=nMasterColStart;
            -- detail in column
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group-footers for group ' || rec2.NAME);
            END IF;
            iMatchGroup:=NULL;
            FOR i IN 1..rReport.lGroups.COUNT LOOP
              IF rReport.lGroups(i).vcName=rec2.NAME THEN
                iMatchGroup:=i;
                EXIT;
              END IF;
            END LOOP;
            IF iMatchGroup IS NOT NULL THEN
              -- find the matching region
              PR_PROCESS_PART(rReport.lGroups(iMatchGroup).rGroupFooter,
                              rec.WHEN_EXPRESSION,
                              nColStartForGroup(rec2.NAME),
                              rec.WIDTH,
                              nInnerheight,
                              rec2.HEIGHT,
                              rec2.BOX_TOP,
                              rec2.BOX_BOTTOM,
                              rec2.BOX_LEFT,
                              rec2.BOX_RIGHT,
                              rec2.BOX_TOP_COLOR,
                              rec2.BOX_BOTTOM_COLOR,
                              rec2.BOX_LEFT_COLOR,
                              rec2.BOX_RIGHT_COLOR,
                              rec2.STYLE,
                              rec2.DETAILS);
            END IF;
            nColStartForGroup(rec2.NAME):=nMasterColStart+rec.WIDTH;
          END LOOP;
        END IF;
      END LOOP;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Load table as subreport' || i_rReport.lStyles.COUNT);
    END IF;
    PR_INITIALIZE_REPORT;
    PR_PROCESS_TH_COLUMNS;
    PR_PROCESS_CH_COLUMNS;
    PR_PROCESS_DC_COLUMNS;
    PR_PROCESS_CF_COLUMNS;
    PR_PROCESS_TF_COLUMNS;
    PR_PROCESS_GH_COLUMNS;
    PR_PROCESS_GF_COLUMNS;
    -- dummy-data
    rReport.nPageWidth          :=nColStart;
    rReport.nPageHeight         :=9999;
    rReport.nLeftMargin         :=0;
    rReport.nRightMargin        :=0;
    rReport.nTopMargin          :=0;
    rReport.nBottomMargin       :=0;
    rReport.vcFloatColumnFooter :=PK_JRXML2PDF_TYPES.YES;
    rReport.nTyp                :=PK_JRXML2PDF_TYPES.REPORT_TYP_TABLE;
    -- push to cache, used later
    lReportCache(i_vcReportName):=rReport;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LOAD_BAND(io_rReport              IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                        i_oBand                 IN      XMLTYPE,
                        i_vcTyp                 IN      PK_JRXML2PDF_TYPES.tAttribute,
                        i_nHeight               IN      NUMBER,
                        i_vcPrintWhenExpression IN      PK_JRXML2PDF_TYPES.tExpression,
                        i_vcSplitType           IN      PK_JRXML2PDF_TYPES.tSplitType)
  RETURN PK_JRXML2PDF_TYPES.tBand IS
    CURSOR crSubFrames IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             BGCOLOR,
             FGCOLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             XMLELEMENT("element", FRAME) FRAME,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             END OPAQUE,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE
        FROM XMLTABLE('/element/frame' PASSING i_oBand
                                       COLUMNS X                NUMBER         PATH './reportElement/@x',
                                               Y                NUMBER         PATH './reportElement/@y',
                                               WIDTH            NUMBER         PATH './reportElement/@width',
                                               HEIGHT           NUMBER         PATH './reportElement/@height',
                                               BGCOLOR          VARCHAR2(20)   PATH './reportElement/@backcolor',
                                               FGCOLOR          VARCHAR2(20)   PATH './reportElement/@forecolor',
                                               STYLE            VARCHAR2(255)  PATH './reportElement/@style',
                                               MODUS            VARCHAR2(20)   PATH './reportElement/@mode',
                                               WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                               POSITION_TYPE    VARCHAR2(20)   PATH './reportElement/@positionType',
                                               BOX_TOP          VARCHAR2(20)   PATH './box/topPen/@lineWidth',
                                               BOX_BOTTOM       VARCHAR2(20)   PATH './box/bottomPen/@lineWidth',
                                               BOX_LEFT         VARCHAR2(20)   PATH './box/leftPen/@lineWidth',
                                               BOX_RIGHT        VARCHAR2(20)   PATH './box/rightPen/@lineWidth',
                                               BOX_TOP_COLOR    VARCHAR2(20)   PATH './box/topPen/@lineColor',
                                               BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './box/bottomPen/@lineColor',
                                               BOX_LEFT_COLOR   VARCHAR2(20)   PATH './box/leftPen/@lineColor',
                                               BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './box/rightPen/@lineColor',
                                               BOX_LINEWIDTH    VARCHAR2(10)   PATH './box/pen/@lineWidth',
                                               BOX_COLOR        VARCHAR2(20)   PATH './box/pen/@lineColor',
                                               FRAME            XMLTYPE        PATH  './*'
                     );
    CURSOR crLines IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(FGCOLOR2, FGCOLOR) FGCOLOR,
             LINEWIDTH,
             CASE WHEN     STRETCH_TYPE='RelativeToBandHeight'
                       AND WIDTH='1' THEN
               'Y'
             ELSE
               'N'
             END STRETCH,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE
        FROM XMLTABLE('/element/line' PASSING i_oBand
                                      COLUMNS X               NUMBER         PATH './reportElement/@x',
                                              Y               NUMBER         PATH './reportElement/@y',
                                              WIDTH           NUMBER         PATH './reportElement/@width',
                                              HEIGHT          NUMBER         PATH './reportElement/@height',
                                              FGCOLOR         VARCHAR2(20)   PATH './reportElement/@forecolor',
                                              STYLE           VARCHAR2(255)  PATH './reportElement/@style',
                                              WHEN_EXPRESSION VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                              POSITION_TYPE  VARCHAR2(20)   PATH './reportElement/@positionType',
                                              LINEWIDTH       VARCHAR2(20)   PATH './graphicElement/pen/@lineWidth',
                                              FGCOLOR2        VARCHAR2(20)   PATH './graphicElement/pen/@lineColor',
                                              STRETCH_TYPE    VARCHAR2(255)  PATH './reportElement/@stretchType'
                     );
    CURSOR crRectangles IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(FGCOLOR2, FGCOLOR) FGCOLOR,
             BGCOLOR,
             LINEWIDTH,
             CASE WHEN STRETCH_TYPE='RelativeToBandHeight' THEN
               'Y'
             ELSE
               'N'
             END STRETCH,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE
        FROM XMLTABLE('/element/rectangle' PASSING i_oBand
                                           COLUMNS X               NUMBER         PATH './reportElement/@x',
                                                   Y               NUMBER         PATH './reportElement/@y',
                                                   WIDTH           NUMBER         PATH './reportElement/@width',
                                                   HEIGHT          NUMBER         PATH './reportElement/@height',
                                                   STYLE           VARCHAR2(255)  PATH './reportElement/@style',
                                                   MODUS           VARCHAR2(20)   PATH './reportElement/@mode',
                                                   FGCOLOR         VARCHAR2(20)   PATH './reportElement/@forecolor',
                                                   BGCOLOR         VARCHAR2(20)   PATH './reportElement/@backcolor',
                                                   WHEN_EXPRESSION VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                   POSITION_TYPE  VARCHAR2(20)   PATH './reportElement/@positionType',
                                                   LINEWIDTH       VARCHAR2(20)   PATH './graphicElement/pen/@lineWidth',
                                                   FGCOLOR2        VARCHAR2(20)   PATH './graphicElement/pen/@lineColor',
                                                   STRETCH_TYPE    VARCHAR2(255)  PATH './reportElement/@stretchType'
                     );
    CURSOR crStaticText IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             BGCOLOR,
             FGCOLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             TOP_PADDING,
             BOTTOM_PADDING,
             LEFT_PADDING,
             RIGHT_PADDING,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             FONT,
             FONT_SIZE,
             ALIGNMENT,
             VERTICAL_ALIGN,
             TEXT,
             CASE WHEN STRETCH_TYPE='RelativeToBandHeight' THEN
               'Y'
             ELSE
               'N'
             END STRETCH,
             STYLE,
             CASE WHEN FONT_BOLD='true' THEN
               'Y'
             WHEN FONT_BOLD='false' THEN
               'N'
             END FONT_BOLD,
             CASE WHEN FONT_ITALIC='true' THEN
               'Y'
             WHEN FONT_ITALIC='false' THEN
               'N'
             END FONT_ITALIC,
             WHEN_EXPRESSION,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             ROTATION
        FROM XMLTABLE('/element/staticText'  PASSING i_oBand
                                            COLUMNS X                NUMBER         PATH './reportElement/@x',
                                                    Y                NUMBER         PATH './reportElement/@y',
                                                    WIDTH            NUMBER         PATH './reportElement/@width',
                                                    HEIGHT           NUMBER         PATH './reportElement/@height',
                                                    BGCOLOR          VARCHAR2(20)   PATH './reportElement/@backcolor',
                                                    FGCOLOR          VARCHAR2(20)   PATH './reportElement/@forecolor',
                                                    STYLE            VARCHAR2(255)  PATH './reportElement/@style',
                                                    MODUS            VARCHAR2(20)   PATH './reportElement/@mode',
                                                    WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                    POSITION_TYPE    VARCHAR2(20)   PATH './reportElement/@positionType',
                                                    BOX_TOP          VARCHAR2(20)   PATH './box/topPen/@lineWidth',
                                                    BOX_BOTTOM       VARCHAR2(20)   PATH './box/bottomPen/@lineWidth',
                                                    BOX_LEFT         VARCHAR2(20)   PATH './box/leftPen/@lineWidth',
                                                    BOX_RIGHT        VARCHAR2(20)   PATH './box/rightPen/@lineWidth',
                                                    TOP_PADDING      VARCHAR2(20)   PATH './box/@topPadding',
                                                    BOTTOM_PADDING   VARCHAR2(20)   PATH './box/@bottomPadding',
                                                    LEFT_PADDING     VARCHAR2(20)   PATH './box/@leftPadding',
                                                    RIGHT_PADDING    VARCHAR2(20)   PATH './box/@rightPadding',
                                                    BOX_TOP_COLOR    VARCHAR2(20)   PATH './box/topPen/@lineColor',
                                                    BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './box/bottomPen/@lineColor',
                                                    BOX_LEFT_COLOR   VARCHAR2(20)   PATH './box/leftPen/@lineColor',
                                                    BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './box/rightPen/@lineColor',
                                                    BOX_LINEWIDTH    VARCHAR2(10)   PATH './box/pen/@lineWidth',
                                                    BOX_COLOR        VARCHAR2(20)   PATH './box/pen/@lineColor',
                                                    FONT             VARCHAR2(255)  PATH './textElement/font/@fontName',
                                                    FONT_SIZE        VARCHAR2(255)  PATH './textElement/font/@size',
                                                    FONT_BOLD        VARCHAR2(5)    PATH './textElement/font/@isBold',
                                                    FONT_ITALIC      VARCHAR2(5)    PATH './textElement/font/@isItalic',
                                                    ALIGNMENT        VARCHAR2(255)  PATH './textElement/@textAlignment',
                                                    VERTICAL_ALIGN   VARCHAR2(255)  PATH './textElement/@verticalAlignment',
                                                    ROTATION         VARCHAR2(20)   PATH './textElement/@rotation',
                                                    TEXT             VARCHAR2(4000) PATH './text',
                                                    STRETCH_TYPE     VARCHAR2(255)  PATH './reportElement/@stretchType'
                      );
    CURSOR crImages IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             IMAGE,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE
        FROM XMLTABLE('/element/image' PASSING i_oBand
                                       COLUMNS X                NUMBER         PATH './reportElement/@x',
                                               Y                NUMBER         PATH './reportElement/@y',
                                               WIDTH            NUMBER         PATH './reportElement/@width',
                                               HEIGHT           NUMBER         PATH './reportElement/@height',
                                               BGCOLOR          VARCHAR2(20)   PATH './reportElement/@backcolor',
                                               FGCOLOR          VARCHAR2(20)   PATH './reportElement/@forecolor',
                                               STYLE            VARCHAR2(255)  PATH './reportElement/@style',
                                               WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                               POSITION_TYPE    VARCHAR2(20)   PATH './reportElement/@positionType',
                                               BOX_TOP          VARCHAR2(20)   PATH './box/topPen/@lineWidth',
                                               BOX_BOTTOM       VARCHAR2(20)   PATH './box/bottomPen/@lineWidth',
                                               BOX_LEFT         VARCHAR2(20)   PATH './box/leftPen/@lineWidth',
                                               BOX_RIGHT        VARCHAR2(20)   PATH './box/rightPen/@lineWidth',
                                               BOX_TOP_COLOR    VARCHAR2(20)   PATH './box/topPen/@lineColor',
                                               BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './box/bottomPen/@lineColor',
                                               BOX_LEFT_COLOR   VARCHAR2(20)   PATH './box/leftPen/@lineColor',
                                               BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './box/rightPen/@lineColor',
                                               BOX_LINEWIDTH    VARCHAR2(10)   PATH './box/pen/@lineWidth',
                                               BOX_COLOR        VARCHAR2(20)   PATH './box/pen/@lineColor',
                                               IMAGE            VARCHAR2(2000) PATH './imageExpression'
                     );
    CURSOR crTextFields IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             BGCOLOR,
             FGCOLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             TOP_PADDING,
             BOTTOM_PADDING,
             LEFT_PADDING,
             RIGHT_PADDING,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             FONT,
             FONT_SIZE,
             ALIGNMENT,
             VERTICAL_ALIGN,
             EXPRESSION,
             PATTERN,
             PATTERN_EXPRESSION,
             CASE WHEN    STRETCH_OVERFLOW='true'
                       OR STRETCH_TYPE='RelativeToBandHeight' THEN
               'Y'
             ELSE
               'N'
            END STRETCH,
            CASE WHEN REPEATED_VALUES='false' THEN
              'N'
            ELSE
              'Y'
            END REPEATED_VALUES,
            CASE WHEN FONT_BOLD='true' THEN
              'Y'
            WHEN FONT_BOLD='false' THEN
              'N'
            END FONT_BOLD,
            CASE WHEN FONT_ITALIC='true' THEN
              'Y'
            WHEN FONT_ITALIC='false' THEN
              'N'
            END FONT_ITALIC,
            STYLE,
            CASE WHEN     STRETCH_OVERFLOW='true'
                      AND ROTATION IS NULL THEN
              'Y'
            ELSE
              'N'
            END STRETCH_OVERFLOW,
            EVALUATION_TIME,
            EVALUATION_GROUP,
            WHEN_EXPRESSION,
            CASE WHEN LINE_SPACE='Single' THEN
              '1.17'
            WHEN LINE_SPACE='1_1_2' THEN
              '1.52'
            WHEN LINE_SPACE='Double' THEN
              '1.85'
            WHEN LINE_SPACE='Proportional' THEN
              NVL(LINE_SPACE_SIZE, '1.17')
            END LINE_SPACING,
            CASE WHEN MODUS='Opaque' THEN
              'Y'
            WHEN MODUS='Transparent' THEN
              'N'
            END OPAQUE,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             MARKUP,
             KEY,
             ROTATION
        FROM XMLTABLE('/element/textField' PASSING i_oBand
                                           COLUMNS X                NUMBER           PATH './reportElement/@x',
                                                   Y                NUMBER           PATH './reportElement/@y',
                                                   WIDTH            NUMBER           PATH './reportElement/@width',
                                                   HEIGHT           NUMBER           PATH './reportElement/@height',
                                                   BGCOLOR          VARCHAR2(20)     PATH './reportElement/@backcolor',
                                                   FGCOLOR          VARCHAR2(20)     PATH './reportElement/@forecolor',
                                                   STYLE            VARCHAR2(255)    PATH './reportElement/@style',
                                                   MODUS            VARCHAR2(20)     PATH './reportElement/@mode',
                                                   KEY              VARCHAr2(80)     PATH './reportElement/@key',
                                                   WHEN_EXPRESSION  VARCHAR2(4000)   PATH './reportElement/printWhenExpression',
                                                   POSITION_TYPE    VARCHAR2(20)     PATH './reportElement/@positionType',
                                                   BOX_TOP          VARCHAR2(20)     PATH './box/topPen/@lineWidth',
                                                   BOX_BOTTOM       VARCHAR2(20)     PATH './box/bottomPen/@lineWidth',
                                                   BOX_LEFT         VARCHAR2(20)     PATH './box/leftPen/@lineWidth',
                                                   BOX_RIGHT        VARCHAR2(20)     PATH './box/rightPen/@lineWidth',
                                                   TOP_PADDING      VARCHAR2(20)     PATH './box/@topPadding',
                                                   BOTTOM_PADDING   VARCHAR2(20)     PATH './box/@bottomPadding',
                                                   LEFT_PADDING     VARCHAR2(20)     PATH './box/@leftPadding',
                                                   RIGHT_PADDING    VARCHAR2(20)     PATH './box/@rightPadding',
                                                   BOX_TOP_COLOR    VARCHAR2(20)     PATH './box/topPen/@lineColor',
                                                   BOX_BOTTOM_COLOR VARCHAR2(20)     PATH './box/bottomPen/@lineColor',
                                                   BOX_LEFT_COLOR   VARCHAR2(20)     PATH './box/leftPen/@lineColor',
                                                   BOX_RIGHT_COLOR  VARCHAR2(20)     PATH './box/rightPen/@lineColor',
                                                   BOX_LINEWIDTH    VARCHAR2(10)     PATH './box/pen/@lineWidth',
                                                   BOX_COLOR        VARCHAR2(20)     PATH './box/pen/@lineColor',
                                                   FONT             VARCHAR2(255)    PATH './textElement/font/@fontName',
                                                   FONT_SIZE        VARCHAR2(255)    PATH './textElement/font/@size',
                                                   FONT_BOLD        VARCHAR2(5)      PATH './textElement/font/@isBold',
                                                   FONT_ITALIC      VARCHAR2(5)      PATH './textElement/font/@isItalic',
                                                   ALIGNMENT        VARCHAR2(255)    PATH './textElement/@textAlignment',
                                                   VERTICAL_ALIGN   VARCHAR2(255)    PATH './textElement/@verticalAlignment',
                                                   MARKUP           VARCHAR2(20)     PATH './textElement/@markup',
                                                   ROTATION         VARCHAR2(20)     PATH './textElement/@rotation',
                                                   LINE_SPACE       VARCHAR2(20)     PATH './textElement/paragraph/@lineSpacing',
                                                   LINE_SPACE_SIZE  VARCHAR2(20)     PATH './textElement/paragraph/@lineSpacingSize',
                                                   EXPRESSION       VARCHAR2(4000)   PATH './textFieldExpression',
                                                   PATTERN_EXPRESSION VARCHAR2(4000) PATH './patternExpression',
                                                   PATTERN          VARCHAR2(2000)   PATH './@pattern',
                                                   STRETCH_TYPE     VARCHAR2(255)    PATH './reportElement/@stretchType',
                                                   STRETCH_OVERFLOW VARCHAR2(5)      PATH './@isStretchWithOverflow',
                                                   EVALUATION_TIME  VARCHAR2(80)     PATH './@evaluationTime',
                                                   EVALUATION_GROUP VARCHAR2(80)     PATH './@evaluationGroup',
                                                   REPEATED_VALUES  VARCHAR2(5)      PATH './reportElement/@isPrintRepeatedValues'
                      );
    CURSOR crSubReports IS
     SELECT X,
            Y,
            WIDTH,
            HEIGHT,
            REPORT_NAME,
            DATA,
            XMLELEMENT("element",RETURNVALS) RETURNVALS
        FROM XMLTABLE('/element/subreport'  PASSING i_oBand
                                            COLUMNS X           NUMBER         PATH './reportElement/@x',
                                                    Y           NUMBER         PATH './reportElement/@y',
                                                    WIDTH       NUMBER         PATH './reportElement/@width',
                                                    HEIGHT      NUMBER         PATH './reportElement/@height',
                                                    REPORT_NAME VARCHAR2(255)  PATH './subreportExpression',
                                                    RETURNVALS  XMLTYPE        PATH './returnValue',
                                                    DATA        XMLTYPE        PATH '.'
                     );
    CURSOR crReturnValues(i_oXml IN XMLTYPE) IS
      SELECT TO_VARIABLE,
             SUBREPORT_VARIABLE,
             CALCULATION
        FROM XMLTABLE('/element/returnValue'   PASSING i_oXml
                                               COLUMNS TO_VARIABLE        VARCHAR2(4000) PATH './@toVariable',
                                                       SUBREPORT_VARIABLE VARCHAR2(4000) PATH './@subreportVariable',
                                                       CALCULATION        VARCHAR2(4000) PATH './@calculation'
                     );

    CURSOR crBreaks IS
     SELECT X,
            Y,
            WIDTH,
            HEIGHT,
            TYPE,
            WHEN_EXPRESSION
        FROM XMLTABLE('/element/break'   PASSING i_oBand
                                         COLUMNS X                NUMBER         PATH './reportElement/@x',
                                                 Y                NUMBER         PATH './reportElement/@y',
                                                 WIDTH            NUMBER         PATH './reportElement/@width',
                                                 HEIGHT           NUMBER         PATH './reportElement/@height',
                                                 WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                 TYPE             VARCHAR2(255)  PATH './@type'
                     );
    CURSOR crTables IS
     SELECT X,
            Y,
            WIDTH,
            HEIGHT,
            WHEN_EXPRESSION,
            STYLE,
            TABLE_ELEMENT,
            DATA,
            SUBDATASET
        FROM XMLTABLE('/element/componentElement'   PASSING i_oBand
                                                    COLUMNS X                NUMBER         PATH './reportElement/@x',
                                                            Y                NUMBER         PATH './reportElement/@y',
                                                            WIDTH            NUMBER         PATH './reportElement/@width',
                                                            HEIGHT           NUMBER         PATH './reportElement/@height',
                                                            WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                            STYLE            VARCHAR2(255)  PATH './reportElement/@style',
                                                            TABLE_ELEMENT    XMLTYPE        PATH './table',
                                                            DATA             XMLTYPE        PATH './table/datasetRun',
                                                            SUBDATASET       VARCHAR2(255)  PATH './table/datasetRun/@subDataset'
                     );
    CURSOR crCrosstabs IS
     SELECT X,
            Y,
            WIDTH,
            HEIGHT,
            WHEN_EXPRESSION,
            CASE WHEN REPEAT_ROWHDR='false' THEN
              'N'
            ELSE
              'Y'
            END REPEAT_ROWHDR,
            CASE WHEN REPEAT_COLHDR='false' THEN
              'N'
            ELSE
              'Y'
            END REPEAT_COLHDR,
            NVL(COLBREAKOFFSET, '10') COLBREAKOFFSET,
            STYLE,
            CROSSTAB_ELEMENT,
            DATA,
            SUBDATASET
        FROM XMLTABLE('/element/crosstab'   PASSING i_oBand
                                                    COLUMNS X                NUMBER         PATH './reportElement/@x',
                                                            Y                NUMBER         PATH './reportElement/@y',
                                                            WIDTH            NUMBER         PATH './reportElement/@width',
                                                            HEIGHT           NUMBER         PATH './reportElement/@height',
                                                            WHEN_EXPRESSION  VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                            STYLE            VARCHAR2(255)  PATH './reportElement/@style',
                                                            REPEAT_ROWHDR    VARCHAR2(20)   PATH './@isRepeatRowHeaders',
                                                            REPEAT_COLHDR    VARCHAR2(20)   PATH './@isRepeatColumnHeaders',
                                                            COLBREAKOFFSET   VARCHAR2(20)   PATH './@columnBreakOffset',
                                                            CROSSTAB_ELEMENT XMLTYPE        PATH '.',
                                                            DATA             XMLTYPE        PATH './crosstabDataset/dataset/datasetRun',
                                                            SUBDATASET       VARCHAR2(255)  PATH './crosstabDataset/dataset/datasetRun/@subDataset'
                     );
    CURSOR crMaps IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             LATITUDE_EXPRESSION,
             LONGITUDE_EXPRESSION,
             ZOOM_EXPRESSION,
             MAP_ELEMENT
        FROM XMLTABLE('/element/componentElement'  PASSING i_oBand
                                                   COLUMNS X                    NUMBER         PATH './reportElement/@x',
                                                           Y                    NUMBER         PATH './reportElement/@y',
                                                           WIDTH                NUMBER         PATH './reportElement/@width',
                                                           HEIGHT               NUMBER         PATH './reportElement/@height',
                                                           BGCOLOR              VARCHAR2(20)   PATH './reportElement/@backcolor',
                                                           FGCOLOR              VARCHAR2(20)   PATH './reportElement/@forecolor',
                                                           STYLE                VARCHAR2(255)  PATH './reportElement/@style',
                                                           WHEN_EXPRESSION      VARCHAR2(4000) PATH './reportElement/printWhenExpression',
                                                           POSITION_TYPE        VARCHAR2(20)   PATH './reportElement/@positionType',
                                                           BOX_TOP              VARCHAR2(20)   PATH './box/topPen/@lineWidth',
                                                           BOX_BOTTOM           VARCHAR2(20)   PATH './box/bottomPen/@lineWidth',
                                                           BOX_LEFT             VARCHAR2(20)   PATH './box/leftPen/@lineWidth',
                                                           BOX_RIGHT            VARCHAR2(20)   PATH './box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR        VARCHAR2(20)   PATH './box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR     VARCHAR2(20)   PATH './box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR       VARCHAR2(20)   PATH './box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR      VARCHAR2(20)   PATH './box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH        VARCHAR2(10)   PATH './box/pen/@lineWidth',
                                                           BOX_COLOR            VARCHAR2(20)   PATH './box/pen/@lineColor',
                                                           MAP_ELEMENT          XMLTYPE        PATH './map',
                                                           LATITUDE_EXPRESSION  VARCHAR2(2000) PATH './map/latitudeExpression',
                                                           LONGITUDE_EXPRESSION VARCHAR2(2000) PATH './map/longitudeExpression',
                                                           ZOOM_EXPRESSION      VARCHAR2(2000) PATH './map/zoomExpression'
                     );
    CURSOR crBarCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/barChart'          PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './barPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './barPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './barPlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './barPlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './barPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './barPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './barPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './barPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './barPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './barPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './barPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './barPlot/plot'
                     );
    CURSOR crBar3DCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/bar3DChart'        PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './bar3DPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './bar3DPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './bar3DPlot/@isShowTickMarks',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './bar3DPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './bar3DPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './bar3DPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './bar3DPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './bar3DPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './bar3DPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './bar3DPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/rangeAxisMaxValueExpression',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './bar3DPlot/plot/@labelRotation',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './bar3DPlot/plot'
                     );
    CURSOR crStackedBarCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/stackedBarChart'   PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './barPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './barPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './barPlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './barPlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './barPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './barPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './barPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './barPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './barPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './barPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './barPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './barPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './barPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './barPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './barPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './barPlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './barPlot/plot'
                     );
    CURSOR crStackedBar3DCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/stackedBar3DChart' PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './bar3DPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './bar3DPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './bar3DPlot/@isShowTickMarks',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './bar3DPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './bar3DPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './bar3DPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './bar3DPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './bar3DPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './bar3DPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './bar3DPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './bar3DPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './bar3DPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './bar3DPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './bar3DPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './bar3DPlot/rangeAxisMaxValueExpression',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './bar3DPlot/plot/@labelRotation',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './bar3DPlot/plot'
                     );
    CURSOR crStackedAreaCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/stackedAreaChart'  PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './areaPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './areaPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './areaPlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './areaPlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './areaPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './areaPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './areaPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './areaPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './areaPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './areaPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './areaPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './areaPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './areaPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './areaPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './areaPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './areaPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './areaPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './areaPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './areaPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './areaPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './areaPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './areaPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './areaPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './areaPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './areaPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './areaPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './areaPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './areaPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './areaPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './areaPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './areaPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './areaPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './areaPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './areaPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './areaPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './areaPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './areaPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './areaPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './areaPlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './areaPlot/plot'
                     );
    CURSOR crBarchartSeries(i_oXml IN XMLTYPE) IS
      SELECT SERIES_EXPRESSION,
             VALUE_EXPRESSION,
             CATEGORY_EXPRESSION
        FROM XMLTABLE('/categoryDataset/categorySeries' PASSING i_oXml
                                                        COLUMNS SERIES_EXPRESSION   VARCHAR2(4000) PATH './seriesExpression',
                                                                VALUE_EXPRESSION    VARCHAR2(4000) PATH './valueExpression',
                                                                CATEGORY_EXPRESSION VARCHAR2(4000) PATH './categoryExpression'
                     );
    CURSOR crChartSeriesColors(i_oXml IN XMLTYPE) IS
      SELECT SERIES_ORDER,
             COLOR
        FROM XMLTABLE('/plot/seriesColor' PASSING i_oXml
                                          COLUMNS SERIES_ORDER   VARCHAR2(20) PATH './@seriesOrder',
                                                  COLOR          VARCHAR2(20) PATH './@color'
                     );
    CURSOR crPieCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             KEY_EXPRESSION,
             VALUE_EXPRESSION,
             LABEL_FORMAT,
             LEGEND_LABEL_FORMAT,
             CUSTOMIZER_CLASS
        FROM XMLTABLE('/element/pieChart'          PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './piePlot/@isShowLabels',
                                                           LABEL_FORMAT                VARCHAR2(2000) PATH './piePlot/@labelFormat',
                                                           LEGEND_LABEL_FORMAT         VARCHAR2(2000) PATH './piePlot/@legendLabelFormat',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './piePlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './piePlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './piePlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './piePlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './piePlot/itemLabel/font/@isItalic',
                                                           DATA                        XMLTYPE        PATH './pieDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './pieDataset/dataset/datasetRun/@subDataset',
                                                           KEY_EXPRESSION              VARCHAR2(2000) PATH './pieDataset/keyExpression',
                                                           VALUE_EXPRESSION            VARCHAR2(2000) PATH './pieDataset/valueExpression',
                                                           SERIESCOLORS                XMLTYPE        PATH './piePlot/plot'
                     );
    CURSOR crCategoryLineCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_LINES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LINES,
             CASE WHEN SHOW_SHAPES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_SHAPES,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/lineChart'         PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LINES                  VARCHAR2(5)    PATH './linePlot/@isShowLines',
                                                           SHOW_SHAPES                 VARCHAR2(5)    PATH './linePlot/@isShowShapes',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './linePlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './linePlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './linePlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './linePlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './linePlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './linePlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './linePlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './linePlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './linePlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './linePlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './linePlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './categoryDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './categoryDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './categoryDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './linePlot/plot'
                     );
    CURSOR crXYLineCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_LINES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LINES,
             CASE WHEN SHOW_SHAPES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_SHAPES,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/xyLineChart'       PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LINES                  VARCHAR2(5)    PATH './linePlot/@isShowLines',
                                                           SHOW_SHAPES                 VARCHAR2(5)    PATH './linePlot/@isShowShapes',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './linePlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './linePlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './linePlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './linePlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './linePlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './linePlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './linePlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './linePlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './linePlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './linePlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './linePlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './linePlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './linePlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './linePlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './linePlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './linePlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './xyDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './xyDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './xyDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './linePlot/plot'
                     );
    CURSOR crXYSeries(i_oXml IN XMLTYPE) IS
      SELECT SERIES_EXPRESSION,
             XVALUE_EXPRESSION,
             YVALUE_EXPRESSION
        FROM XMLTABLE('/xyDataset/xySeries' PASSING i_oXml
                                                        COLUMNS SERIES_EXPRESSION   VARCHAR2(4000) PATH './seriesExpression',
                                                                XVALUE_EXPRESSION   VARCHAR2(4000) PATH './xValueExpression',
                                                                YVALUE_EXPRESSION   VARCHAR2(4000) PATH './yValueExpression'
                     );
    CURSOR crTimeseriesLineCharts IS
      SELECT X,
             Y,
             WIDTH,
             HEIGHT,
             NVL(BOX_TOP,    BOX_LINEWIDTH) BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT,   BOX_LINEWIDTH) BOX_LEFT,
             NVL(BOX_RIGHT,  BOX_LINEWIDTH) BOX_RIGHT,
             BGCOLOR,
             FGCOLOR,
             COALESCE(BOX_TOP_COLOR, BOX_COLOR, FGCOLOR)    BOX_TOP_COLOR,
             COALESCE(BOX_BOTTOM_COLOR, BOX_COLOR, FGCOLOR) BOX_BOTTOM_COLOR,
             COALESCE(BOX_LEFT_COLOR, BOX_COLOR, FGCOLOR)   BOX_LEFT_COLOR,
             COALESCE(BOX_RIGHT_COLOR, BOX_COLOR, FGCOLOR)  BOX_RIGHT_COLOR,
             BOX_TOP_PADDING,
             BOX_BOTTOM_PADDING,
             BOX_LEFT_PADDING,
             BOX_RIGHT_PADDING,
             STYLE,
             WHEN_EXPRESSION,
             CASE WHEN POSITION_TYPE='Float' THEN
               'FixRelativeToTop'
             ELSE
               POSITION_TYPE
             END POSITION_TYPE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE,
             CASE WHEN SHOW_LEGEND='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LEGEND,
             TITLE_POSITION,
             TITLE_EXPRESSION,
             TITLE_FONT,
             TITLE_FONT_SIZE,
             CASE WHEN TITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_BOLD,
             CASE WHEN TITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END TITLE_FONT_ITALIC,
             NVL(TITLE_COLOR, FGCOLOR) TITLE_COLOR,
             SUBTITLE_EXPRESSION,
             SUBTITLE_FONT,
             SUBTITLE_FONT_SIZE,
             CASE WHEN SUBTITLE_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_BOLD,
             CASE WHEN SUBTITLE_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END SUBTITLE_FONT_ITALIC,
             NVL(SUBTITLE_COLOR, FGCOLOR) SUBTITLE_COLOR,
             NVL(LEGEND_FG_COLOR, FGCOLOR) LEGEND_FG_COLOR,
             CASE WHEN MODUS='Opaque' THEN
               NVL(LEGEND_BG_COLOR, BGCOLOR)
             END LEGEND_BG_COLOR,
             LEGEND_POSITION,
             LEGEND_FONT,
             LEGEND_FONT_SIZE,
             CASE WHEN LEGEND_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_BOLD,
             CASE WHEN LEGEND_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LEGEND_FONT_ITALIC,
             DATA,
             SERIES,
             SUBDATASET,
             SERIESCOLORS,
             CASE WHEN SHOW_LABELS='true' THEN
               'Y'
             ELSE
               'N'
             END SHOW_LABELS,
             CASE WHEN SHOW_LINES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_LINES,
             CASE WHEN SHOW_SHAPES='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_SHAPES,
             CASE WHEN SHOW_TICK_LABELS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_LABELS,
             CASE WHEN SHOW_TICK_MARKS='false' THEN
               'N'
             ELSE
               'Y'
             END SHOW_TICK_MARKS,
             CAT_AXIS_EXPRESSION,
             NVL(CAT_AXIS_LABEL_COLOR, FGCOLOR) CAT_AXIS_LABEL_COLOR,
             NVL(CAT_AXIS_TICKLABEL_COLOR, FGCOLOR) CAT_AXIS_TICKLABEL_COLOR,
             CAT_AXIS_TICKLABEL_PATTERN,
             CAT_AXIS_LINE_COLOR,
             CAT_AXIS_LABEL_FONT,
             CAT_AXIS_LABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_LABEL_FONTITAL,
             CAT_AXIS_TICKLABEL_FONT,
             CAT_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN CAT_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END CAT_AXIS_TICKLABEL_FONTITAL,
             VAL_AXIS_EXPRESSION,
             NVL(VAL_AXIS_LABEL_COLOR, FGCOLOR) VAL_AXIS_LABEL_COLOR,
             NVL(VAL_AXIS_TICKLABEL_COLOR, FGCOLOR) VAL_AXIS_TICKLABEL_COLOR,
             VAL_AXIS_TICKLABEL_PATTERN,
             VAL_AXIS_LINE_COLOR,
             VAL_AXIS_LABEL_FONT,
             VAL_AXIS_LABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_LABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_LABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_LABEL_FONTITAL,
             VAL_AXIS_TICKLABEL_FONT,
             VAL_AXIS_TICKLABEL_FONTSIZE,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTBOLD='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTBOLD,
             CASE WHEN VAL_AXIS_TICKLABEL_FONTITAL='true' THEN
               'Y'
             ELSE
               'N'
             END VAL_AXIS_TICKLABEL_FONTITAL,
             NVL(LABEL_COLOR, FGCOLOR) LABEL_COLOR,
             LABEL_FONT,
             LABEL_FONT_SIZE,
             CASE WHEN LABEL_FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_BOLD,
             CASE WHEN LABEL_FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END LABEL_FONT_ITALIC,
             CAT_AXIS_MIN_VAL_EXPRESSION,
             CAT_AXIS_MAX_VAL_EXPRESSION,
             VAL_AXIS_MIN_VAL_EXPRESSION,
             VAL_AXIS_MAX_VAL_EXPRESSION,
             CUSTOMIZER_CLASS,
             LABEL_ROTATION
        FROM XMLTABLE('/element/timeSeriesChart'   PASSING i_oBand
                                                   COLUMNS X                           NUMBER         PATH './chart/reportElement/@x',
                                                           Y                           NUMBER         PATH './chart/reportElement/@y',
                                                           WIDTH                       NUMBER         PATH './chart/reportElement/@width',
                                                           HEIGHT                      NUMBER         PATH './chart/reportElement/@height',
                                                           BGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@backcolor',
                                                           FGCOLOR                     VARCHAR2(20)   PATH './chart/reportElement/@forecolor',
                                                           STYLE                       VARCHAR2(255)  PATH './chart/reportElement/@style',
                                                           MODUS                       VARCHAR2(20)   PATH './chart/reportElement/@mode',
                                                           WHEN_EXPRESSION             VARCHAR2(4000) PATH './chart/reportElement/printWhenExpression',
                                                           POSITION_TYPE               VARCHAR2(20)   PATH './chart/reportElement/@positionType',
                                                           BOX_TOP                     VARCHAR2(20)   PATH './chart/box/topPen/@lineWidth',
                                                           BOX_BOTTOM                  VARCHAR2(20)   PATH './chart/box/bottomPen/@lineWidth',
                                                           BOX_LEFT                    VARCHAR2(20)   PATH './chart/box/leftPen/@lineWidth',
                                                           BOX_RIGHT                   VARCHAR2(20)   PATH './chart/box/rightPen/@lineWidth',
                                                           BOX_TOP_COLOR               VARCHAR2(20)   PATH './chart/box/topPen/@lineColor',
                                                           BOX_BOTTOM_COLOR            VARCHAR2(20)   PATH './chart/box/bottomPen/@lineColor',
                                                           BOX_LEFT_COLOR              VARCHAR2(20)   PATH './chart/box/leftPen/@lineColor',
                                                           BOX_RIGHT_COLOR             VARCHAR2(20)   PATH './chart/box/rightPen/@lineColor',
                                                           BOX_LINEWIDTH               VARCHAR2(10)   PATH './chart/box/pen/@lineWidth',
                                                           BOX_COLOR                   VARCHAR2(20)   PATH './chart/box/pen/@lineColor',
                                                           BOX_TOP_PADDING             VARCHAR2(20)   PATH './chart/box/@topPadding',
                                                           BOX_BOTTOM_PADDING          VARCHAR2(20)   PATH './chart/box/@bottomPadding',
                                                           BOX_LEFT_PADDING            VARCHAR2(20)   PATH './chart/box/@leftPadding',
                                                           BOX_RIGHT_PADDING           VARCHAR2(20)   PATH './chart/box/@rightPadding',
                                                           SHOW_LEGEND                 VARCHAR2(20)   PATH './chart/@isShowLegend',
                                                           CUSTOMIZER_CLASS            VARCHAR2(4000) PATH './chart/@customizerClass',
                                                           TITLE_POSITION              VARCHAR2(20)   PATH './chart/chartTitle/@position',
                                                           TITLE_EXPRESSION            VARCHAR2(4000) PATH './chart/chartTitle/titleExpression',
                                                           TITLE_FONT                  VARCHAR2(255)  PATH './chart/chartTitle/font/@fontName',
                                                           TITLE_FONT_SIZE             VARCHAR2(255)  PATH './chart/chartTitle/font/@size',
                                                           TITLE_FONT_BOLD             VARCHAR2(5)    PATH './chart/chartTitle/font/@isBold',
                                                           TITLE_FONT_ITALIC           VARCHAR2(5)    PATH './chart/chartTitle/font/@isItalic',
                                                           TITLE_COLOR                 VARCHAR2(20)   PATH './chart/chartTitle/@color',
                                                           SUBTITLE_EXPRESSION         VARCHAR2(4000) PATH './chart/chartSubtitle/subtitleExpression',
                                                           SUBTITLE_FONT               VARCHAR2(255)  PATH './chart/chartSubtitle/font/@fontName',
                                                           SUBTITLE_FONT_SIZE          VARCHAR2(255)  PATH './chart/chartSubtitle/font/@size',
                                                           SUBTITLE_FONT_BOLD          VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isBold',
                                                           SUBTITLE_FONT_ITALIC        VARCHAR2(5)    PATH './chart/chartSubtitle/font/@isItalic',
                                                           SUBTITLE_COLOR              VARCHAR2(20)   PATH './chart/chartSubtitle/@color',
                                                           LEGEND_FG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@textColor',
                                                           LEGEND_BG_COLOR             VARCHAR2(20)   PATH './chart/chartLegend/@backgroundColor',
                                                           LEGEND_POSITION             VARCHAR2(20)   PATH './chart/chartLegend/@position',
                                                           LEGEND_FONT                 VARCHAR2(255)  PATH './chart/chartLegend/font/@fontName',
                                                           LEGEND_FONT_SIZE            VARCHAR2(255)  PATH './chart/chartLegend/font/@size',
                                                           LEGEND_FONT_BOLD            VARCHAR2(5)    PATH './chart/chartLegend/font/@isBold',
                                                           LEGEND_FONT_ITALIC          VARCHAR2(5)    PATH './chart/chartLegend/font/@isItalic',
                                                           SHOW_LINES                  VARCHAR2(5)    PATH './timeSeriesPlot/@isShowLines',
                                                           SHOW_SHAPES                 VARCHAR2(5)    PATH './timeSeriesPlot/@isShowShapes',
                                                           SHOW_LABELS                 VARCHAR2(5)    PATH './timeSeriesPlot/@isShowLabels',
                                                           SHOW_TICK_LABELS            VARCHAR2(5)    PATH './timeSeriesPlot/@isShowTickLabels',
                                                           SHOW_TICK_MARKS             VARCHAR2(5)    PATH './timeSeriesPlot/@isShowTickMarks',
                                                           LABEL_ROTATION              VARCHAR2(20)   PATH './timeSeriesPlot/plot/@labelRotation',
                                                           LABEL_COLOR                 VARCHAR2(255)  PATH './timeSeriesPlot/itemLabel/@color',
                                                           LABEL_FONT                  VARCHAR2(255)  PATH './timeSeriesPlot/itemLabel/font/@fontName',
                                                           LABEL_FONT_SIZE             VARCHAR2(255)  PATH './timeSeriesPlot/itemLabel/font/@size',
                                                           LABEL_FONT_BOLD             VARCHAR2(5)    PATH './timeSeriesPlot/itemLabel/font/@isBold',
                                                           LABEL_FONT_ITALIC           VARCHAR2(5)    PATH './timeSeriesPlot/itemLabel/font/@isItalic',
                                                           CAT_AXIS_EXPRESSION         VARCHAR2(4000) PATH './timeSeriesPlot/categoryAxisLabelExpression',
                                                           CAT_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/@labelColor',
                                                           CAT_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/@tickLabelColor',
                                                           CAT_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/@tickLabelMask',
                                                           CAT_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/@axisLineColor',
                                                           CAT_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           CAT_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/labelFont/font/@size',
                                                           CAT_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           CAT_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           CAT_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           CAT_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           CAT_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           CAT_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './timeSeriesPlot/categoryAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           VAL_AXIS_EXPRESSION         VARCHAR2(4000) PATH './timeSeriesPlot/valueAxisLabelExpression',
                                                           VAL_AXIS_LABEL_COLOR        VARCHAR2(20)   PATH './timeSeriesPlot/valueAxisFormat/axisFormat/@labelColor',
                                                           VAL_AXIS_TICKLABEL_COLOR    VARCHAR2(20)   PATH './timeSeriesPlot/valueAxisFormat/axisFormat/@tickLabelColor',
                                                           VAL_AXIS_TICKLABEL_PATTERN  VARCHAR2(20)   PATH './timeSeriesPlot/valueAxisFormat/axisFormat/@tickLabelMask',
                                                           VAL_AXIS_LINE_COLOR         VARCHAR2(20)   PATH './timeSeriesPlot/valueAxisFormat/axisFormat/@axisLineColor',
                                                           VAL_AXIS_LABEL_FONT         VARCHAR2(255)  PATH './timeSeriesPlot/valueAxisFormat/axisFormat/labelFont/font/@fontName',
                                                           VAL_AXIS_LABEL_FONTSIZE     VARCHAR2(255)  PATH './timeSeriesPlot/valueAxisFormat/axisFormat/labelFont/font/@size',
                                                           VAL_AXIS_LABEL_FONTBOLD     VARCHAR2(5)    PATH './timeSeriesPlot/valueAxisFormat/axisFormat/labelFont/font/@isBold',
                                                           VAL_AXIS_LABEL_FONTITAL     VARCHAR2(5)    PATH './timeSeriesPlot/valueAxisFormat/axisFormat/labelFont/font/@isItalic',
                                                           VAL_AXIS_TICKLABEL_FONT     VARCHAR2(255)  PATH './timeSeriesPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@fontName',
                                                           VAL_AXIS_TICKLABEL_FONTSIZE VARCHAR2(255)  PATH './timeSeriesPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@size',
                                                           VAL_AXIS_TICKLABEL_FONTBOLD VARCHAR2(5)    PATH './timeSeriesPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isBold',
                                                           VAL_AXIS_TICKLABEL_FONTITAL VARCHAR2(5)    PATH './timeSeriesPlot/valueAxisFormat/axisFormat/tickLabelFont/font/@isItalic',
                                                           CAT_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './timeSeriesPlot/domainAxisMinValueExpression',
                                                           CAT_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './timeSeriesPlot/domainAxisMaxValueExpression',
                                                           VAL_AXIS_MIN_VAL_EXPRESSION VARCHAR2(4000) PATH './timeSeriesPlot/rangeAxisMinValueExpression',
                                                           VAL_AXIS_MAX_VAL_EXPRESSION VARCHAR2(4000) PATH './timeSeriesPlot/rangeAxisMaxValueExpression',
                                                           DATA                        XMLTYPE        PATH './timeSeriesDataset/dataset/datasetRun',
                                                           SUBDATASET                  VARCHAR2(255)  PATH './timeSeriesDataset/dataset/datasetRun/@subDataset',
                                                           SERIES                      XMLTYPE        PATH './timeSeriesDataset',
                                                           SERIESCOLORS                XMLTYPE        PATH './timeSeriesPlot/plot'
                     );
    CURSOR crTimeSeries(i_oXml IN XMLTYPE) IS
      SELECT SERIES_EXPRESSION,
             TIME_EXPRESSION,
             VALUE_EXPRESSION
        FROM XMLTABLE('/timeSeriesDataset/timeSeries'   PASSING i_oXml
                                                        COLUMNS SERIES_EXPRESSION   VARCHAR2(4000) PATH './seriesExpression',
                                                                TIME_EXPRESSION     VARCHAR2(4000) PATH './timePeriodExpression',
                                                                VALUE_EXPRESSION    VARCHAR2(4000) PATH './valueExpression'
                     );
    rBand   PK_JRXML2PDF_TYPES.tBand;
    rObject PK_JRXML2PDF_TYPES.tObject;
    iPos    PLS_INTEGER;
    PROCEDURE PR_STORE_TOP_BOTTOM_BOUNDS(i_nY             IN NUMBER,
                                         i_nHeight        IN NUMBER,
                                         i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
    BEGIN
      IF NVL(i_vcPositionType,PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP)!=PK_JRXML2PDF_TYPES.RELATIVE_TO_BOTTOM THEN
        rBand.nMaxPosTop:=GREATEST(NVL(rBand.nMaxPosTop, -99999), i_nY+i_nHeight);
        rBand.bHasTopPos:=TRUE;
      ELSE
        rBand.nMinPosBottom:=LEAST(NVL(rBand.nMinPosBottom, 99999), i_nY);
        rBand.bHasBottomPos:=TRUE;
      END IF;
    END;
    PROCEDURE PR_LOAD_SUBFRAMES IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec  IN crSubFrames LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lBands.COUNT+1;
        -- Mark record as used because of recursion
        io_rReport.lBands(iPos).nX:=NULL;
        io_rReport.lBands(iPos):=FK_LOAD_BAND(io_rReport             =>io_rReport,
                                              i_oBand                =>rec.FRAME,
                                              i_vcTyp                =>'frame',
                                              i_nHeight              =>rec.HEIGHT,
                                              i_vcPrintWhenExpression=>rec.WHEN_EXPRESSION,
                                              i_vcSplitType          =>PK_JRXML2PDF_TYPES.PREVENT
                                             );
        io_rReport.lBands(iPos).nX               :=rec.X;
        io_rReport.lBands(iPos).nY               :=rec.Y;
        io_rReport.lBands(iPos).nWidth           :=rec.WIDTH;
        io_rReport.lBands(iPos).nHeight          :=rec.HEIGHT;
        io_rReport.lBands(iPos).vcBGColor        :=rec.BGCOLOR;
        io_rReport.lBands(iPos).vcFGColor        :=rec.FGCOLOR;
        io_rReport.lBands(iPos).nBoxTop          :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lBands(iPos).nBoxLeft         :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lBands(iPos).nBoxBottom       :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lBands(iPos).nBoxRight        :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lBands(iPos).vcBoxTopColor    :=rec.BOX_TOP_COLOR;
        io_rReport.lBands(iPos).vcBoxLeftColor   :=rec.BOX_LEFT_COLOR;
        io_rReport.lBands(iPos).vcBoxBottomColor :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lBands(iPos).vcBoxRightColor  :=rec.BOX_RIGHT_COLOR;
        io_rReport.lBands(iPos).vcStyle          :=rec.STYLE;
        io_rReport.lBands(iPos).vcPositionType   :=rec.POSITION_TYPE;
        io_rReport.lBands(iPos).vcOpaque         :=rec.OPAQUE;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lBands(iPos).nY,
                                   i_nHeight       =>io_rReport.lBands(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lBands(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.SUBFRAME;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load subframes ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_LINES IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crLines LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lLines.COUNT+1;
        io_rReport.lLines(iPos).nX              :=rec.X;
        io_rReport.lLines(iPos).nY              :=rec.Y;
        io_rReport.lLines(iPos).nWidth          :=rec.WIDTH;
        io_rReport.lLines(iPos).nHeight         :=rec.HEIGHT;
        io_rReport.lLines(iPos).vcLineColor     :=rec.FGCOLOR;
        io_rReport.lLines(iPos).nLineWidth      :=FK_MAKE_NUM(rec.LINEWIDTH);
        io_rReport.lLines(iPos).vcStyle         :=rec.STYLE;
        io_rReport.lLines(iPos).vcStretch       :=rec.STRETCH;
        io_rReport.lLines(iPos).vcWhenExpression:=rec.WHEN_EXPRESSION;
        io_rReport.lLines(iPos).vcPositionType  :=rec.POSITION_TYPE;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lLines(iPos).nY,
                                   i_nHeight       =>io_rReport.lLines(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lLines(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.LINE;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load lines ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_RECTANGLES IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crRectangles LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lRectangles.COUNT+1;
        io_rReport.lRectangles(iPos).nX              :=rec.X;
        io_rReport.lRectangles(iPos).nY              :=rec.Y;
        io_rReport.lRectangles(iPos).nWidth          :=rec.WIDTH;
        io_rReport.lRectangles(iPos).nHeight         :=rec.HEIGHT;
        io_rReport.lRectangles(iPos).vcLineColor     :=rec.FGCOLOR;
        io_rReport.lRectangles(iPos).vcFillColor     :=rec.BGCOLOR;
        io_rReport.lRectangles(iPos).nLineWidth      :=FK_MAKE_NUM(rec.LINEWIDTH);
        io_rReport.lRectangles(iPos).vcStyle         :=rec.STYLE;
        io_rReport.lRectangles(iPos).vcStretch       :=rec.STRETCH;
        io_rReport.lRectangles(iPos).vcWhenExpression:=rec.WHEN_EXPRESSION;
        io_rReport.lRectangles(iPos).vcOpaque        :=rec.OPAQUE;
        io_rReport.lRectangles(iPos).vcPositionType  :=rec.POSITION_TYPE;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lRectangles(iPos).nY,
                                   i_nHeight       =>io_rReport.lRectangles(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lRectangles(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.RECTANGLE;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load rectangles ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_IMAGES IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crImages LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lImages.COUNT+1;
        io_rReport.lImages(iPos).vcImageName     :=rec.IMAGE;
        io_rReport.lImages(iPos).nX              :=rec.X;
        io_rReport.lImages(iPos).nY              :=rec.Y;
        io_rReport.lImages(iPos).nWidth          :=rec.WIDTH;
        io_rReport.lImages(iPos).nHeight         :=rec.HEIGHT;
        io_rReport.lImages(iPos).vcLineColor     :=rec.FGCOLOR;
        io_rReport.lImages(iPos).vcFillColor     :=rec.BGCOLOR;
        io_rReport.lImages(iPos).vcStyle         :=rec.STYLE;
        io_rReport.lImages(iPos).nBoxTop         :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lImages(iPos).nBoxLeft        :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lImages(iPos).nBoxBottom      :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lImages(iPos).nBoxRight       :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lImages(iPos).vcBoxTopColor   :=rec.BOX_TOP_COLOR;
        io_rReport.lImages(iPos).vcBoxLeftColor  :=rec.BOX_LEFT_COLOR;
        io_rReport.lImages(iPos).vcBoxBottomColor:=rec.BOX_BOTTOM_COLOR;
        io_rReport.lImages(iPos).vcBoxRightColor :=rec.BOX_RIGHT_COLOR;
        io_rReport.lImages(iPos).vcWhenExpression:=rec.WHEN_EXPRESSION;
        io_rReport.lImages(iPos).vcPositionType  :=rec.POSITION_TYPE;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lImages(iPos).nY,
                                   i_nHeight       =>io_rReport.lImages(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lImages(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.IMAGE;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load images ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_STATIC_TEXT IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crStaticText LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lTexts.COUNT+1;
        io_rReport.lTexts(iPos).vcText           :=rec.TEXT;
        io_rReport.lTexts(iPos).nX               :=rec.X;
        io_rReport.lTexts(iPos).nY               :=rec.Y;
        io_rReport.lTexts(iPos).nWidth           :=rec.WIDTH;
        io_rReport.lTexts(iPos).nHeight          :=rec.HEIGHT;
        io_rReport.lTexts(iPos).vcBGColor        :=rec.BGCOLOR;
        io_rReport.lTexts(iPos).vcFGColor        :=rec.FGCOLOR;
        io_rReport.lTexts(iPos).vcFont           :=rec.FONT;
        io_rReport.lTexts(iPos).vcFontStyle      :=CASE WHEN     rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                             AND rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                     'BI'
                                                   WHEN rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                     'B'
                                                   WHEN rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                     'I'
                                                   WHEN rec.FONT_BOLD=PK_JRXML2PDF_TYPES.NO THEN
                                                     'N'
                                                   END;
        io_rReport.lTexts(iPos).vcAlignment      :=rec.ALIGNMENT;
        io_rReport.lTexts(iPos).vcVerticalAlign  :=rec.VERTICAL_ALIGN;
        io_rReport.lTexts(iPos).nFontSize        :=FK_MAKE_NUM(rec.FONT_SIZE);
        io_rReport.lTexts(iPos).nBoxTop          :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lTexts(iPos).nBoxLeft         :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lTexts(iPos).nBoxBottom       :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lTexts(iPos).nBoxRight        :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lTexts(iPos).nTopPadding      :=FK_MAKE_NUM(rec.TOP_PADDING);
        io_rReport.lTexts(iPos).nLeftPadding     :=FK_MAKE_NUM(rec.LEFT_PADDING);
        io_rReport.lTexts(iPos).nBottomPadding   :=FK_MAKE_NUM(rec.BOTTOM_PADDING);
        io_rReport.lTexts(iPos).nRightPadding    :=FK_MAKE_NUM(rec.RIGHT_PADDING);
        io_rReport.lTexts(iPos).vcBoxTopColor    :=rec.BOX_TOP_COLOR;
        io_rReport.lTexts(iPos).vcBoxLeftColor   :=rec.BOX_LEFT_COLOR;
        io_rReport.lTexts(iPos).vcBoxBottomColor :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lTexts(iPos).vcBoxRightColor  :=rec.BOX_RIGHT_COLOR;
        io_rReport.lTexts(iPos).vcStretch        :=rec.STRETCH;
        io_rReport.lTexts(iPos).vcStyle          :=rec.STYLE;
        io_rReport.lTexts(iPos).vcWhenExpression :=rec.WHEN_EXPRESSION;
        io_rReport.lTexts(iPos).vcOpaque         :=rec.OPAQUE;
        io_rReport.lTexts(iPos).vcPositionType   :=rec.POSITION_TYPE;
        io_rReport.lTexts(iPos).vcRotation       :=rec.ROTATION;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lTexts(iPos).nY,
                                   i_nHeight       =>io_rReport.lTexts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lTexts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.TEXT;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load static text ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_TEXTFIELDS IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crTextFields LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lFields.COUNT+1;
        io_rReport.lFields(iPos).vcExpression       :=rec.EXPRESSION;
        io_rReport.lFields(iPos).vcPattern          :=rec.PATTERN;
        io_rReport.lFields(iPos).vcPatternExpression:=rec.PATTERN_EXPRESSION;
        io_rReport.lFields(iPos).vcPrintRepeated    :=rec.REPEATED_VALUES;
        io_rReport.lFields(iPos).nX                 :=rec.X;
        io_rReport.lFields(iPos).nY                 :=rec.Y;
        io_rReport.lFields(iPos).nWidth             :=rec.WIDTH;
        io_rReport.lFields(iPos).nHeight            :=rec.HEIGHT;
        io_rReport.lFields(iPos).vcBGColor          :=rec.BGCOLOR;
        io_rReport.lFields(iPos).vcFGColor          :=rec.FGCOLOR;
        io_rReport.lFields(iPos).vcFont             :=rec.FONT;
        io_rReport.lFields(iPos).vcFontStyle        :=CASE WHEN    rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                               AND rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                       'BI'
                                                     WHEN rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                       'B'
                                                     WHEN rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                       'I'
                                                     WHEN rec.FONT_BOLD=PK_JRXML2PDF_TYPES.NO THEN
                                                       'N'
                                                     END;
        io_rReport.lFields(iPos).vcAlignment        :=rec.ALIGNMENT;
        io_rReport.lFields(iPos).vcVerticalAlign    :=rec.VERTICAL_ALIGN;
        io_rReport.lFields(iPos).nFontSize          :=FK_MAKE_NUM(rec.FONT_SIZE);
        io_rReport.lFields(iPos).nBoxTop            :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lFields(iPos).nBoxLeft           :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lFields(iPos).nBoxBottom         :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lFields(iPos).nBoxRight          :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lFields(iPos).nTopPadding        :=FK_MAKE_NUM(rec.TOP_PADDING);
        io_rReport.lFields(iPos).nLeftPadding       :=FK_MAKE_NUM(rec.LEFT_PADDING);
        io_rReport.lFields(iPos).nBottomPadding     :=FK_MAKE_NUM(rec.BOTTOM_PADDING);
        io_rReport.lFields(iPos).nRightPadding      :=FK_MAKE_NUM(rec.RIGHT_PADDING);
        io_rReport.lFields(iPos).vcBoxTopColor      :=rec.BOX_TOP_COLOR;
        io_rReport.lFields(iPos).vcBoxLeftColor     :=rec.BOX_LEFT_COLOR;
        io_rReport.lFields(iPos).vcBoxBottomColor   :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lFields(iPos).vcBoxRightColor    :=rec.BOX_RIGHT_COLOR;
        io_rReport.lFields(iPos).vcStretch          :=rec.STRETCH;
        io_rReport.lFields(iPos).vcStretchOverflow  :=rec.STRETCH_OVERFLOW;
        io_rReport.lFields(iPos).vcStyle            :=rec.STYLE;
        io_rReport.lFields(iPos).vcEvaluationTime   :=rec.EVALUATION_TIME;
        io_rReport.lFields(iPos).vcEvaluationGroup  :=rec.EVALUATION_GROUP;
        io_rReport.lFields(iPos).vcWhenExpression   :=rec.WHEN_EXPRESSION;
        io_rReport.lFields(iPos).nLineSpacing       :=GREATEST(FK_MAKE_NUM(rec.LINE_SPACING), PK_JRXML2PDF_TYPES.MIN_LINE_SPACING);
        io_rReport.lFields(iPos).vcPositionType     :=rec.POSITION_TYPE;
        io_rReport.lFields(iPos).vcMarkup           :=rec.MARKUP;
        io_rReport.lFields(iPos).vcKey              :=rec.KEY;
        io_rReport.lFields(iPos).vcRotation         :=rec.ROTATION;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lFields(iPos).nY,
                                   i_nHeight       =>io_rReport.lFields(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lFields(iPos).vcPositionType
                                  );
        io_rReport.lFields(iPos).vcOpaque         :=rec.OPAQUE;
        rObject.nType:=PK_JRXML2PDF_TYPES.FIELD;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load textfields ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_SUBREPORTS IS
      iCount       PLS_INTEGER:=0;
      rReturnValue PK_JRXML2PDF_TYPES.tSubreportReturnvalue;
    BEGIN
      FOR rec IN crSubReports LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lSubreports.COUNT+1;
        io_rReport.lSubreports(iPos).vcReportname     :=rec.REPORT_NAME;
        io_rReport.lSubreports(iPos).nX               :=rec.X;
        io_rReport.lSubreports(iPos).nY               :=rec.Y;
        io_rReport.lSubreports(iPos).nWidth           :=rec.WIDTH;
        io_rReport.lSubreports(iPos).nHeight          :=rec.HEIGHT;
        io_rReport.lSubreports(iPos).lParamList       :=FK_CREATE_PARAMLIST(rec.DATA);
        FOR recReturnValue IN crReturnValues(rec.RETURNVALS) LOOP
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add returnvalue to subreport to/sub' || recReturnValue.TO_VARIABLE || '/' || recReturnValue.SUBREPORT_VARIABLE);
          END IF;
          rReturnValue.vcToVariable:=recReturnValue.TO_VARIABLE;
          rReturnValue.vcSubreportVariable:=recReturnValue.SUBREPORT_VARIABLE;
          rReturnValue.vcCalculation:=NVL(recreturnValue.CALCULATION, PK_JRXML2PDF_TYPES.CALCULATION_NOTHING);
          io_rReport.lSubreports(iPos).lReturnvalues(io_rReport.lSubreports(iPos).lReturnvalues.COUNT+1):=rReturnValue;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lSubreports(iPos).nY,
                                   i_nHeight       =>io_rReport.lSubreports(iPos).nHeight,
                                   i_vcPositionType=>PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.SUBREPORT;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load subreports ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_BREAKS IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crBreaks LOOP
        IF NVL(rec.TYPE, 'page')='page' THEN
          iCount:=iCount+1;
          iPos:=io_rReport.lBreaks.COUNT+1;
          io_rReport.lBreaks(iPos).vcType          :='page';
          io_rReport.lBreaks(iPos).nX              :=rec.X;
          io_rReport.lBreaks(iPos).nY              :=rec.Y;
          io_rReport.lBreaks(iPos).nWidth          :=rec.WIDTH;
          io_rReport.lBreaks(iPos).nHeight         :=rec.HEIGHT;
          io_rReport.lBreaks(iPos).vcWhenExpression:=rec.WHEN_EXPRESSION;
          rObject.nType:=PK_JRXML2PDF_TYPES.BREAK;
          rObject.nPosition:=iPos;
          rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
          rBand.bHasBreaks:=TRUE;
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load breaks ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_TABLES IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crTables LOOP
        IF rec.TABLE_ELEMENT IS NOT NULL THEN
          iCount:=iCount+1;
          -- Create a new table, tables are processed the same way as subreports, so we "fake"
          -- a subreport for the table, and transform all table-elements to subreport-elementa
          iPos:=io_rReport.lSubreports.COUNT+1;
          -- Name must be unique, take SYSTIMESTAMP
          io_rReport.lSubreports(iPos).vcReportname     :=TO_CHAR(SYSTIMESTAMP);
          io_rReport.lSubreports(iPos).nX               :=rec.X;
          io_rReport.lSubreports(iPos).nY               :=rec.Y;
          io_rReport.lSubreports(iPos).nWidth           :=rec.WIDTH;
          io_rReport.lSubreports(iPos).nHeight          :=rec.HEIGHT;
          io_rReport.lSubreports(iPos).vcStyle          :=rec.STYLE;
          io_rReport.lSubreports(iPos).lParamList       :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
          PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lSubreports(iPos).nY,
                                     i_nHeight       =>io_rReport.lSubreports(iPos).nHeight,
                                     i_vcPositionType=>PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP
                                    );
          rObject.nType:=PK_JRXML2PDF_TYPES.SUBREPORT;
          rObject.nPosition:=iPos;
          rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
          PR_LOAD_TABLE_AS_SUBREPORT(i_rReport      =>io_rReport,
                                     i_vcReportName =>io_rReport.lSubreports(iPos).vcReportname,
                                     i_oTable       =>rec.TABLE_ELEMENT,
                                     i_vcSubdataset =>rec.SUBDATASET
                                    );
          -- report-name is evaluated after loading has finished, so enclose it to be a string
          io_rReport.lSubreports(iPos).vcReportname     :='"' || io_rReport.lSubreports(iPos).vcReportname || '"';
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load tables ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_CROSSTABS IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crCrosstabs LOOP
        IF rec.CROSSTAB_ELEMENT IS NOT NULL THEN
          iCount:=iCount+1;
          -- Create a new table, tables are processed the same way as subreports, so we "fake"
          -- a subreport for the table, and transform all table-elements to subreport-elementa
          iPos:=io_rReport.lCrosstabs.COUNT+1;
          rObject.nType:=PK_JRXML2PDF_TYPES.CROSSTAB;
          rObject.nPosition:=iPos;
          rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
          io_rReport.lCrosstabs(iPos):=FK_LOAD_CROSSTAB(io_rReport    =>io_rReport,
                                                        i_oCrosstab   =>rec.CROSSTAB_ELEMENT,
                                                        i_vcSubdataset=>rec.SUBDATASET,
                                                        i_vcRepeatRowHeaders=>rec.REPEAT_ROWHDR,
                                                        i_vcRepeatColHeaders=>rec.REPEAT_COLHDR,
                                                        i_nColBreakOffset=>FK_MAKE_NUM(rec.COLBREAKOFFSET)
                                                        );
          io_rReport.lCrosstabs(iPos).nX               :=rec.X;
          io_rReport.lCrosstabs(iPos).nY               :=rec.Y;
          io_rReport.lCrosstabs(iPos).nWidth           :=rec.WIDTH;
          io_rReport.lCrosstabs(iPos).nHeight          :=rec.HEIGHT;
          io_rReport.lCrosstabs(iPos).vcStyle          :=rec.STYLE;
          io_rReport.lCrosstabs(iPos).vcWhenExpression :=rec.WHEN_EXPRESSION;
          io_rReport.lCrosstabs(iPos).lParams          :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
          PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lCrosstabs(iPos).nY,
                                     i_nHeight       =>io_rReport.lCrosstabs(iPos).nHeight,
                                     i_vcPositionType=>PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP
                                    );
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load Crosstabs ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_MAPS IS
      iCount PLS_INTEGER:=0;
    BEGIN
      FOR rec IN crMaps LOOP
        IF rec.MAP_ELEMENT IS NOT NULL THEN
          iCount:=iCount+1;
          iPos:=io_rReport.lMaps.COUNT+1;
          io_rReport.lMaps(iPos).nX                    :=rec.X;
          io_rReport.lMaps(iPos).nY                    :=rec.Y;
          io_rReport.lMaps(iPos).nWidth                :=rec.WIDTH;
          io_rReport.lMaps(iPos).nHeight               :=rec.HEIGHT;
          io_rReport.lMaps(iPos).vcLineColor           :=rec.FGCOLOR;
          io_rReport.lMaps(iPos).vcLineColor           :=rec.BGCOLOR;
          io_rReport.lMaps(iPos).vcStyle               :=rec.STYLE;
          io_rReport.lMaps(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
          io_rReport.lMaps(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
          io_rReport.lMaps(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
          io_rReport.lMaps(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
          io_rReport.lMaps(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
          io_rReport.lMaps(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
          io_rReport.lMaps(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
          io_rReport.lMaps(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
          io_rReport.lMaps(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
          io_rReport.lMaps(iPos).vcPositionType        :=rec.POSITION_TYPE;
          io_rReport.lMaps(iPos).vcLongitudeExpression :=rec.LONGITUDE_EXPRESSION;
          io_rReport.lMaps(iPos).vcLatitudeExpression  :=rec.LATITUDE_EXPRESSION;
          io_rReport.lMaps(iPos).vcZoomExpression      :=rec.ZOOM_EXPRESSION;
          PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lMaps(iPos).nY,
                                     i_nHeight       =>io_rReport.lMaps(iPos).nHeight,
                                     i_vcPositionType=>io_rReport.lMaps(iPos).vcPositionType
                                    );
          rObject.nType:=PK_JRXML2PDF_TYPES.MAP;
          rObject.nPosition:=iPos;
          rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load maps ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_BARCHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crBarcharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lBarcharts.COUNT+1;
        io_rReport.lBarcharts(iPos).nX                    :=rec.X;
        io_rReport.lBarcharts(iPos).nY                    :=rec.Y;
        io_rReport.lBarcharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lBarcharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lBarcharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lBarcharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lBarcharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lBarcharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lBarcharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lBarcharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lBarcharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lBarcharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lBarcharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lBarcharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lBarcharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lBarcharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lBarcharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lBarcharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lBarcharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.NO;
        io_rReport.lBarcharts(iPos).vcIsStacked           :=PK_JRXML2PDF_TYPES.NO;
        io_rReport.lBarcharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lBarcharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lBarcharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lBarcharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lBarcharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lBarcharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lBarcharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lBarcharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lBarcharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lBarcharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lBarcharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lBarcharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lBarcharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lBarcharts(iPos).lSeries.COUNT+1;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lBarcharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lBarcharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lBarcharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lBarcharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.BARCHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      FOR rec IN crBar3Dcharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lBarcharts.COUNT+1;
        io_rReport.lBarcharts(iPos).nX                    :=rec.X;
        io_rReport.lBarcharts(iPos).nY                    :=rec.Y;
        io_rReport.lBarcharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lBarcharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lBarcharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lBarcharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lBarcharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lBarcharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lBarcharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lBarcharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lBarcharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lBarcharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lBarcharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lBarcharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lBarcharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lBarcharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lBarcharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lBarcharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lBarcharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.YES;
        io_rReport.lBarcharts(iPos).vcIsStacked           :=PK_JRXML2PDF_TYPES.NO;
        io_rReport.lBarcharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lBarcharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lBarcharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lBarcharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lBarcharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lBarcharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lBarcharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lBarcharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lBarcharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lBarcharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lBarcharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lBarcharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        io_rReport.lBarcharts(iPos).lParams               :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lBarcharts(iPos).lSeries.COUNT+1;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lBarcharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lBarcharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lBarcharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lBarcharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.BARCHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      FOR rec IN crStackedBarcharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lBarcharts.COUNT+1;
        io_rReport.lBarcharts(iPos).nX                    :=rec.X;
        io_rReport.lBarcharts(iPos).nY                    :=rec.Y;
        io_rReport.lBarcharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lBarcharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lBarcharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lBarcharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lBarcharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lBarcharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lBarcharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lBarcharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lBarcharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lBarcharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lBarcharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lBarcharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lBarcharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lBarcharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lBarcharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lBarcharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lBarcharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.NO;
        io_rReport.lBarcharts(iPos).vcIsStacked           :=PK_JRXML2PDF_TYPES.YES;
        io_rReport.lBarcharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lBarcharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lBarcharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lBarcharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lBarcharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lBarcharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lBarcharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lBarcharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lBarcharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lBarcharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lBarcharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lBarcharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lBarcharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lBarcharts(iPos).lSeries.COUNT+1;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lBarcharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lBarcharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lBarcharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lBarcharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.BARCHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      FOR rec IN crStackedBar3Dcharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lBarcharts.COUNT+1;
        io_rReport.lBarcharts(iPos).nX                    :=rec.X;
        io_rReport.lBarcharts(iPos).nY                    :=rec.Y;
        io_rReport.lBarcharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lBarcharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lBarcharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lBarcharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lBarcharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lBarcharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lBarcharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lBarcharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lBarcharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lBarcharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lBarcharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lBarcharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lBarcharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lBarcharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lBarcharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lBarcharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lBarcharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lBarcharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.YES;
        io_rReport.lBarcharts(iPos).vcIsStacked           :=PK_JRXML2PDF_TYPES.YES;
        io_rReport.lBarcharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lBarcharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lBarcharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lBarcharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lBarcharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lBarcharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lBarcharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lBarcharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lBarcharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lBarcharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lBarcharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lBarcharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lBarcharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lBarcharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lBarcharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lBarcharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lBarcharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lBarcharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lBarcharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lBarcharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lBarcharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        io_rReport.lBarcharts(iPos).lParams               :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lBarcharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lBarcharts(iPos).lSeries.COUNT+1;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lBarcharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lBarcharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lBarcharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lBarcharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lBarcharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.BARCHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load barcharts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_PIECHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crPiecharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lPieCharts.COUNT+1;
        io_rReport.lPieCharts(iPos).nX                    :=rec.X;
        io_rReport.lPieCharts(iPos).nY                    :=rec.Y;
        io_rReport.lPieCharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lPieCharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lPieCharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lPieCharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lPieCharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lPieCharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lPieCharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lPieCharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lPieCharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lPieCharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lPieCharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lPieCharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lPieCharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lPieCharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lPiecharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lPiecharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lPiecharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lPiecharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lPieCharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lPieCharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lPieCharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.BOOL_NO;
        io_rReport.lPieCharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lPieCharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lPieCharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lPieCharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lPieCharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lPieCharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lPieCharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lPieCharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lPieCharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lPieCharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lPieCharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lPieCharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lPieCharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lPieCharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lPieCharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lPieCharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                     AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'BI'
                                                            WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                              'B'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                              'I'
                                                            WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                              'N'
                                                            END;
        io_rReport.lPieCharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lPieCharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lPieCharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lPieCharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lPieCharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                            AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'BI'
                                                                   WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'B'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                     'I'
                                                                   WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                     'N'
                                                                   END;
        io_rReport.lPieCharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lPieCharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lPieCharts(iPos).vcLabelFormat                :=rec.LABEL_FORMAT;
        io_rReport.lPieCharts(iPos).vcLegendLabelFormat          :=rec.LEGEND_LABEL_FORMAT;
        io_rReport.lPieCharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lPieCharts(iPos).vcKeyExpression              :=rec.KEY_EXPRESSION;
        io_rReport.lPieCharts(iPos).vcValueExpression            :=rec.VALUE_EXPRESSION;
        io_rReport.lPieCharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lPieCharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lPieCharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lPieCharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lPieCharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lPieCharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lPieCharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.PIECHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load piecharts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_CATEGORY_LINECHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crCategoryLinecharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lCategoryLinecharts.COUNT+1;
        io_rReport.lCategoryLinecharts(iPos).nX                    :=rec.X;
        io_rReport.lCategoryLinecharts(iPos).nY                    :=rec.Y;
        io_rReport.lCategoryLinecharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lCategoryLinecharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lCategoryLinecharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lCategoryLinecharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lCategoryLinecharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lCategoryLinecharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lCategoryLinecharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lCategoryLinecharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lCategoryLinecharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lCategoryLinecharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lCategoryLinecharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lCategoryLinecharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lCategoryLinecharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lCategoryLinecharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lCategoryLinecharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lCategoryLinecharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lCategoryLinecharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.BOOL_NO;
        io_rReport.lCategoryLinecharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lCategoryLinecharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                              AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'BI'
                                                                     WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'B'
                                                                     WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'I'
                                                                     WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                       'N'
                                                                     END;
        io_rReport.lCategoryLinecharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lCategoryLinecharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                              AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'BI'
                                                                     WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'B'
                                                                     WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'I'
                                                                     WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                       'N'
                                                                     END;
        io_rReport.lCategoryLinecharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lCategoryLinecharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lCategoryLinecharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                              AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'BI'
                                                                     WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'B'
                                                                     WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                       'I'
                                                                     WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                       'N'
                                                                     END;
        io_rReport.lCategoryLinecharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lCategoryLinecharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lCategoryLinecharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lCategoryLinecharts(iPos).vcShowLines                  :=rec.SHOW_LINES;
        io_rReport.lCategoryLinecharts(iPos).vcShowShapes                 :=rec.SHOW_SHAPES;
        io_rReport.lCategoryLinecharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lCategoryLinecharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                                     AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'BI'
                                                                            WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'B'
                                                                            WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'I'
                                                                            WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                              'N'
                                                                            END;
        io_rReport.lCategoryLinecharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lCategoryLinecharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lCategoryLinecharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lCategoryLinecharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                     AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'BI'
                                                                            WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'B'
                                                                            WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'I'
                                                                            WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                              'N'
                                                                            END;
        io_rReport.lCategoryLinecharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                     AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'BI'
                                                                            WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'B'
                                                                            WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'I'
                                                                            WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                              'N'
                                                                            END;
        io_rReport.lCategoryLinecharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                     AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'BI'
                                                                            WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'B'
                                                                            WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'I'
                                                                            WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                              'N'
                                                                            END;
        io_rReport.lCategoryLinecharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                     AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'BI'
                                                                            WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'B'
                                                                            WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                              'I'
                                                                            WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                              'N'
                                                                            END;
        io_rReport.lCategoryLinecharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lCategoryLinecharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lCategoryLinecharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lCategoryLinecharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lCategoryLinecharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lCategoryLinecharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lCategoryLinecharts(iPos).lSeries.COUNT+1;
          io_rReport.lCategoryLinecharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lCategoryLinecharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lCategoryLinecharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lCategoryLinecharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lCategoryLinecharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lCategoryLinecharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lCategoryLinecharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.CATEGORYLINECHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load category linecharts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_XY_LINECHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crXYLinecharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lXYLineCharts.COUNT+1;
        io_rReport.lXYLineCharts(iPos).nX                    :=rec.X;
        io_rReport.lXYLineCharts(iPos).nY                    :=rec.Y;
        io_rReport.lXYLineCharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lXYLineCharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lXYLineCharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lXYLineCharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lXYLineCharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lXYLineCharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lXYLineCharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lXYLineCharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lXYLineCharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lXYLineCharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lXYLineCharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lXYLineCharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lXYLineCharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lXYLineCharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lXYLineCharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lXYLineCharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lXYLineCharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lXYLineCharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lXYLineCharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lXYLineCharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.BOOL_NO;
        io_rReport.lXYLineCharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lXYLineCharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lXYLineCharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lXYLineCharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lXYLineCharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lXYLineCharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lXYLineCharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lXYLineCharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lXYLineCharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lXYLineCharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lXYLineCharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lXYLineCharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lXYLineCharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lXYLineCharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lXYLineCharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lXYLineCharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lXYLineCharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lXYLineCharts(iPos).vcShowLines                  :=rec.SHOW_LINES;
        io_rReport.lXYLineCharts(iPos).vcShowShapes                 :=rec.SHOW_SHAPES;
        io_rReport.lXYLineCharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lXYLineCharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lXYLineCharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lXYLineCharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lXYLineCharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lXYLineCharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lXYLineCharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lXYLineCharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lXYLineCharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lXYLineCharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lXYLineCharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lXYLineCharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lXYLineCharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lXYLineCharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lXYLineCharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lXYLineCharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lXYLineCharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lXYLineCharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lXYLineCharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lXYLineCharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lXYLineCharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lXYLineCharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lXYLineCharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lXYLineCharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lXYLineCharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lXYLineCharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lXYLineCharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lXYLineCharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lXYLineCharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lXYLineCharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lXYLineCharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lXYLineCharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crXYSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lXYLineCharts(iPos).lSeries.COUNT+1;
          io_rReport.lXYLineCharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lXYLineCharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.YVALUE_EXPRESSION;
          io_rReport.lXYLineCharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.XVALUE_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lXYLineCharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lXYLineCharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lXYLineCharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lXYLineCharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.XYLINECHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load category linecharts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_TIME_LINECHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crTimeseriesLinecharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lTimeLineCharts.COUNT+1;
        io_rReport.lTimeLineCharts(iPos).nX                    :=rec.X;
        io_rReport.lTimeLineCharts(iPos).nY                    :=rec.Y;
        io_rReport.lTimeLineCharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lTimeLineCharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lTimeLineCharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lTimeLineCharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lTimeLineCharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lTimeLineCharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lTimeLineCharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lTimeLineCharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lTimeLineCharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lTimeLineCharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lTimeLineCharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lTimeLineCharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lTimeLineCharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lTimeLineCharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lTimeLineCharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lTimeLineCharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lTimeLineCharts(iPos).vcIs3D                :=PK_JRXML2PDF_TYPES.BOOL_NO;
        io_rReport.lTimeLineCharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lTimeLineCharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lTimeLineCharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lTimeLineCharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lTimeLineCharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lTimeLineCharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lTimeLineCharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lTimeLineCharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lTimeLineCharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lTimeLineCharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                        AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'BI'
                                                               WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'B'
                                                               WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                 'I'
                                                               WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                 'N'
                                                               END;
        io_rReport.lTimeLineCharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lTimeLineCharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lTimeLineCharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lTimeLineCharts(iPos).vcShowLines                  :=rec.SHOW_LINES;
        io_rReport.lTimeLineCharts(iPos).vcShowShapes                 :=rec.SHOW_SHAPES;
        io_rReport.lTimeLineCharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lTimeLineCharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lTimeLineCharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lTimeLineCharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lTimeLineCharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lTimeLineCharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lTimeLineCharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lTimeLineCharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lTimeLineCharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lTimeLineCharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lTimeLineCharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lTimeLineCharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                               AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'BI'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'B'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                        'I'
                                                                      WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                        'N'
                                                                      END;
        io_rReport.lTimeLineCharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lTimeLineCharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lTimeLineCharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lTimeLineCharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lTimeLineCharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lTimeLineCharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lTimeLineCharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crTimeSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lTimeLineCharts(iPos).lSeries.COUNT+1;
          io_rReport.lTimeLineCharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lTimeLineCharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lTimeLineCharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.TIME_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lTimeLineCharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lTimeLineCharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lTimeLineCharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lTimeLineCharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.TIMELINECHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load timeseries linecharts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
    PROCEDURE PR_LOAD_STACKED_AREACHARTS IS
      iCount  PLS_INTEGER:=0;
      iSeries PLS_INTEGER;
    BEGIN
      FOR rec IN crStackedAreaCharts LOOP
        iCount:=iCount+1;
        iPos:=io_rReport.lStackedAreaCharts.COUNT+1;
        io_rReport.lStackedAreaCharts(iPos).nX                    :=rec.X;
        io_rReport.lStackedAreaCharts(iPos).nY                    :=rec.Y;
        io_rReport.lStackedAreaCharts(iPos).nWidth                :=rec.WIDTH;
        io_rReport.lStackedAreaCharts(iPos).nHeight               :=rec.HEIGHT;
        io_rReport.lStackedAreaCharts(iPos).vcFillColor           :=rec.BGCOLOR;
        io_rReport.lStackedAreaCharts(iPos).vcLineColor           :=rec.FGCOLOR;
        io_rReport.lStackedAreaCharts(iPos).vcStyle               :=rec.STYLE;
        io_rReport.lStackedAreaCharts(iPos).vcOpaque              :=rec.OPAQUE;
        io_rReport.lStackedAreaCharts(iPos).nBoxTop               :=FK_MAKE_NUM(rec.BOX_TOP);
        io_rReport.lStackedAreaCharts(iPos).nBoxLeft              :=FK_MAKE_NUM(rec.BOX_LEFT);
        io_rReport.lStackedAreaCharts(iPos).nBoxBottom            :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        io_rReport.lStackedAreaCharts(iPos).nBoxRight             :=FK_MAKE_NUM(rec.BOX_RIGHT);
        io_rReport.lStackedAreaCharts(iPos).vcBoxTopColor         :=rec.BOX_TOP_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcBoxLeftColor        :=rec.BOX_LEFT_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcBoxBottomColor      :=rec.BOX_BOTTOM_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcBoxRightColor       :=rec.BOX_RIGHT_COLOR;
        io_rReport.lStackedAreaCharts(iPos).nTopPadding           :=FK_MAKE_NUM(rec.BOX_TOP_PADDING);
        io_rReport.lStackedAreaCharts(iPos).nLeftPadding          :=FK_MAKE_NUM(rec.BOX_LEFT_PADDING);
        io_rReport.lStackedAreaCharts(iPos).nBottomPadding        :=FK_MAKE_NUM(rec.BOX_BOTTOM_PADDING);
        io_rReport.lStackedAreaCharts(iPos).nRightPadding         :=FK_MAKE_NUM(rec.BOX_RIGHT_PADDING);
        io_rReport.lStackedAreaCharts(iPos).vcWhenExpression      :=rec.WHEN_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcPositionType        :=rec.POSITION_TYPE;
        io_rReport.lStackedAreaCharts(iPos).vcTitleExpression     :=rec.TITLE_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcTitleColor          :=rec.TITLE_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcTitlePosition       :=NVL(rec.TITLE_POSITION, PK_JRXML2PDF_CHARTS.POSITION_TOP);
        io_rReport.lStackedAreaCharts(iPos).vcTitleFont           :=rec.TITLE_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcTitleFontStyle      :=CASE WHEN    rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                             AND rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'BI'
                                                                    WHEN rec.TITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'B'
                                                                    WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'I'
                                                                    WHEN rec.TITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                      'N'
                                                                    END;
        io_rReport.lStackedAreaCharts(iPos).nTitleFontSize        :=FK_MAKE_NUM(rec.TITLE_FONT_SIZE);
        io_rReport.lStackedAreaCharts(iPos).vcSubTitleExpression  :=rec.SUBTITLE_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcSubTitleColor       :=rec.SUBTITLE_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcSubTitleFont        :=rec.SUBTITLE_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcSubTitleFontStyle   :=CASE WHEN    rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                             AND rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'BI'
                                                                    WHEN rec.SUBTITLE_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'B'
                                                                    WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'I'
                                                                    WHEN rec.SUBTITLE_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                      'N'
                                                                    END;
        io_rReport.lStackedAreaCharts(iPos).nSubTitleFontSize     :=FK_MAKE_NUM(rec.SUBTITLE_FONT_SIZE);
        io_rReport.lStackedAreaCharts(iPos).vcShowLegend          :=rec.SHOW_LEGEND;
        io_rReport.lStackedAreaCharts(iPos).vcLegendTextColor     :=rec.LEGEND_FG_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcLegendBgColor       :=rec.LEGEND_BG_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcLegendFont          :=rec.LEGEND_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcLegendFontStyle     :=CASE WHEN    rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                             AND rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'BI'
                                                                    WHEN rec.LEGEND_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'B'
                                                                    WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                      'I'
                                                                    WHEN rec.LEGEND_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                      'N'
                                                                    END;
        io_rReport.lStackedAreaCharts(iPos).nLegendFontSize              :=FK_MAKE_NUM(rec.LEGEND_FONT_SIZE);
        io_rReport.lStackedAreaCharts(iPos).vcLegendPosition             :=NVL(rec.LEGEND_POSITION, PK_JRXML2PDF_CHARTS.POSITION_BOTTOM);
        io_rReport.lStackedAreaCharts(iPos).vcShowLabels                 :=rec.SHOW_LABELS;
        io_rReport.lStackedAreaCharts(iPos).vcLabelFont                  :=rec.LABEL_FONT;
        io_rReport.lStackedAreaCharts(iPos).vclabelFontStyle             :=CASE WHEN    rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                                    AND rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'BI'
                                                                           WHEN rec.LABEL_FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'B'
                                                                           WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'I'
                                                                           WHEN rec.LABEL_FONT_ITALIC=PK_JRXML2PDF_TYPES.NO THEN
                                                                             'N'
                                                                           END;
        io_rReport.lStackedAreaCharts(iPos).vcLabelColor                 :=rec.LABEL_COLOR;
        io_rReport.lStackedAreaCharts(iPos).nLabelFontSize               :=FK_MAKE_NUM(rec.LABEL_FONT_SIZE);
        io_rReport.lStackedAreaCharts(iPos).vcShowTickLabels             :=rec.SHOW_TICK_LABELS;
        io_rReport.lStackedAreaCharts(iPos).vcShowTickMarks              :=rec.SHOW_TICK_MARKS;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisLabelExpression     :=rec.CAT_AXIS_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisLabelColor          :=rec.CAT_AXIS_LABEL_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisTickLabelColor      :=rec.CAT_AXIS_TICKLABEL_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisTickLabelFont       :=rec.CAT_AXIS_TICKLABEL_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisTickLabelFontStyle  :=CASE WHEN    rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                    AND rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'BI'
                                                                           WHEN rec.CAT_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'B'
                                                                           WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'I'
                                                                           WHEN rec.CAT_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                             'N'
                                                                           END;
        io_rReport.lStackedAreaCharts(iPos).nCatAxisTickLabelFontSize    :=FK_MAKE_NUM(rec.CAT_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisTickLabelPattern    :=rec.CAT_AXIS_TICKLABEL_PATTERN;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisLineColor           :=rec.CAT_AXIS_LINE_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisLabelFont           :=rec.CAT_AXIS_LABEL_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisLabelFontStyle      :=CASE WHEN    rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                    AND rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'BI'
                                                                           WHEN rec.CAT_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'B'
                                                                           WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'I'
                                                                           WHEN rec.CAT_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                             'N'
                                                                           END;
        io_rReport.lStackedAreaCharts(iPos).nCatAxisLabelFontSize        :=FK_MAKE_NUM(rec.CAT_AXIS_LABEL_FONTSIZE);
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisLabelExpression   :=rec.VAL_AXIS_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisLabelColor        :=rec.VAL_AXIS_LABEL_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisTickLabelColor    :=rec.VAL_AXIS_TICKLABEL_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisTickLabelFont     :=rec.VAL_AXIS_TICKLABEL_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisTickLabelFontStyle:=CASE WHEN    rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                    AND rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'BI'
                                                                           WHEN rec.VAL_AXIS_TICKLABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'B'
                                                                           WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'I'
                                                                           WHEN rec.VAL_AXIS_TICKLABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                             'N'
                                                                           END;
        io_rReport.lStackedAreaCharts(iPos).nAxisTickLabelFontSize       :=FK_MAKE_NUM(rec.VAL_AXIS_TICKLABEL_FONTSIZE);
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisTickLabelPattern  :=rec.VAL_AXIS_TICKLABEL_PATTERN;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisLineColor         :=rec.VAL_AXIS_LINE_COLOR;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisLabelFont         :=rec.VAL_AXIS_LABEL_FONT;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisLabelFontStyle    :=CASE WHEN    rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES
                                                                                    AND rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'BI'
                                                                           WHEN rec.VAL_AXIS_LABEL_FONTBOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'B'
                                                                           WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.YES THEN
                                                                             'I'
                                                                           WHEN rec.VAL_AXIS_LABEL_FONTITAL=PK_JRXML2PDF_TYPES.NO THEN
                                                                             'N'
                                                                           END;
        io_rReport.lStackedAreaCharts(iPos).nValueAxisLabelFontSize      :=FK_MAKE_NUM(rec.VAL_AXIS_LABEL_FONTSIZE);
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisMinValExpression  :=rec.VAL_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcValueAxisMaxValExpression  :=rec.VAL_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisMinValExpression    :=rec.CAT_AXIS_MIN_VAL_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).vcCatAxisMaxValExpression    :=rec.CAT_AXIS_MAX_VAL_EXPRESSION;
        io_rReport.lStackedAreaCharts(iPos).lParams                      :=FK_CREATE_TABLE_PARAMLIST(rec.DATA);
        io_rReport.lStackedAreaCharts(iPos).vcCustomizerClass            :=rec.CUSTOMIZER_CLASS;
        io_rReport.lStackedAreaCharts(iPos).nLabelRotation               :=FK_MAKE_NUM(rec.LABEL_ROTATION);
        -- find subdataset
        IF io_rReport.lDatasets.EXISTS(rec.SUBDATASET) THEN
          io_rReport.lStackedAreaCharts(iPos).vcQuery:=io_rReport.lDatasets(rec.SUBDATASET).vcQuery;
        ELSE
          io_rReport.lStackedAreaCharts(iPos).vcQuery:=io_rReport.vcQuery;
        END IF;
        FOR recSeries IN crBarchartSeries(rec.SERIES) LOOP
          iSeries:=io_rReport.lStackedAreaCharts(iPos).lSeries.COUNT+1;
          io_rReport.lStackedAreaCharts(iPos).lSeries(iSeries).vcSeriesExpression  :=recSeries.SERIES_EXPRESSION;
          io_rReport.lStackedAreaCharts(iPos).lSeries(iSeries).vcValueExpression   :=recSeries.VALUE_EXPRESSION;
          io_rReport.lStackedAreaCharts(iPos).lSeries(iSeries).vcCategoryExpression:=recSeries.CATEGORY_EXPRESSION;
        END LOOP;
        FOR recColor IN crChartSeriesColors(rec.SERIESCOLORS) LOOP
          io_rReport.lStackedAreaCharts(iPos).lSeriesColors(FK_MAKE_NUM(recColor.SERIES_ORDER)+1):=recColor.COLOR;
        END LOOP;
        PR_STORE_TOP_BOTTOM_BOUNDS(i_nY            =>io_rReport.lStackedAreaCharts(iPos).nY,
                                   i_nHeight       =>io_rReport.lStackedAreaCharts(iPos).nHeight,
                                   i_vcPositionType=>io_rReport.lStackedAreaCharts(iPos).vcPositionType
                                  );
        rObject.nType:=PK_JRXML2PDF_TYPES.STACKEDAREACHART;
        rObject.nPosition:=iPos;
        rBand.lObjects(rBand.lObjects.COUNT+1):=rObject;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        IF iCount>0 THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load stacked.area-charts ' || TO_CHAR(iCount));
        END IF;
      END IF;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Load band, type:' || i_vcTyp);
    END IF;
    rBand.vcTyp:=i_vcTyp;
    rBand.bHasBreaks:=FALSE;
    rBand.bHasTopPos:=FALSE;
    rBand.bHasBottomPos:=FALSE;
    rBand.nHeight:=i_nHeight;
    rBand.vcWhenExpression:=i_vcPrintWhenExpression;
    rBand.vcSplitType:=i_vcSplitType;
    PR_LOAD_SUBFRAMES;
    PR_LOAD_LINES;
    PR_LOAD_RECTANGLES;
    PR_LOAD_IMAGES;
    PR_LOAD_STATIC_TEXT;
    PR_LOAD_TEXTFIELDS;
    PR_LOAD_SUBREPORTS;
    PR_LOAD_BREAKS;
    PR_LOAD_TABLES;
    PR_LOAD_CROSSTABS;
    PR_LOAD_MAPS;
    PR_LOAD_BARCHARTS;
    PR_LOAD_PIECHARTS;
    PR_LOAD_CATEGORY_LINECHARTS;
    PR_LOAD_XY_LINECHARTS;
    PR_LOAD_TIME_LINECHARTS;
    PR_LOAD_STACKED_AREACHARTS;

    RETURN rBand;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LOAD_REGION(io_rReport   IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport,
                          i_oRegion    IN      XMLTYPE)
  RETURN PK_JRXML2PDF_TYPES.tRegion IS
    CURSOR crBand IS
      SELECT XMLELEMENT("element", BAND) BAND,
             HEIGHT,
             WHEN_EXPRESSION,
             SPLIT_TYPE
        FROM XMLTABLE('/region/band' PASSING i_oRegion
                                     COLUMNS BAND            XMLTYPE        PATH './*',
                                             HEIGHT          NUMBER         PATH '@height',
                                             SPLIT_TYPE      VARCHAR2(80)   PATH '@splitType',
                                             WHEN_EXPRESSION VARCHAR2(4000) PATH 'printWhenExpression'
                     );
    rRegion PK_JRXML2PDF_TYPES.tRegion;
    rBand   PK_JRXML2PDF_TYPES.tBand;
    rObject PK_JRXML2PDF_TYPES.tObject;
    iPos    PLS_INTEGER;
  BEGIN
    IF i_oRegion IS NOT NULL THEN
      FOR rec IN crBand LOOP
        rBand:=FK_LOAD_BAND(io_rReport              =>io_rReport,
                            i_oBand                 =>rec.BAND,
                            i_vcTyp                 =>'band',
                            i_nHeight               =>rec.HEIGHT,
                            i_vcPrintWhenExpression =>rec.WHEN_EXPRESSION,
                            i_vcSplitType           =>NVL(rec.SPLIT_TYPE, PK_JRXML2PDF_TYPES.STRETCH)
                           );
        iPos:=io_rReport.lBands.COUNT+1;
        io_rReport.lBands(iPos):=rBand;
        rObject.nType:=PK_JRXML2PDF_TYPES.BAND;
        rObject.nPosition:=iPos;
        rRegion.lObjects(rRegion.lObjects.COUNT+1):=rObject;
      END LOOP;
    END IF;
    RETURN rRegion;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LOAD_REPORT (i_vcReportName IN VARCHAR2,
                           i_lParamList   IN PK_JRXML2PDF_TYPES.tParamList)
  RETURN PK_JRXML2PDF_TYPES.tReport IS
    CURSOR crReport IS
      SELECT JRD_ID,
             PAGE_WIDTH,
             PAGE_HEIGHT,
             LEFT_MARGIN,
             RIGHT_MARGIN,
             TOP_MARGIN,
             BOTTOM_MARGIN,
             XMLELEMENT("region", TITLE_XML) TITLE_XML,
             XMLELEMENT("region", PAGEHEADER_XML) PAGEHEADER_XML,
             XMLELEMENT("region", COLUMNHEADER_XML) COLUMNHEADER_XML,
             XMLELEMENT("region", DETAIL_XML) DETAIL_XML,
             XMLELEMENT("region", COLUMNFOOTER_XML) COLUMNFOOTER_XML,
             XMLELEMENT("region", PAGEFOOTER_XML) PAGEFOOTER_XML,
             XMLELEMENT("region", SUMMARY_XML) SUMMARY_XML,
             XMLELEMENT("region", BACKGROUND_XML) BACKGROUND_XML,
             QUERY_STRING,
             CASE WHEN FLOAT_COLUMN_FOOTER='true' THEN
               'Y'
             ELSE
               'N'
             END                                                                FLOAT_COLUMN_FOOTER,
             CASE WHEN TITLE_ON_NEW_PAGE='true' THEN
               'Y'
             ELSE
               'N'
             END                                                                TITLE_ON_NEW_PAGE,
             CASE WHEN SUMMARY_ON_NEW_PAGE='true' THEN
               'Y'
             ELSE
               'N'
             END                                                                SUMMARY_ON_NEW_PAGE,
             CASE WHEN SUMMARY_WITH_HDR_FTR='true' THEN
               'Y'
             ELSE
               'N'
             END                                                                SUMMARY_WITH_HDR_FTR,
             RESOURCE_BUNDLE,
             XML
        FROM (SELECT JRD_ID,
                     XMLTYPE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(JRD_XML,
                                                                                             'xmlns="http://jasperreports.sourceforge.net/jasperreports"',
                                                                                             ''
                                                                                            ),
                                                                                     'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',
                                                                                     ''
                                                                                    ),
                                                                             'xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"',
                                                                             ''
                                                                            ),
                                                                     'xmlns:jr="http://jasperreports.sourceforge.net/jasperreports/components"',
                                                                     ''
                                                                    ),
                                                             'xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports/components http://jasperreports.sourceforge.net/xsd/components.xsd"',
                                                             ''
                                                            ),
                                                     '<jr:',
                                                     '<'
                                                    ),
                                             '</jr:',
                                             '</'
                                            ),
                                     '<mp:',
                                     '<'
                                    ),
                                 '</mp:',
                                 '</'
                                )
                            ) XML
                FROM JRXML_REPORT_DEFINITIONS
               WHERE JRD_NAME =i_vcReportName
             ),
             XMLTABLE('/jasperReport' PASSING XML
                                      COLUMNS PAGE_WIDTH           VARCHAR2(4000) PATH '/jasperReport/@pageWidth',
                                              PAGE_HEIGHT          VARCHAR2(4000) PATH '/jasperReport/@pageHeight',
                                              LEFT_MARGIN          VARCHAR2(4000) PATH '/jasperReport/@leftMargin',
                                              RIGHT_MARGIN         VARCHAR2(4000) PATH '/jasperReport/@rightMargin',
                                              TOP_MARGIN           VARCHAR2(4000) PATH '/jasperReport/@topMargin',
                                              BOTTOM_MARGIN        VARCHAR2(4000) PATH '/jasperReport/@bottomMargin',
                                              TITLE_XML            XMLTYPE        PATH '/jasperReport/title/*',
                                              PAGEHEADER_XML       XMLTYPE        PATH '/jasperReport/pageHeader/*',
                                              COLUMNHEADER_XML     XMLTYPE        PATH  '/jasperReport/columnHeader/*',
                                              DETAIL_XML           XMLTYPE        PATH  '/jasperReport/detail/*',
                                              COLUMNFOOTER_XML     XMLTYPE        PATH  '/jasperReport/columnFooter/*',
                                              PAGEFOOTER_XML       XMLTYPE        PATH  '/jasperReport/pageFooter/*',
                                              SUMMARY_XML          XMLTYPE        PATH  '/jasperReport/summary/*',
                                              BACKGROUND_XML       XMLTYPE        PATH  '/jasperReport/background/*',
                                              QUERY_STRING         CLOB           PATH '/jasperReport/queryString',
                                              FLOAT_COLUMN_FOOTER  VARCHAR2(4000) PATH  '/jasperReport/@isFloatColumnFooter',
                                              TITLE_ON_NEW_PAGE    VARCHAR2(4000) PATH  '/jasperReport/@isTitleNewPage',
                                              SUMMARY_ON_NEW_PAGE  VARCHAR2(4000) PATH  '/jasperReport/@isSummaryNewPage',
                                              SUMMARY_WITH_HDR_FTR VARCHAR2(4000) PATH  '/jasperReport/@isSummaryWithPageHeaderAndFooter',
                                              RESOURCE_BUNDLE      VARCHAR2(4000) PATH '/jasperReport/@resourceBundle'
             );
    CURSOR crStyles(i_oXml IN XMLTYPE) IS
      SELECT BGCOLOR,
             FGCOLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             TOP_PADDING,
             BOTTOM_PADDING,
             LEFT_PADDING,
             RIGHT_PADDING,
             NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
             NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
             NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
             NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
             FONT,
             FONT_SIZE,
             NVL(ALIGNMENT, H_ALIGN) ALIGNMENT,
             NVL(VERTICAL_ALIGN, V_ALIGN) VERTICAL_ALIGN,
             LINE_WIDTH,
             STYLE_NAME,
             CASE WHEN FONT_BOLD='true' THEN
               'Y'
             ELSE
               'N'
             END FONT_BOLD,
             CASE WHEN FONT_ITALIC='true' THEN
               'Y'
             ELSE
               'N'
             END FONT_ITALIC,
             CASE WHEN LINE_SPACE IS NULL THEN
               '1.17'
             WHEN LINE_SPACE='Single' THEN
               '1.17'
             WHEN LINE_SPACE='1_1_2' THEN
               '1.52'
             WHEN LINE_SPACE='Double' THEN
               '1.85'
             WHEN LINE_SPACE='Proportional' THEN
               NVL(LINE_SPACE_SIZE, '1.17')
             ELSE
               '1.17'
             END LINE_SPACING,
             STYLE,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             END OPAQUE
        FROM XMLTABLE('/jasperReport/style' PASSING i_oXml
                                            COLUMNS BGCOLOR          VARCHAR2(20)   PATH './@backcolor',
                                                    FGCOLOR          VARCHAR2(20)   PATH './@forecolor',
                                                    MODUS            VARCHAR2(20)   PATH './@mode',
                                                    BOX_TOP          VARCHAR2(20)   PATH './box/topPen/@lineWidth',
                                                    BOX_BOTTOM       VARCHAR2(20)   PATH './box/bottomPen/@lineWidth',
                                                    BOX_LEFT         VARCHAR2(20)   PATH './box/leftPen/@lineWidth',
                                                    BOX_RIGHT        VARCHAR2(20)   PATH './box/rightPen/@lineWidth',
                                                    BOX_TOP_COLOR    VARCHAR2(20)   PATH './box/topPen/@lineColor',
                                                    BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './box/bottomPen/@lineColor',
                                                    BOX_LEFT_COLOR   VARCHAR2(20)   PATH './box/leftPen/@lineColor',
                                                    BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './box/rightPen/@lineColor',
                                                    TOP_PADDING      VARCHAR2(20)   PATH './box/@topPadding',
                                                    BOTTOM_PADDING   VARCHAR2(20)   PATH './box/@bottomPadding',
                                                    LEFT_PADDING     VARCHAR2(20)   PATH './box/@leftPadding',
                                                    RIGHT_PADDING    VARCHAR2(20)   PATH './box/@rightPadding',
                                                    FONT             VARCHAR2(255)  PATH './@fontName',
                                                    FONT_SIZE        VARCHAR2(255)  PATH './@fontSize',
                                                    LINE_WIDTH       VARCHAR2(10)   PATH './pen/@lineWidth',
                                                    BOX_LINEWIDTH    VARCHAR2(10)   PATH './box/pen/@lineWidth',
                                                    BOX_COLOR        VARCHAR2(20)   PATH './box/pen/@lineColor',
                                                    ALIGNMENT        VARCHAR2(255)  PATH './@textAlignment',
                                                    VERTICAL_ALIGN   VARCHAR2(255)  PATH './@verticalAlignment',
                                                    H_ALIGN          VARCHAR2(255)  PATH './@hAlign',
                                                    V_ALIGN          VARCHAR2(255)  PATH './@vAlign',
                                                    STYLE_NAME       VARCHAR2(255)  PATH './@name',
                                                    FONT_BOLD        VARCHAR2(5)    PATH './@isBold',
                                                    FONT_ITALIC      VARCHAR2(5)    PATH './@isItalic',
                                                    LINE_SPACE       VARCHAR2(20)   PATH './paragraph/@lineSpacing',
                                                    LINE_SPACE_SIZE  VARCHAR2(20)   PATH './paragraph/@lineSpacingSize',
                                                    STYLE            XMLTYPE        PATH '.'
                      );
    CURSOR crConditionalStyle(i_xmlStyle IN XMLTYPE) IS
      SELECT WHEN_EXPRESSION,
             BGCOLOR,
             FGCOLOR,
             NVL(BOX_TOP, BOX_LINEWIDTH)    BOX_TOP,
             NVL(BOX_BOTTOM, BOX_LINEWIDTH) BOX_BOTTOM,
             NVL(BOX_LEFT, BOX_LINEWIDTH)   BOX_LEFT,
             NVL(BOX_RIGHT, BOX_LINEWIDTH)  BOX_RIGHT,
             TOP_PADDING,
             BOTTOM_PADDING,
             LEFT_PADDING,
             RIGHT_PADDING,
             NVL(BOX_TOP_COLOR, BOX_COLOR)    BOX_TOP_COLOR,
             NVL(BOX_BOTTOM_COLOR, BOX_COLOR) BOX_BOTTOM_COLOR,
             NVL(BOX_LEFT_COLOR, BOX_COLOR)   BOX_LEFT_COLOR,
             NVL(BOX_RIGHT_COLOR, BOX_COLOR)  BOX_RIGHT_COLOR,
             FONT,
             FONT_SIZE,
             NVL(ALIGNMENT, H_ALIGN) ALIGNMENT,
             NVL(VERTICAL_ALIGN, V_ALIGN) VERTICAL_ALIGN,
             LINE_WIDTH,
             STYLE_NAME,
             CASE WHEN FONT_BOLD='true' THEN
               'Y'
             WHEN FONT_BOLD='false' THEN
               'N'
             END FONT_BOLD,
             CASE WHEN FONT_ITALIC='true' THEN
               'Y'
             WHEN FONT_ITALIC='false' THEN
               'N'
             END FONT_ITALIC,
             CASE WHEN LINE_SPACE='Single' THEN
               '1.17'
             WHEN LINE_SPACE='1_1_2' THEN
               '1.52'
             WHEN LINE_SPACE='Double' THEN
               '1.85'
             WHEN LINE_SPACE='Proportional' THEN
               NVL(LINE_SPACE_SIZE, '1.17')
             END LINE_SPACING,
             CASE WHEN MODUS='Opaque' THEN
               'Y'
             WHEN MODUS='Transparent' THEN
               'N'
             END OPAQUE
        FROM XMLTABLE('/style/conditionalStyle' PASSING i_xmlStyle
                                            COLUMNS WHEN_EXPRESSION  VARCHAR2(4000) PATH './conditionExpression',
                                                    BGCOLOR          VARCHAR2(20)   PATH './style/@backcolor',
                                                    FGCOLOR          VARCHAR2(20)   PATH './style/@forecolor',
                                                    MODUS            VARCHAR2(20)   PATH './style/@mode',
                                                    BOX_TOP          VARCHAR2(20)   PATH './style/box/topPen/@lineWidth',
                                                    BOX_BOTTOM       VARCHAR2(20)   PATH './style/box/bottomPen/@lineWidth',
                                                    BOX_LEFT         VARCHAR2(20)   PATH './style/box/leftPen/@lineWidth',
                                                    BOX_RIGHT        VARCHAR2(20)   PATH './style/box/rightPen/@lineWidth',
                                                    BOX_TOP_COLOR    VARCHAR2(20)   PATH './style/box/topPen/@lineColor',
                                                    BOX_BOTTOM_COLOR VARCHAR2(20)   PATH './style/box/bottomPen/@lineColor',
                                                    BOX_LEFT_COLOR   VARCHAR2(20)   PATH './style/box/leftPen/@lineColor',
                                                    BOX_RIGHT_COLOR  VARCHAR2(20)   PATH './style/box/rightPen/@lineColor',
                                                    TOP_PADDING      VARCHAR2(20)   PATH './box/@topPadding',
                                                    BOTTOM_PADDING   VARCHAR2(20)   PATH './box/@bottomPadding',
                                                    LEFT_PADDING     VARCHAR2(20)   PATH './box/@leftPadding',
                                                    RIGHT_PADDING    VARCHAR2(20)   PATH './box/@rightPadding',
                                                    FONT             VARCHAR2(255)  PATH './style/@fontName',
                                                    FONT_SIZE        VARCHAR2(255)  PATH './style/@fontSize',
                                                    LINE_WIDTH       VARCHAR2(10)   PATH './style/pen/@lineWidth',
                                                    BOX_LINEWIDTH    VARCHAR2(10)   PATH './style/box/pen/@lineWidth',
                                                    BOX_COLOR        VARCHAR2(20)   PATH './style/box/pen/@lineColor',
                                                    ALIGNMENT        VARCHAR2(255)  PATH './style/@textAlignment',
                                                    VERTICAL_ALIGN   VARCHAR2(255)  PATH './style/@verticalAlignment',
                                                    H_ALIGN          VARCHAR2(255)  PATH './style/@hAlign',
                                                    V_ALIGN          VARCHAR2(255)  PATH './style/@vAlign',
                                                    STYLE_NAME       VARCHAR2(255)  PATH './style/@name',
                                                    FONT_BOLD        VARCHAR2(5)    PATH './style/@isBold',
                                                    FONT_ITALIC      VARCHAR2(5)    PATH './style/@isItalic',
                                                    LINE_SPACE       VARCHAR2(20)   PATH './style/paragraph/@lineSpacing',
                                                    LINE_SPACE_SIZE  VARCHAR2(20)   PATH './style/paragraph/@lineSpacingSize'
                      );
    CURSOR crGroups(i_oXml IN XMLTYPE) IS
      SELECT NAME,
             EXPRESSION,
             XMLELEMENT("region", GROUPHEADER) GROUPHEADER,
             XMLELEMENT("region", GROUPFOOTER) GROUPFOOTER,
             CASE WHEN START_ON_NEW_PAGE='true' THEN
               'Y'
             ELSE
               'N'
             END START_ON_NEW_PAGE,
             CASE WHEN RESET_PAGE_NUMBER='true' THEN
               'Y'
             ELSE
               'N'
             END RESET_PAGE_NUMBER,
             CASE WHEN REPRINT_HEADER='true' THEN
               'Y'
             ELSE
               'N'
             END REPRINT_HEADER,
             MIN_HEIGHT
        FROM XMLTABLE('/jasperReport/group' PASSING i_oXml
                                            COLUMNS NAME              VARCHAR2(255)  PATH './@name',
                                                    EXPRESSION        VARCHAR2(4000) PATH './groupExpression',
                                                    START_ON_NEW_PAGE VARCHAR2(20)   PATH './@isStartNewPage',
                                                    RESET_PAGE_NUMBER VARCHAR2(20)   PATH './@isResetPageNumber',
                                                    REPRINT_HEADER    VARCHAR2(20)   PATH './@isReprintHeaderOnEachPage',
                                                    MIN_HEIGHT        VARCHAR2(20)   PATH './@minHeightToStartNewPage',
                                                    GROUPHEADER       XMLTYPE        PATH './groupHeader/*',
                                                    GROUPFOOTER       XMLTYPE        PATH './groupFooter/*'
                      );
    CURSOR crDatasets(i_oXml IN XMLTYPE) IS
      SELECT NAME,
             QUERY,
             XMLELEMENT("element", GROUPS) GROUPS,
             XMLELEMENT("element", VARIABLES) VARIABLES
        FROM XMLTABLE('/jasperReport/subDataset' PASSING i_oXml
                                                 COLUMNS NAME         VARCHAR2(255)  PATH './@name',
                                                         QUERY        VARCHAR2(4000) PATH './queryString',
                                                         GROUPS       XMLTYPE        PATH './group',
                                                         VARIABLES    XMLTYPE        PATH './variable'
                      );
    CURSOR crDatasetGroups(i_oXml IN XMLTYPE) IS
      SELECT NAME,
             EXPRESSION
        FROM XMLTABLE('/element/group' PASSING i_oXml
                                       COLUMNS NAME        VARCHAR2(255)  PATH './@name',
                                               EXPRESSION  VARCHAR2(4000) PATH './groupExpression'
                      );
    CURSOR crDatasetVariables(i_oXml IN XMLTYPE) IS
      SELECT NAME,
             CLASS_NAME,
             CALCULATION,
             INCREMENT_TYPE,
             INCREMENT_GROUP,
             RESET_TYPE,
             RESET_GROUP,
             EXPRESSION,
             INITIAL_EXPRESSION
        FROM XMLTABLE('/element/variable' PASSING i_oXml
                                          COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                  CLASS_NAME         VARCHAR2(255)  PATH './@class',
                                                  CALCULATION        VARCHAR2(255)  PATH './@calculation',
                                                  INCREMENT_TYPE     VARCHAR2(255)  PATH './@incrementType',
                                                  INCREMENT_GROUP    VARCHAR2(255)  PATH './@incrementGroup',
                                                  RESET_TYPE         VARCHAR2(255)  PATH './@resetType',
                                                  RESET_GROUP        VARCHAR2(255)  PATH './@resetGroup',
                                                  EXPRESSION         VARCHAR2(4000) PATH './variableExpression',
                                                  INITIAL_EXPRESSION VARCHAR2(4000) PATH './initialValueExpression'
                          );
    CURSOR crVariables(i_oXml IN XMLTYPE) IS
      SELECT NAME,
             CLASS_NAME,
             CALCULATION,
             INCREMENT_TYPE,
             INCREMENT_GROUP,
             RESET_TYPE,
             RESET_GROUP,
             EXPRESSION,
             INITIAL_EXPRESSION
        FROM XMLTABLE('/jasperReport/variable' PASSING i_oXml
                                               COLUMNS NAME               VARCHAR2(255)  PATH './@name',
                                                       CLASS_NAME         VARCHAR2(255)  PATH './@class',
                                                       CALCULATION        VARCHAR2(255)  PATH './@calculation',
                                                       INCREMENT_TYPE     VARCHAR2(255)  PATH './@incrementType',
                                                       INCREMENT_GROUP    VARCHAR2(255)  PATH './@incrementGroup',
                                                       RESET_TYPE         VARCHAR2(255)  PATH './@resetType',
                                                       RESET_GROUP        VARCHAR2(255)  PATH './@resetGroup',
                                                       EXPRESSION         VARCHAR2(4000) PATH './variableExpression',
                                                       INITIAL_EXPRESSION VARCHAR2(4000) PATH './initialValueExpression'
                          );
    recReport   crReport%ROWTYPE;
    rReport     PK_JRXML2PDF_TYPES.tReport;
    rStyle      PK_JRXML2PDF_TYPES.tStyle;
    rEmptyStyle PK_JRXML2PDF_TYPES.tStyle;
    rGroup      PK_JRXML2PDF_TYPES.tGroup;
    iPos        PLS_INTEGER;
    PROCEDURE PR_LOAD_STYLES(i_oXml IN XMLTYPE) IS
    BEGIN
      -- Read styles
      FOR rec IN crStyles(i_oXml) LOOP
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load style:' || rec.STYLE_NAME);
        END IF;
        rStyle:=rEmptyStyle;
        rStyle.rStyle.vcFGColor        :=rec.FGCOLOR;
        rStyle.rStyle.vcBGColor        :=rec.BGCOLOR;
        rStyle.rStyle.vcFont           :=rec.FONT;
        rStyle.rStyle.vcFontStyle      :=CASE WHEN     rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                   AND rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                            'BI'
                                          WHEN rec.FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                            'B'
                                          WHEN rec.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                            'I'
                                          ELSE
                                            'N'
                                          END;
        rStyle.rStyle.nFontSize        :=rec.FONT_SIZE;
        rStyle.rStyle.nBoxTop          :=FK_MAKE_NUM(rec.BOX_TOP);
        rStyle.rStyle.nBoxLeft         :=FK_MAKE_NUM(rec.BOX_LEFT);
        rStyle.rStyle.nBoxBottom       :=FK_MAKE_NUM(rec.BOX_BOTTOM);
        rStyle.rStyle.nBoxRight        :=FK_MAKE_NUM(rec.BOX_RIGHT);
        rStyle.rStyle.nTopPadding      :=FK_MAKE_NUM(rec.TOP_PADDING);
        rStyle.rStyle.nLeftPadding     :=FK_MAKE_NUM(rec.LEFT_PADDING);
        rStyle.rStyle.nBottomPadding   :=FK_MAKE_NUM(rec.BOTTOM_PADDING);
        rStyle.rStyle.nRightPadding    :=FK_MAKE_NUM(rec.RIGHT_PADDING);
        rStyle.rStyle.vcBoxTopColor    :=rec.BOX_TOP_COLOR;
        rStyle.rStyle.vcBoxLeftColor   :=rec.BOX_LEFT_COLOR;
        rStyle.rStyle.vcBoxBottomColor :=rec.BOX_BOTTOM_COLOR;
        rStyle.rStyle.vcBoxRightColor  :=rec.BOX_RIGHT_COLOR;
        rStyle.rStyle.nLineWidth       :=FK_MAKE_NUM(rec.LINE_WIDTH);
        rStyle.rStyle.vcAlignment      :=rec.ALIGNMENT;
        rStyle.rStyle.vcVerticalAlign  :=rec.VERTICAL_ALIGN;
        rStyle.rStyle.nLineSpacing     :=GREATEST(FK_MAKE_NUM(rec.LINE_SPACING), PK_JRXML2PDF_TYPES.MIN_LINE_SPACING);
        rStyle.rStyle.vcOpaque         :=rec.OPAQUE;
        FOR recCond IN crConditionalStyle(rec.STYLE) LOOP
          iPos:=rStyle.lConditionalStyles.COUNT+1;
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Load conditional-style:' || recCond.WHEN_EXPRESSION);
          END IF;
          rStyle.lConditionalStyles(iPos).vcWhenExpression :=recCond.WHEN_EXPRESSION;
          rStyle.lConditionalStyles(iPos).vcFGColor        :=recCond.FGCOLOR;
          rStyle.lConditionalStyles(iPos).vcBGColor        :=recCond.BGCOLOR;
          rStyle.lConditionalStyles(iPos).vcFont           :=recCond.FONT;
          rStyle.lConditionalStyles(iPos).vcFontStyle      :=CASE WHEN     recCond.FONT_BOLD=PK_JRXML2PDF_TYPES.YES
                                                                       AND recCond.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                'BI'
                                                              WHEN recCond.FONT_BOLD=PK_JRXML2PDF_TYPES.YES THEN
                                                                'B'
                                                              WHEN recCond.FONT_ITALIC=PK_JRXML2PDF_TYPES.YES THEN
                                                                'I'
                                                              WHEN recCond.FONT_BOLD=PK_JRXML2PDF_TYPES.NO THEN
                                                                'N'
                                                              END;
          rStyle.lConditionalStyles(iPos).nFontSize        :=recCond.FONT_SIZE;
          rStyle.lConditionalStyles(iPos).nBoxTop          :=FK_MAKE_NUM(recCond.BOX_TOP);
          rStyle.lConditionalStyles(iPos).nBoxLeft         :=FK_MAKE_NUM(recCond.BOX_LEFT);
          rStyle.lConditionalStyles(iPos).nBoxBottom       :=FK_MAKE_NUM(recCond.BOX_BOTTOM);
          rStyle.lConditionalStyles(iPos).nBoxRight        :=FK_MAKE_NUM(recCond.BOX_RIGHT);
          rStyle.lConditionalStyles(iPos).nTopPadding      :=FK_MAKE_NUM(rec.TOP_PADDING);
          rStyle.lConditionalStyles(iPos).nLeftPadding     :=FK_MAKE_NUM(rec.LEFT_PADDING);
          rStyle.lConditionalStyles(iPos).nBottomPadding   :=FK_MAKE_NUM(rec.BOTTOM_PADDING);
          rStyle.lConditionalStyles(iPos).nRightPadding    :=FK_MAKE_NUM(rec.RIGHT_PADDING);
          rStyle.lConditionalStyles(iPos).vcBoxTopColor    :=recCond.BOX_TOP_COLOR;
          rStyle.lConditionalStyles(iPos).vcBoxLeftColor   :=recCond.BOX_LEFT_COLOR;
          rStyle.lConditionalStyles(iPos).vcBoxBottomColor :=recCond.BOX_BOTTOM_COLOR;
          rStyle.lConditionalStyles(iPos).vcBoxRightColor  :=recCond.BOX_RIGHT_COLOR;
          rStyle.lConditionalStyles(iPos).nLineWidth       :=FK_MAKE_NUM(recCond.LINE_WIDTH);
          rStyle.lConditionalStyles(iPos).vcAlignment      :=recCond.ALIGNMENT;
          rStyle.lConditionalStyles(iPos).vcVerticalAlign  :=recCond.VERTICAL_ALIGN;
          rStyle.lConditionalStyles(iPos).nLineSpacing     :=GREATEST(FK_MAKE_NUM(recCond.LINE_SPACING), PK_JRXML2PDF_TYPES.MIN_LINE_SPACING);
          rStyle.lConditionalStyles(iPos).vcOpaque         :=recCond.OPAQUE;
        END LOOP;
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Conditional style count=' || rStyle.lConditionalStyles.COUNT);
        END IF;
        rReport.lStyles(rec.STYLE_NAME):=rStyle;
      END LOOP;
    END;
    PROCEDURE PR_LOAD_GROUPS(i_oXml IN XMLTYPE) IS
    BEGIN
      -- load groups
      FOR rec IN crGroups(i_oXml) LOOP
        rGroup.vcName:=rec.NAME;
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load group:' || rGroup.vcName);
        END IF;
        rGroup.vcExpression:=rec.EXPRESSION;
        rGroup.vcStartOnNewPage:=rec.START_ON_NEW_PAGE;
        rGroup.vcResetPageNumber:=rec.RESET_PAGE_NUMBER;
        rGroup.vcReprintHeader:=rec.REPRINT_HEADER;
        rGroup.nMinHeightForPage:=FK_MAKE_NUM(rec.MIN_HEIGHT);
        rGroup.rGroupHeader:=FK_LOAD_REGION(rReport, rec.GROUPHEADER);
        rGroup.rGroupFooter:=FK_LOAD_REGION(rReport, rec.GROUPFOOTER);
        rReport.lGroups(rReport.lGroups.COUNT+1):=rGroup;
        rReport.lGroupExpressions(rReport.lGroupExpressions.COUNT+1):=NULL;
      END LOOP;
    END;
    PROCEDURE PR_LOAD_DATASETS(i_oXml IN XMLTYPE) IS
      rGroup    PK_JRXML2PDF_TYPES.tGroup;
      rVariable PK_JRXML2PDF_TYPES.tVariable;
    BEGIN
      -- load groups
      FOR rec IN crDatasets(i_oXml) LOOP
        rReport.lDatasets(rec.NAME).vcQuery:=rec.QUERY;
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load dataset:' || rec.NAME);
        END IF;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Dataset query:' || rReport.lDatasets(rec.NAME).vcQuery);
        END IF;
        FOR recGroup IN crDatasetGroups(rec.GROUPS) LOOP
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Add group to dataset:' || recGroup.NAME);
          END IF;
          rGroup.vcName:=recGroup.NAME;
          rGroup.vcExpression:=recGroup.EXPRESSION;
          rReport.lDatasets(rec.NAME).lGroups(rReport.lDatasets(rec.NAME).lGroups.COUNT+1):=rGroup;
        END LOOP;
        FOR recVariable IN crDatasetVariables(rec.VARIABLES) LOOP
          IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
            PK_JRXML2PDF_LOG.PR_LOG_FINE('Add variable to dataset:' || recVariable.NAME);
          END IF;
          rVariable.vcName:=recVariable.NAME;
          rVariable.vcDataType:=FK_DATATYPE_FROM_CLASS(recVariable.CLASS_NAME);
          rVariable.vcCalculation:=NVL(recVariable.CALCULATION, PK_JRXML2PDF_TYPES.CALCULATION_NOTHING);
          rVariable.vcIncrementType:=NVL(recVariable.INCREMENT_TYPE, PK_JRXML2PDF_TYPES.VARTYPE_NONE);
          rVariable.vcIncrementGroup:=recVariable.INCREMENT_GROUP;
          rVariable.vcResetType:=NVL(recVariable.RESET_TYPE, PK_JRXML2PDF_TYPES.VARTYPE_REPORT);
          rVariable.vcResetGroup:=recVariable.RESET_GROUP;
          rVariable.vcValue:=recVariable.EXPRESSION;
          rVariable.vcInitialValue:=recVariable.INITIAL_EXPRESSION;
          rReport.lDatasets(rec.NAME).lVariables(rReport.lDatasets(rec.NAME).lVariables.COUNT+1):=rVariable;
        END LOOP;
      END LOOP;
    END;
    PROCEDURE PR_LOAD_RESOURCES IS
      vcLocale PK_JRXML2PDF_TYPES.tName;
    BEGIN
      -- clear resources
      rReport.lResources.DELETE;
      -- check for locale to use
      -- this is done always, because of format to be used when using the
      -- predefined patterns default, short, medium, long
      FOR i iN 1..i_lParamList.COUNT LOOP
        IF i_lParamList(i).vcName=PK_JRXML2PDF_TYPES.REPORT_LOCALE THEN
          vcLocale:=i_lParamList(i).vcValue;
          EXIT;
        END IF;
      END LOOP;
      rReport.rLocaleData:=PK_JRXML2PDF_UTIL.FK_GET_LOCALE_DATA(vcLocale);
      IF rReport.vcResourceBundle IS NOT NULL THEN
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading Resources');
        END IF;
        -- initialize the resources used for the report
        rReport.lResources:=PK_JRXML2PDF_UTIL.FK_GET_RESOURCE(i_vcResourceName=>rReport.vcResourceBundle,
                                                              i_vcLocale      =>rReport.rLocaleData.vcLocale
                                                             );
      END IF;
    END;
    PROCEDURE PR_LOAD_VARIABLES(i_oXml IN XMLTYPE) IS
      rVariable PK_JRXML2PDF_TYPES.tVariable;
    BEGIN
      -- load variables
      FOR rec IN crVariables(i_oXml) LOOP
        rVariable.vcName:=rec.NAME;
        IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
          PK_JRXML2PDF_LOG.PR_LOG_FINE('Load variable:' || rVariable.vcName);
        END IF;
        rVariable.vcDataType:=FK_DATATYPE_FROM_CLASS(rec.CLASS_NAME);
        rVariable.vcCalculation:=NVL(rec.CALCULATION, PK_JRXML2PDF_TYPES.CALCULATION_NOTHING);
        rVariable.vcIncrementType:=NVL(rec.INCREMENT_TYPE, PK_JRXML2PDF_TYPES.VARTYPE_NONE);
        rVariable.vcIncrementGroup:=rec.INCREMENT_GROUP;
        rVariable.vcResetType:=NVL(rec.RESET_TYPE, PK_JRXML2PDF_TYPES.VARTYPE_REPORT);
        rVariable.vcResetGroup:=rec.RESET_GROUP;
        rVariable.vcValue:=rec.EXPRESSION;
        rVariable.vcInitialValue:=rec.INITIAL_EXPRESSION;
        rReport.lVariables(rReport.lVariables.COUNT+1):=rVariable;
      END LOOP;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Loading report ' || i_vcReportName);
    END IF;
    IF lReportCache.EXISTS(i_vcReportName) THEN
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Taking report from cache');
      END IF;
      rReport:=lReportCache(i_vcReportName);
      rReport.lParams:=i_lParamList;
    ELSE
      rReport.lParams:=i_lParamList;
      OPEN crReport;
      FETCh crReport INTO recReport;
      IF crReport%FOUND THEN
        rReport.nId                 :=recReport.JRD_ID;
        rReport.nPageWidth          :=recReport.PAGE_WIDTH;
        rReport.nPageHeight         :=recReport.PAGE_HEIGHT;
        rReport.nLeftMargin         :=recReport.LEFT_MARGIN;
        rReport.nRightMargin        :=recReport.RIGHT_MARGIN;
        rReport.nTopMargin          :=recReport.TOP_MARGIN;
        rReport.nBottomMargin       :=recReport.BOTTOM_MARGIN;
        rReport.vcFloatColumnFooter :=recReport.FLOAT_COLUMN_FOOTER;
        rReport.vcTitleOnNewPage    :=recReport.TITLE_ON_NEW_PAGE;
        rReport.vcSummaryOnNewPage  :=recReport.SUMMARY_ON_NEW_PAGE;
        rReport.vcSummaryWithHdrFtr :=recReport.SUMMARY_WITH_HDR_FTR;
        rReport.vcResourceBundle    :=recReport.RESOURCE_BUNDLE;
        rReport.vcQuery             :=recReport.QUERY_STRING;
        rReport.nTyp                :=PK_JRXML2PDF_TYPES.REPORT_TYP_REPORT;
        -- Styles must be loadced before regions because of tables,
        -- which inherit styles
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading styles');
        END IF;
        PR_LOAD_STYLES(recReport.XML);
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading resources');
        END IF;
        PR_LOAD_RESOURCES;
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading datasets');
        END IF;
        PR_LOAD_DATASETS(recReport.XML);
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading groups');
        END IF;
        PR_LOAD_GROUPS(recReport.XML);
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Loading variables');
        END IF;
        PR_LOAD_VARIABLES(recReport.XML);
        rReport.rTitleRegion        :=FK_LOAD_REGION(rReport, recReport.TITLE_XML);
        rReport.rPageHeaderRegion   :=FK_LOAD_REGION(rReport, recReport.PAGEHEADER_XML);
        rReport.rColumnHeaderRegion :=FK_LOAD_REGION(rReport, recReport.COLUMNHEADER_XML);
        rReport.rDetailRegion       :=FK_LOAD_REGION(rReport, recReport.DETAIL_XML);
        rReport.rColumnFooterRegion :=FK_LOAD_REGION(rReport, recReport.COLUMNFOOTER_XML);
        rReport.rPageFooterRegion   :=FK_LOAD_REGION(rReport, recReport.PAGEFOOTER_XML);
        rReport.rSummaryRegion      :=FK_LOAD_REGION(rReport, recReport.SUMMARY_XML);
        rReport.rBackgroundRegion   :=FK_LOAD_REGION(rReport, recReport.BACKGROUND_XML);
        CLOSE crReport;
      ELSE
        CLOSE crReport;
        RAISE NO_DATA_FOUND;
      END IF;
      -- Cache
      lReportCache(i_vcReportName):=rReport;
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Parse and execute query');
    END IF;
    PR_EXECUTE_QUERY(rReport, i_lParamList);
    -- empty variables
    rReport.lVariableCache.DELETE;
    rReport.lPageNumbers.DELETE;
    rReport.lLogicalPageNumbers.DELETE;
    rReport.lStartOfPageDone.DELETE;
    rReport.lEndOfPageDone.DELETE;
    rReport.lPageFrameMarkers.DELETE;
    rReport.lPageNumbers(1):=1;
    rReport.lLogicalPageNumbers(1):=1;
    rReport.nCurrentPagePointer:=1;
    RETURN rReport;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CLEAR_CACHE IS
  BEGIN
    lReportCache.DELETE;
  END;
END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_log IS
  nLevel    NUMBER:=LEVEL_NONE;
  nLogMode  NUMBER:=LOGMODE_DBMS_OUTPUT;
  nRunid    NUMBER;
  tsLastTimeStamp TIMESTAMP;
  PROCEDURE PR_SET_LEVEL(i_nLevel   IN NUMBER,
                         i_nLogMode IN NUMBER DEFAULT LOGMODE_DBMS_OUTPUT) IS
    CURSOR crSeq IS
      SELECT JRXML_SEQ.NEXTVAL
        FROM DUAL;
  BEGIN
    DBMS_OUTPUT.ENABLE(40000000);
    nLevel:=i_nLevel;
    nLogMode:=i_nLogMode;
    tsLastTimeStamp:=SYSTIMESTAMP;
    IF i_nLogMode=LOGMODE_TABLE THEN
      -- create a unique run-id
      OPEN crSeq;
      FETCh crSeq INTO nRunId;
      CLOSE crSeq;
    END IF;
  END;

  PROCEDURE PR_LOG(i_nLevel IN NUMBER,
                   i_vcText IN VARCHAR2) IS
  PRAGMA AUTONOMOUS_TRANSACTION;
    tsNew TIMESTAMP;
    nMillis NUMBER;
  BEGIN
    IF nLevel>=i_nLevel THEN
      tsNew:=SYSTIMESTAMP;
      nMillis:=TRUNC(EXTRACT(HOUR         FROM tsNew-tsLastTimeStamp)*3600000)+
               TRUNC(EXTRACT(MINUTE       FROM tsNew-tsLastTimeStamp)*60000)+
               TRUNC(EXTRACT(SECOND       FROM tsNew-tsLastTimeStamp)*1000);
      IF nLogMode=LOGMODE_TABLE THEN
        INSERT INTO JRXML_LOGGING (
          JRL_ID,
          JRL_RUN_ID,
          JRL_TIME,
          JRL_TIME_SINCE_LAST_LOG,
          JRL_TEXT
        ) VALUES (
          JRXML_SEQ.NEXTVAL,
          nRunId,
          tsNew,
          nMillis,
          RPAD('| ', 2*(i_nLevel-1), '| ') || i_vcText
        );
      ELSE
        DBMS_OUTPUT.PUT_LINE(TO_CHAR(tsNew, 'HH24:MI:SS:FF') || '  ' ||
                             TO_CHAR(nMillis, '9999999990') ||'  ' ||
                             RPAD('| ', 2*(i_nLevel-1), '| ') || i_vcText);
      END IF;
      tsLastTimeStamp:=tsNew;
    END IF;
    COMMIT;
  END;

  FUNCTION FK_IS_OVERVIEW
  RETURN BOOLEAN IS
  BEGIN
    RETURN nLevel>LEVEL_NONE;
  END;
  FUNCTION FK_IS_PROCESS
  RETURN BOOLEAN IS
  BEGIN
    RETURN nLevel>LEVEL_OVERVIEW;
  END;
  FUNCTION FK_IS_DETAIL
  RETURN BOOLEAN IS
  BEGIN
    RETURN nLevel>LEVEL_PROCESS;
  END;
  FUNCTION FK_IS_FINE
  RETURN BOOLEAN IS
  BEGIN
    RETURN nLevel>LEVEL_DETAIL;
  END;
  FUNCTION FK_IS_INTERNAL
  RETURN BOOLEAN IS
  BEGIN
    RETURN nLevel=LEVEL_INTERNAL;
  END;
  PROCEDURE PR_LOG_OVERVIEW(i_vcText IN VARCHAR2) IS
  BEGIN
    PR_LOG(LEVEL_OVERVIEW, i_vcText);
  END;
  PROCEDURE PR_LOG_PROCESS(i_vcText IN VARCHAR2) IS
  BEGIN
    PR_LOG(LEVEL_PROCESS, i_vcText);
  END;
  PROCEDURE PR_LOG_DETAIL(i_vcText IN VARCHAR2) IS
  BEGIN
    PR_LOG(LEVEL_DETAIL, i_vcText);
  END;

  PROCEDURE PR_LOG_FINE(i_vcText IN VARCHAR2) IS
  BEGIN
    PR_LOG(LEVEL_FINE, i_vcText);
  END;
  PROCEDURE PR_LOG_INTERNAL(i_vcText IN VARCHAR2) IS
  BEGIN
    PR_LOG(LEVEL_INTERNAL, i_vcText);
  END;

END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_repgen IS
  VERSION_NUMBER        CONSTANT VARCHAR2(20):='1.3.1.1';
  -- Forwards
  FUNCTION FK_RENDER_SUBREPORT(i_nX                IN NUMBER,
                               i_nY                IN NUMBER,
                               i_nWidth            IN NUMBER,
                               i_nHeight           IN NUMBER,
                               i_vcStyle           IN PK_JRXML2PDF_TYPES.tStyleName,
                               i_rArea             IN PK_JRXML2PDF_TYPES.tArea,
                               i_vcReportName      IN PK_JRXML2PDF_TYPES.tName,
                               i_lParamList        IN PK_JRXML2PDF_TYPES.tParamList,
                               i_nMasterRecord     IN NUMBER,
                               io_lReturnValues    IN OUT NOCOPY PK_JRXML2PDF_TYPES.tSubreportReturnvalueList
                               )
  RETURN PK_JRXML2PDF_TYPES.tArea;
  FUNCTION FK_EVALUATE_EXPRESSION(i_nStackPos      IN NUMBER,
                                  i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                  i_vcPattern      IN PK_JRXML2PDF_TYPES.tPattern,
                                  i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN VARCHAR2;
  FUNCTION FK_EVALUATE_IMAGE(i_nStackPos      IN NUMBER,
                             i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression)
  RETURN BLOB;
  FUNCTION FK_EVALUATE_CONDITION(i_nStackPos      IN NUMBER,
                                 i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                 i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN BOOLEAN;
  PROCEDURE PR_FINISH_PAGE_AND_START_NEW(io_rArea                 IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                                         i_nStackPos              IN NUMBER,
                                         i_bInnerToBottom         IN BOOLEAN    DEFAULT FALSE,
                                         i_bBeforeSubReportHdr    IN BOOLEAN    DEFAULT FALSE,
                                         i_bBeforeSubReportColHdr IN BOOLEAN    DEFAULT FALSE,
                                         i_bResetPagenumber       IN BOOLEAN    DEFAULT FALSE,
                                         i_bOneRecordBack         IN BOOLEAN    DEFAULT FALSE,
                                         i_vcStyleToApply         IN PK_JRXML2PDF_TYPES.tStyleName DEFAULT NULL,
                                         i_bRenderGroups          IN BOOLEAN    DEFAULT TRUE,
                                         i_bPageHeaders           IN BOOLEAN    DEFAULT TRUE
                                         );
  PROCEDURE PR_RENDER_GROUP_HEADERS(i_nStackPos     IN NUMBER,
                                    io_rArea        IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                                    i_bReprintOnly  IN BOOLEAN DEFAULT FALSE,
                                    i_bIsOnNewPage  IN BOOLEAN DEFAULT FALSE);
  FUNCTION FK_RENDER_TEXT(i_nX               IN NUMBER,
                          i_nY               IN NUMBER,
                          i_nWidth           IN NUMBER,
                          i_nHeight          IN NUMBER,
                          i_vcText           IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                          i_vcFont           IN PK_JRXML2PDF_TYPES.tFont,
                          i_nFontSize        IN NUMBER,
                          i_vcFontStyle      IN PK_JRXML2PDF_TYPES.tFontStyle,
                          i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcVerticalAlign  IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcBgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcFgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_nBoxTop          IN NUMBER,
                          i_nBoxLeft         IN NUMBER,
                          i_nBoxBottom       IN NUMBER,
                          i_nBoxRight        IN NUMBER,
                          i_nTopPadding      IN NUMBER,
                          i_nLeftPadding     IN NUMBER,
                          i_nBottomPadding   IN NUMBER,
                          i_nRightPadding    IN NUMBER,
                          i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                          i_nLineSpacing     IN NUMBER,
                          i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo,
                          i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle,
                          i_bMayPageBreak    IN BOOLEAN DEFAULT FALSE,
                          i_rArea            IN PK_JRXML2PDF_TYPES.tArea DEFAULT NULL,
                          i_vcRotation       IN PK_JRXML2PDF_TYPES.tAttribute DEFAULT NULL)
  RETURN PK_JRXML2PDF_TYPES.tArea;
  PROCEDURE PR_PUSH_SUBREPORT_DATA(io_rReport IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport);
  FUNCTION FK_FETCH_ROW(i_nStackPos IN NUMBER)
  RETURN BOOLEAN;
  PROCEDURE PR_POP_SUBREPORT_DATA;
  FUNCTION FK_RENDER_BAND(i_nStackPos           IN NUMBER,
                          i_rBand               IN PK_JRXML2PDF_TYPES.tBand,
                          i_rArea               IN PK_JRXML2PDF_TYPES.tArea,
                          i_bAllowSubReports    IN BOOLEAN,
                          i_nRenderFrame        IN NUMBER,
                          i_vcContentAdjustment IN PK_JRXML2PDF_TYPES.tAlignment DEFAULT PK_JRXML2PDF_TYPES.NONE_ALIGN,
                          i_nXFactor            IN NUMBER DEFAULT 1,
                          i_nYFactor            IN NUMBER DEFAULT 1,
                          i_nNeededHeight       IN NUMBER DEFAULT NULL
                         )
  RETURN PK_JRXML2PDF_TYPES.tArea;
  FUNCTION FK_FITS_IN_PAGE(i_nCurrentY           IN NUMBER,
                           i_nDetailHeight       IN NUMBER)
  RETURN BOOLEAN;
  lTokens             PK_JRXML2PDF_TYPES.tTokenList;
  rPageSetup          PK_JRXML2PDF_TYPES.tPageSetup;
  lReportStack        PK_JRXML2PDF_TYPES.tReportList;
  lDatePattern        PK_JRXML2PDF_TYPES.tPatternList;
  lHtmlTokens         PK_JRXML2PDF_TYPES.tHtmlTokenList;
  lHtmlReplacements   PK_JRXML2PDF_TYPES.tHtmlReplacementList;
  rMasterHtmlSettings PK_JRXML2PDF_TYPES.tHtmlSettings;
  rLastStyle          PK_JRXML2PDF_TYPES.tSimpleStyle;
  rLastStyleName      PK_JRXML2PDF_TYPES.tStyleName:=PK_JRXML2PDF_TYPES.NIL;
  blPDF               BLOB;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_TOKEN(i_vcStartTag IN PK_JRXML2PDF_TYPES.tAttribute,
                         i_vcEndTag   IN PK_JRXML2PDF_TYPES.tAttribute DEFAULT NULL) IS
    iPos PLS_INTEGER:=lTokens.COUNT+1;
  BEGIN
    lTokens(iPos).vcStartTag:=i_vcStartTag;
    lTokens(iPos).vcEndTag  :=i_vcEndTag;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_HTML_REPLACEMENT (i_vcHtmlTag IN PK_JRXML2PDF_TYPES.tAttribute,
                                     i_vcPdfChar IN PK_JRXML2PDF_TYPES.tAttribute) IS
  BEGIN
    lHtmlReplacements(i_vcHtmlTag):=i_vcPdfChar;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_PUSH_PAGE_FRAME_MARKER(i_nStackPos    IN NUMBER,
                                      i_nBorderTop   IN NUMBER,
                                      i_nBorderWidth IN NUMBER,
                                      i_rStyle       IN PK_JRXML2PDF_TYPES.tSimpleStyle) IS
    rPageFrameMarker PK_JRXML2PDF_TYPES.tPageFrameMarker;
  BEGIN
    rPageFrameMarker.nBorderTop:=i_nBorderTop;
    rPageFrameMarker.nBorderWidth:=i_nBorderWidth;
    rPageFrameMarker.rStyle:=i_rStyle;
    lReportStack(i_nStackpos).lPageFrameMarkers(lReportStack(i_nStackpos).lPageFrameMarkers.COUNT+1):=rPageFrameMarker;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_POP_PAGE_FRAME_MARKER(i_nStackPos    IN NUMBER) IS
  BEGIN
    IF lReportStack(i_nStackpos).lPageFrameMarkers.COUNT>0 THEN
      lReportStack(i_nStackpos).lPageFrameMarkers.DELETE(lReportStack(i_nStackpos).lPageFrameMarkers.COUNT);
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_STORE_PAGE_POSITION(i_rArea IN PK_JRXML2PDF_TYPES.tArea) IS
    rArea PK_JRXML2PDF_TYPES.tArea:=i_rArea;
  BEGIN
    FOR i IN 1..lReportStack.COUNT LOOP
      -- store the Pagepointer
      rArea.nPage:=lReportStack(i).nCurrentPagePointer;
      -- position is stored in last report on stack
      lReportStack(i).lStoredPositions(lReportStack(i).lStoredPositions.COUNT+1):=rArea;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GOTO_LAST_STORED_POSITION
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    rArea PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    FOR i IN 1..lReportStack.COUNT LOOP
      -- position is stored in last report on stack
      rArea:=lReportStack(i).lStoredPositions(lReportStack(i).lStoredPositions.COUNT);
      lReportStack(i).nCurrentPagePointer:=rArea.nPage;
    END LOOP;
    IF lReportStack(1).lPageNumbers.COUNT=lReportStack(1).nCurrentPagePointer THEN
      AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
    ELSE
      AS_PDF3_MOD.PR_GOTO_PAGE(lReportStack(1).lPageNumbers(lReportStack(1).nCurrentPagePointer));
    END IF;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_REMOVE_LAST_STORED_POSITION IS
    rArea PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    FOR i IN 1..lReportStack.COUNT LOOP
      -- position is stored in last report on stack
      rArea:=lReportStack(i).lStoredPositions(lReportStack(i).lStoredPositions.COUNT);
      lReportStack(i).lStoredPositions.DELETE(lReportStack(i).lStoredPositions.COUNT);
    END LOOP;
    IF lReportStack(1).lStoredPositions.COUNT=0 THEN
      AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_GOTO_STORED_POSITION(i_rArea IN PK_JRXML2PDF_TYPES.tArea) IS
  BEGIN
    lReportStack(1).nCurrentPagePointer:=i_rArea.nPage;
    IF lReportStack(1).nCurrentPagePointer=lReportStack(1).lPageNumbers.COUNT THEN
      AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
      -- Reset current page pointers for all subreports
      FOR i IN 2..lReportStack.COUNT LOOP
        lReportStack(i).nCurrentPagePointer:=lReportStack(i).lPageNumbers(lReportStack(i).lPageNumbers.COUNT);
      END LOOP;
    ELSE
      AS_PDF3_MOD.PR_GOTO_PAGE(lReportStack(1).lPageNumbers(lReportStack(1).nCurrentPagePointer));
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_NUM_PATTERN(i_vcPattern IN PK_JRXML2PDF_TYPES.tPattern)
  RETURN VARCHAR2 IS
    -- official format
    CURRENCYPATTERN     CONSTANT VARCHAR2(4) :=UNISTR('\00A4');
    ISOCURRENCYPATTERN  CONSTANT VARCHAR2(8) :=UNISTR('\00A4\00A4');
    FULLCURRENCYPATTERN CONSTANT VARCHAR2(12):=UNISTR('\00A4\00A4\00A4');
    FUNCTION FK_PATTERN(i_vcPattern IN VARCHAR2)
    RETURN VARCHAR2 IS
      iPos     PLS_INTEGER:=INSTR(i_vcPattern, CURRENCYPATTERN);
      vcResult PK_JRXML2PDF_TYPES.tPattern;
    BEGIN
      vcResult:=TRANSLATE(i_vcPattern, '#0.,', '90DG');
      IF iPos>0 THEN
        vcResult:=REPLACE(vcResult, FULLCURRENCYPATTERN, 'C');
        vcResult:=REPLACE(vcResult, ISOCURRENCYPATTERN, 'C');
        vcResult:=REPLACE(vcResult, CURRENCYPATTERN, 'L');
        vcResult:=REPLACE(vcResult, ' ', '');
      END IF;
      RETURN vcResult;
    END;
  BEGIN
    IF INSTR(i_vcPattern, ';')>0 THEN
      RETURN FK_PATTERN(SUBSTR(i_vcPattern, 1,INSTR(i_vcPattern, ';')-1));
    ELSE
      RETURN FK_PATTERN(i_vcPattern);
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_LOAD_REPORT (i_vcReportName IN VARCHAR2,
                           i_lParamList   IN PK_JRXML2PDF_TYPES.tParamList)
  RETURN PK_JRXML2PDF_TYPES.tReport IS
    rReport PK_JRXML2PDF_TYPES.tReport;
  BEGIN
    rReport:=PK_JRXML2PDF_LOADER.FK_LOAD_REPORT(i_vcReportName =>i_vcReportName,
                                                i_lParamList   =>i_lParamList);
    RETURN rReport;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_STYLE(i_nStackPos IN NUMBER,
                        i_vcStyle   IN PK_JRXML2PDF_TYPES.tStyleName)
  RETURn PK_JRXML2PDF_TYPES.tSimpleStyle IS
    rSimpleStyle PK_JRXML2PDF_TYPES.tSimpleStyle;
    rCondStyle   PK_JRXML2PDF_TYPES.tSimpleStyle;
    iPos         PLS_INTEGER;
    bOk          BOOLEAN;
  BEGIN
    IF i_vcStyle IS NOT NULL THEN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Search Style ' || i_vcStyle);
      END IF;
      IF rLastStyleName=i_vcStyle THEN
        rSimpleStyle:=rLastStyle;
        bOk:=TRUE;
      ELSE
        BEGIN
          rSimpleStyle:=lReportStack(i_nStackPos).lStyles(i_vcStyle).rStyle;
          rLastStyleName:=i_vcStyle;
          rLastStyle:=rSimpleStyle;
          bOk:=TRUE;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            NULL;
        END;
      END IF;
    END IF;
    IF bOk THEN
      -- Apply conditional styles
      iPos:=lReportStack(i_nStackPos).lStyles(i_vcStyle).lConditionalStyles.FIRST;
      WHILE iPos IS NOT NULL LOOP
        -- evaluate expression
        IF FK_EVALUATE_CONDITION(i_nStackPos,
                                 lReportStack(i_nStackPos).lStyles(i_vcStyle).lConditionalStyles(iPos).vcWhenExpression) THEN
          rCondStyle:=lReportStack(i_nStackPos).lStyles(i_vcStyle).lConditionalStyles(iPos);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Apply conditional style:'||lReportStack(i_nStackPos).lStyles(i_vcStyle).lConditionalStyles(iPos).vcWhenExpression);
          END IF;
          -- apply conditional attributes
          rSimpleStyle.vcFGColor        :=NVL(rCondStyle.vcFGColor       , rSimpleStyle.vcFGColor);
          rSimpleStyle.vcBGColor        :=NVL(rCondStyle.vcBGColor       , rSimpleStyle.vcBGColor);
          rSimpleStyle.vcFont           :=NVL(rCondStyle.vcFont          , rSimpleStyle.vcFont);
          rSimpleStyle.vcFontStyle      :=NVL(rCondStyle.vcFontStyle     , rSimpleStyle.vcFontStyle);
          rSimpleStyle.vcAlignment      :=NVL(rCondStyle.vcAlignment     , rSimpleStyle.vcAlignment);
          rSimpleStyle.nFontSize        :=NVL(rCondStyle.nFontSize       , rSimpleStyle.nFontSize);
          rSimpleStyle.nLineWidth       :=NVL(rCondStyle.nLineWidth      , rSimpleStyle.nLineWidth);
          rSimpleStyle.nBoxTop          :=NVL(rCondStyle.nBoxTop         , rSimpleStyle.nBoxTop);
          rSimpleStyle.nBoxLeft         :=NVL(rCondStyle.nBoxLeft        , rSimpleStyle.nBoxLeft);
          rSimpleStyle.nBoxBottom       :=NVL(rCondStyle.nBoxBottom      , rSimpleStyle.nBoxBottom);
          rSimpleStyle.nBoxRight        :=NVL(rCondStyle.nBoxRight       , rSimpleStyle.nBoxRight);
          rSimpleStyle.vcBoxTopColor    :=NVL(rCondStyle.vcBoxTopColor   , rSimpleStyle.vcBoxTopColor);
          rSimpleStyle.vcBoxLeftColor   :=NVL(rCondStyle.vcBoxLeftColor  , rSimpleStyle.vcBoxLeftColor);
          rSimpleStyle.vcBoxBottomColor :=NVL(rCondStyle.vcBoxBottomColor, rSimpleStyle.vcBoxBottomColor);
          rSimpleStyle.vcBoxRightColor  :=NVL(rCondStyle.vcBoxRightColor , rSimpleStyle.vcBoxRightColor);
          rSimpleStyle.vcOpaque         :=NVL(rCondStyle.vcOpaque        , rSimpleStyle.vcOpaque);
          iPos:=NULL;
        ELSE
          iPos:=lReportStack(i_nStackPos).lStyles(i_vcStyle).lConditionalStyles.NEXT(iPos);
        END IF;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Found');
      END IF;
      RETURN rSimpleStyle;
    ELSE
      RETURN NULL;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_MAKE_STYLE_FROM_ATTRIBS(i_vcFont           IN PK_JRXML2PDF_TYPES.tFont      DEFAULT NULL,
                                      i_nFontSize        IN NUMBER     DEFAULT NULL,
                                      i_nLineWidth       IN NUMBER     DEFAULT NULL,
                                      i_vcFontStyle      IN VARCHAR2   DEFAULT NULL,
                                      i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment DEFAULT NULL,
                                      i_vcVerticalAlign  IN PK_JRXML2PDF_TYPES.tAlignment DEFAULT NULL,
                                      i_vcBgColor        IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_vcFgColor        IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_nBoxTop          IN NUMBER     DEFAULT NULL,
                                      i_nBoxLeft         IN NUMBER     DEFAULT NULL,
                                      i_nBoxBottom       IN NUMBER     DEFAULT NULL,
                                      i_nBoxRight        IN NUMBER     DEFAULT NULL,
                                      i_nTopPadding      IN NUMBER     DEFAULT NULL,
                                      i_nLeftPadding     IN NUMBER     DEFAULT NULL,
                                      i_nBottomPadding   IN NUMBER     DEFAULT NULL,
                                      i_nRightPadding    IN NUMBER     DEFAULT NULL,
                                      i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor     DEFAULT NULL,
                                      i_nLineSpacing     IN NUMBER     DEFAULT NULL,
                                      i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo     DEFAULT NULL,
                                      i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle)
  RETURN PK_JRXML2PDF_TYPES.tSimpleStyle IS
    rStyle PK_JRXML2PDF_TYPES.tSimpleStyle;
  BEGIN
    rStyle.vcFGColor        :=NVL(i_vcFGColor       , i_rStyle.vcFGColor);
    rStyle.vcBGColor        :=NVL(i_vcBGColor       , i_rStyle.vcBGColor);
    rStyle.vcFont           :=NVL(i_vcFont          , i_rStyle.vcFont);
    rStyle.vcFontStyle      :=NVL(i_vcFontStyle     , i_rStyle.vcFontStyle);
    rStyle.vcAlignment      :=NVL(i_vcAlignment     , i_rStyle.vcAlignment);
    rStyle.nFontSize        :=NVL(i_nFontSize       , i_rStyle.nFontSize);
    rStyle.nLineWidth       :=NVL(i_nLineWidth      , i_rStyle.nLineWidth);
    rStyle.nBoxTop          :=NVL(i_nBoxTop         , i_rStyle.nBoxTop);
    rStyle.nBoxLeft         :=NVL(i_nBoxLeft        , i_rStyle.nBoxLeft);
    rStyle.nBoxBottom       :=NVL(i_nBoxBottom      , i_rStyle.nBoxBottom);
    rStyle.nBoxRight        :=NVL(i_nBoxRight       , i_rStyle.nBoxRight);
    rStyle.vcBoxTopColor    :=NVL(i_vcBoxTopColor   , i_rStyle.vcBoxTopColor);
    rStyle.vcBoxLeftColor   :=NVL(i_vcBoxLeftColor  , i_rStyle.vcBoxLeftColor);
    rStyle.vcBoxBottomColor :=NVL(i_vcBoxBottomColor, i_rStyle.vcBoxBottomColor);
    rStyle.vcBoxRightColor  :=NVL(i_vcBoxRightColor , i_rStyle.vcBoxRightColor);
    rStyle.vcOpaque         :=NVL(i_vcOpaque        , i_rStyle.vcOpaque);
    RETURn rStyle;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_INIT_PDF(i_vcTitle    IN VARCHAR2,
                        i_vcAuthor   IN VARCHAR2,
                        i_vcSubject  IN VARCHAR2,
                        i_vcKeywords IN VARCHAR2) IS
  BEGIN
    AS_PDF3_MOD.INIT;
    IF    i_vcTitle IS NOT NULL
       OR i_vcAuthor IS NOT NULL
       OR i_vcSubject IS NOT NULL
       OR i_vcKeywords IS NOT NULL THEN
      AS_PDF3_MOD.set_info(p_title   =>i_vcTitle,
                           p_author  =>i_vcAuthor,
                           p_subject =>i_vcSubject,
                           p_keywords=>i_vcKeywords
                          );
   END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_FINISH_PDF IS
  BEGIN
    blPDF:=AS_PDF3_MOD.get_pdf;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SETUP_PAGE(i_nWidth        IN NUMBER,
                          i_nHeight       IN NUMBER,
                          i_nLeftMargin   IN NUMBER,
                          i_nRightMargin  IN NUMBER,
                          i_nTopMargin    IN NUMBER,
                          i_nBottomMargin IN NUMBER
                         ) IS
  BEGIN
    AS_PDF3_MOD.set_page_size(p_width  =>i_nWidth,
                              p_height =>i_nHeight,
                              p_unit   =>PK_JRXML2PDF_TYPES.PIXEL
                             );
    AS_PDF3_MOD.set_margins(p_top   =>i_nTopMargin,
                            p_left  =>i_nLeftMargin,
                            p_bottom=>i_nBottomMargin,
                            p_right =>i_nRightMargin,
                            p_unit   =>PK_JRXML2PDF_TYPES.PIXEL
                           );
    rPageSetup.nPageWidth   :=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_PAGE_WIDTH);
    rPageSetup.nPageHeight  :=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_PAGE_HEIGHT);
    rPageSetup.nLeftMargin  :=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_MARGIN_LEFT);
    rPageSetup.nRightMargin :=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_MARGIN_RIGHT);
    rPageSetup.nTopMargin   :=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_MARGIN_TOP);
    rPageSetup.nBottomMargin:=AS_PDF3_MOD.get(AS_PDF3_MOD.C_GET_MARGIN_BOTTOM);
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_NEW_PAGE(i_bResetPageNumber IN BOOLEAN) IS
  BEGIN
    IF NOT lReportStack(1).lStartOfPageDone.EXISTS(lReportStack(1).nCurrentPagePointer+1) THEN
      -- its a new page
      AS_PDF3_MOD.new_page;
      -- set pointer to current page
      AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('New Page for Report : ' || lReportStack.COUNT);
      END IF;
      FOR i IN 1..lReportStack.COUNT LOOP
        -- increase Stack of Pagenumber
        lReportStack(i).nCurrentPagePointer:=lReportStack(i).nCurrentPagePointer+1;
        lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer):=lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer-1)+1;
        IF     i=lReportStack.COUNT
           AND i_bResetPageNumber THEN
          lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer):=1;
        ELSE
          lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer):=lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer-1)+1;
        END IF;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Increase Page no for report : ' ||TO_CHAR(lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer)) || '/' || TO_CHAR(i));
        END IF;
      END LOOP;
    ELSE
      IF lReportStack(1).nCurrentPagePointer+1=lReportStack(1).lPageNumbers.COUNT THEN
        AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
      ELSE
        AS_PDF3_MOD.PR_GOTO_PAGE(lReportStack(1).lPageNumbers(lReportStack(1).nCurrentPagePointer+1));
      END IF;
      -- we are on a page were the already have been
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Return to Page for Report : ' || lReportStack.COUNT);
      END IF;
      FOR i IN 1..lReportStack.COUNT LOOP
        -- increase Stack of Pagenumber
        lReportStack(i).nCurrentPagePointer:=lReportStack(i).nCurrentPagePointer+1;
        IF NOT lReportStack(i).lStartOfPageDone.EXISTS(lReportStack(i).nCurrentPagePointer) THEN
          lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer):=lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer-1)+1;
          IF     i=lReportStack.COUNT
             AND i_bResetPageNumber THEN
            lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer):=1;
          ELSE
            lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer):=lReportStack(i).lLogicalPageNumbers(lReportStack(i).nCurrentPagePointer-1)+1;
          END IF;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Increase Page no for report : ' ||TO_CHAR(lReportStack(i).lPageNumbers(lReportStack(i).nCurrentPagePointer)) || '/' || TO_CHAR(i));
          END IF;
        END IF;
      END LOOP;
    END IF;
  END;
  PROCEDURE PR_RENDER_LINE(i_nX          IN NUMBER,
                           i_nY          IN NUMBER,
                           i_nWidth      IN NUMBER,
                           i_nHeight     IN NUMBER,
                           i_nLineWidth  IN NUMBER,
                           i_vcLineColor IN PK_JRXML2PDF_TYPES.tColor,
                           i_rStyle      IN PK_JRXML2PDF_TYPES.tSimpleStyle
                          ) IS
  BEGIN
    IF i_nWidth=1 THEN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('vert Line x/y/Height/Linewidth' || TO_CHAR(i_nX) || '/' ||
                                                                             TO_CHAR(i_nY) || '/' ||
                                                                             TO_CHAR(i_nHeight) || '/' ||
                                                                             TO_CHAR(COALESCE(i_nLineWidth, i_rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN))
                                        );
      END IF;
      -- vertical line
      AS_PDF3_MOD.vertical_line(p_x          =>rPageSetup.nLeftMargin+i_nX,
                                p_y          =>rPageSetup.nPageHeight-i_nY-rPageSetup.nTopMargin,
                                p_height     =>-i_nHeight,
                                p_line_width =>COALESCE(i_nLineWidth, i_rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN),
                                p_line_color =>REPLACE(COALESCE(i_vcLineColor, i_rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK), '#', '')
                               );
    ELSIF i_nHeight=1 THEN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('horz Line x/y/Width/Linewidth'  || TO_CHAR(i_nX) || '/' ||
                                                                             TO_CHAR(i_nY) || '/' ||
                                                                             TO_CHAR(i_nWidth) || '/' ||
                                                                             TO_CHAR(COALESCE(i_nLineWidth, i_rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN))
                                        );
      END IF;
      -- horizontal line
      AS_PDF3_MOD.horizontal_line(p_x          =>rPageSetup.nLeftMargin+i_nX,
                                  p_y          =>rPageSetup.nPageHeight-rPageSetup.nTopMargin-i_nY,
                                  p_width      =>i_nWidth,
                                  p_line_width =>COALESCE(i_nLineWidth, i_rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN),
                                  p_line_color =>REPLACE(COALESCE(i_vcLineColor, i_rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK), '#', '')
                                 );
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_RECT(i_nX          IN NUMBER,
                           i_nY          IN NUMBER,
                           i_nWidth      IN NUMBER,
                           i_nHeight     IN NUMBER,
                           i_nLineWidth  IN NUMBER,
                           i_vcLineColor IN PK_JRXML2PDF_TYPES.tColor,
                           i_vcFillColor IN PK_JRXML2PDF_TYPES.tColor,
                           i_rStyle      IN PK_JRXML2PDF_TYPES.tSimpleStyle
                          ) IS
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Rect ' || i_nX || '-' || i_nY || '-' || i_nWidth || '-' || i_nHeight);
    END IF;
    -- vertical line
    AS_PDF3_MOD.rect(p_x          =>rPageSetup.nLeftMargin+i_nX,
                     p_y          =>rPageSetup.nPageHeight-rPageSetup.nTopMargin-i_nY,
                     p_width      =>i_nWidth,
                     p_height     =>-i_nHeight,
                     p_line_color =>REPLACE(COALESCE(i_vcLineColor, i_rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK), '#', ''),
                     p_fill_color =>REPLACE(COALESCE(i_vcFillColor, i_rStyle.vcBgColor, PK_JRXML2PDF_TYPES.WHITE), '#', ''),
                     p_line_width =>COALESCE(i_nLineWidth, i_rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN)
                    );
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_IMAGE(i_nX          IN NUMBER,
                            i_nY          IN NUMBER,
                            i_nWidth      IN NUMBER,
                            i_nHeight     IN NUMBER,
                            i_blImage     IN BLOB,
                            i_vcAdler32   IN PK_JRXML2PDF_TYPEs.tMaxVarchar2
                          ) IS
    blTemp  BLOB;
    rDummy PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    -- Evaluate Expression of image
    IF i_blImage IS NOT NULL THEN
      DBMS_LOB.CREATETEMPORARY(blTemp, true);
      DBMS_LOB.COPY(dest_lob=>blTemp,
                    src_lob =>i_blImage,
                    amount  =>dbms_lob.getlength(i_blImage)
                   );
      AS_PDF3_MOD.put_image(p_img        =>blTemp,
                            p_x          =>rPageSetup.nLeftMargin+i_nX,
                            p_y          =>rPageSetup.nPageHeight-rPageSetup.nTopMargin-i_nY-i_nHeight,
                            p_width      =>i_nWidth,
                            p_height     =>i_nHeight,
                            p_align      =>PK_JRXML2PDF_TYPES.LEFT_ALIGN,
                            p_adler32    =>i_vcAdler32
                           );
      DBMS_LOB.FREETEMPORARY(blTemp);
    END IF;
  EXCEPTION
    WHEN OTHERS THEN
      -- render error, output error as text
      rDummy:=FK_RENDER_TEXT(i_nX              =>i_nX,
                             i_nY              =>i_nY,
                             i_nWidth          =>i_nWidth,
                             i_nHeight         =>i_nHeight,
                             i_vcText          =>SQLCODE || SQLERRM ,
                             i_vcFont          =>PK_JRXML2PDF_TYPES.ARIAL,
                             i_nFontSize       =>10,
                             i_vcFontStyle     =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                             i_vcAlignment     =>PK_JRXML2PDF_TYPES.LEFT_ALIGN,
                             i_vcVerticalAlign =>PK_JRXML2PDF_TYPES.TOP_ALIGN,
                             i_vcBgColor       =>PK_JRXML2PDF_TYPES.WHITE,
                             i_vcFgColor       =>PK_JRXML2PDF_TYPES.BLACK,
                             i_nBoxTop         =>NULL,
                             i_nBoxLeft        =>NULL,
                             i_nBoxBottom      =>NULL,
                             i_nBoxRight       =>NULL,
                             i_nTopPadding     =>NULL,
                             i_nLeftPadding    =>NULL,
                             i_nBottomPadding  =>NULL,
                             i_nRightPadding   =>NULL,
                             i_vcBoxTopColor   =>NULL,
                             i_vcBoxLeftColor  =>NULL,
                             i_vcBoxBottomColor=>NULL,
                             i_vcBoxRightColor =>NULL,
                             i_nLineSpacing    =>PK_JRXML2PDF_TYPES.MIN_LINE_SPACING,
                             i_vcOpaque        =>PK_JRXML2PDF_TYPES.NO,
                             i_rStyle          =>NULL
                            );
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_BOX(i_nX               IN NUMBER,
                          i_nY               IN NUMBER,
                          i_nWidth           IN NUMBER,
                          i_nHeight          IN NUMBER,
                          i_vcBgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcFgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_nBoxTop          IN VARCHAR2,
                          i_nBoxLeft         IN VARCHAR2,
                          i_nBoxBottom       IN VARCHAR2,
                          i_nBoxRight        IN VARCHAR2,
                          i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo,
                          i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle) IS
    nStartOffset NUMBER;
    nEndOffset   NUMBER;
  BEGIN
    IF NVL(i_vcBgColor, i_rStyle.vcBgColor) IS NOT NULL
       AND COALESCE(i_vcOpaque, i_rStyle.vcOpaque, PK_JRXML2PDF_TYPES.NO)=PK_JRXML2PDF_TYPES.YES THEN
      -- Render rectangle
      PR_RENDER_RECT(i_nX         =>i_nX+0.5,
                     i_nY         =>i_nY+0.5,
                     i_nWidth     =>i_nWidth-1,
                     i_nHeight    =>i_nHeight-1,
                     i_nLineWidth =>NULL,
                     i_vcLineColor=>NVL(i_vcBgColor, i_rStyle.vcBgColor),
                     i_vcFillColor=>NVL(i_vcBgColor, i_rStyle.vcBgColor),
                     i_rStyle     =>i_rStyle
                    );
    END IF;
    IF NVL(i_nBoxTop, i_rStyle.nBoxTop) >0 THEN
      nStartOffset:=COALESCE(i_nBoxLeft, i_rStyle.nBoxLeft, 0)/2;
      nEndOffset  :=COALESCE(i_nBoxRight, i_rStyle.nBoxRight, 0)/2;
      -- horizontal line
      PR_RENDER_LINE(i_nX         =>i_nX-nStartOffset,
                     i_nY         =>i_nY,
                     i_nWidth     =>i_nWidth+nStartOffset+nEndOffset,
                     i_nHeight    =>1,
                     i_nLineWidth =>NVL(i_nBoxTop, i_rStyle.nBoxTop),
                     i_vcLineColor=>NVL(i_vcBoxTopColor, i_rStyle.vcBoxTopColor),
                     i_rStyle     =>i_rStyle
                    );
    END IF;
    IF NVL(i_nBoxLeft, i_rStyle.nBoxLeft)>0 THEN
      nStartOffset:=COALESCE(i_nBoxTop, i_rStyle.nBoxTop,0)/2;
      nEndOffset  :=COALESCE(i_nBoxBottom, i_rStyle.nBoxBottom,0)/2;
      -- vertical line
      PR_RENDER_LINE(i_nX         =>i_nX,
                     i_nY         =>i_nY-nStartOffset,
                     i_nWidth     =>1,
                     i_nHeight    =>i_nHeight+nStartOffset+nEndOffset,
                     i_nLineWidth =>NVL(i_nBoxLeft, i_rStyle.nBoxLeft),
                     i_vcLineColor=>NVL(i_vcBoxLeftColor, i_rStyle.vcBoxLeftColor),
                     i_rStyle     =>i_rStyle
                    );
    END IF;
    IF NVL(i_nBoxBottom, i_rStyle.nBoxBottom)>0 THEN
      nStartOffset:=COALESCE(i_nBoxLeft, i_rStyle.nBoxLeft, 0)/2;
      nEndOffset  :=COALESCE(i_nBoxRight, i_rStyle.nBoxRight, 0)/2;
      -- horizontal line
      PR_RENDER_LINE(i_nX         =>i_nX-nStartOffset,
                     i_nY         =>i_nY+i_nHeight,
                     i_nWidth     =>i_nWidth+nStartOffset+nEndOffset,
                     i_nHeight    =>1,
                     i_nLineWidth =>NVL(i_nBoxBottom, i_rStyle.nBoxBottom),
                     i_vcLineColor=>NVL(i_vcBoxBottomColor, i_rStyle.vcBoxBottomColor),
                     i_rStyle     =>i_rStyle
                    );
    END IF;
    IF NVL(i_nBoxRight, i_rStyle.nBoxRight)>0 THEN
      nStartOffset:=COALESCE(i_nBoxTop, i_rStyle.nBoxTop, 0)/2;
      nEndOffset  :=COALESCE(i_nBoxBottom, i_rStyle.nBoxBottom, 0)/2;
      -- horizontal line
      PR_RENDER_LINE(i_nX         =>i_nX+ i_nWidth,
                     i_nY         =>i_nY-nStartOffset,
                     i_nWidth     =>1,
                     i_nHeight    =>i_nHeight+nStartOffset+nEndOffset,
                     i_nLineWidth =>NVL(i_nBoxRight, i_rStyle.nBoxRight),
                     i_vcLineColor=>NVL(i_vcBoxRightColor, i_rStyle.vcBoxRightColor),
                     i_rStyle     =>i_rStyle
                    );
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_APPLY_REPORT_STYLE(i_nStackPos      IN NUMBER,
                                  i_nX             IN NUMBER,
                                  i_nBottom        IN NUMBER
                                 ) IS
    rStyle PK_JRXML2PDF_TYPES.tSimpleStyle;
  BEGIN
    FOR i IN 1..lReportStack(i_nStackPos).lPageFrameMarkers.COUNT LOOP
      rStyle:=lReportStack(i_nStackPos).lPageFrameMarkers(i).rStyle;
      -- Render a transparent box around the whole report-area
      PR_RENDER_BOX(i_nX              =>i_nX,
                    i_nY              =>lReportStack(i_nStackPos).lPageFrameMarkers(i).nBorderTop,
                    i_nWidth          =>lReportStack(i_nStackPos).lPageFrameMarkers(i).nBorderWidth,
                    i_nHeight         =>i_nBottom-lReportStack(i_nStackPos).lPageFrameMarkers(i).nBorderTop,
                    i_vcBgColor       =>rStyle.vcBgColor,
                    i_vcFgColor       =>rStyle.vcFgColor,
                    i_nBoxTop         =>rStyle.nBoxTop,
                    i_nBoxLeft        =>rStyle.nBoxLeft,
                    i_nBoxBottom      =>rStyle.nBoxBottom,
                    i_nBoxRight       =>rStyle.nBoxRight,
                    i_vcBoxTopColor   =>rStyle.vcBoxTopColor,
                    i_vcBoxLeftColor  =>rStyle.vcBoxLeftColor,
                    i_vcBoxBottomColor=>rStyle.vcBoxBottomColor,
                    i_vcBoxRightColor =>rStyle.vcBoxRightColor,
                    i_vcOpaque        =>rStyle.vcOpaque,
                    i_rStyle          =>NULL
                   );
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RENDER_TEXT(i_nX               IN NUMBER,
                          i_nY               IN NUMBER,
                          i_nWidth           IN NUMBER,
                          i_nHeight          IN NUMBER,
                          i_vcText           IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                          i_vcFont           IN PK_JRXML2PDF_TYPES.tFont,
                          i_nFontSize        IN NUMBER,
                          i_vcFontStyle      IN PK_JRXML2PDF_TYPES.tFontStyle,
                          i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcVerticalAlign  IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcBgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcFgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_nBoxTop          IN NUMBER,
                          i_nBoxLeft         IN NUMBER,
                          i_nBoxBottom       IN NUMBER,
                          i_nBoxRight        IN NUMBER,
                          i_nTopPadding      IN NUMBER,
                          i_nLeftPadding     IN NUMBER,
                          i_nBottomPadding   IN NUMBER,
                          i_nRightPadding    IN NUMBER,
                          i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                          i_nLineSpacing     IN NUMBER,
                          i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo,
                          i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle,
                          i_bMayPageBreak    IN BOOLEAN DEFAULT FALSE,
                          i_rArea            IN PK_JRXML2PDF_TYPES.tArea DEFAULT NULL,
                          i_vcRotation       IN PK_JRXML2PDF_TYPES.tAttribute DEFAULT NULL)
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    rArea     PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    nHeight   NUMBER;
    nWidth    NUMBER;
    nRotation NUMBER;
    PROCEDURE PR_SET_FONT_AND_COLOR IS
    BEGIN
      -- set font
      PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont   =>NVL(i_vcFont, i_rStyle.vcFont),
                                    i_vcStyle  =>COALESCE(i_vcFontStyle, i_rStyle.vcFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL),
                                    i_nSize    =>COALESCE(i_nFontSize, i_rStyle.nFontSize, 10)
                                   );
      AS_PDF3_MOD.set_color(NVL(REPLACE(COALESCE(i_vcFgColor, i_rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK),'#',''), PK_JRXML2PDF_TYPES.BLACK));
    END;
    PROCEDURE PR_RENDER_BOX_FOR_TEXT(i_nY      IN NUMBER,
                                     i_nHeight IN NUMBER) IS
    BEGIN
      PR_RENDER_BOX(i_nX               =>i_nX,
                    i_nY               =>i_nY,
                    i_nWidth           =>i_nWidth,
                    i_nHeight          =>i_nHeight,
                    i_vcBgColor        =>i_vcBgColor,
                    i_vcFgColor        =>i_vcFgColor,
                    i_nBoxTop          =>i_nBoxTop,
                    i_nBoxLeft         =>i_nBoxLeft,
                    i_nBoxBottom       =>i_nBoxBottom,
                    i_nBoxRight        =>i_nBoxRight,
                    i_vcBoxTopColor    =>i_vcBoxTopColor,
                    i_vcBoxLeftColor   =>i_vcBoxLeftColor,
                    i_vcBoxBottomColor =>i_vcBoxBottomColor,
                    i_vcBoxRightColor  =>i_vcBoxRightColor,
                    i_vcOpaque         =>i_vcOpaque,
                    i_rStyle           =>i_rStyle);
    END;
    PROCEDURE PR_WRITE_TEXT_TO_BOX(i_nMaxHeight      IN NUMBER,
                                   i_nLineSpacing    IN NUMBER,
                                   i_nMaxWidth       IN NUMBER,
                                   i_vcAlignment     IN PK_JRXML2PDF_TYPES.tAlignment,
                                   i_vcVerticalAlign IN PK_JRXML2PDF_TYPES.tAlignment
                                  ) IS
      lText          PK_JRXML2PDF_TYPES.tTextPieceList;
      nX             NUMBER:=i_nX;
      nxStart        NUMBER;
      nY             NUMBER;
      nCurrentHeight NUMBER:=0;
      nGroup         NUMBER:=0;
      nLineSpacing   NUMBER;
      vcAlignment    PK_JRXML2PDF_TYPES.tAlignment:=LOWER(i_vcAlignment);
      nHeight        NUMBER:=0;
      nBaseY         NUMBER;
      bTrackY        BOOLEAN:=FALSE;
      bFirstPage     BOOLEAN:=TRUE;
      nStopHeight    NUMBER;
      nStartY        NUMBER;
      FUNCTION FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  IN NUMBER,
                                            i_nCurrentY IN NUMBER,
                                            i_nTopY     IN NUMBER)
      RETURN NUMBER IS
        nHeight  NUMBER:=0;
        i        PLS_INTEGER:=i_nTextPos;
        bNoFit   BOOLEAN:=FALSE;
      BEGIN
        IF i_bMayPageBreak THEN
          LOOP
            EXIT WHEN i>lText.COUNT;
            IF NOT FK_FITS_IN_PAGE(i_nCurrentY, nHeight+
                                                lText(i).nHeight+
                                                NVL(i_nTopPadding,0)+
                                                NVL(i_nBottomPadding,0)
                                  ) THEN
              bNoFit:=TRUE;
              EXIT;
            END IF;
            nHeight:=nHeight+lText(i).nHeight;
            i:=i+1;
          END LOOP;
        END IF;
        IF     bFirstPage
          AND nHeight<i_nHeight THEN
          nHeight:=i_nHeight;
        ELSIF bFirstPage THEN
          nHeight:=nHeight+
                   NVL(i_nBottomPadding,0)+
                   NVL(i_nTopPadding,0);
        ELSIF bNoFit AND nHeight<i_nHeight THEN
          nHeight:=i_nHeight;
        END IF;
        -- now render the box
        PR_RENDER_BOX_FOR_TEXT(i_nY     =>i_nTopY,
                               i_nHeight=>nHeight+
                                          CASE WHEN bFirstPage THEN
                                            0
                                          ELSE
                                            NVL(i_nBottomPadding,0)+
                                            NVL(i_nTopPadding,0)
                                          END
                              );
        bFirstPage:=FALSE;
        RETURN nHeight;
      END;
      PROCEDURE PR_TEXT_NO_ROTATION IS
      BEGIN
        IF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.MIDDLE_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxHeight THEN
            nY:=i_nY+(i_nMaxHeight-nHeight)/2;
          ELSE
            nY:=i_nY;
          END IF;
        ELSIF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.BOTTOM_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxHeight THEN
            nY:=i_nY+(i_nMaxHeight-nHeight);
          ELSE
            nY:=i_nY;
          END IF;
        ELSE
          nY:=i_nY;
        END IF;
        nStartY:=nY;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Alignment vertical/horizontal/nY ' || i_vcVerticalAlign || '/' || vcAlignment || '/' || nY);
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('No. of text parts ' || lText.COUNT);
        END IF;
        -- calculate the positions for the next possible page-breaks
        nStopHeight:=FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  =>1,
                                                  i_nCurrentY =>nY,
                                                  i_nTopY     =>i_nY
                                                 );
        -- write the textparts
        FOR i IN 1..lText.COUNT LOOP
          IF    INSTR(vcAlignment, PK_JRXML2PDF_TYPES.RIGHT_ALIGN ) > 0
             OR INSTR(vcAlignment, PK_JRXML2PDF_TYPES.END_ALIGN ) > 0 THEN
            nX:=nXstart+i_nMaxWidth-lText(i).nLength;
          ELSIF INSTR(vcAlignment, PK_JRXML2PDF_TYPES.CENTER_ALIGN ) > 0 THEN
            nX:=nXstart+(i_nMaxWidth-lText(i).nLength) / 2;
          ELSE
            nX:=nXStart;
          END IF;
          AS_PDF3_MOD.put_txt(p_x               =>nX,
                              p_y               =>nBaseY-nY,
                              p_txt             =>lText(i).vcText);
          IF i_bMayPageBreak AND i<lText.COUNT THEN
            nY:=nY+lText(i).nHeight;
            IF NOT FK_FITS_IN_PAGE(nY, lText(i+1).nHeight+NVL(i_nBottomPadding,0)+
                                                          NVL(i_nTopPadding,0)) THEN
              rArea.nY:=nStartY+nStopHeight;
              PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                           i_nStackPos     =>lReportStack.COUNT,
                                           i_bOneRecordBack=>FALSE);
              nY:=rArea.nY;
              nStartY:=rArea.nY;
              -- after a page-break, the new Y-positin must be tracked and returned
              bTrackY:=TRUE;
              -- calculate the positions for the next possible page-breaks
              nStopHeight:=FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  =>i+1,
                                                        i_nCurrentY =>nY,
                                                        i_nTopY     =>nY
                                                       );
              -- reset font and color, maybe changed by footers and headers
              PR_SET_FONT_AND_COLOR;
            END IF;
          ELSE
            nY:=nY+lText(i).nHeight;
          END IF;
        END LOOP;
      END;
      PROCEDURE PR_TEXT_90_ROTATION IS
      BEGIN
        IF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.MIDDLE_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxWidth THEN
            nX:=nXStart+(i_nMaxWidth-nHeight)/2;
          ELSE
            nX:=nXStart;
          END IF;
        ELSIF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.BOTTOM_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxWidth THEN
            nX:=nXStart+(i_nMaxHeight-nHeight);
          ELSE
            nX:=nXStart;
          END IF;
        ELSE
          nX:=nXStart;
        END IF;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Alignment vertical/horizontal/nY ' || i_vcVerticalAlign || '/' || vcAlignment || '/' || nY);
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('No. of text parts ' || lText.COUNT);
        END IF;
        -- calculate the positions for the next possible page-breaks
        nStopHeight:=FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  =>1,
                                                  i_nCurrentY =>nY,
                                                  i_nTopY     =>i_nY
                                                 );
        -- write the textparts
        FOR i IN 1..lText.COUNT LOOP
          IF    INSTR(vcAlignment, PK_JRXML2PDF_TYPES.RIGHT_ALIGN ) > 0
             OR INSTR(vcAlignment, PK_JRXML2PDF_TYPES.END_ALIGN ) > 0 THEN
            nY:=i_nY+lText(i).nLength;
          ELSIF INSTR(vcAlignment, PK_JRXML2PDF_TYPES.CENTER_ALIGN ) > 0 THEN
            nY:=i_nY+i_nHeight-(i_nMaxHeight-lText(i).nLength) / 2;
          ELSE
            nY:=i_nY+i_nHeight;
          END IF;
          AS_PDF3_MOD.put_txt(p_x               =>nX+lText(i).nHeight*0.66,
                              p_y               =>nBaseY-nY+lText(i).nHeight*0.80,
                              p_txt             =>lText(i).vcText,
                              p_degrees_rotation=>90);
          nX:=nX+lText(i).nHeight;
        END LOOP;
      END;
      PROCEDURE PR_TEXT_180_ROTATION IS
        lDummy PK_JRXML2PDF_TYPES.tTextPiece;
      BEGIN
        IF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.MIDDLE_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxHeight THEN
            nY:=i_nY+(i_nMaxHeight-nHeight)/2;
          ELSE
            nY:=i_nY;
          END IF;
        ELSIF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.BOTTOM_ALIGN THEN
          nY:=i_nY;
        ELSE
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxHeight THEN
            nY:=i_nY+(i_nMaxHeight-nHeight);
          ELSE
            nY:=i_nY;
          END IF;
        END IF;
        nStartY:=nY;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Alignment vertical/horizontal/nY ' || i_vcVerticalAlign || '/' || vcAlignment || '/' || nY);
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('No. of text parts ' || lText.COUNT);
        END IF;
        -- calculate the positions for the next possible page-breaks
        nStopHeight:=FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  =>1,
                                                  i_nCurrentY =>nY,
                                                  i_nTopY     =>i_nY
                                                 );
        -- upside-down, revert text-pieces
        FOR i IN 1..TRUNC(lText.COUNT/2) LOOP
          lDummy:=lText(i);
          lText(i):=lText(lText.COUNT-i+1);
          lText(lText.COUNT-i+1):=lDummy;
        END LOOP;
        -- write the textparts
        FOR i IN 1..lText.COUNT LOOP
          IF    INSTR(vcAlignment, PK_JRXML2PDF_TYPES.RIGHT_ALIGN ) > 0
             OR INSTR(vcAlignment, PK_JRXML2PDF_TYPES.END_ALIGN ) > 0 THEN
            nX:=nXstart+lText(i).nLength;
          ELSIF INSTR(vcAlignment, PK_JRXML2PDF_TYPES.CENTER_ALIGN ) > 0 THEN
            nX:=nXstart+(i_nMaxWidth-lText(i).nLength) / 2 + lText(i).nLength;
          ELSE
            nX:=nXStart+nWidth;
          END IF;
          AS_PDF3_MOD.put_txt(p_x               =>nX,
                              p_y               =>nBaseY-nY+lText(i).nHeight*0.66,
                              p_txt             =>lText(i).vcText,
                              p_degrees_rotation=>180);
          nY:=nY+lText(i).nHeight;
        END LOOP;
      END;
      PROCEDURE PR_TEXT_270_ROTATION IS
        lDummy PK_JRXML2PDF_TYPES.tTextPiece;
      BEGIN
        IF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.MIDDLE_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxWidth THEN
            nX:=nXStart+(i_nMaxWidth-nHeight)/2;
          ELSE
            nX:=nXStart;
          END IF;
        ELSIF i_vcVerticalAlign=PK_JRXML2PDF_TYPES.TOP_ALIGN THEN
          -- calculate total text height
          FOR i IN 1..lText.COUNT LOOP
            nHeight:=nHeight+lText(i).nHeight;
          END LOOP;
          IF nHeight<i_nMaxWidth THEN
            nX:=nXStart+(i_nMaxWidth-nHeight);
          ELSE
            nX:=nXStart;
          END IF;
        ELSE
          nX:=nXStart;
        END IF;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Alignment vertical/horizontal/nY ' || i_vcVerticalAlign || '/' || vcAlignment || '/' || nY);
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('No. of text parts ' || lText.COUNT);
        END IF;
        -- calculate the positions for the next possible page-breaks
        nStopHeight:=FK_CALC_BREAK_AND_RENDER_BOX(i_nTextPos  =>1,
                                                  i_nCurrentY =>nY,
                                                  i_nTopY     =>i_nY
                                                 );
        -- upside-down, revert text-pieces
        FOR i IN 1..TRUNC(lText.COUNT/2) LOOP
          lDummy:=lText(i);
          lText(i):=lText(lText.COUNT-i+1);
          lText(lText.COUNT-i+1):=lDummy;
        END LOOP;
        -- write the textparts
        FOR i IN 1..lText.COUNT LOOP
          IF    INSTR(vcAlignment, PK_JRXML2PDF_TYPES.RIGHT_ALIGN ) > 0
             OR INSTR(vcAlignment, PK_JRXML2PDF_TYPES.END_ALIGN ) > 0 THEN
            nY:=i_nY+i_nHeight-lText(i).nLength;
          ELSIF INSTR(vcAlignment, PK_JRXML2PDF_TYPES.CENTER_ALIGN ) > 0 THEN
            nY:=i_nY+(i_nMaxHeight-lText(i).nLength) / 2;
          ELSE
            nY:=i_nY;
          END IF;
          AS_PDF3_MOD.put_txt(p_x               =>nX+lText(i).nHeight*0.20,
                              p_y               =>nBaseY-nY+lText(i).nHeight*0.80,
                              p_txt             =>lText(i).vcText,
                              p_degrees_rotation=>270);
          nX:=nX+lText(i).nHeight;
        END LOOP;
      END;
    BEGIN
      nBaseY:=rPageSetup.nPageHeight
              -rPageSetup.nTopMargin
              -AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)
              -COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0);
      nXStart:=rPageSetup.nLeftMargin+i_nX+COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0);
      nx:=nXStart;
      nLineSpacing:=(NVL(i_nLineSpacing, PK_JRXML2PDF_TYPES.MIN_LINE_SPACING)-1)*AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
      IF    nRotation IS NULL
         OR nRotation=180 THEN
        PK_JRXML2PDF_UTIL.PR_GET_TEXT_PIECES(io_lText          =>lText,
                                             io_nCurrentHeight =>nCurrentHeight,
                                             io_nX             =>nX,
                                             i_vcText          =>i_vcText,
                                             i_nMaxHeight      =>CASE WHEN i_bMayPageBreak THEN
                                                                   99999
                                                                 ELSE
                                                                   i_nMaxheight
                                                                 END,
                                             io_nGroup         =>nGroup,
                                             i_nLineSpacing    =>nLineSpacing,
                                             i_nXStart         =>nXStart,
                                             i_nMaxWidth       =>i_nMaxWidth
                                            );
      ELSE
        -- switch width and height
        PK_JRXML2PDF_UTIL.PR_GET_TEXT_PIECES(io_lText          =>lText,
                                             io_nCurrentHeight =>nCurrentHeight,
                                             io_nX             =>nX,
                                             i_vcText          =>i_vcText,
                                             i_nMaxHeight      =>CASE WHEN i_bMayPageBreak THEN
                                                                   99999
                                                                 ELSE
                                                                   i_nMaxWidth
                                                                 END,
                                             io_nGroup         =>nGroup,
                                             i_nLineSpacing    =>nLineSpacing,
                                             i_nXStart         =>nXStart,
                                             i_nMaxWidth       =>i_nMaxHeight
                                            );
      END IF;
      IF nRotation IS NULL THEN
        PR_TEXT_NO_ROTATION;
      ELSIF nRotation=90 THEN
        PR_TEXT_90_ROTATION;
      ELSIF nRotation=180 THEN
        PR_TEXT_180_ROTATION;
      ELSIF nRotation=270 THEN
        PR_TEXT_270_ROTATION;
      END IF;
      IF bTrackY THEN
        rArea.nY:=nY;
      END IF;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Text ' || i_nX || '-' || i_nY || '-' || i_nWidth || '-' || i_nHeight|| '-' || COALESCE(i_vcFgColor, i_rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK) || '-' || i_vcText);
    END IF;
    PR_SET_FONT_AND_COLOR;
    -- Rotation
    IF i_vcRotation IS NOT NULL THEN
      IF i_vcRotation='UpsideDown' THEN
        nRotation:=180;
      ELSIF i_vcRotation='Left' THEN
        nRotation:=90;
      ELSIF i_vcRotation='Right' THEN
        nRotation:=270;
      END IF;
    END IF;
    nHeight:=i_nHeight-COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0)
                      -COALESCE(i_nBottomPadding, i_rStyle.nBottomPadding, 0);
    nWidth:=i_nWidth-COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0)
                    -COALESCE(i_nRightPadding, i_rStyle.nRightPadding, 0);
    PR_WRITE_TEXT_TO_BOX(i_nMaxHeight      =>nHeight,
                         i_nLineSpacing    =>COALESCE(i_nLineSpacing, i_rStyle.nLineSpacing, PK_JRXML2PDF_TYPES.MIN_LINE_SPACING),
                         i_nMaxWidth       =>nWidth,
                         i_vcAlignment     =>LOWER(COALESCE(i_vcAlignment, i_rStyle.vcAlignment, PK_JRXML2PDF_TYPES.LEFT_ALIGN)),
                         i_vcVerticalAlign =>LOWER(COALESCE(i_vcVerticalAlign, i_rStyle.vcVerticalAlign, PK_JRXML2PDF_TYPES.TOP_ALIGN))
                        );
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Text finished');
    END IF;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_BUILD_HTML_ATTRIB_LIST(i_vcAttribs IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tAttributeList IS
    lAttribs     PK_JRXML2PDF_TYPES.tAttributeList;
    vcAllAttribs PK_JRXML2PDF_TYPES.tMaxVarchar2:=TRIM(i_vcAttribs);
    vcOneAttrib  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcName       PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcValue      PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(' Attribs: [' || vcAllAttribs ||  ']');
    END IF;
    IF vcAllAttribs LIKE 'style="%' THEN
      -- only check the style-attributes
      vcAllAttribs:=REPLACE(REPLACE(vcAllAttribs, 'style="', ''), '"', '');
      LOOP
        vcOneAttrib:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcAllAttribs, ';');
        EXIT WHEN vcOneAttrib IS NULL;
        vcName:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcOneAttrib, ':');
        vcValue:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcOneAttrib, ':');
        IF    vcName IS NOT NULL
           AND vcValue IS NOT NULL THEN
          lAttribs(TRIM(vcName)):=TRIM(vcValue);
        END IF;
      END LOOP;
    END IF;
    RETURN lAttribs;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_TOKENIZE_HTML(i_nFontSize IN NUMBER,
                            i_vcText    IN VARCHAR2,
                            i_vcColor   IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tHtmlTree IS
    lResult         PK_JRXML2PDF_TYPES.tHtmlTree;
    nPos            NUMBER:=0;
    nTagEnd         NUMBER;
    nLength         NUMBER:=LENGTH(i_vcText);
    vcText          PK_JRXML2PDF_TYPES.tMaxVarchar2:=i_vcText;
    bInList         BOOLEAN:=FALSE;
    nListIndex      NUMBER;
    PROCEDURE PR_FIT_TEXT(io_rPiece IN OUT PK_JRXML2PDF_TYPES.tHtmlPiece, i_vcText IN VARCHAR2) IS
      vcText PK_JRXML2PDF_TYPES.tMaxVarchar2:=i_vcText;
      iPos   PLS_INTEGER;
      iPos2  PLS_INTEGER;
      vctag  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      IF NOT io_rPiece.bIsPRE THEN
        vcText:=REPLACE(REPLACE(REPLACE(vcText, CHR(10), ''), CHR(9), ''), CHR(13), '');
      END IF;
      -- remove leading spaces
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(' FIT_TEXT for tag ' || io_rPiece.vcTag || CASE WHEN io_rPiece.bIsPRE THEN 'PRE' END);
      END IF;
      IF NOT io_rPiece.bIsPRE THEN
        -- cut leading spaces
        vcText:=LTRIM(vcText);
        -- elimite double spaces
        vcText:=REPLACE(vcText, '  ', ' ');
      END IF;
      iPos:=0;
      IF vcText IS NOT NULL THEN
        LOOP
          -- extract tag
          iPos:=INSTR(vctext, '&', iPos+1);
          EXIT WHEN iPos=0;
          iPos2:=INSTR(vctext, ';', iPos);
          EXIT WHEN iPos2=0;
          vcTag:=SUBSTR(vcText, iPos,iPos2-iPos+1);
          IF lHtmlReplacements.EXISTS(vcTag) THEN
            vcText:=REPLACE(vcText, vcTag, lHtmlReplacements(vcTag));
          ELSIF vcTag LIKE '&#x%' THEN
            vcText:=REPLACE(vcText, vcTag, '\' || LPAD(TRANSLATE(vcTag, '&#x;',''), 4, '0'));
          ELSIF vcTag LIKE '&#%' THEN
            vcText:=REPLACE(vcText, vcTag, '\' || TO_CHAR(TO_NUMBER(TRANSLATE(vcTag, '&#;','')), 'FM000X'));
          END IF;
          iPos:=iPos+1;
        END LOOP;
      END IF;
      io_rPiece.vcText:=vcText;
    END;
    PROCEDURE PR_REKU_TOKENIZE_HTML(io_rMasterHtml IN OUT PK_JRXML2PDF_TYPES.tHtmlPiece, i_nLevel IN NUMBER) IS
      rPiece          PK_JRXML2PDF_TYPES.tHtmlPiece;
      rEmptyPiece     PK_JRXML2PDF_TYPES.tHtmlPiece;
      bEndTag         BOOLEAN;
      vcTag           PK_JRXML2PDF_TYPES.tMaxVarchar2;
      vcAttribs       PK_JRXML2PDF_TYPES.tMaxVarchar2;
      iTag            PLS_INTEGER;
      iPos            PLS_INTEGER;
    BEGIN
      LOOP
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(i_nLevel || ' Start');
        END IF;
        nPos:=INSTR(vcText, PK_JRXML2PDF_TYPES.HTML_LT);
        IF nPos>0 THEN
          IF nPos>1 THEN
            IF     io_rMasterHtml.vcText IS NULL
               AND lResult.lPieces.COUNT=0 THEN
              io_rMasterHtml.vcText:=SUBSTR(vcText, 1, nPos-1);
              PR_FIT_TEXT(io_rMasterHtml, SUBSTR(vcText, 1, nPos-1));
            ELSE
              -- additional text, add another text-tag
              rPiece:=io_rMasterHtml;
              rPiece.bBreak:=FALSE;
              rPiece.lSubPieces.DELETE;
              IF rPiece.vcTag IN (PK_JRXML2PDF_TYPES.HTML_H1,
                                  PK_JRXML2PDF_TYPES.HTML_H2,
                                  PK_JRXML2PDF_TYPES.HTML_H3,
                                  PK_JRXML2PDF_TYPES.HTML_H4,
                                  PK_JRXML2PDF_TYPES.HTML_P) THEN
                -- keep leading spaces
                rPiece.bIsPRE:=TRUE;
              END IF;
              rPiece.vcTag:=PK_JRXML2PDF_TYPES.HTML_TEXT;
              PR_FIT_TEXT(rpiece, SUBSTR(vcText, 1, nPos-1));
              iPos:=lResult.lPieces.COUNT+1;
              lResult.lPieces(iPos):=rPiece;
              io_rMasterHtml.lSubPieces(io_rMasterHtml.lSubPieces.COUNT+1):=iPos;
            END IF;
          END IF;
          vcText:=SUBSTR(vcText, nPos+1);
          -- Identify tag
          bEndTag:=(SUBSTR(vcText,1,1)='/');
          IF bEndTag THEN
            vcText:=SUBSTR(vcText,2);
          END IF;
          iTag:=1;
          LOOP
            EXIT WHEN vcText LIKE lhtmlTokens(iTag).vcTag || '%';
            iTag:=iTag+1;
            EXIT WHEN iTag>lhtmlTokens.COUNT;
          END LOOP;
          nPos:=INSTR(vcText, PK_JRXML2PDF_TYPES.HTML_GT);
          IF nPos>0 THEN
            IF iTag<=lhtmlTokens.COUNT THEN
              vcTag:=lhtmlTokens(iTag).vcTag;
            ELSE
              vcTag:='';
            END IF;
            vcAttribs:=SUBSTR(vcText, LENGTH(vcTag)+1, nPos-1-LENGTH(vcTag));
            vcText:=SUBSTR(vcText, nPos+1);
          END IF;
          IF vcTag IN (PK_JRXML2PDF_TYPES.HTML_UL, PK_JRXML2PDF_TYPES.HTML_OL) THEN
            -- reset list-settings
            bInList:=NOT bEndTag;
            IF vcTag=PK_JRXML2PDF_TYPES.HTML_UL THEN
              nListIndex:=-1;
            ELSE
              nListIndex:=0;
            END IF;
          END IF;
          IF     bInList
             AND vcTag=PK_JRXML2PDF_TYPES.HTML_LI THEN
            IF     nListIndex>=0
               AND NOT bEndTag THEN
              nListIndex:=nListIndex+1;
            END IF;
          END IF;
          IF NOT bEndTag THEN
            -- one level deeper
            rPiece:=rEmptyPiece;
            rPiece.bBreak:=FALSE;
            rPiece.nListIndex:=nListIndex;
            rPiece.vcTag:=vcTag;
            rPiece.lAttribs:=FK_BUILD_HTML_ATTRIB_LIST(vcAttribs);
            -- Take over the text-align-style-attribute from the master to the current if set
            IF         io_rMasterHtml.lAttribs.EXISTS('text-align')
               AND NOT rPiece.lAttribs.EXISTS('text-align') THEN
              rPiece.lAttribs('text-align'):=io_rMasterHtml.lAttribs('text-align');
            END IF;
            rPiece.bIsPRE:=(vcTag IN (PK_JRXML2PDF_TYPES.HTML_PRE, PK_JRXML2PDF_TYPES.HTML_CODE, PK_JRXML2PDF_TYPES.HTML_SPAN));
            rPiece.bInList:=bInList;
            iPos:=lResult.lPieces.COUNT+1;
            lResult.lPieces(iPos):=rPiece;
            io_rMasterHtml.lSubPieces(io_rMasterHtml.lSubPieces.COUNT+1):=iPos;
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(vcTag || ':' || (io_rMasterHtml.lSubPieces.COUNT) || ':' || iPos);
            END IF;
            PR_REKU_TOKENIZE_HTML(rPiece, i_nLevel+1);
            lResult.lPieces(iPos):=rPiece;
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(i_nLevel || ' Back from sub store in Pos/Text:' || iPos || '/' || lResult.lPieces(iPos).vcText);
            END IF;
          END IF;
        ELSE
          vcText:=NULL;
        END IF;
        EXIT WHEN bEndtag;
        EXIT WHEN vcText IS NULL;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL(i_nLevel || ' Ende');
      END IF;
    END;
  BEGIN
    lResult.lPieces(1).bIsPRE:=FALSE;
    lResult.lPieces(1).nFontSize:=i_nFontSize;
    lResult.lPieces(1).vcColor:=i_vcColor;
    lResult.lPieces(1).bBreak:=FALSE;
    IF INSTR(vcText, PK_JRXML2PDF_TYPES.HTML_LT)=0 THEN
      vcText:=PK_JRXML2PDF_TYPES.HTML_P_START || vcText || PK_JRXML2PDF_TYPES.HTML_P_END;
    END IF;
    PR_REKU_TOKENIZE_HTML(lResult.lPieces(1), 1);
    RETURN lResult;
  END;
  -- ----------------------------------------------------------------------
  PROCEDURE PR_LAYOUT_HTML(i_rHtmlSetting IN PK_JRXML2PDF_TYPES.tHtmlSettings,
                           io_lHtml       IN OUT NOCOPY PK_JRXML2PDF_TYPES.tHtmlTree,
                           i_nX           IN NUMBER,
                           i_nWidth       IN NUMBER,
                           i_vcColor      IN VARCHAR2) IS
    ALIGN_LEFT    CONSTANT NUMBER:=1;
    ALIGN_RIGHT   CONSTANT NUMBER:=2;
    ALIGN_CENTER  CONSTANT NUMBER:=3;
    ALIGN_JUSTIFY CONSTANT NUMBER:=4;
    bInList       BOOLEAN:=FALSE;
    nGroup        NUMBER:=0;
    nDummy        NUMBER;
    lGroupWidth   PK_JRXML2PDF_TYPES.tNumList;
    lGroupBreak   PK_JRXML2PDF_TYPES.tNumList;
    lWordCount    PK_JRXML2PDF_TYPES.tNumList;
    lGroupAligns  PK_JRXML2PDF_TYPES.tNumList;
    nX            NUMBER:=i_nX;
    nGroupPos     NUMBER;
    nCurrentGroup NUMBER;
    bSplitWord    BOOLEAN;
    nAlign        NUMBER;
    nMaxGroup     NUMBER:=-1;
    bBreak        BOOLEAN;
    PROCEDURE PR_GET_HTML_FONT(i_nPiece IN NUMBER, i_nMasterPiece IN NUMBER, i_vcTag IN VARCHAR2) IS
      vcFont      PK_JRXML2PDF_TYPES.tFont;
      nFontSize   NUMBER;
      vcFontStyle PK_JRXML2PDF_TYPES.tFontStyle;
      vcColor     PK_JRXML2PDF_TYPES.tColor;
      vcAttrib    PK_JRXML2PDF_TYPES.tMaxVarchar2;
      vcR         PK_JRXML2PDF_TYPES.tAttribute;
      vcG         PK_JRXML2PDF_TYPES.tAttribute;
      vcB         PK_JRXML2PDF_TYPES.tAttribute;
    BEGIN
      IF i_nMasterPiece IS NULL THEN
        vcFontStyle:=PK_JRXML2PDF_TYPES.FONT_NORMAL;
        vcFont:=i_rHtmlSetting.vcFont;
      ELSE
        vcFontStyle:=io_lHtml.lPieces(i_nMasterPiece).vcFontStyle;
        vcFont:=io_lHtml.lPieces(i_nMasterPiece).vcFont;
      END IF;
      IF i_vcTag IN (PK_JRXML2PDF_TYPES.HTML_B, PK_JRXML2PDF_TYPES.HTML_STRONG) THEN
        vcFontStyle:=PK_JRXML2PDF_TYPES.FONT_BOLD;
      END IF;
      IF i_vcTag=PK_JRXML2PDF_TYPES.HTML_H1 THEN
        nFontSize:=i_rHtmlSetting.nH1FontSize;
      ELSIF i_vcTag=PK_JRXML2PDF_TYPES.HTML_H2 THEN
        nFontSize:=i_rHtmlSetting.nH2FontSize;
      ELSIF i_vcTag=PK_JRXML2PDF_TYPES.HTML_H3 THEN
        nFontSize:=i_rHtmlSetting.nH3FontSize;
      ELSIF i_vcTag=PK_JRXML2PDF_TYPES.HTML_H4 THEN
        nFontSize:=i_rHtmlSetting.nH4FontSize;
      ELSIF i_vcTag=PK_JRXML2PDF_TYPES.HTML_P THEN
        nFontSize:=i_rHtmlSetting.nFontSize;
      ELSIF i_nMasterPiece IS NOT NULL THEN
        nFontSize:=io_lHtml.lPieces(i_nMasterPiece).nFontSize;
      ELSE
        nFontSize:=i_rHtmlSetting.nFontSize;
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Attrib-COUNT:' || io_lHtml.lPieces(i_nPiece).lAttribs.COUNT);
      END IF;
      vcAttrib:=io_lHtml.lPieces(i_nPiece).lAttribs.FIRST;
      WHILE vcAttrib IS NOT NULL LOOP
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Attrib:' || vcAttrib || '#' || io_lHtml.lPieces(i_nPiece).lAttribs(vcAttrib));
        END IF;
        vcAttrib:=io_lHtml.lPieces(i_nPiece).lAttribs.NEXT(vcAttrib);
      END LOOP;
      IF    io_lHtml.lPieces(i_nPiece).lAttribs.EXISTS('font-size') THEN
        vcAttrib:=io_lHtml.lPieces(i_nPiece).lAttribs('font-size');
        IF vcAttrib='xx-large' THEN
          nFontSize:=i_rHtmlSetting.nXXLargeFontSize;
        ELSIF vcAttrib='x-large' THEN
          nFontSize:=i_rHtmlSetting.nXLargeFontSize;
        ELSIF vcAttrib='large' THEN
          nFontSize:=i_rHtmlSetting.nLargeFontSize;
        ELSIF vcAttrib='medium' THEN
          nFontSize:=i_rHtmlSetting.nMediumFontSize;
        ELSIF vcAttrib='small' THEN
          nFontSize:=i_rHtmlSetting.nSmallFontSize;
        ELSIF vcAttrib='x-small' THEN
          nFontSize:=i_rHtmlSetting.nXSmallFontSize;
        ELSIF vcAttrib='xx-small' THEN
          nFontSize:=i_rHtmlSetting.nXXSmallFontSize;
        ELSIF vcAttrib='smaller' THEN
          nFontSize:=i_rHtmlSetting.nSmallerFontSize;
        ELSIF vcAttrib='larger' THEN
          nFontSize:=i_rHtmlSetting.nLargerFontSize;
        ELSE
          -- a number
          BEGIN
            nFontSize:=TO_NUMBER(REPLACE(vcAttrib, PK_JRXML2PDF_TYPES.PIXEL, ''));
          EXCEPTION
            WHEN OTHERS THEN
              nFontSize:=i_rHtmlSetting.nFontSize;
          END;
        END IF;
      END IF;
      IF    io_lHtml.lPieces(i_nPiece).lAttribs.EXISTS('color') THEN
        vcColor:=REPLACE(io_lHtml.lPieces(i_nPiece).lAttribs('color'), '#');
        IF UPPER(vcColor) LIKE 'RGB(%' THEN
          vcColor:=REPLACE(UPPER(vcColor), 'RGB');
          vcR:=REPLACE(PK_JRXML2PDF_UTIL.FK_SPLIT(vcColor, ','), '(');
          vcG:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcColor, ',');
          vcB:=PK_JRXML2PDF_UTIL.FK_SPLIT(vcColor, ')');
          vcColor:=TO_CHAR(TO_NUMBER(vcR), 'FM0X') ||
                   TO_CHAR(TO_NUMBER(vcG), 'FM0X') ||
                   TO_CHAR(TO_NUMBER(vcB), 'FM0X');
        END IF;
      ELSIF i_nMasterPiece IS NOT NULL THEN
        vcColor:=io_lHtml.lPieces(i_nMasterPiece).vcColor;
      ELSE
        vcColor:=i_vcColor;
      END IF;
      IF i_vcTag=PK_JRXML2PDF_TYPES.HTML_PRE THEN
        vcFont:=PK_JRXML2PDF_TYPES.COURIER_NEW;
      ELSIF io_lHtml.lPieces(i_nPiece).lAttribs.EXISTS('font-family') THEN
        vcFont:=io_lHtml.lPieces(i_nPiece).lAttribs('font-family');
        IF INSTR(vcFont, ',')>0 THEN
          vcFont:=SUBSTR(vcFont, 1, INSTR(vcFont, ',')-1);
        END IF;
      END IF;
      io_lHtml.lPieces(i_nPiece).vcFont:=vcFont;
      io_lHtml.lPieces(i_nPiece).nFontSize:=nFontSize;
      io_lHtml.lPieces(i_nPiece).vcFontStyle:=vcFontStyle;
      io_lHtml.lPieces(i_nPiece).vcColor:=vcColor;
      -- set font
      PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>vcFont,
                                    i_vcStyle =>vcFontStyle,
                                    i_nSize   =>nFontSize
                                   );
    END;
    PROCEDURE PR_REKU_LAYOUT_HTML(i_nMasterPiece IN NUMBER, i_nPiece IN NUMBER, i_nLevel IN NUMBER) IS
      bBreak BOOLEAN:=FALSE;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('>'|| RPAD(' ', i_nLevel*2, ' ') || io_lHtml.lPieces(i_nPiece).vcTag ||':' || io_lHtml.lPieces(i_nPiece).vcText);
      END IF;
      IF io_lHtml.lPieces(i_nPiece).vcTag IN (PK_JRXML2PDF_TYPES.HTML_UL, PK_JRXML2PDF_TYPES.HTML_OL) THEN
        bInList:=TRUE;
      END IF;
      IF io_lHtml.lPieces(i_nPiece).vcTag IN (PK_JRXML2PDF_TYPES.HTML_BR,PK_JRXML2PDF_TYPES.HTML_LI) THEN
        IF bInList THEN
          nx:=i_nX+i_rHtmlSetting.nListIndent;
        ELSE
          nx:=i_nX;
        END IF;
        nGroup:=nGroup+1;
        IF io_lHtml.lPieces(i_nPiece).vcTag=PK_JRXML2PDF_TYPES.HTML_BR THEN
          IF i_nPiece>1 THEN
            bBreak:=TRUE;
          END IF;
        END IF;
      ELSIF io_lHtml.lPieces(i_nPiece).vcTag IN (PK_JRXML2PDF_TYPES.HTML_H1,
                                                 PK_JRXML2PDF_TYPES.HTML_H2,
                                                 PK_JRXML2PDF_TYPES.HTML_H3,
                                                 PK_JRXML2PDF_TYPES.HTML_H4,
                                                 PK_JRXML2PDF_TYPES.HTML_P,
                                                 PK_JRXML2PDF_TYPES.HTML_BR) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Tag is ' || io_lHtml.lPieces(i_nPiece).vcTag);
        END IF;
        -- new line, but only if last tag was not a new line
        IF i_nMasterPiece IS NOT NULL THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('AND Master Tag is ' || io_lHtml.lPieces(i_nMasterPiece).vcTag);
          END IF;
          IF    io_lHtml.lPieces(i_nMasterPiece).vcTag NOT IN (PK_JRXML2PDF_TYPES.HTML_LI)
             OR io_lHtml.lPieces(i_nMasterPiece).vcTag IS NULL THEN
            IF bInList THEN
              nx:=i_nX+i_rHtmlSetting.nListIndent;
            ELSE
              nx:=i_nX;
            END IF;
            nGroup:=nGroup+1;
            -- first piece and first group do not break
            IF i_nPiece>1 THEN
              bBreak:=TRUE;
            END IF;
          END IF;
        END IF;
      END IF;
      IF nGroup=0 THEN
        nGroup:=1;
      END IF;
      io_lHtml.lPieces(i_nPiece).nGroup:=nGroup;
      io_lHtml.lPieces(i_nPiece).bBreak:=bBreak;
      PR_GET_HTML_FONT(i_nPiece, i_nMasterPiece, io_lHtml.lPieces(i_nPiece).vcTag);
      IF     i_nPiece=1
         AND io_lHtml.lPieces(i_nPiece).vcTag IS NULL
         AND io_lHtml.lPieces(i_nPiece).vcText IS NULL THEN
          -- dummy-piece at the beginning, set size to 0
        io_lHtml.lPieces(i_nPiece).nHeight:=0;
      ELSE
        io_lHtml.lPieces(i_nPiece).nHeight:=AS_PDF3_MOD.GET(AS_PDF3_MOD.c_get_fontsize);
      END IF;
      io_lHtml.lPieces(i_nPiece).nX:=nX;
      IF io_lHtml.lPieces(i_nPiece).vcText IS NOT NULL THEN
        -- check for alignment
        IF io_lHtml.lPieces(i_nPiece).lAttribs.EXISTS('text-align') THEN
          bSplitWord:=io_lHtml.lPieces(i_nPiece).lAttribs('text-align')='justify';
        ELSE
          bSplitWord:=FALSE;
        END IF;
        -- layout the complete text in lines
        PK_JRXML2PDF_UTIL.PR_GET_TEXT_PIECES(io_lText          =>io_lHtml.lPieces(i_nPiece).lTextPieces,
                                             io_nCurrentHeight =>nDummy,
                                             io_nX             =>nX,
                                             i_vcText          =>io_lHtml.lPieces(i_nPiece).vcText,
                                             i_nMaxHeight      =>30,
                                             io_nGroup         =>nGroup,
                                             i_nLineSpacing    =>0,
                                             i_nXStart         =>CASE WHEN bInList THEN
                                                                   i_nX+i_rHtmlSetting.nListIndent
                                                                 ELSE
                                                                   i_nX
                                                                 END,
                                             i_nMaxWidth       =>i_nWidth,
                                             i_bSplitByWord    =>bSplitWord
                                            );
      END IF;
      FOR i IN 1..io_lHtml.lPieces(i_nPiece).lSubPieces.COUNT LOOP
        PR_REKU_LAYOUT_HTML(i_nPiece, io_lHtml.lPieces(i_nPiece).lSubPieces(i), i_nLevel+1);
      END LOOP;
      IF io_lHtml.lPieces(i_nPiece).vcTag IN (PK_JRXML2PDF_TYPES.HTML_UL, PK_JRXML2PDF_TYPES.HTML_OL) THEN
        bInList:=FALSE;
      END IF;
    END;
  BEGIN
    PR_REKU_LAYOUT_HTML(NULL, 1,1);
    -- restore widths for each group
    FOR i IN 1..io_lHtml.lPieces.COUNT LOOP
      IF NOT lGroupWidth.EXISTS(io_lHtml.lPieces(i).nGroup-1) THEN
        lGroupBreak(io_lHtml.lPieces(i).nGroup-1):=CASE WHEN io_lHtml.lPieces(i).bBreak THEN 1 ELSE 0 END;
      ELSIF io_lHtml.lPieces(i).bBreak THEN
        lGroupBreak(io_lHtml.lPieces(i).nGroup-1):=1;
      END IF;
      FOR j IN 1..io_lHtml.lPieces(i).lTextPieces.COUNT LOOP
        IF NOT lGroupWidth.EXISTS(io_lHtml.lPieces(i).lTextPieces(j).nGroup) THEN
          lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=io_lHtml.lPieces(i).lTextPieces(j).nLength;
          lWordCount(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=1;
          -- first match defines alignment
          IF io_lHtml.lPieces(i).lAttribs.EXISTS('text-align') THEN
            IF io_lHtml.lPieces(i).lAttribs('text-align')='center' THEN
              lGroupAligns(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=ALIGN_CENTER;
            ELSIF io_lHtml.lPieces(i).lAttribs('text-align')='right' THEN
              lGroupAligns(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=ALIGN_RIGHT;
            ELSIF io_lHtml.lPieces(i).lAttribs('text-align')='justify' THEN
              lGroupAligns(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=ALIGN_JUSTIFY;
            ELSE
              lGroupAligns(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=ALIGN_LEFT;
            END IF;
          ELSE
            lGroupAligns(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=ALIGN_LEFT;
          END IF;
        ELSE
          lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup)+io_lHtml.lPieces(i).lTextPieces(j).nLength;
          lWordCount(io_lHtml.lPieces(i).lTextPieces(j).nGroup):=lWordCount(io_lHtml.lPieces(i).lTextPieces(j).nGroup)+1;
        END IF;
      END LOOP;
    END LOOP;
    nGroupPos:=0;
    nCurrentGroup:=-1;
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Count pieces ' || io_lHtml.lPieces.COUNT);
    END IF;
    IF io_lHtml.lPieces.COUNT>0 THEN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Count textpieces ' || io_lHtml.lPieces(io_lHtml.lPieces.COUNT).lTextPieces.COUNT);
      END IF;
      nDummy:=io_lHtml.lPieces.COUNT;
      WHILE nDummy>0 LOOP
        IF io_lHtml.lPieces(nDummy).lTextPieces.COUNT>0 THEN
          nMaxGroup:=io_lHtml.lPieces(nDummy).lTextPieces(io_lHtml.lPieces(nDummy).lTextPieces.COUNT).nGroup;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Max group ' || nMaxGroup);
          END IF;
          nDummy:=-1;
        ELSE
          nDummy:=nDummy-1;
        END IF;
      END LOOP;
    END IF;
    FOR i IN 1..io_lHtml.lPieces.COUNT LOOP
      FOR j IN 1..io_lHtml.lPieces(i).lTextPieces.COUNT LOOP
        IF nCurrentGroup!=io_lHtml.lPieces(i).lTextPieces(j).nGroup THEN
          nGroupPos:=0;
          nCurrentGroup:=io_lHtml.lPieces(i).lTextPieces(j).nGroup;
          nAlign:=lGroupAligns(nCurrentGroup);
          IF lGroupBreak.EXISTS(nCurrentGroup) THEN
            bBreak:=lGroupBreak(nCurrentGroup)=1;
          ELSE
            bBreak:=FALSE;
          END IF;
        END IF;
        IF lGroupWidth.EXISTS(io_lHtml.lPieces(i).lTextPieces(j).nGroup) THEN
          IF nAlign=ALIGN_CENTER THEN
            io_lHtml.lPieces(i).lTextPieces(j).nX:=io_lHtml.lPieces(i).lTextPieces(j).nX+(i_nWidth-lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup))/2;
          ELSIF nAlign=ALIGN_RIGHT THEN
            io_lHtml.lPieces(i).lTextPieces(j).nX:=io_lHtml.lPieces(i).lTextPieces(j).nX+i_nWidth-lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup);
          ELSIF     nAlign=ALIGN_JUSTIFY
                AND nCurrentGroup<nMaxGroup
                AND NOT bBreak THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('group/Text ' || nCurrentGroup || ':' || io_lHtml.lPieces(i).lTextPieces(j).vcText);
            END IF;
            IF (lWordCount(io_lHtml.lPieces(i).lTextPieces(j).nGroup)-1)>0 THEN
              io_lHtml.lPieces(i).lTextPieces(j).nX:=io_lHtml.lPieces(i).lTextPieces(j).nX+((i_nWidth-lGroupWidth(io_lHtml.lPieces(i).lTextPieces(j).nGroup))/(lWordCount(io_lHtml.lPieces(i).lTextPieces(j).nGroup)-1))*nGroupPos;
            END IF;
            nGroupPos:=nGroupPos+1;
          END IF;
        END IF;
      END LOOP;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_HTML_HEIGHT(i_nX               IN NUMBER,
                               i_nY               IN NUMBER,
                               i_nWidth           IN NUMBER,
                               i_nHeight          IN NUMBER,
                               i_vcText           IN VARCHAR2,
                               i_vcFont           IN PK_JRXML2PDF_TYPES.tFont,
                               i_nFontSize        IN NUMBER,
                               i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment,
                               i_nTopPadding      IN NUMBER,
                               i_nLeftPadding     IN NUMBER,
                               i_nBottomPadding   IN NUMBER,
                               i_nRightPadding    IN NUMBER,
                               i_nLineSpacing     IN NUMBER,
                               i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle,
                               i_bEnhanced        IN BOOLEAN)
  RETURN NUMBER IS
    lResult       PK_JRXML2PDF_TYPES.tHtmlTree;
    nX            NUMBER;
    nXStart       NUMBER;
    nWidth        NUMBER;
    nOutputHeight NUMBER;
    nGroup        NUMBER:=1;
    lGroupHeight  PK_JRXML2PDF_TYPES.tNumList;
    vcLastTag     PK_JRXML2PDF_TYPES.tAttribute;
    rHtmlSettings PK_JRXML2PDF_TYPES.tHtmlSettings:=rMasterHtmlSettings;
    PROCEDURE PR_REKU_SCALE_HTML(i_rPiece IN PK_JRXML2PDF_TYPES.tHtmlPiece,
                                 i_nLevel IN NUMBER) IS
      FUNCTION FK_GET_LINE_SPACING
      RETURN NUMBER IS
        nResult NUMBER;
      BEGIN
        IF vcLastTag IS NULL THEN
          nResult:=0;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H1 THEN
          nResult:=rHtmlSettings.nH1LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H2 THEN
          nResult:=rHtmlSettings.nH2LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H3 THEN
          nResult:=rHtmlSettings.nH3LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H4 THEN
          nResult:=rHtmlSettings.nH4LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_UL THEN
          nResult:=rHtmlSettings.nBrLineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_LI THEN
          IF vcLastTag!=PK_JRXML2PDF_TYPES.HTML_LI THEN
            nResult:=rHtmlSettings.nH4LineSpacing;
          ELSE
            nResult:=rHtmlSettings.nLiLineSpacing;
          END IF;
        ELSIF i_rPiece.vcTag IN (PK_JRXML2PDF_TYPES.HTML_BR, PK_JRXML2PDF_TYPES.HTML_P) THEN
          nResult:=rHtmlSettings.nBrLineSpacing;
        ELSE
          nResult:=rHtmlSettings.nLineSpacing;
        END IF;
        vcLastTag:=i_rPiece.vcTag;
        RETURN nResult;
      END;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('>'|| RPAD(' ', i_nLevel*2, ' ') || i_rPiece.vcTag ||':' || i_rPiece.vcText || ':' || i_rPiece.vcColor);
      END IF;
      IF i_rPiece.vcText IS NOT NULL THEN
        -- write text
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('scale x/height/text' || i_rPiece.nx || '/' || nOutputHeight || '/[' || i_rPiece.vcText || ']');
        END IF;
        FOR i IN 1..i_rPiece.lTextPieces.COUNT LOOP
          IF nGroup!=i_rPiece.lTextPieces(i).nGroup THEN
            nGroup:=i_rPiece.lTextPieces(i).nGroup;
            IF i=1 THEN
              -- big spacing
              nOutputHeight:=nOutputHeight+lGroupHeight(i_rPiece.lTextPieces(i).nGroup)+FK_GET_LINE_SPACING;
            ELSE
              -- smallm spacing
              nOutputHeight:=nOutputHeight+lGroupHeight(i_rPiece.lTextPieces(i).nGroup)+rHtmlSettings.nLineSpacing;
            END IF;
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Group/height ' || nGroup || '/' || nOutputHeight);
            END IF;
          END IF;
        END LOOP;
      ELSE
        IF nGroup!=i_rPiece.nGroup THEN
          nGroup:=i_rPiece.nGroup;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Group/height ' || nGroup || '/' || nOutputHeight);
          END IF;
          -- big spacing
          nOutputHeight:=nOutputHeight+lGroupHeight(i_rPiece.nGroup)+FK_GET_LINE_SPACING;
        END IF;
      END IF;
      FOR i IN 1..i_rPiece.lSubPieces.COUNT LOOP
        PR_REKU_SCALE_HTML(lResult.lPieces(i_rPiece.lSubPieces(i)), i_nLevel+1);
      END LOOP;
    END;
  BEGIN
    -- basic font and color are taken from the input values
    rHtmlSettings.vcFont   :=i_vcFont;
    rHtmlSettings.nFontSize:=i_nFontSize;
    IF NOT i_bEnhanced THEN
      -- no enhanced mode for HTML, no rendering of H1, H2, H3, H4
      rHtmlSettings.nH1FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH2FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH3FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH4FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH1LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH2LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH3LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH4LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nLiLineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nBrLineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nLineSpacing  :=rHtmlSettings.nLineSpacing;
    END IF;
    nXStart:=rPageSetup.nLeftMargin+i_nX+COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0);
    lResult:=FK_TOKENIZE_HTML(i_nFontSize=>rHtmlSettings.nFontSize,
                              i_vcText   =>i_vcText,
                              i_vcColor  =>PK_JRXML2PDF_TYPES.BLACK);
    nWidth:=i_nWidth;
    -- initally scale all parts
    PR_LAYOUT_HTML(i_rHtmlSetting=>rHtmlSettings,
                   io_lHtml      =>lResult,
                   i_nX          =>nXStart,
                   i_nWidth      =>i_nWidth,
                   i_vcColor     =>PK_JRXML2PDF_TYPES.BLACK);
    -- for each "line" get the maximum height
    FOR i IN 1..lResult.lPieces.COUNT LOOP
      FOR j IN 1..lResult.lPieces(i).lTextPieces.COUNT LOOP
        IF NOT lGroupHeight.EXISTS(lResult.lPieces(i).lTextPieces(j).nGroup) THEN
          lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup):=lResult.lPieces(i).lTextPieces(j).nHeight;
        ELSE
          lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup):=GREATEST(lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup), lResult.lPieces(i).lTextPieces(j).nHeight);
        END IF;
      END LOOP;
      IF NOT lGroupHeight.EXISTS(lResult.lPieces(i).nGroup) THEN
        lGroupHeight(lResult.lPieces(i).nGroup):=NVL(lResult.lPieces(i).nHeight,0);
      ELSE
        lGroupHeight(lResult.lPieces(i).nGroup):=GREATEST(lGroupHeight(lResult.lPieces(i).nGroup), NVL(lResult.lPieces(i).nHeight,0));
      END IF;
    END LOOP;
    nGroup:=1;
    nOutputHeight:=0;
    vcLastTag:=NULL;
    PR_REKU_SCALE_HTML(lResult.lPieces(1),1);
    -- Add paddings to height
    RETURN nOutputHeight+GREATEST(COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0),0)
                        +GREATEST(COALESCE(i_nBottomPadding, i_rStyle.nBottomPadding,0), 0);
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_TEXT_HEIGHT(i_nX               IN NUMBER,
                               i_nY               IN NUMBER,
                               i_nWidth           IN NUMBER,
                               i_nHeight          IN NUMBER,
                               i_vcText           IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                               i_vcFont           IN PK_JRXML2PDF_TYPES.tFont,
                               i_nFontSize        IN NUMBER,
                               i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment,
                               i_nTopPadding      IN NUMBER,
                               i_nLeftPadding     IN NUMBER,
                               i_nBottomPadding   IN NUMBER,
                               i_nRightPadding    IN NUMBER,
                               i_nLineSpacing     IN NUMBER,
                               i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle)
  RETURN NUMBER IS
    vcFont        VARCHAR2(60);
    nX            NUMBER;
    nY            NUMBER;
    nWidth        NUMBER;
    nLineSpacing  NUMBER;
    nTextHeight   NUMBER;
  BEGIN
    -- set font
    PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont   =>NVL(i_vcFont, i_rStyle.vcFont),
                                  i_vcStyle  =>COALESCE(i_rStyle.vcFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL),
                                  i_nSize    =>COALESCE(i_nFontSize, i_rStyle.nFontSize, 10)
                                 );
    nX:=rPageSetup.nLeftMargin+i_nX+COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0);
    nY:=rPageSetup.nPageHeight-rPageSetup.nTopMargin
                              -i_nY
                              -AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)
                              -COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0);
    nWidth:=i_nWidth-COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0)
                    -COALESCE(i_nRightPadding, i_rStyle.nRightPadding, 0);
    nLineSpacing:=COALESCE(i_nLineSpacing, i_rStyle.nLineSpacing, PK_JRXML2PDF_TYPES.MIN_LINE_SPACING);
    nTextHeight:=PK_JRXML2PDF_UTIL.FK_CALC_BOX_HEIGHT(i_vcText          =>i_vcText,
                                                      i_nX              =>nX,
                                                      i_nMaxHeight      =>9999,
                                                      i_nLineSpacing    =>nLineSpacing,
                                                      i_nXStart         =>nX,
                                                      i_nMaxWidth       =>nWidth
                                                     );
    -- Add paddings to height
    RETURN nTextHeight+GREATEST(COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0),0)
                      +GREATEST(COALESCE(i_nBottomPadding, i_rStyle.nBottomPadding,0), 0);
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_FITS_IN_PAGE(i_nCurrentY           IN NUMBER,
                           i_nDetailHeight       IN NUMBER)
  RETURN BOOLEAN IS
    nColumnFooterHeight NUMBER:=0;
    nPageFooterheight   NUMBER:=0;
  BEGIN
    nColumnFooterHeight:=0;
    nPageFooterheight:=0;
    FOR i IN 1..lReportStack.COUNT LOOP
      nColumnFooterHeight:=nColumnFooterHeight+lReportStack(i).nColumnFtrHeight;
      nPageFooterheight  :=nPageFooterheight  +lReportStack(i).nPageFtrHeight;
    END LOOP;
    IF rPageSetup.nPageHeight
       -rPageSetup.nTopMargin
       -i_nCurrentY
       -i_nDetailHeight
       -nColumnFooterHeight
       -nPageFooterheight
       -rPageSetup.nBottomMargin>=0 THEN
      RETURN TRUE;
    ELSE
      RETURN FALSE;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_REST_OF_PAGE(i_nCurrentY IN NUMBER)
  RETURN NUMBER IS
    nColumnFooterHeight NUMBER:=0;
    nPageFooterheight   NUMBER:=0;
  BEGIN
    nColumnFooterHeight:=0;
    nPageFooterheight:=0;
    FOR i IN 1..lReportStack.COUNT LOOP
      nColumnFooterHeight:=nColumnFooterHeight+lReportStack(i).nColumnFtrHeight;
      nPageFooterheight  :=nPageFooterheight  +lReportStack(i).nPageFtrHeight;
    END LOOP;
    RETURN rPageSetup.nPageHeight
           -rPageSetup.nTopMargin
           -i_nCurrentY
           -nColumnFooterHeight
           -nPageFooterheight
           -rPageSetup.nBottomMargin;
  END;
  -- ----------------------------------------------------------------------
  FUNCTION FK_RENDER_HTML(i_nX               IN NUMBER,
                          i_nY               IN NUMBER,
                          i_nWidth           IN NUMBER,
                          i_nHeight          IN NUMBER,
                          i_vcText           IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                          i_vcFont           IN PK_JRXML2PDF_TYPES.tFont,
                          i_nFontSize        IN NUMBER,
                          i_vcFontStyle      IN PK_JRXML2PDF_TYPES.tFontStyle,
                          i_vcAlignment      IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcVerticalAlign  IN PK_JRXML2PDF_TYPES.tAlignment,
                          i_vcBgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcFgColor        IN PK_JRXML2PDF_TYPES.tColor,
                          i_nBoxTop          IN NUMBER,
                          i_nBoxLeft         IN NUMBER,
                          i_nBoxBottom       IN NUMBER,
                          i_nBoxRight        IN NUMBER,
                          i_nTopPadding      IN NUMBER,
                          i_nLeftPadding     IN NUMBER,
                          i_nBottomPadding   IN NUMBER,
                          i_nRightPadding    IN NUMBER,
                          i_vcBoxTopColor    IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxLeftColor   IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxBottomColor IN PK_JRXML2PDF_TYPES.tColor,
                          i_vcBoxRightColor  IN PK_JRXML2PDF_TYPES.tColor,
                          i_nLineSpacing     IN NUMBER,
                          i_vcOpaque         IN PK_JRXML2PDF_TYPES.tYesNo,
                          i_rStyle           IN PK_JRXML2PDF_TYPES.tSimpleStyle,
                          i_bMayPageBreak    IN BOOLEAN,
                          i_rArea            IN PK_JRXML2PDF_TYPES.tArea,
                          i_bEnhanced        IN BOOLEAN)
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    rArea         PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    lResult       PK_JRXML2PDF_TYPES.tHtmlTree;
    nBaseY        NUMBER;
    nX            NUMBER;
    nXStart       NUMBER;
    nY            NUMBER;
    nWidth        NUMBER;
    nOutputHeight NUMBER;
    nGroup        NUMBER:=1;
    lGroupHeight  PK_JRXML2PDF_TYPES.tNumList;
    bInList       BOOLEAN;
    nDummy        NUMBER;
    vcLastTag     PK_JRXML2PDF_TYPES.tAttribute;
    nMaxheight    NUMBER;
    nRestOfPage   NUMBER;
    bTrackY       BOOLEAN:=FALSE;
    nTotalHeight  NUMBER;
    rHtmlSettings PK_JRXML2PDF_TYPES.tHtmlSettings:=rMasterHtmlSettings;
    PROCEDURE PR_RENDER_BOX_FOR_TEXT(i_nY      IN NUMBER,
                                     i_nHeight IN NUMBER) IS
    BEGIN
      PR_RENDER_BOX(i_nX               =>i_nX,
                    i_nY               =>i_nY,
                    i_nWidth           =>i_nWidth,
                    i_nHeight          =>i_nHeight,
                    i_vcBgColor        =>i_vcBgColor,
                    i_vcFgColor        =>i_vcFgColor,
                    i_nBoxTop          =>i_nBoxTop,
                    i_nBoxLeft         =>i_nBoxLeft,
                    i_nBoxBottom       =>i_nBoxBottom,
                    i_nBoxRight        =>i_nBoxRight,
                    i_vcBoxTopColor    =>i_vcBoxTopColor,
                    i_vcBoxLeftColor   =>i_vcBoxLeftColor,
                    i_vcBoxBottomColor =>i_vcBoxBottomColor,
                    i_vcBoxRightColor  =>i_vcBoxRightColor,
                    i_vcOpaque         =>i_vcOpaque,
                    i_rStyle           =>i_rStyle);
    END;
    PROCEDURE PR_REKU_OUTPUT_HTML(i_rPiece IN PK_JRXML2PDF_TYPES.tHtmlPiece, i_nLevel IN NUMBER) IS
      nSpacing     NUMBER;
      nYToAdd      NUMBER;
      FUNCTION FK_GET_LINE_SPACING
      RETURN NUMBER IS
        nResult NUMBER;
      BEGIN
        IF vcLastTag IS NULL THEN
          nResult:=0;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H1 THEN
          nResult:=rHtmlSettings.nH1LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H2 THEN
          nResult:=rHtmlSettings.nH2LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H3 THEN
          nResult:=rHtmlSettings.nH3LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_H4 THEN
          nResult:=rHtmlSettings.nH4LineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_UL THEN
          nResult:=rHtmlSettings.nBrLineSpacing;
        ELSIF i_rPiece.vcTag=PK_JRXML2PDF_TYPES.HTML_LI THEN
          IF vcLastTag!=PK_JRXML2PDF_TYPES.HTML_LI THEN
            nResult:=rHtmlSettings.nH4LineSpacing;
          ELSE
            nResult:=rHtmlSettings.nLiLineSpacing;
          END IF;
        ELSIF i_rPiece.vcTag IN (PK_JRXML2PDF_TYPES.HTML_BR, PK_JRXML2PDF_TYPES.HTML_P) THEN
          nResult:=rHtmlSettings.nBrLineSpacing;
        ELSE
          nResult:=rHtmlSettings.nLineSpacing;
        END IF;
        vcLastTag:=i_rPiece.vcTag;
        RETURN nResult;
      END;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('>'|| RPAD(' ', i_nLevel*2, ' ') || i_rPiece.vcTag ||':' || i_rPiece.vcText || ':' || i_rPiece.vcColor);
      END IF;
      -- set color
      AS_PDF3_MOD.set_color(i_rPiece.vcColor);
      IF i_rPiece.vcText IS NOT NULL THEN
        -- set font
        PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                      i_vcStyle =>i_rPiece.vcFontStyle,
                                      i_nSize   =>i_rPiece.nFontSize
                                     );
        -- write text
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('write x/y/text' || i_rPiece.nx || '/' || ny || '/[' || i_rPiece.vcText || ']');
        END IF;
        FOR i IN 1..i_rPiece.lTextPieces.COUNT LOOP
          IF nGroup!=i_rPiece.lTextPieces(i).nGroup THEN
            nGroup:=i_rPiece.lTextPieces(i).nGroup;
            IF i=1 THEN
              -- big spacing
              nSpacing:=FK_GET_LINE_SPACING;
            ELSE
              -- smallm spacing
              nSpacing:=rHtmlSettings.nLineSpacing;
            END IF;
            nYToAdd:=lGroupHeight(i_rPiece.lTextPieces(i).nGroup);
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('GRUPPE/y ' || nGroup || '/' || ny);
            END IF;
          ELSE
            nYToAdd:=0;
            nSpacing:=0;
          END IF;
          EXIT WHEN     nOutputHeight+nYToAdd+nSpacing>i_nHeight
                    AND NOT i_bMayPageBreak;
          IF nOutputHeight+nYToAdd+nSpacing>nRestOfPage THEN
            -- new page
            rArea.nY:=nY;
            PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                         i_nStackPos     =>lReportStack.COUNT,
                                         i_bOneRecordBack=>FALSE);
            nY:=rArea.nY;
            -- reduce height
            nTotalHeight:=nTotalHeight-nOutputheight-nSpacing;
            -- after a page-break, the new Y-positin must be tracked and returned
            bTrackY:=TRUE;
            nOutputHeight:=nYToAdd;
            nRestOfPage:=FK_REST_OF_PAGE(i_nY);
            -- render box
            PR_RENDER_BOX_FOR_TEXT(i_nY     =>nY,
                                   i_nHeight=>LEAST(nTotalHeight, nRestOfPage)
                                  );
            -- re-set Color and font, as it may have changed during header-rendering
            AS_PDF3_MOD.set_color(i_rPiece.vcColor);
            -- set font
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                          i_vcStyle =>i_rPiece.vcFontStyle,
                                          i_nSize   =>i_rPiece.nFontSize
                                         );
            -- we have to remember y-value at the end
            bTrackY:=TRUE;
            ny:=ny+nYToAdd;
          ELSE
            ny:=ny+nYToAdd+nSpacing;
            nOutputHeight:=nOutputHeight+nYToAdd+nSpacing;
          END IF;
          IF i=1 THEN
            IF i_rPiece.vcTag =PK_JRXML2PDF_TYPES.HTML_LI THEN
              IF i_rPiece.nListindex>0 THEN
                PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                              i_vcStyle =>i_rPiece.vcFontStyle,
                                              i_nSize   =>i_rPiece.nFontSize
                                             );
                as_pdf3_mod.put_txt(i_rPiece.nx-15,
                                    nBaseY-ny,
                                    TO_CHAR(i_rPiece.nListindex, 'FM990') || '.'
                                   );
              ELSE
                PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>PK_JRXML2PDF_TYPES.WINGDINGS,
                                              i_vcStyle =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                              i_nSize   =>6
                                             );
                as_pdf3_mod.put_txt(i_rPiece.nx-15,
                                    nBaseY-ny+2,
                                    rHtmlSettings.vcUlChar
                                   );
                PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                              i_vcStyle =>i_rPiece.vcFontStyle,
                                              i_nSize   =>i_rPiece.nFontSize
                                             );
              END IF;
            END IF;
          END IF;
          as_pdf3_mod.put_txt(i_rPiece.lTextPieces(i).nX,
                              nBaseY-ny,
                              i_rPiece.lTextPieces(i).vcText
                             );
        END LOOP;
      ELSE
        IF nGroup!=i_rPiece.nGroup THEN
          nGroup:=i_rPiece.nGroup;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Group/y ' || nGroup || '/' || ny);
          END IF;
          -- big spacing
          nSpacing:=FK_GET_LINE_SPACING;
          nYToAdd:=lGroupHeight(i_rPiece.nGroup);
        ELSE
          nYToAdd:=0;
          nSpacing:=0;
        END IF;
        IF nOutputHeight+nYToAdd+nSpacing>nRestOfPage THEN
          -- new page
          rArea.nY:=nY;
          PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                       i_nStackPos     =>lReportStack.COUNT,
                                       i_bOneRecordBack=>FALSE);
          nY:=rArea.nY;
          -- reduce height
          nTotalHeight:=nTotalHeight-nOutputheight-nSpacing;
          -- after a page-break, the new Y-positin must be tracked and returned
          bTrackY:=TRUE;
          nOutputHeight:=nYToAdd;
          nRestOfPage:=FK_REST_OF_PAGE(i_nY);
          -- render box
          PR_RENDER_BOX_FOR_TEXT(i_nY     =>nY,
                                 i_nHeight=>LEAST(nTotalHeight, nRestOfPage)
                                );
          -- re-set Color and font, as it may have changed during header-rendering
          AS_PDF3_MOD.set_color(i_rPiece.vcColor);
          -- set font
          PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                        i_vcStyle =>i_rPiece.vcFontStyle,
                                        i_nSize   =>i_rPiece.nFontSize
                                       );
          -- we have to remember y-value at the end
          bTrackY:=TRUE;
          ny:=ny+nYToAdd;
        ELSE
          ny:=ny+nYToAdd+nSpacing;
          nOutputHeight:=nOutputHeight+nYToAdd+nSpacing;
        END IF;
        IF     i_rPiece.vcTag =PK_JRXML2PDF_TYPES.HTML_LI
           AND nOutputHeight<=i_nHeight THEN
          IF i_rPiece.nListindex>0 THEN
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                          i_vcStyle =>i_rPiece.vcFontStyle,
                                          i_nSize   =>i_rPiece.nFontSize
                                         );
            as_pdf3_mod.put_txt(i_rPiece.nx-15,
                                nBaseY-ny,
                                TO_CHAR(i_rPiece.nListindex, 'FM990') || '.'
                               );
          ELSE
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>PK_JRXML2PDF_TYPES.WINGDINGS,
                                          i_vcStyle =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                          i_nSize   =>6
                                         );
            as_pdf3_mod.put_txt(i_rPiece.nx-15,
                                nBaseY-ny ,
                                rHtmlSettings.vcUlChar
                               );
            PK_JRXML2PDF_UTIL.PR_SET_FONT(i_vcFont  =>i_rPiece.vcFont,
                                          i_vcStyle =>i_rPiece.vcFontStyle,
                                          i_nSize   =>i_rPiece.nFontSize
                                         );
          END IF;
        END IF;
      END IF;
      FOR i IN 1..i_rPiece.lSubPieces.COUNT LOOP
        PR_REKU_OUTPUT_HTML(lResult.lPieces(i_rPiece.lSubPieces(i)), i_nLevel+1);
        EXIT WHEN         nOutputHeight>i_nHeight
                  AND NOT i_bMayPageBreak;
      END LOOP;
    END;
  BEGIN
    -- basic font and color are taken from the input values
    rHtmlSettings.vcFont   :=COALESCE(i_vcFont, i_rStyle.vcFont, rMasterHtmlSettings.vcFont);
    rHtmlSettings.nFontSize:=COALESCE(i_nFontSize, i_rStyle.nFontSize, rMasterHtmlSettings.nFontSize);
    IF NOT i_bEnhanced THEN
      -- no enhanced mode for HTML, no rendering of H1, H2, H3, H4
      rHtmlSettings.nH1FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH2FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH3FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH4FontSize   :=rHtmlSettings.nFontSize;
      rHtmlSettings.nH1LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH2LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH3LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nH4LineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nLiLineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nBrLineSpacing:=rHtmlSettings.nLineSpacing;
      rHtmlSettings.nLineSpacing  :=rHtmlSettings.nLineSpacing;
    END IF;
    nBaseY:=rPageSetup.nPageHeight
            -rPageSetup.nTopMargin
            -COALESCE(i_nTopPadding, i_rStyle.nTopPadding, 0);
    nXStart:=rPageSetup.nLeftMargin+i_nX+COALESCE(i_nLeftPadding, i_rStyle.nLeftPadding, 0);
    nY:=i_nY;
    nMaxheight:=FK_CALC_HTML_HEIGHT(i_nX              =>i_nX,
                                    i_nY              =>i_nY,
                                    i_nWidth          =>i_nWidth,
                                    i_nHeight         =>i_nHeight,
                                    i_vcText          =>i_vcText,
                                    i_vcFont          =>i_vcFont,
                                    i_nFontSize       =>i_nFontSize,
                                    i_vcAlignment     =>i_vcAlignment,
                                    i_nTopPadding     =>i_nTopPadding,
                                    i_nLeftPadding    =>i_nLeftPadding,
                                    i_nBottomPadding  =>i_nBottomPadding,
                                    i_nRightPadding   =>i_nRightPadding,
                                    i_nLineSpacing    =>i_nLineSpacing,
                                    i_rStyle          =>i_rStyle,
                                    i_bEnhanced       =>i_bEnhanced);
    lResult:=FK_TOKENIZE_HTML(i_nFontSize=>rHtmlSettings.nFontSize,
                              i_vcText   =>i_vcText,
                              i_vcColor  =>COALESCE(i_vcFgColor, i_rStyle.vcFgColor, PK_JRXML2PDF_TYPES.BLACK));
    nWidth:=i_nWidth;
    -- initally scale all parts
    PR_LAYOUT_HTML(i_rHtmlSetting=>rHtmlSettings,
                   io_lHtml      =>lResult,
                   i_nX          =>nXStart,
                   i_nWidth      =>i_nWidth,
                   i_vcColor     =>COALESCE(i_vcFgColor, i_rStyle.vcFgColor, PK_JRXML2PDF_TYPES.BLACK)
                  );
    -- for each "line" get the maximum height
    FOR i IN 1..lResult.lPieces.COUNT LOOP
      FOR j IN 1..lResult.lPieces(i).lTextPieces.COUNT LOOP
        IF NOT lGroupHeight.EXISTS(lResult.lPieces(i).lTextPieces(j).nGroup) THEN
          lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup):=lResult.lPieces(i).lTextPieces(j).nHeight;
        ELSE
          lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup):=GREATEST(lGroupHeight(lResult.lPieces(i).lTextPieces(j).nGroup), lResult.lPieces(i).lTextPieces(j).nHeight);
        END IF;
      END LOOP;
      IF NOT lGroupHeight.EXISTS(lResult.lPieces(i).nGroup) THEN
        lGroupHeight(lResult.lPieces(i).nGroup):=NVL(lResult.lPieces(i).nHeight,0);
      ELSE
        lGroupHeight(lResult.lPieces(i).nGroup):=GREATEST(lGroupHeight(lResult.lPieces(i).nGroup), NVL(lResult.lPieces(i).nHeight,0));
      END IF;
    END LOOP;
    nTotalHeight:=nMaxHeight;
    nRestOfPage:=FK_REST_OF_PAGE(i_nY);
    PR_RENDER_BOX_FOR_TEXT(i_nY     =>i_nY,
                           i_nHeight=>LEAST(i_nHeight, nRestOfPage)
                          );
    nGroup:=0;
    nOutputHeight:=0;
    vcLastTag:=NULL;
    PR_REKU_OUTPUT_HTML(lResult.lPieces(1),1);
    IF bTrackY THEN
      rArea.nY:=nY;
    END IF;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_QUERY_RESULT(i_nStackPos     IN NUMBER,
                               i_nRecordOffset IN NUMBER
                              )
  RETURN PK_JRXML2PDF_TYPES.tDataEntries IS
    lResult PK_JRXML2PDF_TYPES.tDataEntries;
    nIndex  NUMBER;
  BEGIN
    IF i_nRecordOffset=PK_JRXML2PDF_TYPES.OFFSET_NONE THEN
      IF lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent THEN
        IF lReportStack(i_nStackPos).rQuery.nPreviousRecord IS NOT NULL THEN
          nIndex:=lReportStack(i_nStackPos).rQuery.nPreviousRecord;
        ELSE
          nIndex:=lReportStack(i_nStackPos).rQuery.nCurrentRecord;
        END IF;
      ELSE
        nIndex:=lReportStack(i_nStackPos).rQuery.nCurrentRecord;
      END IF;
    ELSIF i_nRecordOffset=PK_JRXML2PDF_TYPES.OFFSET_PREVIOUS THEN
      IF lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent THEN
        nIndex:=-1;
      ELSE
        nIndex:=lReportStack(i_nStackPos).rQuery.nPreviousRecord;
      END IF;
    ELSIF i_nRecordOffset=PK_JRXML2PDF_TYPES.OFFSET_NEXT THEN
      IF lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent THEN
        nIndex:=lReportStack(i_nStackPos).rQuery.nCurrentRecord;
      ELSE
        nIndex:=lReportStack(i_nStackPos).rQuery.nNextRecord;
      END IF;
    END IF;
    BEGIN
      lResult:=lReportStack(i_nStackPos).rQuery.lQueryResult(nIndex);
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        NULL;
    END;
    RETURN lResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_EXPRESSION_INT(i_nStackPos      IN NUMBER,
                                      i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                      i_vcPattern      IN PK_JRXML2PDF_TYPES.tPattern,
                                      i_bForSqlUsage   IN BOOLEAN,
                                      i_nRecordOffset  IN NUMBER)
  RETURN VARCHAR2 IS
    lTokenValues PK_JRXML2PDF_TYPES.tTokenValueList;
    vcResult     PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rEntry       PK_JRXML2PDF_TYPES.tDataEntry;
    vcVarName    PK_JRXML2PDF_TYPES.tAttribute;
    iPos         PLS_INTEGER;
    iEndPos      PLS_INTEGER;
    iLastPos     PLS_INTEGER;
    PROCEDURE PR_TOKENIZE IS
      iPos      PLS_INTEGER:=1;
      iFoundPos PLS_INTEGER;
      iToken    PLS_INTEGER;
    BEGIN
      LOOP
        EXIT WHEN iPos>LENGTH(i_vcExpression);
        iFoundPos:=99999;
        FOR i IN 1..lTokens.COUNT LOOP
          iToken:=INSTR(i_vcExpression, lTokens(i).vcStartTag, iPos);
          IF iToken>0 THEN
            iFoundPos:=LEAST(iFoundPos, iToken);
            lTokenValues(iToken).vcFoundTag:=lTokens(i).vcStartTag;
            lTokenValues(iToken).vcEndTag:=lTokens(i).vcEndTag;
            iToken:=INSTR(i_vcExpression, lTokens(i).vcEndTag, iToken+1);
            IF iToken>0 THEN
              lTokenValues(iToken).vcFoundTag:=lTokens(i).vcEndTag;
            END IF;
          END IF;
        END LOOP;
        iPos:=iFoundPos+1;
      END LOOP;
    END;
    FUNCTION FK_DATE_PATTERN(i_vcPattern IN PK_JRXML2PDF_TYPES.tPattern)
    RETURN VARCHAR2 IS
      vcPattern PK_JRXML2PDF_TYPES.tPattern;
      PROCEDURE PR_REDEFINE_SHORTCUTS IS
        vcdatePattern PK_JRXML2PDF_TYPES.tPattern;
        vcTimePattern PK_JRXML2PDF_TYPES.tPattern;
      BEGIN
        IF i_vcPattern='short' THEN
          vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateShort;
          vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeShort;
        ELSIF i_vcPattern='medium' THEN
          vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateMedium;
          vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeMedium;
        ELSIF i_vcPattern='long' THEN
          vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateLong;
          vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeLong;
        ELSIF i_vcPattern='default' THEN
          vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateDefault;
          vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeDefault;
        ELSE
          IF INSTR(i_vcPattern, 'short,')>0 THEN
            vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateShort;
          ELSIF INSTR(i_vcPattern, 'medium,')>0 THEN
            vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateMedium;
          ELSIF INSTR(i_vcPattern, 'long,')>0 THEN
            vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateLong;
          ELSIF INSTR(i_vcPattern, 'default,')>0 THEN
            vcDatePattern:=lReportStack(i_nStackPos).rLocaleData.vcDateDefault;
          END IF;
          IF INSTR(i_vcPattern, ',short')>0 THEN
            vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeShort;
          ELSIF INSTR(i_vcPattern, ',medium')>0 THEN
            vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeMedium;
          ELSIF INSTR(i_vcPattern, ',long')>0 THEN
            vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeLong;
          ELSIF INSTR(i_vcPattern, ',default')>0 THEN
            vcTimePattern:=lReportStack(i_nStackPos).rLocaleData.vcTimeDefault;
          END IF;
        END IF;
        IF    vcDatePattern IS NOT NULL
           OR vcTimePattern IS NOT NULL THEN
          -- convert, LTR or RTL
          vcPattern:=PK_JRXML2PDF_UTIL.FK_TEXT_MESSAGE(lReportStack(i_nStackPos).rLocaleData.vcDateTimeString,
                                                       vcTimePattern,
                                                       vcDatePattern
                                                      );
        END IF;
      END;
    BEGIN
      IF NOT lDatePattern.EXISTS(i_vcPattern) THEN
        -- handle special pattern, like short,short
        PR_REDEFINE_SHORTCUTS;
        IF vcPattern IS NOT NULL THEN
          -- use predefined pattern
          lDatePattern(i_vcPattern):=vcPattern;
        ELSE
          -- create the oracle-format-mask
          lDatePattern(i_vcPattern):=PK_JRXML2PDF_UTIL.FK_ORA_DATE_PATTERN(i_vcPattern);
        END IF;
      END IF;
      -- now its parsed, simple return
      RETURN lDatePattern(i_vcPattern);
    END;
    FUNCTION FK_GET_FIELD_VALUE(i_vcFieldName IN VARCHAr2,
                                i_nStackPos   IN NUMBER)
    RETURN VARCHAR2 IS
      vcValue    PK_JRXML2PDF_TYPES.tMaxVarchar2;
      lDataEntry PK_JRXML2PDF_TYPES.tDataEntries;
    BEGIN
      lDataEntry:=FK_GET_QUERY_RESULT(i_nStackPos    =>i_nStackPos,
                                      i_nRecordOffset=>i_nRecordOffset
                                     );
      BEGIN
        rEntry:=lDataEntry(UPPER(i_vcFieldName));
        IF rEntry.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF i_bForSqlUsage THEN
            IF rEntry.nData IS NOT NULL THEN
              vcValue:=TO_CHAR(rEntry.nData, PK_JRXML2PDF_TYPES.NUM_FORMAT_MASK, 'NLS_NUMERIC_CHARACTERS=.,');
            ELSE
              vcValue:='NULL';
            END IF;
          ELSE
            IF i_vcPattern IS NOT NULL THEN
              DECLARE
                V_FORMATO_NUMERO CHAR (2);
              BEGIN
                select Value
                INTO  V_FORMATO_NUMERO
                from nls_session_parameters
                where parameter = 'NLS_NUMERIC_CHARACTERS';
                 vcValue:=TO_CHAR(rEntry.nData,
                                 FK_NUM_PATTERN(i_vcPattern),
                                 REPLACE ( lReportStack(i_nStackPos).rLocaleData.vcNumericChars || lReportStack(i_nStackPos).rLocaleData.vcCurrency,',.',V_FORMATO_NUMERO));
              EXCEPTION
                WHEN OTHERS THEN
                  -- format error
                  vcValue:='Format error :' || FK_NUM_PATTERN(i_vcPattern);
              END;
            ELSE
              IF rEntry.ndata=TRUNC(rEntry.ndata) THEN
                vcValue:=TO_CHAR(rEntry.nData, PK_JRXML2PDF_TYPES.DEFAULT_INT_FORMAT);--, lReportStack(i_nStackPos).rLocaleData.vcNumericChars);
              ELSE
                vcValue:=TO_CHAR(rEntry.nData, PK_JRXML2PDF_TYPES.DEFAULT_FLOAT_FORMAT);--, lReportStack(i_nStackPos).rLocaleData.vcNumericChars);
              END IF;
            END IF;
          END IF;
        ELSIF rEntry.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          IF i_bForSqlUsage THEN
            IF rEntry.dtData IS NOT NULL THEN
              vcValue:='TO_DATE(''' || TO_CHAR(rEntry.dtData, PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK) || ''', ''' || PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK || ''')';
            ELSE
              vcValue:='NULL';
            END IF;
          ELSE
            IF i_vcPattern IS NOT NULL THEN
              BEGIN
                vcValue:=TO_CHAR(rEntry.dtData,
                                 FK_DATE_PATTERN(i_vcPattern),
                                 lReportStack(i_nStackPos).rLocaleData.vcDateLanguage
                                );
              EXCEPTION
                WHEN OTHERS THEN
                  -- format error
                  vcValue:='Format error :' || i_vcPattern;
              END;
            ELSE
              vcValue:=TO_CHAR(rEntry.dtData,
                               lReportStack(i_nStackPos).rLocaleData.vcDateShort || ' ' ||
                               lReportStack(i_nStackPos).rLocaleData.vcTimeShort,
                               lReportStack(i_nStackPos).rLocaleData.vcDateLanguage);
            END IF;
          END IF;
        ELSIF rEntry.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_BLOB THEN
          vcValue:=PK_JRXML2PDF_TYPES.THIS_IS_A_BLOB;
        ELSE
          IF i_bForSqlUsage THEN
            IF rEntry.vcData IS NOT NULL THEN
              vcValue:='''' || REPLACE(rEntry.vcData, '''', '''''') || '''';
            ELSE
              vcValue:='NULL';
            END IF;
          ELSE
            vcValue:=rEntry.vcData;
          END IF;
        END IF;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          IF i_nStackPos>1 THEN
            -- try on master-report
            vcValue:=FK_GET_FIELD_VALUE(i_vcFieldName=>i_vcFieldName,
                                        i_nStackPos  =>i_nStackPos-1);
          END IF;
      END;
      RETURN vcValue;
    END;
    FUNCTION FK_GET_RESOURCE_VALUE(i_vcResName IN VARCHAR2)
    RETURN VARCHAR2 IS
      vcValue    PK_JRXML2PDF_TYPES.tMaxVarchar2;
      vcResource PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      IF lReportStack(i_nStackPos).lResources.EXISTS(i_vcResName) THEN
        vcResource:=lReportStack(i_nStackPos).lResources(i_vcResName);
      END IF;
      IF i_bForSqlUsage THEN
        vcValue:='''' || vcResource || '''';
      ELSE
        vcValue:=vcResource;
      END IF;
      RETURN vcValue;
    END;
    FUNCTION FK_GET_VAR_VALUE(i_vcVarName IN VARCHAr2)
    RETURN VARCHAR2 IS
      vcValue PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      IF i_vcVarname='PAGE_NUMBER' THEN
        vcValue:=TO_CHAR(lReportStack(i_nStackPos).lLogicalPageNumbers(lReportStack(i_nStackPos).nCurrentPagePointer));
      ELSIF i_vcVarname='REPORT_COUNT' THEN
        vcValue:=TO_CHAR(lReportStack(i_nStackPos).rQuery.nRecordPosition);
      ELSIF i_vcVarname='current_date' THEN
        IF i_bForSqlUsage THEN
          vcValue:='TO_DATE(''' || TO_CHAR(current_date, PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK) || ''', ''' || PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK || ''')';
        ELSE
          IF i_vcPattern IS NOT NULL THEN
            BEGIN
              vcValue:=TO_CHAR(current_date,FK_DATE_PATTERN(i_vcPattern), lReportStack(i_nStackPos).rLocaleData.vcDateLanguage);
            EXCEPTION
              WHEN OTHERS THEN
                -- format error
                vcValue:='Format error :' || i_vcPattern;
            END;
          ELSE
            vcValue:=TO_CHAR(current_date, lReportStack(i_nStackPos).rLocaleData.vcDateShort || ' ' ||
                                      lReportStack(i_nStackPos).rLocaleData.vcTimeShort
                                    , lReportStack(i_nStackPos).rLocaleData.vcDateLanguage);
          END IF;
        END IF;
      ELSE
        -- Check reports variable cache
        IF lReportStack(i_nStackPos).lVariableCache.EXISTS(UPPER(i_vcVarname)) THEN
          IF lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            IF i_bForSqlUsage THEN
              IF lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData IS NOT NULL THEN
                vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData, PK_JRXML2PDF_TYPES.NUM_FORMAT_MASK, 'NLS_NUMERIC_CHARACTERS=.,');
              ELSE
                vcValue:='NULL';
              END IF;
            ELSE
              IF i_vcPattern IS NOT NULL THEN
                DECLARE
                V_FORMATO_NUMERO CHAR (2);
                BEGIN
                select Value
                INTO  V_FORMATO_NUMERO
                from nls_session_parameters
                where parameter = 'NLS_NUMERIC_CHARACTERS';
                  vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData,
                                   FK_NUM_PATTERN(i_vcPattern),
                                   REPLACE (
                                   lReportStack(i_nStackPos).rLocaleData.vcNumericChars || ' ' ||
                                   lReportStack(i_nStackPos).rLocaleData.vcCurrency
                                   ,',.',V_FORMATO_NUMERO)
                                  );
                EXCEPTION
                  WHEN OTHERS THEN
                    -- format error
                    vcValue:='Format error :' || i_vcPattern;
                END;
              ELSE
                IF lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData=TRUNC(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData) THEN
                  vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData, PK_JRXML2PDF_TYPES.DEFAULT_INT_FORMAT, lReportStack(i_nStackPos).rLocaleData.vcNumericChars);
                ELSE
                  vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).nData, PK_JRXML2PDF_TYPES.DEFAULT_FLOAT_FORMAT, lReportStack(i_nStackPos).rLocaleData.vcNumericChars);
                END IF;
              END IF;
            END IF;
          ELSIF lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            IF i_bForSqlUsage THEN
              vcValue:='TO_DATE(''' || TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).dtData, PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK) || ''', ''' || PK_JRXML2PDF_TYPES.DATE_FORMAT_MASK || ''')';
            ELSE
              IF i_vcPattern IS NOT NULL THEN
                BEGIN
                  vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).dtData,
                                   FK_DATE_PATTERN(i_vcPattern),
                                   lReportStack(i_nStackPos).rLocaleData.vcDateLanguage
                                  );
                EXCEPTION
                  WHEN OTHERS THEN
                    -- format error
                    vcValue:='Format error :' || i_vcPattern;
                END;
              ELSE
                vcValue:=TO_CHAR(lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).dtData,
                                 lReportStack(i_nStackPos).rLocaleData.vcDateShort || ' ' ||
                                 lReportStack(i_nStackPos).rLocaleData.vcTimeShort,
                                 lReportStack(i_nStackPos).rLocaleData.vcDateLanguage
                                );
              END IF;
            END IF;
          ELSE
            IF lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).vcData IS  NOT NULL THEN
              vcValue:=lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcVarname)).vcData;
            ELSIF NOT i_bForSqlUsage THEN
              vcValue:=NULL;
            ELSE
              vcValue:='NULL';
            END IF;
          END IF;
        ELSE
          IF NOT i_bForSqlUsage THEN
            vcValue:=NULL;
          ELSE
            vcValue:='NULL';
          END IF;
        END IF;
      END IF;
      RETURN vcValue;
    END;
    FUNCTION FK_GET_PARAM_VALUE(i_vcParamName IN VARCHAr2)
    RETURN VARCHAR2 IS
      vcValue PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      -- special handling for SUBREPORT_DIR, always return ''
      IF i_vcParamName!='SUBREPORT_DIR' THEN
        FOR i IN 1..lReportStack(i_nStackPos).lParams.COUNT LOOP
          IF lReportStack(i_nStackPos).lParams(i).vcName=i_vcParamName THEN
            IF i_bForSqlUsage THEN
              IF lReportStack(i_nStackPos).lParams(i).vcValue IS NOT NULL THEN
                vcValue:='''' || REPLACE(lReportStack(i_nStackPos).lParams(i).vcValue, '''', '''''') || '''';
              ELSE
                vcValue:='NULL';
              END IF;
            ELSE
              vcValue:=lReportStack(i_nStackPos).lParams(i).vcValue;
            END IF;
            EXIT;
          END IF;
        END LOOP;
      END IF;
      IF     i_bForSqlUsage
         AND vcValue IS NULL THEN
        vcValue:='NULL';
      END IF;
      RETURN vcValue;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Evaluate expression:' || i_vcExpression);
    END IF;
    IF i_vcExpression IS NOT NULL THEN
      -- for performance issues, check the most happeing case explicitly
      IF SUBSTR(i_vcExpression, 1, 3)='$F{'
         AND INSTR(i_vcExpression, '}')=LENGTH(i_vcExpression) THEN
        -- a simple field
        -- String, match end-Token
        vcVarName:=SUBSTR(i_vcExpression,4, LENGTH(i_vcExpression)-4);
        vcResult:=vcResult || FK_GET_FIELD_VALUE(vcVarName, i_nStackPos);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Fast field,fieldname/result:' || vcVarname || '/' || vcResult);
        END IF;
      ELSE
        PR_TOKENIZE;
        IF lTokenValues.COUNT>0 THEN
          iLastPos:=1;
          iPos:=lTokenValues.FIRST;
          WHILE iPos IS NOT NULL LOOP
            IF i_bForSqlUsage AND iPos>iLastPos THEN
              -- take value from gap and add
              vcResult:=vcResult||SUBSTR(i_vcExpression, iLastPos,iPos-iLastPos);
            END IF;
            iEndPos:=iPos;
            iLastPos:=iPos+LENGTH(lTokenValues(iPos).vcFoundTag);
            IF lTokenValues(iPos).vcEndTag IS NOT NULL THEN
              iEndPos:=lTokenValues.NEXT(iEndPos);
              WHILE iEndPos IS NOT NULL LOOP
                EXIT WHEN lTokenValues(iEndPos).vcFoundTag=lTokenValues(iPos).vcEndTag;
                iEndPos:=lTokenValues.NEXT(iEndPos);
              END LOOP;
              iLastPos:=iEndPos+1;
            END IF;
            IF     iPos IS NOT NULL
               AND iEndPos IS NOT NULL THEN
              IF lTokenValues(iPos).vcFoundTag='"' THEN
                -- String, match end-Token
                IF i_bForSqlUsage THEN
                  vcResult:=vcResult || '''' || REPLACE(SUBSTR(i_vcExpression,iPos+1, iEndPos-iPos-1), '''', '''''') || '''';
                ELSE
                  vcResult:=vcResult || SUBSTR(i_vcExpression,iPos+1, iEndPos-iPos-1);
                END IF;
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add string,result:' || vcResult);
                END IF;
              ELSIF lTokenValues(iPos).vcFoundTag='$F{' THEN
                -- String, match end-Token
                vcVarName:=SUBSTR(i_vcExpression,iPos+3, iEndPos-iPos-3);
                vcResult:=vcResult || FK_GET_FIELD_VALUE(vcVarName, i_nStackPos);
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add field,fieldname/result:' || vcVarname || '/' || vcResult);
                END IF;
              ELSIF lTokenValues(iPos).vcFoundTag='$V{' THEN
                -- String, match end-Token
                vcVarName:=SUBSTR(i_vcExpression,iPos+3, iEndPos-iPos-3);
                vcResult:=vcResult || FK_GET_VAR_VALUE(vcVarName);
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add variable,varname/result:' || vcVarname || '/' || vcResult);
                END IF;
              ELSIF lTokenValues(iPos).vcFoundTag='$P{' THEN
                -- String, match end-Token
                vcVarName:=SUBSTR(i_vcExpression,iPos+3, iEndPos-iPos-3);
                vcResult:=vcResult || FK_GET_PARAM_VALUE(vcVarName);
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add parameter,parname/result:' || vcVarname || '/' || vcResult);
                END IF;
              ELSIF lTokenValues(iPos).vcFoundTag='$R{' THEN
                -- String, match end-Token
                vcVarName:=SUBSTR(i_vcExpression,iPos+3, iEndPos-iPos-3);
                vcResult:=vcResult || FK_GET_RESOURCE_VALUE(vcVarName);
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add resource,name/result:' || vcVarname || '/' || vcResult);
                END IF;
              ELSIF lTokenValues(iPos).vcFoundTag='new java.util.Date()' THEN
                -- String, match end-Token
                vcVarName:='current_date';
                vcResult:=vcResult || FK_GET_VAR_VALUE(vcVarName);
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add java.util.date,vresult:' || vcResult);
                END IF;
              ELSIF i_bForSqlUsage THEN
                -- Other tokens only when used in SQL
                IF lTokenValues(iPos).vcFoundTag='==' THEN
                  vcResult:=vcResult || '=';
                ELSIF lTokenValues(iPos).vcFoundTag='==null' THEN
                  vcResult:=vcResult || ' IS NULL ';
                ELSIF lTokenValues(iPos).vcFoundTag='!=null' THEN
                  vcResult:=vcResult || ' IS NOT NULL ';
                ELSIF lTokenValues(iPos).vcFoundTag='||' THEN
                  vcResult:=vcResult || ' OR ';
                ELSIF lTokenValues(iPos).vcFoundTag='&&' THEN
                  vcResult:=vcResult || ' AND ';
                ELSIF lTokenValues(iPos).vcFoundTag='jrxml2pdf.Wrappers.mod' THEN
                  vcResult:=vcResult || ' MOD ';
                ELSIF lTokenValues(iPos).vcFoundTag='.startsWith(' THEN
                  -- String, match end-Token
                  vcVarName:=REPLACE(SUBSTR(i_vcExpression,iPos+12, iEndPos-iPos-13), '"', '''');
                  vcResult:=vcResult || ' LIKE ' || vcVarname || ' || ''%''';
                ELSIF lTokenValues(iPos).vcFoundTag='!' THEN
                  -- String, match end-Token
                  vcResult:=vcResult || ' NOT ';
                ELSE
                  vcResult:=vcResult || lTokenValues(iPos).vcFoundTag;
                END IF;
              END IF;
            END IF;
            iPos:=lTokenValues.NEXT(iEndPos);
          END LOOP;
          IF i_bForSqlUsage AND iLastPos<=LENGTH(i_vcExpression) THEN
            vcResult:=vcResult || SUBSTR(i_vcExpression, iLastPos);
          END IF;
        ELSE
          vcResult:=i_vcExpression;
        END IF;
      END IF;
    END IF;
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('expression result:' || vcResult);
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_EXPRESSION(i_nStackPos      IN NUMBER,
                                  i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                  i_vcPattern      IN PK_JRXML2PDF_TYPES.tPattern,
                                  i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN VARCHAR2 IS
    vcResult PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF i_vcExpression LIKE 'msg(%' THEN
      -- special case, language specific msg, cobvert to SQL
      -- and then execute immediate
      vcResult:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos      =>i_nStackPos,
                                           i_vcExpression   =>i_vcExpression,
                                           i_vcPattern      =>i_vcPattern,
                                           i_bForSqlUsage   =>TRUE,
                                           i_nRecordOffset  =>i_nRecordOffset
                                          );
      EXECUTE IMMEDIATE 'SELECT ' || REPLACE(vcResult, 'msg(', 'PK_JRXML2PDF_UTIL.FK_TEXT_MESSAGE(') || 'FROM DUAL'
                   INTO vcResult;
    ELSE
      vcResult:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos      =>i_nStackPos,
                                           i_vcExpression   =>i_vcExpression,
                                           i_vcPattern      =>i_vcPattern,
                                           i_bForSqlUsage   =>FALSE,
                                           i_nRecordOffset  =>i_nRecordOffset
                                          );
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos      IN NUMBER,
                                         i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                         i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN NUMBER IS
    vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nResult     NUMBER;
  BEGIN
    IF i_vcExpression IS NOT NULL THEN
      vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_vcExpression,
                                              i_vcPattern    =>NULL,
                                              i_bForSQLUsage =>TRUE,
                                              i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE
                                             );
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Try to evaluate as Number:' || vcStatement);
      END IF;
      EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                   INTO nResult;
    END IF;
    RETURn nResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_EXPRESSION_DATE(i_nStackPos      IN NUMBER,
                                       i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                       i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN DATE IS
    vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
    dtResult    DATE;
  BEGIN
    IF i_vcExpression IS NOT NULL THEN
      vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_vcExpression,
                                              i_vcPattern    =>NULL,
                                              i_bForSQLUsage =>TRUE,
                                              i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE
                                             );
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Try to evaluate as Date:' || vcStatement);
      END IF;
      EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                   INTO dtResult;
    END IF;
    RETURn dtResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_CONDITION(i_nStackPos      IN NUMBER,
                                 i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression,
                                 i_nRecordOffset  IN NUMBER DEFAULT PK_JRXML2PDF_TYPES.OFFSET_NONE)
  RETURN BOOLEAN IS
    vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nResult     NUMBER;
  BEGIN
    vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos      =>i_nStackPos,
                                            i_vcExpression   =>i_vcExpression,
                                            i_vcPattern      =>NULL,
                                            i_bForSqlUsage   =>TRUE,
                                            i_nRecordOffset  =>i_nRecordOffset);
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Evaluate boolean:' || vcStatement);
    END IF;
    EXECUTE IMMEDIATE 'SELECT CASE WHEN ' || vcStatement || ' THEN 1 END FROM DUAL'
            INTO nResult;
    RETURN NVL(nResult,0)=1;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_EVALUATE_IMAGE(i_nStackPos      IN NUMBER,
                             i_vcExpression   IN PK_JRXML2PDF_TYPES.tExpression)
  RETURN BLOB IS
    iField       PLS_INTEGER:=INSTR(i_vcExpression, '$F');
    iEndField    PLS_INTEGER;
    vcFieldName  PK_JRXML2PDF_TYPES.tAttribute;
    rEntry       PK_JRXML2PDF_TYPES.tDataEntry;
    blValue      BLOB;
    lDataEntry   PK_JRXML2PDF_TYPES.tDataEntries;
  BEGIN
    IF iField>0 THEN
      iEndField:=INSTR(i_vcExpression, '}', iField+1);
      IF iEndField>iField THEN
        vcFieldName:=SUBSTR(i_vcExpression, iField+3, iEndField-iField-3);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Fieldname is ' || vcFieldName);
        END IF;
        lDataEntry:=FK_GET_QUERY_RESULT(i_nStackPos    =>i_nStackPos,
                                        i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE);
        IF lDataEntry.EXISTS(UPPER(vcFieldName)) THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Found Entry of datatype ' || rEntry.vcDatatype);
          END IF;
          rEntry:=lDataEntry(UPPER(vcFieldName));
          IF rEntry.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_BLOB THEN
            blValue:=rEntry.blData;
          END IF;
        END IF;
      END IF;
    END IF;
    RETURN blValue;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_VARIABLE(i_nStackPos IN NUMBER,
                           i_vcName    IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tDataEntry IS
    rResult PK_JRXML2PDF_TYPES.tDataEntry;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('GSet variable Stackpos / Name ' || TO_CHAR(i_nStackPos) || '/' ||
                                                                           i_vcName             );
    END IF;
    IF lReportStack(i_nStackPos).lVariableCache.EXISTS(UPPER(i_vcName)) THEN
      -- Set value into reports variable-cache
      rResult:=lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcName));
    END IF;
    -- return result
    RETURN rResult;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_VARIABLE(i_nStackPos IN NUMBER,
                            i_vcName    IN VARCHAR2,
                            i_rData     IN PK_JRXML2PDF_TYPES.tDataEntry
                           ) IS
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable Stackpos / Name / <DATAENTRY> ' || TO_CHAR(i_nStackPos) || '/' ||
                                                                                  i_vcName             );
    END IF;
    -- Set value into reports variable-cache
    lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcName)):=i_rData;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_VARIABLE(i_nStackPos IN NUMBER,
                            i_vcName    IN VARCHAR2,
                            i_vcValue   IN VARCHAR2
                           ) IS
    rVariable PK_JRXML2PDF_TYPES.tDataEntry;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable Stackpos / Name / value ' || TO_CHAR(i_nStackPos) || '/' ||
                                                                                  i_vcName             || '/' ||
                                                                                  i_vcValue);
    END IF;
    rVariable.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
    rVariable.vcData    :=i_vcValue;
    -- Set value into reports variable-cache
    lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcName)):=rVariable;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_VARIABLE(i_nStackPos IN NUMBER,
                            i_vcName    IN VARCHAR2,
                            i_nValue    IN NUMBER
                           ) IS
    rVariable PK_JRXML2PDF_TYPES.tDataEntry;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable Stackpos / Name / value ' || TO_CHAR(i_nStackPos) || '/' ||
                                                                                  i_vcName             || '/' ||
                                                                                  i_nValue);
    END IF;
    rVariable.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
    rVariable.nData     :=i_nValue;
    -- Set value into reports variable-cache
    lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcName)):=rVariable;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_VARIABLE(i_nStackPos IN NUMBER,
                            i_vcName    IN VARCHAR2,
                            i_dtValue   IN DATE
                           ) IS
    rVariable PK_JRXML2PDF_TYPES.tDataEntry;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable Stackpos / Name / value ' || TO_CHAR(i_nStackPos) || '/' ||
                                                                                  i_vcName             || '/' ||
                                                                                  i_dtValue);
    END IF;
    rVariable.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
    rVariable.dtData    :=i_dtValue;
    -- Set value into reports variable-cache
    lReportStack(i_nStackPos).lVariableCache(UPPER(i_vcName)):=rVariable;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_UNSET_VARIABLE(i_nStackPos IN NUMBER,
                              i_vcName    IN VARCHAR2) IS
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Unset variable Stackpos / Name' || TO_CHAR(i_nStackPos) || '/' ||
                                                                           i_vcName);
    END IF;
    -- Set value into reports variable-cache
    lReportStack(i_nStackPos).lVariableCache.DELETE(UPPER(i_vcName));
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_INIT_VARIABLES(i_nStackPos  IN NUMBER,
                              i_vcType     IN PK_JRXML2PDF_TYPES.tIncrementType,
                              i_bCalculate IN BOOLEAN,
                              i_bReset     IN BOOLEAN,
                              i_vcGroup    IN VARCHAR2 DEFAULT NULL) IS
    nValue  NUMBER;
    dtValue DATE;
    vcValue PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rVar    PK_JRXML2PDF_TYPES.tVariable;
    rData   PK_JRXML2PDF_TYPES.tDataEntry;
    FUNCTION FK_MATCHES(i_vcChecktype IN VARCHAR2, i_vcCheckGroup IN VARCHAR2)
    RETURN BOOLEAN IS
    BEGIN
      RETURN  (    i_vcChecktype=i_vcType
               AND i_vcType IN (PK_JRXML2PDF_TYPES.VARTYPE_REPORT,
                              PK_JRXML2PDF_TYPES.VARTYPE_PAGE,
                              PK_JRXML2PDF_TYPES.VARTYPE_NONE)
              )
           OR (     i_vcChecktype=i_vcType
               AND i_vcType=PK_JRXML2PDF_TYPES.VARTYPE_GROUP
               AND i_vcCheckGroup=i_vcGroup
              );
    END;
  BEGIN
    IF i_bReset THEN
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Reset Variables Type ' || i_vcType || '(' || i_vcGroup || ')');
      END IF;
      -- unset vars on current level
      FOR i IN 1..lReportStack(i_nStackPos).lVariables.COUNT LOOP
        rVar:=lReportStack(i_nStackPos).lVariables(i);
        IF FK_MATCHES(rVar.vcResetType, rVar.vcResetGroup) THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Reset Variable ' || rVar.vcName);
          END IF;
          -- Reset variable
          PR_UNSET_VARIABLE(i_nStackPos, rVar.vcName);
          -- and initialize
          rData.vcDataType:=rVar.vcDataType;
          rData.bIsInitial:=TRUE;
          IF rVar.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            rData.nData:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos, rVar.vcInitialValue);
            IF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_SUM THEN
              rData.nSum:=rData.nData;
            END IF;
            rData.iCount:=0;
          ELSIF rVar.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            rData.dtData:=FK_EVALUATE_EXPRESSION_DATE(i_nStackPos, rVar.vcInitialValue);
          ELSE
            rData.vcData:=FK_EVALUATE_EXPRESSION(i_nStackPos, rVar.vcInitialValue, NULL);
          END IF;
          PR_SET_VARIABLE(i_nStackPos, rVar.vcName, rData);
        END IF;
      END LOOP;
    END IF;
    IF i_bCalculate THEN
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Set Variables Type ' || i_vcType || '(' || i_vcGroup || ')');
      END IF;
      -- recalculate vars on current level
      FOR i IN 1..lReportStack(i_nStackPos).lVariables.COUNT LOOP
        rVar:=lReportStack(i_nStackPos).lVariables(i);
        IF FK_MATCHES(rVar.vcIncrementType, rVar.vcIncrementGroup) THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Increment Variable ' || rVar.vcName);
          END IF;
          rData:=FK_GET_VARIABLE(i_nStackPos, rVar.vcName);
          rData.vcDataType:=rVar.vcDataType;
          IF rData.bIsInitial THEN
            -- reset initial value
            rData.bIsInitial:=FALSE;
            rData.vcData:=NULL;
            rData.nData:=NULL;
            rData.dtData:=NULL;
            rData.nSum:=NULL;
          END IF;
          -- get variable-value, increment and set
          IF rVar.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
            nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos, rVar.vcValue);
            IF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_COUNT THEN
              IF nValue IS NOT NULL THEN
                rData.iCount:=rData.iCount+1;
              END IF;
              rData.nData:=rData.iCount;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_SUM THEN
              rData.nSum:=NVL(rData.nSum, 0)+NVL(nValue,0);
              rData.nData:=rData.nSum;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_AVERAGE THEN
              IF nValue IS NOT NULL THEN
                rData.iCount:=rData.iCount+1;
                rData.nSum:=NVL(rData.nSum,0)+nValue;
              END IF;
              rData.nData:=rData.nSum/rData.iCount;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
              IF rData.nData IS NULL THEN
                rData.nData:=nValue;
              END IF;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
              rData.nData:=nValue;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
              rData.nData:=LEAST(NVL(rData.nData, nValue), nValue);
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
              rData.nData:=GREATEST(NVL(rData.nData, nValue), nValue);
            END IF;
          ELSIF rVar.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
            dtValue:=FK_EVALUATE_EXPRESSION_DATE(i_nStackPos, rVar.vcValue);
            IF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
              IF rData.dtData IS NULL THEN
                rData.dtData:=dtValue;
              END IF;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
              rData.dtData:=dtValue;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
              rData.dtData:=LEAST(NVL(rData.dtData, dtValue), dtValue);
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
              rData.dtData:=GREATEST(NVL(rData.dtData, dtValue), dtValue);
            END IF;
          ELSE
            vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos, rVar.vcValue, NULL);
            IF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
              IF rData.vcData IS NULL THEN
                rData.vcData:=vcValue;
              END IF;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
              rData.vcData:=vcValue;
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
              rData.vcData:=LEAST(NVL(rData.vcData, vcValue), vcValue);
            ELSIF rVar.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
              rData.vcData:=GREATEST(NVL(rData.vcData, vcValue), vcValue);
            END IF;
          END IF;
          PR_SET_VARIABLE(i_nStackPos, rVar.vcName, rData);
        END IF;
      END LOOP;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_SUBREPORT_VARS(i_nStackPos      IN NUMBER,
                                  io_lReturnvalues IN OUT NOCOPY PK_JRXML2PDF_TYPES.tSubreportReturnvalueList) IS
    rVariable PK_JRXML2PDF_TYPES.tVariable;
  BEGIN
    FOR i IN 1..io_lReturnvalues.COUNT LOOP
      io_lReturnvalues(i).rData:=FK_GET_VARIABLE(i_nStackPos, io_lReturnvalues(i).vcSubreportVariable);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        IF io_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Set returnvalue Variable / Value ' || io_lReturnvalues(i).vcSubreportVariable || '/' || TO_CHAR(io_lReturnvalues(i).rData.nData));
        ELSIF io_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Set returnvalue Variable / Value ' || io_lReturnvalues(i).vcSubreportVariable || '/' || TO_CHAR(io_lReturnvalues(i).rData.vcData));
        ELSIF io_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Set returnvalue Variable / Value ' || io_lReturnvalues(i).vcSubreportVariable || '/' || TO_CHAR(io_lReturnvalues(i).rData.dtData));
        END IF;
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RETRIEVE_SUBREPORT_VARS(i_nStackPos     IN NUMBER,
                                       i_lReturnvalues IN PK_JRXML2PDF_TYPES.tSubreportReturnvalueList) IS
   rData PK_JRXML2PDF_TYPES.tDataEntry;
  BEGIN
    FOR i IN 1..i_lReturnvalues.COUNT LOOP
      rData:=FK_GET_VARIABLE(i_nStackPos, i_lReturnvalues(i).vcToVariable);
      rData.vcDataType:=i_lReturnvalues(i).rData.vcDataType;
      IF rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        -- do calulcations here
        IF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_COUNT THEN
          IF i_lReturnvalues(i).rData.nData IS NOT NULL THEN
            rData.iCount:=rData.iCount+1;
          END IF;
          rData.nData:=rData.iCount;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_SUM THEN
          rData.nSum:=NVL(rData.nSum, 0)+NVL(i_lReturnvalues(i).rData.nData,0);
          rData.nData:=rData.nSum;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_AVERAGE THEN
          IF i_lReturnvalues(i).rData.nData IS NOT NULL THEN
            rData.iCount:=rData.iCount+1;
            rData.nSum:=NVL(rData.nSum,0)+i_lReturnvalues(i).rData.nData;
          END IF;
          rData.nData:=rData.nSum/rData.iCount;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
          IF rData.nData IS NULL THEN
            rData.nData:=i_lReturnvalues(i).rData.nData;
          END IF;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
          rData.nData:=i_lReturnvalues(i).rData.nData;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
          rData.nData:=LEAST(NVL(rData.nData, i_lReturnvalues(i).rData.nData), i_lReturnvalues(i).rData.nData);
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
          rData.nData:=GREATEST(NVL(rData.nData, i_lReturnvalues(i).rData.nData), i_lReturnvalues(i).rData.nData);
        END IF;
      ELSIF rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
        IF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
          IF rData.dtData IS NULL THEN
            rData.dtData:=i_lReturnvalues(i).rData.dtData;
          END IF;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
          rData.dtData:=i_lReturnvalues(i).rData.dtData;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
          rData.dtData:=LEAST(NVL(rData.dtData, i_lReturnvalues(i).rData.dtData), i_lReturnvalues(i).rData.dtData);
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
          rData.dtData:=GREATEST(NVL(rData.dtData, i_lReturnvalues(i).rData.dtData), i_lReturnvalues(i).rData.dtData);
        END IF;
      ELSE
        IF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
          IF rData.vcData IS NULL THEN
            rData.vcData:=i_lReturnvalues(i).rData.vcData;
          END IF;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
          rData.vcData:=i_lReturnvalues(i).rData.vcData;
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
          rData.vcData:=LEAST(NVL(rData.vcData, i_lReturnvalues(i).rData.vcData), i_lReturnvalues(i).rData.vcData);
        ELSIF i_lReturnvalues(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
          rData.vcData:=GREATEST(NVL(rData.vcData, i_lReturnvalues(i).rData.vcData), i_lReturnvalues(i).rData.vcData);
        END IF;
      END IF;
      PR_SET_VARIABLE(i_nStackPos, i_lReturnvalues(i).vcToVariable, rData);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        IF i_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Retrieve returnvalue into Variable / Value ' || i_lReturnvalues(i).vcToVariable || '/' || TO_CHAR(i_lReturnvalues(i).rData.nData));
        ELSIF i_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Retrieve returnvalue into Variable / Value ' || i_lReturnvalues(i).vcToVariable || '/' || TO_CHAR(i_lReturnvalues(i).rData.vcData));
        ELSIF i_lReturnvalues(i).rData.vcDataType=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Retrieve returnvalue into Variable / Value ' || i_lReturnvalues(i).vcToVariable || '/' || TO_CHAR(i_lReturnvalues(i).rData.dtData));
        END IF;
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_POPULATE_PARAMLIST(i_nStackPos  IN NUMBER,
                                 i_lParamList IN PK_JRXML2PDF_TYPES.tParamList)
  RETURN PK_JRXML2PDF_TYPES.tParamList IS
    lParams PK_JRXML2PDF_TYPES.tParamList:=i_lParamList;
    iPos    PLS_INTEGER:=0;
  BEGIN
    FOR i IN 1..lParams.COUNT LOOP
      lParams(i).vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos      =>i_nStackPos,
                                                 i_vcExpression   =>lParams(i).vcValue,
                                                 i_vcPattern      =>NULL
                                                );
    END LOOP;
    -- for nls-support, pass the parameter PK_JRXML2PDF_TYPES.REPORT_LOCALE, if set in the main-report
    FOR i iN 1..lReportStack(i_nStackPos).lParams.COUNT LOOP
      IF lReportStack(i_nStackPos).lParams(i).vcName=PK_JRXML2PDF_TYPES.REPORT_LOCALE THEN
        iPos:=lParams.COUNT+1;
        lParams(iPos).vcName:=PK_JRXML2PDF_TYPES.REPORT_LOCALE;
        lParams(iPos).vcValue:=lReportStack(i_nStackPos).lParams(i).vcValue;
        EXIT;
      END IF;
    END LOOP;
    RETURN lParams;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CALC_BAND_HEIGHT(i_nStackPos        IN NUMBER,
                                i_rBand            IN PK_JRXML2PDF_TYPES.tBand,
                                i_bForceCalculate  IN BOOLEAN DEFAULT FALSE,
                                o_nbandHeight      OUT NUMBER,
                                o_nBandOffset      OUT NUMBER) IS
    nBandHeight   NUMBER:=0;
    vcText        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcPattern     PK_JRXML2PDF_TYPES.tPattern;
    rDummyArea    PK_JRXML2PDF_TYPES.tArea;
    blImage       BLOB;
    nHeightOffset NUMBER:=0;
    nDetailOffset NUMBER:=0;
    nDummy        NUMBER;
    nTextheight   NUMBER;
    nPos          NUMBER;
    bRender       BOOLEAN:=TRUE;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Scale band');
    END IF;
    IF i_rBand.vcWhenExpression IS NOT NULL THEN
      bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                     i_vcExpression=>i_rBand.vcWhenExpression
                                    );
    END IF;
    IF bRender THEN
      nBandHeight:=NVL(i_rBand.nHeight, 0);
      IF    i_rband.vcSplitType!=PK_JRXML2PDF_TYPES.STRETCH
         OR i_bForceCalculate THEN
        -- is not allowed to stretch, calculate object heights
        FOR i IN 1..i_rband.lObjects.COUNT LOOP
          nPos:=i_rband.lObjects(i).nPosition;
          IF i_rband.lObjects(i).nType=PK_JRXML2PDF_TYPES.SUBFRAME THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Scale subframe');
            END IF;
            PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                                i_rBand            =>lReportStack(i_nStackPos).lBands(nPos),
                                o_nbandHeight      =>nDummy,
                                o_nBandOffset      =>nDetailOffset
                               );
            nHeightOffset:=GREATEST(nHeightOffset, nDetailOffset);
          ELSIF i_rband.lObjects(i).nType=PK_JRXML2PDF_TYPES.FIELD THEN
            IF lReportStack(i_nStackPos).lFields(nPos).vcStretchOverflow=PK_JRXML2PDF_TYPES.YES THEN
              IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Scale Textfield ' || lReportStack(i_nStackPos).lFields(nPos).vcExpression);
              END IF;
              IF lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression IS NOT NULL THEN
                vcPattern:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                                  i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression,
                                                  i_vcPattern   =>NULL);
              ELSE
                vcPattern:=lReportStack(i_nStackPos).lFields(nPos).vcPattern;
              END IF;
              vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                             i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcExpression,
                                             i_vcPattern   =>vcPattern);
              IF lReportStack(i_nStackPos).lFields(nPos).vcMarkup='html' THEN
                nTextheight:=FK_CALC_HTML_HEIGHT(i_nX              =>lReportStack(i_nStackPos).lFields(nPos).nX,
                                                 i_nY              =>lReportStack(i_nStackPos).lFields(nPos).nY,
                                                 i_nWidth          =>lReportStack(i_nStackPos).lFields(nPos).nWidth,
                                                 i_nHeight         =>lReportStack(i_nStackPos).lFields(nPos).nHeight,
                                                 i_vcText          =>vcText,
                                                 i_vcFont          =>lReportStack(i_nStackPos).lFields(nPos).vcFont,
                                                 i_nFontSize       =>lReportStack(i_nStackPos).lFields(nPos).nFontSize,
                                                 i_vcAlignment     =>lReportStack(i_nStackPos).lFields(nPos).vcAlignment,
                                                 i_nTopPadding     =>lReportStack(i_nStackPos).lFields(nPos).nTopPadding,
                                                 i_nLeftPadding    =>lReportStack(i_nStackPos).lFields(nPos).nLeftPadding,
                                                 i_nBottomPadding  =>lReportStack(i_nStackPos).lFields(nPos).nBottomPadding,
                                                 i_nRightPadding   =>lReportStack(i_nStackPos).lFields(nPos).nRightPadding,
                                                 i_nLineSpacing    =>lReportStack(i_nStackPos).lFields(nPos).nLineSpacing,
                                                 i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lFields(nPos).vcStyle),
                                                 i_bEnhanced       =>NVL(lReportStack(i_nStackPos).lFields(nPos).vcKey, '.') LIKE 'enhanced%');
              ELSE
                nTextheight:=FK_CALC_TEXT_HEIGHT(i_nX              =>lReportStack(i_nStackPos).lFields(nPos).nX,
                                                 i_nY              =>lReportStack(i_nStackPos).lFields(nPos).nY,
                                                 i_nWidth          =>lReportStack(i_nStackPos).lFields(nPos).nWidth,
                                                 i_nHeight         =>lReportStack(i_nStackPos).lFields(nPos).nHeight,
                                                 i_vcText          =>vcText,
                                                 i_vcFont          =>lReportStack(i_nStackPos).lFields(nPos).vcFont,
                                                 i_nFontSize       =>lReportStack(i_nStackPos).lFields(nPos).nFontSize,
                                                 i_vcAlignment     =>lReportStack(i_nStackPos).lFields(nPos).vcAlignment,
                                                 i_nTopPadding     =>lReportStack(i_nStackPos).lFields(nPos).nTopPadding,
                                                 i_nLeftPadding    =>lReportStack(i_nStackPos).lFields(nPos).nLeftPadding,
                                                 i_nBottomPadding  =>lReportStack(i_nStackPos).lFields(nPos).nBottomPadding,
                                                 i_nRightPadding   =>lReportStack(i_nStackPos).lFields(nPos).nRightPadding,
                                                 i_nLineSpacing    =>lReportStack(i_nStackPos).lFields(nPos).nLineSpacing,
                                                 i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lFields(nPos).vcStyle));
              END IF;
              IF nTextheight>lReportStack(i_nStackPos).lFields(nPos).nHeight THEN
                IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
                  PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Field stretched from/to: ' || TO_CHAR(lReportStack(i_nStackPos).lFields(nPos).nHeight) || '/' || TO_CHAR(nTextheight));
                END IF;
                -- Field stretched
                nHeightOffset:=GREATEST(nHeightOffset,nTextheight-lReportStack(i_nStackPos).lFields(nPos).nHeight);
              END IF;
            END IF;
          END IF;
        END LOOP;
      END IF;
    END IF;
    o_nBandHeight:=nBandHeight+nHeightOffset;
    o_nBandOffset:=nHeightOffset;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_ADD_FIELD_FOR_LATER(i_nStackPos IN NUMBER,
                                   i_nX       IN NUMBER,
                                   i_nY       IN NUMBER,
                                   i_rField   IN PK_JRXML2PDF_TYPES.tField
                                  ) IS
    iPos   PLS_INTEGER:=NVL(lReportStack(i_nStackPos).lEvalLaterFields.LAST+1,1);
    rField PK_JRXML2PDF_TYPES.tField:=i_rField;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add Field for Later Expression / Page / Pos ' ||
                                       i_rField.vcExpression ||'/' ||
                                       lReportStack(1).lLogicalPageNumbers(lReportStack(1).nCurrentPagePointer) ||'/' || iPos);
    END IF;
    -- absoulte Position
    rField.nX:=rField.nX+i_nX;
    rField.nY:=rField.nY+i_nY;
    -- The page number has to be the gloabl pagenumber
    lReportStack(i_nStackPos).lEvalLaterPageNo(iPos):=lReportStack(1).lPageNumbers(lReportStack(1).nCurrentPagePointer);
    lReportStack(i_nStackPos).lEvalLaterFields(iPos):=rField;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_LATER_FIELDS(i_nStackPos         IN NUMBER,
                                   i_vcEvaluationTime  IN VARCHAr2,
                                   i_vcEvaluationGroup IN VARCHAR2 DEFAULT NULL,
                                   i_bKeepPagenumber   IN BOOLEAN  DEFAULT FALSE
                                  ) IS
    iPos      PLS_INTEGER:=lReportStack(i_nStackPos).lEvalLaterFields.FIRST;
    iDelPos   PLS_INTEGER;
    vcText    PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcPattern PK_JRXML2PDF_TYPES.tPattern;
    rDummy    PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Render later fields, type/count ' || i_vcEvaluationTime || '/' || TO_CHAR(lReportStack(i_nStackPos).lEvalLaterFields.COUNT));
    END IF;
    WHILE iPos IS NOT NULL LOOP
      IF     lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcEvaluationTime=i_vcEvaluationTime
         AND (   i_vcEvaluationTime!=PK_JRXML2PDF_TYPES.EVALUATION_GROUP
              OR (    i_vcEvaluationTime=PK_JRXML2PDF_TYPES.EVALUATION_GROUP
                  AND i_vcEvaluationGroup=lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcEvaluationGroup
                 )
             ) THEN
        -- Do it now, same like in Render band
        -- navigate to appropiate page
        -- special case PAGE_NUMBER is not rendered when i_bKeepPagenumber and evaluation tiem is REPORT
        IF     lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcEvaluationTime!=PK_JRXML2PDF_TYPES.EVALUATION_REPORT
           OR (    lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcEvaluationTime=PK_JRXML2PDF_TYPES.EVALUATION_REPORT
               AND NOT i_bKeepPagenumber
              )
           OR (    lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcEvaluationTime=PK_JRXML2PDF_TYPES.EVALUATION_REPORT
               AND i_bKeepPagenumber
               AND INSTR(lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcExpression, '{PAGE_NUMBER}')=0
              ) THEN
          AS_PDF3_MOD.PR_GOTO_PAGE(lReportStack(i_nStackPos).lEvalLaterPageNo(iPos));
          IF lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcPatternExpression IS NOT NULL THEN
            vcPattern:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                              i_vcExpression=>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcPatternExpression,
                                              i_vcPattern   =>NULL);
          ELSE
            vcPattern:=lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcPattern;
          END IF;
          vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>i_nStackPos,
                                         i_vcExpression =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcExpression,
                                         i_vcPattern    =>vcPattern);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render later field Page/Text: ' || lReportStack(i_nStackPos).lEvalLaterPageNo(iPos)
                                                                                 || vcText
                                               );
          END IF;
          rDummy:=FK_RENDER_TEXT(i_nX              =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nX,
                                 i_nY              =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nY,
                                 i_nWidth          =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nWidth,
                                 i_nHeight         =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nHeight,
                                 i_vcText          =>vcText,
                                 i_vcFont          =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcFont,
                                 i_nFontSize       =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nFontSize,
                                 i_vcFontStyle     =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcFontStyle,
                                 i_vcAlignment     =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcAlignment,
                                 i_vcVerticalAlign =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcVerticalAlign,
                                 i_vcBgColor       =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcBGColor,
                                 i_vcFgColor       =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcFGColor,
                                 i_nBoxTop         =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nBoxTop,
                                 i_nBoxLeft        =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nBoxLeft,
                                 i_nBoxBottom      =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nBoxBottom,
                                 i_nBoxRight       =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nBoxRight,
                                 i_nTopPadding     =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nTopPadding,
                                 i_nLeftPadding    =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nLeftPadding,
                                 i_nBottomPadding  =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nBottomPadding,
                                 i_nRightPadding   =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nRightPadding,
                                 i_vcBoxTopColor   =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcBoxTopColor,
                                 i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcBoxLeftColor,
                                 i_vcBoxBottomColor=>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcBoxBottomColor,
                                 i_vcBoxRightColor =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcBoxRightColor,
                                 i_nLineSpacing    =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).nLineSpacing,
                                 i_vcOpaque        =>lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcOpaque,
                                 i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lEvalLaterFields(iPos).vcStyle)
                                );
          -- back to current page
          AS_PDF3_MOD.PR_GOTO_CURRENT_PAGE;
          iDelPos:=iPos;
          iPos:=lReportStack(i_nStackPos).lEvalLaterFields.NEXT(iPos);
          -- delete written entry
          lReportStack(i_nStackPos).lEvalLaterFields.DELETE(iDelPos);
          lReportStack(i_nStackPos).lEvalLaterPageNo.DELETE(iDelPos);
        ELSE
          iPos:=lReportStack(i_nStackPos).lEvalLaterFields.NEXT(iPos);
        END IF;
      ELSE
        iPos:=lReportStack(i_nStackPos).lEvalLaterFields.NEXT(iPos);
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RENDER_CROSSTAB(i_nStackPos        IN NUMBER,
                              i_rCrosstab        IN PK_JRXML2PDF_TYPES.tCrosstab,
                              i_rArea            IN PK_JRXML2PDF_TYPES.tArea)
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    TYPE tCrossGroupEntry IS RECORD (
      vcIndex     PK_JRXML2PDF_TYPES.tMaxVarchar2,
      vcValue     PK_JRXML2PDF_TYPES.tMaxVarchar2,
      nValue      NUMBER,
      dtValue     DATE,
      iDetailList PLS_INTEGER
    );
    TYPE tCrossGroupEntries IS TABLE OF tCrossGroupEntry INDEX BY PK_JRXML2PDF_TYPES.tName;
    TYPE tCrossGroupEntriesList IS TABLE OF tCrossGroupEntries INDEX BY BINARY_INTEGER;
    TYPE tCellData IS RECORD (
      vcDatatype  PK_JRXML2PDF_TYPES.tDatatype,
      iCount      PLS_INTEGER,
      nSum        NUMBER,
      vcValue     PK_JRXML2PDF_TYPES.tMaxVarchar2,
      dtValue     DATE,
      nValue      NUMBER
    );
    TYPE tCellDataList IS TABLE OF tCellData INDEX BY PK_JRXML2PDF_TYPES.tName;
    TYPE tCellList     IS TABLE OF tCellDataList INDEX BY PK_JRXML2PDF_TYPES.tName;
    TYPE tRowList      IS TABLE OF PK_JRXML2PDF_TYPES.tName INDEX BY PK_JRXML2PDF_TYPES.tName;
    TYPE tMatrix       IS TABLE OF tRowList INDEX BY BINARY_INTEGER;
    TYPE tRowHeader IS RECORD (
      nStartX NUMBER,
      nStartY NUMBER,
      rBand   PK_JRXML2PDF_TYPES.tBand
    );
    TYPE tRowHeaderList IS TABLE OF tRowHeader INDEX BY BINARY_INTEGER;
    lRowHeaders         tRowHeaderList;
    lRowgroups          tCrossGroupEntriesList;
    lColGroups          tCrossGroupEntriesList;
    lCells              tCellList;
    lEmptyList          tCrossGroupEntries;
    rArea               PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    nRowOffset          NUMBER;
    nColPosition        NUMBER;
    nColGroupIdx        NUMBER;
    lColumnMatrix       tMatrix;
    rDummyArea          PK_JRXML2PDF_TYPES.tArea;
    nColumnFooterHeight NUMBER;
    nPageFooterheight   NUMBER;
    bDummy              BOOLEAN;
    lColHeaderHeights   PK_JRXML2PDF_TYPES.tNumList;
    bNoRowHeaders       BOOLEAN:=FALSE;
    bNeedsColumnHeader  BOOLEAN:=FALSE;
    lColKeys            PK_JRXML2PDF_TYPES.tIndexList;
    lRowKeys            PK_JRXML2PDF_TYPES.tIndexList;
    rEmptydata          tCellData;
    rHeaderBand         PK_JRXML2PDF_TYPES.tBand;
    PROCEDURE PR_SET_VARIABLE_FROM_DATA(i_nStackPos IN NUMBER,
                                        i_vcName    IN PK_JRXML2PDF_TYPES.tName,
                                        i_rData     IN tCellData,
                                        i_rMeasure  IN PK_JRXML2PDF_TYPES.tCrossTabMeasure
                                       ) IS
    BEGIN
      IF i_rMeasure.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_COUNT THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable/value for COUNT:' || i_vcName || '/' || TO_CHAR(i_rData.iCount));
        END IF;
        PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                        i_vcName   =>i_vcName,
                        i_nValue   =>NVL(i_rData.iCount,0)
                       );
      ELSIF i_rMeasure.vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_SUM THEN
        IF i_rData.vcdatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set number-variable/value:' || i_vcName || '/' || TO_CHAR(i_rData.nValue));
          END IF;
          PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                          i_vcName   =>i_vcName,
                          i_nValue   =>NVL(i_rData.nValue, 0)
                         );
        ELSE
          PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                          i_vcName   =>i_vcName,
                          i_nValue   =>0
                         );
        END IF;
      ELSIF i_rMeasure.vcCalculation IN (PK_JRXML2PDF_TYPES.CALCULATION_LOWEST,
                                         PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST,
                                         PK_JRXML2PDF_TYPES.CALCULATION_FIRST,
                                         PK_JRXML2PDF_TYPES.CALCULATION_NOTHING) THEN
        IF i_rData.vcdatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set number-variable/value:' || i_vcName || '/' || TO_CHAR(i_rData.nValue));
          END IF;
          PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                          i_vcName   =>i_vcName,
                          i_nValue   =>i_rData.nValue
                         );
        ELSIF i_rData.vcdatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set date-variable/value:' || i_vcName || '/' || TO_CHAR(i_rData.dtValue));
          END IF;
          PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                          i_vcName   =>i_vcName,
                          i_dtValue  =>i_rData.dtValue
                         );
        ELSE
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set varchar2-variable/value:' || i_vcName || '/' || TO_CHAR(i_rData.vcValue));
          END IF;
          PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                          i_vcName   =>i_vcName,
                          i_vcValue  =>i_rData.vcValue
                         );
        END IF;
      ELSIF i_rMeasure.vcCalculation IN (PK_JRXML2PDF_TYPES.CALCULATION_AVERAGE) THEN
        IF i_rData.vcdatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
          IF i_rData.iCount>0 THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable/value for AVG:' || i_vcName || '/' || TO_CHAR(i_rData.nValue/i_rData.iCount));
            END IF;
            PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                            i_vcName   =>i_vcName,
                            i_nValue   =>i_rData.nValue/i_rData.iCount
                           );
          ELSE
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set variable/value for AVG:' || i_vcName || '/0');
            END IF;
            PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                            i_vcName   =>i_vcName,
                            i_nValue   =>0
                           );
          END IF;
        END IF;
      END IF;
    END;
    PROCEDURE PR_SET_VARIABLE_FROM_CROSSTAB(i_vcName     IN PK_JRXML2PDF_TYPES.tName,
                                            i_vcDatatype IN PK_JRXML2PDF_TYPES.tDatatype,
                                            i_rEntry     IN tCrossGroupEntry
                                           ) IS
    BEGIN
      IF i_vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set crosstab-number-variable/value:' || i_vcName || '/' || TO_CHAR(i_rEntry.nValue));
        END IF;
        PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                        i_vcName   =>i_vcName,
                        i_nValue   =>i_rEntry.nValue
                       );
      ELSIF i_vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set crosstab-varchar2-variable/value:' || i_vcName || '/' || TO_CHAR(i_rEntry.vcValue));
        END IF;
        PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                        i_vcName   =>i_vcName,
                        i_vcValue  =>i_rEntry.vcValue
                       );
      ELSIF i_vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set crosstab-date-variable/value:' || i_vcName || '/' || TO_CHAR(i_rEntry.dtValue));
        END IF;
        PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                        i_vcName   =>i_vcName,
                        i_dtValue  =>i_rEntry.dtValue
                      );
      END IF;
    END;
    FUNCTION FK_MAKE_ENTRY(i_vcDatatype   IN PK_JRXML2PDF_TYPES.tDatatype,
                           i_vcExpression IN PK_JRXML2PDF_TYPES.tExpression
                          )
    RETURN tCrossGroupEntry IS
      rEntry      tCrossGroupEntry;
      vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_vcExpression,
                                              i_vcPattern    =>NULL,
                                              i_bForSQLUsage =>TRUE,
                                              i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE
                                             );
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Create entry-index for row/column from statement:' || vcStatement);
      END IF;
      IF i_vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
        EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                     INTO rEntry.nValue;
        rEntry.vcIndex:=TO_CHAR(rEntry.nValue, 'FM00000000000000000000D00000000000000000');
      ELSIF i_vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
        EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                     INTO rEntry.dtValue;
        rEntry.vcIndex:=TO_CHAR(rEntry.dtValue, 'YYYYMMDDHH24MISS');
      ELSE
        EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                     INTO rEntry.vcValue;
        rEntry.vcIndex:=rEntry.vcValue;
      END IF;
      RETURn rEntry;
    END;
    FUNCTION FK_REKU_ROWGROUPS(i_nRow          IN NUMBER,
                               i_nGroupListIdx IN PLS_INTEGER)
    RETURN PK_JRXML2PDF_TYPES.tMaxVarcharList IS
      rEntry      tCrossGroupEntry;
      lRowIndexes PK_JRXML2PDF_TYPES.tMaxVarcharList;
    BEGIN
      IF i_nRow<=i_rCrosstab.lRows.COUNT THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Recursive rowgroup-entry row/expression:' || TO_CHAR(i_nRow) || '/' || i_rCrosstab.lRows(i_nRow).vcBucketExpression);
        END IF;
        rEntry:=FK_MAKE_ENTRY(i_vcDatatype  =>i_rCrosstab.lRows(i_nRow).vcDatatype,
                              i_vcExpression=>i_rCrosstab.lRows(i_nRow).vcBucketExpression
                             );
        IF NOT lRowgroups(i_nGroupListIdx).EXISTS(rEntry.vcIndex) THEN
          lRowgroups(i_nGroupListIdx)(rEntry.vcIndex):=rEntry;
          lRowgroups(lRowgroups.COUNT+1):=lEmptyList;
          lRowgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList:=lRowgroups.COUNT;
        END IF;
        lRowIndexes:=FK_REKU_ROWGROUPS(i_nRow+1, lRowgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList);
        lRowIndexes(lRowIndexes.COUNT+1):=TO_CHAR(lRowgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList) || '_';
        IF i_nRow=1 THEN
          lRowIndexes(lRowIndexes.COUNT+1):=NULL;
        END IF;
      END IF;
      RETURN lRowIndexes;
    END;
    FUNCTION FK_REKU_COLGROUPS(i_nCol          IN NUMBER,
                               i_nGroupListIdx IN PLS_INTEGER)
    RETURN PK_JRXML2PDF_TYPES.tMaxVarcharList IS
      rEntry      tCrossGroupEntry;
      lColIndexes PK_JRXML2PDF_TYPES.tMaxVarcharList;
    BEGIN
      IF i_nCol<=i_rCrosstab.lColumns.COUNT THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Recursive colgroup-entry row/expression:' || TO_CHAR(i_nCol) || '/' || i_rCrosstab.lColumns(i_nCol).vcBucketExpression);
        END IF;
        -- evaluate value for row
        rEntry:=FK_MAKE_ENTRY(i_vcDatatype  =>i_rCrosstab.lColumns(i_nCol).vcDatatype,
                              i_vcExpression=>i_rCrosstab.lColumns(i_nCol).vcBucketExpression
                             );
        IF NOT lColgroups(i_nGroupListIdx).EXISTS(rEntry.vcIndex) THEN
          lColgroups(i_nGroupListIdx)(rEntry.vcIndex):=rEntry;
          lColgroups(lColgroups.COUNT+1):=lEmptyList;
          lColgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList:=lColgroups.COUNT;
          -- coun the number of last-level-columns
        END IF;
        lColIndexes:=FK_REKU_COLGROUPS(i_nCol+1, lColgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList);
        lColIndexes(lColIndexes.COUNT+1):=TO_CHAR(lColgroups(i_nGroupListIdx)(rEntry.vcIndex).iDetailList) || '_';
        IF i_nCol=1 THEN
          lColIndexes(lColIndexes.COUNT+1):=NULL;
        END IF;
      END IF;
      RETURN lColIndexes;
    END;
    PROCEDURE PR_LOAD_DATA IS
      rReport     PK_JRXML2PDF_TYPES.tReport;
      vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
      vcIndex     PK_JRXML2PDF_TYPES.tName;
      vcRowIndex  PK_JRXML2PDF_TYPES.tName;
      vcColIndex  PK_JRXML2PDF_TYPES.tName;
      vcIndex2    PK_JRXML2PDF_TYPES.tName;
      rCell       tCellDataList;
      rEmptyCell  tCellDataList;
      rData       tCellData;
      rEmptydata  tCellData;
      lRowIndexes PK_JRXML2PDF_TYPES.tMaxVarcharList;
      lColIndexes PK_JRXML2PDF_TYPES.tMaxVarcharList;
      nValue      NUMBER;
      dtValue     DATE;
      vcValue     PK_JRXML2PDF_TYPES.tMaxVarchar2;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Load crosstab-data from query');
      END IF;
      -- fake a report to execute the query
      rReport.vcQuery:=i_rCrosstab.vcQuery;
      -- Push to stack
      PR_PUSH_SUBREPORT_DATA(rReport);
      -- Init lists
      lRowgroups(1):=lEmptyList;
      lColgroups(1):=lEmptyList;
      PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), i_rCrosstab.lParams);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Fetching crosstab-data');
      END IF;
      IF FK_FETCH_ROW(lReportStack.COUNT) THEN
        LOOP
          -- build up rows and columns recursively from the values
          lRowIndexes:=FK_REKU_ROWGROUPS(1, 1);
          lColIndexes:=FK_REKU_COLGROUPS(1, 1);
          FOR i IN 1..lRowIndexes.COUNT LOOP
            FOR j IN 1..lColIndexes.COUNT LOOP
              vcIndex:=lRowIndexes(i) || '#' || lColIndexes(j);
              -- now put the measure in the cell
              IF lCells.EXISTS(vcIndex) THEN
                rCell:=lCells(vcIndex);
              ELSE
                rCell:=rEmptyCell;
              END IF;
              -- add up values
              FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
                IF rCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
                  rData:=rCell(i_rCrosstab.lMeasures(i).vcName);
                ELSE
                  rData:=rEmptydata;
                END IF;
                rData.iCount:=NVL(rData.iCount,0)+1;
                IF i_rCrosstab.lMeasures(i).vcCalculation!=PK_JRXML2PDF_TYPES.CALCULATION_COUNT THEN
                  vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos    =>lReportStack.COUNT,
                                                          i_vcExpression =>i_rCrosstab.lMeasures(i).vcExpression,
                                                          i_vcPattern    =>NULL,
                                                          i_bForSQLUsage =>TRUE,
                                                          i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE
                                                         );
                  IF i_rCrosstab.lMeasures(i).vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER THEN
                    rData.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
                    EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                                 INTO nValue;
                    IF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
                      rData.nValue:=NVL(GREATEST(rData.nValue, nValue), nValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation IN (PK_JRXML2PDF_TYPES.CALCULATION_SUM, PK_JRXML2PDF_TYPES.CALCULATION_AVERAGE) THEN
                      rData.nValue:=NVL(rData.nValue,0)+ NVL(nValue,0);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
                      rData.nValue:=NVL(LEAST(rData.nValue, nValue), nValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
                      IF rData.nValue IS NULL THEN
                        rData.nValue:=nValue;
                      END IF;
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
                      rData.nValue:=nValue;
                    END IF;
                  ELSIF i_rCrosstab.lMeasures(i).vcDatatype=PK_JRXML2PDF_TYPES.DATATYPE_DATE THEN
                    rData.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
                    EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                                 INTO dtValue;
                    IF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
                      rData.dtValue:=NVL(GREATEST(rData.dtValue, dtValue), dtValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
                      rData.dtValue:=NVL(LEAST(rData.dtValue, dtValue), dtValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
                      IF rData.dtValue IS NULL THEN
                        rData.dtValue:=dtValue;
                      END IF;
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
                      rData.dtValue:=dtValue;
                    END IF;
                  ELSE
                    rData.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
                    EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                                 INTO vcValue;
                    IF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_HIGHEST THEN
                      rData.vcValue:=NVL(GREATEST(rData.vcValue, vcValue), vcValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_LOWEST THEN
                      rData.vcValue:=NVL(LEAST(rData.vcValue, vcValue), vcValue);
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_FIRST THEN
                      IF rData.vcValue IS NULL THEN
                        rData.vcValue:=vcValue;
                      END IF;
                    ELSIF i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_NOTHING THEN
                      rData.vcValue:=vcValue;
                    END IF;
                  END IF;
                END IF;
                rCell(i_rCrosstab.lMeasures(i).vcName):=rData;
              END LOOP;
              -- store value back
              lCells(vcIndex):=rCell;
            END LOOP;
          END LOOP;
          EXIT WHEN NOT FK_FETCH_ROW(lReportStack.COUNT);
        END LOOP;
      END IF;
      -- take report back from stack
      PR_POP_SUBREPORT_DATA;
    END;
    PROCEDURE PR_ADD_COLUMN(i_vcDataIndex IN VARCHAR2,
                            i_vcName      IN VARCHAR2,
                            i_nColWidth   IN NUMBER
                           ) IS
      rEmptyEntry   tRowList;
    BEGIN
      IF nColPosition+i_nColWidth>i_rCrosstab.nWidth THEN
        -- new Columngroup
        nColGroupIdx:=nColGroupIdx+1;
        nColPosition:=nRowOffset;
        lColumnMatrix(nColGroupIdx):=rEmptyEntry;
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Add column Index/Name' || TO_CHAR(nColGroupIdx) || '/' || i_vcName);
      END IF;
      lColumnMatrix(nColGroupIdx)(NVL(i_vcDataIndex, PK_JRXML2PDF_TYPES.NIL)):=i_vcName;
      nColPosition:=nColPosition+i_nColWidth;
    END;
    PROCEDURE PR_REKU_ADD_COLUMN(i_nCol          IN NUMBER,
                                 i_nGroupListIdx IN NUMBER,
                                 i_vcKey         IN VARCHAR2) IS
      vcIndex PK_JRXML2PDF_TYPES.tIndex;
    BEGIN
      -- add all columnTotal with position start
      IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='Start' THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Recursive column-add, total at start ' || i_vcKey);
        END IF;
        PR_ADD_COLUMN(i_vcDataIndex=>i_vcKey,
                      i_vcName     =>i_rCrosstab.lColumns(i_nCol).vcName,
                      i_nColWidth  =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos).nWidth
                     );
      END IF;
      IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
        vcIndex:=lColGroups(i_nGroupListIdx).FIRST;
      ELSE
        vcIndex:=lColGroups(i_nGroupListIdx).LAST;
      END IF;
      WHILE vcIndex IS NOT NULL LOOP
        IF i_nCol<i_rCrosstab.lColumns.COUNT THEN
          -- process next level
          PR_REKU_ADD_COLUMN(i_nCol         =>i_nCol+1,
                             i_nGroupListIdx=>lColGroups(i_nGroupListIdx)(vcIndex).iDetailList,
                             i_vcKey        =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_'
                            );
        ELSE
          -- last level, add column to layout
          PR_ADD_COLUMN(i_vcDataIndex=>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_',
                        i_vcName     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_',
                        i_nColWidth  =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nHeaderPos).nWidth
                       );
        END IF;
        IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
          vcIndex:=lColGroups(i_nGroupListIdx).NEXT(vcIndex);
        ELSE
          vcIndex:=lColGroups(i_nGroupListIdx).PRIOR(vcIndex);
        END IF;
      END LOOP;
      -- add all columnTotal with position start
      IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='End' THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Recursive column-add, total at end ' || i_vcKey);
        END IF;
        PR_ADD_COLUMN(i_vcDataIndex=>i_vcKey,
                      i_vcName     =>i_rCrosstab.lColumns(i_nCol).vcName,
                      i_nColWidth  =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos).nWidth
                     );
      END IF;
    END;
    FUNCTION FK_CHECK_IN_COLSET(i_nColMatrixIdx IN NUMBER,
                                i_vcColkey      IN VARCHAR2
                               )
    RETURN BOOLEAN IS
    BEGIN
      RETURN lColumnMatrix(i_nColMatrixIdx).EXISTS(NVL(i_vcColkey, PK_JRXML2PDF_TYPES.NIL));
    END;
    PROCEDURE PR_SUMMARY_VARIABLES(i_nCurrentRow IN NUMBER,
                                   i_nCurrentCol IN NUMBER) IS
      rDataCell   tCellDataList;
      rEmptyCell  tCellDataList;
      vcIndex     PK_JRXML2PDF_TYPES.tName;
      vcRowIndex  PK_JRXML2PDF_TYPES.tName;
      vcColIndex  PK_JRXML2PDF_TYPES.tName;
      PROCEDURE PR_SET_ROW_VALUES IS
      BEGIN
        rDataCell:=rEmptyCell;
        vcIndex:='#';
        IF lCells.EXISTS(vcIndex) THEN
          rDataCell:=lCells(vcIndex);
        END IF;
        vcColIndex:=NULL;
        vcRowIndex:=NULL;
        FOR j IN 1..i_rCrossTab.lColumns.COUNT LOOP
          IF lColKeys.EXISTS(j)
             AND j<=i_nCurrentCol THEN
            -- now set the cell-values as variables
            vcColIndex:=lColKeys(j);
          END IF;
        END LOOP;
        FOR j IN 1..i_rCrossTab.lRows.COUNT LOOP
          IF     lRowKeys.EXISTS(j-1)
                AND j<=i_nCurrentRow THEN
            -- get the row-index from the above row
            vcRowIndex:=lRowKeys(j-1);
          END IF;
          vcIndex:=vcRowIndex || '#' || vcColIndex;
          IF lCells.EXISTS(vcIndex) THEN
            rDataCell:=lCells(vcIndex);
          END IF;
          FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
            -- set variable with value
            IF rDataCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
              PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                        i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lRows(j).vcName || '_ALL',
                                        i_rData    =>rDataCell(i_rCrosstab.lMeasures(i).vcName),
                                        i_rMeasure =>i_rCrosstab.lMeasures(i)
                                       );
            ELSE
              -- set variable to null
              PR_UNSET_VARIABLE(i_nStackPos=>i_nStackPos,
                                i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lRows(j).vcName || '_ALL'
                               );
            END IF;
          END LOOP;
        END LOOP;
      END;
      PROCEDURE PR_SET_COLUMN_VALUES IS
      BEGIN
        rDataCell:=rEmptyCell;
        vcIndex:='#';
        IF lCells.EXISTS(vcIndex) THEN
          rDataCell:=lCells(vcIndex);
        END IF;
        vcColIndex:=NULL;
        vcRowIndex:=NULL;
        FOR j IN 1..i_rCrossTab.lRows.COUNT LOOP
          IF lRowKeys.EXISTS(j)
             AND j<=i_nCurrentRow THEN
            -- now set the cell-values as variables
            vcRowIndex:=lRowKeys(j);
          END IF;
        END LOOP;
        FOR j IN 1..i_rCrossTab.lColumns.COUNT LOOP
          IF     lColKeys.EXISTS(j-1)
                AND j<=i_nCurrentCol THEN
            -- get the row-index from the above row
            vcColIndex:=lColKeys(j-1);
          END IF;
          vcIndex:=vcRowIndex || '#' || vcColIndex;
          IF lCells.EXISTS(vcIndex) THEN
            rDataCell:=lCells(vcIndex);
          END IF;
          FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
            -- set variable with value
            IF rDataCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
              PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                        i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lColumns(j).vcName || '_ALL',
                                        i_rData    =>rDataCell(i_rCrosstab.lMeasures(i).vcName),
                                        i_rMeasure =>i_rCrosstab.lMeasures(i)
                                       );
            ELSE
              -- set variable to null
              PR_UNSET_VARIABLE(i_nStackPos=>i_nStackPos,
                                i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lColumns(j).vcName || '_ALL'
                               );
            END IF;
          END LOOP;
        END LOOP;
      END;
      PROCEDURE PR_SET_CELL_VALUES IS
      BEGIN
        vcRowIndex:=NULL;
        FOR j IN 1..i_rCrossTab.lRows.COUNT LOOP
          IF lRowKeys.EXISTS(j-1) THEN
            -- now set the cell-values as variables
            vcRowIndex:=lRowKeys(j-1);
          END IF;
          vcColIndex:=NULL;
          FOR z IN 1..i_rCrossTab.lColumns.COUNT LOOP
            IF lColKeys.EXISTS(z-1) THEN
              -- now set the cell-values as variables
              vcColIndex:=lColKeys(z-1);
            END IF;
            IF lCells.EXISTS(vcRowIndex || '#' || vcColIndex) THEN
              rDataCell:=lCells(vcRowIndex || '#' || vcColIndex);
            END IF;
            FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
              -- set variable with value
              IF rDataCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
                PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                          i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lRows(j).vcName || '_' || i_rCrosstab.lColumns(z).vcName || '_ALL',
                                          i_rData    =>rDataCell(i_rCrosstab.lMeasures(i).vcName),
                                          i_rMeasure =>i_rCrosstab.lMeasures(i)
                                         );
              ELSE
                -- set variable to null
                PR_UNSET_VARIABLE(i_nStackPos=>i_nStackPos,
                                  i_vcName   =>i_rCrosstab.lMeasures(i).vcName || '_' || i_rCrosstab.lRows(j).vcName || '_' || i_rCrosstab.lColumns(z).vcName || '_ALL'
                                 );
              END IF;
            END LOOP;
          END LOOP;
        END LOOP;
      END;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Setting summary-variables for rows/cols/cells ');
      END IF;
      PR_SET_ROW_VALUES;
      PR_SET_COLUMN_VALUES;
      PR_SET_CELL_VALUES;
    END;
    PROCEDURE PR_COLUMN_HEIGHT(i_nCol          IN  NUMBER,
                               i_nColMatrixIdx IN  NUMBER,
                               i_vcColIndex    IN  VARCHAR2,
                               i_vcColkey      IN  VARCHAR2
                              ) IS
      nHeight NUMBER;
      nDummy  NUMBER;
      rBand   PK_JRXML2PDF_TYPES.tBand;
    BEGIN
      IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                            i_vcColkey     =>i_vcColKey) THEN
        -- set variables for all row
        PR_SET_VARIABLE(i_nStackPos=>i_nStackPos,
                        i_vcName   =>i_rCrosstab.lColumns(i_nCol).vcName,
                        i_vcValue  =>i_vcColIndex
                       );
        rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nHeaderPos);
        -- Calc height for row-part
        PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                            i_rBand       =>rBand,
                            o_nbandHeight =>nHeight,
                            o_nBandOffset =>nDummy
                           );
        lColHeaderHeights(i_nCol):=GREATEST(lColHeaderHeights(i_nCol), nHeight);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Calculate rowheight name/key/height:' || i_rCrosstab.lColumns(i_nCol).vcName || '/' || i_vcColIndex|| '/' || nHeight);
        END IF;
      END IF;
    END;
    PROCEDURE PR_REKU_COLUMN_HEIGHTS(i_nColMatrixIdx IN NUMBER,
                                     i_nCol          IN NUMBER,
                                     i_nGroupListIdx IN NUMBER,
                                     i_vcColKey      IN PK_JRXML2PDF_TYPES.tIndex)  IS
      vcIndex       PK_JRXML2PDF_TYPES.tName;
      nMinHeight    NUMBER;
      nDummy        NUMBER;
      nYOffset      NUMBER;
      rDummyArea    PK_JRXML2PDF_TYPES.tArea:=rArea;
      rReturnArea   PK_JRXML2PDF_TYPES.tArea;
      rBand         PK_JRXML2PDF_TYPES.tBand;
      nStartWidth   NUMBER;
      nHeight       NUMBER;
    BEGIN
      IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                            i_vcColKey     =>i_vcColKey) THEN
        IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition IN ('Start', 'End') THEN
          -- calculate height for total column
          rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos);
          PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                              i_rBand       =>rBand,
                              o_nbandHeight =>nHeight,
                              o_nBandOffset =>nDummy
                             );
          lColHeaderHeights(i_nCol):=GREATEST(lColHeaderHeights(i_nCol), nHeight);
        END IF;
      END IF;
      IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
        vcIndex:=lColGroups(i_nGroupListIdx).FIRST;
      ELSE
        vcIndex:=lColGroups(i_nGroupListIdx).LAST;
      END IF;
      WHILE vcIndex IS NOT NULL LOOP
        PR_SUMMARY_VARIABLES(i_nCurrentRow =>1,
                             i_nCurrentCol =>i_nCol);
        -- put the value of the col-value into the variable-cache
        PR_SET_VARIABLE_FROM_CROSSTAB(i_vcName    =>i_rCrosstab.lColumns(i_nCol).vcName,
                                      i_vcDatatype=>i_rCrosstab.lColumns(i_nCol).vcDatatype,
                                      i_rEntry    =>lColGroups(i_nGroupListIdx)(vcIndex)
                                     );
        IF i_nCol<i_rCrosstab.lColumns.COUNT THEN
          -- calculate the height for the current header, if its not the last
          PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                              i_rBand       =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nHeaderPos),
                              o_nbandHeight =>nHeight,
                              o_nBandOffset =>nDummy
                             );
          lColHeaderHeights(i_nCol):=GREATEST(lColHeaderHeights(i_nCol), nHeight);
          PR_REKU_COLUMN_HEIGHTS(i_nColMatrixIdx=>i_nColMatrixIdx,
                                 i_nCol         =>i_nCol+1,
                                 i_nGroupListIdx=>lColGroups(i_nGroupListIdx)(vcIndex).iDetailList,
                                 i_vcColKey     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_'
                                );
        ELSE
          -- last level, add column to layout
          PR_COLUMN_HEIGHT(i_nCol         =>i_nCol,
                           i_nColMatrixIdx=>i_nColMatrixIdx,
                           i_vcColIndex   =>vcIndex,
                           i_vcColkey     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_'
                           );
        END IF;
        IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
          vcIndex:=lColGroups(i_nGroupListIdx).NEXT(vcIndex);
        ELSE
          vcIndex:=lColGroups(i_nGroupListIdx).PRIOR(vcIndex);
        END IF;
      END LOOP;
    END;
    FUNCTION FK_RENDER_COL(i_nCol          IN  NUMBER,
                           i_nColMatrixIdx IN  NUMBER,
                           i_vcColIndex    IN  PK_JRXML2PDF_TYPES.tIndex,
                           i_vcColkey      IN  PK_JRXML2PDF_TYPES.tIndex,
                           i_nColWidth     IN  NUMBER,
                           i_nYOffset      IN  NUMBER,
                           o_bInSet        OUT BOOLEAN
                          )
    RETURN PK_JRXML2PDF_TYPES.tArea IS
      nCellHeight NUMBER;
      nCellOffset NUMBER;
      rBand       PK_JRXML2PDF_TYPES.tBand;
    BEGIN
      o_bInSet:=FK_CHECK_IN_COLSET(i_nColMatrixIdx, i_vcColKey);
      IF NOT o_bInset THEN
        rDummyArea:=rArea;
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render column Num/Key:' || TO_CHAR(i_nCol) || '/' || i_vcColkey);
        END IF;
        rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nHeaderPos);
        -- Calc height for row-part
        PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                            i_rBand       =>rBand,
                            o_nbandHeight =>nCellHeight,
                            o_nBandOffset =>nCellOffset
                           );
        IF lColHeaderheights(i_nCol)<nCellHeight THEN
          rBand.nHeight:=lColHeaderheights(i_nCol);
        END IF;
        -- Render the row-header
        rDummyArea.nX:=i_nColWidth;
        rDummyArea.nY:=rArea.nY+i_nYOffset;
        rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                   i_rBand           =>rBand,
                                   i_rArea           =>rDummyArea,
                                   i_bAllowSubReports=>FALSE,
                                   i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
        rDummyArea.nX:=i_nColWidth+rBand.nWidth;
        o_bInSet:=TRUE;
      END IF;
      RETURN rDummyArea;
    END;
    FUNCTION FK_REKU_RENDER_COLS(i_nColMatrixIdx IN NUMBER,
                                 i_nCol          IN NUMBER,
                                 i_nGroupListIdx IN NUMBER,
                                 i_vcColKey      IN PK_JRXML2PDF_TYPES.tIndex,
                                 i_nMinHeight    IN NUMBER,
                                 i_nXOffset      IN NUMBER,
                                 i_nYOffset      IN NUMBER,
                                 o_bInSet        OUT BOOLEAN)
    RETURN PK_JRXML2PDF_TYPES.tArea IS
      vcIndex       PK_JRXML2PDF_TYPES.tIndex;
      nMinHeight    NUMBER;
      nDummy        NUMBER;
      nYOffset      NUMBER;
      rDummyArea    PK_JRXML2PDF_TYPES.tArea:=rArea;
      rReturnArea   PK_JRXML2PDF_TYPES.tArea;
      rBand         PK_JRXML2PDF_TYPES.tBand;
      nStartWidth   NUMBER;
      bInSet        BOOLEAN;
      nXForTotal    NUMBER;
    BEGIN
      o_bInSet:=FALSE;
      rReturnArea.nX:=i_nXOffset;
      rReturnArea.nY:=i_nYOffset;
      IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                            i_vcColKey     =>i_vcColKey) THEN
        IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='Start' THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Keep space for total at start col/key:' || TO_CHAR(i_nCol) || '/' || i_vcColKey);
          END IF;
          -- Render the col-header for this column
          rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos);
          -- just remeber the x-position and reserve space
          nXForTotal:=rReturnArea.nX;
          rReturnArea.nX:=rReturnArea.nX+rBand.nWidth;
        END IF;
      END IF;
      IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
        vcIndex:=lColGroups(i_nGroupListIdx).FIRST;
      ELSE
        vcIndex:=lColGroups(i_nGroupListIdx).LAST;
      END IF;
      WHILE vcIndex IS NOT NULL LOOP
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render column col/key:' || TO_CHAR(i_nCol) || '/' || vcIndex);
        END IF;
        lColKeys(i_nCol):=TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_';
        PR_SUMMARY_VARIABLES(i_nCurrentRow =>1,
                             i_nCurrentCol =>i_nCol);
        -- put the value of the col-value into the variable-cache
        PR_SET_VARIABLE_FROM_CROSSTAB(i_vcName    =>i_rCrosstab.lColumns(i_nCol).vcName,
                                      i_vcDatatype=>i_rCrosstab.lColumns(i_nCol).vcDatatype,
                                      i_rEntry    =>lColGroups(i_nGroupListIdx)(vcIndex)
                                     );
        IF i_nCol<i_rCrosstab.lColumns.COUNT THEN
          -- calculate the height for the current header, if its not the last
          nYOffset:=i_rCrosstab.lColumns(i_nCol).nHeight;
          nStartWidth:=rReturnArea.nX;
          rDummyArea:=FK_REKU_RENDER_COLS(i_nColMatrixIdx=>i_nColMatrixIdx,
                                          i_nCol         =>i_nCol+1,
                                          i_nGroupListIdx=>lColGroups(i_nGroupListIdx)(vcIndex).iDetailList,
                                          i_vcColKey     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_',
                                          i_nMinHeight   =>GREATEST(nMinHeight, i_nMinHeight),
                                          i_nXOffset     =>rReturnArea.nX,
                                          i_nYOffset     =>i_nYOffset+nYOffset,
                                          o_bInSet       =>bInSet
                                         );
          IF bInset THEN
            PR_SUMMARY_VARIABLES(i_nCurrentRow =>1,
                                 i_nCurrentCol =>i_nCol);
            rReturnArea.nX:=rDummyArea.nX;
            rReturnArea.nY:=GREATEST(rDummyArea.nY, rReturnArea.nY);
            -- Render the col-header for this column
            rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nHeaderPos);
            rBand.nX:=0;
            rBand.nWidth:=rReturnArea.nX-nStartWidth;
            rDummyArea.nY:=rArea.nY+i_nYOffset;
            rDummyArea.nX:=nStartWidth;
            rDummyArea:=FK_RENDER_BAND(i_nStackPos          =>i_nStackPos,
                                       i_rBand              =>rBand,
                                       i_rArea              =>rDummyArea,
                                       i_bAllowSubReports   =>FALSE,
                                       i_nRenderFrame       =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER,
                                       i_vcContentAdjustment=>i_rCrosstab.lColumns(i_nCol).vcHeaderPosition
                                      );
            nStartWidth:=rDummyArea.nX+rBand.nWidth;
            rReturnArea.nX:=rDummyArea.nX+rBand.nWidth;
            rReturnArea.nY:=GREATEST(rDummyArea.nY, rReturnArea.nY);
            o_bInSet:=TRUE;
          END IF;
        ELSE
          -- last level, add column to layout
          rDummyArea:=FK_RENDER_COL(i_nCol         =>i_nCol,
                                    i_nColMatrixIdx=>i_nColMatrixIdx,
                                    i_vcColIndex   =>vcIndex,
                                    i_vcColkey     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_',
                                    i_nColWidth    =>rReturnArea.nX,
                                    i_nYOffset     =>i_nYOffset,
                                    o_bInSet       =>bInSet
                                   );
          IF bInSet THEN
            rReturnArea.nX:=rDummyArea.nX;
            rReturnArea.nY:=GREATEST(rDummyArea.nY, rReturnArea.nY);
            o_bInSet:=TRUE;
          END IF;
        END IF;
        IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
          vcIndex:=lColGroups(i_nGroupListIdx).NEXT(vcIndex);
        ELSE
          vcIndex:=lColGroups(i_nGroupListIdx).PRIOR(vcIndex);
        END IF;
      END LOOP;
      lColKeys.DELETE(i_nCol);
      IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                            i_vcColKey     =>i_vcColKey) THEN
        IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='Start' THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render total at start col/key:' || TO_CHAR(i_nCol) || '/' || i_vcColKey);
          END IF;
          -- Render the col-header for this column
          rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos);
          rDummyArea.nY:=rArea.nY+i_nYOffset;
          -- set height
          --rBand.nHeight:=lColHeaderHeights(i_nCol);
          rBand.nHeight:=rReturnArea.nY-rDummyArea.nY;
          -- x-position is the one saved at start
          rDummyArea.nX:=nXForTotal;
          rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                     i_rBand           =>rBand,
                                     i_rArea           =>rDummyArea,
                                     i_bAllowSubReports=>FALSE,
                                     i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
          rReturnArea.nY:=GREATEST(rDummyArea.nY, rReturnArea.nY);
          o_bInSet:=TRUE;
        ELSIF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='End' THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render total at end col/key:' || TO_CHAR(i_nCol) || '/' || i_vcColKey);
          END IF;
          -- Render the col-header for this column
          rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lColumns(i_nCol).nTotalHeaderPos);
          rDummyArea.nY:=rArea.nY+i_nYOffset;
          -- set height
          rBand.nHeight:=GREATEST(rReturnArea.nY-rDummyArea.nY, rBand.nHeight);
          rDummyArea.nX:=rReturnArea.nX;
          rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                     i_rBand           =>rBand,
                                     i_rArea           =>rDummyArea,
                                     i_bAllowSubReports=>FALSE,
                                     i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
          rReturnArea.nX:=rDummyArea.nX+rBand.nWidth;
          rReturnArea.nY:=GREATEST(rDummyArea.nY, rReturnArea.nY);
          o_bInSet:=TRUE;
        END IF;
      END IF;
      RETURN rReturnArea;
    END;
    PROCEDURE PR_RENDER_ROWHEADER(i_nHeaderPos IN NUMBER,
                                  i_bRenderAll IN BOOLEAN
                                 ) IS
      rDummyArea PK_JRXML2PDF_TYPES.tArea;
      rBand      PK_JRXML2PDF_TYPES.tBand;
      iStart     PLS_INTEGER:=i_nHeaderPos;
      iEnd       PLS_INTEGER:=i_nHeaderPos;
    BEGIN
      IF NOT bNoRowHeaders
         AND lRowHeaders.COUNT>0 THEN
        IF i_bRenderAll THEN
          iEnd:=1;
        END IF;
        FOR i IN REVERSE iStart..iEnd LOOP
          -- Render the row-header for this row
          rBand:=lRowHeaders(i).rBand;
          rBand.nHeight:=rArea.nY-lRowHeaders(i).nStartY;
          rDummyArea.nX:=lRowHeaders(i).nStartX;
          rDummyArea.nY:=lRowHeaders(i).nStartY;
          rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                     i_rBand           =>rBand,
                                     i_rArea           =>rDummyArea,
                                     i_bAllowSubReports=>FALSE,
                                     i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER,
                                     i_vcContentAdjustment=>i_rCrosstab.lRows(i).vcHeaderPosition
                                    );
        END LOOP;
      END IF;
    END;
    FUNCTION FK_CALC_ROW_HEIGHT(i_nRow          IN  NUMBER,
                                i_nColMatrixIdx IN  NUMBER,
                                i_nMinHeight    IN  NUMBER,
                                i_vcColBandName IN  PK_JRXML2PDF_TYPES.tName,
                                i_rRowBand      IN  PK_JRXML2PDF_TYPES.tBand)
    RETURN NUMBER IS
      nRowheight  NUMBER:=i_nMinHeight;
      nCellHeight NUMBER;
      nCellOffset NUMBER;
      rCell       PK_JRXML2PDF_TYPES.tCrossTabCell;
      vcIndex     PK_JRXML2PDF_TYPES.tIndex;
    BEGIN
      IF i_rCrosstab.lCells.EXISTS(i_rCrosstab.lRows(i_nRow).vcName || '_') THEN
        rCell:=i_rCrosstab.lCells(i_rCrosstab.lRows(i_nRow).vcName || '_');
      ELSE
        rCell:=i_rCrosstab.lCells('_');
      END IF;
      -- Calc height for row-part
      PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                          i_rBand       =>i_rRowBand,
                          o_nbandHeight =>nCellHeight,
                          o_nBandOffset =>nCellOffset
                         );
      nRowHeight:=GREATEST(nRowHeight, nCellHeight);
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Calculate max row height for row :' || i_rCrosstab.lRows(i_nRow).vcName || '/' || TO_CHAR(nCellHeight));
      END IF;
      -- calculate height for each cell, take the maximum for the whole row
      vcIndex:=lColumnMatrix(i_nColMatrixIdx).FIRST;
      WHILE vcIndex IS NOT NULL LOOP
        -- get the cell matric the column-value
        IF i_rCrosstab.lCells.EXISTS(i_vcColBandName || '_' || lColumnMatrix(i_nColMatrixIdx)(vcIndex)) THEN
          rCell:=i_rCrosstab.lCells(i_vcColBandName || '_' || lColumnMatrix(i_nColMatrixIdx)(vcIndex));
        ELSIF i_rCrosstab.lCells.EXISTS(i_vcColBandName || '_') THEN
          rCell:=i_rCrosstab.lCells(i_vcColBandName || '_');
        ELSE
          rCell:=i_rCrosstab.lCells('_');
        END IF;
        -- not found then get the matrix-cell itself
        PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                            i_rBand       =>lReportStack(i_nStackPos).lBands(rCell.nCellPos),
                            o_nbandHeight =>nCellHeight,
                            o_nBandOffset =>nCellOffset
                           );
        nRowHeight:=GREATEST(nRowHeight, nCellHeight);
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Calculate max row height for row :' || i_rCrosstab.lRows(i_nRow).vcName || '/' || vcIndex || '/' || TO_CHAR(nCellHeight));
        END IF;
        vcIndex:=lColumnMatrix(i_nColMatrixIdx).NEXT(vcIndex);
      END LOOP;
      RETURN nRowHeight;
    END;
    FUNCTION FK_RENDER_ROW(i_nRow          IN  NUMBER,
                           i_nColMatrixIdx IN  NUMBER,
                           i_vcRowIndex    IN  PK_JRXML2PDF_TYPES.tIndex,
                           i_vcRowkey      IN  PK_JRXML2PDF_TYPES.tIndex,
                           i_nMinHeight    IN  NUMBER,
                           i_nXOffset      IN  NUMBER,
                           i_rRowband      IN  PK_JRXML2PDF_TYPES.tBand,
                           i_vcColBandName IN  PK_JRXML2PDF_TYPES.tName)
    RETURN PK_JRXML2PDF_TYPES.tArea IS
      nRowheight  NUMBER:=i_nMinHeight;
      nColHeight  NUMBER:=0;
      nCellHeight NUMBER;
      nCellOffset NUMBER;
      rDummyArea  PK_JRXML2PDF_TYPES.tArea;
      rCell       PK_JRXML2PDF_TYPES.tCrossTabCell;
      rBand       PK_JRXML2PDF_TYPES.tBand;
      rDataCell   tCellDataList;
      rEmptyCell  tCellDataList;
      vcIndex     PK_JRXML2PDF_TYPES.tName;
      nDummy      NUMBER;
      rReturnArea PK_JRXML2PDF_TYPES.tArea;
      nTempY      NUMBER;
      PROCEDURE PR_RENDER_CELL(i_nCol IN NUMBER, i_vcColKey IN VARCHAR2) IS
        vcname  PK_JRXML2PDF_TYPES.tName;
        vcIndex PK_JRXML2PDF_TYPES.tName;
      BEGIN
        vcName:=lColumnMatrix(i_nColMatrixIdx)(NVL(i_vcColKey, PK_JRXML2PDF_TYPES.NIL));
        -- set summary values
        PR_SUMMARY_VARIABLES(i_nCurrentRow =>i_nRow,
                             i_nCurrentCol =>i_nCol);
      -- get the cell matric the column-value
        IF i_rCrosstab.lCells.EXISTS(i_vcColBandName || '_' || vcName) THEN
          rCell:=i_rCrosstab.lCells(i_vcColBandName || '_' || vcName);
        ELSIF i_rCrosstab.lCells.EXISTS(i_vcColBandName || '_') THEN
          rCell:=i_rCrosstab.lCells(i_vcColBandName || '_');
        ELSE
          rCell:=i_rCrosstab.lCells('_');
        END IF;
        rDummyArea.nY:=rArea.nY;
        rDummyArea.nPage:=rArea.nPage;
        -- now set the cell-values as variables
        vcIndex:=i_vcRowKey  || '#' || i_vcColKey;
        IF lCells.EXISTS(vcIndex) THEN
          rDataCell:=lCells(vcIndex);
        ELSE
          rDataCell:=rEmptyCell;
        END IF;
        FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
          -- set variable with value
          IF rDataCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
            PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                      i_vcName   =>i_rCrosstab.lMeasures(i).vcName,
                                      i_rData    =>rDataCell(i_rCrosstab.lMeasures(i).vcName),
                                      i_rMeasure =>i_rCrosstab.lMeasures(i)
                                     );
          ELSE
            -- Type count will return 0, others NULL
            IF    i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_COUNT
               OR i_rCrosstab.lMeasures(i).vcCalculation=PK_JRXML2PDF_TYPES.CALCULATION_SUM THEN
              PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                        i_vcName   =>i_rCrosstab.lMeasures(i).vcName,
                                        i_rData    =>rEmptydata,
                                        i_rMeasure =>i_rCrosstab.lMeasures(i)
                                       );
            ELSE
              -- set variable to null
              PR_UNSET_VARIABLE(i_nStackPos=>i_nStackPos,
                                i_vcName   =>i_rCrosstab.lMeasures(i).vcname
                               );
            END IF;
          END IF;
        END LOOP;
        rBand:=lReportStack(i_nStackPos).lBands(rCell.nCellPos);
        rBand.nHeight:=nRowHeight;
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render cell :' || TO_CHAR(i_nCol)  || '/' || i_vcColKey);
        END IF;
        rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                   i_rBand           =>rBand,
                                   i_rArea           =>rDummyArea,
                                   i_bAllowSubReports=>FALSE,
                                   i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
        rDummyArea.nX:=rDummyArea.nX+rBand.nWidth;
      END;
      PROCEDURE PR_REKU_RENDER_CELLS(i_nCol          IN NUMBER,
                                     i_nGroupListIdx IN NUMBER,
                                     i_vcColKey      IN PK_JRXML2PDF_TYPES.tName) IS
        vcIndex PK_JRXML2PDF_TYPES.tName;
      BEGIN
        IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                              i_vcColKey     =>i_vcColKey) THEN
          IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='Start' THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render cell total at start:' || TO_CHAR(i_nCol)  || '/' || i_vcColKey);
            END IF;
            -- Render the col-header for this column
            --lColumnMatrix(i_nColMatrixIdx)(i).vcName
            PR_RENDER_CELL(i_nCol    =>i_nCol,
                           i_vcColKey=>i_vcColKey);
          END IF;
        END IF;
        IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
          vcIndex:=lColGroups(i_nGroupListIdx).FIRST;
        ELSE
          vcIndex:=lColGroups(i_nGroupListIdx).LAST;
        END IF;
        WHILE vcIndex IS NOT NULL LOOP
          lColKeys(i_nCol):=TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_';
          IF i_nCol<i_rCrosstab.lColumns.COUNT THEN
            -- calculate the height for the current header, if its not the last
            PR_REKU_RENDER_CELLS(i_nCol         =>i_nCol+1,
                                 i_nGroupListIdx=>lColGroups(i_nGroupListIdx)(vcIndex).iDetailList,
                                 i_vcColKey     =>TO_CHAR(lColGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_'
                                );
          ELSE
            IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                                  i_vcColKey     =>lColKeys(i_nCol)) THEN
              PR_RENDER_CELL(i_nCol    =>i_nCol,
                             i_vcColKey=>lColKeys(i_nCol)
                            );
            END IF;
          END IF;
          IF i_rCrosstab.lColumns(i_nCol).vcOrderBy=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
            vcIndex:=lColGroups(i_nGroupListIdx).NEXT(vcIndex);
          ELSE
            vcIndex:=lColGroups(i_nGroupListIdx).PRIOR(vcIndex);
          END IF;
          lColKeys.DELETE(i_nCol);
        END LOOP;
        IF FK_CHECK_IN_COLSET(i_nColMatrixIdx=>i_nColMatrixIdx,
                              i_vcColKey     =>i_vcColKey) THEN
          IF i_rCrosstab.lColumns(i_nCol).vcTotalPosition='End' THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render cell total at end:' || TO_CHAR(i_nCol)  || '/' || i_vcColKey);
            END IF;
            -- Render the col-header for this column
            PR_RENDER_CELL(i_nCol    =>i_nCol,
                           i_vcColKey=>i_vcColKey
                          );
          END IF;
        END IF;
      END;
    BEGIN
      rReturnArea.nX:=i_nXOffset;
      IF bNeedsColumnHeader THEN
        FOR i IN 1..lColHeaderHeights.COUNT LOOP
          nColHeight:=nColheight+lColHeaderHeights(i);
        END LOOP;
      END IF;
      nRowHeight:=FK_CALC_ROW_HEIGHT(i_nRow         =>i_nRow,
                                     i_nColMatrixIdx=>i_nColMatrixIdx,
                                     i_nMinHeight   =>i_nMinHeight,
                                     i_vcColBandName=>i_vcColBandName,
                                     i_rRowband     =>i_rRowband
                                    );
      -- Check if region fits on page
      IF NOT FK_FITS_IN_PAGE(rArea.nY, nColHeight+nRowHeight) THEN
        -- finish open row-headers
        PR_RENDER_ROWHEADER(i_nHeaderPos=>lRowHeaders.COUNT,
                            i_bRenderAll=>TRUE
                           );
        -- skip to last record to have the correct data in the buffer
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render crostab-row on new page,record:' || lReportStack(i_nStackPos).rQuery.nRecordPosition);
        END IF;
        PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                     i_nStackPos     =>i_nStackPos,
                                     i_bOneRecordBack=>TRUE);
        -- check, if Colheaders have to be repeated
        IF i_rCrosstab.vcRepeatColHeaders=PK_JRXML2PDF_TYPES.YES THEN
          rDummyArea:=FK_REKU_RENDER_COLS(i_nColMatrixIdx =>i_nColMatrixIdx,
                                          i_nCol          =>1,
                                          i_nGroupListIdx =>1,
                                          i_vcColKey      =>NULL,
                                          i_nMinHeight    =>0,
                                          i_nXOffset      =>nRowOffset,
                                          i_nYOffset      =>0,
                                          o_bInSet        =>bDummy);
          nTempY:=rArea.nY;
          rArea.nY:=rDummyArea.nY;
        END IF;
        -- set the start-positions for the rowheaders
        FOR i IN 1..lRowHeaders.COUNT LOOP
          lRowHeaders(i).nStartY:=rArea.nY;
        END LOOP;
        IF i_rCrosstab.rHeaderCell.nCellPos IS NOT NULL THEN
          -- render the Headercell
           rHeaderBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.rHeaderCell.nCellPos);
           rHeaderBand.nHeight:=rArea.nY-nTempY;
           rHeaderBand.nWidth:=nRowOffset;
           rDummyArea.nx:=rReturnArea.nX;
           rDummyArea.nY:=nTempY;
           rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                      i_rBand           =>rHeaderBand,
                                      i_rArea           =>rDummyArea,
                                      i_bAllowSubReports=>FALSE,
                                      i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
        END IF;
        -- Reset flag for column-headers, are already done
        bNeedsColumnHeader:=FALSE;
      ELSE
        IF bNeedsColumnHeader THEN
          bNeedsColumnHeader:=FALSE;
          rDummyArea:=FK_REKU_RENDER_COLS(i_nColMatrixIdx =>i_nColMatrixIdx,
                                          i_nCol          =>1,
                                          i_nGroupListIdx =>1,
                                          i_vcColKey      =>NULL,
                                          i_nMinHeight    =>0,
                                          i_nXOffset      =>nRowOffset,
                                          i_nYOffset      =>0,
                                          o_bInSet        =>bDummy);
          nTempY:=rArea.nY;
          rArea.nY:=rDummyArea.nY;
          -- set the start-positions for the rowheaders
          FOR i IN 1..lRowHeaders.COUNT LOOP
            lRowHeaders(i).nStartY:=rArea.nY;
          END LOOP;
          IF i_rCrosstab.rHeaderCell.nCellPos IS NOT NULL THEN
            -- render the Headercell
             rHeaderBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.rHeaderCell.nCellPos);
             rHeaderBand.nHeight:=rArea.nY-nTempY;
             rHeaderBand.nWidth:=nRowOffset;
             rDummyArea.nx:=rReturnArea.nX;
             rDummyArea.nY:=nTempY;
             rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                        i_rBand           =>rHeaderBand,
                                        i_rArea           =>rDummyArea,
                                        i_bAllowSubReports=>FALSE,
                                        i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
          END IF;
        END IF;
      END IF;
      PR_SUMMARY_VARIABLES(i_nCurrentRow =>i_nRow,
                           i_nCurrentCol =>1
                          );
      rDummyArea.nX:=rArea.nX+i_nXOffset;
      rDummyArea.nY:=rArea.nY;
      rBand:=i_rRowband;
      rBand.nHeight:=nRowHeight;
      IF NOT bNoRowHeaders THEN
        -- set cell-measures to row-values
        vcIndex:=i_vcRowKey  || '#';
        IF lCells.EXISTS(vcIndex) THEN
          rDataCell:=lCells(vcIndex);
        ELSE
          rDataCell:=rEmptyCell;
        END IF;
        FOR i IN 1..i_rCrosstab.lMeasures.COUNT LOOP
          -- set variable with value
          IF rDataCell.EXISTS(i_rCrosstab.lMeasures(i).vcName) THEN
            PR_SET_VARIABLE_FROM_DATA(i_nStackPos=>i_nStackPos,
                                      i_vcName   =>i_rCrosstab.lMeasures(i).vcName,
                                      i_rData    =>rDataCell(i_rCrosstab.lMeasures(i).vcName),
                                      i_rMeasure =>i_rCrosstab.lMeasures(i)
                                     );
          ELSE
            -- set variable to null
            PR_UNSET_VARIABLE(i_nStackPos=>i_nStackPos,
                              i_vcName   =>i_rCrosstab.lMeasures(i).vcname
                             );
          END IF;
        END LOOP;
        -- Render the row-header
        rDummyArea:=FK_RENDER_BAND(i_nStackPos       =>i_nStackPos,
                                   i_rBand           =>rBand,
                                   i_rArea           =>rDummyArea,
                                   i_bAllowSubReports=>FALSE,
                                   i_nRenderFrame    =>PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER);
        rDummyArea.nX:=rArea.nX+nRowOffset;
      ELSE
        rDummyArea.nX:=rArea.nX;
      END IF;
      PR_REKU_RENDER_CELLS(1, 1, NULL);
      rArea.nY:=rArea.nY+nRowHeight;
      rReturnArea.nX:=i_nXOffset+i_rRowBand.nWidth;
      RETURN rReturnArea;
    END;
    FUNCTION FK_REKU_RENDER_ROWS(i_nColMatrixIdx IN NUMBER,
                                 i_nRow          IN NUMBER,
                                 i_nGroupListIdx IN NUMBER,
                                 i_vcRowKey      IN PK_JRXML2PDF_TYPES.tIndex,
                                 i_nMinHeight    IN NUMBER,
                                 i_nXOffset      IN NUMBER)
    RETURN PK_JRXML2PDF_TYPES.tArea IS
      vcIndex       PK_JRXML2PDF_TYPES.tName;
      nMinHeight    NUMBER;
      nDummy        NUMBER;
      rDummyArea    PK_JRXML2PDF_TYPES.tArea:=rArea;
      rBand         PK_JRXML2PDF_TYPES.tBand;
      rReturnArea   PK_JRXML2PDF_TYPES.tArea;
      nNewheight    NUMBER;
      nStartY       NUMBER;
      iHeader       PLS_INTEGER;
      nYForTotal    NUMBER;
      nYSave        NUMBER;
    BEGIN
      rReturnArea.nX:=0;
      rReturnArea.nY:=rArea.nY;
      IF i_rCrosstab.lRows(i_nRow).vcTotalPosition='Start' THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Keep space for row total at start:' || TO_CHAR(i_nRow)  || '/' || i_vcRowKey);
        END IF;
        -- save psotion for row-header
        nYForTotal:=rReturnArea.nY;
        -- calculate the row-height
        rArea.nY:=rArea.nY+FK_CALC_ROW_HEIGHT(i_nRow         =>i_nRow,
                                              i_nColMatrixIdx=>i_nColMatrixIdx,
                                              i_nMinHeight   =>i_nMinHeight,
                                              i_vcColBandName=>NULL,
                                              i_rRowBand     =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nTotalHeaderPos)
                                             );
      END IF;
      IF i_rCrosstab.lRows(i_nRow).vcOrderby=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
        vcIndex:=lRowGroups(i_nGroupListIdx).FIRST;
      ELSE
        vcIndex:=lRowGroups(i_nGroupListIdx).LAST;
      END IF;
      WHILE vcIndex IS NOT NULL LOOP
        lRowKeys(i_nRow):=TO_CHAR(lRowGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_';
        PR_SUMMARY_VARIABLES(i_nCurrentRow =>i_nRow,
                             i_nCurrentCol =>1);
        -- put the value of the row-value into the variable-cache
        PR_SET_VARIABLE_FROM_CROSSTAB(i_vcName    =>i_rCrosstab.lRows(i_nRow).vcName,
                                      i_vcDatatype=>i_rCrosstab.lRows(i_nRow).vcDatatype,
                                      i_rEntry    =>lRowGroups(i_nGroupListIdx)(vcIndex)
                                     );
        IF i_nRow<i_rCrosstab.lRows.COUNT THEN
          -- Calc height for row-part
          PR_CALC_BAND_HEIGHT(i_nStackPos   =>i_nStackPos,
                              i_rBand       =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nHeaderPos),
                              o_nbandHeight =>nMinHeight,
                              o_nBandOffset =>nDummy
                             );
          IF NOT bNoRowHeaders THEN
            iHeader:=lRowHeaders.COUNT+1;
            lRowHeaders(iHeader).nStartY:=rArea.nY;
            lRowHeaders(iHeader).nStartX:=rArea.nX+i_nXOffset;
            lRowHeaders(iHeader).rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nHeaderPos);
            nStartY:=rArea.nY;
            rReturnArea.nX:=i_rCrosstab.lRows(i_nRow).nWidth;
          END IF;
          rDummyArea:=FK_REKU_RENDER_ROWS(i_nColMatrixIdx=>i_nColMatrixIdx,
                                          i_nRow         =>i_nRow+1,
                                          i_nGroupListIdx=>lRowGroups(i_nGroupListIdx)(vcIndex).iDetailList,
                                          i_vcRowKey     =>TO_CHAR(lRowGroups(i_nGroupListIdx)(vcIndex).iDetailList)  || '_',
                                          i_nMinHeight   =>0,
                                          i_nXOffset     =>i_nXOffset+rReturnArea.nX
                                         );
          rReturnArea.nY:=NVL(rDummyArea.nY, rReturnArea.nY);
          PR_SUMMARY_VARIABLES(i_nCurrentRow =>i_nRow,
                               i_nCurrentCol =>1);
          rReturnArea.nX:=rDummyArea.nX;
          IF NOT bNoRowHeaders THEN
            PR_RENDER_ROWHEADER(i_nHeaderPos=>lRowHeaders.COUNT,
                                i_bRenderAll=>FALSE
                               );
          END IF;
          rReturnArea.nY:=rArea.nY;
          lRowHeaders.DELETE(lRowHeaders.COUNT);
        ELSE
          -- last level, add column to layout
          rDummyArea:=FK_RENDER_ROW(i_nRow         =>i_nRow,
                                    i_nColMatrixIdx=>i_nColMatrixIdx,
                                    i_vcRowIndex   =>vcIndex,
                                    i_vcRowkey     =>TO_CHAR(lRowGroups(i_nGroupListIdx)(vcIndex).iDetailList) || '_',
                                    i_nMinHeight   =>i_nMinHeight,
                                    i_nXOffset     =>i_nXOffset,
                                    i_rRowband     =>lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nHeaderPos),
                                    i_vcColBandName=>NULL);
          rReturnArea.nX:=GREATEST(rReturnArea.nX, rDummyArea.nX);
        END IF;
        IF i_rCrosstab.lRows(i_nRow).vcOrderby=PK_JRXML2PDF_TYPES.ORDERBY_ASCENDING THEN
          vcIndex:=lRowGroups(i_nGroupListIdx).NEXT(vcIndex);
        ELSE
          vcIndex:=lRowGroups(i_nGroupListIdx).PRIOR(vcIndex);
        END IF;
      END LOOP;
      lRowKeys.DELETE(i_nRow);
      IF i_rCrosstab.lRows(i_nRow).vcTotalPosition='Start' THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render row total at start:' || TO_CHAR(i_nRow)  || '/' || i_vcRowKey);
        END IF;
        -- Render the col-header for this column
        rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nTotalHeaderPos);
        rBand.nWidth:=rReturnArea.nX-i_nXOffset;
        -- set the Y-position to the formerly saved value
        nYSave:=rArea.nY;
        rArea.nY:=nYForTotal;
        -- last level, add column to layout
        rDummyArea:=FK_RENDER_ROW(i_nRow         =>i_nRow,
                                  i_nColMatrixIdx=>i_nColMatrixIdx,
                                  i_vcRowIndex   =>vcIndex,
                                  i_vcRowkey     =>i_vcRowKey,
                                  i_nMinHeight   =>i_nMinHeight,
                                  i_nXOffset     =>i_nXOffset,
                                  i_rRowband     =>rBand,
                                  i_vcColBandName=>i_rCrosstab.lRows(i_nRow).vcName
                                 );
       rArea.nY:=nYSave;
      ELSIF i_rCrosstab.lRows(i_nRow).vcTotalPosition='End' THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render row total at end:' || TO_CHAR(i_nRow)  || '/' || i_vcRowKey);
        END IF;
        -- Render the col-header for this column
        rBand:=lReportStack(i_nStackPos).lBands(i_rCrosstab.lRows(i_nRow).nTotalHeaderPos);
        rBand.nWidth:=rReturnArea.nX-i_nXOffset;
        -- last level, add column to layout
        rDummyArea:=FK_RENDER_ROW(i_nRow         =>i_nRow,
                                  i_nColMatrixIdx=>i_nColMatrixIdx,
                                  i_vcRowIndex   =>vcIndex,
                                  i_vcRowkey     =>i_vcRowKey,
                                  i_nMinHeight   =>i_nMinHeight,
                                  i_nXOffset     =>i_nXOffset,
                                  i_rRowband     =>rBand,
                                  i_vcColBandName=>i_rCrosstab.lRows(i_nRow).vcName
                                 );
      END IF;
      RETURN rReturnArea;
    END;
    PROCEDURE PR_DEBUG_DATA IS
      vcIndex PK_JRXML2PDF_TYPES.tName;
    BEGIN
      vcIndex:=lCells.FIRST;
      WHILE vcIndex IS NOT NULL LOOP
        -- put the value of the row-value into the variable-cache
        FOR i IN 1..i_rCrossTab.lMeasures.COUNT LOOP
           NULL;--  DBMS_OUTPUT.PUT_LINE(lCells(vcIndex)(i_rCrossTab.lMeasures(i).vcName).iCount);
        END LOOP;
        vcIndex:=lCells.NEXT(vcIndex);
      END LOOP;
    END;
  BEGIN
    -- Get the data for the crosstab,
    -- and calculate aggregates
    PR_LOAD_DATA;
    --PR_DEBUG_DATA;
    -- Calculate area for pagefooter
    nColumnFooterHeight:=0;
    nPageFooterheight:=0;
    FOR i IN 1..lReportStack.COUNT LOOP
      nColumnFooterHeight:=nColumnFooterHeight+lReportStack(i).nColumnFtrHeight;
      nPageFooterheight  :=nPageFooterheight  +lReportStack(i).nPageFtrHeight;
    END LOOP;
    -- set up the matrix width by calculating how many column fit in each row
    nRowOffset:=0;
    nColPosition:=999999;
    nColGroupIdx:=0;
    -- calculate the space for the row-Headers in front
    FOR i IN 1..i_rCrosstab.lRows.COUNT LOOP
      nRowOffset:=nRowOffset+lReportstack(i_nStackPos).lBands(i_rCrosstab.lRows(i).nHeaderPos).nWidth;
    END LOOP;
    -- now add all last-level columns from the data
    PR_REKU_ADD_COLUMN(1, 1, NULL);
    -- now we have one or more list of columns each of which forms one column-header, so
    --
    -- row1 row2 ColVal1 ColVal2 ColVal3 ColVal4 ColTotal
    --
    -- maybe split into
    --
    -- row1 row2 ColVal1 ColVal2 ColVal3
    -- row1 row2 ColVal4 ColTotal
    -- and each of the column-header will be rendered for all rows in the rowgroups
    FOR iColMatrixIdx IN 1..lColumnMatrix.COUNT LOOP
      -- calculate the heights of all column-headers
      lColHeaderHeights.DELETE;
      FOR i IN 1..i_rCrosstab.lColumns.COUNT LOOP
        lColHeaderHeights(i):=0;
      END LOOP;
      PR_REKU_COLUMN_HEIGHTS(i_nColMatrixIdx=>iColMatrixIdx,
                             i_nCol         =>1,
                             i_nGroupListIdx=>1,
                             i_vcColKey     =>NULL
                            );
      -- maybe do not print the row-headers anymore
      IF     iColMatrixIdx>1
         AND i_rCrosstab.vcRepeatRowHeaders=PK_JRXML2PDF_TYPES.NO THEN
        nRowOffset:=0;
        bNoRowHeaders:=TRUE;
      END IF;
      -- Set flag, that the column-headers have to be rendered
      -- this is checked inside RENDER_ROW to make sure that
      -- the colheader is only rendered if at least one row of data fits beneath the header
      bNeedsColumnHeader:=TRUE;
      -- Render rows
      rDummyArea:=FK_REKU_RENDER_ROWS(iColMatrixIdx, 1, 1, NULL, 0, rArea.nX);
      -- Add column-break-offset
      rArea.nY:=rArea.nY+i_rCrosstab.nColBreakOffset;
    END LOOP;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_BARCHART(i_nX        IN NUMBER,
                               i_nY        IN NUMBER,
                               i_nWidth    IN NUMBER,
                               i_nHeight   IN NUMBER,
                               i_rBarChart IN PK_JRXML2PDF_TYPES.tBarChart,
                               i_rStyle    IN PK_JRXML2PDF_TYPES.tSimpleStyle
                              ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lDatasets       PK_JRXML2PDF_CHARTS.tDatasetList;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rBarChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rBarChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    IF i_rBarChart.vcIsStacked=PK_JRXML2PDF_TYPES.NO THEN
      rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_BAR_CHART(i_nWidth=> i_nWidth
                                                                         -NVL(i_rBarChart.nLeftPadding,0)
                                                                         -NVL(i_rBarChart.nRightPadding,0),
                                                               i_nHeight=> i_nHeight
                                                                          -NVL(i_rBarChart.nTopPadding,0)
                                                                          -NVL(i_rBarChart.nBottomPadding,0)
                                                              );
    ELSE
      rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_STACKED_BAR_CHART(i_nWidth=> i_nWidth
                                                                        -NVL(i_rBarChart.nLeftPadding,0)
                                                                        -NVL(i_rBarChart.nRightPadding,0),
                                                              i_nHeight=> i_nHeight
                                                                         -NVL(i_rBarChart.nTopPadding,0)
                                                                         -NVL(i_rBarChart.nBottomPadding,0)
                                                             );
    END IF;
    -- transfer properties
    rChart.vcIs3D:=i_rBarchart.vcIs3D;
    rChart.vcTitlePosition:=i_rBarChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rBarChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rBarChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rBarChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rBarChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rBarChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rBarChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rBarChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rBarChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rBarChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rBarChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rBarchart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rBarchart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rBarchart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rBarchart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rBarchart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rBarchart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rBarchart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    IF i_rBarchart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rBarChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rBarChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rBarChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).vcLabelPattern          :=FK_NUM_PATTERN(NVL(i_rBarchart.vcValueAxisTickLabelPattern, '##########0'));
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rBarChart.nLabelFontSize, 10);
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    -- Value-Axis-Settings
    rChart.lValueAxis(1).vcShowTickLabels         :=NVL(i_rBarchart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcShowTickMarks          :=NVL(i_rBarchart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rBarchart.vcValueAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lValueAxis(1).vcLabelColor             :=REPLACE(NVL(i_rBarchart.vcValueAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcLabelFont              :=NVL(i_rBarchart.vcValueAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcLabelFontStyle         :=NVL(i_rBarchart.vcValueAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nLabelFontSize           :=NVL(i_rBarchart.nValueAxisLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rBarchart.vcValueAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcTickLabelFont          :=NVL(i_rBarchart.vcValueAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcTickLabelFontStyle     :=NVL(i_rBarchart.vcValueAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nTickLabelFontSize       :=NVL(i_rBarchart.nAxisTickLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rBarchart.vcValueAxisTickLabelPattern);
    rChart.lValueAxis(1).vcLineColor              :=REPLACE(NVL(i_rBarchart.vcValueAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rBarchart.vcValueAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rBarchart.vcValueAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- Range-Axis-Settings
    rChart.lRangeAxis(1).vcShowTickLabels         :=NVL(i_rBarchart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcShowTickMarks          :=PK_JRXML2PDF_TYPES.BOOL_NO;
    rChart.lRangeAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rBarchart.vcCatAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lRangeAxis(1).vcLabelColor             :=REPLACE(NVL(i_rBarchart.vcCatAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcLabelFont              :=NVL(i_rBarchart.vcCatAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcLabelFontStyle         :=NVL(i_rBarchart.vcCatAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nLabelFontSize           :=NVL(i_rBarchart.nCatAxisLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rBarchart.vcCatAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcTickLabelFont          :=NVL(i_rBarchart.vcCatAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcTickLabelFontStyle     :=NVL(i_rBarchart.vcCatAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nTickLabelFontSize       :=NVL(i_rBarchart.nCatAxisTickLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rBarchart.vcCatAxisTickLabelPattern);
    rChart.lRangeAxis(1).vcLineColor              :=REPLACE(NVL(i_rBarchart.vcCatAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).nTickLabelRotation       :=i_rBarChart.nLabelRotation;
    -- create datasets
    FOR i IN 1..i_rBarChart.lSeries.COUNT LOOP
      lDatasets(i):=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_DATASET;
      lDatasets(i).vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
      lDatasets(i).nSeries:=i;
    END LOOP;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      FOR i IN 1..i_rBarChart.lSeries.COUNT LOOP
        rValueDataEntry.nValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                       i_vcExpression =>i_rBarChart.lSeries(i).vcValueExpression,
                                                       i_vcPattern    =>NULL
                                                      );
        rRangeDataEntry.vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                        i_vcExpression =>i_rBarChart.lSeries(i).vcCategoryExpression,
                                                        i_vcPattern    =>NULL
                                                      );
        lDatasets(i).lValueDataEntries(lDatasets(i).lValueDataEntries.COUNT+1):=rValueDataEntry;
        lDatasets(i).lRangeDataEntries(lDatasets(i).lRangeDataEntries.COUNT+1):=rRangeDataEntry;
      END LOOP;
    END LOOP;
    FOR i IN 1..i_rBarChart.lSeries.COUNT LOOP
      vcSeries:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                       i_vcExpression =>i_rBarChart.lSeries(i).vcSeriesExpression,
                                       i_vcPattern    =>NULL
                                      );
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(vcSeries);
      IF i_rBarchart.lSeriesColors.EXISTS(i) THEN
        rSeries.vcColor:=REPLACE(i_rBarchart.lSeriesColors(i), '#', '');
        rSeries.vcBorderColor:=rSeries.vcColor;
      END IF;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
      PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, lDatasets(i), vcSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rBarChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rBarChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rBarChart.vcFillColor,
                  i_vcFgColor       =>i_rBarChart.vcLineColor,
                  i_nBoxTop         =>i_rBarChart.nBoxTop,
                  i_nBoxLeft        =>i_rBarChart.nBoxLeft,
                  i_nBoxBottom      =>i_rBarChart.nBoxBottom,
                  i_nBoxRight       =>i_rBarChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rBarChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rBarChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rBarChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rBarChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rBarChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    -- set locale
    rChart.rLocaleData:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rBarChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rBarChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_STACKEDAREACHART(i_nX                IN NUMBER,
                                       i_nY                IN NUMBER,
                                       i_nWidth            IN NUMBER,
                                       i_nHeight           IN NUMBER,
                                       i_rStackedAreaChart IN PK_JRXML2PDF_TYPES.tStackedAreaChart,
                                       i_rStyle            IN PK_JRXML2PDF_TYPES.tSimpleStyle
                                      ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lDatasets       PK_JRXML2PDF_CHARTS.tDatasetList;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rStackedAreaChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rStackedAreaChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_STACKED_AREA_CHART(i_nWidth=> i_nWidth
                                                                      -NVL(i_rStackedAreaChart.nLeftPadding,0)
                                                                      -NVL(i_rStackedAreaChart.nRightPadding,0),
                                                             i_nHeight=> i_nHeight
                                                                       -NVL(i_rStackedAreaChart.nTopPadding,0)
                                                                       -NVL(i_rStackedAreaChart.nBottomPadding,0)
                                                           );
    -- transfer properties
    rChart.vcTitlePosition:=i_rStackedAreaChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rStackedAreaChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rStackedAreaChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rStackedAreaChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rStackedAreaChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rStackedAreaChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rStackedAreaChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rStackedAreaChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rStackedAreaChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rStackedAreaChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rStackedAreaChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rStackedAreaChart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rStackedAreaChart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rStackedAreaChart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rStackedAreaChart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rStackedAreaChart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rStackedAreaChart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rStackedAreaChart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    IF i_rStackedAreaChart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rStackedAreaChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rStackedAreaChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rStackedAreaChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).vcLabelPattern          :=FK_NUM_PATTERN(NVL(i_rStackedAreaChart.vcValueAxisTickLabelPattern, '##########0'));
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rStackedAreaChart.nLabelFontSize, 10);
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    -- Value-Axis-Settings
    rChart.lValueAxis(1).vcShowTickLabels         :=NVL(i_rStackedAreaChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcShowTickMarks          :=NVL(i_rStackedAreaChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rStackedAreaChart.vcValueAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lValueAxis(1).vcLabelColor             :=REPLACE(NVL(i_rStackedAreaChart.vcValueAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcLabelFont              :=NVL(i_rStackedAreaChart.vcValueAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcLabelFontStyle         :=NVL(i_rStackedAreaChart.vcValueAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nLabelFontSize           :=NVL(i_rStackedAreaChart.nValueAxisLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rStackedAreaChart.vcValueAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcTickLabelFont          :=NVL(i_rStackedAreaChart.vcValueAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcTickLabelFontStyle     :=NVL(i_rStackedAreaChart.vcValueAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nTickLabelFontSize       :=NVL(i_rStackedAreaChart.nAxisTickLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rStackedAreaChart.vcValueAxisTickLabelPattern);
    rChart.lValueAxis(1).vcLineColor              :=REPLACE(NVL(i_rStackedAreaChart.vcValueAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rStackedAreaChart.vcValueAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rStackedAreaChart.vcValueAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- Range-Axis-Settings
    rChart.lRangeAxis(1).vcShowTickLabels         :=NVL(i_rStackedAreaChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcShowTickMarks          :=PK_JRXML2PDF_TYPES.BOOL_NO;
    rChart.lRangeAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rStackedAreaChart.vcCatAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lRangeAxis(1).vcLabelColor             :=REPLACE(NVL(i_rStackedAreaChart.vcCatAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcLabelFont              :=NVL(i_rStackedAreaChart.vcCatAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcLabelFontStyle         :=NVL(i_rStackedAreaChart.vcCatAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nLabelFontSize           :=NVL(i_rStackedAreaChart.nCatAxisLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rStackedAreaChart.vcCatAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcTickLabelFont          :=NVL(i_rStackedAreaChart.vcCatAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcTickLabelFontStyle     :=NVL(i_rStackedAreaChart.vcCatAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nTickLabelFontSize       :=NVL(i_rStackedAreaChart.nCatAxisTickLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rStackedAreaChart.vcCatAxisTickLabelPattern);
    rChart.lRangeAxis(1).vcLineColor              :=REPLACE(NVL(i_rStackedAreaChart.vcCatAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).nTickLabelRotation       :=i_rStackedAreaChart.nLabelRotation;
    -- create datasets
    FOR i IN 1..i_rStackedAreaChart.lSeries.COUNT LOOP
      lDatasets(i):=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_DATASET;
      lDatasets(i).vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
      lDatasets(i).nSeries:=i;
    END LOOP;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      FOR i IN 1..i_rStackedAreaChart.lSeries.COUNT LOOP
        rValueDataEntry.nValue:=NVL(FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                           i_vcExpression =>i_rStackedAreaChart.lSeries(i).vcValueExpression,
                                                           i_vcPattern    =>NULL
                                                          ), 0);
        rRangeDataEntry.vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                        i_vcExpression =>i_rStackedAreaChart.lSeries(i).vcCategoryExpression,
                                                        i_vcPattern    =>NULL
                                                      );
        lDatasets(i).lValueDataEntries(lDatasets(i).lValueDataEntries.COUNT+1):=rValueDataEntry;
        lDatasets(i).lRangeDataEntries(lDatasets(i).lRangeDataEntries.COUNT+1):=rRangeDataEntry;
      END LOOP;
    END LOOP;
    FOR i IN 1..i_rStackedAreaChart.lSeries.COUNT LOOP
      vcSeries:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                       i_vcExpression =>i_rStackedAreaChart.lSeries(i).vcSeriesExpression,
                                       i_vcPattern    =>NULL
                                      );
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(vcSeries);
      IF i_rStackedAreaChart.lSeriesColors.EXISTS(i) THEN
        rSeries.vcColor:=REPLACE(i_rStackedAreaChart.lSeriesColors(i), '#', '');
        rSeries.vcBorderColor:=rSeries.vcColor;
      END IF;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
      PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, lDatasets(i), vcSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rStackedAreaChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rStackedAreaChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rStackedAreaChart.vcFillColor,
                  i_vcFgColor       =>i_rStackedAreaChart.vcLineColor,
                  i_nBoxTop         =>i_rStackedAreaChart.nBoxTop,
                  i_nBoxLeft        =>i_rStackedAreaChart.nBoxLeft,
                  i_nBoxBottom      =>i_rStackedAreaChart.nBoxBottom,
                  i_nBoxRight       =>i_rStackedAreaChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rStackedAreaChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rStackedAreaChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rStackedAreaChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rStackedAreaChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rStackedAreaChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    -- set locale
    rChart.rLocaleData:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rStackedAreaChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rStackedAreaChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_PIECHART(i_nX        IN NUMBER,
                               i_nY        IN NUMBER,
                               i_nWidth    IN NUMBER,
                               i_nHeight   IN NUMBER,
                               i_rPieChart IN PK_JRXML2PDF_TYPES.tPieChart,
                               i_rStyle    IN PK_JRXML2PDF_TYPES.tSimpleStyle
                              ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    rDataset        PK_JRXML2PDF_CHARTS.tDataset;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rPieChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rPieChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_PIE_CHART(i_nWidth=> i_nWidth
                                                              -NVL(i_rPieChart.nLeftPadding,0)
                                                              -NVL(i_rPieChart.nRightPadding,0),
                                                    i_nHeight=> i_nHeight
                                                               -NVL(i_rPieChart.nTopPadding,0)
                                                               -NVL(i_rPieChart.nBottomPadding,0)
                                                   );
    -- transfer properties
    rChart.vcIs3D:=i_rPiechart.vcIs3D;
    rChart.vcTitlePosition:=i_rPieChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rPieChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rPieChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rPieChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rPieChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rPieChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rPieChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rPieChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rPieChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rPieChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rPieChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rPieChart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rPieChart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rPieChart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rPieChart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rPieChart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rPieChart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rPieChart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    rChart.lPlots(1).vcKeyFormat:=NVL(i_rPieChart.vcLegendLabelFormat, '{0}');
    IF i_rPieChart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rPieChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rPieChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rPieChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rPieChart.nLabelFontSize, 10);
      rChart.lPlots(1).vcLabelFormat           :=NVL(i_rPieChart.vcLabelFormat, '{0}');
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    rDataset:=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_DATASET;
    rDataset.vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      rValueDataEntry.nValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rPieChart.vcValueExpression,
                                                     i_vcPattern    =>NULL
                                                    );
      rRangeDataEntry.vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                      i_vcExpression =>i_rPieChart.vcKeyExpression,
                                                      i_vcPattern    =>NULL
                                                    );
      rDataset.lValueDataEntries(rDataset.lValueDataEntries.COUNT+1):=rValueDataEntry;
      rDataset.lRangeDataEntries(rDataset.lRangeDataEntries.COUNT+1):=rRangeDataEntry;
    END LOOP;
    PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, rDataset);
    FOR i IN 1..i_rPieChart.lSeriesColors.COUNT LOOP
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(TO_CHAR(i));
      rSeries.vcColor:=REPLACE(i_rPieChart.lSeriesColors(i), '#', '');
      rSeries.vcBorderColor:=rSeries.vcColor;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rPieChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rPieChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rPieChart.vcFillColor,
                  i_vcFgColor       =>i_rPieChart.vcLineColor,
                  i_nBoxTop         =>i_rPieChart.nBoxTop,
                  i_nBoxLeft        =>i_rPieChart.nBoxLeft,
                  i_nBoxBottom      =>i_rPieChart.nBoxBottom,
                  i_nBoxRight       =>i_rPieChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rPieChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rPieChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rPieChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rPieChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rPieChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    rChart.rLocaleData:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rPieChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rPieChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_CAT_LINECHART(i_nX                 IN NUMBER,
                                    i_nY                 IN NUMBER,
                                    i_nWidth             IN NUMBER,
                                    i_nHeight            IN NUMBER,
                                    i_rCategoryLineChart IN PK_JRXML2PDF_TYPES.tLineChart,
                                    i_rStyle             IN PK_JRXML2PDF_TYPES.tSimpleStyle
                                   ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lDatasets       PK_JRXML2PDF_CHARTS.tDatasetList;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rCategoryLineChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rCategoryLineChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_LINE_CHART(i_nWidth=> i_nWidth
                                                                        -NVL(i_rCategoryLineChart.nLeftPadding,0)
                                                                        -NVL(i_rCategoryLineChart.nRightPadding,0),
                                                              i_nHeight=> i_nHeight
                                                                         -NVL(i_rCategoryLineChart.nTopPadding,0)
                                                                         -NVL(i_rCategoryLineChart.nBottomPadding,0)
                                                             );
    -- transfer properties
    rChart.vcIs3D:=i_rCategoryLineChart.vcIs3D;
    rChart.vcTitlePosition:=i_rCategoryLineChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rCategoryLineChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rCategoryLineChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rCategoryLineChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rCategoryLineChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rCategoryLineChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rCategoryLineChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rCategoryLineChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rCategoryLineChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rCategoryLineChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rCategoryLineChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rCategoryLineChart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rCategoryLineChart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rCategoryLineChart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rCategoryLineChart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rCategoryLineChart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rCategoryLineChart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rCategoryLineChart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    IF i_rCategoryLineChart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rCategoryLineChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rCategoryLineChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rCategoryLineChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).vcLabelPattern          :=FK_NUM_PATTERN(NVL(i_rCategoryLineChart.vcValueAxisTickLabelPattern, '##########0'));
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rCategoryLineChart.nLabelFontSize, 10);
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    rChart.lPlots(1).vcShowLines                  :=i_rCategoryLineChart.vcShowLines;
    rChart.lPlots(1).vcShowShapes                 :=i_rCategoryLineChart.vcShowShapes;
    -- Value-Axis-Settings
    rChart.lValueAxis(1).vcShowTickLabels         :=NVL(i_rCategoryLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcShowTickMarks          :=NVL(i_rCategoryLineChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rCategoryLineChart.vcValueAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lValueAxis(1).vcLabelColor             :=REPLACE(NVL(i_rCategoryLineChart.vcValueAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcLabelFont              :=NVL(i_rCategoryLineChart.vcValueAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcLabelFontStyle         :=NVL(i_rCategoryLineChart.vcValueAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nLabelFontSize           :=NVL(i_rCategoryLineChart.nValueAxisLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rCategoryLineChart.vcValueAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcTickLabelFont          :=NVL(i_rCategoryLineChart.vcValueAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcTickLabelFontStyle     :=NVL(i_rCategoryLineChart.vcValueAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nTickLabelFontSize       :=NVL(i_rCategoryLineChart.nAxisTickLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rCategoryLineChart.vcValueAxisTickLabelPattern);
    rChart.lValueAxis(1).vcLineColor              :=REPLACE(NVL(i_rCategoryLineChart.vcValueAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rCategoryLineChart.vcValueAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rCategoryLineChart.vcValueAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- Range-Axis-Settings
    rChart.lRangeAxis(1).vcShowTickLabels         :=NVL(i_rCategoryLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcShowTickMarks          :=PK_JRXML2PDF_TYPES.BOOL_NO;
    rChart.lRangeAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rCategoryLineChart.vcCatAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lRangeAxis(1).vcLabelColor             :=REPLACE(NVL(i_rCategoryLineChart.vcCatAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcLabelFont              :=NVL(i_rCategoryLineChart.vcCatAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcLabelFontStyle         :=NVL(i_rCategoryLineChart.vcCatAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nLabelFontSize           :=NVL(i_rCategoryLineChart.nCatAxisLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rCategoryLineChart.vcCatAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcTickLabelFont          :=NVL(i_rCategoryLineChart.vcCatAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcTickLabelFontStyle     :=NVL(i_rCategoryLineChart.vcCatAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nTickLabelFontSize       :=NVL(i_rCategoryLineChart.nCatAxisTickLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rCategoryLineChart.vcCatAxisTickLabelPattern);
    rChart.lRangeAxis(1).vcLineColor              :=REPLACE(NVL(i_rCategoryLineChart.vcCatAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).nTickLabelRotation       :=i_rCategoryLineChart.nLabelRotation;
    -- create datasets
    FOR i IN 1..i_rCategoryLineChart.lSeries.COUNT LOOP
      lDatasets(i):=PK_JRXML2PDF_CHARTS.FK_CREATE_CATEGORY_DATASET;
      lDatasets(i).vcRangeType:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
      lDatasets(i).nSeries:=i;
    END LOOP;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      FOR i IN 1..i_rCategoryLineChart.lSeries.COUNT LOOP
        rValueDataEntry.nValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                       i_vcExpression =>i_rCategoryLineChart.lSeries(i).vcValueExpression,
                                                       i_vcPattern    =>NULL
                                                      );
        rRangeDataEntry.vcValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                        i_vcExpression =>i_rCategoryLineChart.lSeries(i).vcCategoryExpression,
                                                        i_vcPattern    =>NULL
                                                      );
        lDatasets(i).lValueDataEntries(lDatasets(i).lValueDataEntries.COUNT+1):=rValueDataEntry;
        lDatasets(i).lRangeDataEntries(lDatasets(i).lRangeDataEntries.COUNT+1):=rRangeDataEntry;
      END LOOP;
    END LOOP;
    FOR i IN 1..i_rCategoryLineChart.lSeries.COUNT LOOP
      vcSeries:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                       i_vcExpression =>i_rCategoryLineChart.lSeries(i).vcSeriesExpression,
                                       i_vcPattern    =>NULL
                                      );
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(vcSeries);
      IF i_rCategoryLineChart.lSeriesColors.EXISTS(i) THEN
        rSeries.vcColor:=REPLACE(i_rCategoryLineChart.lSeriesColors(i), '#', '');
        rSeries.vcBorderColor:=rSeries.vcColor;
      END IF;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
      PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, lDatasets(i), vcSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rCategoryLineChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rCategoryLineChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rCategoryLineChart.vcFillColor,
                  i_vcFgColor       =>i_rCategoryLineChart.vcLineColor,
                  i_nBoxTop         =>i_rCategoryLineChart.nBoxTop,
                  i_nBoxLeft        =>i_rCategoryLineChart.nBoxLeft,
                  i_nBoxBottom      =>i_rCategoryLineChart.nBoxBottom,
                  i_nBoxRight       =>i_rCategoryLineChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rCategoryLineChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rCategoryLineChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rCategoryLineChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rCategoryLineChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rCategoryLineChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    rChart.rLocaledata:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rCategoryLineChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rCategoryLineChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_XY_LINECHART(i_nX           IN NUMBER,
                                   i_nY           IN NUMBER,
                                   i_nWidth       IN NUMBER,
                                   i_nHeight      IN NUMBER,
                                   i_rXYLineChart IN PK_JRXML2PDF_TYPES.tLineChart,
                                   i_rStyle       IN PK_JRXML2PDF_TYPES.tSimpleStyle
                                   ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lDatasets       PK_JRXML2PDF_CHARTS.tDatasetList;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rXYLineChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rXYLineChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_XY_LINE_CHART(i_nWidth=> i_nWidth
                                                                  -NVL(i_rXyLineChart.nLeftPadding,0)
                                                                  -NVL(i_rXyLineChart.nRightPadding,0),
                                                        i_nHeight=> i_nHeight
                                                                   -NVL(i_rXyLineChart.nTopPadding,0)
                                                                   -NVL(i_rXyLineChart.nBottomPadding,0)
                                                       );
    -- transfer properties
    rChart.vcIs3D:=i_rXyLineChart.vcIs3D;
    rChart.vcTitlePosition:=i_rXyLineChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rXyLineChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rXyLineChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rXyLineChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rXyLineChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rXyLineChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rXyLineChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rXyLineChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rXyLineChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rXyLineChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rXyLineChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rXyLineChart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rXyLineChart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rXyLineChart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rXyLineChart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rXyLineChart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rXyLineChart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rXyLineChart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    IF i_rXyLineChart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rXyLineChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rXyLineChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rXyLineChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).vcLabelPattern          :=FK_NUM_PATTERN(NVL(i_rXyLineChart.vcValueAxisTickLabelPattern, '##########0'));
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rXyLineChart.nLabelFontSize, 10);
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    rChart.lPlots(1).vcShowLines                  :=i_rXyLineChart.vcShowLines;
    rChart.lPlots(1).vcShowShapes                 :=i_rXyLineChart.vcShowShapes;
    -- Value-Axis-Settings
    rChart.lValueAxis(1).vcShowTickLabels         :=NVL(i_rXyLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcShowTickMarks          :=NVL(i_rXyLineChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rXyLineChart.vcValueAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lValueAxis(1).vcLabelColor             :=REPLACE(NVL(i_rXyLineChart.vcValueAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcLabelFont              :=NVL(i_rXyLineChart.vcValueAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcLabelFontStyle         :=NVL(i_rXyLineChart.vcValueAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nLabelFontSize           :=NVL(i_rXyLineChart.nValueAxisLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rXyLineChart.vcValueAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcTickLabelFont          :=NVL(i_rXyLineChart.vcValueAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcTickLabelFontStyle     :=NVL(i_rXyLineChart.vcValueAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nTickLabelFontSize       :=NVL(i_rXyLineChart.nAxisTickLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rXyLineChart.vcValueAxisTickLabelPattern);
    rChart.lValueAxis(1).vcLineColor              :=REPLACE(NVL(i_rXyLineChart.vcValueAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rXyLineChart.vcValueAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rXyLineChart.vcValueAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- Range-Axis-Settings
    rChart.lRangeAxis(1).vcShowTickLabels         :=NVL(i_rXyLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcShowTickMarks          :=NVL(i_rXyLineChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rXyLineChart.vcCatAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lRangeAxis(1).vcLabelColor             :=REPLACE(NVL(i_rXyLineChart.vcCatAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcLabelFont              :=NVL(i_rXyLineChart.vcCatAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcLabelFontStyle         :=NVL(i_rXyLineChart.vcCatAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nLabelFontSize           :=NVL(i_rXyLineChart.nCatAxisLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rXyLineChart.vcCatAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcTickLabelFont          :=NVL(i_rXyLineChart.vcCatAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcTickLabelFontStyle     :=NVL(i_rXyLineChart.vcCatAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nTickLabelFontSize       :=NVL(i_rXyLineChart.nCatAxisTickLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rXyLineChart.vcCatAxisTickLabelPattern);
    rChart.lRangeAxis(1).vcLineColor              :=REPLACE(NVL(i_rXyLineChart.vcCatAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).nTickLabelRotation       :=i_rXyLineChart.nLabelRotation;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rXyLineChart.vcCatAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lRangeAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lRangeAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rXyLineChart.vcCatAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lRangeAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lRangeAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- create datasets
    FOR i IN 1..i_rXyLineChart.lSeries.COUNT LOOP
      lDatasets(i):=PK_JRXML2PDF_CHARTS.FK_CREATE_XY_DATASET;
      lDatasets(i).nSeries:=i;
    END LOOP;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      FOR i IN 1..i_rXyLineChart.lSeries.COUNT LOOP
        rValueDataEntry.nValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                       i_vcExpression =>i_rXyLineChart.lSeries(i).vcValueExpression,
                                                       i_vcPattern    =>NULL
                                                      );
        rRangeDataEntry.nValue:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                       i_vcExpression =>i_rXyLineChart.lSeries(i).vcCategoryExpression,
                                                       i_vcPattern    =>NULL
                                                      );
        lDatasets(i).lValueDataEntries(lDatasets(i).lValueDataEntries.COUNT+1):=rValueDataEntry;
        lDatasets(i).lRangeDataEntries(lDatasets(i).lRangeDataEntries.COUNT+1):=rRangeDataEntry;
      END LOOP;
    END LOOP;
    FOR i IN 1..i_rXyLineChart.lSeries.COUNT LOOP
      vcSeries:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                       i_vcExpression =>i_rXyLineChart.lSeries(i).vcSeriesExpression,
                                       i_vcPattern    =>NULL
                                      );
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(vcSeries);
      IF i_rXyLineChart.lSeriesColors.EXISTS(i) THEN
        rSeries.vcColor:=REPLACE(i_rXyLineChart.lSeriesColors(i), '#', '');
        rSeries.vcBorderColor:=rSeries.vcColor;
      END IF;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
      PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, lDatasets(i), vcSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rXyLineChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rXyLineChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rXyLineChart.vcFillColor,
                  i_vcFgColor       =>i_rXyLineChart.vcLineColor,
                  i_nBoxTop         =>i_rXyLineChart.nBoxTop,
                  i_nBoxLeft        =>i_rXyLineChart.nBoxLeft,
                  i_nBoxBottom      =>i_rXyLineChart.nBoxBottom,
                  i_nBoxRight       =>i_rXyLineChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rXyLineChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rXyLineChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rXyLineChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rXyLineChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rXyLineChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    rChart.rLocaleData:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rXyLineChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rXyLineChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_TIME_LINECHART(i_nX             IN NUMBER,
                                     i_nY             IN NUMBER,
                                     i_nWidth         IN NUMBER,
                                     i_nHeight        IN NUMBER,
                                     i_rTimeLineChart IN PK_JRXML2PDF_TYPES.tLineChart,
                                     i_rStyle         IN PK_JRXML2PDF_TYPES.tSimpleStyle
                                    ) IS
    rChart          PK_JRXML2PDF_CHARTS.tChart;
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lDatasets       PK_JRXML2PDF_CHARTS.tDatasetList;
    vcSeries        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rValueDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rRangeDataEntry PK_JRXML2PDF_CHARTS.tDataEntry;
    rDataEntry      PK_JRXML2PDF_CHARTS.tDataEntry;
    rSeries         PK_JRXML2PDF_CHARTS.tSeries;
    rLocaleData     PK_JRXML2PDF_TYPES.tLocaleData:=lReportStack(lReportStack.COUNT).rLocaledata;
    lParams         PK_JRXML2PDF_TYPES.tParamList;
  BEGIN
    lParams:=FK_POPULATE_PARAMLIST(i_nStackPos  =>lReportStack.COUNT,
                                   i_lParamList =>i_rTimeLineChart.lParams);
    -- fake a report to execute the query
    rReport.vcQuery:=i_rTimeLineChart.vcQuery;
    -- Push to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    -- Transform a JRXMLchart into a PL-JRXML2PDF-chart
    rChart:=PK_JRXML2PDF_CHARTS.FK_CREATE_TIME_LINE_CHART(i_nWidth=> i_nWidth
                                                                    -NVL(i_rTimeLineChart.nLeftPadding,0)
                                                                    -NVL(i_rTimeLineChart.nRightPadding,0),
                                                          i_nHeight=> i_nHeight
                                                                     -NVL(i_rTimeLineChart.nTopPadding,0)
                                                                     -NVL(i_rTimeLineChart.nBottomPadding,0)
                                                         );
    -- transfer properties
    rChart.vcIs3D:=i_rTimeLineChart.vcIs3D;
    rChart.vcTitlePosition:=i_rTimeLineChart.vcTitlePosition;
    rChart.vcTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                           i_vcExpression =>i_rTimeLineChart.vcTitleExpression,
                                           i_vcPattern    =>NULL);
    rChart.vcTitleFont     :=NVL(i_rTimeLineChart.vcTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcTitleFontStyle:=NVL(i_rTimeLineChart.vcTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nTitleFontSize  :=NVL(i_rTimeLineChart.nTitleFontSize  , 16);
    rChart.vcTitleColor    :=REPLACE(NVL(i_rTimeLineChart.vcTitleColor    , PK_JRXML2PDF_TYPES.BLACK), '#','');
    rChart.vcSubTitle:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                              i_vcExpression =>i_rTimeLineChart.vcSubTitleExpression,
                                              i_vcPattern    =>NULL);
    rChart.vcSubTitleFont     :=NVL(i_rTimeLineChart.vcSubTitleFont,      PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.vcSubTitleFontStyle:=NVL(i_rTimeLineChart.vcSubTitleFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.nSubTitleFontSize  :=NVL(i_rTimeLineChart.nSubTitleFontSize,   10);
    rChart.vcSubTitleColor    :=REPLACE(NVL(i_rTimeLineChart.vcSubTitleColor,     PK_JRXML2PDF_TYPES.BLACK),'#','');
    IF NVL(i_rTimeLineChart.vcShowLegend, PK_JRXML2PDF_TYPES.BOOL_YES)=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.rLegend.vcPosition   :=i_rTimeLineChart.vcLegendPosition;
      rChart.rLegend.vcFont       :=NVL(i_rTimeLineChart.vcLegendFont,      PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.rLegend.vcFontStyle  :=NVL(i_rTimeLineChart.vcLegendFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.rLegend.nFontSize    :=NVL(i_rTimeLineChart.nLegendFontSize  , 10);
      rChart.rLegend.vcFontColor  :=REPLACE(NVL(i_rTimeLineChart.vcLegendTextColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.rLegend.vcBgColor    :=i_rTimeLineChart.vcLegendBgColor;
    ELSE
      rChart.rLegend.vcPosition   :=PK_JRXML2PDF_CHARTS.POSITION_NONE;
    END IF;
    IF i_rTimeLineChart.vcShowLabels=PK_JRXML2PDF_TYPES.BOOL_YES THEN
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_OUTSIDE;
      rChart.lPlots(1).vcLabelColor            :=REPLACE(NVL(i_rTimeLineChart.vcLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
      rChart.lPlots(1).vcLabelFont             :=NVL(i_rTimeLineChart.vcLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
      rChart.lPlots(1).vcLabelFontStyle        :=NVL(i_rTimeLineChart.vcLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
      rChart.lPlots(1).vcLabelPattern          :=FK_NUM_PATTERN(NVL(i_rTimeLineChart.vcValueAxisTickLabelPattern, '##########0'));
      rChart.lPlots(1).nLabelFontSize          :=NVL(i_rTimeLineChart.nLabelFontSize, 10);
    ELSE
      rChart.lPlots(1).nLabelPosition          :=PK_JRXML2PDF_CHARTS.VALUE_POSITION_NONE;
    END IF;
    rChart.lPlots(1).vcShowLines                  :=i_rTimeLineChart.vcShowLines;
    rChart.lPlots(1).vcShowShapes                 :=i_rTimeLineChart.vcShowShapes;
    -- Value-Axis-Settings
    rChart.lValueAxis(1).vcShowTickLabels         :=NVL(i_rTimeLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcShowTickMarks          :=NVL(i_rTimeLineChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lValueAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rTimeLineChart.vcValueAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lValueAxis(1).vcLabelColor             :=REPLACE(NVL(i_rTimeLineChart.vcValueAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcLabelFont              :=NVL(i_rTimeLineChart.vcValueAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcLabelFontStyle         :=NVL(i_rTimeLineChart.vcValueAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nLabelFontSize           :=NVL(i_rTimeLineChart.nValueAxisLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rTimeLineChart.vcValueAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lValueAxis(1).vcTickLabelFont          :=NVL(i_rTimeLineChart.vcValueAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lValueAxis(1).vcTickLabelFontStyle     :=NVL(i_rTimeLineChart.vcValueAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lValueAxis(1).nTickLabelFontSize       :=NVL(i_rTimeLineChart.nAxisTickLabelFontSize, 10);
    rChart.lValueAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rTimeLineChart.vcValueAxisTickLabelPattern);
    rChart.lValueAxis(1).vcLineColor              :=REPLACE(NVL(i_rTimeLineChart.vcValueAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rTimeLineChart.vcValueAxisMinValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                     i_vcExpression =>i_rTimeLineChart.vcValueAxisMaxValExpression);
    IF rDataEntry.nValue IS NOT NULL THEN
      rChart.lValueAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lValueAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- Range-Axis-Settings
    rChart.lRangeAxis(1).vcShowTickLabels         :=NVL(i_rTimeLineChart.vcShowTickLabels, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcShowTickMarks          :=NVL(i_rTimeLineChart.vcShowTickMarks, PK_JRXML2PDF_TYPES.BOOL_YES);
    rChart.lRangeAxis(1).vcLabelText              :=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                                                           i_vcExpression =>i_rTimeLineChart.vcCatAxisLabelExpression,
                                                                           i_vcPattern    =>NULL);
    rChart.lRangeAxis(1).vcLabelColor             :=REPLACE(NVL(i_rTimeLineChart.vcCatAxisLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcLabelFont              :=NVL(i_rTimeLineChart.vcCatAxisLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcLabelFontStyle         :=NVL(i_rTimeLineChart.vcCatAxisLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nLabelFontSize           :=NVL(i_rTimeLineChart.nCatAxisLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelColor         :=REPLACE(NVL(i_rTimeLineChart.vcCatAxisTickLabelColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).vcTickLabelFont          :=NVL(i_rTimeLineChart.vcCatAxisTickLabelFont, PK_JRXML2PDF_TYPES.HELVETICA);
    rChart.lRangeAxis(1).vcTickLabelFontStyle     :=NVL(i_rTimeLineChart.vcCatAxisTickLabelFontStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL);
    rChart.lRangeAxis(1).nTickLabelFontSize       :=NVL(i_rTimeLineChart.nCatAxisTickLabelFontSize, 10);
    rChart.lRangeAxis(1).vcTickLabelPattern       :=FK_NUM_PATTERN(i_rTimeLineChart.vcCatAxisTickLabelPattern);
    rChart.lRangeAxis(1).vcLineColor              :=REPLACE(NVL(i_rTimeLineChart.vcCatAxisLineColor, PK_JRXML2PDF_TYPES.BLACK),'#','');
    rChart.lRangeAxis(1).nTickLabelRotation       :=i_rTimeLineChart.nLabelRotation;
    rDataEntry.dtValue:=FK_EVALUATE_EXPRESSION_DATE(i_nStackPos    =>lReportStack.COUNT,
                                                    i_vcExpression =>i_rTimeLineChart.vcCatAxisMinValExpression);
    IF rDataEntry.dtValue IS NOT NULL THEN
      rChart.lRangeAxis(1).rMinValueDataEntry       :=rDataEntry;
      rChart.lRangeAxis(1).nMinValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    rDataEntry.dtValue:=FK_EVALUATE_EXPRESSION_DATE(i_nStackPos    =>lReportStack.COUNT,
                                                    i_vcExpression =>i_rTimeLineChart.vcCatAxisMaxValExpression);
    IF rDataEntry.dtValue IS NOT NULL THEN
      rChart.lRangeAxis(1).rMaxValueDataEntry       :=rDataEntry;
      rChart.lRangeAxis(1).nMaxValueType:=PK_JRXML2PDF_CHARTS.VALUE_FIXED;
    END IF;
    -- create datasets
    FOR i IN 1..i_rTimeLineChart.lSeries.COUNT LOOP
      lDatasets(i):=PK_JRXML2PDF_CHARTS.FK_CREATE_TIMESERIES_DATASET;
      lDatasets(i).nSeries:=i;
    END LOOP;
    -- Add data from query
    PK_JRXML2PDF_LOADER.PR_EXECUTE_QUERY(lReportStack(lReportStack.COUNT), lParams);
    WHILE FK_FETCH_ROW(lReportStack.COUNT) LOOP
      FOR i IN 1..i_rTimeLineChart.lSeries.COUNT LOOP
        rValueDataEntry.nValue:=FK_EVALUATE_EXPRESSION_NUMBER(i_nStackPos    =>lReportStack.COUNT,
                                                              i_vcExpression =>i_rTimeLineChart.lSeries(i).vcValueExpression
                                                             );
        rRangeDataEntry.dtValue:=FK_EVALUATE_EXPRESSION_DATE(i_nStackPos    =>lReportStack.COUNT,
                                                             i_vcExpression =>i_rTimeLineChart.lSeries(i).vcCategoryExpression
                                                            );
        lDatasets(i).lValueDataEntries(lDatasets(i).lValueDataEntries.COUNT+1):=rValueDataEntry;
        lDatasets(i).lRangeDataEntries(lDatasets(i).lRangeDataEntries.COUNT+1):=rRangeDataEntry;
      END LOOP;
    END LOOP;
    FOR i IN 1..i_rTimeLineChart.lSeries.COUNT LOOP
      vcSeries:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>lReportStack.COUNT,
                                       i_vcExpression =>i_rTimeLineChart.lSeries(i).vcSeriesExpression,
                                       i_vcPattern    =>NULL
                                      );
      rSeries:=PK_JRXML2PDF_CHARTS.FK_CREATE_SERIES(vcSeries);
      IF i_rTimeLineChart.lSeriesColors.EXISTS(i) THEN
        rSeries.vcColor:=REPLACE(i_rTimeLineChart.lSeriesColors(i), '#', '');
        rSeries.vcBorderColor:=rSeries.vcColor;
      END IF;
      PK_JRXML2PDF_CHARTS.PR_ADD_SERIES(rChart, rSeries);
      PK_JRXML2PDF_CHARTS.PR_ADD_DATASET(rChart, 1, lDatasets(i), vcSeries);
    END LOOP;
    -- If set, run the customizer-procedure
    IF i_rTimeLineChart.vcCustomizerClass IS NOT NULL THEN
      -- set Chart as public chart-object
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=rChart;
      EXECUTE IMMEDIATE 'BEGIN ' || i_rTimeLineChart.vcCustomizerClass || '; END;';
      rChart:=PK_JRXML2PDF_CHARTS.rCustomizableChart;
      PK_JRXML2PDF_CHARTS.rCustomizableChart:=NULL;
    END IF;
    -- render box for chart
    PR_RENDER_BOX(i_nX              =>i_nX,
                  i_nY              =>i_nY,
                  i_nWidth          =>i_nWidth,
                  i_nHeight         =>i_nHeight,
                  i_vcBgColor       =>i_rTimeLineChart.vcFillColor,
                  i_vcFgColor       =>i_rTimeLineChart.vcLineColor,
                  i_nBoxTop         =>i_rTimeLineChart.nBoxTop,
                  i_nBoxLeft        =>i_rTimeLineChart.nBoxLeft,
                  i_nBoxBottom      =>i_rTimeLineChart.nBoxBottom,
                  i_nBoxRight       =>i_rTimeLineChart.nBoxRight,
                  i_vcBoxTopColor   =>i_rTimeLineChart.vcBoxTopColor,
                  i_vcBoxLeftColor  =>i_rTimeLineChart.vcBoxLeftColor,
                  i_vcBoxBottomColor=>i_rTimeLineChart.vcBoxBottomColor,
                  i_vcBoxRightColor =>i_rTimeLineChart.vcBoxRightColor,
                  i_vcOpaque        =>i_rTimeLineChart.vcOpaque,
                  i_rStyle          =>i_rStyle
                 );
    rChart.rLocaleData:=rLocaleData;
    PK_JRXML2PDF_CHARTS.PR_CHART_TO_PDF(i_rChart=>rChart,
                                        i_nX    =>rPageSetup.nLeftMargin+i_nX+NVL(i_rTimeLineChart.nLeftPadding,0),
                                        i_nY    => rPageSetup.nPageHeight
                                                  -rPageSetup.nTopMargin
                                                  -i_nY
                                                  -NVL(i_rTimeLineChart.nTopPadding,0)
                                       );
    -- pop pseudo-subreport from stack
    PR_POP_SUBREPORT_DATA;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RENDER_BAND(i_nStackPos           IN NUMBER,
                          i_rBand               IN PK_JRXML2PDF_TYPES.tBand,
                          i_rArea               IN PK_JRXML2PDF_TYPES.tArea,
                          i_bAllowSubReports    IN BOOLEAN,
                          i_nRenderFrame        IN NUMBER,
                          i_vcContentAdjustment IN PK_JRXML2PDF_TYPES.tAlignment DEFAULT PK_JRXML2PDF_TYPES.NONE_ALIGN,
                          i_nXFactor            IN NUMBER DEFAULT 1,
                          i_nYFactor            IN NUMBER DEFAULT 1,
                          i_nNeededHeight       IN NUMBER DEFAULT NULL)
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    CURSOR crImage(i_nJrdId  IN NUMBER,
                   i_vcImage IN VARCHAR2) IS
      SELECT JRI_IMAGE,
             JRI_ID,
             JRI_ADLER32,
             JRI_ADLER32_VALID
        FROM JRXML_REPORT_IMAGES
       WHERE JRI_NAME=i_vcImage
         AND (   JRI_JRD_ID=i_nJrdId
              OR JRI_JRD_ID IS NULL
             )
       ORDER BY CASE WHEN JRI_JRD_ID IS NOT NULL THEN
                  1
                ELSE
                  2
                END;
    rArea                    PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    rOriginalArea            PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    rSubArea                 PK_JRXML2PDF_TYPES.tArea;
    nBandHeight              NUMBER:=0;
    nBandOffset              NUMBER:=0;
    vcText                   PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcPriorText              PK_JRXML2PDF_TYPES.tMaxVarchar2;
    rDummyArea               PK_JRXML2PDF_TYPES.tArea;
    blImage                  BLOB;
    vcAdler32                PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcAdler32Valid           PK_JRXML2PDF_TYPES.tYesNo;
    nJriId                   NUMBER;
    bPrintText               BOOLEAN;
    bSubreports              BOOLEAN:=FALSE;
    vcImage                  PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nPos                     NUMBER;
    vcReportName             PK_JRXML2PDF_TYPES.tName;
    lYList                   PK_JRXML2PDF_TYPES.tNumList;
    nLastY                   NUMBER;
    bRender                  BOOLEAN:=TRUE;
    -- Minimum bounds for content adjustments bounds
    nMinX                    NUMBER:=999999;
    nMaxX                    NUMBER:=-1;
    nMinY                    NUMBER:=999999;
    nMaxY                    NUMBER:=-1;
    nXFactor                 NUMBER:=i_nXFactor;
    nYFactor                 NUMBER:=i_nYFactor;
    nMaxHeightForCurrentPage NUMBER;
    bPageFrame               BOOLEAN:=FALSE;
    rStyle                   PK_JRXML2PDF_TYPES.tSimpleStyle;
    PROCEDURE PR_PROCESS_CROSSTAB(i_nMinY          IN NUMBER,
                                  i_nMaxY          IN NUMBER,
                                  i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender   BOOLEAN:=FALSE;
      rCrossTab PK_JRXML2PDF_TYPES.tCrosstab;
    BEGIN
      IF      lReportStack(i_nStackPos).lCrosstabs(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lCrosstabs(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lCrosstabs(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render crosstab');
        END IF;
        rDummyArea:=rArea;
        rDummyArea.nX:=rArea.nX+lReportStack(i_nStackPos).lCrosstabs(nPos).nX;
        rDummyArea.nY:=rArea.nY+lReportStack(i_nStackPos).lCrosstabs(nPos).nY;
        rCrossTab:=lReportStack(i_nStackPos).lCrosstabs(nPos);
        -- resolve parameters
        rCrossTab.lParams:=FK_POPULATE_PARAMLIST(i_nStackPos =>i_nStackPos,
                                                 i_lParamList=>rCrossTab.lParams);
        rArea:=FK_RENDER_CROSSTAB(i_nStackPos        =>i_nStackPos,
                                  i_rCrosstab        =>rCrossTab,
                                  i_rArea            =>rDummyArea
                                 );
      END IF;
    END;
    PROCEDURE PR_PROCESS_SUBFRAME(i_nMinY          IN NUMBER,
                                  i_nMaxY          IN NUMBER,
                                  i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender       BOOLEAN:=FALSE;
      rBand         PK_JRXML2PDF_TYPES.tBand;
      nNeededHeight NUMBER;
    BEGIN
      IF     lReportStack(i_nStackPos).lbands(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lbands(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lbands(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lbands(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render subframe');
        END IF;
        rDummyArea:=rArea;
        rDummyArea.nX:=rArea.nX+lReportStack(i_nStackPos).lbands(nPos).nX*nXFactor;
        rDummyArea.nY:=rArea.nY+lReportStack(i_nStackPos).lbands(nPos).nY*nYFactor;
        rBand:=lReportStack(i_nStackPos).lbands(nPos);
        rBand.nWidth:=rBand.nWidth*nXFactor;
        -- subframes can be stretched
        IF rBand.vcStretch=PK_JRXML2PDF_TYPES.YES THEN
          IF (rBand.nHeight+nBandOffset<=nMaxHeightForCurrentPage) THEN
            nNeededHeight:=(rBand.nHeight+nBandOffset)*nYFactor;
          ELSE
            nNeededHeight:=(nMaxHeightForCurrentPage)*nYFactor;
          END IF;
        END IF;
        rBand.nHeight:=rBand.nHeight*nYFactor;
        rDummyArea:=FK_RENDER_BAND(i_nStackPos          =>i_nStackPos,
                                   i_rBand              =>rBand,
                                   i_rArea              =>rDummyArea,
                                   i_bAllowSubReports   =>i_bAllowSubReports,
                                   i_nRenderFrame       =>PK_JRXML2PDF_TYPES.RENDER_FRAME_BEFORE,
                                   i_nXFactor           =>nXFactor,
                                   i_nYFactor           =>nYFactor,
                                   i_nNeededHeight      =>nNeededheight
                                  );
        IF rDummyArea.nPage>rArea.nPage THEN
          rArea.nPage:=rDummyArea.nPage;
          rArea.nY:=rDummyArea.nY;
        END IF;
      END IF;
    END;
    PROCEDURE PR_PROCESS_LINE(i_nMinY          IN NUMBER,
                              i_nMaxY          IN NUMBER,
                              i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender BOOLEAN:=FALSE;
    BEGIN
      IF     lReportStack(i_nStackPos).lLines(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lLines(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lLines(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lLines(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Line');
        END IF;
        PR_RENDER_LINE(i_nX         =>rArea.nX + lReportStack(i_nStackPos).lLines(nPos).nX*nXFactor,
                       i_nY         =>rArea.nY + lReportStack(i_nStackPos).lLines(nPos).nY*nYFactor,
                       i_nWidth     =>lReportStack(i_nStackPos).lLines(nPos).nWidth*nXFactor,
                       i_nHeight    =>CASE WHEN lReportStack(i_nStackPos).lLines(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
                                        (lReportStack(i_nStackPos).lLines(nPos).nHeight+nBandOffset)*nYFactor
                                      ELSE
                                        lReportStack(i_nStackPos).lLines(nPos).nHeight*nYFactor
                                      END,
                       i_nLineWidth =>lReportStack(i_nStackPos).lLines(nPos).nLineWidth,
                       i_vcLineColor=>lReportStack(i_nStackPos).lLines(nPos).vcLineColor,
                       i_rStyle     =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lLines(nPos).vcStyle)
                      );
      END IF;
    END;
    PROCEDURE PR_PROCESS_RECTANGLE(i_nMinY          IN NUMBER,
                                   i_nMaxY          IN NUMBER,
                                   i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender     BOOLEAN:=FALSE;
      rStyle      PK_JRXML2PDF_TYPES.tSimpleStyle;
      vcLineColor PK_JRXML2PDF_TYPES.tColor;
      vcFillColor PK_JRXML2PDF_TYPES.tColor;
      nLineWidth  NUMBER;
      vcOpaque    PK_JRXML2PDF_TYPES.tYesNo;
    BEGIN
      IF     lReportStack(i_nStackPos).lRectangles(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lRectangles(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lRectangles(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lRectangles(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Rectangle');
        END IF;
        -- defaults
        rStyle:=FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lRectangles(nPos).vcStyle);
        vcLineColor:=REPLACE(COALESCE(lReportStack(i_nStackPos).lRectangles(nPos).vcLineColor, rStyle.vcFGColor, PK_JRXML2PDF_TYPES.BLACK), '#', '');
        vcFillColor:=REPLACE(COALESCE(lReportStack(i_nStackPos).lRectangles(nPos).vcFillColor, rStyle.vcBgColor, PK_JRXML2PDF_TYPES.WHITE), '#', '');
        nLineWidth:=COALESCE(lReportStack(i_nStackPos).lRectangles(nPos).nLineWidth, rStyle.nLineWidth, PK_JRXML2PDF_TYPES.THIN);
        vcOpaque  :=COALESCE(lReportStack(i_nStackPos).lRectangles(nPos).vcOpaque,   rStyle.vcOpaque, PK_JRXML2PDF_TYPES.YES);
        PR_RENDER_BOX(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lRectangles(nPos).nX*nXFactor,
                      i_nY              =>rArea.nY + lReportStack(i_nStackPos).lRectangles(nPos).nY*nYFactor,
                      i_nWidth          =>lReportStack(i_nStackPos).lRectangles(nPos).nWidth*nXFactor,
                      i_nHeight         =>CASE WHEN lReportStack(i_nStackPos).lRectangles(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
                                            (lReportStack(i_nStackPos).lRectangles(nPos).nHeight+nBandOffset)*nYFactor
                                          ELSE
                                            (lReportStack(i_nStackPos).lRectangles(nPos).nHeight)*nYFactor
                                          END,
                      i_vcBgColor       =>vcFillColor,
                      i_vcFgColor       =>vcLineColor,
                      i_nBoxTop         =>nLineWidth,
                      i_nBoxLeft        =>nLineWidth,
                      i_nBoxBottom      =>nLineWidth,
                      i_nBoxRight       =>nLineWidth,
                      i_vcBoxTopColor   =>vcLineColor,
                      i_vcBoxLeftColor  =>vcLineColor,
                      i_vcBoxBottomColor=>vcLineColor,
                      i_vcBoxRightColor =>vcLineColor,
                      i_vcOpaque        =>vcOpaque,
                      i_rStyle          =>rStyle
                     );
      END IF;
    END;
    PROCEDURE PR_PROCESS_IMAGE(i_nMinY          IN NUMBER,
                               i_nMaxY          IN NUMBER,
                               i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender BOOLEAN:=FALSE;
    BEGIN
      IF     lReportStack(i_nStackPos).lImages(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lImages(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lImages(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lImages(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                  i_vcExpression=>lReportStack(i_nStackPos).lImages(nPos).vcImageName,
                                  i_vcPattern   =>NULL
                                 )=PK_JRXML2PDF_TYPES.THIS_IS_A_BLOB THEN
          blImage:=FK_EVALUATE_IMAGE(i_nStackPos   =>i_nStackPos,
                                     i_vcExpression=>lReportStack(i_nStackPos).lImages(nPos).vcImageName
                                    );
          vcAdler32:=NULL;
        ELSE
          vcImage:=REPLACE(lReportStack(i_nStackPos).lImages(nPos).vcImageName, '"', '');
          IF INSTR(vcImage, '\', -1)>0 THEN
            vcImage:=SUBSTR(vcImage, INSTR(vcImage, '\', -1)+1);
          END IF;
          OPEN crImage(lReportStack(i_nStackPos).nId, vcImage);
          FETCH crImage INTO blImage,
                             nJriId,
                             vcAdler32,
                             vcAdler32Valid;
          CLOSE crImage;
          IF vcAdler32Valid=PK_JRXML2PDF_TYPES.NO THEN
            -- precalulate Adler32 and store in Report-table
              vcAdler32:=PK_JRXML2PDF_UTIL.FK_UPDATE_ADLER32_FOR_IMAGE(i_nId    =>nJriId,
                                                                       i_blImage=>blImage);
          END IF;
        END IF;
        IF blImage IS NOT NULL THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Image x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lImages(nPos).nX) || '/' ||
                                                                                    TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lImages(nPos).nY) || '/' ||
                                                                                    TO_CHAR(lReportStack(i_nStackPos).lImages(nPos).nWidth)        || '/' ||
                                                                                    TO_CHAR(lReportStack(i_nStackPos).lImages(nPos).nHeight)
                                               );
          END IF;
          PR_RENDER_IMAGE(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lImages(nPos).nX*nXFactor,
                          i_nY              =>rArea.nY + lReportStack(i_nStackPos).lImages(nPos).nY*nYFactor,
                          i_nWidth          =>lReportStack(i_nStackPos).lImages(nPos).nWidth*nXFactor,
                          i_nHeight         =>lReportStack(i_nStackPos).lImages(nPos).nHeight*nYFactor,
                          i_blImage         =>blImage,
                          i_vcAdler32       =>vcAdler32
                         );
          PR_RENDER_BOX(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lImages(nPos).nX*nXFactor,
                        i_nY              =>rArea.nY + lReportStack(i_nStackPos).lImages(nPos).nY*nYFactor,
                        i_nWidth          =>lReportStack(i_nStackPos).lImages(nPos).nWidth*nXFactor,
                        i_nHeight         =>lReportStack(i_nStackPos).lImages(nPos).nHeight*nYFactor,
                        i_vcBgColor       =>NULL,
                        i_vcFgColor       =>lReportStack(i_nStackPos).lImages(nPos).vcFillColor,
                        i_nBoxTop         =>lReportStack(i_nStackPos).lImages(nPos).nBoxTop,
                        i_nBoxLeft        =>lReportStack(i_nStackPos).lImages(nPos).nBoxLeft,
                        i_nBoxBottom      =>lReportStack(i_nStackPos).lImages(nPos).nBoxBottom,
                        i_nBoxRight       =>lReportStack(i_nStackPos).lImages(nPos).nBoxRight,
                        i_vcBoxTopColor   =>lReportStack(i_nStackPos).lImages(nPos).vcBoxTopColor,
                        i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lImages(nPos).vcBoxLeftColor,
                        i_vcBoxBottomColor=>lReportStack(i_nStackPos).lImages(nPos).vcBoxBottomColor,
                        i_vcBoxRightColor =>lReportStack(i_nStackPos).lImages(nPos).vcBoxRightColor,
                        i_vcOpaque        =>PK_JRXML2PDF_TYPES.YES,
                        i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lImages(nPos).vcStyle)
                       );
        END IF;
      END IF;
    END;
    PROCEDURE PR_PROCESS_MAP(i_nMinY          IN NUMBER,
                             i_nMaxY          IN NUMBER,
                             i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      nLatitude  NUMBER;
      nLongitude NUMBER;
      nZoomLevel NUMBER;
      vcUrl      PK_JRXML2PDF_TYPES.tMaxVarchar2;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
      FUNCTION FK_MAP_PARAMETER(i_vcExpression IN VARCHAR2)
      RETURN NUMBER IS
        vcStatement PK_JRXML2PDF_TYPES.tMaxVarchar2;
        nValue      NUMBER;
      BEGIN
        vcStatement:=FK_EVALUATE_EXPRESSION_INT(i_nStackPos    =>i_nStackPos,
                                                i_vcExpression =>i_vcExpression,
                                                i_vcPattern    =>NULL,
                                                i_bForSQLUsage =>TRUE,
                                                i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NONE
                                               );
        EXECUTE IMMEDIATE 'SELECT ' || vcStatement || ' FROM DUAL'
                    INTO nValue;
        RETURN nValue;
      END;
    BEGIN
      IF     lReportStack(i_nStackPos).lMaps(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lMaps(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lMaps(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lMaps(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        BEGIN
          -- evaluate conditions for map-location
          nLatitude:=FK_MAP_PARAMETER(i_vcExpression=>lReportStack(i_nStackPos).lMaps(nPos).vcLatitudeExpression);
          nLongitude:=FK_MAP_PARAMETER(i_vcExpression=>lReportStack(i_nStackPos).lMaps(nPos).vcLongitudeExpression);
          nZoomLevel:=FK_MAP_PARAMETER(i_vcExpression=>lReportStack(i_nStackPos).lMaps(nPos).vcZoomExpression);
          vcUrl:=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(PK_JRXML2PDF_TYPES.MAP_URL,
                                                         '#LATITUDE#',
                                                         TO_CHAR(nLatitude, PK_JRXML2PDF_TYPES.DEFAULT_FLOAT_FORMAT, 'NLS_NUMERIC_CHARACTERS=.,')
                                                        ),
                                                 '#LONGITUDE#',
                                                 TO_CHAR(nLongitude, PK_JRXML2PDF_TYPES.DEFAULT_FLOAT_FORMAT, 'NLS_NUMERIC_CHARACTERS=.,')
                                                ),
                                         '#ZOOM#',
                                         TO_CHAR(TRUNC(nZoomLevel))
                                        ),
                                 '#WIDTH#',
                                 TO_CHAR(TRUNC(lReportStack(i_nStackPos).lMaps(nPos).nWidth))
                                ),
                         '#HEIGHT#',
                         TO_CHAR(TRUNC(lReportStack(i_nStackPos).lMaps(nPos).nHeight))
                        );
          blImage:=HTTPURITYPE(vcUrl).GETBLOB();
        EXCEPTION
          WHEN OTHERS THEN
            -- render error, output error as text
            rDummy:=FK_RENDER_TEXT(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lMaps(nPos).nX,
                                   i_nY              =>rArea.nY + lReportStack(i_nStackPos).lMaps(nPos).nY,
                                   i_nWidth          =>lReportStack(i_nStackPos).lMaps(nPos).nWidth,
                                   i_nHeight         =>lReportStack(i_nStackPos).lMaps(nPos).nHeight,
                                   i_vcText          =>'Error when reading map-image',
                                   i_vcFont          =>'ARIAL',
                                   i_nFontSize       =>10,
                                   i_vcFontStyle     =>PK_JRXML2PDF_TYPES.FONT_NORMAL,
                                   i_vcAlignment     =>PK_JRXML2PDF_TYPES.LEFT_ALIGN,
                                   i_vcVerticalAlign =>PK_JRXML2PDF_TYPES.TOP_ALIGN,
                                   i_vcBgColor       =>PK_JRXML2PDF_TYPES.WHITE,
                                   i_vcFgColor       =>PK_JRXML2PDF_TYPES.BLACK,
                                   i_nBoxTop         =>NULL,
                                   i_nBoxLeft        =>NULL,
                                   i_nBoxBottom      =>NULL,
                                   i_nBoxRight       =>NULL,
                                   i_nTopPadding     =>NULL,
                                   i_nLeftPadding    =>NULL,
                                   i_nBottomPadding  =>NULL,
                                   i_nRightPadding   =>NULL,
                                   i_vcBoxTopColor   =>NULL,
                                   i_vcBoxLeftColor  =>NULL,
                                   i_vcBoxBottomColor=>NULL,
                                   i_vcBoxRightColor =>NULL,
                                   i_nLineSpacing    =>PK_JRXML2PDF_TYPES.MIN_LINE_SPACING,
                                   i_vcOpaque        =>PK_JRXML2PDF_TYPES.NO,
                                   i_rStyle          =>NULL
                                  );
            bRender:=FALSE;
        END;
        IF bRender THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lMaps(nPos).nX) || '/' ||
                                                                               TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lMaps(nPos).nY) || '/' ||
                                                                               TO_CHAR(lReportStack(i_nStackPos).lMaps(nPos).nWidth)        || '/' ||
                                                                               TO_CHAR(lReportStack(i_nStackPos).lMaps(nPos).nHeight)
                                               );
          END IF;
          PR_RENDER_IMAGE(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lMaps(nPos).nX*nXFactor,
                          i_nY              =>rArea.nY + lReportStack(i_nStackPos).lMaps(nPos).nY*nYFactor,
                          i_nWidth          =>lReportStack(i_nStackPos).lMaps(nPos).nWidth*nXFactor,
                          i_nHeight         =>lReportStack(i_nStackPos).lMaps(nPos).nHeight*nYFactor,
                          i_blImage         =>blImage,
                          i_vcAdler32       =>NULL
                         );
          DBMS_LOB.FREETEMPORARY(blImage);
          PR_RENDER_BOX(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lMaps(nPos).nX*nXFactor,
                        i_nY              =>rArea.nY + lReportStack(i_nStackPos).lMaps(nPos).nY*nYFactor,
                        i_nWidth          =>lReportStack(i_nStackPos).lMaps(nPos).nWidth*nXFactor,
                        i_nHeight         =>lReportStack(i_nStackPos).lMaps(nPos).nHeight*nYFactor,
                        i_vcBgColor       =>NULL,
                        i_vcFgColor       =>lReportStack(i_nStackPos).lMaps(nPos).vcFillColor,
                        i_nBoxTop         =>lReportStack(i_nStackPos).lMaps(nPos).nBoxTop,
                        i_nBoxLeft        =>lReportStack(i_nStackPos).lMaps(nPos).nBoxLeft,
                        i_nBoxBottom      =>lReportStack(i_nStackPos).lMaps(nPos).nBoxBottom,
                        i_nBoxRight       =>lReportStack(i_nStackPos).lMaps(nPos).nBoxRight,
                        i_vcBoxTopColor   =>lReportStack(i_nStackPos).lMaps(nPos).vcBoxTopColor,
                        i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lMaps(nPos).vcBoxLeftColor,
                        i_vcBoxBottomColor=>lReportStack(i_nStackPos).lMaps(nPos).vcBoxBottomColor,
                        i_vcBoxRightColor =>lReportStack(i_nStackPos).lMaps(nPos).vcBoxRightColor,
                        i_vcOpaque        =>PK_JRXML2PDF_TYPES.YES,
                        i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lMaps(nPos).vcStyle)
                       );
        END IF;
      END IF;
    END;
    PROCEDURE PR_PROCESS_BARCHART(i_nMinY          IN NUMBER,
                                  i_nMaxY          IN NUMBER,
                                  i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lBarcharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lBarcharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lBarcharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lBarcharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lBarcharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lBarcharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lBarcharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lBarcharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_BARCHART(i_nX        =>rArea.nX + lReportStack(i_nStackPos).lBarcharts(nPos).nX*nXFactor,
                           i_nY        =>rArea.nY + lReportStack(i_nStackPos).lBarcharts(nPos).nY*nYFactor,
                           i_nWidth    =>lReportStack(i_nStackPos).lBarcharts(nPos).nWidth*nXFactor,
                           i_nHeight   =>lReportStack(i_nStackPos).lBarcharts(nPos).nHeight*nYFactor,
                           i_rBarChart =>lReportStack(i_nStackPos).lBarcharts(nPos),
                           i_rStyle    =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lBarcharts(nPos).vcStyle)
                          );
      END IF;
    END;
    PROCEDURE PR_PROCESS_STACKEDAREACHART(i_nMinY          IN NUMBER,
                                          i_nMaxY          IN NUMBER,
                                          i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lStackedAreaCharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lStackedAreaCharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lStackedAreaCharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_STACKEDAREACHART(i_nX                =>rArea.nX + lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nX*nXFactor,
                                   i_nY                =>rArea.nY + lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nY*nYFactor,
                                   i_nWidth            =>lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nWidth*nXFactor,
                                   i_nHeight           =>lReportStack(i_nStackPos).lStackedAreaCharts(nPos).nHeight*nYFactor,
                                   i_rStackedAreaChart =>lReportStack(i_nStackPos).lStackedAreaCharts(nPos),
                                   i_rStyle            =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lStackedAreaCharts(nPos).vcStyle)
                                  );
      END IF;
    END;
    PROCEDURE PR_PROCESS_PIECHART(i_nMinY          IN NUMBER,
                                  i_nMaxY          IN NUMBER,
                                  i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lPiecharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lPiecharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lPiecharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lPiecharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lPiecharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lPiecharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lPiecharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lPiecharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_PIECHART(i_nX        =>rArea.nX + lReportStack(i_nStackPos).lPiecharts(nPos).nX*nXFactor,
                           i_nY        =>rArea.nY + lReportStack(i_nStackPos).lPiecharts(nPos).nY*nYFactor,
                           i_nWidth    =>lReportStack(i_nStackPos).lPiecharts(nPos).nWidth*nXFactor,
                           i_nHeight   =>lReportStack(i_nStackPos).lPiecharts(nPos).nHeight*nYFactor,
                           i_rPieChart =>lReportStack(i_nStackPos).lPiecharts(nPos),
                           i_rStyle    =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lPiecharts(nPos).vcStyle)
                          );
      END IF;
    END;
    PROCEDURE PR_PROCESS_CAT_LINECHART(i_nMinY          IN NUMBER,
                                       i_nMaxY          IN NUMBER,
                                       i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lCategoryLinecharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lCategoryLinecharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lCategoryLinecharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_CAT_LINECHART(i_nX                =>rArea.nX + lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nX*nXFactor,
                                i_nY                =>rArea.nY + lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nY*nYFactor,
                                i_nWidth            =>lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nWidth*nXFactor,
                                i_nHeight           =>lReportStack(i_nStackPos).lCategoryLinecharts(nPos).nHeight*nYFactor,
                                i_rCategoryLineChart=>lReportStack(i_nStackPos).lCategoryLinecharts(nPos),
                                i_rStyle            =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lCategoryLinecharts(nPos).vcStyle)
                               );
      END IF;
    END;
    PROCEDURE PR_PROCESS_XY_LINECHART(i_nMinY          IN NUMBER,
                                      i_nMaxY          IN NUMBER,
                                      i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lXYLineCharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lXYLineCharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lXYLineCharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lXYLineCharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lXYLineCharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lXYLineCharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lXYLineCharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lXYLineCharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_XY_LINECHART(i_nX           =>rArea.nX + lReportStack(i_nStackPos).lXYLineCharts(nPos).nX*nXFactor,
                               i_nY           =>rArea.nY + lReportStack(i_nStackPos).lXYLineCharts(nPos).nY*nYFactor,
                               i_nWidth       =>lReportStack(i_nStackPos).lXYLineCharts(nPos).nWidth*nXFactor,
                               i_nHeight      =>lReportStack(i_nStackPos).lXYLineCharts(nPos).nHeight*nYFactor,
                               i_rXYLineChart =>lReportStack(i_nStackPos).lXYLineCharts(nPos),
                               i_rStyle       =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lXYLineCharts(nPos).vcStyle)
                              );
      END IF;
    END;
    PROCEDURE PR_PROCESS_TIME_LINECHART(i_nMinY          IN NUMBER,
                                        i_nMaxY          IN NUMBER,
                                        i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender    BOOLEAN:=FALSE;
      rDummy     PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lTimeLineCharts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lTimeLineCharts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lTimeLineCharts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lTimeLineCharts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Map x/Y/Width/Height:' || TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lTimeLineCharts(nPos).nX) || '/' ||
                                                                             TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lTimeLineCharts(nPos).nY) || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lTimeLineCharts(nPos).nWidth)        || '/' ||
                                                                             TO_CHAR(lReportStack(i_nStackPos).lTimeLineCharts(nPos).nHeight)
                                             );
        END IF;
        PR_RENDER_TIME_LINECHART(i_nX            =>rArea.nX + lReportStack(i_nStackPos).lTimeLineCharts(nPos).nX*nXFactor,
                                 i_nY            =>rArea.nY + lReportStack(i_nStackPos).lTimeLineCharts(nPos).nY*nYFactor,
                                 i_nWidth        =>lReportStack(i_nStackPos).lTimeLineCharts(nPos).nWidth*nXFactor,
                                 i_nHeight       =>lReportStack(i_nStackPos).lTimeLineCharts(nPos).nHeight*nYFactor,
                                 i_rTimeLineChart=>lReportStack(i_nStackPos).lTimeLineCharts(nPos),
                                 i_rStyle        =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lTimeLineCharts(nPos).vcStyle)
                                );
      END IF;
    END;
    PROCEDURE PR_PROCESS_TEXT(i_nMinY          IN NUMBER,
                              i_nMaxY          IN NUMBER,
                              i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      bRender BOOLEAN:=FALSE;
      rDummy  PK_JRXML2PDF_TYPES.tArea;
    BEGIN
      IF     lReportStack(i_nStackPos).lTexts(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lTexts(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lTexts(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lTexts(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render Static Text:' || lReportStack(i_nStackPos).lTexts(nPos).vcText);
        END IF;
        rDummy:=FK_RENDER_TEXT(i_nX              =>rArea.nX + lReportStack(i_nStackPos).lTexts(nPos).nX*nXFactor,
                               i_nY              =>rArea.nY + lReportStack(i_nStackPos).lTexts(nPos).nY*nYFactor,
                               i_nWidth          =>lReportStack(i_nStackPos).lTexts(nPos).nWidth*nXFactor,
                               i_nHeight         =>CASE WHEN lReportStack(i_nStackPos).lTexts(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
                                                     (lReportStack(i_nStackPos).lTexts(nPos).nHeight+nBandOffset)*nYFactor
                                                   ELSE
                                                     (lReportStack(i_nStackPos).lTexts(nPos).nHeight)*nYFactor
                                                   END,
                               i_vcText          =>lReportStack(i_nStackPos).lTexts(nPos).vcText,
                               i_vcFont          =>lReportStack(i_nStackPos).lTexts(nPos).vcFont,
                               i_nFontSize       =>lReportStack(i_nStackPos).lTexts(nPos).nFontSize,
                               i_vcFontStyle     =>lReportStack(i_nStackPos).lTexts(nPos).vcFontStyle,
                               i_vcAlignment     =>lReportStack(i_nStackPos).lTexts(nPos).vcAlignment,
                               i_vcVerticalAlign =>lReportStack(i_nStackPos).lTexts(nPos).vcVerticalAlign,
                               i_vcBgColor       =>lReportStack(i_nStackPos).lTexts(nPos).vcBGColor,
                               i_vcFgColor       =>lReportStack(i_nStackPos).lTexts(nPos).vcFGColor,
                               i_nBoxTop         =>lReportStack(i_nStackPos).lTexts(nPos).nBoxTop,
                               i_nBoxLeft        =>lReportStack(i_nStackPos).lTexts(nPos).nBoxLeft,
                               i_nBoxBottom      =>lReportStack(i_nStackPos).lTexts(nPos).nBoxBottom,
                               i_nBoxRight       =>lReportStack(i_nStackPos).lTexts(nPos).nBoxRight,
                               i_nTopPadding     =>lReportStack(i_nStackPos).lTexts(nPos).nTopPadding,
                               i_nLeftPadding    =>lReportStack(i_nStackPos).lTexts(nPos).nLeftPadding,
                               i_nBottomPadding  =>lReportStack(i_nStackPos).lTexts(nPos).nBottomPadding,
                               i_nRightPadding   =>lReportStack(i_nStackPos).lTexts(nPos).nRightPadding,
                               i_vcBoxTopColor   =>lReportStack(i_nStackPos).lTexts(nPos).vcBoxTopColor,
                               i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lTexts(nPos).vcBoxLeftColor,
                               i_vcBoxBottomColor=>lReportStack(i_nStackPos).lTexts(nPos).vcBoxBottomColor,
                               i_vcBoxRightColor =>lReportStack(i_nStackPos).lTexts(nPos).vcBoxRightColor,
                               i_nLineSpacing    =>PK_JRXML2PDF_TYPES.MIN_LINE_SPACING,
                               i_vcOpaque        =>lReportStack(i_nStackPos).lTexts(nPos).vcOpaque,
                               i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lTexts(nPos).vcStyle),
                               i_vcRotation      =>lReportStack(i_nStackPos).lTexts(nPos).vcRotation
                              );
      END IF;
    END;
    FUNCTION FK_PROCESS_FIELD(i_nMinY          IN NUMBER,
                              i_nMaxY          IN NUMBER,
                              i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType)
    RETURN BOOLEAN IS
      bPageBreaks BOOLEAN:=FALSE;
      bRender     BOOLEAN:=FALSE;
      vcPattern   PK_JRXML2PDF_TYPES.tPattern;
      nPage       NUMBER:=i_rArea.nPage;
    BEGIN
      IF     lReportStack(i_nStackPos).lFields(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=NVL(lReportStack(i_nStackPos).lFields(nPos).vcPositionType, PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP) THEN
        bRender:=TRUE;
      END IF;
      IF bRender AND lReportStack(i_nStackPos).lFields(nPos).vcWhenExpression IS NOT NULL THEN
        bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                       i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcWhenExpression
                                      );
      END IF;
      IF bRender THEN
        IF NVL(lReportStack(i_nStackPos).lFields(nPos).vcEvaluationTime,PK_JRXML2PDF_TYPES.EVALUATION_NOW)=PK_JRXML2PDF_TYPES.EVALUATION_NOW THEN
          IF lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression IS NOT NULL THEN
            vcPattern:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                              i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression,
                                              i_vcPattern   =>NULL);
          ELSE
            vcPattern:=lReportStack(i_nStackPos).lFields(nPos).vcPattern;
          END IF;
          vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                         i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcExpression,
                                         i_vcPattern   =>vcPattern);
          bPrintText:=TRUE;
          IF     lReportStack(i_nStackPos).lFields(nPos).vcPrintRepeated=PK_JRXML2PDF_TYPES.NO
             AND lReportStack(i_nStackPos).rQuery.nPreviousRecord IS NOT NULL THEN
            IF lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression IS NOT NULL THEN
              vcPattern:=FK_EVALUATE_EXPRESSION(i_nStackPos   =>i_nStackPos,
                                                i_vcExpression=>lReportStack(i_nStackPos).lFields(nPos).vcPatternExpression,
                                                i_vcPattern   =>NULL);
            ELSE
              vcPattern:=lReportStack(i_nStackPos).lFields(nPos).vcPattern;
            END IF;
            vcPriorText:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>i_nStackPos,
                                                i_vcExpression =>lReportStack(i_nStackPos).lFields(nPos).vcExpression,
                                                i_vcPattern    =>lReportStack(i_nStackPos).lFields(nPos).vcpattern,
                                                i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_PREVIOUS);
            IF vcText=vcPriorText THEN
              bPrintText:=FALSE;
            END IF;
          END IF;
          IF bPrintText THEN
            IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
              PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render TextField, Stretch, Opaque, x, y, Offset' ||
                                               vcText || ', ' ||
                                               lReportStack(i_nStackPos).lFields(nPos).vcStretch || ',' ||
                                               lReportStack(i_nStackPos).lFields(nPos).vcOpaque  || ',' ||
                                               TO_CHAR(rArea.nX + lReportStack(i_nStackPos).lFields(nPos).nX*nXFactor) || ',' ||
                                               TO_CHAR(rArea.nY + lReportStack(i_nStackPos).lFields(nPos).nY*nYFactor) || ',' ||
                                               TO_CHAR(nBandOffset)
                                              );
            END IF;
            IF lReportStack(i_nStackPos).lFields(nPos).vcMarkup='html' THEN
              rArea:=FK_RENDER_HTML( i_nX              =>rArea.nX + lReportStack(i_nStackPos).lFields(nPos).nX*nXFactor,
                                     i_nY              =>rArea.nY + lReportStack(i_nStackPos).lFields(nPos).nY*nYFactor,
                                     i_nWidth          =>lReportStack(i_nStackPos).lFields(nPos).nWidth*nXFactor,
                                     i_nHeight         =>CASE WHEN lReportStack(i_nStackPos).lFields(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
                                                           (lReportStack(i_nStackPos).lFields(nPos).nHeight+nBandOffset)*nYFactor
                                                         ELSE
                                                           (lReportStack(i_nStackPos).lFields(nPos).nHeight)*nYFactor
                                                         END,
                                     i_vcText          =>vcText,
                                     i_vcFont          =>lReportStack(i_nStackPos).lFields(nPos).vcFont,
                                     i_nFontSize       =>lReportStack(i_nStackPos).lFields(nPos).nFontSize,
                                     i_vcFontStyle     =>lReportStack(i_nStackPos).lFields(nPos).vcFontStyle,
                                     i_vcAlignment     =>lReportStack(i_nStackPos).lFields(nPos).vcAlignment,
                                     i_vcVerticalAlign =>lReportStack(i_nStackPos).lFields(nPos).vcVerticalAlign,
                                     i_vcBgColor       =>lReportStack(i_nStackPos).lFields(nPos).vcBGColor,
                                     i_vcFgColor       =>lReportStack(i_nStackPos).lFields(nPos).vcFGColor,
                                     i_nBoxTop         =>lReportStack(i_nStackPos).lFields(nPos).nBoxTop,
                                     i_nBoxLeft        =>lReportStack(i_nStackPos).lFields(nPos).nBoxLeft,
                                     i_nBoxBottom      =>lReportStack(i_nStackPos).lFields(nPos).nBoxBottom,
                                     i_nBoxRight       =>lReportStack(i_nStackPos).lFields(nPos).nBoxRight,
                                     i_nTopPadding     =>lReportStack(i_nStackPos).lFields(nPos).nTopPadding,
                                     i_nLeftPadding    =>lReportStack(i_nStackPos).lFields(nPos).nLeftPadding,
                                     i_nBottomPadding  =>lReportStack(i_nStackPos).lFields(nPos).nBottomPadding,
                                     i_nRightPadding   =>lReportStack(i_nStackPos).lFields(nPos).nRightPadding,
                                     i_vcBoxTopColor   =>lReportStack(i_nStackPos).lFields(nPos).vcBoxTopColor,
                                     i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lFields(nPos).vcBoxLeftColor,
                                     i_vcBoxBottomColor=>lReportStack(i_nStackPos).lFields(nPos).vcBoxBottomColor,
                                     i_vcBoxRightColor =>lReportStack(i_nStackPos).lFields(nPos).vcBoxRightColor,
                                     i_nLineSpacing    =>lReportStack(i_nStackPos).lFields(nPos).nLineSpacing,
                                     i_vcOpaque        =>lReportStack(i_nStackPos).lFields(nPos).vcOpaque,
                                     i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lFields(nPos).vcStyle),
                                     i_bMayPageBreak   =>    lReportStack(i_nStackPos).lFields(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES
                                                         AND nBandOffset>0,
                                     i_rArea           =>rArea,
                                     i_bEnhanced       =>NVL(lReportStack(i_nStackPos).lFields(nPos).vcKey, '.') LIKE 'enhanced%'
                                    );
            ELSE
              rArea:=FK_RENDER_TEXT( i_nX              =>rArea.nX + lReportStack(i_nStackPos).lFields(nPos).nX*nXFactor,
                                     i_nY              =>rArea.nY + lReportStack(i_nStackPos).lFields(nPos).nY*nYFactor,
                                     i_nWidth          =>lReportStack(i_nStackPos).lFields(nPos).nWidth*nXFactor,
                                     i_nHeight         =>CASE WHEN lReportStack(i_nStackPos).lFields(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
                                                           (lReportStack(i_nStackPos).lFields(nPos).nHeight+nBandOffset)*nYFactor
                                                         ELSE
                                                           (lReportStack(i_nStackPos).lFields(nPos).nHeight)*nYFactor
                                                         END,
                                     i_vcText          =>vcText,
                                     i_vcFont          =>lReportStack(i_nStackPos).lFields(nPos).vcFont,
                                     i_nFontSize       =>lReportStack(i_nStackPos).lFields(nPos).nFontSize,
                                     i_vcFontStyle     =>lReportStack(i_nStackPos).lFields(nPos).vcFontStyle,
                                     i_vcAlignment     =>lReportStack(i_nStackPos).lFields(nPos).vcAlignment,
                                     i_vcVerticalAlign =>lReportStack(i_nStackPos).lFields(nPos).vcVerticalAlign,
                                     i_vcBgColor       =>lReportStack(i_nStackPos).lFields(nPos).vcBGColor,
                                     i_vcFgColor       =>lReportStack(i_nStackPos).lFields(nPos).vcFGColor,
                                     i_nBoxTop         =>lReportStack(i_nStackPos).lFields(nPos).nBoxTop,
                                     i_nBoxLeft        =>lReportStack(i_nStackPos).lFields(nPos).nBoxLeft,
                                     i_nBoxBottom      =>lReportStack(i_nStackPos).lFields(nPos).nBoxBottom,
                                     i_nBoxRight       =>lReportStack(i_nStackPos).lFields(nPos).nBoxRight,
                                     i_nTopPadding     =>lReportStack(i_nStackPos).lFields(nPos).nTopPadding,
                                     i_nLeftPadding    =>lReportStack(i_nStackPos).lFields(nPos).nLeftPadding,
                                     i_nBottomPadding  =>lReportStack(i_nStackPos).lFields(nPos).nBottomPadding,
                                     i_nRightPadding   =>lReportStack(i_nStackPos).lFields(nPos).nRightPadding,
                                     i_vcBoxTopColor   =>lReportStack(i_nStackPos).lFields(nPos).vcBoxTopColor,
                                     i_vcBoxLeftColor  =>lReportStack(i_nStackPos).lFields(nPos).vcBoxLeftColor,
                                     i_vcBoxBottomColor=>lReportStack(i_nStackPos).lFields(nPos).vcBoxBottomColor,
                                     i_vcBoxRightColor =>lReportStack(i_nStackPos).lFields(nPos).vcBoxRightColor,
                                     i_nLineSpacing    =>lReportStack(i_nStackPos).lFields(nPos).nLineSpacing,
                                     i_vcOpaque        =>lReportStack(i_nStackPos).lFields(nPos).vcOpaque,
                                     i_rStyle          =>FK_GET_STYLE(i_nStackPos, lReportStack(i_nStackPos).lFields(nPos).vcStyle),
                                     i_bMayPageBreak   =>    lReportStack(i_nStackPos).lFields(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES
                                                         AND nBandOffset>0,
                                     i_rArea           =>rArea,
                                     i_vcRotation      =>lReportStack(i_nStackPos).lFields(nPos).vcRotation
                                    );
            END IF;
            IF rArea.nPage>nPage THEN
              bPageBreaks:=TRUE;
            END IF;
          END IF;
        ELSE
          -- evaluate later
          PR_ADD_FIELD_FOR_LATER(i_nStackPos, rArea.nX, rArea.nY, lReportStack(i_nStackPos).lFields(nPos));
        END IF;
      END IF;
      -- return flag, if pagebreaks may have occured
      RETURN bPageBreaks;
    END;
    PROCEDURE PR_PROCESS_SUBREPORT(i_nMinY          IN NUMBER,
                                   i_nMaxY          IN NUMBER,
                                   i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
    BEGIN
      IF     lReportStack(i_nStackPos).lSubreports(nPos).nY BETWEEN i_nMinY AND i_nMaxY-1
         AND i_vcPositionType=PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP THEN
        -- Subreports, if allowed
        IF i_bAllowSubReports THEN
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Reportname is ' || vcReportName);
          END IF;
          -- Evaluate
          vcReportName:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>PK_JRXML2PDF_TYPES.NO_RECORD,
                                               i_vcExpression =>lReportStack(i_nStackPos).lSubreports(nPos).vcReportName,
                                               i_vcPattern    =>NULL
                                              );
          vcReportName:=REPLACE(vcReportName, '.jasper','');
          IF INSTR(vcReportName, '\', -1)>0 THEN
            vcReportName:=SUBSTR(vcReportName, INSTR(vcReportName, '\', -1)+1);
          END IF;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render subreport ' || vcReportName);
          END IF;
          rSubArea:=FK_RENDER_SUBREPORT(i_nX               =>rArea.nX + lReportStack(i_nStackPos).lSubreports(nPos).nX*nXFactor,
                                        i_nY               =>rArea.nY + lReportStack(i_nStackPos).lSubreports(nPos).nY*nYFactor,
                                        i_nWidth           =>lReportStack(i_nStackPos).lSubreports(nPos).nWidth*nXFactor,
                                        i_nHeight          =>lReportStack(i_nStackPos).lSubreports(nPos).nHeight*nYFactor,
                                        i_vcStyle          =>lReportStack(i_nStackPos).lSubreports(nPos).vcStyle,
                                        i_rArea            =>i_rArea,
                                        i_vcReportName     =>vcReportName,
                                        i_lParamList       =>FK_POPULATE_PARAMLIST(i_nStackPos, lReportStack(i_nStackPos).lSubreports(nPos).lParamList),
                                        i_nMasterRecord    =>lReportStack(i_nStackPos).rQuery.nRecordPosition,
                                        io_lReturnValues   =>lReportStack(i_nStackPos).lSubreports(nPos).lReturnValues
                                       );
          -- take over returnvalues into local variables
          PR_RETRIEVE_SUBREPORT_VARS(i_nStackPos, lReportStack(i_nStackPos).lSubreports(nPos).lReturnValues);
          IF    rSubArea.nY>rArea.nY
             OR rSubArea.nPage>rArea.nPage THEN
            rArea.nY:=rSubArea.nY;
            rArea.nPage:=rSubArea.nPage;
            bSubreports:=TRUE;
          END IF;
        END IF;
      END IF;
    END;
    PROCEDURE PR_CALCULATE_MBR IS
      nMinCheckX NUMBER;
      nMinCheckY NUMBER;
      nMaxCheckX NUMBER;
      nMaxCheckY NUMBER;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Calculating MBR');
      END IF;
      -- now check all objects
      FOR i IN 1..i_rBand.lObjects.COUNT LOOP
        nPos:=i_rBand.lObjects(i).nPosition;
        IF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.SUBFRAME THEN
          nMinCheckX:=lReportStack(i_nStackPos).lbands(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lbands(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lbands(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lbands(nPos).nHeight;
        ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.LINE THEN
          nMinCheckX:=lReportStack(i_nStackPos).lLines(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lLines(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lLines(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lLines(nPos).nHeight;
        ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.RECTANGLE THEN
          nMinCheckX:=lReportStack(i_nStackPos).lRectangles(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lRectangles(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lRectangles(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lRectangles(nPos).nHeight;
        ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.IMAGE THEN
          nMinCheckX:=lReportStack(i_nStackPos).lImages(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lImages(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lImages(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lImages(nPos).nHeight;
        ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.TEXT THEN
          nMinCheckX:=lReportStack(i_nStackPos).lTexts(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lTexts(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lTexts(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lTexts(nPos).nHeight;
        ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.FIELD THEN
          nMinCheckX:=lReportStack(i_nStackPos).lFields(nPos).nX;
          nMinCheckY:=lReportStack(i_nStackPos).lFields(nPos).nY;
          nMaxCheckX:=nMinCheckX+lReportStack(i_nStackPos).lFields(nPos).nWidth;
          nMaxCheckY:=nMinCheckY+lReportStack(i_nStackPos).lFields(nPos).nHeight;
        END IF;
        -- calculate bounds
        nMinX:=LEAST(nMinX, nMinCheckX);
        nMinY:=LEAST(nMinY, nMinCheckY);
        nMaxX:=GREATEST(nMaxX, nMaxCheckX);
        nMaxY:=GREATEST(nMaxY, nMaxCheckY);
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('MBR Min x/y Max x/y :' || nMinX || '/'|| nMinY || '/'|| nMaxX || '/' || nMinY);
      END IF;
    END;
    PROCEDURE PR_RENDER_BAND(i_vcPositionType IN PK_JRXML2PDF_TYPES.tPositionType) IS
      rMaxArea   PK_JRXML2PDF_TYPES.tArea;
      bAreaReset BOOLEAN:=FALSE;
      bStorePos  BOOLEAN:=FALSE;
    BEGIN
      rMaxArea:=rArea;
      nLastY:=-9999;
      FOR z IN 1..lYList.COUNT LOOP
        IF z>1 THEN
          -- Page break here
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Page break');
          END IF;
          PR_FINISH_PAGE_AND_START_NEW(io_rArea         =>rArea,
                                       i_nStackPos      =>i_nStackPos,
                                       i_bInnerToBottom =>TRUE
                                      );
        END IF;
        FOR i IN 1..i_rBand.lObjects.COUNT LOOP
          nPos:=i_rBand.lObjects(i).nPosition;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Render object no:' || nPos);
          END IF;
          IF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.SUBFRAME THEN
            -- store the current position of the page
            IF NOT bStorePos THEN
              bStorePos:=TRUE;
              PR_STORE_PAGE_POSITION(rArea);
            END IF;
            PR_PROCESS_SUBFRAME(nLastY, lYList(z), i_vcPositionType);
            IF rArea.nPage>rMaxArea.nPage THEN
              bSubreports:=TRUE;
              rMaxArea:=rArea;
              rArea:=FK_GOTO_LAST_STORED_POSITION;
              bAreaReset:=TRUE;
            END IF;
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.LINE THEN
            PR_PROCESS_LINE(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.RECTANGLE THEN
            PR_PROCESS_RECTANGLE(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.IMAGE THEN
            PR_PROCESS_IMAGE(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.TEXT THEN
            PR_PROCESS_TEXT(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.FIELD THEN
            -- if field may strecth, we have to keep the position
            IF lReportStack(i_nStackPos).lFields(nPos).vcStretch=PK_JRXML2PDF_TYPES.YES THEN
              -- store the current position of the page
              IF NOT bStorePos THEN
                bStorePos:=TRUE;
                PR_STORE_PAGE_POSITION(rArea);
              END IF;
            END IF;
            IF FK_PROCESS_FIELD(nLastY, lYList(z), i_vcPositionType) THEN
              -- treat pagebreak like a sub-report
              bSubreports:=TRUE;
              IF rArea.nPage>rMaxArea.nPage THEN
                rMaxArea:=rArea;
              ELSIF     rArea.nPage=rMaxArea.nPage
                    AND rArea.nY>rMaxArea.nY THEN
                rMaxArea.nY:=rArea.nY;
              END IF;
              rArea:=FK_GOTO_LAST_STORED_POSITION;
              bAreaReset:=TRUE;
            END IF;
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.SUBREPORT THEN
            -- store the current position of the page
            IF NOT bStorePos THEN
              bStorePos:=TRUE;
              PR_STORE_PAGE_POSITION(rArea);
            END IF;
            PR_PROCESS_SUBREPORT(nLastY, lYList(z), i_vcPositionType);
            IF rArea.nPage>rMaxArea.nPage THEN
              rMaxArea:=rArea;
            ELSIF     rArea.nPage=rMaxArea.nPage
                  AND rArea.nY>rMaxArea.nY THEN
              rMaxArea.nY:=rArea.nY;
            END IF;
            rArea:=FK_GOTO_LAST_STORED_POSITION;
            bAreaReset:=TRUE;
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.CROSSTAB THEN
            -- store the current position of the page
            IF NOT bStorePos THEN
              bStorePos:=TRUE;
              PR_STORE_PAGE_POSITION(rArea);
            END IF;
            PR_PROCESS_CROSSTAB(nLastY, lYList(z), i_vcPositionType);
            IF rArea.nPage>rMaxArea.nPage THEN
              rMaxArea:=rArea;
            ELSIF     rArea.nPage=rMaxArea.nPage
                  AND rArea.nY>rMaxArea.nY THEN
              rMaxArea.nY:=rArea.nY;
            END IF;
            rArea:=FK_GOTO_LAST_STORED_POSITION;
            bAreaReset:=TRUE;
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.MAP THEN
            PR_PROCESS_MAP(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.BARCHART THEN
            PR_PROCESS_BARCHART(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.PIECHART THEN
            PR_PROCESS_PIECHART(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.CATEGORYLINECHART THEN
            PR_PROCESS_CAT_LINECHART(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.XYLINECHART THEN
            PR_PROCESS_XY_LINECHART(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.TIMELINECHART THEN
            PR_PROCESS_TIME_LINECHART(nLastY, lYList(z), i_vcPositionType);
          ELSIF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.STACKEDAREACHART THEN
            PR_PROCESS_STACKEDAREACHART(nLastY, lYList(z), i_vcPositionType);
          END IF;
        END LOOP;
        IF bStorePos THEN
          PR_REMOVE_LAST_STORED_POSITION;
        END IF;
        nLastY:=lYList(z);
      END LOOP;
      IF bAreaReset THEN
        -- restore position
        rArea:=rMaxArea;
        PR_GOTO_STORED_POSITION(rArea);
      END IF;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Render band/ object count/Y-Before/Page-Before:' || TO_CHAR(i_rBand.lObjects.COUNT) || '/' ||
                                                                                        TO_CHAR(rArea.nY)               || '/' ||
                                                                                        TO_CHAR(rArea.nPage)
                                  );
    END IF;
    IF i_rBand.vcWhenExpression IS NOT NULL THEN
      bRender:=FK_EVALUATE_CONDITION(i_nStackPos   =>i_nStackPos,
                                     i_vcExpression=>i_rBand.vcWhenExpression
                                    );
    END IF;
    IF bRender THEN
      nBandHeight:=i_rBand.nHeight;
      IF i_rBand.bHasBreaks THEN
        -- build up multiple ranges of items
        FOR i IN 1..i_rBand.lObjects.COUNT LOOP
          IF i_rBand.lObjects(i).nType=PK_JRXML2PDF_TYPES.BREAK THEN
            lYList(lYList.COUNT+1):=lReportStack(i_nStackPos).lBreaks(i_rBand.lObjects(i).nPosition).nY;
          END IF;
        END LOOP;
        lYList(lYList.COUNT+1):=9999999;
      ELSE
        -- render all items
        lYList(1):=9999999;
      END IF;
      -- Check band-Height for Stretching
      PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                          i_rBand            =>i_rband,
                          i_bForceCalculate  =>TRUE,
                          o_nbandHeight      =>nBandHeight,
                          o_nBandOffset      =>nBandOffset
                         );
      -- amke sure its scaled up to the needed height
      IF     i_nNeededHeight IS NOT NULL
         AND nBandHeight+nBandOffset<i_nNeededHeight THEN
        nBandOffset:=i_nNeededHeight-nBandHeight;
        nBandHeight:=i_nNeededHeight;
      END IF;
      IF nBandOffset>0 THEN
        -- page may break, check height
        nMaxHeightForCurrentPage:=FK_REST_OF_PAGE(rArea.nY);
        IF nMaxHeightForCurrentPage<nBandHeight THEN
          -- no longer
          nBandOffset:=nBandOffset-(nBandHeight-nMaxHeightForCurrentPage);
          IF i_rband.nWidth IS NOT NULL THEN
            -- add frame to page-break-frames
            bPageFrame:=TRUE;
            rStyle:=FK_MAKE_STYLE_FROM_ATTRIBS(i_vcBgColor        =>i_rband.vcBGColor,
                                               i_vcFgColor        =>i_rband.vcFGColor,
                                               i_nBoxTop          =>i_rband.nBoxTop,
                                               i_nBoxLeft         =>i_rband.nBoxLeft,
                                               i_nBoxBottom       =>i_rband.nBoxBottom,
                                               i_nBoxRight        =>i_rband.nBoxRight,
                                               i_vcBoxTopColor    =>i_rband.vcBoxTopColor,
                                               i_vcBoxLeftColor   =>i_rband.vcBoxLeftColor,
                                               i_vcBoxBottomColor =>i_rband.vcBoxBottomColor,
                                               i_vcBoxRightColor  =>i_rband.vcBoxRightColor,
                                               i_vcOpaque         =>i_rBand.vcOpaque,
                                               i_rStyle           =>FK_GET_STYLE(i_nStackPos, i_rband.vcStyle)
                                              );
            -- add to stack
            PR_PUSH_PAGE_FRAME_MARKER(i_nStackPos   =>i_nStackpos,
                                      i_nBorderTop  =>i_rArea.nY,
                                      i_nBorderWidth=>i_rband.nWidth,
                                      i_rStyle      =>rStyle);
          END IF;
        ELSE
          nMaxHeightForCurrentPage:=nBandHeight;
        END IF;
      ELSE
        nMaxHeightForCurrentPage:=nBandHeight;
      END IF;
      IF i_vcContentAdjustment!=PK_JRXML2PDF_TYPES.NONE_ALIGN THEN
        -- adjustment of contentposition requested, calculate MBR of content
        PR_CALCULATE_MBR;
        IF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.RIGHT_ALIGN THEN
          -- set so that all x-values are adjusted and appear right-aligned
          rArea.nX:=rArea.nX+(i_rband.nWidth-nMaxX);
        ELSIF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.STRETCH_ALIGN THEN
          -- set up and X-factor which is afterwards applied to all objects
          IF     nMaxX>0
             AND i_rband.nWidth>nMaxX THEN
            nXFactor:=i_rband.nWidth/nMaxX;
          END IF;
        ELSIF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.STRETCH_Y_ALIGN THEN
          -- set up and Y-factor which is afterwards applied to all objects
          IF     nMaxY>0
             AND nBandHeight>nMaxY THEN
            nYFactor:=nBandHeight/nMaxY;
          END IF;
        ELSIF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.CENTER_ALIGN THEN
          -- set so that all x-values are adjusted and appear centered
          rArea.nX:=rArea.nX+(i_rband.nWidth-(nMaxX-nMinX))/2;
        ELSIF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.BOTTOM_ALIGN THEN
          -- set so that all y-values are adjusted to the bottom
          rArea.nY:=rArea.nY+i_rband.nHeight-(nMaxY+nBandOffset);
        ELSIF i_vcContentAdjustment=PK_JRXML2PDF_TYPES.MIDDLE_ALIGN THEN
          -- set so that all y-values are adjusted and appear centered
          rArea.nY:=rArea.nY+(GREATEST(i_rband.nHeight,nBandHeight)-(nMaxY-nMinY))/2;
        END IF;
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Start rendering band, height and offset=' || TO_CHAR(nBandHeight)  || '/' || TO_CHAR(nBandOffset));
      END IF;
      IF     i_nRenderFrame IN (PK_JRXML2PDF_TYPES.RENDER_FRAME_BEFORE, PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER)
         AND NOT bPageFrame THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Rendering box for band before band');
        END IF;
        PR_RENDER_BOX(i_nX              =>i_rArea.nX,
                      i_nY              =>i_rArea.nY,
                      i_nWidth          =>i_rband.nWidth,
                      i_nHeight         =>nMaxHeightForCurrentPage,
                      i_vcBgColor       =>i_rband.vcBGColor,
                      i_vcFgColor       =>i_rband.vcFGColor,
                      i_nBoxTop         =>i_rband.nBoxTop,
                      i_nBoxLeft        =>i_rband.nBoxLeft,
                      i_nBoxBottom      =>i_rband.nBoxBottom,
                      i_nBoxRight       =>i_rband.nBoxRight,
                      i_vcBoxTopColor   =>i_rband.vcBoxTopColor,
                      i_vcBoxLeftColor  =>i_rband.vcBoxLeftColor,
                      i_vcBoxBottomColor=>i_rband.vcBoxBottomColor,
                      i_vcBoxRightColor =>i_rband.vcBoxRightColor,
                      i_vcOpaque        =>i_rband.vcOpaque,
                      i_rStyle          =>FK_GET_STYLE(i_nStackPos, i_rband.vcStyle)
                     );
      END IF;
      IF NVL(i_rBand.bHasTopPos, TRUE) THEN
        -- Render everything with position Fix relative to top
        PR_RENDER_BAND(PK_JRXML2PDF_TYPES.RELATIVE_TO_TOP);
      END IF;
      IF i_rBand.bHasBottomPos THEN
        IF FK_FITS_IN_PAGE(rArea.nY, i_rBand.nHeight-NVL(i_rBand.nMaxPosTop,i_rBand.nHeight)) THEN
          IF NOT bSubReports THEN
            IF i_rBand.bHasTopPos THEN
              rArea.nY:=rArea.nY+NVL(nBandHeight,0)-i_rBand.nHeight-NVL(i_rBand.nMaxPosTop,i_rBand.nHeight)+NVL(i_rBand.nMinPosBottom,0);
            ELSE
              rArea.nY:=rArea.nY+NVL(nBandHeight,0)-i_rBand.nHeight+NVL(i_rBand.nMinPosBottom,0);
            END IF;
          ELSE
            -- relative adjustment
            rArea.nY:=rArea.nY-NVL(i_rBand.nMaxPosTop,i_rBand.nHeight);
            -- reset Bandheight to original value
            nBandHeight:=i_rBand.nHeight;
          END IF;
          -- Render fix relative to bottom
          PR_RENDER_BAND(PK_JRXML2PDF_TYPES.RELATIVE_TO_BOTTOM);
        ELSE
          PR_FINISH_PAGE_AND_START_NEW(io_rArea         =>rArea,
                                       i_nStackPos      =>i_nStackPos,
                                       i_bInnerToBottom =>TRUE
                                      );
          -- position up to skip gap between band-start and bottom-part
          rArea.nY:=rArea.nY-i_rBand.nMinPosBottom;
          -- Render fix relative to bottom
          PR_RENDER_BAND(PK_JRXML2PDF_TYPES.RELATIVE_TO_BOTTOM);
        END IF;
      END IF;
      IF     NOT NVL(i_rBand.bHasTopPos, TRUE)
         AND NOT i_rBand.bHasBottomPos
         AND i_rBand.bHasBreaks THEN
        -- a band with only a page break, do the page-break
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Page break only ');
        END IF;
        PR_FINISH_PAGE_AND_START_NEW(io_rArea         =>rArea,
                                     i_nStackPos      =>i_nStackPos,
                                     i_bInnerToBottom =>TRUE
                                    );
      END IF;
      IF     i_nRenderFrame=PK_JRXML2PDF_TYPES.RENDER_FRAME_AFTER
         AND NOT bPageFrame THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Rendering box for band after band');
        END IF;
        -- Rendering again, but only the lines, not the background color
        PR_RENDER_BOX(i_nX              =>i_rArea.nX,
                      i_nY              =>i_rArea.nY,
                      i_nWidth          =>i_rband.nWidth,
                      i_nHeight         =>nMaxHeightForCurrentPage,
                      i_vcBgColor       =>i_rband.vcBGColor,
                      i_vcFgColor       =>i_rband.vcFGColor,
                      i_nBoxTop         =>i_rband.nBoxTop,
                      i_nBoxLeft        =>i_rband.nBoxLeft,
                      i_nBoxBottom      =>i_rband.nBoxBottom,
                      i_nBoxRight       =>i_rband.nBoxRight,
                      i_vcBoxTopColor   =>i_rband.vcBoxTopColor,
                      i_vcBoxLeftColor  =>i_rband.vcBoxLeftColor,
                      i_vcBoxBottomColor=>i_rband.vcBoxBottomColor,
                      i_vcBoxRightColor =>i_rband.vcBoxRightColor,
                      i_vcOpaque        =>PK_JRXML2PDF_TYPES.NO,
                      i_rStyle          =>FK_GET_STYLE(i_nStackPos, i_rband.vcStyle)
                     );
      END IF;
      IF NOT bSubReports AND NOT i_rBand.bHasBreaks THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('No-subreport and no Breaks, added height ' || TO_CHAR(nBandHeight));
        END IF;
        IF i_rBand.bHasBottomPos THEN
          IF NOT bSubReports THEN
            IF i_rBand.bHasTopPos THEN
              rArea.nY:=rArea.nY
                        -NVL(nBandHeight,0)+i_rBand.nHeight+NVL(i_rBand.nMaxPosTop,i_rBand.nHeight)-NVL(i_rBand.nMinPosBottom,0)
                        +i_rBand.nHeight-NVL(i_rBand.nMaxPosTop,i_rBand.nHeight)
                        +GREATEST(NVL(nBandHeight,0),NVL(i_rBand.nHeight,0));
            ELSE
              rArea.nY:=rArea.nY
                        -NVL(nBandHeight,0)+i_rBand.nHeight-NVL(i_rBand.nMinPosBottom,0)
                        +GREATEST(NVL(nBandHeight,0),NVL(i_rBand.nHeight,0));
            END IF;
          ELSE
            -- relative adjustment
            rArea.nY:=rArea.nY+i_rBand.nMinPosBottom;
          END IF;
        ELSE
          rArea.nY:=rArea.nY+NVL(nBandHeight,0);
        END IF;
      ELSIF     bSubReports
            AND rArea.nPage=rOriginalArea.nPage
            AND rArea.nY<rOriginalArea.nY+NVL(nBandHeight,0) THEN
        rArea.nY:=rOriginalArea.nY+NVL(nBandHeight,0);
      ELSIF     bSubReports
            AND i_rBand.bHasBottomPos THEN
        rArea.nY:=rArea.nY+NVL(nBandHeight,0);
      END IF;
      IF bPageFrame THEN
        PR_APPLY_REPORT_STYLE(i_nStackPos=>i_nStackpos,
                              i_nX       =>rArea.nX,
                              i_nBottom  =>rArea.nY
                             );
        -- add to stack
        PR_POP_PAGE_FRAME_MARKER(i_nStackPos   =>i_nStackpos);
      END IF;
    END IF;
    -- set back x which may have been changed for adjustments
    rArea.nX:=i_rArea.nX;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Finished Y-After/Page-After:' || TO_CHAR(rArea.nY) || '/' ||
                                                                     TO_CHAR(rArea.nPage)
                                  );
    END IF;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RENDER_REGION(i_nStackPos         IN NUMBER,
                            i_rRegion           IN PK_JRXML2PDF_TYPES.tRegion,
                            i_rArea             IN PK_JRXML2PDF_TYPES.tArea,
                            i_bAllowSubReports  IN BOOLEAN
                           )
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    rArea PK_JRXML2PDF_TYPES.tArea:=i_rArea;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Render Region:' || i_rRegion.vcBaseNode);
    END IF;
    FOR i IN 1..i_rRegion.lObjects.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
        PK_JRXML2PDF_LOG.PR_LOG_FINE('Render Band:' || i);
      END IF;
      rArea:=FK_RENDER_BAND(i_nStackPos,
                            lReportStack(i_nStackPos).lBands(i_rRegion.lObjects(i).nPosition),
                            rArea,
                            i_bAllowSubReports,
                            PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE);
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('X/Y after rendering:' || rArea.nX || ' - ' || rArea.nY);
    END IF;
    RETURN rArea;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_REGION_HEIGHT(i_nStackPos IN NUMBER,
                                 i_rRegion   IN PK_JRXML2PDF_TYPES.tRegion)
  RETURN NUMBER IS
    nHeight     NUMBER:=0;
    nBandHeight NUMBER;
    nBandOffset NUMBER;
    rArea       PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    FOR i IN 1..i_rRegion.lObjects.COUNT LOOP
      PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                          i_rBand            =>lReportStack(i_nStackPos).lBands(i_rRegion.lObjects(i).nPosition),
                          o_nbandHeight      =>nBandHeight,
                          o_nBandOffset      =>nBandOffset
                         );
      nHeight:=nHeight+NVL(nBandHeight,0);
    END LOOP;
    IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
      PK_JRXML2PDF_LOG.PR_LOG_FINE('Calculate Region height Node/height:' || i_rRegion.vcBaseNode || '/' || TO_CHAR(nHeight));
    END IF;
    RETURN nHeight;
  END;
  FUNCTION FK_FETCH_ROW(i_nStackPos IN NUMBER)
  RETURN BOOLEAN IS
    clTemp CLOB;
    bReturn BOOLEAN:=TRUE;
    FUNCTION FK_FETCH
    RETURN PK_JRXML2PDF_TYPES.tDataEntries IS
      nRows   NUMBER;
      rResult PK_JRXML2PDF_TYPES.tDataEntries;
      rEntry  PK_JRXML2PDF_TYPES.tDataEntry;
    BEGIN
      nRows := DBMS_SQL.FETCH_ROWS(lReportStack(i_nStackPos).rQuery.iCursor);
      lReportStack(i_nStackPos).rQuery.bEOF:=(nRows=0);
      IF NOT lReportStack(i_nStackPos).rQuery.bEOF THEN
        lReportStack(i_nStackPos).rQuery.nRecordRead:=lReportStack(i_nStackPos).rQuery.nRecordRead+1;
      END IF;
      FOR i IN 1..lReportStack(i_nStackPos).rQuery.lDescTab.COUNT LOOP
        IF lReportStack(i_nStackPos).rQuery.lDescTab(i).col_type IN     (PK_JRXML2PDF_TYPES.DBMS_SQL_VARCHAR2_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_CHAR_TYPE
                                                                        ) THEN
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
          DBMS_SQL.COLUMN_VALUE(lReportStack(i_nStackPos).rQuery.iCursor, i, rEntry.vcdata);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('VARCHAR2-value for row / column : ' ||
                                                lReportStack(i_nStackPos).rQuery.nRecordRead ||'/' ||
                                                UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME) || ':' ||
                                                rEntry.vcdata);
          END IF;
        ELSIF lReportStack(i_nStackPos).rQuery.lDescTab(i).col_type =PK_JRXML2PDF_TYPES.DBMS_SQL_CLOB_TYPE THEN
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
          DBMS_SQL.COLUMN_VALUE(lReportStack(i_nStackPos).rQuery.iCursor, i, clTemp);
          rEntry.vcdata:=DBMS_LOB.SUBSTR(clTemp, 32767, 1);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('CLOB-value for row / column : ' ||
                                                lReportStack(i_nStackPos).rQuery.nRecordRead ||'/' ||
                                                UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME) || ':' ||
                                                rEntry.vcdata);
          END IF;
        ELSIF lReportStack(i_nStackPos).rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_NUMBER_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_FLOAT_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_BINARY_BOUBLE_TYPE
                                                                        ) THEN
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_NUMBER;
          DBMS_SQL.COLUMN_VALUE(lReportStack(i_nStackPos).rQuery.iCursor, i, rEntry.nData);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('NUMBER-value for row / column : ' ||
                                                lReportStack(i_nStackPos).rQuery.nRecordRead ||'/' ||
                                                UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME) || ':' ||
                                                rEntry.nData);
          END IF;
        ELSIF lReportStack(i_nStackPos).rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_DATE_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_TIMESTAMP_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_TSTMP_WITH_TZ_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_IV_YEAR_TO_MONTH_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_IV_DAY_TO_SECOND_TYPE,
                                                                         PK_JRXML2PDF_TYPES.DBMS_SQL_TS_WTH_LOCAL_TZ_TYPE
                                                                        ) THEN
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_DATE;
          DBMS_SQL.COLUMN_VALUE(lReportStack(i_nStackPos).rQuery.iCursor, i, rEntry.dtData);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DATE-value for row / column : ' ||
                                                lReportStack(i_nStackPos).rQuery.nRecordRead ||'/' ||
                                                UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME) || ':' ||
                                                rEntry.dtData);
          END IF;
        ELSIF lReportStack(i_nStackPos).rQuery.lDescTab(i).col_type IN  (PK_JRXML2PDF_TYPES.DBMS_SQL_BLOB_TYPE
                                                                        ) THEN
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_BLOB;
          DBMS_SQL.COLUMN_VALUE(lReportStack(i_nStackPos).rQuery.iCursor, i, rEntry.blData);
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('BLOB-value for row / column : ' ||
                                                lReportStack(i_nStackPos).rQuery.nRecordRead ||'/' ||
                                                UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME) || ':BLOB');
          END IF;
        ELSE
          rEntry.vcDatatype:=PK_JRXML2PDF_TYPES.DATATYPE_VARCHAR;
          rEntry.vcdata:='Unsupported datatype';
        END IF;
        rResult(UPPER(lReportStack(i_nStackPos).rQuery.lDescTab(i).COL_NAME)):=rEntry;
      END LOOP;
      RETURN rResult;
    END;
  BEGIN
    IF     NOT lReportStack(i_nStackPos).rQuery.bEOF
       AND lReportStack(i_nStackPos).rQuery.nCurrentRecord IS NULL THEN
      -- first record
      -- fetch current record
      lReportStack(i_nStackPos).rQuery.nCurrentRecord:=1;
      lReportStack(i_nStackPos).rQuery.lQueryResult(1):=FK_FETCH;
      IF NOT lReportStack(i_nStackPos).rQuery.bEOF THEN
        lReportStack(i_nStackPos).rQuery.nRecordPosition:=1;
        lReportStack(i_nStackPos).rQuery.nNextRecord:=2;
        lReportStack(i_nStackPos).rQuery.lQueryResult(2):=FK_FETCH;
        IF lReportStack(i_nStackPos).rQuery.bEOF THEN
          lReportStack(i_nStackPos).rQuery.nNextRecord:=NULL;
        END IF;
      ELSE
        lReportStack(i_nStackPos).rQuery.nCurrentRecord:=NULL;
        bReturn:=FALSE;
      END IF;
    ELSIF     lReportStack(i_nStackPos).rQuery.bEOF
          AND lReportStack(i_nStackPos).rQuery.nNextRecord IS NOT NULL THEN
      -- the next record is the last
      lReportStack(i_nStackPos).rQuery.nPreviousRecord:=lReportStack(i_nStackPos).rQuery.nCurrentRecord;
      lReportStack(i_nStackPos).rQuery.nCurrentRecord:=lReportStack(i_nStackPos).rQuery.nNextRecord;
      lReportStack(i_nStackPos).rQuery.nNextRecord:=NULL;
      lReportStack(i_nStackPos).rQuery.nRecordPosition:=lReportStack(i_nStackPos).rQuery.nRecordPosition+1;
    ELSIF     lReportStack(i_nStackPos).rQuery.bEOF THEN
      -- no more records
      bReturn:=FALSE;
    ELSE
      -- swap record and fetch next record
      lReportStack(i_nStackPos).rQuery.nPreviousRecord:=lReportStack(i_nStackPos).rQuery.nCurrentRecord;
      lReportStack(i_nStackPos).rQuery.nCurrentRecord:=lReportStack(i_nStackPos).rQuery.nNextRecord;
      IF lReportStack(i_nStackPos).rQuery.nNextRecord=1 THEN
        lReportStack(i_nStackPos).rQuery.nNextRecord:=2;
      ELSIF lReportStack(i_nStackPos).rQuery.nNextRecord=2 THEN
        lReportStack(i_nStackPos).rQuery.nNextRecord:=3;
      ELSIF lReportStack(i_nStackPos).rQuery.nNextRecord=3 THEN
        lReportStack(i_nStackPos).rQuery.nNextRecord:=1;
      END IF;
      lReportStack(i_nStackPos).rQuery.lQueryResult(lReportStack(i_nStackPos).rQuery.nNextRecord):=FK_FETCH;
      IF lReportStack(i_nStackPos).rQuery.bEOF THEN
        lReportStack(i_nStackPos).rQuery.nNextRecord:=NULL;
      END IF;
      lReportStack(i_nStackPos).rQuery.nRecordPosition:=lReportStack(i_nStackPos).rQuery.nRecordPosition+1;
    END IF;
    RETURN bReturn;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_PUSH_SUBREPORT_DATA(io_rReport IN OUT NOCOPY PK_JRXML2PDF_TYPES.tReport) IS
    iPos PLS_INTEGER:=lReportStack.COUNT+1;
  BEGIN
    lReportStack(iPos):=io_rReport;
    lReportStack(iPos).nPageHdrHeight:=FK_CALC_REGION_HEIGHT  (i_nStackPos=>iPos,
                                                               i_rRegion  =>io_rReport.rPageHeaderRegion);
    lReportStack(iPos).nColumnHdrHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>iPos,
                                                               i_rRegion  =>io_rReport.rColumnHeaderRegion);
    lReportStack(iPos).nColumnFtrHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>iPos,
                                                               i_rRegion  =>io_rReport.rColumnFooterRegion);
    lReportStack(iPos).nPageFtrHeight:=FK_CALC_REGION_HEIGHT  (i_nStackPos=>iPos,
                                                               i_rRegion  =>io_rReport.rPageFooterRegion);
    lReportStack(iPos).nSummaryHeight:=FK_CALC_REGION_HEIGHT  (i_nStackPos=>iPos,
                                                               i_rRegion  =>io_rReport.rSummaryRegion);
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_POP_SUBREPORT_DATA IS
    iPos PLS_INTEGER:=lReportStack.COUNT;
  BEGIN
    IF iPos>0 THEN
      -- Close Cursor
      DBMS_SQL.CLOSE_CURSOR(lReportStack(iPos).rQuery.iCursor);
      lReportStack.DELETE(iPos);
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_FINISH_PAGE(io_rArea                 IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                           i_nStackPos              IN NUMBER,
                           i_bInnerToBottom         IN BOOLEAN DEFAULT FALSE,
                           i_bBeforeSubReportHdr    IN BOOLEAN DEFAULT FALSE,
                           i_bBeforeSubReportColHdr IN BOOLEAN DEFAULT FALSE,
                           i_bResetPagenumber       IN BOOLEAN DEFAULT FALSE,
                           i_vcStyleToApply         IN PK_JRXML2PDF_TYPES.tStyleName DEFAULT NULL,
                           i_bOneRecordBack         IN BOOLEAN DEFAULT FALSE
                          ) IS
    nXSave     NUMBER;
    nMax       NUMBER;
    rDummyArea PK_JRXML2PDF_TYPES.tArea;
  BEGIN
    IF i_bOneRecordBack THEN
      lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent:=TRUE;
    END IF;
    IF i_nStackPos=1 THEN
      -- Main report
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Finish page for main report');
      END IF;
      -- finish page, but only if not already done
      IF NOT lReportStack(i_nStackPos).lEndOfPageDone.EXISTS(lReportStack(i_nStackPos).nCurrentPagePointer) THEN
        PR_APPLY_REPORT_STYLE(i_nStackPos     =>i_nStackPos,
                              i_nX            =>io_rArea.nX,
                              i_nBottom       =>io_rArea.nY
                             );
        IF lReportStack(i_nStackPos).vcFloatColumnFooter=PK_JRXML2PDF_TYPES.YES THEN
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render column footer (floating)');
          END IF;
          io_rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnFooterRegion, io_rArea, TRUE);
          -- psoition to bottom for page-footer
          io_rArea.nY:=rPageSetup.nPageHeight-
                       rPageSetup.nBottomMargin-
                       rPageSetup.nTopMargin-
                       lReportStack(i_nStackPos).nPageFtrHeight;
        ELSE
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render column footer (at bottom)');
          END IF;
          -- psoition to bottom for page-footer
          io_rArea.nY:=rPageSetup.nPageHeight-
                       rPageSetup.nBottomMargin-
                       rPageSetup.nTopMargin-
                       lReportStack(i_nStackPos).nColumnFtrHeight-
                       lReportStack(i_nStackPos).nPageFtrHeight;
          io_rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnFooterRegion, io_rArea, TRUE);
        END IF;
        IF NOT i_bBeforeSubReportHdr THEN
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render page footer');
          END IF;
          io_rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rPageFooterRegion, io_rArea, FALSE);
          lReportStack(i_nStackPos).lEndOfPageDone(lReportStack(i_nStackPos).nCurrentPagePointer):=1;
        END IF;
      END IF;
    ELSE
      nXSave:=io_rArea.nX;
      -- finish page, but only if not already done
      IF NOT lReportStack(i_nStackPos).lEndOfPageDone.EXISTS(lReportStack(i_nStackPos).nCurrentPagePointer) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Finish page for subreport ' || TO_CHAR(i_nStackPos));
        END IF;
        -- Render all column-Footer below, reverse order
        IF     NOT i_bInnerToBottom
           AND (   NOT i_bBeforeSubReportHdr
                OR NOT i_bBeforeSubReportColHdr
               ) THEN
          io_rArea.nX:=lReportStack(lReportStack.COUNT).nXPositionHdr;
          IF NOT i_bBeforeSubReportColHdr THEN
            io_rArea:=FK_RENDER_REGION(lReportStack.COUNT, lReportStack(lReportStack.COUNT).rColumnFooterRegion, io_rArea, TRUE);
          END IF;
          IF NOT i_bBeforeSubReportHdr THEN
            io_rArea:=FK_RENDER_REGION(lReportStack.COUNT, lReportStack(lReportStack.COUNT).rPageFooterRegion, io_rArea, TRUE);
          END IF;
          PR_APPLY_REPORT_STYLE(i_nStackPos     =>lReportStack.COUNT,
                                i_nX            =>io_rArea.nX,
                                i_nBottom       =>io_rArea.nY
                               );
          lReportStack(i_nStackPos).lEndOfPageDone(lReportStack(i_nStackPos).nCurrentPagePointer):=1;
        END IF;
      END IF;
      IF     i_bInnerToBottom
         AND (   NOT i_bBeforeSubReportHdr
              OR NOT i_bBeforeSubReportColHdr
             ) THEN
        nMax:=lReportStack.COUNT;
      ELSE
        nMax:=lReportStack.COUNT-1;
      END IF;
      io_rArea.nY:=rPageSetup.nPageHeight-
                   rPageSetup.nBottomMargin-
                   rPageSetup.nTopMargin;
      FOR j IN  REVERSE 1..nMax LOOP
        io_rArea.nY:=io_rArea.nY-lReportStack(j).nPageFtrHeight-
                                 lReportStack(j).nColumnFtrHeight;
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render all page footers and column footers, report count:' || lReportStack.COUNT);
      END IF;
      FOR j IN  REVERSE 1..nMax LOOP
        io_rArea.nX:=lReportStack(j).nXPositionHdr;
        -- finish page, but only if not already done
        IF NOT lReportStack(j).lEndOfPageDone.EXISTS(lReportStack(j).nCurrentPagePointer) THEN
          lReportStack(j).lEndOfPageDone(lReportStack(j).nCurrentPagePointer):=1;
          IF j=1 THEN
            PR_APPLY_REPORT_STYLE(i_nStackPos     =>j,
                                  i_nX            =>io_rArea.nX,
                                  i_nBottom       =>io_rArea.nY
                                 );
          END IF;
          io_rArea:=FK_RENDER_REGION(j, lReportStack(j).rColumnFooterRegion, io_rArea, TRUE);
          io_rArea:=FK_RENDER_REGION(j, lReportStack(j).rPageFooterRegion,   io_rArea, TRUE);
          IF j>1 THEN
            PR_APPLY_REPORT_STYLE(i_nStackPos     =>j,
                                  i_nX            =>io_rArea.nX,
                                  i_nBottom       =>io_rArea.nY
                                 );
          END IF;
        END IF;
      END LOOP;
      io_rArea.nX:=nXSave;
    END IF;
    -- Now render all fiels marked as Evaluate later type Group
    PR_RENDER_LATER_FIELDS(i_nStackPos        =>i_nStackPos,
                           i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_PAGE
                          );
    IF i_bOneRecordBack THEN
      lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent:=FALSE;
    END IF;
  END;
  PROCEDURE PR_START_NEW_PAGE(io_rArea                 IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                              i_nStackPos              IN NUMBER,
                              i_bInnerToBottom         IN BOOLEAN DEFAULT FALSE,
                              i_bBeforeSubReportHdr    IN BOOLEAN DEFAULT FALSE,
                              i_bBeforeSubReportColHdr IN BOOLEAN DEFAULT FALSE,
                              i_bResetPagenumber       IN BOOLEAN DEFAULT FALSE,
                              i_bRenderGroups          IN BOOLEAN DEFAULT TRUE,
                              i_bPageHeaders           IN BOOLEAN DEFAULT TRUE) IS
    nXSave        NUMBER;
    nMax          NUMBER;
    rDummyArea    PK_JRXML2PDF_TYPES.tArea;
    nDetailHeight NUMBER;
  BEGIN
    PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                      i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_PAGE,
                      i_bCalculate=>TRUE,
                      i_bReset    =>TRUE);
    IF i_nStackPos=1 THEN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Start new page for main report');
      END IF;
      PR_NEW_PAGE(i_bResetPageNumber);
      io_rArea.nX:=0;
      io_rArea.nY:=0;
      io_rArea.nPage:=io_rArea.nPage+1;
      IF NOT lReportStack(i_nStackPos).lStartOfPageDone.EXISTS(lReportStack(i_nStackPos).nCurrentPagePointer) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render background');
        END IF;
        -- Background for the page
        rDummyArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rBackgroundRegion, io_rArea, FALSE);
        IF i_bPageHeaders THEN
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render page header');
          END IF;
          io_rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rPageHeaderRegion, io_rArea,  FALSE);
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render column header');
          END IF;
          io_rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnHeaderRegion, io_rArea, TRUE);
        END IF;
        FOR z IN 1..lReportStack(1).lPageFrameMarkers.COUNT LOOP
          lReportStack(1).lPageFrameMarkers(z).nBorderTop:=io_rArea.nY;
        END LOOP;
        IF i_bRenderGroups THEN
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render group headers');
          END IF;
          -- Render all group-Headers above
          PR_RENDER_GROUP_HEADERS(i_nStackPos     =>i_nStackPos,
                                  io_rArea        =>io_rArea,
                                  i_bReprintOnly  =>TRUE,
                                  i_bIsOnNewPage  =>TRUE
                                 );
        END IF;
        -- Store Y-Position after header
        lReportStack(i_nStackPos).lStartOfPageDone(lReportStack(i_nStackPos).nCurrentPagePointer):=io_rArea.nY;
      ELSE
        io_rArea.nY:=lReportStack(i_nStackPos).lStartOfPageDone(lReportStack(i_nStackPos).nCurrentPagePointer);
      END IF;
    ELSE
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Start new page for subreport ' || TO_CHAR(i_nStackPos));
      END IF;
      nXSave:=io_rArea.nX;
      PR_NEW_PAGE(i_bResetPagenumber);
      io_rArea.nY:=0;
      io_rArea.nX:=0;
      io_rArea.nPage:=io_rArea.nPage+1;
      IF NOT lReportStack(1).lStartOfPageDone.EXISTS(lReportStack(1).nCurrentPagePointer) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render background');
        END IF;
        -- Background for the page, taken from main-report
        rDummyArea:=FK_RENDER_REGION(1, lReportStack(1).rBackgroundRegion, io_rArea, FALSE);
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render all page headers and column headers, report count:' || lReportStack.COUNT);
      END IF;
      -- Render all column-Headers above
      FOR j IN 1..lReportStack.COUNT LOOP
        io_rArea.nX:=lReportStack(j).nXPositionHdr;
        IF j=lReportStack.COUNT THEN
          FOR z IN 1..lReportStack(j).lPageFrameMarkers.COUNT LOOP
            lReportStack(j).lPageFrameMarkers(z).nBorderTop:=io_rArea.nY;
          END LOOP;
        END IF;
        IF    j<lReportStack.COUNT
           OR (    j=lReportStack.COUNT
               AND (   NOT i_bBeforeSubReportHdr
                    OR NOT i_bBeforeSubReportColHdr
                   )
              ) THEN
          IF NOT lReportStack(j).lStartOfPageDone.EXISTS(lReportStack(j).nCurrentPagePointer) THEN
            IF    i_bPageHeaders
               OR j<lReportStack.COUNT THEN
              IF    NOT i_bBeforeSubReportHdr
                 OR j<lReportStack.COUNT THEN
                -- In a subreport, headers may already do not fit
                nDetailHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>j,
                                                     i_rRegion   =>lReportStack(j).rPageHeaderRegion
                                                    );
                IF FK_FITS_IN_PAGE(io_rArea.nY,
                                   nDetailHeight
                                  ) THEN
                  io_rArea:=FK_RENDER_REGION(j, lReportStack(j).rPageHeaderRegion, io_rArea, TRUE);
                ELSE
                  -- new page
                  PR_FINISH_PAGE_AND_START_NEW(io_rArea       =>io_rArea,
                                               i_nStackPos    =>i_nStackPos,
                                               i_bRenderGroups=>FALSE);
                  -- stop
                END IF;
              END IF;
              IF    NOT i_bBeforeSubReportColHdr
                 OR j<lReportStack.COUNT THEN
                -- In a subreport, headers may already do not fit
                nDetailHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>j,
                                                     i_rRegion   =>lReportStack(j).rColumnHeaderRegion
                                                    );
                IF FK_FITS_IN_PAGE(io_rArea.nY,
                                   nDetailHeight
                                  ) THEN
                  io_rArea:=FK_RENDER_REGION(j, lReportStack(j).rColumnHeaderRegion, io_rArea, TRUE);
                ELSE
                  PR_FINISH_PAGE_AND_START_NEW(io_rArea       =>io_rArea,
                                               i_nStackPos    =>i_nStackPos,
                                               i_bRenderGroups=>FALSE);
                  -- stop
                END IF;
              END IF;
            END IF;
            IF i_bRenderGroups THEN
              -- Render all column-Headers above
              PR_RENDER_GROUP_HEADERS(i_nStackPos     =>j,
                                      io_rArea        =>io_rArea,
                                      i_bReprintOnly  =>TRUE,
                                      i_bIsOnNewPage  =>TRUE
                                     );
            END IF;
            lReportStack(j).lStartOfPageDone(lReportStack(j).nCurrentPagePointer):=io_rArea.nY;
          ELSE
            io_rArea.nY:=lReportStack(j).lStartOfPageDone(lReportStack(j).nCurrentPagePointer);
          END IF;
        END IF;
      END LOOP;
      io_rArea.nX:=nXSave;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_LATER_AND_INIT(i_nStartPos    IN PLS_INTEGER,
                                     i_nStackPos    IN NUMBER,
                                     i_bEndOfReport IN BOOLEAN) IS
  BEGIN
    FOR j IN i_nStartPos..lReportStack(i_nStackPos).lGroups.COUNT LOOP
      -- Now render all fiels marked as Evaluate later type Group
      PR_RENDER_LATER_FIELDS(i_nStackPos        =>i_nStackPos,
                             i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_GROUP,
                             i_vcEvaluationGroup=>lReportStack(i_nStackPos).lGroups(j).vcName
                            );
      IF NOT i_bEndOfReport THEN
        -- end of report, vars may be used in report-level vars
        PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                          i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_GROUP,
                          i_bCalculate=>FALSE,
                          i_bReset    =>TRUE,
                          i_vcGroup   =>lReportStack(i_nStackPos).lGroups(j).vcName);
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_GROUP_HEADERS(i_nStackPos     IN NUMBER,
                                    io_rArea        IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                                    i_bReprintOnly  IN BOOLEAN DEFAULT FALSE,
                                    i_bIsOnNewPage  IN BOOLEAN DEFAULT FALSE) IS
    vcText        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    bRenderGroup  BOOLEAN:=FALSE;
    nDetailheight NUMBER;
    nDummy        NUMBER;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render group-headers, group-count/ReprintOnly:' || lReportStack(i_nStackPos).lGroups.COUNT || '/' ||
                                                                                         CASE WHEN i_bReprintOnly THEN
                                                                                           PK_JRXML2PDF_TYPES.YES
                                                                                         ELSE
                                                                                           PK_JRXML2PDF_TYPES.NO
                                                                                         END);
    END IF;
    FOR i IN 1..lReportStack(i_nStackPos).lGroups.COUNT LOOP
      vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>i_nStackPos,
                                     i_vcExpression =>lReportStack(i_nStackPos).lGroups(i).vcExpression,
                                     i_vcPattern    =>NULL
                                    );
      bRenderGroup:=    i_bReprintOnly
                    AND lReportStack(i_nStackPos).lGroups(i).vcReprintHeader=PK_JRXML2PDF_TYPES.YES;
      IF NOT bRenderGroup THEN
        IF NVL(vcText,PK_JRXML2PDF_TYPES.NIL2)!=NVL(lReportStack(i_nStackPos).lGroupExpressions(i), PK_JRXML2PDF_TYPES.NIL) THEN
          -- group change, escalade down
          FOR j IN i+1..lReportStack(i_nStackPos).lGroupExpressions.COUNT LOOP
            lReportStack(i_nStackPos).lGroupExpressions(j):=NULL;
          END LOOP;
          -- store new value
          lReportStack(i_nStackPos).lGroupExpressions(i):=NVL(vcText,PK_JRXML2PDF_TYPES.NIL2);
          bRenderGroup:=TRUE;
        END IF;
      END IF;
      IF bRenderGroup THEN
        -- Eventually start on new page
        IF     NOT i_bIsOnNewPage
           AND (
                   (    lReportStack(i_nStackPos).rQuery.nPreviousRecord IS NOT NULL
                    AND lReportStack(i_nStackPos).lGroups(i).vcStartOnNewPage=PK_JRXML2PDF_TYPES.YES
                   )
                OR (    lReportStack(i_nStackPos).lGroups(i).nMinHeightForPage IS NOT NULL
                    AND NOT FK_FITS_IN_PAGE(io_rArea.nY, lReportStack(i_nStackPos).lGroups(i).nMinHeightForPage)
                   )
               ) THEN
          -- new page
          PR_FINISH_PAGE(io_rArea          =>io_rArea,
                         i_nStackPos       =>i_nStackPos,
                         i_bResetPageNumber=>lReportStack(i_nStackPos).lGroups(i).vcResetPageNumber=PK_JRXML2PDF_TYPES.YES,
                         i_bOneRecordBack  =>TRUE);
          -- special case group with start on new page
          IF lReportStack(i_nStackPos).lGroups(i).vcStartOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
            PR_RENDER_LATER_AND_INIT(i_nStartPos   =>i,
                                     i_nStackPos   =>i_nStackPos,
                                     i_bEndOfReport=>FALSE);
          END IF;
          -- new page
          PR_START_NEW_PAGE(io_rArea          =>io_rArea,
                            i_nStackPos       =>i_nStackPos,
                            i_bResetPageNumber=>lReportStack(i_nStackPos).lGroups(i).vcResetPageNumber=PK_JRXML2PDF_TYPES.YES,
                            i_bRenderGroups   =>TRUE);
          -- stop here, rest in done in the next recursion level
          -- only case we have something to do if we statrt the new page because of property "start on ny page"
          IF     lReportStack(i_nStackPos).rQuery.nPreviousRecord IS NOT NULL
             AND lReportStack(i_nStackPos).lGroups(i).vcStartOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
            IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
              PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group Header band because of "Start on new page"');
            END IF;
            -- Render group header
            FOR ii IN 1..lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects.COUNT LOOP
              PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                                  i_rBand            =>lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects(ii).nPosition),
                                  o_nbandHeight      =>nDetailHeight,
                                  o_nBandOffset      =>nDummy
                             );
              io_rArea:=FK_RENDER_BAND(i_nStackPos,
                                       lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects(ii).nPosition),
                                       io_rArea,
                                       TRUE,
                                       PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                      );
            END LOOP;
          END IF;
        ELSE
          -- Render group header
          FOR ii IN 1..lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects.COUNT LOOP
            PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                                i_rBand            =>lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects(ii).nPosition),
                                o_nbandHeight      =>nDetailHeight,
                                o_nBandOffset      =>nDummy
                           );
            -- Check if region fits on page
            IF FK_FITS_IN_PAGE(io_rArea.nY, nDetailHeight) THEN
              IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group Header band (same page)');
              END IF;
              io_rArea:=FK_RENDER_BAND(i_nStackPos,
                                       lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects(ii).nPosition),
                                       io_rArea,
                                       TRUE,
                                       PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                      );
            ELSE
              IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group Header band (new page)');
              END IF;
              PR_FINISH_PAGE_AND_START_NEW(io_rArea       =>io_rArea,
                                           i_nStackPos    =>i_nStackPos,
                                           i_bRenderGroups=>FALSE);
              io_rArea:=FK_RENDER_BAND(i_nStackPos,
                                       lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(i).rGroupHeader.lObjects(ii).nPosition),
                                       io_rArea,
                                       TRUE,
                                       PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                      );
            END IF;
          END LOOP;
        END IF;
      END IF;
    END LOOP;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_FINISH_PAGE_AND_START_NEW(io_rArea                 IN OUT NOCOPY PK_JRXML2PDF_TYPES.tArea,
                                         i_nStackPos              IN NUMBER,
                                         i_bInnerToBottom         IN BOOLEAN    DEFAULT FALSE,
                                         i_bBeforeSubReportHdr    IN BOOLEAN    DEFAULT FALSE,
                                         i_bBeforeSubReportColHdr IN BOOLEAN    DEFAULT FALSE,
                                         i_bResetPagenumber       IN BOOLEAN    DEFAULT FALSE,
                                         i_bOneRecordBack         IN BOOLEAN    DEFAULT FALSE,
                                         i_vcStyleToApply         IN PK_JRXML2PDF_TYPES.tStyleName DEFAULT NULL,
                                         i_bRenderGroups          IN BOOLEAN    DEFAULT TRUE,
                                         i_bPageHeaders           IN BOOLEAN    DEFAULT TRUE
                                         ) IS
  BEGIN
    IF i_bOneRecordBack THEN
      lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent:=TRUE;
    END IF;
    PR_FINISH_PAGE(io_rArea                =>io_rArea,
                   i_nStackPos             =>i_nStackPos,
                   i_bInnerToBottom        =>i_bInnerToBottom,
                   i_bBeforeSubReportHdr   =>i_bBeforeSubReportHdr,
                   i_bBeforeSubReportColHdr=>i_bBeforeSubReportColHdr,
                   i_bResetPagenumber      =>i_bResetPagenumber,
                   i_vcStyleToApply        =>i_vcStyleToApply
                  );
    IF i_bOneRecordBack THEN
      lReportStack(i_nStackPos).rQuery.bTreatLastAsCurrent:=FALSE;
    END IF;
    PR_START_NEW_PAGE(io_rArea                =>io_rArea,
                      i_nStackPos             =>i_nStackPos,
                      i_bInnerToBottom        =>i_bInnerToBottom,
                      i_bBeforeSubReportHdr   =>i_bBeforeSubReportHdr,
                      i_bBeforeSubReportColHdr=>i_bBeforeSubReportColHdr,
                      i_bResetPagenumber      =>i_bResetPagenumber,
                      i_bRenderGroups         =>i_bRenderGroups,
                      i_bPageHeaders          =>i_bPageHeaders
                     );
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RENDER_SUBREPORT(i_nX                IN NUMBER,
                               i_nY                IN NUMBER,
                               i_nWidth            IN NUMBER,
                               i_nHeight           IN NUMBER,
                               i_vcStyle           IN PK_JRXML2PDF_TYPES.tStyleName,
                               i_rArea             IN PK_JRXML2PDF_TYPES.tArea,
                               i_vcReportName      IN PK_JRXML2PDF_TYPES.tName,
                               i_lParamList        IN PK_JRXML2PDF_TYPES.tParamList,
                               i_nMasterRecord     IN NUMBER,
                               io_lReturnValues    IN OUT NOCOPY PK_JRXML2PDF_TYPES.tSubreportReturnvalueList
                               )
  RETURN PK_JRXML2PDF_TYPES.tArea IS
    rArea               PK_JRXML2PDF_TYPES.tArea:=i_rArea;
    nXSave              NUMBER;
    rReport             PK_JRXML2PDF_TYPES.tReport;
    nColumnFooterHeight NUMBER;
    nPageHeaderheight   NUMBER:=0;
    nPageFooterheight   NUMBER:=0;
    nDetailHeight       NUMBER;
    bSummaryAtEnd       BOOLEAN:=FALSE;
    nDummy              NUMBER;
    nStackPos           NUMBER;
    PROCEDURE PR_RENDER_GROUP_FOOTERS IS
      vcText PK_JRXML2PDF_TYPES.tMaxVarchar2;
      bBreak       BOOLEAN:=FALSE;
      bEndOfReport BOOLEAN:=FALSE;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport-group-footers, group-count:' || lReportStack(nStackPos).lGroups.COUNT);
      END IF;
      FOR i IN 1..lReportStack(nStackPos).lGroups.COUNT LOOP
        IF lReportStack(nStackPos).rQuery.bEOF AND
           lReportStack(nStackPos).rQuery.nNextRecord IS NULL THEN
          bBreak:=TRUE;
          bEndOfReport:=TRUE;
        ELSE
          vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>nStackPos,
                                         i_vcExpression =>lReportStack(nStackPos).lGroups(i).vcExpression,
                                         i_vcPattern    =>NULL,
                                         i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NEXT
                                        );
          IF NVL(vcText,PK_JRXML2PDF_TYPES.NIL2)!=NVL(lReportStack(nStackPos).lGroupExpressions(i), PK_JRXML2PDF_TYPES.NIL) THEN
            bBreak:=TRUE;
          END IF;
        END IF;
        IF bBreak THEN
          FOR j IN i..lReportStack(nStackPos).lGroups.COUNT LOOP
            PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                              i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_GROUP,
                              i_bCalculate=>TRUE,
                              i_bReset    =>FALSE,
                              i_vcGroup   =>lReportStack(nStackPos).lGroups(j).vcName);
          END LOOP;
          -- group change, render group footer up to current level
          FOR j IN REVERSE i..lReportStack(nStackPos).lGroupExpressions.COUNT LOOP
            -- Render group header
            FOR ii IN 1..lReportStack(nStackPos).lGroups(j).rGroupFooter.lObjects.COUNT LOOP
              PR_CALC_BAND_HEIGHT(i_nStackPos        =>nStackPos,
                                  i_rBand            =>lReportStack(nStackPos).lBands(lReportStack(nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                  o_nbandHeight      =>nDetailHeight,
                                  o_nBandOffset      =>nDummy
                             );
              -- Check if region fits on page
              IF FK_FITS_IN_PAGE(rArea.nY, nDetailHeight) THEN
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group footer band (same page)');
                END IF;
                rArea:=FK_RENDER_BAND(nStackPos,
                                      lReportStack(nStackPos).lBands(lReportStack(nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                      rArea,
                                      TRUE,
                                      PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                     );
              ELSE
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group footer band (new page)');
                END IF;
                PR_FINISH_PAGE_AND_START_NEW(io_rArea          =>rArea,
                                             i_nStackPos       =>nStackPos,
                                             i_vcStyleToApply  =>i_vcStyle,
                                             i_bRenderGroups   =>TRUE
                                            );
                rArea:=FK_RENDER_BAND(nStackPos,
                                      lReportStack(nStackPos).lBands(lReportStack(nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                      rArea,
                                      TRUE,
                                      PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                     );
              END IF;
            END LOOP;
          END LOOP;
          IF lReportStack(nStackPos).lGroups(i).vcStartOnNewPage!=PK_JRXML2PDF_TYPES.YES THEN
            PR_RENDER_LATER_AND_INIT(i_nStartPos   =>i,
                                     i_nStackPos   =>nStackPos,
                                     i_bEndOfReport=>bEndOfReport);
          END IF;
          -- exit
          EXIT;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_RENDER_SUBREPORT_BEGIN IS
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Calculate heights for regions');
      END IF;
      nColumnFooterHeight:=0;
      nPageHeaderheight:=0;
      nPageFooterheight:=0;
      FOR i IN 1..lReportStack.COUNT LOOP
        nColumnFooterHeight:=nColumnFooterHeight+lReportStack(i).nColumnFtrHeight;
        nPageHeaderheight  :=nPageHeaderheight  +lReportStack(i).nPageHdrHeight;
        nPageFooterheight  :=nPageFooterheight  +lReportStack(i).nPageFtrHeight;
      END LOOP;
      -- In a subreport, headers may already do not fit
      nDetailHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>nStackPos,
                                           i_rRegion   =>lReportStack(nStackPos).rTitleRegion
                                          );
      IF FK_FITS_IN_PAGE(rArea.nY,
                         nDetailHeight
                        ) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport title region (same page)');
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rTitleRegion, rArea, TRUE);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport title region (new page)');
        END IF;
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea                =>rArea,
                                     i_nStackPos             =>nStackPos,
                                     i_bBeforeSubReportHdr   =>TRUE,
                                     i_bBeforeSubReportColHdr=>TRUE,
                                     i_vcStyleToApply        =>i_vcStyle
                                    );
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rTitleRegion, rArea, TRUE);
      END IF;
      IF lReportStack(nStackPos).vcTitleOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea                =>rArea,
                                     i_nStackPos             =>nStackPos,
                                     i_bBeforeSubReportHdr   =>TRUE,
                                     i_bBeforeSubReportColHdr=>TRUE,
                                     i_vcStyleToApply        =>i_vcStyle
                                    );
      END IF;
      nDetailHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>nStackPos,
                                           i_rRegion  =>lReportStack(nStackPos).rPageHeaderRegion
                                          );
      IF FK_FITS_IN_PAGE(rArea.nY,
                         nDetailHeight
                        ) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport page header region (same page)');
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rPageHeaderRegion, rArea, TRUE);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport page header region (new page)');
        END IF;
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea                =>rArea,
                                     i_nStackPos             =>nStackPos,
                                     i_bBeforeSubReportHdr   =>TRUE,
                                     i_bBeforeSubReportColHdr=>TRUE,
                                     i_vcStyleToApply        =>i_vcStyle
                                    );
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rPageHeaderRegion, rArea, TRUE);
      END IF;
      nDetailHeight:=FK_CALC_REGION_HEIGHT(i_nStackPos=>nStackPos,
                                           i_rRegion  =>lReportStack(nStackPos).rColumnHeaderRegion
                                          );
      IF FK_FITS_IN_PAGE(rArea.nY,
                         nDetailHeight
                        ) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport column header region (same page)');
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rColumnHeaderRegion, rArea, TRUE);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport column header region (new page)');
        END IF;
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea                =>rArea,
                                     i_nStackPos             =>nStackPos,
                                     i_bBeforeSubReportHdr   =>FALSE,
                                     i_bBeforeSubReportColHdr=>TRUE,
                                     i_vcStyleToApply        =>i_vcStyle
                                    );
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rColumnHeaderRegion, rArea, TRUE);
      END IF;
    END;
    PROCEDURE PR_RENDER_RECORD IS
    BEGIN
      -- evaluate group-conditions and check changes
      PR_RENDER_GROUP_HEADERS(i_nStackPos    =>nStackPos,
                              io_rArea       =>rArea
                             );
      FOR ii IN 1..lReportStack(nStackPos).rDetailRegion.lObjects.COUNT LOOP
        PR_CALC_BAND_HEIGHT(i_nStackPos        =>nStackPos,
                            i_rBand            =>lReportStack(nStackPos).lBands(lReportStack(nStackPos).rDetailRegion.lObjects(ii).nPosition),
                            o_nbandHeight      =>nDetailHeight,
                            o_nBandOffset      =>nDummy
                       );
        -- Check if region fits on page
        IF FK_FITS_IN_PAGE(rArea.nY,
                           nDetailHeight
                          ) THEN
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport record (same page),record:' || lReportStack(nStackPos).rQuery.nRecordPosition);
          END IF;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('nY / detailHeight / ColFtrHeight / PageFtrHeight:' || TO_CHAR(rArea.nY) || '/' ||
                                                                                                    TO_CHAR(nDetailHeight) || '/' ||
                                                                                                    TO_CHAR(nColumnFooterHeight) || '/' ||
                                                                                                    TO_CHAR(nPageFooterheight)
                                            );
          END IF;
          PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                            i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_NONE,
                            i_bCalculate=>TRUE,
                            i_bReset    =>TRUE);
          rArea:=FK_RENDER_BAND(nStackPos,
                                lReportStack(nStackPos).lBands(lReportStack(nStackPos).rDetailRegion.lObjects(ii).nPosition),
                                rArea,
                                TRUE,
                                PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                               );
        ELSE
          IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
            PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport detail region (new page),record:' || lReportStack(nStackPos).rQuery.nRecordPosition);
          END IF;
          IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
            PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('nY / detailHeight / ColFtrHeight / PageFtrHeight:' || TO_CHAR(rArea.nY) || '/' ||
                                                                                                    TO_CHAR(nDetailHeight) || '/' ||
                                                                                                    TO_CHAR(nColumnFooterHeight) || '/' ||
                                                                                                    TO_CHAR(nPageFooterheight)
                                            );
          END IF;
          -- Finish page
          PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                       i_nStackPos     =>nStackPos,
                                       i_bOneRecordBack=>TRUE,
                                       i_vcStyleToApply=>i_vcStyle
                                       );
          PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                            i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_NONE,
                            i_bCalculate=>TRUE,
                            i_bReset    =>TRUE);
          rArea:=FK_RENDER_BAND(nStackPos,
                                lReportStack(nStackPos).lBands(lReportStack(nStackPos).rDetailRegion.lObjects(ii).nPosition),
                                rArea,
                                TRUE,
                                PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                               );
        END IF;
      END LOOP;
      -- evaluate group-conditions and check changes
      PR_RENDER_GROUP_FOOTERS;
      -- clear text-cache
      PK_JRXML2PDF_UTIL.PR_CLEAR_TEXT_CACHE;
    END;
    PROCEDURE PR_RENDER_SUBREPORT_END IS
      rSummaryRegion       PK_JRXML2PDF_TYPES.tRegion;
      nSummaryHeight       NUMBER;
      rColumnFooterRegion  PK_JRXML2PDF_TYPES.tRegion;
    BEGIN
      -- Regions are skipped in layout of table
      IF lReportStack(nStackPos).nTyp=PK_JRXML2PDF_TYPES.REPORT_TYP_TABLE THEN
        rSummaryRegion       :=lReportStack(nStackPos).rColumnFooterRegion;
        rColumnFooterRegion  :=lReportStack(nStackPos).rSummaryRegion;
      ELSE
        rSummaryRegion       :=lReportStack(nStackPos).rSummaryRegion;
        rColumnFooterRegion  :=lReportStack(nStackPos).rColumnFooterRegion;
      END IF;
      IF FK_FITS_IN_PAGE(rArea.nY,
                         lReportStack(nStackPos).nSummaryHeight
                        ) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport summary region (same page)');
        END IF;
        IF lReportStack(nStackPos).vcSummaryOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
          PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                       i_nStackPos     =>nStackPos,
                                       i_vcStyleToApply=>i_vcStyle,
                                       i_bPageHeaders  =>lReportStack(nStackPos).vcSummaryWithHdrFtr=PK_JRXML2PDF_TYPES.YES
                                      );
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, rSummaryRegion, rArea, TRUE);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport summary region (new page)');
        END IF;
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                     i_nStackPos     =>nStackPos,
                                     i_vcStyleToApply=>i_vcStyle,
                                     i_bPageHeaders  =>lReportStack(nStackPos).vcSummaryWithHdrFtr=PK_JRXML2PDF_TYPES.YES
                                    );
        rArea:=FK_RENDER_REGION(nStackPos, rSummaryRegion, rArea, TRUE);
        bSummaryAtEnd:=TRUE;
      END IF;
      IF    NOT bSummaryAtEnd
         OR lReportStack(nStackPos).nTyp=PK_JRXML2PDF_TYPES.REPORT_TYP_TABLE THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport column footer region');
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, rColumnFooterRegion, rArea, TRUE);
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport page footer region');
        END IF;
        rArea:=FK_RENDER_REGION(nStackPos, lReportStack(nStackPos).rPageFooterRegion, rArea, FALSE);
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render subreport later fields');
      END IF;
      IF lReportStack(nStackPos).lGroups.COUNT>0 THEN
        -- Now render all fiels marked as Evaluate later type Group
        PR_RENDER_LATER_FIELDS(i_nStackPos        =>nStackPos,
                               i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_GROUP,
                               i_vcEvaluationGroup=>lReportStack(nStackPos).lGroups(1).vcName
                              );
      END IF;
      -- Now render all fiels marked as Evaluate later type Page
      PR_RENDER_LATER_FIELDS(i_nStackPos        =>nStackPos,
                             i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_PAGE
                            );
      -- Now render all fiels marked as Evaluate later type Report
      PR_RENDER_LATER_FIELDS(i_nStackPos        =>nStackPos,
                             i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_REPORT
                            );
    END;
    PROCEDURE PR_ADJUST_COLUMNS(i_rRegion IN PK_JRXML2PDF_TYPES.tRegion) IS
      nAdjustWidth NUMBER:=0;
      nMaxWidth    NUMBER:=0;
      rband        PK_JRXML2PDF_TYPES.tBand;
    BEGIN
      FOR i IN 1..i_rRegion.lObjects.COUNT LOOP
        IF i_rRegion.lObjects(i).nType=PK_JRXML2PDF_TYPES.BAND THEN
          rBand:=lReportStack(nStackPos).lBands(i_rRegion.lObjects(i).nPosition);
          FOR j IN 1..rBand.lObjects.COUNT LOOP
            IF rBand.lObjects(j).nType=PK_JRXML2PDF_TYPES.SUBFRAME THEN
              lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nX:=lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nX-nAdjustWidth;
              IF lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).vcWhenExpression IS NOT NULL THEN
                -- evaluate expression for master-report
                IF NOT FK_EVALUATE_CONDITION(i_nStackPos    =>nStackPos-1,
                                             i_vcExpression =>lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).vcWhenExpression
                                            ) THEN
                  -- column is hidden, remember width to adjust following columns
                  nAdjustWidth:=nAdjustWidth+lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nWidth;
                ELSE
                  nMaxWidth:=GREATEST(nMaxWidth, lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nX+
                                                 lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nWidth
                                     );
                END IF;
              ELSE
                nMaxWidth:=GREATEST(nMaxWidth, lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nX+
                                               lReportStack(nStackPos).lBands(rBand.lObjects(j).nPosition).nWidth
                                   );
              END IF;
            END IF;
          END LOOP;
        END IF;
      END LOOP;
      FOR i IN 1..lReportStack(nStackPos).lPageFrameMarkers.COUNT LOOP
        lReportStack(nStackPos).lPageFrameMarkers(i).nBorderWidth:=GREATEST(lReportStack(nStackPos).lPageFrameMarkers(i).nBorderWidth, nMaxWidth);
      END LOOP;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Starting subreport:' || i_vcReportName);
    END IF;
    rReport:=FK_LOAD_REPORT(i_vcReportName, i_lParamList);
    rArea.nX:=i_nX+rReport.nLeftMargin;
    rArea.nY:=i_nY+rReport.nTopMargin;
    rReport.nXPositionHdr:=i_nX+rReport.nLeftMargin;
    PR_PUSH_SUBREPORT_DATA(rReport);
    nStackPos:=lReportStack.COUNT;
    PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                      i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_REPORT,
                      i_bCalculate=>TRUE,
                      i_bReset    =>TRUE);
    PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                      i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_PAGE,
                      i_bCalculate=>TRUE,
                      i_bReset    =>TRUE);
    -- Additionally reset all other vars to initialze the default-value
    FOR i IN 1..lReportStack(nStackPos).lGroups.COUNT LOOP
      PR_INIT_VARIABLES(i_nStackPos =>nStackPos,
                        i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_GROUP,
                        i_bCalculate=>FALSE,
                        i_bReset    =>TRUE,
                        i_vcGroup   =>lReportStack(nStackPos).lGroups(i).vcName);
    END LOOP;
    -- set a page-frame-marker if style to be applied is set
    IF i_vcStyle IS NOT NULL THEN
      -- mark the initial y-Position, in case a style has to be applied
      IF rReport.nTyp=PK_JRXML2PDF_TYPES.REPORT_TYP_TABLE THEN
        -- the width will be calculated in PR_ADJUST_COLUMNS
        PR_PUSH_PAGE_FRAME_MARKER(i_nStackPos   =>nStackPos,
                                  i_nBorderTop  =>rArea.nY,
                                  i_nBorderWidth=>0,
                                  i_rStyle      =>FK_GET_STYLE(i_nStackPos=>nStackPos,
                                                               i_vcStyle  =>i_vcStyle
                                                              )
                                 );
      ELSE
        -- width is the report's total width
        PR_PUSH_PAGE_FRAME_MARKER(i_nStackPos   =>nStackPos,
                                  i_nBorderTop  =>rArea.nY,
                                  i_nBorderWidth=>i_nWidth,
                                  i_rStyle      =>FK_GET_STYLE(i_nStackPos=>nStackPos,
                                                               i_vcStyle  =>i_vcStyle
                                                              )
                                 );
      END IF;
    END IF;
    IF FK_FETCH_ROW(nStackPos) THEN
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render subreport');
      END IF;
      IF lReportStack(nStackPos).nTyp=PK_JRXML2PDF_TYPES.REPORT_TYP_TABLE THEN
        -- check if there are any condiions on columns, and if so
        -- evaluate the conditions and adjust column-positions, if needed
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Subreport is table, check columns');
        END IF;
        PR_ADJUST_COLUMNS(lReportStack(nStackPos).rTitleRegion);
        PR_ADJUST_COLUMNS(lReportStack(nStackPos).rColumnHeaderRegion);
        PR_ADJUST_COLUMNS(lReportStack(nStackPos).rDetailRegion);
        PR_ADJUST_COLUMNS(lReportStack(nStackPos).rColumnFooterRegion);
        PR_ADJUST_COLUMNS(lReportStack(nStackPos).rSummaryRegion);
      END IF;
      PR_RENDER_SUBREPORT_BEGIN;
      LOOP
        PR_RENDER_RECORD;
        EXIT WHEN NOT FK_FETCH_ROW(nStackPos);
      END LOOP;
      PR_RENDER_SUBREPORT_END;
      -- finally apply subreport-style
      PR_APPLY_REPORT_STYLE(i_nStackPos     =>nStackPos,
                            i_nX            =>i_nX,
                            i_nBottom       =>rArea.nY
                           );
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('End of subreport record-count:' || lReportStack(nStackPos).rQuery.nRecordRead);
      END IF;
      -- Reset X-Value to Input-value
      rArea.nX:=i_rArea.nX;
      rArea.nY:=rArea.nY+lReportStack(nStackPos).nBottomMargin;
    END IF;
    PR_SET_SUBREPORT_VARS(nStackPos, io_lReturnValues);
    -- Take report from stack
    PR_POP_SUBREPORT_DATA;
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('End of subreport');
    END IF;
    RETURn rArea;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RENDER_REPORT(i_nStackPos            IN NUMBER,
                             i_bFinishPdf           IN BOOLEAN,
                             i_bKeepPageNosForLater IN BOOLEAN) IS
    rArea               PK_JRXML2PDF_TYPES.tArea;
    rDummyArea          PK_JRXML2PDF_TYPES.tArea;
    nColumnFooterHeight NUMBER;
    nPageHeaderheight   NUMBER;
    nPageFooterheight   NUMBER;
    nDetailHeight       NUMBER;
    nSummaryHeight      NUMBER;
    nDummy              NUMBER;
    PROCEDURE PR_RENDER_GROUP_FOOTERS IS
      vcText       PK_JRXML2PDF_TYPES.tMaxVarchar2;
      bBreak       BOOLEAN:=FALSE;
      bEndOfReport BOOLEAN:=FALSE;
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render group-footers, group-count:' || lReportStack(i_nStackPos).lGroups.COUNT);
      END IF;
      FOR i IN 1..lReportStack(i_nStackPos).lGroups.COUNT LOOP
        IF     lReportStack(i_nStackPos).rQuery.bEOF
           AND lReportStack(i_nStackPos).rQuery.nNextRecord IS NULL THEN
          bBreak:=TRUE;
          bEndOfReport:=TRUE;
        ELSE
          vcText:=FK_EVALUATE_EXPRESSION(i_nStackPos    =>i_nStackPos,
                                         i_vcExpression =>lReportStack(i_nStackPos).lGroups(i).vcExpression,
                                         i_vcPattern    =>NULL,
                                         i_nRecordOffset=>PK_JRXML2PDF_TYPES.OFFSET_NEXT
                                        );
          IF NVL(vcText,PK_JRXML2PDF_TYPES.NIL2)!=NVL(lReportStack(i_nStackPos).lGroupExpressions(i), PK_JRXML2PDF_TYPES.NIL) THEN
            bBreak:=TRUE;
          END IF;
        END IF;
        IF bBreak THEN
          FOR j IN i..lReportStack(i_nStackPos).lGroups.COUNT LOOP
            PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                              i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_GROUP,
                              i_bCalculate=>TRUE,
                              i_bReset    =>FALSE,
                              i_vcGroup   =>lReportStack(i_nStackPos).lGroups(j).vcName);
          END LOOP;
          -- group change, render group footer up to current level
          FOR j IN REVERSE i..lReportStack(i_nStackPos).lGroupExpressions.COUNT LOOP
            -- Render group header
            FOR ii IN 1..lReportStack(i_nStackPos).lGroups(j).rGroupFooter.lObjects.COUNT LOOP
              PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                                  i_rBand            =>lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                  o_nbandHeight      =>nDetailHeight,
                                  o_nBandOffset      =>nDummy
                             );
              -- Check if region fits on page
              IF FK_FITS_IN_PAGE(rArea.nY, nDetailHeight) THEN
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group footer band (same page)');
                END IF;
                rArea:=FK_RENDER_BAND(i_nStackPos,
                                      lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                      rArea,
                                      TRUE,
                                      PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                     );
              ELSE
                IF PK_JRXML2PDF_LOG.FK_IS_FINE THEN
                  PK_JRXML2PDF_LOG.PR_LOG_FINE('Render group footer band (new page)');
                END IF;
                PR_FINISH_PAGE_AND_START_NEW(io_rArea       =>rArea,
                                             i_nStackPos    =>i_nStackPos,
                                             i_bRenderGroups=>TRUE
                                            );
                rArea:=FK_RENDER_BAND(i_nStackPos,
                                      lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).lGroups(j).rGroupFooter.lObjects(ii).nPosition),
                                      rArea,
                                      TRUE,
                                      PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                                     );
              END IF;
            END LOOP;
          END LOOP;
          IF lReportStack(i_nStackPos).lGroups(i).vcStartOnNewPage!=PK_JRXML2PDF_TYPES.YES THEN
            PR_RENDER_LATER_AND_INIT(i_nStartPos   =>i,
                                     i_nStackPos   =>i_nStackPos,
                                     i_bEndOfReport=>bEndOfReport);
          END IF;
          -- exit
          EXIT;
        END IF;
      END LOOP;
    END;
    PROCEDURE PR_INITIALIZE IS
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Setup page width/height:' || TO_CHAR(lReportStack(i_nStackPos).nPageWidth) || '/' ||
                                                                        TO_CHAR(lReportStack(i_nStackPos).nPageHeight));
      END IF;
      PR_SETUP_PAGE(i_nWidth       =>lReportStack(i_nStackPos).nPageWidth,
                    i_nHeight      =>lReportStack(i_nStackPos).nPageHeight,
                    i_nLeftMargin  =>lReportStack(i_nStackPos).nLeftMargin,
                    i_nRightMargin =>lReportStack(i_nStackPos).nRightMargin,
                    i_nTopMargin   =>lReportStack(i_nStackPos).nTopMargin,
                    i_nBottomMargin=>lReportStack(i_nStackPos).nBottomMargin
                   );
      -- create a new page
      AS_PDF3_MOD.new_page;
      -- Initialize location-pointer
      rArea.nX:=0;
      lReportStack(i_nStackPos).nXPositionHdr:=0;
      rArea.nY:=0;
      IF i_bFinishPdf THEN
        rArea.nPage:=1;
      ELSE
        rArea.nPage:=lReportStack(i_nStackPos).nCurrentPagePointer;
      END IF;
      nPageHeaderheight  :=FK_CALC_REGION_HEIGHT(i_nStackPos, lReportStack(i_nStackPos).rPageHeaderRegion);
      nPageFooterheight  :=FK_CALC_REGION_HEIGHT(i_nStackPos, lReportStack(i_nStackPos).rPageFooterRegion);
      nSummaryheight     :=FK_CALC_REGION_HEIGHT(i_nStackPos, lReportStack(i_nStackPos).rSummaryRegion);
      nColumnFooterHeight:=lReportStack(i_nStackPos).nColumnFtrHeight;
    END;
    PROCEDURE PR_RENDER_REPORT_BEGIN IS
    BEGIN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render first background');
      END IF;
      -- Background for the page
      rDummyArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rBackgroundRegion, rArea, FALSE);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render title-region');
      END IF;
      rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rTitleRegion, rArea, TRUE);
      IF lReportStack(i_nStackPos).vcTitleOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
        -- Finish page
        PR_FINISH_PAGE_AND_START_NEW(io_rArea                =>rArea,
                                     i_nStackPos             =>i_nStackPos,
                                     i_bBeforeSubReportHdr   =>TRUE,
                                     i_bBeforeSubReportColHdr=>TRUE,
                                     i_bPageHeaders          =>FALSE
                                    );
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render first page header');
      END IF;
      rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rPageHeaderRegion, rArea, TRUE);
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render first column header');
      END IF;
      rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnHeaderRegion, rArea, TRUE);
    END;
    PROCEDURE PR_RENDER_REPORT_END IS
    BEGIN
      IF FK_FITS_IN_PAGE(rArea.nY, nSummaryHeight) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render summary on same page');
        END IF;
        IF lReportStack(i_nStackPos).vcSummaryOnNewPage=PK_JRXML2PDF_TYPES.YES THEN
          PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                       i_nStackPos     =>i_nStackPos,
                                       i_bPageHeaders  =>lReportStack(i_nStackPos).vcSummaryWithHdrFtr=PK_JRXML2PDF_TYPES.YES
                                      );
        END IF;
        rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rSummaryRegion, rArea, TRUE);
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render summary on new page');
        END IF;
        PR_FINISH_PAGE_AND_START_NEW(io_rArea   =>rArea,
                                     i_nStackPos=>i_nStackPos
                                    );
        rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rSummaryRegion, rArea, TRUE);
      END IF;
      IF lReportStack(i_nStackPos).vcFloatColumnFooter=PK_JRXML2PDF_TYPES.YES THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render last column footer (floating)');
        END IF;
        rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnFooterRegion, rArea, TRUE);
        rArea.nY:=rPageSetup.nPageHeight-
                  rPageSetup.nBottomMargin-
                  rPageSetup.nTopMargin-
                  nPageFooterheight;
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render last column footer (bottom)');
        END IF;
        rArea.nY:=rPageSetup.nPageHeight-
                  rPageSetup.nBottomMargin-
                  rPageSetup.nTopMargin-
                  lReportStack(i_nStackPos).nColumnFtrHeight-
                  nPageFooterheight;
        rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rColumnFooterRegion, rArea, TRUE);
      END IF;
      IF    (    lReportStack(i_nStackPos).vcSummaryOnNewPage=PK_JRXML2PDF_TYPES.YES
             AND lReportStack(i_nStackPos).vcSummaryWithHdrFtr=PK_JRXML2PDF_TYPES.YES
            )
         OR (lReportStack(i_nStackPos).vcSummaryOnNewPage=PK_JRXML2PDF_TYPES.NO) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render last page footer');
        END IF;
        rArea:=FK_RENDER_REGION(i_nStackPos, lReportStack(i_nStackPos).rPageFooterRegion, rArea, FALSE);
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Render later fields');
      END IF;
      -- evaluate later for last group
      IF lReportStack(i_nStackPos).lGroups.COUNT>0 THEN
        -- Now render all fiels marked as Evaluate later type Group
        PR_RENDER_LATER_FIELDS(i_nStackPos        =>i_nStackPos,
                               i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_GROUP,
                               i_vcEvaluationGroup=>lReportStack(i_nStackPos).lGroups(1).vcName
                              );
      END IF;
      -- Now render all fiels marked as Evaluate later type Page
      PR_RENDER_LATER_FIELDS(i_nStackPos        =>i_nStackPos,
                             i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_PAGE
                            );
      -- Now render all fiels marked as Evaluate later type Report
      PR_RENDER_LATER_FIELDS(i_nStackPos        =>i_nStackPos,
                             i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_REPORT,
                             i_bKeepPagenumber  =>i_bKeepPageNosForLater
                            );
    END;
    PROCEDURE PR_RENDER_RECORD IS
    BEGIN
      -- evaluate group-conditions and check changes
      PR_RENDER_GROUP_HEADERS(i_nStackPos=>i_nStackPos,
                              io_rArea   =>rArea
                             );
      -- Loop over all bands of the detail
      FOR ii IN 1..lReportStack(i_nStackPos).rDetailRegion.lObjects.COUNT LOOP
        PR_CALC_BAND_HEIGHT(i_nStackPos        =>i_nStackPos,
                            i_rBand            =>lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).rDetailRegion.lObjects(ii).nPosition),
                            o_nbandHeight      =>nDetailHeight,
                            o_nBandOffset      =>nDummy
                       );
        -- Check if region fits on page
        IF FK_FITS_IN_PAGE(rArea.nY, nDetailHeight) THEN
          PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                            i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_NONE,
                            i_bCalculate=>TRUE,
                            i_bReset    =>TRUE);
          IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
            PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render record on same page,record:' || lReportStack(i_nStackPos).rQuery.nRecordPosition);
          END IF;
          rArea:=FK_RENDER_BAND(i_nStackPos,
                                lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).rDetailRegion.lObjects(ii).nPosition),
                                rArea,
                                TRUE,
                                PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                               );
        ELSE
          -- skip to last record to have the correct data in the buffer
          IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
            PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render record on new page,record:' || lReportStack(i_nStackPos).rQuery.nRecordPosition);
          END IF;
          PR_FINISH_PAGE_AND_START_NEW(io_rArea        =>rArea,
                                       i_nStackPos     =>i_nStackPos,
                                       i_bOneRecordBack=>TRUE
                                      );
          PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                            i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_NONE,
                            i_bCalculate=>TRUE,
                            i_bReset    =>TRUE);
          rArea:=FK_RENDER_BAND(i_nStackPos,
                                lReportStack(i_nStackPos).lBands(lReportStack(i_nStackPos).rDetailRegion.lObjects(ii).nPosition),
                                rArea,
                                TRUE,
                                PK_JRXML2PDF_TYPES.RENDER_FRAME_NONE
                               );
        END IF;
      END LOOP;
      -- evaluate group-conditions and check changes
      PR_RENDER_GROUP_FOOTERS;
      -- clear text-cache
      PK_JRXML2PDF_UTIL.PR_CLEAR_TEXT_CACHE;
    END;
  BEGIN
    IF FK_FETCH_ROW(i_nStackPos) THEN
      -- There are records, start
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Initialize the report');
      END IF;
      PR_INITIALIZE;
      PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                        i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_REPORT,
                        i_bCalculate=>TRUE,
                        i_bReset    =>TRUE);
      PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                        i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_PAGE,
                        i_bCalculate=>TRUE,
                        i_bReset    =>TRUE);
      -- Additionally reset all other vars to initialze the default-value
      FOR i IN 1..lReportStack(i_nStackPos).lGroups.COUNT LOOP
        PR_INIT_VARIABLES(i_nStackPos =>i_nStackPos,
                          i_vcType    =>PK_JRXML2PDF_TYPES.VARTYPE_GROUP,
                          i_bCalculate=>FALSE,
                          i_bReset    =>TRUE,
                          i_vcGroup   =>lReportStack(i_nStackPos).lGroups(i).vcName);
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render begin of report');
      END IF;
      PR_RENDER_REPORT_BEGIN;
      IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
        PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Render records');
      END IF;
      LOOP
        PR_RENDER_RECORD;
        EXIT WHEN NOT FK_FETCH_ROW(i_nStackPos);
      END LOOP;
      IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Records rendered:' || lReportStack(i_nStackPos).rQuery.nRecordRead);
        PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Render end of report');
      END IF;
      PR_RENDER_REPORT_END;
      IF i_bFinishPdf THEN
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Finish pdf');
        END IF;
        PR_POP_SUBREPORT_DATA;
        PR_FINISH_PDF;
      ELSE
        IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
          PK_JRXML2PDF_LOG.PR_LOG_PROCESS('pdf not finished');
        END IF;
      END IF;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CLEAN_UP IS
  BEGIN
    rPageSetup:=NULL;
    lReportStack.DELETE;
    PK_JRXML2PDF_LOADER.PR_CLEAR_CACHE;
    lDatePattern.DELETE;
    PK_JRXML2PDF_UTIL.PR_CLEAR_TEXT_CACHE;
    rLastStyle:=NULL;
    rLastStyleName:=PK_JRXML2PDF_TYPES.NIL;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SAVE_TO_FILE(i_blData     IN BLOB,
                            i_vcDir      IN VARCHAR2,
                            i_vcFilename IN VARCHAR2) IS
    LEN   CONSTANT NUMBER:=32767;
    rFile UTL_FILE.FILE_TYPE;
  BEGIN
    rFile:= UTL_FILE.FOPEN(i_vcDir, i_vcFilename, 'wb');
    FOR i IN 0..TRUNC((DBMS_LOB.GETLENGTH(i_blData)-1)/LEN) LOOP
      UTL_FILE.PUT_RAW(rFile,
                       DBMS_LOB.SUBSTR(i_blData, LEN, i*LEN+1)
                      );
    END LOOP;
    UTL_FILE.FCLOSE(rFile);
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RESET_PAGE_SETUP IS
  BEGIN
    rPageSetup.nPageWidth   :=9999;
    rPageSetup.nPageHeight  :=9999;
    rPageSetup.nLeftMargin  :=0;
    rPageSetup.nRightMargin :=0;
    rPageSetup.nTopMargin   :=0;
    rPageSetup.nBottomMargin:=0;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_COPY_PARAMS(i_lParams       IN  tParamList,
                           o_lLocaleParams OUT PK_JRXML2PDF_TYPES.tParamList,
                           o_vcTitle       OUT PK_JRXML2PDF_TYPES.tMaxVarchar2,
                           o_vcAuthor      OUT PK_JRXML2PDF_TYPES.tMaxVarchar2,
                           o_vcSubject     OUT PK_JRXML2PDF_TYPES.tMaxVarchar2,
                           o_vcKeywords    OUT PK_JRXML2PDF_TYPES.tMaxVarchar2
                          ) IS
  BEGIN
    -- Convert parameterlist, take over PDF-parameters
    FOR i IN 1..i_lParams.COUNT LOOP
      o_lLocaleParams(i).vcName:=i_lParams(i).vcName;
      o_lLocaleParams(i).vcValue:=i_lParams(i).vcValue;
      -- extract PDF-parameters, if set
      IF o_lLocaleParams(i).vcName='$$TITLE$$' THEN
        o_vcTitle:=o_lLocaleParams(i).vcValue;
      ELSIF o_lLocaleParams(i).vcName='$$AUTHOR$$' THEN
        o_vcAuthor:=o_lLocaleParams(i).vcValue;
      ELSIF o_lLocaleParams(i).vcName='$$SUBJECT$$' THEN
        o_vcSubject:=o_lLocaleParams(i).vcValue;
      ELSIF o_lLocaleParams(i).vcName='$$KEYWORDS$$' THEN
        o_vcKeywords:=o_lLocaleParams(i).vcValue;
      END IF;
    END LOOP;
  EXCEPTION
     WHEN Others THEN
     print_error('No se encontraron registros, Favor Verificar');
  END;
  FUNCTION FK_RUN(i_vcName  IN VARCHAR2,
                  i_lParams IN tParamList)
  RETURN BLOB IS
    rReport       PK_JRXML2PDF_TYPES.tReport;
    lLocaleParams PK_JRXML2PDF_TYPES.tParamList;
    vcTitle       PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcAuthor      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcSubject     PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcKeywords    PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Initializing PK_JRXML_REPGEN-Version:' || VERSION_NUMBER);
    END IF;
    PR_CLEAN_UP;
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Initializing Standard-fonts');
    END IF;
    PR_COPY_PARAMS(i_lParams       =>i_lParams,
                   o_lLocaleParams =>lLocaleParams,
                   o_vcTitle       =>vcTitle,
                   o_vcAuthor      =>vcAuthor,
                   o_vcSubject     =>vcSubject,
                   o_vcKeywords    =>vcKeywords
                  );
    PK_JRXML2PDF_UTIL.PR_INIT_FONTS(lLocaleParams);
    -- initialize setup
    PR_RESET_PAGE_SETUP;
    blPDF:=NULL;
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Load report ' || i_vcName);
    END IF;
    -- Initialize the PDF
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('initialize pdf');
    END IF;
    PR_INIT_PDF(i_vcTitle   =>vcTitle,
                i_vcAuthor  =>vcAuthor,
                i_vcSubject =>vcSubject,
                i_vcKeywords=>vcKeywords
               );
    rReport:=FK_LOAD_REPORT(i_vcReportName =>i_vcName,
                            i_lParamList   =>lLocaleParams);
    -- Add to stack
    PR_PUSH_SUBREPORT_DATA(rReport);
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Render report');
    END IF;
    PR_RENDER_REPORT(i_nStackPos           =>1,
                     i_bFinishPdf          =>TRUE,
                     i_bKeepPageNosForLater=>FALSE);
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Clean-up');
    END IF;
    PR_CLEAN_UP;
    RETURN blPDF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RUN(i_vcName  IN VARCHAR2)
  RETURN BLOB IS
    lEmptyParams tParamList;
  BEGIN
    RETURN FK_RUN(i_vcName  =>i_vcName,
                  i_lParams =>lEmptyParams
                 );
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_RUN(i_lReports         IN PK_JRXML2PDF_TYPES.tReportNameList,
                  i_lParams          IN tParamList,
                  i_bResetPageNumber IN BOOLEAN)
  RETURN BLOB IS
    rReport         PK_JRXML2PDF_TYPES.tReport;
    lLocaleParams   PK_JRXML2PDF_TYPES.tParamList;
    vcTitle         PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcAuthor        PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcSubject       PK_JRXML2PDF_TYPES.tMaxVarchar2;
    vcKeywords      PK_JRXML2PDF_TYPES.tMaxVarchar2;
    nLastPage       NUMBER;
    lLastEvalfields PK_JRXML2PDF_TYPES.tFieldList;
    lLastEvalPageno PK_JRXML2PDF_TYPES.tNumList;
    lLastStyles     PK_JRXML2PDF_TYPES.tStyleList;
    rStyle          PK_JRXML2PDF_TYPES.tSimpleStyle;
    vcStyle         PK_JRXML2PDF_TYPES.tName;
    iLastEvalPos    PLS_INTEGER:=0;
    iPos            PLS_INTEGER;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Initializing PK_JRXML_REPGEN-Version:' || VERSION_NUMBER);
    END IF;
    PR_CLEAN_UP;
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Initializing Standard-fonts');
    END IF;
    PR_COPY_PARAMS(i_lParams       =>i_lParams,
                   o_lLocaleParams =>lLocaleParams,
                   o_vcTitle       =>vcTitle,
                   o_vcAuthor      =>vcAuthor,
                   o_vcSubject     =>vcSubject,
                   o_vcKeywords    =>vcKeywords
                  );
    PK_JRXML2PDF_UTIL.PR_INIT_FONTS(lLocaleParams);
    -- initialize setup
    PR_RESET_PAGE_SETUP;
    blPDF:=NULL;
    -- Initialize the PDF
    IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
      PK_JRXML2PDF_LOG.PR_LOG_DETAIL('initialize pdf');
    END IF;
    PR_INIT_PDF(i_vcTitle   =>vcTitle,
                i_vcAuthor  =>vcAuthor,
                i_vcSubject =>vcSubject,
                i_vcKeywords=>vcKeywords
               );
    FOR i IN 1..i_lReports.COUNT LOOP
      IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
        PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Load report ' || i_lReports(i));
      END IF;
      rReport:=FK_LOAD_REPORT(i_vcReportName =>i_lReports(i),
                              i_lParamList   =>lLocaleParams);
      IF     i>1 THEN
        rReport.nCurrentPagePointer:=nLastPage+1;
        -- fill pagenumber array with dummies
        FOR i IN 1..nLastPage LOOP
          rReport.lPageNumbers(i):=i;
          rReport.lLogicalPageNumbers(i):=i;
        END LOOP;
        rReport.lPageNumbers(rReport.nCurrentPagePointer):=rReport.nCurrentPagePointer;
        IF i_bResetPageNumber THEN
          rReport.lLogicalPageNumbers(rReport.nCurrentPagePointer):=1;
        ELSE
          rReport.lLogicalPageNumbers(rReport.nCurrentPagePointer):=nLastPage+1;
        END IF;
        -- take over outstanding evaluationfields
        rReport.lEvalLaterFields:=lLastEvalfields;
        rReport.lEvalLaterPageNo:=lLastEvalPageno;
        vcStyle:=lLastStyles.FIRST;
        WHILE vcStyle IS NOT NULL LOOP
          rReport.lStyles(vcStyle):=lLastStyles(vcStyle);
          vcStyle:=lLastStyles.NEXT(vcStyle);
        END LOOP;
      END IF;
      -- Add to stack
      PR_PUSH_SUBREPORT_DATA(rReport);
      IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
        PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Render report');
      END IF;
      PR_RENDER_REPORT(i_nStackPos           =>1,
                       i_bFinishPdf          =>FALSE,
                       i_bKeepPageNosForLater=>NOT i_bResetPageNumber);
      nLastPage:=lReportStack(1).nCurrentPagePointer;
      IF i=i_lReports.COUNT  THEN
        -- add the report-margins to the last added fields
        iPos:=lReportStack(1).lEvalLaterFields.NEXT(iLastEvalPos);
        WHILE iPos IS NOT NULL LOOP
          lReportStack(1).lEvalLaterFields(iPos).nX:= lReportStack(1).lEvalLaterFields(iPos).nX
                                                     +rPageSetup.nLeftMargin;
          lReportStack(1).lEvalLaterFields(iPos).nY:= lReportStack(1).lEvalLaterFields(iPos).nY
                                                     -rPageSetup.nPageHeight
                                                     +rPageSetup.nTopMargin;
          iPos:=lReportStack(1).lEvalLaterFields.NEXT(iPos);
        END LOOP;
        -- reset margins, for they are included in the x and y-coordinates
        rPageSetup.nLeftMargin:=0;
        rPageSetup.nPageHeight:=0;
        rPageSetup.nTopMargin:=0;
        -- Now render all fiels marked as Evaluate later type Report
        PR_RENDER_LATER_FIELDS(i_nStackPos        =>1,
                               i_vcEvaluationTime =>PK_JRXML2PDF_TYPES.EVALUATION_REPORT
                              );
      ELSE
        -- store outstanding evaluation fields and process them in next report
        lLastEvalfields:=lReportStack(1).lEvalLaterFields;
        lLastEvalPageno:=lReportStack(1).lEvalLaterPageNo;
        -- to keep the styles, take them from the current report, rename them and store them
        iPos:=lLastEvalfields.NEXT(iLastEvalPos);
        WHILE iPos IS NOT NULL LOOP
          IF lLastEvalfields(iPos).vcStyle IS NOT NULL THEN
            -- preserve style
            rStyle:=FK_GET_STYLE(1, lLastEvalfields(iPos).vcStyle);
            vcStyle:='$$' || TO_CHAR(i*10000) || TO_CHAR(iPos);
            lLastEvalfields(iPos).vcStyle:=vcStyle;
            lLastStyles(vcStyle).rStyle:=rStyle;
          END IF;
          -- takeover margin into absolute coordinates
          lLastEvalfields(iPos).nX:= lLastEvalfields(iPos).nX
                                    +rPageSetup.nLeftMargin;
          lLastEvalfields(iPos).nY:= lLastEvalfields(iPos).nY
                                    -rPageSetup.nPageHeight
                                    +rPageSetup.nTopMargin;
          iPos:=lLastEvalfields.NEXT(iPos);
        END LOOP;
        iLastEvalPos:=NVL(lReportStack(1).lEvalLaterFields.LAST,0);
      END IF;
      -- now, take report from stack
      PR_POP_SUBREPORT_DATA;
      -- cleanup
      IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
        PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Clean-up');
      END IF;
      PR_CLEAN_UP;
    END LOOP;
    -- now finish the pdf
    IF PK_JRXML2PDF_LOG.FK_IS_PROCESS THEN
      PK_JRXML2PDF_LOG.PR_LOG_PROCESS('Finish pdf');
    END IF;
    PR_FINISH_PDF;
    RETURN blPDF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RUN_TO_FILE(i_vcName     IN VARCHAR2,
                           i_lParams    IN tParamList,
                           i_vcDir      IN VARCHAR2,
                           i_vcFilename IN VARCHAR2) IS
    bl BLOB;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Start run');
    END IF;
    bl:=FK_RUN(i_vcName  =>i_vcName,
               i_lParams =>i_lParams
              );
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Save result to dir/file:' || i_vcDir || '/' || i_vcFilename);
    END IF;
    PR_SAVE_TO_FILE(i_blData     =>bl,
                    i_vcDir      =>i_vcDir,
                    i_vcFilename =>i_vcFilename
                   );
    DBMS_LOB.FREETEMPORARY(bl);
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Finish');
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_RUN_TO_FILE(i_lReports         IN PK_JRXML2PDF_TYPES.tReportNameList,
                           i_lParams          IN tParamList,
                           i_vcDir            IN VARCHAR2,
                           i_vcFilename       IN VARCHAR2,
                           i_bResetPageNumber IN BOOLEAN) IS
    bl BLOB;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Start run');
    END IF;
    bl:=FK_RUN(i_lReports        =>i_lReports,
               i_lParams         =>i_lParams,
               i_bResetPageNumber=>i_bResetPageNumber
              );
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Save result to dir/file:' || i_vcDir || '/' || i_vcFilename);
    END IF;
    PR_SAVE_TO_FILE(i_blData     =>bl,
                    i_vcDir      =>i_vcDir,
                    i_vcFilename =>i_vcFilename
                   );
    DBMS_LOB.FREETEMPORARY(bl);
    IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
      PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Finish');
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SHOW_REPORT(io_blReport            IN OUT BLOB,
                           i_vcContentDisposition IN VARCHAR2 DEFAULT 'inline',
                           i_vcFilename           IN VARCHAR2 DEFAULT 'reportresult.pdf') IS
     l_mime        VARCHAR2 (255);
     l_length      NUMBER;
     l_file_name   VARCHAR2 (2000);
     lob_loc       BLOB;
  BEGIN
     OWA_UTIL.mime_header ('application/pdf', FALSE);
     HTP.p ('Content-Length: ' || DBMS_LOB.GETLENGTH(io_blReport));
     HTP.p ('Content-Disposition: ' || i_vcContentDisposition ||'; filename="' || i_vcFilename || '"');
     OWA_UTIL.http_header_close;
     WPG_DOCLOAD.download_file(io_blReport);
     EXCEPTION
       WHEN Others THEN
       print_error('No se encontraron registros, Favor Verificar');
  END;
  -- ---------------------------------------------------------------------------
BEGIN
  -- Setup Tokens
  PR_ADD_TOKEN('"', '"');
  PR_ADD_TOKEN('+');
  PR_ADD_TOKEN('!','');
  PR_ADD_TOKEN('$F{', '}');
  PR_ADD_TOKEN('$V{', '}');
  PR_ADD_TOKEN('$P{', '}');
  PR_ADD_TOKEN('$R{', '}');
  PR_ADD_TOKEN('-');
  PR_ADD_TOKEN('==');
  PR_ADD_TOKEN('!=');
  PR_ADD_TOKEN('<');
  PR_ADD_TOKEN('<=');
  PR_ADD_TOKEN('>');
  PR_ADD_TOKEN('>=');
  PR_ADD_TOKEN('==null');
  PR_ADD_TOKEN('!=null');
  PR_ADD_TOKEN('||');
  PR_ADD_TOKEN('&&');
  PR_ADD_TOKEN('jrxml2pdf.Wrappers.mod');
  PR_ADD_TOKEN('new java.util.Date()', '');
  PR_ADD_TOKEN('.startsWith(', ')');
  lHtmlTokens(1).vcTag:=PK_JRXML2PDF_TYPES.HTML_H1;
  lHtmlTokens(1).bHasEndTag:=TRUE;
  lHtmlTokens(1).bHasAttribs:=FALSE;
  lHtmlTokens(2).vcTag:=PK_JRXML2PDF_TYPES.HTML_H2;
  lHtmlTokens(2).bHasEndTag:=TRUE;
  lHtmlTokens(2).bHasAttribs:=FALSE;
  lHtmlTokens(3).vcTag:=PK_JRXML2PDF_TYPES.HTML_H3;
  lHtmlTokens(3).bHasEndTag:=TRUE;
  lHtmlTokens(3).bHasAttribs:=FALSE;
  lHtmlTokens(4).vcTag:=PK_JRXML2PDF_TYPES.HTML_H4;
  lHtmlTokens(4).bHasEndTag:=TRUE;
  lHtmlTokens(4).bHasAttribs:=FALSE;
  lHtmlTokens(5).vcTag:=PK_JRXML2PDF_TYPES.HTML_PRE;
  lHtmlTokens(5).bHasEndTag:=TRUE;
  lHtmlTokens(5).bHasAttribs:=FALSE;
  lHtmlTokens(6).vcTag:=PK_JRXML2PDF_TYPES.HTML_UL;
  lHtmlTokens(6).bHasEndTag:=TRUE;
  lHtmlTokens(6).bHasAttribs:=FALSE;
  lHtmlTokens(7).vcTag:=PK_JRXML2PDF_TYPES.HTML_OL;
  lHtmlTokens(7).bHasEndTag:=TRUE;
  lHtmlTokens(7).bHasAttribs:=FALSE;
  lHtmlTokens(8).vcTag:=PK_JRXML2PDF_TYPES.HTML_LI;
  lHtmlTokens(8).bHasEndTag:=TRUE;
  lHtmlTokens(8).bHasAttribs:=FALSE;
  lHtmlTokens(9).vcTag:='span';
  lHtmlTokens(9).bHasEndTag:=TRUE;
  lHtmlTokens(9).bHasAttribs:=TRUE;
  lHtmlTokens(10).vcTag:=PK_JRXML2PDF_TYPES.HTML_P;
  lHtmlTokens(10).bHasEndTag:=TRUE;
  lHtmlTokens(10).bHasAttribs:=FALSE;
  lHtmlTokens(11).vcTag:=PK_JRXML2PDF_TYPES.HTML_BR;
  lHtmlTokens(11).bHasEndTag:=FALSE;
  lHtmlTokens(11).bHasAttribs:=FALSE;
  lHtmlTokens(12).vcTag:=PK_JRXML2PDF_TYPES.HTML_B;
  lHtmlTokens(12).bHasEndTag:=FALSE;
  lHtmlTokens(12).bHasAttribs:=FALSE;
  lHtmlTokens(13).vcTag:=PK_JRXML2PDF_TYPES.HTML_STRONG;
  lHtmlTokens(13).bHasEndTag:=FALSE;
  lHtmlTokens(13).bHasAttribs:=FALSE;
  -- Defaults for HTML
  rMasterHtmlSettings.vcFont            :=PK_JRXML2PDF_TYPES.ARIAL;
  rMasterHtmlSettings.nFontSize         :=12;
  rMasterHtmlSettings.nH1FontSize       :=24;
  rMasterHtmlSettings.nH2FontSize       :=18;
  rMasterHtmlSettings.nH3FontSize       :=14;
  rMasterHtmlSettings.nH4FontSize       :=12;
  rMasterHtmlSettings.nXXlargeFontSize  :=30;
  rMasterHtmlSettings.nXlargeFontSize   :=22;
  rMasterHtmlSettings.nLargeFontSize    :=17;
  rMasterHtmlSettings.nMediumFontSize   :=14;
  rMasterHtmlSettings.nSmallFontSize    :=12;
  rMasterHtmlSettings.nXsmallFontSize   :=10;
  rMasterHtmlSettings.nXXsmallFontSize  :=7;
  rMasterHtmlSettings.nLargerFontSize   :=12;
  rMasterHtmlSettings.nSmallerFontSize  :=10;
  rMasterHtmlSettings.nListIndent :=40;
  rMasterHtmlSettings.vcUlChar    :=CHR(108);
  rMasterHtmlSettings.nH1LineSpacing:=18;
  rMasterHtmlSettings.nH2LineSpacing:=16;
  rMasterHtmlSettings.nH3LineSpacing:=14;
  rMasterHtmlSettings.nH4LineSpacing:=12;
  rMasterHtmlSettings.nLiLineSpacing:=1;
  rMasterHtmlSettings.nBrLineSpacing:=12;
  rMasterHtmlSettings.nLineSpacing:=3;
  PR_ADD_HTML_REPLACEMENT('&quot;', UNISTR('\0022'));
  PR_ADD_HTML_REPLACEMENT('&Aacute;', UNISTR('\00C1'));
  PR_ADD_HTML_REPLACEMENT('&aacute;', UNISTR('\00E1'));
  PR_ADD_HTML_REPLACEMENT('&Acirc;', UNISTR('\00C2'));
  PR_ADD_HTML_REPLACEMENT('&acirc;', UNISTR('\00E2'));
  PR_ADD_HTML_REPLACEMENT('&acute;', UNISTR('\00B4'));
  PR_ADD_HTML_REPLACEMENT('&AElig;', UNISTR('\00C6'));
  PR_ADD_HTML_REPLACEMENT('&aelig;', UNISTR('\00E6'));
  PR_ADD_HTML_REPLACEMENT('&Agrave;', UNISTR('\00C0'));
  PR_ADD_HTML_REPLACEMENT('&agrave;', UNISTR('\00E0'));
  PR_ADD_HTML_REPLACEMENT('&Alpha;', UNISTR('\0391'));
  PR_ADD_HTML_REPLACEMENT('&alpha;', UNISTR('\03B1'));
  PR_ADD_HTML_REPLACEMENT('&amp;', UNISTR('\0026'));
  PR_ADD_HTML_REPLACEMENT('&and;', UNISTR('\2227'));
  PR_ADD_HTML_REPLACEMENT('&ang;', UNISTR('\2220'));
  PR_ADD_HTML_REPLACEMENT('&Aring;', UNISTR('\00C5'));
  PR_ADD_HTML_REPLACEMENT('&aring;', UNISTR('\00E5'));
  PR_ADD_HTML_REPLACEMENT('&asymp;', UNISTR('\2248'));
  PR_ADD_HTML_REPLACEMENT('&Atilde;', UNISTR('\00C3'));
  PR_ADD_HTML_REPLACEMENT('&atilde;', UNISTR('\00E3'));
  PR_ADD_HTML_REPLACEMENT('&Auml;', UNISTR('\00C4'));
  PR_ADD_HTML_REPLACEMENT('&auml;', UNISTR('\00E4'));
  PR_ADD_HTML_REPLACEMENT('&Beta;', UNISTR('\0392'));
  PR_ADD_HTML_REPLACEMENT('&beta;', UNISTR('\03B2'));
  PR_ADD_HTML_REPLACEMENT('&brvbar;', UNISTR('\00A6'));
  PR_ADD_HTML_REPLACEMENT('&cap;', UNISTR('\2229'));
  PR_ADD_HTML_REPLACEMENT('&Ccedil;', UNISTR('\00C7'));
  PR_ADD_HTML_REPLACEMENT('&ccedil;', UNISTR('\00E7'));
  PR_ADD_HTML_REPLACEMENT('&cedil;', UNISTR('\00B8'));
  PR_ADD_HTML_REPLACEMENT('&cent;', UNISTR('\00A2'));
  PR_ADD_HTML_REPLACEMENT('&Chi;', UNISTR('\03A7'));
  PR_ADD_HTML_REPLACEMENT('&chi;', UNISTR('\03C7'));
  PR_ADD_HTML_REPLACEMENT('&cong;', UNISTR('\2245'));
  PR_ADD_HTML_REPLACEMENT('&copy;', UNISTR('\00A9'));
  PR_ADD_HTML_REPLACEMENT('&cup;', UNISTR('\222A'));
  PR_ADD_HTML_REPLACEMENT('&curren;', UNISTR('\00A4'));
  PR_ADD_HTML_REPLACEMENT('&deg;', UNISTR('\00B0'));
  PR_ADD_HTML_REPLACEMENT('&Delta;', UNISTR('\0394'));
  PR_ADD_HTML_REPLACEMENT('&delta;', UNISTR('\03B4'));
  PR_ADD_HTML_REPLACEMENT('&divide;', UNISTR('\00F7'));
  PR_ADD_HTML_REPLACEMENT('&Eacute;', UNISTR('\00C9'));
  PR_ADD_HTML_REPLACEMENT('&eacute;', UNISTR('\00E9'));
  PR_ADD_HTML_REPLACEMENT('&Ecirc;', UNISTR('\00CA'));
  PR_ADD_HTML_REPLACEMENT('&ecirc;', UNISTR('\00EA'));
  PR_ADD_HTML_REPLACEMENT('&Egrave;', UNISTR('\00C8'));
  PR_ADD_HTML_REPLACEMENT('&egrave;', UNISTR('\00E8'));
  PR_ADD_HTML_REPLACEMENT('&empty;', UNISTR('\2205'));
  PR_ADD_HTML_REPLACEMENT('&Epsilon;', UNISTR('\0395'));
  PR_ADD_HTML_REPLACEMENT('&epsilon;', UNISTR('\03B5'));
  PR_ADD_HTML_REPLACEMENT('&equiv;', UNISTR('\2261'));
  PR_ADD_HTML_REPLACEMENT('&Eta;', UNISTR('\0397'));
  PR_ADD_HTML_REPLACEMENT('&eta;', UNISTR('\03B7'));
  PR_ADD_HTML_REPLACEMENT('&ETH;', UNISTR('\00D0'));
  PR_ADD_HTML_REPLACEMENT('&eth;', UNISTR('\00F0'));
  PR_ADD_HTML_REPLACEMENT('&Euml;', UNISTR('\00CB'));
  PR_ADD_HTML_REPLACEMENT('&euml;', UNISTR('\00EB'));
  PR_ADD_HTML_REPLACEMENT('&exist;', UNISTR('\2203'));
  PR_ADD_HTML_REPLACEMENT('&forall;', UNISTR('\2200'));
  PR_ADD_HTML_REPLACEMENT('&frac12;', UNISTR('\00BD'));
  PR_ADD_HTML_REPLACEMENT('&frac14;', UNISTR('\00BC'));
  PR_ADD_HTML_REPLACEMENT('&frac34;', UNISTR('\00BE'));
  PR_ADD_HTML_REPLACEMENT('&Gamma;', UNISTR('\0393'));
  PR_ADD_HTML_REPLACEMENT('&gamma;', UNISTR('\03B3'));
  PR_ADD_HTML_REPLACEMENT('&ge;', UNISTR('\2265'));
  PR_ADD_HTML_REPLACEMENT('&gt;', UNISTR('\003E'));
  PR_ADD_HTML_REPLACEMENT('&Iacute;', UNISTR('\00CD'));
  PR_ADD_HTML_REPLACEMENT('&iacute;', UNISTR('\00ED'));
  PR_ADD_HTML_REPLACEMENT('&Icirc;', UNISTR('\00CE'));
  PR_ADD_HTML_REPLACEMENT('&icirc;', UNISTR('\00EE'));
  PR_ADD_HTML_REPLACEMENT('&iexcl;', UNISTR('\00A1'));
  PR_ADD_HTML_REPLACEMENT('&Igrave;', UNISTR('\00CC'));
  PR_ADD_HTML_REPLACEMENT('&igrave;', UNISTR('\00EC'));
  PR_ADD_HTML_REPLACEMENT('&infin;', UNISTR('\221E'));
  PR_ADD_HTML_REPLACEMENT('&int;', UNISTR('\222B'));
  PR_ADD_HTML_REPLACEMENT('&Iota;', UNISTR('\0399'));
  PR_ADD_HTML_REPLACEMENT('&iota;', UNISTR('\03B9'));
  PR_ADD_HTML_REPLACEMENT('&iquest;', UNISTR('\00BF'));
  PR_ADD_HTML_REPLACEMENT('&isin;', UNISTR('\2208'));
  PR_ADD_HTML_REPLACEMENT('&Iuml;', UNISTR('\00CF'));
  PR_ADD_HTML_REPLACEMENT('&iuml;', UNISTR('\00EF'));
  PR_ADD_HTML_REPLACEMENT('&Kappa;', UNISTR('\039A'));
  PR_ADD_HTML_REPLACEMENT('&kappa;', UNISTR('\03BA'));
  PR_ADD_HTML_REPLACEMENT('&Lambda;', UNISTR('\039B'));
  PR_ADD_HTML_REPLACEMENT('&lambda;', UNISTR('\03BB'));
  PR_ADD_HTML_REPLACEMENT('&lang;', UNISTR('\2329'));
  PR_ADD_HTML_REPLACEMENT('&laquo;', UNISTR('\00AB'));
  PR_ADD_HTML_REPLACEMENT('&lceil;', UNISTR('\2308'));
  PR_ADD_HTML_REPLACEMENT('&le;', UNISTR('\2264'));
  PR_ADD_HTML_REPLACEMENT('&lfloor;', UNISTR('\230A'));
  PR_ADD_HTML_REPLACEMENT('&lowast;', UNISTR('\2217'));
  PR_ADD_HTML_REPLACEMENT('&loz;', UNISTR('\25CA'));
  PR_ADD_HTML_REPLACEMENT('&lt;', UNISTR('\003C'));
  PR_ADD_HTML_REPLACEMENT('&macr;', UNISTR('\00AF'));
  PR_ADD_HTML_REPLACEMENT('&micro;', UNISTR('\00B5'));
  PR_ADD_HTML_REPLACEMENT('&middot;', UNISTR('\00B7'));
  PR_ADD_HTML_REPLACEMENT('&minus;', UNISTR('\2212'));
  PR_ADD_HTML_REPLACEMENT('&Mu;', UNISTR('\039C'));
  PR_ADD_HTML_REPLACEMENT('&mu;', UNISTR('\03BC'));
  PR_ADD_HTML_REPLACEMENT('&nabla;', UNISTR('\2207'));
  PR_ADD_HTML_REPLACEMENT('&nbsp;', UNISTR('\00A0'));
  PR_ADD_HTML_REPLACEMENT('&ne;', UNISTR('\2260'));
  PR_ADD_HTML_REPLACEMENT('&ni;', UNISTR('\220B'));
  PR_ADD_HTML_REPLACEMENT('&not;', UNISTR('\00AC'));
  PR_ADD_HTML_REPLACEMENT('&notin;', UNISTR('\2209'));
  PR_ADD_HTML_REPLACEMENT('&nsub;', UNISTR('\2284'));
  PR_ADD_HTML_REPLACEMENT('&Ntilde;', UNISTR('\00D1'));
  PR_ADD_HTML_REPLACEMENT('&ntilde;', UNISTR('\00F1'));
  PR_ADD_HTML_REPLACEMENT('&Nu;', UNISTR('\039D'));
  PR_ADD_HTML_REPLACEMENT('&nu;', UNISTR('\03BD'));
  PR_ADD_HTML_REPLACEMENT('&Oacute;', UNISTR('\00D3'));
  PR_ADD_HTML_REPLACEMENT('&oacute;', UNISTR('\00F3'));
  PR_ADD_HTML_REPLACEMENT('&Ocirc;', UNISTR('\00D4'));
  PR_ADD_HTML_REPLACEMENT('&ocirc;', UNISTR('\00F4'));
  PR_ADD_HTML_REPLACEMENT('&Ograve;', UNISTR('\00D2'));
  PR_ADD_HTML_REPLACEMENT('&ograve;', UNISTR('\00F2'));
  PR_ADD_HTML_REPLACEMENT('&Omega;', UNISTR('\03A9'));
  PR_ADD_HTML_REPLACEMENT('&omega;', UNISTR('\03C9'));
  PR_ADD_HTML_REPLACEMENT('&Omicron;', UNISTR('\039F'));
  PR_ADD_HTML_REPLACEMENT('&omicron;', UNISTR('\03BF'));
  PR_ADD_HTML_REPLACEMENT('&oplus;', UNISTR('\2295'));
  PR_ADD_HTML_REPLACEMENT('&or;', UNISTR('\2228'));
  PR_ADD_HTML_REPLACEMENT('&ordf;', UNISTR('\00AA'));
  PR_ADD_HTML_REPLACEMENT('&ordm;', UNISTR('\00BA'));
  PR_ADD_HTML_REPLACEMENT('&Oslash;', UNISTR('\00D8'));
  PR_ADD_HTML_REPLACEMENT('&oslash;', UNISTR('\00F8'));
  PR_ADD_HTML_REPLACEMENT('&Otilde;', UNISTR('\00D5'));
  PR_ADD_HTML_REPLACEMENT('&otilde;', UNISTR('\00F5'));
  PR_ADD_HTML_REPLACEMENT('&otimes;', UNISTR('\2297'));
  PR_ADD_HTML_REPLACEMENT('&Ouml;', UNISTR('\00D6'));
  PR_ADD_HTML_REPLACEMENT('&ouml;', UNISTR('\00F6'));
  PR_ADD_HTML_REPLACEMENT('&para;', UNISTR('\00B6'));
  PR_ADD_HTML_REPLACEMENT('&part;', UNISTR('\2202'));
  PR_ADD_HTML_REPLACEMENT('&perp;', UNISTR('\22A5'));
  PR_ADD_HTML_REPLACEMENT('&Phi;', UNISTR('\03A6'));
  PR_ADD_HTML_REPLACEMENT('&phi;', UNISTR('\03C6'));
  PR_ADD_HTML_REPLACEMENT('&Pi;', UNISTR('\03A0'));
  PR_ADD_HTML_REPLACEMENT('&pi;', UNISTR('\03C0'));
  PR_ADD_HTML_REPLACEMENT('&piv;', UNISTR('\03D6'));
  PR_ADD_HTML_REPLACEMENT('&plusmn;', UNISTR('\00B1'));
  PR_ADD_HTML_REPLACEMENT('&pound;', UNISTR('\00A3'));
  PR_ADD_HTML_REPLACEMENT('&prod;', UNISTR('\220F'));
  PR_ADD_HTML_REPLACEMENT('&prop;', UNISTR('\221D'));
  PR_ADD_HTML_REPLACEMENT('&Psi;', UNISTR('\03A8'));
  PR_ADD_HTML_REPLACEMENT('&psi;', UNISTR('\03C8'));
  PR_ADD_HTML_REPLACEMENT('&radic;', UNISTR('\221A'));
  PR_ADD_HTML_REPLACEMENT('&rang;', UNISTR('\232A'));
  PR_ADD_HTML_REPLACEMENT('&raquo;', UNISTR('\00BB'));
  PR_ADD_HTML_REPLACEMENT('&rceil;', UNISTR('\2309'));
  PR_ADD_HTML_REPLACEMENT('&reg;', UNISTR('\00AE'));
  PR_ADD_HTML_REPLACEMENT('&rfloor;', UNISTR('\230B'));
  PR_ADD_HTML_REPLACEMENT('&Rho;', UNISTR('\03A1'));
  PR_ADD_HTML_REPLACEMENT('&rho;', UNISTR('\03C1'));
  PR_ADD_HTML_REPLACEMENT('&sdot;', UNISTR('\22C5'));
  PR_ADD_HTML_REPLACEMENT('&sect;', UNISTR('\00A7'));
  PR_ADD_HTML_REPLACEMENT('&shy;', UNISTR('\00AD'));
  PR_ADD_HTML_REPLACEMENT('&Sigma;', UNISTR('\03A3'));
  PR_ADD_HTML_REPLACEMENT('&sigma;', UNISTR('\03C3'));
  PR_ADD_HTML_REPLACEMENT('&sigmaf;', UNISTR('\03C2'));
  PR_ADD_HTML_REPLACEMENT('&sim;', UNISTR('\223C'));
  PR_ADD_HTML_REPLACEMENT('&sub;', UNISTR('\2282'));
  PR_ADD_HTML_REPLACEMENT('&sube;', UNISTR('\2286'));
  PR_ADD_HTML_REPLACEMENT('&sum;', UNISTR('\2211'));
  PR_ADD_HTML_REPLACEMENT('&sup;', UNISTR('\2283'));
  PR_ADD_HTML_REPLACEMENT('&sup1;', UNISTR('\00B9'));
  PR_ADD_HTML_REPLACEMENT('&sup2;', UNISTR('\00B2'));
  PR_ADD_HTML_REPLACEMENT('&sup3;', UNISTR('\00B3'));
  PR_ADD_HTML_REPLACEMENT('&supe;', UNISTR('\2287'));
  PR_ADD_HTML_REPLACEMENT('&szlig;', UNISTR('\00DF'));
  PR_ADD_HTML_REPLACEMENT('&Tau;', UNISTR('\03A4'));
  PR_ADD_HTML_REPLACEMENT('&tau;', UNISTR('\03C4'));
  PR_ADD_HTML_REPLACEMENT('&there4;', UNISTR('\2234'));
  PR_ADD_HTML_REPLACEMENT('&Theta;', UNISTR('\0398'));
  PR_ADD_HTML_REPLACEMENT('&theta;', UNISTR('\03B8'));
  PR_ADD_HTML_REPLACEMENT('&thetasym;', UNISTR('\03D1'));
  PR_ADD_HTML_REPLACEMENT('&THORN;', UNISTR('\00DE'));
  PR_ADD_HTML_REPLACEMENT('&thorn;', UNISTR('\00FE'));
  PR_ADD_HTML_REPLACEMENT('&times;', UNISTR('\00D7'));
  PR_ADD_HTML_REPLACEMENT('&Uacute;', UNISTR('\00DA'));
  PR_ADD_HTML_REPLACEMENT('&uacute;', UNISTR('\00FA'));
  PR_ADD_HTML_REPLACEMENT('&Ucirc;', UNISTR('\00DB'));
  PR_ADD_HTML_REPLACEMENT('&ucirc;', UNISTR('\00FB'));
  PR_ADD_HTML_REPLACEMENT('&Ugrave;', UNISTR('\00D9'));
  PR_ADD_HTML_REPLACEMENT('&ugrave;', UNISTR('\00F9'));
  PR_ADD_HTML_REPLACEMENT('&uml;', UNISTR('\00A8'));
  PR_ADD_HTML_REPLACEMENT('&upsih;', UNISTR('\03D2'));
  PR_ADD_HTML_REPLACEMENT('&Upsilon;', UNISTR('\03A5'));
  PR_ADD_HTML_REPLACEMENT('&upsilon;', UNISTR('\03C5'));
  PR_ADD_HTML_REPLACEMENT('&Uuml;', UNISTR('\00DC'));
  PR_ADD_HTML_REPLACEMENT('&uuml;', UNISTR('\00FC'));
  PR_ADD_HTML_REPLACEMENT('&Xi;', UNISTR('\039E'));
  PR_ADD_HTML_REPLACEMENT('&xi;', UNISTR('\03BE'));
  PR_ADD_HTML_REPLACEMENT('&Yacute;', UNISTR('\00DD'));
  PR_ADD_HTML_REPLACEMENT('&yacute;', UNISTR('\00FD'));
  PR_ADD_HTML_REPLACEMENT('&yen;', UNISTR('\00A5'));
  PR_ADD_HTML_REPLACEMENT('&yuml;', UNISTR('\00FF'));
  PR_ADD_HTML_REPLACEMENT('&Zeta;', UNISTR('\0396'));
  PR_ADD_HTML_REPLACEMENT('&zeta;', UNISTR('\03B6'));
END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_types IS
END;
/
create or replace PACKAGE BODY pk_jrxml2pdf_util IS
  TYPE tDateSplitChars IS TABLE OF VARCHAR2(1) INDEX BY BINARY_INTEGER;
  lDateSplitChars     tDateSplitChars;
  lFontNames          PK_JRXML2PDF_TYPES.tFontNames;
  lCustomFonts        PK_JRXML2PDF_TYPES.tFontNames;
  lTextCache          PK_JRXML2PDF_TYPES.tTextCacheList;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_EXTRACT_RESOURCES_FROM_CLOB(i_nJrrId IN NUMBER) IS
    PRAGMA AUTONOMOUS_TRANSACTION;
    CURSOR crFile IS
      SELECT JRR_CONTENT
        FROM JRXML_RESOURCE_FILES
       WHERE JRR_ID=i_nJrrId;
    clData      CLOB;
    vcLine      VARCHAR2(32767);
    vcKey       VARCHAR2(4000);
    vcValue     VARCHAR2(4000);
    nLength     NUMBER;
    nOffset     NUMBER;
    nPartlength NUMBER;
  BEGIN
    -- Delete current resources
    DELETE JRXML_RESOURCE_ENTRIES
     WHERE JRS_JRR_ID=i_nJrrId;
    OPEN crFile;
    FETCH crFile INTO clData;
    CLOSE crFile;
    DBMS_LOB.OPEN(clData, DBMS_LOB.LOB_READONLY);
    nLength:=DBMS_LOB.GETLENGTH(clData);
    nOffset:=1;
    WHILE (nOffset < nLength AND nOffset>0) LOOP
      IF DBMS_LOB.INSTR(clData, CHR(10), nOffset)>0 THEN
        nPartlength:=DBMS_LOB.INSTR(clData, CHR(10), nOffset)-nOffset;
      ELSE
        nPartlength:=nLength-nOffset;
      END IF;
      vcLine:=DBMS_LOB.SUBSTR(clData, nPartLength, nOffset);
      IF vcLine IS NOT NULL THEN
        -- Split into Key and Value
        IF INSTR(vcLine, '=')>0 THEN
          vcKey:=SUBSTR(vcLine, 1, INSTR(vcLine, '=')-1);
          vcValue:=SUBSTR(vcLine, INSTR(vcLine, '=')+1);
          -- In the value, replace Unicode-encodings and linefeed
          IF INSTR(vcValue, '\n')>0 THEN
            vcValue:=REPLACE(vcValue, '\n', CHR(10));
          END IF;
          IF INSTR(vcValue, '\u')>0 THEN
            vcValue:=UNISTR(REPLACE(vcValue, '\u', '\'));
          END IF;
          INSERT INTO JRXML_RESOURCE_ENTRIES (
            JRS_ID,
            JRS_JRR_ID,
            JRS_KEY,
            JRS_VALUE
          ) VALUES (
            JRXML_SEQ.NEXTVAL,
            i_nJrrId,
            vcKey,
            vcValue
          );
        END IF;
      END IF;
      nOffset:=nOffset+nPartLength+1;
    END LOOP;
    DBMS_LOB.CLOSE(clData);
    -- set valid-flag
    UPDATE JRXML_RESOURCE_FILES SET
      JRR_VALID='Y'
     WHERE JRR_ID=i_nJrrId;
    COMMIT;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CHECK_LOCALE_DATA(i_vcResourceName IN VARCHAR2,
                                i_vcLocale       IN VARCHAR2
                               )
  RETURN NUMBER IS
    CURSOR crFile IS
      SELECT 1 SORT,
             JRR_ID,
             JRR_VALID
        FROM JRXML_RESOURCE_FILES
       WHERE JRR_NAME=i_vcResourceName
         AND JRR_LOCALE=i_vcLocale
      UNION ALL
      SELECT 2 SORT,
             JRR_ID,
             JRR_VALID
        FROM JRXML_RESOURCE_FILES
       WHERE JRR_NAME=i_vcResourceName
         AND JRR_LOCALE=SUBSTR(i_vcLocale, 1, INSTR(i_vcLocale, '_'))
      UNION ALL
      SELECT 3 SORT,
             JRR_ID,
             JRR_VALID
        FROM JRXML_RESOURCE_FILES
       WHERE JRR_NAME=i_vcResourceName
         AND JRR_LOCALE IS NULL
      ORDER BY 1;
    recFile crFile%ROWTYPE;
  BEGIN
    OPEN crFile;
    FETCH crFile INTO recFile;
    IF crFile%FOUND THEN
      IF recFile.JRR_VALID!='Y' THEN
        PR_EXTRACT_RESOURCES_FROM_CLOB(recFile.JRR_ID);
      END IF;
    END IF;
    CLOSE crFile;
    -- return ID for resource
    RETURN recFile.JRR_ID;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_LOCALE_DATA(i_vcLocale IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tLocaleData IS
    CURSOR crNls IS
      SELECT JRN_LOCALE_LANGUAGE || '_' || JRN_LOCALE_COUNTRY LOCALE,
             JRN_DEFAULT_DATE_FORMAT,
             JRN_SHORT_DATE_FORMAT,
             JRN_MEDIUM_DATE_FORMAT,
             JRN_LONG_DATE_FORMAT,
             JRN_DEFAULT_TIME_FORMAT,
             JRN_SHORT_TIME_FORMAT,
             JRN_MEDIUM_TIME_FORMAT,
             JRN_LONG_TIME_FORMAT,
             JRN_DATE_TIME_STRING,
             JRN_NUMERIC_CHARACTERS,
             JRN_CURRENCY,
             JRN_NLS_LANGUAGE
        FROM JRXML_NLS_PARAMETERS,
             (SELECT VALUE SESSION_LANGUAGE
                FROM NLS_SESSION_PARAMETERS
               WHERE PARAMETER='NLS_LANGUAGE'
             ),
             (SELECT VALUE SESSION_TERRITORY
                FROM NLS_SESSION_PARAMETERS
               WHERE PARAMETER='NLS_TERRITORY'
             )
       WHERE JRN_NLS_LANGUAGE=SESSION_LANGUAGE
         AND JRN_NLS_TERRITORY=SESSION_TERRITORY;
    CURSOR crLocale(i_vcLanguage  IN VARCHAR2,
                    i_vcTerritory IN VARCHAR2) IS
      SELECT 1 SORT,
             JRN_LOCALE_LANGUAGE || '_' || JRN_LOCALE_COUNTRY LOCALE,
             JRN_DEFAULT_DATE_FORMAT,
             JRN_SHORT_DATE_FORMAT,
             JRN_MEDIUM_DATE_FORMAT,
             JRN_LONG_DATE_FORMAT,
             JRN_DEFAULT_TIME_FORMAT,
             JRN_SHORT_TIME_FORMAT,
             JRN_MEDIUM_TIME_FORMAT,
             JRN_LONG_TIME_FORMAT,
             JRN_DATE_TIME_STRING,
             JRN_NUMERIC_CHARACTERS,
             JRN_CURRENCY,
             JRN_NLS_LANGUAGE
        FROM JRXML_NLS_PARAMETERS
       WHERE JRN_LOCALE_LANGUAGE=i_vcLanguage
         AND (   JRN_LOCALE_COUNTRY=i_vcTerritory
              OR (    JRN_LOCALE_COUNTRY IS NULL
                  AND i_vcTerritory IS NULL
                 )
             )
       UNION ALL
      SELECT 2 SORT,
             JRN_LOCALE_LANGUAGE || '_' || JRN_LOCALE_COUNTRY LOCALE,
             JRN_DEFAULT_DATE_FORMAT,
             JRN_SHORT_DATE_FORMAT,
             JRN_MEDIUM_DATE_FORMAT,
             JRN_LONG_DATE_FORMAT,
             JRN_DEFAULT_TIME_FORMAT,
             JRN_SHORT_TIME_FORMAT,
             JRN_MEDIUM_TIME_FORMAT,
             JRN_LONG_TIME_FORMAT,
             JRN_DATE_TIME_STRING,
             JRN_NUMERIC_CHARACTERS,
             JRN_CURRENCY,
             JRN_NLS_LANGUAGE
        FROM JRXML_NLS_PARAMETERS
       WHERE JRN_LOCALE_LANGUAGE=i_vcLanguage
       ORDER BY 1;
    rLocaleData PK_JRXML2PDF_TYPES.tLocaleData;
    nDummy      NUMBER;
  BEGIN
    IF i_vcLocale IS NULL THEN
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Load Resources from NLS-Parameters');
      END IF;
      -- get locale from NLS-settings
      OPEN crNls;
      FETCH crNls INTO rLocaleData.vcLocale,
                       rLocaleData.vcDateDefault,
                       rLocaleData.vcDateShort,
                       rLocaleData.vcDateMedium,
                       rLocaleData.vcDateLong,
                       rLocaleData.vcTimeDefault,
                       rLocaleData.vcTimeShort,
                       rLocaleData.vcTimeMedium,
                       rLocaleData.vcTimeLong,
                       rLocaleData.vcDateTimeString,
                       rLocaleData.vcNumericChars,
                       rLocaleData.vcCurrency,
                       rLocaleData.vcDateLanguage;
      CLOSE crNls;
    ELSE
      IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
        PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Load Resources from Locale ' || i_vcLocale);
      END IF;
      OPEN crLocale(SUBSTR(i_vcLocale, 1, INSTR(i_vcLocale, '_')-1),
                    SUBSTR(i_vcLocale, INSTR(i_vcLocale, '_')+1)
                   );
      FETCH crLocale INTO nDummy,
                          rLocaleData.vcLocale,
                          rLocaleData.vcDateDefault,
                          rLocaleData.vcDateShort,
                          rLocaleData.vcDateMedium,
                          rLocaleData.vcDateLong,
                          rLocaleData.vcTimeDefault,
                          rLocaleData.vcTimeShort,
                          rLocaleData.vcTimeMedium,
                          rLocaleData.vcTimeLong,
                          rLocaleData.vcDateTimeString,
                          rLocaleData.vcNumericChars,
                          rLocaleData.vcCurrency,
                          rLocaleData.vcDateLanguage;
      CLOSE crLocale;
    END IF;
    IF rLocaleData.vcLocale IS NULL THEN
      IF PK_JRXML2PDF_LOG.FK_IS_OVERVIEW THEN
        PK_JRXML2PDF_LOG.PR_LOG_OVERVIEW('Invalid locale ' || i_vcLocale);
      END IF;
      RAISE NO_DATA_FOUND;
    END IF;
    -- now convert the formats to oracle
    rLocaleData.vcDateDefault:=FK_ORA_DATE_PATTERN(rLocaleData.vcDateDefault);
    rLocaleData.vcDateShort  :=FK_ORA_DATE_PATTERN(rLocaleData.vcDateShort);
    rLocaleData.vcDateMedium :=FK_ORA_DATE_PATTERN(rLocaleData.vcDateMedium);
    rLocaleData.vcDateLong   :=FK_ORA_DATE_PATTERN(rLocaleData.vcDateLong);
    rLocaleData.vcTimeDefault:=FK_ORA_DATE_PATTERN(rLocaleData.vcTimeDefault);
    rLocaleData.vcTimeShort  :=FK_ORA_DATE_PATTERN(rLocaleData.vcTimeShort);
    rLocaleData.vcTimeMedium :=FK_ORA_DATE_PATTERN(rLocaleData.vcTimeMedium);
    rLocaleData.vcTimeLong   :=FK_ORA_DATE_PATTERN(rLocaleData.vcTimeLong);
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Locale-settings read');
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Locale       : ' || rLocaleData.vcLocale);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DateDefault  : ' || rLocaleData.vcDateDefault);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DateShort    : ' || rLocaleData.vcDateShort);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DateMedium   : ' || rLocaleData.vcDateMedium);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DateLong     : ' || rLocaleData.vcDateLong);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('TimeDefault  : ' || rLocaleData.vcTimeDefault);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('TimeShort    : ' || rLocaleData.vcTimeShort);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('TimeMedium   : ' || rLocaleData.vcTimeMedium);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Time Long    : ' || rLocaleData.vcTimeLong);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('DateTime     : ' || rLocaleData.vcDateTimeString);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Currency     : ' || rLocaleData.vcCurrency);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Num-Chars    : ' || rLocaleData.vcNumericChars);
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Date-Language: ' || rLocaleData.vcDateLanguage);
    END IF;
    rLocaleData.vcDateLanguage:=' NLS_DATE_LANGUAGE=''' || rLocaleData.vcDateLanguage || '''';
    rLocaleData.vcNumericChars:=' NLS_NUMERIC_CHARACTERS=''' || RPAD(rLocaleData.vcNumericChars, 2, ' ') || '''';
    rLocaleData.vcCurrency    :=' NLS_CURRENCY=''' || rLocaleData.vcCurrency || '''';
    RETURN rLocaleData;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_GET_RESOURCE(i_vcResourceName IN VARCHAR2,
                           i_vcLocale       IN VARCHAR2)
  RETURN PK_JRXML2PDF_TYPES.tResourceList IS
    CURSOR crResources(i_nJrrId IN NUMBER) IS
      SELECT JRS_KEY,
             JRS_VALUE
       FROM JRXML_RESOURCE_ENTRIES
      WHERE JRS_JRR_ID=i_nJrrId;
    TYPE tRessources IS TABLE OF crResources%ROWTYPE;
    lResources tRessources;
    lReturn    PK_JRXML2PDF_TYPES.tResourceList;
    nJrrId     NUMBER;
  BEGIN
    nJrrId:=FK_CHECK_LOCALE_DATA(i_vcResourceName=>i_vcResourceName,
                                 i_vcLocale      =>i_vcLocale
                                );
    OPEN crResources(nJrrId);
    FETCH crResources
    BULK COLLECT INTO lResources;
    CLOSE crResources;
    FOR i IN 1..lResources.COUNT LOOP
      lReturn(lResources(i).JRS_KEY):=lResources(i).JRS_VALUE;
    END LOOP;
    RETURN lReturn;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_ORA_DATE_PATTERN(i_vcPattern IN VARCHAR2)
  RETURN VARCHAR2 IS
    iPos          PLS_INTEGER;
    iSplitPos     PLS_INTEGER;
    lSplitPos     tDateSplitChars;
    vcResult      VARCHAR2(4000);
    PROCEDURE PR_TOKENIZE IS
      iPos      PLS_INTEGER:=1;
      iFoundPos PLS_INTEGER;
      iToken    PLS_INTEGER;
    BEGIN
      LOOP
        EXIT WHEN iPos>LENGTH(i_vcPattern);
        iFoundPos:=99999;
        FOR i IN 1..lDateSplitChars.COUNT LOOP
          iToken:=INSTR(i_vcPattern, lDateSplitChars(i), iPos);
          IF iToken>0 THEN
            iFoundPos:=LEAST(iFoundPos, iToken);
            lSplitPos(iToken):=lDateSplitChars(i);
          END IF;
        END LOOP;
        iPos:=iFoundPos+1;
      END LOOP;
    END;
    FUNCTION FK_CONVERT_PATTERN(i_vcToConvert IN VARCHAR2)
    RETURN VARCHAR2 IS
      vcNewPattern VARCHAR2(20);
    BEGIN
      vcNewPattern:=CASE WHEN i_vcToConvert='GG' THEN
                      'AD'
                    WHEN i_vcToConvert='M' THEN
                      'MM'
                    WHEN i_vcToConvert='MM' THEN
                      'MM'
                    WHEN i_vcToConvert='MMM' THEN
                      'Mon'
                    WHEN i_vcToConvert='MMMM' THEN
                      'FMMonth'
                    WHEN i_vcToConvert='MMMMM' THEN
                      'FMMonth'
                    WHEN i_vcToConvert='d' THEN
                      'DD'
                    WHEN i_vcToConvert='dd' THEN
                      'DD'
                    WHEN i_vcToConvert='h' THEN
                      'HH'
                    WHEN i_vcToConvert='hh' THEN
                      'HH'
                    WHEN i_vcToConvert='HH' THEN
                      'HH24'
                    WHEN i_vcToConvert='m' THEN
                      'MI'
                    WHEN i_vcToConvert='mm' THEN
                      'MI'
                    WHEN i_vcToConvert='s' THEN
                      'SS'
                    WHEN i_vcToConvert='ss' THEN
                      'SS'
                    WHEN i_vcToConvert='S' THEN
                      NULL
                    WHEN i_vcToConvert='EEE' THEN
                      'Dy'
                    WHEN i_vcToConvert='EEEEE' THEN
                      'Day'
                    WHEN i_vcToConvert='D' THEN
                      'DDD'
                    WHEN i_vcToConvert='DD' THEN
                      'DDD'
                    WHEN i_vcToConvert='DDD' THEN
                      'DDD'
                    WHEN i_vcToConvert='w' THEN
                      'IW'
                    WHEN i_vcToConvert='a' THEN
                      'PM'
                    WHEN i_vcToConvert='aa' THEN
                      'PM'
                    WHEN i_vcToConvert='z' THEN
                      NULL
                    WHEN i_vcToConvert='zz' THEN
                      NULL
                    WHEN i_vcToConvert='zzz' THEN
                      NULL
                    WHEN i_vcToConvert='yy' THEN
                      'YY'
                    WHEN i_vcToConvert='yyyy' THEN
                      'YYYY'
                    END;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Convert ' || i_vcToConvert || ' to ' || vcNewPattern);
      END IF;
      RETURN vcNewPattern;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Scan date format ' || i_vcPattern);
    END IF;
    IF i_vcPattern IS NOT NULL THEN
      PR_TOKENIZE;
      iPos:=1;
      iSplitPos:=lSplitPos.FIRST;
      WHILE iSplitPos IS NOT NULL LOOP
        IF iSplitPos>iPos THEN
          vcResult:=vcResult || FK_CONVERT_PATTERN(SUBSTR(i_vcPattern, iPos, iSplitPos-iPos));
          iPos:=iSplitPos;
        END IF;
        IF lSplitPos(iPos)='''' THEN
          -- search end of fixed part
          iSplitPos:=lSplitPos.NEXT(iSplitPos);
          WHILE     iSplitPos IS NOT NULL
                AND lSplitPos(iSplitPos)!='''' LOOP
            iSplitPos:=lSplitPos.NEXT(iSplitPos);
          END LOOP;
          IF iSplitPos IS NOT NULL THEN
            vcResult:=vcResult || '"' || SUBSTR(i_vcPattern, iPos+1, iSplitPos-iPos-1) || '"';
          ELSE
            vcResult:=vcResult || '"' || SUBSTR(i_vcPattern, iPos+1) || '"';
          END IF;
          iPos:=iSplitPos+1;
        ELSE
          vcResult:=vcResult || lSplitPos(iSplitPos);
          iPos:=iSplitPos+1;
        END IF;
        iSplitPos:=lSplitPos.NEXT(iSplitPos);
      END LOOP;
      IF iPos <= LENGTH(i_vcPattern) THEN
        vcResult:=vcResult || FK_CONVERT_PATTERN(SUBSTR(i_vcPattern, iPos));
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Result date format ' || vcResult);
      END IF;
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_JAVA_DATE_PATTERN(i_vcPattern IN VARCHAR2)
  RETURN VARCHAR2 IS
    iPos          PLS_INTEGER;
    iSplitPos     PLS_INTEGER;
    lSplitPos     tDateSplitChars;
    vcResult      VARCHAR2(4000);
    PROCEDURE PR_TOKENIZE IS
      iPos      PLS_INTEGER:=1;
      iFoundPos PLS_INTEGER;
      iToken    PLS_INTEGER;
    BEGIN
      LOOP
        EXIT WHEN iPos>LENGTH(i_vcPattern);
        iFoundPos:=99999;
        FOR i IN 1..lDateSplitChars.COUNT LOOP
          iToken:=INSTR(i_vcPattern, lDateSplitChars(i), iPos);
          IF iToken>0 THEN
            iFoundPos:=LEAST(iFoundPos, iToken);
            lSplitPos(iToken):=lDateSplitChars(i);
          END IF;
        END LOOP;
        iPos:=iFoundPos+1;
      END LOOP;
    END;
    FUNCTION FK_CONVERT_PATTERN(i_vcToConvert IN VARCHAR2)
    RETURN VARCHAR2 IS
      vcNewPattern VARCHAR2(20);
    BEGIN
      vcNewPattern:=CASE WHEN UPPER(i_vcToConvert)='AD' THEN
                      'GG'
                    WHEN UPPER(i_vcToConvert)='MM' THEN
                      'M'
                    WHEN UPPER(i_vcToConvert)='MM' THEN
                      'MM'
                    WHEN UPPER(i_vcToConvert)='MON' THEN
                      'MMM'
                    WHEN UPPER(i_vcToConvert)='FMMONTH' THEN
                      'MMMM'
                    WHEN UPPER(i_vcToConvert)='MONTH' THEN
                      'MMMM'
                    WHEN UPPER(i_vcToConvert)='DD' THEN
                      'dd'
                    WHEN UPPER(i_vcToConvert)='HH' THEN
                      'hh'
                    WHEN UPPER(i_vcToConvert)='HH24' THEN
                      'HH'
                    WHEN UPPER(i_vcToConvert)='MI' THEN
                      'mm'
                    WHEN UPPER(i_vcToConvert)='SS' THEN
                      'ss'
                    WHEN UPPER(i_vcToConvert)='DY' THEN
                      'EEE'
                    WHEN UPPER(i_vcToConvert)='DAY' THEN
                      'EEEEE'
                    WHEN UPPER(i_vcToConvert)='DDD' THEN
                      'DD'
                    WHEN UPPER(i_vcToConvert)='IW' THEN
                      'w'
                    WHEN UPPER(i_vcToConvert)='PM' THEN
                      'aa'
                    WHEN UPPER(i_vcToConvert)='YY' THEN
                      'yy'
                    WHEN UPPER(i_vcToConvert)='YYYY' THEN
                      'yyyy'
                    END;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Convert ' || i_vcToConvert || ' to ' || vcNewPattern);
      END IF;
      RETURN vcNewPattern;
    END;
  BEGIN
    IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
      PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Scan date format ' || i_vcPattern);
    END IF;
    IF i_vcPattern IS NOT NULL THEN
      PR_TOKENIZE;
      iPos:=1;
      iSplitPos:=lSplitPos.FIRST;
      WHILE iSplitPos IS NOT NULL LOOP
        IF iSplitPos>iPos THEN
          vcResult:=vcResult || FK_CONVERT_PATTERN(SUBSTR(i_vcPattern, iPos, iSplitPos-iPos));
          iPos:=iSplitPos;
        END IF;
        IF lSplitPos(iPos)='''' THEN
          -- search end of fixed part
          iSplitPos:=lSplitPos.NEXT(iSplitPos);
          WHILE     iSplitPos IS NOT NULL
                AND lSplitPos(iSplitPos)!='''' LOOP
            iSplitPos:=lSplitPos.NEXT(iSplitPos);
          END LOOP;
          IF iSplitPos IS NOT NULL THEN
            vcResult:=vcResult || '"' || SUBSTR(i_vcPattern, iPos+1, iSplitPos-iPos-1) || '"';
          ELSE
            vcResult:=vcResult || '"' || SUBSTR(i_vcPattern, iPos+1) || '"';
          END IF;
          iPos:=iSplitPos+1;
        ELSE
          vcResult:=vcResult || lSplitPos(iSplitPos);
          iPos:=iSplitPos+1;
        END IF;
        iSplitPos:=lSplitPos.NEXT(iSplitPos);
      END LOOP;
      IF iPos <= LENGTH(i_vcPattern) THEN
        vcResult:=vcResult || FK_CONVERT_PATTERN(SUBSTR(i_vcPattern, iPos));
      END IF;
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Result date format ' || vcResult);
      END IF;
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_TEXT_MESSAGE(i_vcText         IN VARCHAR2,
                           i_vcPlaceholder1 IN VARCHAR2 DEFAULT NULL,
                           i_vcPlaceholder2 IN VARCHAR2 DEFAULT NULL,
                           i_vcPlaceholder3 IN VARCHAR2 DEFAULT NULL)
  RETURN VARCHAR2 IS
    vcResult VARCHAR2(4000):=i_vcText;
  BEGIN
    IF INSTR(vcresult, '{0}')>0 THEN
      vcResult:=REPLACE(vcResult, '{0}', i_vcPlaceholder1);
    END IF;
    IF INSTR(vcresult, '{1}')>0 THEN
      vcResult:=REPLACE(vcResult, '{1}', i_vcPlaceholder2);
    END IF;
    IF INSTR(vcresult, '{2}')>0 THEN
      vcResult:=REPLACE(vcResult, '{2}', i_vcPlaceholder3);
    END IF;
    RETURN vcResult;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_SPLIT(io_vcText     IN OUT NOCOPY VARCHAR2,
                    i_vcDelimiter IN     VARCHAR2 DEFAULT '|')
  RETURN VARCHAR2 IS
    vcText VARCHAR2(2000);
  BEGIN
    IF INSTR(io_vcText, i_vcDelimiter) > 0 THEN
      vcText := SUBSTR(io_vcText, 1, INSTR(io_vcText, i_vcDelimiter)-1);
      io_vcText := SUBSTR(io_vcText, INSTR(io_vcText, i_vcDelimiter)+1);
    ELSE
      vcText := io_vcText;
      io_vcText := '';
    END IF;
    RETURN vcText;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SET_FONT(i_vcFont  IN VARCHAR2,
                        i_vcStyle IN PK_JRXML2PDF_TYPES.tStyleName,
                        i_nSize   IN NUMBER) IS
   CURSOR crFont(i_vcCustomFont IN VARCHAR2) IS
     SELECT JRF_NAME,
            JRF_TYPE,
            JRF_FONT,
            NVL(JRF_ENCODING, 'WINDOWS-1252') JRF_ENCODING,
            JRF_COMPRESS
       FROM JRXML_FONTS
      WHERE JRF_NAME=i_vcCustomFont;
    recFont crFont%ROWTYPE;
    vcFont           PK_JRXML2PDF_TYPES.tFont:=i_vcFont;
    nFontIndex       NUMBER;
    vcCustomFontName PK_JRXML2PDF_TYPES.tFont;
    FUNCTION FK_GET_CUSTOM_FONT(i_vcCustomFont IN VARCHAR2)
    RETURN NUMBER IS
      nReturn NUMBER;
    BEGIN
      IF NOT lCustomFonts.EXISTS(UPPER(i_vcCustomFont)) THEN
        IF PK_JRXML2PDF_LOG.FK_IS_DETAIL THEN
          PK_JRXML2PDF_LOG.PR_LOG_DETAIL('Load custom font ' || i_vcCustomFont);
        END IF;
        -- Load font from table
        OPEN crFont(i_vcCustomFont);
        FETCh crFont INTO recFont;
        IF crFont%FOUND THEN
          -- Add font to pdf
          IF recFont.JRF_TYPE='TTF' THEN
            -- only ttf-fonts are supported for now
            nReturn:=AS_PDF3_MOD.load_ttf_font(p_font     =>recFont.JRF_FONT,
                                               p_encoding =>recFont.JRF_ENCODING,
                                               p_embed    =>TRUE,
                                               p_compress =>(recFont.JRF_COMPRESS=PK_JRXML2PDF_TYPES.YES)
                                              );
          END IF;
          -- add to mapping-table
          lCustomFonts(UPPER(i_vcCustomFont)):=nReturn;
        END IF;
        CLOSE crFont;
      ELSE
        nReturn:=lCustomFonts(UPPER(i_vcCustomFont));
      END IF;
      RETURN nReturn;
    END;
  BEGIN
    -- default if no font defined
    IF TRIM(vcFont) IS NULL THEN
      vcFont:=PK_JRXML2PDF_TYPES.ARIAL;
    END IF;
    -- set font ans size
    IF lFontNames.EXISTS(UPPER(vcFont)) THEN
      -- standard-font, map to internal name
      vcFont:=lFontNames(UPPER(vcFont));
      IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
        PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Set font to ' || vcFont || '-' || NVL(i_vcStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL) || '-' ||NVL(i_nSize, 10));
      END IF;
      AS_PDF3_MOD.set_font(p_family     =>vcFont,
                           p_style      =>NVL(i_vcStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL),
                           p_fontsize_pt=>NVL(i_nSize, 10)
                          );
    ELSE
      -- custom font, build lookup-fontname
      vcCustomFontName:=vcFont || CASE WHEN i_vcStyle=PK_JRXML2PDF_TYPES.FONT_BOLD THEN
                                      '-Bold'
                                    WHEN i_vcStyle=PK_JRXML2PDF_TYPES.FONT_ITALIC THEN
                                      '-Italic'
                                    WHEN i_vcStyle=PK_JRXML2PDF_TYPES.FONT_BOLD_ITALIC THEN
                                      '-BoldItalic'
                                    END;
      -- get the font-index
      nFontIndex:=FK_GET_CUSTOM_FONT(vcCustomFontName);
      IF     nFontIndex IS NULL
         AND NVL(i_vcStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL)!=PK_JRXML2PDF_TYPES.FONT_NORMAL THEN
        -- font with given style not found,
        -- check for Normal font
        nFontIndex:=FK_GET_CUSTOM_FONT(vcFont);
      END IF;
      -- set font by index
      IF nFontIndex IS NOT NULL THEN
        AS_PDF3_MOD.set_font(p_index => nFontIndex,
                             p_fontsize_pt=>NVL(i_nSize, 10)
                            );
      ELSE
        -- Default to PK_JRXML2PDF_TYPES.HELVETICA
        AS_PDF3_MOD.set_font(p_family     =>PK_JRXML2PDF_TYPES.HELVETICA,
                             p_style      =>NVL(i_vcStyle, PK_JRXML2PDF_TYPES.FONT_NORMAL),
                             p_fontsize_pt=>NVL(i_nSize, 10)
                            );
      END IF;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_INIT_FONTS(i_lParams in PK_JRXML2PDF_TYPES.tParamList) IS
    bMapArial BOOLEAN:=TRUE;
    bMapTimes BOOLEAN:=TRUE;
    bMapCourier BOOLEAN:=TRUE;
  BEGIN
    -- check parameter for not mapping fon
    FOR i IN 1..i_lParams.COUNT LOOP
      IF     i_lParams(i).vcName='$$EXTERNAL_FONT_ARIAL$$'
         AND i_lParams(i).vcValue=PK_JRXML2PDF_TYPES.YES THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Arial font will not be mapped!');
        END IF;
        bMapArial:=FALSE;
      ELSIF    i_lParams(i).vcName='$$EXTERNAL_FONT_TIMES$$'
           AND i_lParams(i).vcValue=PK_JRXML2PDF_TYPES.YES THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Times font will not be mapped!');
        END IF;
        bMapTimes:=FALSE;
      ELSIF    i_lParams(i).vcName='$$EXTERNAL_FONT_COURIER$$'
           AND i_lParams(i).vcValue=PK_JRXML2PDF_TYPES.YES THEN
        IF PK_JRXML2PDF_LOG.FK_IS_INTERNAL THEN
          PK_JRXML2PDF_LOG.PR_LOG_INTERNAL('Courier font will not be mapped!');
        END IF;
        bMapCourier:=FALSE;
      END IF;
    END LOOP;
    -- Clear fonts
    lFontNames.DELETE;
    -- Init Fontmapping
    IF bMapArial THEN
      lFontNames('ARIAL'):='helvetica';
    END IF;
    IF bMapTimes THEN
      lFontNames('TIMES NEW ROMAN'):='times';
    END IF;
    IF bMapCourier THEN
      lFontNames('COURIER NEW'):='courier';
    END IF;
    lFontNames('WINGDINGS'):='zapfdingbats';
    -- Clear custom fonts
    lCustomFonts.DELETE;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_SPLIT_TEXT_TO_BOX(io_lText          IN OUT NOCOPY PK_JRXML2PDF_TYPES.tTextPieceList,
                                 io_nCurrentHeight IN OUT NOCOPY NUMBER,
                                 io_nX             IN OUT NOCOPY NUMBER,
                                 i_vcText          IN VARCHAR2,
                                 i_nMaxHeight      IN NUMBER,
                                 io_nGroup         IN OUT NUMBER,
                                 i_nLineSpacing    IN NUMBER,
                                 i_nXStart         IN NUMBER,
                                 i_nMaxWidth       IN NUMBER,
                                 i_bSplitByWord    IN BOOLEAN
                                ) IS
    nLen        NUMBER;
    iCnt        PLS_INTEGER;
    iIdx        PLS_INTEGER;
    nLineHeight NUMBER;
    nXTemp      NUMBER;
  begin
    IF i_vcText IS NULL THEN
      RETURN;
    END IF;
    nLineHeight:=AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
    iIdx:=INSTR(i_vcText, CHR(10));
    IF iIdx>0 THEN
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           i_vcText          =>RTRIM(SUBSTR(i_vcText, 1, iIdx-1), CHR(13)),
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nX             =>io_nX,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXstart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
      io_nGroup:=io_nGroup+1;
      io_nX:=i_nXStart;
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           i_vcText          =>SUBSTR(i_vcText, iIdx+1),
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nX             =>io_nX,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXstart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
      RETURN;
    END IF;
    nLen:=AS_PDF3_MOD.str_len(i_vcText);
    IF nLen<=i_nMaxWidth-io_nX+i_nXStart THEN
      IF io_nCurrentHeight+nLineHeight>i_nMaxHeight THEN
        -- stop
        RETURN;
      ELSIF i_bSplitByWord THEN
        -- fits, but split in separate entries
        iIdx:=INSTR(i_vcText, ' ');
        IF iIdx>0 THEN
          PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                               io_nCurrentHeight =>io_nCurrentHeight,
                               i_vcText          =>SUBSTR(i_vcText, 1, iIdx-1),
                               i_nMaxHeight      =>i_nMaxHeight,
                               io_nX             =>io_nX,
                               io_nGroup         =>io_nGroup,
                               i_nLineSpacing    =>i_nLineSpacing,
                               i_nXstart         =>i_nXStart,
                               i_nMaxWidth       =>i_nMaxWidth,
                               i_bSplitByWord    =>i_bSplitByWord
                              );
          PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                               io_nCurrentHeight =>io_nCurrentHeight,
                               i_vcText          =>SUBSTR(i_vcText, iIdx+1),
                               i_nMaxHeight      =>i_nMaxHeight,
                               io_nX             =>io_nX,
                               io_nGroup         =>io_nGroup,
                               i_nLineSpacing    =>i_nLineSpacing,
                               i_nXstart         =>i_nXStart,
                               i_nMaxWidth       =>i_nMaxWidth,
                               i_bSplitByWord    =>i_bSplitByWord
                              );
          RETURN;
        ELSE
          nLen:=nLen+AS_PDF3_MOD.str_len(' ');
          -- put text-piece in array
          iIdx:=io_lText.COUNT+1;
          io_lText(iIdx).nX:=io_nX;
          io_lText(iIdx).nGroup:=io_nGroup;
          io_lText(iIdx).nHeight:=nLineHeight+i_nLineSpacing;
          -- if wordsplitting is activated, add length for one space
          io_lText(iIdx).nLength:=nLen;
          io_lText(iIdx).vcText:=i_vcText;
          io_nX:=io_nX+nLen;
          io_nCurrentHeight:=io_nCurrentHeight+nLineHeight+i_nLineSpacing;
          RETURN;
        END IF;
      ELSE
        -- put text-piece in array
        iIdx:=io_lText.COUNT+1;
        io_lText(iIdx).nX:=io_nX;
        io_lText(iIdx).nGroup:=io_nGroup;
        io_lText(iIdx).nHeight:=nLineHeight+i_nLineSpacing;
        io_lText(iIdx).nLength:=nLen;
        io_lText(iIdx).vcText:=i_vcText;
        io_nX:=io_nX+nLen;
        io_nCurrentHeight:=io_nCurrentHeight+nLineHeight+i_nLineSpacing;
        RETURN;
      END IF;
    END IF;
    -- Text does not fit in whole, split by spaces
    iCnt:=0;
    WHILE (   INSTR(i_vcText, ' ', 1, iCnt+1)>0
           AND AS_PDF3_MOD.str_len(SUBSTR(i_vcText, 1, INSTR(i_vcText, ' ', 1, iCnt+1)-1))<=i_nMaxWidth-io_nX+i_nXStart
          ) LOOP
      iCnt:=iCnt+1;
    END LOOP;
    IF iCnt>0 THEN
      iIdx:=INSTR(i_vcText, ' ', 1, iCnt);
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           i_vcText          =>SUBSTR(i_vcText, 1, iIdx-1),
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nX             =>io_nX,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXstart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
      io_nGroup:=io_nGroup+1;
      io_nX:=i_nXStart;
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           i_vcText          =>SUBSTR(i_vcText, iIdx+1),
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nX             =>io_nX,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXstart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
      RETURN;
    END IF;
    IF     io_nX>i_nXStart
       AND nLen <i_nMaxWidth THEN
      io_nGroup:=io_nGroup+1;
      io_nX:=i_nXStart;
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           i_vcText          =>i_vcText,
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nX             =>io_nX,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXstart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
    ELSE
      IF LENGTH(i_vcText)=1 THEN
        IF io_nX>i_nXStart THEN
          io_nGroup:=io_nGroup+1;
          io_nX:=i_nXStart;
          PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                               io_nCurrentHeight =>io_nCurrentHeight,
                               i_vcText          =>i_vcText,
                               i_nMaxHeight      =>i_nMaxHeight,
                               io_nX             =>io_nX,
                               io_nGroup         =>io_nGroup,
                               i_nLineSpacing    =>i_nLineSpacing,
                               i_nXstart         =>i_nXStart,
                               i_nMaxWidth       =>i_nMaxWidth,
                               i_bSplitByWord    =>i_bSplitByWord
                              );
        ELSE
          -- 1 char fits always
          IF io_nCurrentHeight+nLineHeight>i_nMaxHeight THEN
            -- stop
            RETURN;
          ELSE
            -- put text-piece in array
            iIdx:=io_lText.COUNT+1;
            io_lText(iIdx).nX:=io_nX;
            io_lText(iIdx).nGroup:=io_nGroup;
            io_lText(iIdx).nHeight:=nLineHeight+i_nLineSpacing;
            io_lText(iIdx).nLength:=nLen;
            io_lText(iIdx).vcText:=i_vcText;
            io_nX:=io_nX+nLen;
            io_nCurrentHeight:=io_nCurrentHeight+nLineHeight+i_nLineSpacing;
            RETURN;
          END IF;
        END IF;
      ELSE
        iIdx:=2;
        WHILE AS_PDF3_MOD.str_len(SUBSTR(i_vcText, 1, iIdx))<=i_nMaxWidth-io_nX+i_nXStart LOOP
          iIdx:=iIdx+1;
        END LOOP;
        PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                             io_nCurrentHeight =>io_nCurrentHeight,
                             i_vcText          =>SUBSTR(i_vcText, 1, iIdx-1),
                             i_nMaxHeight      =>i_nMaxHeight,
                             io_nX             =>io_nX,
                             io_nGroup         =>io_nGroup,
                             i_nLineSpacing    =>i_nLineSpacing,
                             i_nXstart         =>i_nXStart,
                             i_nMaxWidth       =>i_nMaxWidth,
                             i_bSplitByWord    =>i_bSplitByWord
                            );
        io_nGroup:=io_nGroup+1;
        io_nX:=i_nXStart;
        PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                             io_nCurrentHeight =>io_nCurrentHeight,
                             i_vcText          =>SUBSTR(i_vcText, iIdx),
                             i_nMaxHeight      =>i_nMaxHeight,
                             io_nX             =>io_nX,
                             io_nGroup         =>io_nGroup,
                             i_nLineSpacing    =>i_nLineSpacing,
                             i_nXstart         =>i_nXStart,
                             i_nMaxWidth       =>i_nMaxWidth,
                             i_bSplitByWord    =>i_bSplitByWord
                            );
      END IF;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_GET_TEXT_PIECES(io_lText          IN OUT NOCOPY PK_JRXML2PDF_TYPES.tTextPieceList,
                               io_nCurrentHeight IN OUT NOCOPY NUMBER,
                               io_nX             IN OUT NOCOPY NUMBER,
                               i_vcText          IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                               i_nMaxHeight      IN NUMBER,
                               io_nGroup         IN OUT NUMBER,
                               i_nLineSpacing    IN NUMBER,
                               i_nXStart         IN NUMBER,
                               i_nMaxWidth       IN NUMBER,
                               i_bSplitByWord    IN BOOLEAN DEFAULT FALSE
                              ) IS
    vcIndex    PK_JRXML2PDF_TYPES.tMaxVarchar2:=TO_CHAR(AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize)) || '^' ||
                                                TO_CHAR(i_nMaxHeight) || '^' ||
                                                TO_CHAR(io_nX) || '^' ||
                                                TO_CHAR(io_nGroup) || '^' ||
                                                i_vcText;
    rTextCache PK_JRXML2PDF_TYPES.tTextCacheEntry;
  BEGIN
    IF lTextCache.EXISTS(vcIndex) THEN
      rTextCache:=lTextCache(vcIndex);
      io_lText:=rTextCache.lText;
      io_nCurrentHeight:=rTextCache.nCurrentheight;
      io_nX:=rTextCache.nX;
      io_nGroup:=rTextCache.nGroup;
    ELSE
      PR_SPLIT_TEXT_TO_BOX(io_lText          =>io_lText,
                           io_nCurrentHeight =>io_nCurrentHeight,
                           io_nX             =>io_nX,
                           i_vcText          =>i_vcText,
                           i_nMaxHeight      =>i_nMaxHeight,
                           io_nGroup         =>io_nGroup,
                           i_nLineSpacing    =>i_nLineSpacing,
                           i_nXStart         =>i_nXStart,
                           i_nMaxWidth       =>i_nMaxWidth,
                           i_bSplitByWord    =>i_bSplitByWord
                          );
      rTextCache.lText:=io_lText;
      rTextCache.nCurrentheight:=io_nCurrentHeight;
      rTextCache.nX:=io_nX;
      rTextCache.nGroup:=io_nGroup;
      lTextCache(vcIndex):=rTextCache;
    END IF;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_CALC_BOX_HEIGHT(i_vcText          IN PK_JRXML2PDF_TYPES.tMaxVarchar2,
                              i_nX              IN NUMBER,
                              i_nMaxHeight      IN NUMBER,
                              i_nLineSpacing    IN NUMBER,
                              i_nXStart         IN NUMBER,
                              i_nMaxWidth       IN NUMBER
                             )
  RETURN NUMBER IS
    lText          PK_JRXML2PDF_TYPES.tTextPieceList;
    nX             NUMBER:=i_nX;
    nCurrentHeight NUMBER:=0;
    nGroup         NUMBER:=0;
    nLineSpacing   NUMBER;
  BEGIN
    nLineSpacing:=(NVL(i_nLineSpacing, PK_JRXML2PDF_TYPES.MIN_LINE_SPACING)-1)*AS_PDF3_MOD.get(AS_PDF3_MOD.c_get_fontsize);
    PR_GET_TEXT_PIECES(io_lText          =>lText,
                       io_nCurrentHeight =>nCurrentHeight,
                       io_nX             =>nX,
                       i_vcText          =>i_vcText,
                       i_nMaxHeight      =>i_nMaxheight,
                       io_nGroup         =>nGroup,
                       i_nLineSpacing    =>nLineSpacing,
                       i_nXStart         =>i_nXStart,
                       i_nMaxWidth       =>i_nMaxWidth
                      );
    RETURN nCurrentHeight;
  END;
  -- ---------------------------------------------------------------------------
  FUNCTION FK_UPDATE_ADLER32_FOR_IMAGE(i_nId     IN NUMBER,
                                       i_blImage IN BLOB)
  RETURN VARCHAR2 IS
    PRAGMA AUTONOMOUS_TRANSACTION;
    vcAdler32 PK_JRXML2PDF_TYPES.tMaxVarchar2;
  BEGIN
    -- calc checksum
    vcAdler32:=AS_PDF3_MOD.adler32(i_blImage);
    -- update table
    UPDATE JRXML_REPORT_IMAGES SET
      JRI_ADLER32=vcAdler32,
      JRI_ADLER32_VALID='Y'
    WHERE JRI_ID=i_nId;
    -- COMMIT, is an autonomous transaction
    COMMIT;
    -- return adler
    RETURN vcAdler32;
  END;
  -- ---------------------------------------------------------------------------
  PROCEDURE PR_CLEAR_TEXT_CACHE IS
  BEGIN
    lTextcache.DELETE;
  END;
BEGIN
  -- Initialize Date-split-Chars
  lDateSplitChars(1):='/';
  lDateSplitChars(2):=' ';
  lDateSplitChars(3):=',';
  lDateSplitChars(4):='.';
  lDateSplitChars(5):=':';
  lDateSplitChars(6):='-';
  lDateSplitChars(7):='''';
  lDateSplitChars(8):='"';
END;
/
create or replace PACKAGE BODY pr_num_a_letras AS
--
-- Retrofitted
FUNCTION Excepcion(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Decena(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Centena(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Diez(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Cien(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION mil(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Millon(
i IN integer )
RETURN varchar2;
--
-- Retrofitted
FUNCTION Excepcion(
i IN integer )
RETURN varchar2 IS
--
--
v_r VARCHAR2(15);
BEGIN
IF i < 10 THEN
SELECT
DECODE(i, 0, '', 1, 'un', 2, 'dos', 3, 'tres', 4, 'cuatro',
5, 'cinco', 6, 'seis', 7, 'siete', 8, 'ocho', 9, 'nueve')
INTO
v_r
FROM
dual;
ELSIF
i < 20 THEN
SELECT
DECODE(i, 10, 'diez', 11, 'once', 12, 'doce', 13, 'trece',
14, 'catorce', 15, 'quince', 16, 'dieciseis', 17, 'diecisiete',
18, 'dieciocho', 19, 'diecinueve')
INTO
v_r
FROM
dual;
ELSE
SELECT
DECODE(i, 20, 'veinte', 21, 'veintiun', 22, 'veintidos',
23, 'veintitres', 24, 'veinticuatro', 25, 'veinticinco',
26, 'veintiseis', 27, 'veintisiete', 28, 'veintiocho',
29, 'veintinueve')
INTO
v_r
FROM
dual;
END IF;
RETURN v_r;
END;
--
-- Retrofitted
FUNCTION Decena(
i IN integer )
RETURN varchar2 IS
--
--
v_r VARCHAR2(15);
BEGIN
SELECT
DECODE(i, 0, '', 1, '', 2, '', 3, 'treinta', 4, 'cuarenta',
5, 'cincuenta', 6, 'sesenta', 7, 'setenta', 8, 'ochenta',
9, 'noventa')
INTO
v_r
FROM
dual;
RETURN v_r;
END;
--
-- Retrofitted
FUNCTION Centena(
i IN integer )
RETURN varchar2 IS
--
--
v_r VARCHAR2(15);
BEGIN
SELECT
DECODE(i, 0, '', 1, 'ciento', 2, 'doscientos', 3, 'trescientos',
4, 'cuatrocientos', 5, 'quinientos', 6, 'seiscientos', 7, 'setecientos',
8, 'ochocientos', 9, 'novecientos')
INTO
v_r
FROM
dual;
RETURN v_r;
END;
--
-- Retrofitted
FUNCTION Diez(
i IN integer )
RETURN varchar2 IS
--
--
TDiez VARCHAR2(50);
BEGIN
IF i < 30 THEN
TDiez := Excepcion(i);
ELSE
TDiez := Decena(TRUNC(i/10));
IF MOD(i, 10) <> 0 THEN
TDiez := TDiez || ' y '|| excepcion(i MOD 10);
END IF;
END IF;
RETURN(TDiez);
END;
--
-- Retrofitted
FUNCTION Cien(
i IN integer )
RETURN varchar2 IS
--
--
TCien VARCHAR2(50);
BEGIN
IF i = 100 THEN
TCien := 'cien';
ELSE
TCien := centena(TRUNC(i / 100));
IF MOD(i, 100) <> 0 THEN
IF TRUNC(i / 100) <> 0 THEN
TCien := TCien || ' ';
END IF;
TCien := TCien || diez(MOD(i, 100));
END IF;
END IF;
RETURN(TCien);
END;
--
-- Retrofitted
FUNCTION mil(
i IN integer )
RETURN varchar2 IS
--
--
TMil VARCHAR2(100);
BEGIN
IF TRUNC(i/1000) = 1 THEN
TMil := 'mil';
IF MOD(i, 1000) <> 0 THEN
TMil := TMil || ' ';
END IF;
TMil := TMil || Cien(MOD(i, 1000));
ELSIF
TRUNC(i/1000) = 0 THEN
TMil := Cien(i);
ELSE
TMil := Cien(TRUNC(i/1000)) || ' mil';
IF MOD(i, 1000) <> 0 THEN
TMil := TMil || ' ';
END IF;
TMil := TMil || Cien(MOD(i, 1000));
END IF;
RETURN(TMil);
END;
--
-- Retrofitted
FUNCTION Millon(
i IN integer )
RETURN varchar2 IS
--
--
TMillon VARCHAR2(150);
BEGIN
IF i >= 0 THEN
IF i = 0 THEN
TMillon := 'cero';
ELSIF
TRUNC(i/1000000) = 0 THEN
TMillon := Mil(i);
ELSIF
TRUNC(i/1000000) = 1 THEN
TMillon := 'un millon';
IF MOD(i, 1000000) <> 0 THEN
TMillon := TMillon || ' ';
END IF;
TMillon := TMillon || Mil(MOD(i, 1000000));
ELSE
TMillon := Mil(TRUNC(i/1000000)) || ' millones';
IF(MOD(i, 1000000)) <>0 THEN
TMillon := TMillon || ' ';
END IF;
TMillon := TMillon || Mil(MOD(i, 1000000));
END IF;
IF(MOD(i, 10) =1) AND(MOD(i, 100) <> 11) THEN
TMillon := TMillon || 'o';
END IF;
END IF;
RETURN(TMillon);
END;
--
-- Retrofitted
FUNCTION DinTex(
x IN number )
RETURN varchar2 IS
--
--
Texto VARCHAR2(150);
--
--
IntX NUMBER;
--
--
FraX INTEGER;
BEGIN
IF x < 2147483647 AND x >= 0 THEN
Intx := TRUNC(x);
Texto := Millon(Intx);
FraX := TRUNC((x - Intx) * 100 + 0.5);
Texto := Texto; --|| TO_CHAR(Frax, '00') || '/100';
END IF;
RETURN(Texto);
END;
--
-- Retrofitted
FUNCTION NumTex(
x IN number )
RETURN varchar2 IS
--
--
Texto VARCHAR2(150);
--
--
IntX NUMBER;
BEGIN
IF x < 2147483647 AND x >= 0 THEN
Intx := TRUNC(x);
Texto := Millon(Intx);
END IF;
RETURN(Texto);
END;
END PR_NUM_A_LETRAS;
/























































































































































